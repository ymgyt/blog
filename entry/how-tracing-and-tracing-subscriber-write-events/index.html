<!doctype html><html lang=ja><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1" name=viewport><link href=https://blog.ymgyt.io/favicon.ico rel=icon sizes=any><link href=https://blog.ymgyt.io/icon.svg rel=icon type=image/svg+xml><link href=https://blog.ymgyt.io/apple-touch-icon.png rel=apple-touch-icon><link href=https://blog.ymgyt.io/manifest.webmanifest rel=manifest><link href=https://blog.ymgyt.io/style.css rel=stylesheet><link href=https://blog.ymgyt.io/atom.xml rel=alternate title=Atom type=application/atom+xml><script src="https://www.googletagmanager.com/gtag/js?id=G-GTB0KMLN90" async></script><script>window.dataLayer = window.dataLayer || [];
	function gtag() {dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-GTB0KMLN90');</script><title>ğŸ”­ tracing/tracing-subscriberã§ãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã‚‹ä»•çµ„ã¿ã‚’ç†è§£ã™ã‚‹ | Happy developing</title><meta content=tracing-subscrierã®ä»•çµ„ã¿ã«ã¤ã„ã¦ name=description><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><body><div class=world><div class=content-container><header class=blog-header-container><div class=blog-logo><a href=https://blog.ymgyt.io>Happy developing</a></div><div class=blog-nav><nav><ul><li><a href=https://blog.ymgyt.io/entry/>Entries</a><li><a href=https://blog.ymgyt.io/tags/>Tags</a><li><a href=https://blog.ymgyt.io/about/>About</a><li><a href=https://github.com/ymgyt> <img alt=Github class=icon src=https://blog.ymgyt.io/images/icon/github.svg> </a><li><a href="https://twitter.com/YAmaguchixt "> <img alt=Twitter class=icon src=https://blog.ymgyt.io/images/icon/twitter.svg> </a></ul></nav></div></header><main class=blog-main><article><header class=entry-header><h1 class=entry-title>ğŸ”­ tracing/tracing-subscriberã§ãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã‚‹ä»•çµ„ã¿ã‚’ç†è§£ã™ã‚‹</h1><div class=entry-meta><p class=entry-meta-item>ğŸ—“ 2022-11-19<p class=entry-meta-item>ğŸ· <span class=tag><a href=https://blog.ymgyt.io/tags/rust/>rust</a></span></div></header><aside class=entry-toc><nav><ul class=entry-toc-toplevel-list><li><a href=https://blog.ymgyt.io/entry/how-tracing-and-tracing-subscriber-write-events/#ben-ji-shi-nogoru>æœ¬è¨˜äº‹ã®ã‚´ãƒ¼ãƒ«</a><li><a href=https://blog.ymgyt.io/entry/how-tracing-and-tracing-subscriber-write-events/#qian-ti-noque-ren>å‰æã®ç¢ºèª</a> <ul><li><a href=https://blog.ymgyt.io/entry/how-tracing-and-tracing-subscriber-write-events/#spantoha>Spanã¨ã¯</a><li><a href=https://blog.ymgyt.io/entry/how-tracing-and-tracing-subscriber-write-events/#thread-local-thread-local-threadlocal>thread_local!, thread_local::ThreadLocal</a><li><a href=https://blog.ymgyt.io/entry/how-tracing-and-tracing-subscriber-write-events/#shareded-slab-pool>shareded_slab::Pool</a></ul><li><a href=https://blog.ymgyt.io/entry/how-tracing-and-tracing-subscriber-write-events/#macrowoexpand>Macroã‚’expand</a><li><a href=https://blog.ymgyt.io/entry/how-tracing-and-tracing-subscriber-write-events/#tracing-subscriber-crate>tracing_subscriber crate</a> <ul><li><a href=https://blog.ymgyt.io/entry/how-tracing-and-tracing-subscriber-write-events/#fmtsubscriber>FmtSubscriber</a><li><a href=https://blog.ymgyt.io/entry/how-tracing-and-tracing-subscriber-write-events/#layer>Layer</a><li><a href=https://blog.ymgyt.io/entry/how-tracing-and-tracing-subscriber-write-events/#layered>Layered</a><li><a href=https://blog.ymgyt.io/entry/how-tracing-and-tracing-subscriber-write-events/#filter>Filter</a><li><a href=https://blog.ymgyt.io/entry/how-tracing-and-tracing-subscriber-write-events/#registry>Registry</a><li><a href=https://blog.ymgyt.io/entry/how-tracing-and-tracing-subscriber-write-events/#fmt-layer-layer>fmt_layer::Layer</a><li><a href=https://blog.ymgyt.io/entry/how-tracing-and-tracing-subscriber-write-events/#subscribernodeng-lu>Subscriberã®ç™»éŒ²</a><li><a href=https://blog.ymgyt.io/entry/how-tracing-and-tracing-subscriber-write-events/#fmtsubscriber-matome>FmtSubscriber ã¾ã¨ã‚</a></ul><li><a href=https://blog.ymgyt.io/entry/how-tracing-and-tracing-subscriber-write-events/#tracing-span-new>tracing::Span::new()</a><li><a href=https://blog.ymgyt.io/entry/how-tracing-and-tracing-subscriber-write-events/#tracing-span-enter>tracing::Span::enter()</a><li><a href=https://blog.ymgyt.io/entry/how-tracing-and-tracing-subscriber-write-events/#tracing-event-dispatch>tracing::Event::dispatch</a><li><a href=https://blog.ymgyt.io/entry/how-tracing-and-tracing-subscriber-write-events/#rogunofiltering>ãƒ­ã‚°ã®filtering</a> <ul><li><a href=https://blog.ymgyt.io/entry/how-tracing-and-tracing-subscriber-write-events/#tracing-level-fiters-static-max-level>tracing::level_fiters::STATIC_MAX_LEVEL</a><li><a href=https://blog.ymgyt.io/entry/how-tracing-and-tracing-subscriber-write-events/#tracing-level-filters-levelfilter-current>tracing::level_filters::LevelFilter::current()</a><li><a href=https://blog.ymgyt.io/entry/how-tracing-and-tracing-subscriber-write-events/#calliste-interest>CALLISTE.interest()</a><li><a href=https://blog.ymgyt.io/entry/how-tracing-and-tracing-subscriber-write-events/#tracing-macro-support-is-enabled>tracing::__macro_support::__is_enabled()</a></ul><li><a href=https://blog.ymgyt.io/entry/how-tracing-and-tracing-subscriber-write-events/#matome>ã¾ã¨ã‚</a></ul></nav></aside><div class=entry-content><p>æœ¬è¨˜äº‹ã§ã¯Rustã®<a href=https://github.com/tokio-rs/tracing rel=external>tracing</a>/<a href=https://github.com/tokio-rs/tracing/tree/master/tracing-subscriber rel=external>tracing-subscriber</a>ã§ãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã‚‹ä»•çµ„ã¿ã‚’ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿ãªãŒã‚‰ç†è§£ã™ã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚ å…·ä½“çš„ã«ã¯ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã«ãŠã„ã¦<a href=https://github.com/tokio-rs/tracing rel=external>tracing</a>ãŒã©ã®ã‚ˆã†ã«ã—ã¦ãƒ­ã‚°ã‚’å‡ºåŠ›ã™ã‚‹ã‹ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> tracing</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span>info</span><span style=color:#eceff4>,</span><span> info_span</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span>    tracing_subscriber</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>fmt</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>init</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> span</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0;font-weight:700> info_span!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>span_1</span><span style=color:#eceff4>",</span><span> key</span><span style=color:#81a1c1>=</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>hello</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> _guard</span><span style=color:#81a1c1> =</span><span> span</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>enter</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    info!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>hello</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>Cargo.toml</code><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=toml><span class=giallo-l><span style=color:#eceff4>[</span><span>dependencies</span><span style=color:#eceff4>]</span></span>
<span class=giallo-l><span>thread_local</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>1.1.4</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span>tracing</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>=0.1.35</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span>tracing-core</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>=0.1.30</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span>tracing-subscriber</span><span style=color:#eceff4> = {</span><span> version</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>=0.3.16</span><span style=color:#eceff4>",</span><span> default-features</span><span style=color:#eceff4> =</span><span style=color:#81a1c1> false</span><span style=color:#eceff4>,</span><span> features</span><span style=color:#eceff4> = ["</span><span style=color:#a3be8c>smallvec</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>fmt</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>ansi</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>std</span><span style=color:#eceff4>"] }</span></span></code></pre><p>ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ä»¥ä¸‹ã®å‡ºåŠ›ã‚’å¾—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>2022-11-11T08:39:02.198973Z</span><span style=color:#a3be8c>  INFO span_1{key=</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>hello</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>}: tracing_handson: hello</span></span></code></pre><p>versionã¯<a href=https://github.com/tokio-rs/tracing/tree/tracing-subscriber-0.3.16 rel=external><code>tracing-subscriber-0.3.16</code></a>ã‚’å¯¾è±¡ã«ã—ã¾ã—ãŸã€‚<br> (ãªãŠã€<code>tracing::info!()</code>ã¯tracingçš„ã«ã¯Eventã¨ã„ã‚ã‚Œã¦ã„ã‚‹ã®ã§ä»¥ä¸‹ã§ã¯ãƒ­ã‚°ã§ã¯ãªãEventã¨å‘¼ã‚“ã§ã„ãã¾ã™)<h2 id=ben-ji-shi-nogoru><a aria-label="Anchor link for: ben-ji-shi-nogoru" class=zola-anchor href=#ben-ji-shi-nogoru>æœ¬è¨˜äº‹ã®ã‚´ãƒ¼ãƒ«</a></h2><p>æœ¬è¨˜äº‹ã§ã¯ä»¥ä¸‹ã®ç‚¹ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚<ul><li><code>tracing_subscriber::fmt()::init()</code>ã§ãªã«ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹ã‹ <ul><li><code>tracing_subscriber::Subscriber</code>ã®å†…éƒ¨æ§‹é€  <ul><li><code>Subscriber</code>ã®å®Ÿæ…‹ã¯<code>Layer * n</code> + <code>Registry</code></ul><li><code>tracing_subscriber::Registry</code>ã®å½¹å‰²</ul><li><code>tracing::Span</code>ã®ä»•çµ„ã¿ <ul><li><code>info_span!()</code>ã®å†…å®¹ãŒã©ã®ã‚ˆã†ã«ã—ã¦å¾Œç¶šã®eventã«å‡ºåŠ›ã•ã‚Œã‚‹ã‹</ul><li><code>tracing::info!()</code>ãŒå‡ºåŠ›ã•ã‚Œã‚‹ä»•çµ„ã¿</ul><p>æœ¬è¨˜äº‹ã§æ‰±ã‚ãªã„ã“ã¨<ul><li><code>tracing-future</code> <ul><li><code>async/await</code>ã§ã®tracingã®åˆ©ç”¨ã®ä»•æ–¹(ãŸã ã—ã€<code>async</code>ãªã‚³ãƒ¼ãƒ‰ã§ãã®ã¾ã¾ä½¿ã†ã¨ã©ã†ã—ã¦ã†ã¾ãå‹•ä½œã—ãªã„ã‹ã¯ç†è§£ã§ãã¾ã™)</ul><li><code>tracing-log</code> <ul><li>log crateã¨ã®äº’æ›å‡¦ç†ã‚‚æä¾›ã•ã‚Œã¦ã„ã¾ã™</ul><li>per-filter-layer <ul><li><a href=https://blog.ymgyt.io/entry/produce-measurement-with-attributes-from-tracing/ rel=external>tracing-opentelemetryã«PRã‚’é€ã£ãŸè¨˜äº‹</a>ã§per-filter-layerã®åˆ©ç”¨æ–¹æ³•ã«ã¤ã„ã¦æ›¸ãã¾ã—ãŸ</ul></ul><h2 id=qian-ti-noque-ren><a aria-label="Anchor link for: qian-ti-noque-ren" class=zola-anchor href=#qian-ti-noque-ren>å‰æã®ç¢ºèª</a></h2><h3 id=spantoha><a aria-label="Anchor link for: spantoha" class=zola-anchor href=#spantoha>Spanã¨ã¯</a></h3><p>æœ€åˆã«tracingã‚’è§¦ã£ãŸæ™‚ã«<code>info!()</code>ã‚„<code>error!()</code>ã¯ãƒ­ã‚°ã®å‡ºåŠ›ã¨ã—ã¦ç†è§£ã§ããŸã®ã§ã™ãŒã€spanã®å½¹å‰²ã‚„ä½¿ã„æ–¹ãŒã‚ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚å…¬å¼ã®docã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚ã‚Šã¾ã™ã€‚<blockquote><p>Unlike a log line that represents a moment in time, a span represents a period of time with a beginning and an end.</blockquote><p>è‡ªåˆ†ã®è¨€è‘‰ã§èª¬æ˜ã™ã‚‹ãªã‚‰ã€spanã¯å¾Œç¶šã®stack traceä¸Šã§ä½œã‚‰ã‚Œã‚‹event(<code>info!()</code>)ã«ä»˜ä¸ã•ã‚Œã‚‹key,valueã§ã€eventã«å®Ÿè¡Œæ™‚ã®contextã‚’ä»˜ä¸ã™ã‚‹ã‚‚ã®ã§ã™ã€‚ã¨ã„ã£ã¦ã‚‚ã‚ã‹ã‚Šã¥ã‚‰ã„ã¨æ€ã†ã®ã§å…·ä½“çš„ãªã‚³ãƒ¼ãƒ‰ã§ã¿ã¦ã„ãã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> tracing</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span>info</span><span style=color:#eceff4>,</span><span> info_span</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> start</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#616e88>    // Generate unique request id</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> request_id</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>req-123</span><span style=color:#eceff4>";</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> _guard</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0;font-weight:700> info_span!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>req</span><span style=color:#eceff4>",</span><span> request_id</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>entered</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>    handle_request</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> handle_request</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#616e88>    // Authenticate</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> user_id</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>user_aaa</span><span style=color:#eceff4>";</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> _guard</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0;font-weight:700> info_span!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>user</span><span style=color:#eceff4>",</span><span> user_id</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>entered</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>    do_process</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> do_process</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    info!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>successfully processed</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span>    tracing_subscriber</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>fmt</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>init</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>    start</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>å‡¦ç†ã®å†…å®¹ã¯ãªã‚“ã§ã‚‚ã‚ˆã„ã®ã§ã™ãŒã€ã¾ãšãƒªã‚¯ã‚¨ã‚¹ãƒˆã®è­˜åˆ¥å­ã‚’ç”Ÿæˆã—ã¦æ¬¡ã«èªè¨¼ã—ã¦ã€...ã¨å‡¦ç†ã‚’é€²ã‚ã¦ã„ãä¸­ã§å‡¦ç†å†…å®¹ã®contextãŒã§ãã¦ã„ãã¨æ€ã„ã¾ã™ã€‚ãã‚Œã‚’spanã¨ã—ã¦è¡¨ç¾ã—ã¾ã™ã€‚ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>2022-11-11T09:19:18.317693Z</span><span style=color:#a3be8c>  INFO req{request_id=</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>req-123</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>}:user{user_id=</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>user_aaa</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>}: span: successfully processed</span></span></code></pre><p><code>info!()</code>ã§ç”Ÿæˆã—ãŸeventã«spanã«ä¸ãˆãŸkey,valueãŒä»˜ä¸ã•ã‚Œã¾ã—ãŸã€‚ã“ã®ã‚ˆã†ã«å‡¦ç†ã®éšå±¤æ§‹é€ ã®contextã‚’ãƒ­ã‚°ã«æ§‹é€ çš„ã«è¡¨ç¾ã§ãã¾ã™ã€‚ä¸€åº¦ã“ã®ãƒ­ã‚°ãŒä½œã‚Œã‚‹ã¨ã‚ã‹ã‚‹ã¨ã‚‚ã†spanãªã—ã«ã¯æˆ»ã‚Œãªã„ã§ã™ã€‚<h3 id=thread-local-thread-local-threadlocal><a aria-label="Anchor link for: thread-local-thread-local-threadlocal" class=zola-anchor href=#thread-local-thread-local-threadlocal><code>thread_local!</code>, <code>thread_local::ThreadLocal</code></a></h3><p>tracingã®å®Ÿè£…ã§ã¯ã—ã°ã—ã°<code>thread_local!</code>ã‚„<code>thread_local::ThreadLocal</code>ãŒã§ã¦ãã¾ã™ã€‚<br> è‡ªåˆ†è‡ªèº«ã€thread localã¨ã„ã†æ©Ÿæ§‹ã¸ã®ç†è§£ãŒã‚ã‚„ã—ã„ã®ã§ã™ãŒæœ¬è¨˜äº‹ã‚’èª­ã‚€ç¯„å›²ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«Rustã®APIçš„è¦³ç‚¹ã‹ã‚‰æ‰ãˆã¦ãŠã‘ã°ã‚ˆã„ã¨è€ƒãˆã¦ãŠã‚Šã¾ã™ã€‚<p><code>thread_local!</code>ã¯globalãªstaticå¤‰æ•°ã«<code>RefCell</code>ã‚’ä¿æŒã§ãã‚‹ã€‚<br> å…·ä½“çš„ã«ã¯ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã¯globalãªstaticå¤‰æ•°ã‚’è¤‡æ•°threadã‹ã‚‰å¤‰æ›´ã—ã‚ˆã†ã¨ã—ã¦ãŠã‚Šcompileã«å¤±æ•—ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>static</span><span> STATE</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> RefCell</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>></span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> RefCell</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>String</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> threads</span><span style=color:#81a1c1> =</span><span style=color:#b48ead> 5</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> handles</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Vec</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>with_capacity</span><span style=color:#eceff4>(</span><span>threads</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>    for</span><span> i</span><span style=color:#81a1c1> in</span><span style=color:#b48ead> 0</span><span style=color:#81a1c1>..</span><span>threads</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> handle</span><span style=color:#81a1c1> =</span><span> thread</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>spawn</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>move ||</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            STATE</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>borrow_mut</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>push_str</span><span style=color:#eceff4>(</span><span>i</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_string</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_str</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#eceff4>        });</span></span>
<span class=giallo-l><span>        handles</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>push</span><span style=color:#eceff4>(</span><span>handle</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    for</span><span> handle</span><span style=color:#81a1c1> in</span><span> handles</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>        handle</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>join</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>--</span><span>></span><span style=color:#a3be8c> examples/thread_local.rs:8:15</span></span>
<span class=giallo-l><span style=color:#81a1c1>  |</span></span>
<span class=giallo-l><span style=color:#88c0d0>8</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> static</span><span style=color:#a3be8c> STATE: RefCell</span><span style=color:#81a1c1>&lt;</span><span style=color:#a3be8c>Strin</span><span>g</span><span style=color:#81a1c1>></span><span style=color:#a3be8c> = RefCell::new</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>String::new</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>  |</span><span style=color:#88c0d0>               ^^^^^^^^^^^^^^^</span><span style=color:#eceff4> `</span><span style=color:#88c0d0>RefCell</span><span style=color:#a3be8c>&lt;String></span><span style=color:#eceff4>`</span><span style=color:#88c0d0> cannot</span><span style=color:#a3be8c> be shared between threads safely</span></span>
<span class=giallo-l><span style=color:#81a1c1>  |</span></span>
<span class=giallo-l><span style=color:#a3be8c>  = help: the trait</span><span style=color:#eceff4> `</span><span style=color:#88c0d0>Sync</span><span style=color:#eceff4>`</span><span style=color:#88c0d0> is</span><span style=color:#a3be8c> not implemented for</span><span style=color:#eceff4> `</span><span style=color:#88c0d0>RefCell</span><span style=color:#a3be8c>&lt;String></span><span style=color:#eceff4>`</span></span>
<span class=giallo-l><span style=color:#a3be8c>  = note: shared static variables must have a type that implements</span><span style=color:#eceff4> `</span><span style=color:#88c0d0>Sync</span><span style=color:#eceff4>`</span></span></code></pre><p>ãã“ã§ã€globalå¤‰æ•°<code>STATE</code>ã‚’<code>thread_local!</code>ã«ã™ã‚‹ã¨compileãŒé€šã‚Šã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>cell</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>RefCell</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>thread</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>thread_local!</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    static</span><span> STATE</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> RefCell</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>></span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> RefCell</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>String</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> threads</span><span style=color:#81a1c1> =</span><span style=color:#b48ead> 5</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> handles</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Vec</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>with_capacity</span><span style=color:#eceff4>(</span><span>threads</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>    for</span><span> i</span><span style=color:#81a1c1> in</span><span style=color:#b48ead> 0</span><span style=color:#81a1c1>..</span><span>threads</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> handle</span><span style=color:#81a1c1> =</span><span> thread</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>spawn</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>move ||</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            STATE</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>with</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>state</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>RefCell</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>></span><span style=color:#81a1c1>|</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                state</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>borrow_mut</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>push_str</span><span style=color:#eceff4>(</span><span>i</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_string</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_str</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#eceff4>            })</span></span>
<span class=giallo-l><span style=color:#eceff4>        });</span></span>
<span class=giallo-l><span>        handles</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>push</span><span style=color:#eceff4>(</span><span>handle</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    for</span><span> handle</span><span style=color:#81a1c1> in</span><span> handles</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>        handle</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>join</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>RefCell</code>ã¯<code>Sync</code>ã§ã¯ãªã„ã®ã§multi threadã§ã¯<code>Arc&lt;Mutext&lt;T>></code>ç­‰ã‚’ä½¿ã†ã¨ã“ã‚ã§ã™ãŒã€thread localã«ã™ã‚‹ã¨threadã”ã¨ã«globalå¤‰æ•°ã‚’ä¿æŒã§ãã€single threadã§åˆ©ç”¨ã§ããŸ<code>RefCell</code>ãŒä½¿ãˆã¾ã™ã€‚<p><code>ThreadLocal</code>ã¯ä¸Šè¨˜ã®æ©Ÿèƒ½ã‚’structã®fieldã§ã‚‚ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ã‚‚ã®ã§ã™ã€‚ å…·ä½“çš„ã«ã¯ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã¯compileãŒé€šã‚Šã¾ã›ã‚“ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>cell</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>RefCell</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> A</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    _a</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> RefCell</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> should_sync</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Sync</span><span style=color:#eceff4>>(</span><span>_t</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> T</span><span style=color:#eceff4>) {}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> a</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> A</span><span style=color:#eceff4> {</span><span> _a</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> RefCell</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>String</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>()) };</span></span>
<span class=giallo-l><span style=color:#88c0d0>    should_sync</span><span style=color:#eceff4>(</span><span>a</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>  --</span><span>></span><span style=color:#a3be8c> examples/thread_local.rs:14:17</span></span>
<span class=giallo-l><span style=color:#81a1c1>   |</span></span>
<span class=giallo-l><span style=color:#88c0d0>14</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0>     should_sync(a</span><span>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>   |</span><span style=color:#88c0d0>     -----------</span><span style=color:#a3be8c> ^</span><span style=color:#eceff4> `</span><span style=color:#88c0d0>RefCell</span><span style=color:#a3be8c>&lt;String></span><span style=color:#eceff4>`</span><span style=color:#88c0d0> cannot</span><span style=color:#a3be8c> be shared between threads safely</span></span>
<span class=giallo-l><span style=color:#81a1c1>   |     |</span></span>
<span class=giallo-l><span style=color:#81a1c1>   |</span><span style=color:#88c0d0>     required</span><span style=color:#a3be8c> by a bound introduced by this call</span></span>
<span class=giallo-l><span style=color:#81a1c1>   |</span></span>
<span class=giallo-l><span style=color:#a3be8c>   = help: within</span><span style=color:#eceff4> `</span><span style=color:#88c0d0>A</span><span style=color:#eceff4>`</span><span style=color:#88c0d0>,</span><span style=color:#a3be8c> the trait</span><span style=color:#eceff4> `</span><span style=color:#88c0d0>Sync</span><span style=color:#eceff4>`</span><span style=color:#88c0d0> is</span><span style=color:#a3be8c> not implemented for</span><span style=color:#eceff4> `</span><span style=color:#88c0d0>RefCell</span><span style=color:#a3be8c>&lt;String></span><span style=color:#eceff4>`</span></span></code></pre><p><code>RefCell</code>ãŒ<code>Sync</code>ã§ãªã„ã¨è¨€ã‚ã‚Œã¾ã™ã€‚ãã“ã§ã€<code>ThreadLocal</code>ã§wrapã™ã‚‹ã¨compileãŒé€šã‚Šã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>cell</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>RefCell</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> thread_local</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>ThreadLocal</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> A</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    _a</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> ThreadLocal</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>RefCell</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> should_sync</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Sync</span><span style=color:#eceff4>>(</span><span>_t</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> T</span><span style=color:#eceff4>) {}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> a</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> A</span><span style=color:#eceff4> {</span><span> _a</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> ThreadLocal</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>() };</span></span>
<span class=giallo-l><span style=color:#88c0d0>    should_sync</span><span style=color:#eceff4>(</span><span>a</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><h3 id=shareded-slab-pool><a aria-label="Anchor link for: shareded-slab-pool" class=zola-anchor href=#shareded-slab-pool><code>shareded_slab::Pool</code></a></h3><p><code>shareded_slab::Pool</code>ã¯slabã¨ã„ã†ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’multi threadé–“ã§å…±æœ‰ã§ãã‚‹ã‚ˆã†ã«ã—(<code>Sync</code>)ã‹ã¤ã€object pool likeãªAPIã‚’æä¾›ã™ã‚‹ã‚‚ã®ã§ã™ã€‚ã‚ã¾ã‚Šæ·±å…¥ã‚Šã™ã‚‹ã¨æœ¬è¨˜äº‹ã®ã‚´ãƒ¼ãƒ«ã‹ã‚‰ãã‚Œã¦ã—ã¾ã†ã®ã§ã€ã“ã“ã§ã¯dataã‚’create/insertã™ã‚‹ã¨index(usize)ã‚’è¿”ã—ã¦ãã‚Œã‚‹<code>Sync</code>ã§åŠ¹ç‡çš„ãª<code>Vec</code>ã¨ã„ã†ç¨‹åº¦ã«ç†è§£ã—ã¾ã™ã€‚<h2 id=macrowoexpand><a aria-label="Anchor link for: macrowoexpand" class=zola-anchor href=#macrowoexpand>Macroã‚’expand</a></h2><p>tracingä»¥å¤–ã®crateã§æŠ¼ã•ãˆã¦ãŠããŸã„å‹ã¯å‰æã®ç¢ºèªã§æ¦‚è¦ã‚’æŠ¼ã•ãˆãŸã®ã§ã‚ã¨ã¯tracingã¨stdã ã‘ã§å®Œçµã—ã¾ã™ã€‚<br> ã¾ãšã¯macroã‚’expandã—ã¦ã€å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹tracingã®apiã‚’ç¢ºèªã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> tracing</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span>info</span><span style=color:#eceff4>,</span><span> info_span</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span>    tracing_subscriber</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>fmt</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>init</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> span</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0;font-weight:700> info_span!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>span_1</span><span style=color:#eceff4>",</span><span> key</span><span style=color:#81a1c1>=</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>hello</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> _guard</span><span style=color:#81a1c1> =</span><span> span</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>enter</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    info!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>hello</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã“ã®codeã‚’<code>cargo expand</code>ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚(compileã§ãã‚‹ã‚ˆã†ã«preludeç­‰ã‚’å‰Šã‚Šã¾ã—ãŸã€‚)<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#![feature(fmt_internals)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>prelude</span><span style=color:#81a1c1>::</span><span>rust_2021</span><span style=color:#81a1c1>::*</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span>    tracing_subscriber</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>fmt</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>init</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> span</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        use ::</span><span>tracing</span><span style=color:#81a1c1>::</span><span>__macro_support</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Callsite</span><span style=color:#81a1c1> as</span><span> _</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        static</span><span> CALLSITE</span><span style=color:#81a1c1>: ::</span><span>tracing</span><span style=color:#81a1c1>::</span><span>callsite</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>DefaultCallsite</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            static</span><span> META</span><span style=color:#81a1c1>: ::</span><span>tracing</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Metadata</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>></span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                ::</span><span>tracing_core</span><span style=color:#81a1c1>::</span><span>metadata</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Metadata</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>                    "</span><span style=color:#a3be8c>span_1</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>                    "</span><span style=color:#a3be8c>tracing_handson</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    ::</span><span>tracing</span><span style=color:#81a1c1>::</span><span>Level</span><span style=color:#81a1c1>::</span><span>INFO</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                    Some</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>src/main.rs</span><span style=color:#eceff4>"),</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                    Some</span><span style=color:#eceff4>(</span><span style=color:#b48ead>8</span><span style=color:#8fbcbb>u32</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                    Some</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>tracing_handson</span><span style=color:#eceff4>"),</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    ::</span><span>tracing_core</span><span style=color:#81a1c1>::</span><span>field</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>FieldSet</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#81a1c1>                        &</span><span style=color:#eceff4>["</span><span style=color:#a3be8c>key</span><span style=color:#eceff4>"],</span></span>
<span class=giallo-l><span style=color:#81a1c1>                        ::</span><span>tracing_core</span><span style=color:#81a1c1>::</span><span>callsite</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Identifier</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>CALLSITE</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>                    ),</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    ::</span><span>tracing</span><span style=color:#81a1c1>::</span><span>metadata</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Kind</span><span style=color:#81a1c1>::</span><span>SPAN</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>                )</span></span>
<span class=giallo-l><span style=color:#eceff4>            };</span></span>
<span class=giallo-l><span style=color:#81a1c1>            ::</span><span>tracing</span><span style=color:#81a1c1>::</span><span>callsite</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>DefaultCallsite</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>META</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>        };</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> interest</span><span style=color:#81a1c1> = ::</span><span>tracing</span><span style=color:#81a1c1>::</span><span>subscriber</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Interest</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>never</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if ::</span><span>tracing</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Level</span><span style=color:#81a1c1>::</span><span>INFO</span><span style=color:#81a1c1> &lt;= ::</span><span>tracing</span><span style=color:#81a1c1>::</span><span>level_filters</span><span style=color:#81a1c1>::</span><span>STATIC_MAX_LEVEL</span></span>
<span class=giallo-l><span style=color:#81a1c1>            && ::</span><span>tracing</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Level</span><span style=color:#81a1c1>::</span><span>INFO</span><span style=color:#81a1c1> &lt;= ::</span><span>tracing</span><span style=color:#81a1c1>::</span><span>level_filters</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>LevelFilter</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>current</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>            &&</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                interest</span><span style=color:#81a1c1> =</span><span> CALLSITE</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>interest</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>                !</span><span>interest</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>is_never</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#81a1c1>            && ::</span><span>tracing</span><span style=color:#81a1c1>::</span><span>__macro_support</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>__is_enabled</span><span style=color:#eceff4>(</span><span>CALLSITE</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>metadata</span><span style=color:#eceff4>(),</span><span> interest</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>        {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let</span><span> meta</span><span style=color:#81a1c1> =</span><span> CALLSITE</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>metadata</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>            ::</span><span>tracing</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Span</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>meta</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> &</span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#5e81ac>                #[allow(unused_imports)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>                use ::</span><span>tracing</span><span style=color:#81a1c1>::</span><span>field</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span>debug</span><span style=color:#eceff4>,</span><span> display</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Value</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l><span style=color:#81a1c1>                let mut</span><span> iter</span><span style=color:#81a1c1> =</span><span> meta</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>fields</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>iter</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span>                meta</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>fields</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>value_set</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span style=color:#eceff4>[(</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    &</span><span>iter</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>next</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>expect</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>FieldSet corrupted (this is a bug)</span><span style=color:#eceff4>"),</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                    Some</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>hello</span><span style=color:#eceff4>"</span><span style=color:#81a1c1> as  &dyn</span><span style=color:#8fbcbb> Value</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>                )])</span></span>
<span class=giallo-l><span style=color:#eceff4>            })</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let</span><span> span</span><span style=color:#81a1c1> = ::</span><span>tracing</span><span style=color:#81a1c1>::</span><span>__macro_support</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>__disabled_span</span><span style=color:#eceff4>(</span><span>CALLSITE</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>metadata</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#eceff4>            {};</span></span>
<span class=giallo-l><span>            span</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    };</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> _guard</span><span style=color:#81a1c1> =</span><span> span</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>enter</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        use ::</span><span>tracing</span><span style=color:#81a1c1>::</span><span>__macro_support</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Callsite</span><span style=color:#81a1c1> as</span><span> _</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        static</span><span> CALLSITE</span><span style=color:#81a1c1>: ::</span><span>tracing</span><span style=color:#81a1c1>::</span><span>callsite</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>DefaultCallsite</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            static</span><span> META</span><span style=color:#81a1c1>: ::</span><span>tracing</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Metadata</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>></span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                ::</span><span>tracing_core</span><span style=color:#81a1c1>::</span><span>metadata</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Metadata</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>                    "</span><span style=color:#a3be8c>event src/main.rs:11</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>                    "</span><span style=color:#a3be8c>tracing_handson</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    ::</span><span>tracing</span><span style=color:#81a1c1>::</span><span>Level</span><span style=color:#81a1c1>::</span><span>INFO</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                    Some</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>src/main.rs</span><span style=color:#eceff4>"),</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                    Some</span><span style=color:#eceff4>(</span><span style=color:#b48ead>11</span><span style=color:#8fbcbb>u32</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                    Some</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>tracing_handson</span><span style=color:#eceff4>"),</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    ::</span><span>tracing_core</span><span style=color:#81a1c1>::</span><span>field</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>FieldSet</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#81a1c1>                        &</span><span style=color:#eceff4>["</span><span style=color:#a3be8c>message</span><span style=color:#eceff4>"],</span></span>
<span class=giallo-l><span style=color:#81a1c1>                        ::</span><span>tracing_core</span><span style=color:#81a1c1>::</span><span>callsite</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Identifier</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>CALLSITE</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>                    ),</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    ::</span><span>tracing</span><span style=color:#81a1c1>::</span><span>metadata</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Kind</span><span style=color:#81a1c1>::</span><span>EVENT</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>                )</span></span>
<span class=giallo-l><span style=color:#eceff4>            };</span></span>
<span class=giallo-l><span style=color:#81a1c1>            ::</span><span>tracing</span><span style=color:#81a1c1>::</span><span>callsite</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>DefaultCallsite</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>META</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>        };</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> enabled</span><span style=color:#81a1c1> = ::</span><span>tracing</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Level</span><span style=color:#81a1c1>::</span><span>INFO</span><span style=color:#81a1c1> &lt;= ::</span><span>tracing</span><span style=color:#81a1c1>::</span><span>level_filters</span><span style=color:#81a1c1>::</span><span>STATIC_MAX_LEVEL</span></span>
<span class=giallo-l><span style=color:#81a1c1>            && ::</span><span>tracing</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Level</span><span style=color:#81a1c1>::</span><span>INFO</span><span style=color:#81a1c1> &lt;= ::</span><span>tracing</span><span style=color:#81a1c1>::</span><span>level_filters</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>LevelFilter</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>current</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>            &&</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                let</span><span> interest</span><span style=color:#81a1c1> =</span><span> CALLSITE</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>interest</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>                !</span><span>interest</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>is_never</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    && ::</span><span>tracing</span><span style=color:#81a1c1>::</span><span>__macro_support</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>__is_enabled</span><span style=color:#eceff4>(</span><span>CALLSITE</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>metadata</span><span style=color:#eceff4>(),</span><span> interest</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>            };</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if</span><span> enabled</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#eceff4>            (</span><span style=color:#81a1c1>|</span><span>value_set</span><span style=color:#81a1c1>: ::</span><span>tracing</span><span style=color:#81a1c1>::</span><span>field</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>ValueSet</span><span style=color:#81a1c1>|</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                let</span><span> meta</span><span style=color:#81a1c1> =</span><span> CALLSITE</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>metadata</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>                ::</span><span>tracing</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Event</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>dispatch</span><span style=color:#eceff4>(</span><span>meta</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> &</span><span>value_set</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>            })({</span></span>
<span class=giallo-l><span style=color:#5e81ac>                #[allow(unused_imports)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>                use ::</span><span>tracing</span><span style=color:#81a1c1>::</span><span>field</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span>debug</span><span style=color:#eceff4>,</span><span> display</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Value</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l><span style=color:#81a1c1>                let mut</span><span> iter</span><span style=color:#81a1c1> =</span><span> CALLSITE</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>metadata</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>fields</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>iter</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span>                CALLSITE</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>metadata</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>fields</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>value_set</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span style=color:#eceff4>[(</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    &</span><span>iter</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>next</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>expect</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>FieldSet corrupted (this is a bug)</span><span style=color:#eceff4>"),</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                    Some</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&::</span><span>core</span><span style=color:#81a1c1>::</span><span>fmt</span><span style=color:#81a1c1>::</span><span>Arguments</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new_v1</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span style=color:#eceff4>["</span><span style=color:#a3be8c>hello</span><span style=color:#eceff4>"],</span><span style=color:#81a1c1> &</span><span style=color:#eceff4>[])</span><span style=color:#81a1c1> as  &dyn</span><span style=color:#8fbcbb> Value</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>                )])</span></span>
<span class=giallo-l><span style=color:#eceff4>            });</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    };</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>é•·ã„ã§ã™ãŒã€æ¦‚è¦ã¯ã‚·ãƒ³ãƒ—ãƒ«ã§ã™ã€‚ <code>info_span!()</code>,<code>info!()</code>å…±é€šã§ã€macroã‚’å‘¼ã³å‡ºã™ã¨å½“è©²å‘¼ã³å‡ºã—ç®‡æ‰€ã®æƒ…å ±ãŒä»¥ä¸‹ã®ã‚ˆã†ã«<code>tracing::callsite::DefaultCallsite</code>ã¨ã—ã¦è¡¨ç¾ã•ã‚Œã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>        static</span><span> CALLSITE</span><span style=color:#81a1c1>: ::</span><span>tracing</span><span style=color:#81a1c1>::</span><span>callsite</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>DefaultCallsite</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            static</span><span> META</span><span style=color:#81a1c1>: ::</span><span>tracing</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Metadata</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>></span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                ::</span><span>tracing_core</span><span style=color:#81a1c1>::</span><span>metadata</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Metadata</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#616e88>                    // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>                )</span></span>
<span class=giallo-l><span style=color:#eceff4>            };</span></span>
<span class=giallo-l><span style=color:#81a1c1>            ::</span><span>tracing</span><span style=color:#81a1c1>::</span><span>callsite</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>DefaultCallsite</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>META</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>        };</span></span></code></pre><p>ã¾ãšè¦‹ã¦ã„ãŸã ããŸã„ã®ãŒã€<code>static CALLSITE</code>ã®ã‚ˆã†ã«staticã«ãªã£ã¦ã„ã‚‹ç‚¹ã§ã™ã€‚<br> tracingã®ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚€ã¾ã§çŸ¥ã‚‰ãªã‹ã£ãŸã®ã§ã™ãŒã€rustã§ã¯é–¢æ•°ã®ä¸­ã§ã‚‚staticå¤‰æ•°ãŒå®šç¾©ã§ãã‚‹ãã†ã§ã™ã€‚<blockquote><p>A static item defined in a generic scope (for example in a blanket or default implementation) will result in exactly one static item being defined, as if the static definition was pulled out of the current scope into the module.</blockquote><p>https://doc.rust-lang.org/reference/items/static-items.html#statics--generics<p>é–¢æ•°å†…ã§staticã‚’å®šç¾©ã—ã¦ã‚‚å®Ÿéš›ã«ã¯moduleã®top levelã§å®šç¾©ã—ãŸã®ã¨åŒæ§˜ã«ãªã‚Šã€å½“è©²å¤‰æ•°ã«ã¯å®šç¾©ã—ãŸé–¢æ•°ã‹ã‚‰ã—ã‹ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ã¨ã„ã†æŒ™å‹•ã«ãªã‚Šã¾ã™ã€‚<br> <code>CALLSITE</code>ã«ã¤ã„ã¦ã¯å…¨ä½“ã®æ§‹é€ ã‚’æŠ¼ã•ãˆã¦ã‹ã‚‰ã®ã»ã†ãŒã‚ã‹ã‚Šã‚„ã™ã„ã®ã§ã“ã“ã§ã¯macroã®å‘¼ã³å‡ºã—ã®æƒ…å ±(source codeä¸Šã®ä½ç½®ã€key,value, span or event)ã‚’ä¿æŒã—ã¦ã„ã‚‹ã¨ã„ã†ãã‚‰ã„ã§OKã§ã™ã€‚<p><code>CALLSITE</code>ã¯staticãªã®ã§compileæ™‚ã«æ±ºã¾ã‚Šã¾ã™ã€‚æ¬¡ã®ç®‡æ‰€ã‹ã‚‰ãŒruntimeæ™‚ã®æŒ™å‹•ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>let mut</span><span> interest</span><span style=color:#81a1c1> = ::</span><span>tracing</span><span style=color:#81a1c1>::</span><span>subscriber</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Interest</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>never</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>if ::</span><span>tracing</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Level</span><span style=color:#81a1c1>::</span><span>INFO</span><span style=color:#81a1c1> &lt;= ::</span><span>tracing</span><span style=color:#81a1c1>::</span><span>level_filters</span><span style=color:#81a1c1>::</span><span>STATIC_MAX_LEVEL</span></span>
<span class=giallo-l><span style=color:#81a1c1>    && ::</span><span>tracing</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Level</span><span style=color:#81a1c1>::</span><span>INFO</span><span style=color:#81a1c1> &lt;= ::</span><span>tracing</span><span style=color:#81a1c1>::</span><span>level_filters</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>LevelFilter</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>current</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>    &&</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>        interest</span><span style=color:#81a1c1> =</span><span> CALLSITE</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>interest</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>        !</span><span>interest</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>is_never</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#81a1c1>    && ::</span><span>tracing</span><span style=color:#81a1c1>::</span><span>__macro_support</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>__is_enabled</span><span style=color:#eceff4>(</span><span>CALLSITE</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>metadata</span><span style=color:#eceff4>(),</span><span> interest</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span><span style=color:#616e88> // ... }</span></span></code></pre><p>subscriberã®<code>Interest</code>ãªã‚‹ã‚‚ã®ã‚„ã€levelã®åˆ¤å®šã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚ã“ã¡ã‚‰ã‚‚subscriberã®æ§‹é€ ãŒã‹ã‹ã‚ã£ã¦ãã‚‹ã®ã§å¾Œè¿°ã—ã¾ã™ã€‚ã–ã£ãã‚Šã§ã™ãŒ<code>info_span!()</code>ã‚„<code>debug_span!()</code>ã®ã‚ˆã†ãªlevelã«å¿œã˜ãŸåˆ¤å®šå‡¦ç†ã‚’å®Ÿæ–½ã—ã¦ã„ã‚‹ç¨‹åº¦ã«ç†è§£ã—ã¦ãŠãã¾ã™ã€‚æ¬¡ãŒspanã®å®Ÿè³ªçš„ãªå‡¦ç†ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>let</span><span> meta</span><span style=color:#81a1c1> =</span><span> CALLSITE</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>metadata</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>::</span><span>tracing</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Span</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>meta</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> &</span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#5e81ac>    #[allow(unused_imports)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>    use ::</span><span>tracing</span><span style=color:#81a1c1>::</span><span>field</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span>debug</span><span style=color:#eceff4>,</span><span> display</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Value</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> iter</span><span style=color:#81a1c1> =</span><span> meta</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>fields</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>iter</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span>    meta</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>fields</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>value_set</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span style=color:#eceff4>[(</span></span>
<span class=giallo-l><span style=color:#81a1c1>        &</span><span>iter</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>next</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>expect</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>FieldSet corrupted (this is a bug)</span><span style=color:#eceff4>"),</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Some</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>hello</span><span style=color:#eceff4>"</span><span style=color:#81a1c1> as  &dyn</span><span style=color:#8fbcbb> Value</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>    )])</span></span>
<span class=giallo-l><span style=color:#eceff4>})</span></span></code></pre><p>ã“ã“ã§å¤§äº‹ãªã®ã¯<code>tracing::Span::new()</code>ãŒå‘¼ã³å‡ºã•ã‚Œã¦ã„ã‚‹ç‚¹ã§ã™ã€‚å¼•æ•°ã«ã¯macroå‘¼ã³å‡ºã—æ™‚ã®æƒ…å ±ã‚’æ¸¡ã—ã¦ã„ã¾ã™ã€‚<br> spanã®å‡¦ç†ã«ã¤ã„ã¦ã¾ã¨ã‚ã‚‹ã¨æ¦‚è¦ã¨ã—ã¦ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span>    tracing_subscriber</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>fmt</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>init</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span>    </span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> span</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        static</span><span> CALLSITE</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span><span style=color:#616e88> /* ... */</span><span style=color:#eceff4> };</span></span>
<span class=giallo-l><span>        tracing</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Span</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>CALLSITE</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    };</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> _guard</span><span style=color:#81a1c1> =</span><span> span</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>enter</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>è¦ã¯ã€<code>tracing::Span::new()</code>ã«macroã®æƒ…å ±æ¸¡ã—ã¦ã€spanã‚’ç”Ÿæˆã—ã€<code>span.enter()</code>ã—ã¦ã€guardã‚’dropã—ãªã„ã‚ˆã†ã«å¤‰æ•°ã§ä¿æŒã—ã¦ã„ã‚‹ã ã‘ã§ã™ã€‚<p><code>info!()</code>ã®eventç”Ÿæˆã§ã‚‚æµã‚Œã¯spanã¨åŒã˜ã§ã€staticãª<code>CALLSITE</code>ç”Ÿæˆã€levelã®åˆ¤å®šå‡¦ç†ã€api callã¨ã„ã†æµã‚Œã§ã™ã€‚eventã®å ´åˆã¯<code>tracing::Event::dispatch(CALLSITE)</code>ãŒå‘¼ã°ã‚Œã¾ã™ã€‚<p>è©±ã‚’æ•´ç†ã™ã‚‹ã¨ã€ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ¢ãƒ‡ãƒ«ã¨ã—ã¦ã¯spanã¨eventã®macroã¯æ¦‚ã­ä»¥ä¸‹ã®ã‚ˆã†ã«å±•é–‹ã•ã‚Œã‚‹ã¨ã„ãˆã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span>    tracing_subscriber</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>fmt</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>init</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> span</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0;font-weight:700> info_span!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>span_1</span><span style=color:#eceff4>",</span><span> key</span><span style=color:#81a1c1>=</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>hello</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> _guard</span><span style=color:#81a1c1> =</span><span> span</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>enter</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    info!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>hello</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>â¬‡<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span>    tracing_subscriber</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>fmt</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>init</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> span</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        static</span><span> CALLSITE</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span><span style=color:#616e88> /* ... */</span><span style=color:#eceff4> };</span></span>
<span class=giallo-l><span>        tracing</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Span</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>CALLSITE</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    };</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> _guard</span><span style=color:#81a1c1> =</span><span> span</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>enter</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#eceff4>    {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        static</span><span> CALLSITE</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span><span style=color:#616e88> /* ... */</span><span style=color:#eceff4> }</span></span>
<span class=giallo-l><span>        tracing</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Event</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>dispatch</span><span style=color:#eceff4>(</span><span>CALLSITE</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã¨ã„ã†ã“ã¨ã§ã€ä»¥ä¸‹ã®tracingã®apiã®å‡¦ç†ã‚’è¿½ã£ã¦ã„ãã¾ã™ã€‚<ol><li><code>tracing::Span::new()</code><li><code>tracing::Span::enter()</code><li><code>tracing::Event::dispatch()</code></ol><p>ã•ã£ããã€<code>tracing::Span::new()</code>ã®definitionã«jumpã—ã¦ã„ããŸã„ã¨ã“ã‚ã§ã™ãŒã€ã“ã“ã‹ã‚‰ã¯<code>tracing_subscriber</code>å´ã®å‡¦ç†ã«ãªã‚‹ã®ã§ã€<code>tracing_subscriber</code> crateã«ã¤ã„ã¦èª¬æ˜ã•ã›ã¦ãã ã•ã„ã€‚<h2 id=tracing-subscriber-crate><a aria-label="Anchor link for: tracing-subscriber-crate" class=zola-anchor href=#tracing-subscriber-crate><code>tracing_subscriber</code> crate</a></h2><p><code>tracing</code>ã¯ç”Ÿæˆã—ãŸspanã‚„eventã‚’å‡¦ç†ã™ã‚‹ãŸã‚ã«å¿…è¦ãªæ©Ÿèƒ½ã‚’<a href=https://docs.rs/tracing-core/0.1.30/tracing_core/trait.Subscriber.html rel=external><code>tracing_core::Subscriber</code></a>ã¨ã—ã¦å®šç¾©ã—ã¦ã„ã¾ã™ã€‚tracingã¯<code>tracing_core::Subscriber</code>ã®å®Ÿè£…ãŒspanã‚„eventã®ç”Ÿæˆå‰ã«tracingã®apiã‚’é€šã˜ã¦åˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’æœŸå¾…ã—ã¦ã„ã¾ã™ã€‚<code>tracing_subscriber</code>ã¯<code>tracing_core::Subscriber</code>ã®å®Ÿè£…ã‚’æä¾›ã™ã‚‹ãŸã‚ã®crateã§ã™ã€‚<br> tracingã§ã¯traitã¨ãã‚Œã‚’å®Ÿè£…ã™ã‚‹å‹ã«åŒã˜åå‰ã‚’ä½¿ã†å ´åˆãŒã‚ã‚Šæœ€åˆã¯ç´›ã‚‰ã‚ã—ã„ã®ã§ã™ãŒã€<code>tracing_core::Subscriber</code>ã¯traitã§<code>tracing_subscriber::fmt::Subscriber</code>ã¯ã“ã®traitã®å®Ÿè£…ã‚’æä¾›ã™ã‚‹structã§ã™ã€‚<br> ä»¥å¾Œã¯ç´›ã‚‰ã‚ã—ã„ã®ã§<code>tracing_subscriber</code>ã®re-exportã«ãªã‚‰ã£ã¦ã€<code>tracing_subscriber::fmt::Subscriber</code>ã‚’<code>FmtSubscriber</code>ã¨å‘¼ã³ã¾ã™ã€‚<p>ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã®æœ€åˆã«ã§ã¦ããŸ<code>tracing_subscriber::fmt().init();</code>ã¯<code>FmtSubscriber</code>ã‚’ç”Ÿæˆã—ã¦ã€<code>tracing</code>ã«è¦‹ãˆã‚‹ä½ç½®ã«ã‚»ãƒƒãƒˆã™ã‚‹å‡¦ç†ã¨ç†è§£ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚<h3 id=fmtsubscriber><a aria-label="Anchor link for: fmtsubscriber" class=zola-anchor href=#fmtsubscriber><code>FmtSubscriber</code></a></h3><p>ã•ã£ãã<code>FmtSubscriber</code>ã®å®šç¾©ã‚’ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> Subscriber</span><span style=color:#eceff4>&lt;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    N</span><span style=color:#81a1c1> =</span><span> format</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>DefaultFields</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    E</span><span style=color:#81a1c1> =</span><span> format</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Format</span><span style=color:#eceff4>&lt;</span><span>format</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Full</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    F</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> LevelFilter</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    W</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> fn</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span> io</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Stdout</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span>    inner</span><span style=color:#81a1c1>:</span><span> layer</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Layered</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>F</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Formatter</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>N</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> E</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> W</span><span style=color:#eceff4>>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/fmt/mod.rs#L225-L232 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/fmt/mod.rs#L225</a><p>GenericsãŒ4ã¤ã‚‚ã§ã¦ãã¦ã€ã†ã£ã¨ãªã‚Šã¾ã™ã€‚ãŸã ã—ã€ã‚ˆãã¿ã¦ã¿ã‚‹ã¨ä»¥ä¸‹ã®æ§‹é€ ã‚’ã—ã¦ã„ã‚‹<code>inner</code>ã®wrapperã§ã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span>inner</span><span style=color:#81a1c1>:</span><span> layer</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Layered</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>F</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb>Formatter</span><span style=color:#eceff4>&lt;</span><span>_</span><span style=color:#eceff4>>></span></span></code></pre><p><code>Formatter&lt;_></code>ã¯ã™ãä¸‹ã«ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>pub type</span><span style=color:#8fbcbb> Formatter</span><span style=color:#eceff4>&lt;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    N</span><span style=color:#81a1c1> =</span><span> format</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>DefaultFields</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    E</span><span style=color:#81a1c1> =</span><span> format</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Format</span><span style=color:#eceff4>&lt;</span><span>format</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Full</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    W</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> fn</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span> io</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Stdout</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>></span><span style=color:#81a1c1> =</span><span> layer</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Layered</span><span style=color:#eceff4>&lt;</span><span>fmt_layer</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Layer</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Registry</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> N</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> E</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> W</span><span style=color:#eceff4>>,</span><span style=color:#8fbcbb> Registry</span><span style=color:#eceff4>>;</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/fmt/mod.rs#L237-L241 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/fmt/mod.rs#L237</a><p>ã¨ã„ã†ã“ã¨ã§ã€<code>Formatter</code>ã‚‚å®Ÿä½“ã¯<code>layer::Layered</code>ã§ã—ãŸã€‚<br> <code>N = format::DefaultFields</code>ã¨<code>E = format::Fromat&lt;format::Full></code>ã¯ãƒ­ã‚°ã®å‡ºåŠ›æ–¹æ³•ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹ãŸã‚ã®genericsã€<code>W = fn() -> io::Stdout</code>ã¯ãƒ­ã‚°ã®å‡ºåŠ›å…ˆã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ãŸã‚ã®genericã§ã™ã€‚ãã“ã§ã“ã‚Œã‚‰ã®genericsã‚’ã„ã£ãŸã‚“ç„¡è¦–ã™ã‚‹ã¨<code>FmtSubscriber</code>ã¯æ¦‚ã­ä»¥ä¸‹ã®æ§‹é€ ã‚’ã—ã¦ã„ã‚‹ã¨ã„ãˆã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>Layered&lt;</span></span>
<span class=giallo-l><span>    LevelFilter,</span></span>
<span class=giallo-l><span>    Layered&lt;</span></span>
<span class=giallo-l><span>        fmt_layer::Layer,</span></span>
<span class=giallo-l><span>        Registry,</span></span>
<span class=giallo-l><span>    ></span></span>
<span class=giallo-l><span>></span></span></code></pre><p><code>FmtSubscriber</code>ã¯ã€<code>LevelFilter</code>,<code>fmt_layer::Layer</code>, <code>Registry</code>ã‚’<code>Layered</code>ã¨ã„ã†structã§nestã•ã›ã¦ã§ãã¦ã„ãˆã‚‹ã‚ˆã†ã«è¦‹ãˆãªã„ã§ã—ã‚‡ã†ã‹ã€‚<br> ã¨ã„ã†ã“ã¨ã§ã€<code>tracing_subscriber</code>ã®<code>Layer</code>,<code>Layered</code>ã‚’ã¾ãšã¯ç†è§£ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚<h3 id=layer><a aria-label="Anchor link for: layer" class=zola-anchor href=#layer><code>Layer</code></a></h3><p>ã¾ãšã¯docã‚’è¦‹ã¦ã¿ã¾ã™ã€‚<code>Layer</code>ã«ã¤ã„ã¦ã¯<a href=https://docs.rs/tracing-subscriber/0.3.16/tracing_subscriber/layer/index.html rel=external><code>tracing_subscriber::layer</code> module</a>ã«èª¬æ˜ãŒã‚ã‚Šã¾ã™ã€‚<blockquote><p>The Layer trait, a composable abstraction for building Subscribers.</blockquote><p><code>Layer</code>ã¯<code>Subscriber</code>ã‚’ä½œã‚‹ãŸã‚ã®composable abstractionãªtraitã¨ã‚ã‚Šã¾ã™ã€‚Layerã‚’çŸ¥ã£ãŸã‚ã¨ã«èª­ã‚€ã¨ãªã‚‹ã»ã©ã¨æ€ãˆã¾ã™ãŒæœ€åˆã«èª­ã‚€ã¨ãƒ”ãƒ³ã¨ã“ãªã‹ã£ãŸã§ã™ã€‚<blockquote><p>The Subscriber trait in tracing-core represents the complete set of functionality required to consume tracing instrumentation. This means that a single Subscriber instance is a self-contained implementation of a complete strategy for collecting traces; but it also means that the Subscriber trait cannot easily be composed with other Subscribers.</blockquote><p><code>tracing_core::Subscriber</code>ã¯tracing instrumentationã‚’consumeã™ã‚‹ãŸã‚ã«å¿…è¦ãªæ©Ÿèƒ½ã‚’ã™ã¹ã¦é›†ç´„ã—ãŸã‚‚ã®ãªã®ã§ã€Subscriber instanceã¯ã„ã‚ã„ã‚ãªè²¬å‹™ã‚’ã‚‚ã¡ã¾ã™ã€‚ãã®ãŸã‚Subscriberã‚’ä»–ã®Subscriberã¨çµ„ã¿åˆã‚ã›ã¥ã‚‰ã„ã¨ã„ã†å•é¡Œç‚¹ãŒã‚ã‚Šã¾ã™ã€‚<blockquote><p>In particular, Subscribers are responsible for generating span IDs and assigning them to spans. Since these IDs must uniquely identify a span within the context of the current trace, this means that there may only be a single Subscriber for a given thread at any point in time â€” otherwise, there would be no authoritative source of span IDs.</blockquote><p>Subscriberã‚’ä»–ã®Subscriberã¨composableã«ã§ããªã„ç†ç”±ãŒæ›¸ã„ã¦ã‚ã‚Šã¾ã™ã€‚ã“ã®span IDã‚’ç”Ÿæˆã™ã‚‹ç®‡æ‰€ã«ã¤ã„ã¦ã¯å¾Œè¿°ã—ã¾ã™ã€‚ã“ã“ã§ã¯ã©ã†ã‚„ã‚‰Subscriberã®è²¬å‹™ã®ã²ã¨ã¤ã«spanã«IDã‚’æŒ¯ã‚‹ã“ã¨ãŒã‚ã‚‹ãã‚‰ã„ã‚’æŠ¼ã•ãˆã¦ãŠãã¾ã™ã€‚<blockquote><p>On the other hand, the majority of the Subscriber traitâ€™s functionality is composable: any number of subscribers may observe events, span entry and exit, and so on, provided that there is a single authoritative source of span IDs. The Layer trait represents this composable subset of the Subscriber behavior; it can observe events and spans, but does not assign IDs.</blockquote><p>ä¸€æ–¹ã§ã€Subscriber traitã®methodã¯composableã€‚<br> eventã®å‡ºåŠ›ã‚„spanã®entryã‚„exitã¨ã„ã£ãŸå‡¦ç†ã¯è¤‡æ•°ã®subscriberã§å®Ÿè£…ã§ãã¾ã™ã€‚(stdoutã«jsonã§loggingã—ã¤ã¤ã€ç‰¹å®šã®spanã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨ˆæ¸¬ã—ã¤ã¤ã€ç‰¹å®šã®eventã‚’metricsã§åé›†ã—ãŸã‚Š)<br> Layer traitã¯Subscriber traitã®ä¸€éƒ¨ã®methodã®å®Ÿè£…ã‚’æ‹…ã„ã€Subscriberã‚’composableã«ã™ã‚‹ãŸã‚ã«ã‚ã‚Šã¾ã™ã€‚<p>ã¾ã¨ã‚<ul><li><code>tracing_core::Subscriber</code>ã«ã¯tracingã‚’åˆ©ç”¨ã™ã‚‹ã†ãˆã§å¿…è¦ãªå‡¦ç†ãŒã¾ã¨ã‚ã¦å®šç¾©ã•ã‚Œã¦ã„ã‚‹<li>Subscriberã®å®Ÿè£…ã¯spanã«IDã‚’ä»˜ä¸ã™ã‚‹è²¬å‹™ã‚’ã‚‚ã¤è¦³ç‚¹ã‹ã‚‰ç‰¹å®šã®contextå†…ã§1ã¤ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚‹<li>ãã“ã§Subscriberã‚’composableã«ä½œã£ã¦ã„ããŸã‚ã«LayerãŒã‚ã‚‹</ul><h3 id=layered><a aria-label="Anchor link for: layered" class=zola-anchor href=#layered><code>Layered</code></a></h3><p>æ¬¡ã«<code>tracing_subscriber::layer::Layered</code>ã‚’ã¿ã¦ã„ãã¾ã™ã€‚<code>Layered</code>ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> Layered</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>L</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> I</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> I</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#616e88>    /// The layer.</span></span>
<span class=giallo-l><span>    layer</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> L</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    /// The inner value that `self.layer` was layered onto.</span></span>
<span class=giallo-l><span style=color:#616e88>    ///</span></span>
<span class=giallo-l><span style=color:#616e88>    /// If this is also a `Layer`, then this `Layered` will implement `Layer`.</span></span>
<span class=giallo-l><span style=color:#616e88>    /// If this is a `Subscriber`, then this `Layered` will implement</span></span>
<span class=giallo-l><span style=color:#616e88>    /// `Subscriber` instead.</span></span>
<span class=giallo-l><span>    inner</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> I</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/layer/layered.rs#L22<p>çœç•¥ã—ã¦ã„ã¾ã™ãŒã€åŸºæœ¬çš„ã«ã¯1ã¤ã®Layerã§innerã‚’wrapã™ã‚‹structã§ã™ã€‚ã‚³ãƒ¡ãƒ³ãƒˆã«ã‚ã‚‹é€šã‚Šã€<code>inner: I</code>ã«ã¯<code>Subscriber</code>ã‚„<code>Layer</code>ã‚’ã„ã‚Œã¾ã™ã€‚<p>é‡è¦ãªã®ã¯<code>Layered</code>ã¯<code>Subscriber</code>ã‚’wrapã—ã¦ã„ã‚‹ã¨ãã¯Subscriberã¨ã—ã¦æŒ¯ã‚‹èˆã†ç‚¹ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>L</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Subscriber</span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> Layered</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>L</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    L</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Layer</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    S</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Subscriber</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/layer/layered.rs#L89 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/layer/layered.rs#L89</a><p>ã¾ãŸ<code>Subscriber</code>ã®å®Ÿè£…æ–¹æ³•ã¯<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> event</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> event</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Event</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>inner</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>event</span><span style=color:#eceff4>(</span><span>event</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>layer</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>on_event</span><span style=color:#eceff4>(</span><span>event</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> self.</span><span style=color:#88c0d0>ctx</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/layer/layered.rs#L151-L154<p>ã®ã‚ˆã†ã«ã€wrapã—ã¦ã„ã‚‹innerã‚’å‘¼ã³å‡ºã—ãŸå¾Œè‡ªèº«ã®layerã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚<p>ã¾ã¨ã‚ã‚‹ã¨<code>Layered</code>ã¯<code>Subscriber</code>ã‚’composableã«æ§‹ç¯‰ã™ã‚‹ãŸã‚ã®<code>Layer</code>ã‚’ã¾ã¨ã‚ã¦ã„ããŸã‚ã®structã§ãã‚Œè‡ªèº«ã‚‚<code>Subscriber</code>ã®å®Ÿè£…ã§ã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚<h3 id=filter><a aria-label="Anchor link for: filter" class=zola-anchor href=#filter><code>Filter</code></a></h3><p>ã‚ã‚‰ãŸã‚ã¦<code>FmtSubscriber</code>ã®æ¦‚è¦ã‚’ç¢ºèªã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>Layered&lt;</span></span>
<span class=giallo-l><span>    LevelFilter,</span></span>
<span class=giallo-l><span>    Layered&lt;</span></span>
<span class=giallo-l><span>        fmt_layer::Layer,</span></span>
<span class=giallo-l><span>        Registry,</span></span>
<span class=giallo-l><span>    ></span></span>
<span class=giallo-l><span>>    </span></span></code></pre><p><code>Layered</code>ã¯innerã«<code>Subscriber</code>(or<code>Layer</code>)ã‚’ã‚‚ã¡<code>Layer</code>ã¨çµ„ã¿åˆã‚ã›ã‚‹ã¨ã„ã†ã“ã¨ã‚’ã¿ã¦ãã¾ã—ãŸã€‚<br> ã¨ã™ã‚‹ã¨ã€<code>LevelFilter</code>ã‚‚Filterã¨ã„ã„ãªãŒã‚‰Layerãªã®ã§ã—ã‚‡ã†ã‹ã€‚ã“ã“ã§ã¯Filterã«ã¤ã„ã¦è¦‹ã¦ã„ãã¾ã™ã€‚<p>Filterã«ã¤ã„ã¦ã¯<a href=https://docs.rs/tracing-subscriber/0.3.16/tracing_subscriber/layer/index.html#filtering-with-layers rel=external>layer moduleã®doc</a>ã§ä»¥ä¸‹ã®ã‚ˆã†ã«èª¬æ˜ã•ã‚Œã¦ã„ã¾ã™ã€‚<blockquote><p>As well as strategies for handling trace events, the Layer trait may also be used to represent composable filters. This allows the determination of what spans and events should be recorded to be decoupled from how they are recorded: a filtering layer can be applied to other layers or subscribers.</blockquote><p>ã¨ã„ã†ã“ã¨ã§<code>Layer</code>ã®ã†ã¡,spanã‚„eventã‚’å‡¦ç†å¯¾è±¡ã¨ã™ã‚‹ã‹ã®åˆ¤å®šã®ã¿ã‚’è¡Œã†<code>Layer</code>ã‚’<code>Filter</code>ã¨ã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>pub use</span><span> tracing_core</span><span style=color:#81a1c1>::</span><span>metadata</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>LevelFilter</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> ParseLevelFilterError</span><span style=color:#81a1c1> as</span><span style=color:#8fbcbb> ParseError</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Subscriber</span><span style=color:#eceff4>></span><span style=color:#81a1c1> crate::</span><span style=color:#8fbcbb>Layer</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>></span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> LevelFilter</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> register_callsite</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> metadata</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>static Metadata</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Interest</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if self >=</span><span> metadata</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>level</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Interest</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>always</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Interest</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>never</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> enabled</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> metadata</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Metadata</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>,</span><span> _</span><span style=color:#81a1c1>: crate::</span><span>layer</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Context</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> bool</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self >=</span><span> metadata</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>level</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> max_level_hint</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>LevelFilter</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Some</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>*self</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/filter/level.rs#L11 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/filter/level.rs#L11</a><p>ã¨ã—ã¦ã€<code>LevelFilter</code>ã«<code>Layer</code>ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚<br> ã¨ã„ã†ã“ã¨ã§<code>LevelFilter</code>ã®å®Ÿä½“ã¯tracingã®æœ‰åŠ¹åˆ¤æ–­ã‚’å®Ÿè£…ã—ãŸ<code>Layer</code>ã¨ã„ã†ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚<h3 id=registry><a aria-label="Anchor link for: registry" class=zola-anchor href=#registry><code>Registry</code></a></h3><p><code>FmtSubscriber</code>ã®componentã§æ¬¡ã«ã¿ã¦ã„ãã®ãŒ<code>Registry</code>ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>Layered&lt;</span></span>
<span class=giallo-l><span>    LevelFilter,</span></span>
<span class=giallo-l><span>    Layered&lt;</span></span>
<span class=giallo-l><span>        fmt_layer::Layer,</span></span>
<span class=giallo-l><span>        Registry,</span></span>
<span class=giallo-l><span>    ></span></span>
<span class=giallo-l><span>>    </span></span></code></pre><p><code>Registry</code>ã¯ã‚‚ã£ã¨ã‚‚æ·±ãnestã•ã‚Œã¦ãŠã‚Šã€ä»–ã®Layerã¯Registryä¸Šã«composeã•ã‚Œã¦ã„ã¾ã™ã€‚ã¾ãŸã€<code>Layered</code>ã®å®Ÿè£…ã§ã¯åŸºæœ¬çš„ã«innerã‚’æœ€åˆã«å‘¼ã³å‡ºã™ã®ã§å®Ÿè³ªçš„ã«æœ€åˆã«å‘¼ã³å‡ºã•ã‚Œã‚‹ã®ã¯<code>Registry</code>ã®å‡¦ç†ã«ãªã‚Šã¾ã™ã€‚ã¾ãšã¯<a href=https://docs.rs/tracing-subscriber/0.3.16/tracing_subscriber/registry/struct.Registry.html rel=external><code>tracing_subscriber::registry::Registry</code>ã®doc</a>ã‚’è¦‹ã¦ã¿ã¾ã™ã€‚<blockquote><p>A shared, reusable store for spans. A Registry is a Subscriber around which multiple Layers implementing various behaviors may be added. Unlike other types implementing Subscriber, Registry does not actually record traces itself: instead, it collects and stores span data that is exposed to any Layers wrapping it through implementations of the LookupSpan trait. The Registry is responsible for storing span metadata, recording relationships between spans, and tracking which spans are active and which are closed. In addition, it provides a mechanism for Layers to store user-defined per-span data, called extensions, in the registry. This allows Layer-specific data to benefit from the Registryâ€™s high-performance concurrent storage.</blockquote><p>ã¾ã¨ã‚ã‚‹ã¨<ul><li>Subscriberã®å®Ÿè£…ã§ã€layerãŒè¿½åŠ ã•ã‚Œã‚‹<li>traceã‚’è¨˜éŒ²ã—ãªã„<li>spanã®dataã‚’collectã—ã¦ä»–ã®layerã«æä¾›ã™ã‚‹<li>metadataã‚„relationships,activeã‚„closeã¨ã„ã£ãŸspanã®æƒ…å ±ã‚’ç®¡ç†ã™ã‚‹<li>extensionã‚’é€šã˜ã¦userå´ã§spanã‚’æ‹¡å¼µã§ãã‚‹ä»•çµ„ã¿ã‚’æä¾›ã™ã‚‹</ul><p>ã¨ã„ã†ã“ã¨ã§ã€<code>Subscriber</code>ã®æ©Ÿèƒ½ã®ã†ã¡spané–¢é€£ã®è²¬å‹™ã‚’ã«ãªã£ã¦ã„ãã†ã§ã™ã€‚è©³ç´°ã«ã¤ã„ã¦ã¯ã“ã®ã‚ã¨<code>Span::new()</code>ã‚„<code>Span::enter()</code>ã‚’ãŠã£ã¦ã„ãä¸­ã§ã¿ã¦ã„ãã¾ã™ã€‚<br> ã“ã“ã§ã¯ä»¥ä¸‹ã®ç‚¹ã‚’ãŠã•ãˆã¾ã™<ul><li><code>Layered</code>ã®å®Ÿè£…ã‹ã‚‰æœ€åˆã«ã‚ˆã°ã‚Œã‚‹ã®ã¯<code>Registry</code>ã®å‡¦ç†<li>spanã®æƒ…å ±ã‚’ç®¡ç†ã—ã¦ä»–ã®<code>Layer</code>ã«æä¾›ã™ã‚‹ã®ãŒ<code>Registry</code>ã®è²¬å‹™</ul><h3 id=fmt-layer-layer><a aria-label="Anchor link for: fmt-layer-layer" class=zola-anchor href=#fmt-layer-layer><code>fmt_layer::Layer</code></a></h3><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>Layered&lt;</span></span>
<span class=giallo-l><span>    LevelFilter,</span></span>
<span class=giallo-l><span>    Layered&lt;</span></span>
<span class=giallo-l><span>        fmt_layer::Layer,</span></span>
<span class=giallo-l><span>        Registry,</span></span>
<span class=giallo-l><span>    ></span></span>
<span class=giallo-l><span>>    </span></span></code></pre><p><code>FmtSubscriber</code>ã®æœ€å¾Œã®componentã¯<code>fmt_layer::Layer</code>ã§ã™ã€‚<a href=https://docs.rs/tracing-subscriber/0.3.16/tracing_subscriber/fmt/struct.Layer.html rel=external>doc</a>ã«<blockquote><p>A Layer that logs formatted representations of tracing events.</blockquote><p>ã¨ã‚ã‚‹é€šã‚Šã€<code>tracing_subscriber::Layer</code>ã‚’å®Ÿè£…ã™ã‚‹structã§ã™ã€‚ã“ã®LayerãŒå®Ÿéš›ã«<code>info!()</code>ã—ãŸéš›ã«eventã‚’å‡ºåŠ›ã™ã‚‹å‡¦ç†ã‚’å®Ÿè£…ã—ã¾ã™ã€‚<p>ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> Layer</span><span style=color:#eceff4>&lt;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    S</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    N</span><span style=color:#81a1c1> =</span><span> format</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>DefaultFields</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    E</span><span style=color:#81a1c1> =</span><span> format</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Format</span><span style=color:#eceff4>&lt;</span><span>format</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Full</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    W</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> fn</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span> io</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Stdout</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span>    make_writer</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> W</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    fmt_fields</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> N</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    fmt_event</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> E</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    fmt_span</span><span style=color:#81a1c1>:</span><span> format</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>FmtSpanConfig</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    is_ansi</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> bool</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    log_internal_errors</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> bool</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    _inner</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> PhantomData</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>fn</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>)>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/fmt/fmt_layer.rs#L62 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/fmt/fmt_layer.rs#L62</a><p>4ã¤ã‚‚genericsã‚’ã‚‚ã£ã¦ã„ã¾ã™ã€‚<code>FmtSubscriber</code>ã®genericsãŒå¤šã‹ã£ãŸã®ã¯ã“ã®<code>fmt_layer::Layer</code>ã®ãŸã‚ã§ã™ã€‚<br> ã¾ãš<code>S</code>ã§ã™ãŒã€ã“ã‚Œã¯<code>fmt_layer::Layer</code>ãŒwrapã—ã¦ã„ã‚‹<code>Subscriber</code>ã‚’æŠ½è±¡åŒ–ã—ã¦ã„ã¾ã™ã€‚æœ€åˆã‚ã‹ã‚Šã¥ã‚‰ã‹ã£ãŸã®ã¯<code>fmt_layer::Layer</code>è‡ªä½“ã¯<code>Subscriber</code>ã‚’ä¿æŒã—ã¦ãŠã‚‰ãšã€å®Ÿéš›ã«ä¿æŒã—ã¦ã„ã‚‹ã®ã¯<code>Layered</code>ã«ãªã‚Šã¾ã™ã€‚ãã®ãŸã‚ã€<code>PhantomData&lt;fn(S)></code>ã¨ãªã£ã¦ã„ã¾ã™ã€‚<br> <code>N</code>ã¨<code>E</code>ã§ã™ãŒã€<code>tracing_subscriber</code>ã§ã¯eventã‚’å‡ºåŠ›ã™ã‚‹éš›ã«å¿…è¦ãªæ©Ÿèƒ½ãŒç´°ã‹ãtraitã«ãªã£ã¦ã„ã¾ã™ã€‚<br> <code>N</code>ã¯eventã¨spanå…±é€šã®key,valueã‚’å‡ºåŠ›ã—ã€<code>E</code>ã¯å®Ÿéš›ã«eventã‚’å‡ºåŠ›ã—ã¾ã™ã€‚<code>W</code>ã¯å‡ºåŠ›å…ˆã®åˆ‡ã‚Šæ›¿ãˆã‚’æ‹…ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> N</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> E</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> W</span><span style=color:#eceff4>></span><span> layer</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Layer</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>></span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> Layer</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> N</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> E</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> W</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    S</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Subscriber</span><span style=color:#81a1c1> + for</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> LookupSpan</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    N</span><span style=color:#81a1c1>: for</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>writer</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> FormatFields</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>writer</span><span style=color:#eceff4>></span><span style=color:#81a1c1> +</span><span style=color:#eceff4> '</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    E</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> FormatEvent</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> N</span><span style=color:#eceff4>></span><span style=color:#81a1c1> +</span><span style=color:#eceff4> '</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    W</span><span style=color:#81a1c1>: for</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>writer</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> MakeWriter</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>writer</span><span style=color:#eceff4>></span><span style=color:#81a1c1> +</span><span style=color:#eceff4> '</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> on_event</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> event</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Event</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>,</span><span> ctx</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Context</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>>) {</span><span style=color:#616e88> /* .. */</span><span style=color:#eceff4> }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/fmt/fmt_layer.rs#L764 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/fmt/fmt_layer.rs#L764</a><p>ã®ã¡ã»ã©å‡¦ç†ã®å†…å®¹ã‚’ãŠã£ã¦ã„ãã¾ã™ãŒã€<code>fmt_layer::Layer</code>ãŒ<code>Layer</code>ã‚’å®Ÿè£…ã—ã¦ãŠã‚Šã€<code>Layered</code>ã‹ã‚‰å‘¼ã°ã‚Œã‚‹<code>on_event()</code>ãŒå®Ÿéš›ã®eventã®ãƒ­ã‚®ãƒ³ã‚°å‡¦ç†ã§ã™ã€‚<h3 id=subscribernodeng-lu><a aria-label="Anchor link for: subscribernodeng-lu" class=zola-anchor href=#subscribernodeng-lu><code>Subscriber</code>ã®ç™»éŒ²</a></h3><p><code>FmtSubscriber</code>ã®å„componentã‚’ã¿ã¦ããŸã®ã§æœ€å¾Œã«constructã—ãŸ<code>FmtSubscriber</code>ã‚’<code>tracing</code>ã‹ã‚‰è¦‹ãˆã‚‹ä½ç½®ã«ã‚»ãƒƒãƒˆã™ã‚‹å‡¦ç†ã‚’ã¿ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span>tracing_subscriber</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>fmt</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>init</span><span style=color:#eceff4>();</span></span></code></pre><p>ã“ã®å‡¦ç†ãŒå‘¼ã°ã‚Œã‚‹ã¨<code>SubscriberBuilder</code>ãŒ<code>FmtSubscriber</code>ã‚’constructã—ãŸã®ã¡ä»¥ä¸‹ã®å‡¦ç†ãŒå‘¼ã°ã‚Œã¾ã™<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> try_init</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;(),</span><span style=color:#8fbcbb> TryInitError</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span>        dispatcher</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>set_global_default</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>map_err</span><span style=color:#eceff4>(</span><span>TryInitError</span><span style=color:#81a1c1>::</span><span>new</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span>    </span></span>
<span class=giallo-l><span style=color:#616e88>        // ...</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        Ok</span><span style=color:#eceff4>(())</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/util.rs#L59 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/util.rs#L59</a><p><code>dispatcher::set_global_default</code>ã¯<code>tracing_core</code>ã«å®šç¾©ã•ã‚Œã¦ãŠã‚Šã€ä»¥ä¸‹ã®ã‚ˆã†ãªå‡¦ç†ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>static</span><span> GLOBAL_INIT</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> AtomicUsize</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> AtomicUsize</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>UNINITIALIZED</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>const</span><span> UNINITIALIZED</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> usize</span><span style=color:#81a1c1> =</span><span style=color:#b48ead> 0</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>const</span><span> INITIALIZING</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> usize</span><span style=color:#81a1c1> =</span><span style=color:#b48ead> 1</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>const</span><span> INITIALIZED</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> usize</span><span style=color:#81a1c1> =</span><span style=color:#b48ead> 2</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>static mut</span><span> GLOBAL_DISPATCH</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Dispatch</span><span style=color:#eceff4>></span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> None</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#616e88>// ...</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub fn</span><span style=color:#88c0d0> set_global_default</span><span style=color:#eceff4>(</span><span>dispatcher</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Dispatch</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;(),</span><span style=color:#8fbcbb> SetGlobalDefaultError</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    if</span><span> GLOBAL_INIT</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>compare_exchange</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>            UNINITIALIZED</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            INITIALIZING</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            Ordering</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>SeqCst</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            Ordering</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>SeqCst</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>        )</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>is_ok</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>    {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        unsafe</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            GLOBAL_DISPATCH</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>dispatcher</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span>        GLOBAL_INIT</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>store</span><span style=color:#eceff4>(</span><span>INITIALIZED</span><span style=color:#eceff4>,</span><span> Ordering</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>SeqCst</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span>        EXISTS</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>store</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>true</span><span style=color:#eceff4>,</span><span> Ordering</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Release</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Ok</span><span style=color:#eceff4>(())</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Err</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>SetGlobalDefaultError</span><span style=color:#eceff4> {</span><span> _no_construct</span><span style=color:#81a1c1>:</span><span style=color:#eceff4> () })</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-core/src/dispatcher.rs#L296 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-core/src/dispatcher.rs#L296</a><p>åå‰ã«globalã¨ã‚ã‚‹é€šã‚Šglobalå¤‰æ•°ã®<code>GLOBAL_DISPATCH</code>ã«ã‚»ãƒƒãƒˆã™ã‚‹å‡¦ç†ã§ã™ã€‚<br> <code>AtomicUsize::compare_exchange()</code>ã¯ç¾åœ¨ã®å€¤ãŒç¬¬ä¸€å¼•æ•°ã®ã¨ãã®ã¿ç¬¬äºŒå¼•æ•°ã®å€¤ã‚’ã‚»ãƒƒãƒˆã™ã‚‹é–¢æ•°ã§ã™ã€‚<br> ãã®ãŸã‚ã“ã®å‡¦ç†ã¯ä¸€åº¦ã—ã‹å‘¼ã¹ãªã„ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚<br> <code>set_global_default()</code>ã®å¼•æ•°ã®å‹ã¯<code>Dispatch</code>ã¨ãªã£ã¦ã„ã‚‹ã®ã§ã€<code>FmtSubscriber</code>ã‹ã‚‰<code>Dispatch</code>ã¸ã®å¤‰æ›ãŒå¿…è¦ã§ã™ã€‚<p>ã“ã“ã§<code>Dispatch</code>ã®å®šç¾©ã§ã™ãŒä»¥ä¸‹ã«ã‚ã‚‹é€šã‚Šã€<code>Subscriber</code>ã‚’<code>Arc</code>ã§trait objectã¨ã—ã¦ä¿æŒã—ã¦ã„ã‚‹wrapperã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Clone</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> Dispatch</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    subscriber</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Arc</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>dyn</span><span style=color:#8fbcbb> Subscriber</span><span style=color:#81a1c1> +</span><span style=color:#8fbcbb> Send</span><span style=color:#81a1c1> +</span><span style=color:#8fbcbb> Sync</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-core/src/dispatcher.rs#L154 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-core/src/dispatcher.rs#L154</a><p>ã‚·ãƒ³ãƒ—ãƒ«ãªwrapperãªã®ã§<code>tracing_core::Subscriber</code>ã‚’å®Ÿè£…ã—ãŸå‹ã‹ã‚‰<code>Dispatch</code>ã¸ã®å¤‰æ›ãŒæä¾›ã•ã‚Œã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> From</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>></span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> Dispatch</span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    S</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Subscriber</span><span style=color:#81a1c1> +</span><span style=color:#8fbcbb> Send</span><span style=color:#81a1c1> +</span><span style=color:#8fbcbb> Sync</span><span style=color:#81a1c1> +</span><span style=color:#eceff4> '</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#5e81ac>    #[inline]</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> from</span><span style=color:#eceff4>(</span><span>subscriber</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Dispatch</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>subscriber</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-core/src/dispatcher.rs#L720 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-core/src/dispatcher.rs#L720</a><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Dispatch</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> new</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>>(</span><span>subscriber</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> Self</span></span>
<span class=giallo-l><span style=color:#81a1c1>        where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            S</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Subscriber</span><span style=color:#81a1c1> +</span><span style=color:#8fbcbb> Send</span><span style=color:#81a1c1> +</span><span style=color:#8fbcbb> Sync</span><span style=color:#81a1c1> +</span><span style=color:#eceff4> '</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> me</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Dispatch</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            subscriber</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Arc</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>subscriber</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>        };</span></span>
<span class=giallo-l><span>        callsite</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>register_dispatch</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>me</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span>        me</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-core/src/dispatcher.rs#L451 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-core/src/dispatcher.rs#L451</a><p><code>Dispatch::new()</code>ã®ä¸­ã§<code>Subscriber</code>ã‚’Heapã«ç¢ºä¿ã—ã¾ã™ã€‚<code>callsite::register_dispatch()</code>ã¯ã®ã¡ã»ã©è¨€åŠã—ã¾ã™ã€‚<p>ã¨ã„ã†ã“ã¨ã§ã€<code>FmtSubscriber</code>ã®åˆæœŸåŒ–å‡¦ç†(<code>init()</code>)ã§ã¯<code>FmtSubscriber</code>ã‚’Arcã«ã—ã¦<code>Dispatch</code>ã§è–„ãwrapã—ã¦globalå¤‰æ•°ã«ã‚»ãƒƒãƒˆã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚<code>info!()</code>ã‚„<code>info_span!()</code>ã§ã¯ã“ã®globalã®<code>Dispatch</code>(<code>FmtSubscriber</code>)ãŒå‚ç…§ã•ã‚Œã¾ã™ã€‚<br> <code>callsite::register_dispatch()</code>ã¯filteringå‡¦ç†ã‚’è¦‹ã¦ã„ãéš›ã«ç¢ºèªã—ã¾ã™ã€‚<h3 id=fmtsubscriber-matome><a aria-label="Anchor link for: fmtsubscriber-matome" class=zola-anchor href=#fmtsubscriber-matome><code>FmtSubscriber</code> ã¾ã¨ã‚</a></h3><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>Layered&lt;</span></span>
<span class=giallo-l><span>    LevelFilter,</span></span>
<span class=giallo-l><span>    Layered&lt;</span></span>
<span class=giallo-l><span>        fmt_layer::Layer,</span></span>
<span class=giallo-l><span>        Registry,</span></span>
<span class=giallo-l><span>    ></span></span>
<span class=giallo-l><span>></span></span></code></pre><p><code>FmtSubscriber</code>ã®å„componentã®æ¦‚è¦ã‚’ã¿ã¦ãã¾ã—ãŸã€‚<br> <code>Layered</code>ã¯<code>Layer</code>ã¨<code>Subscriber</code>ã‚’composeã™ã‚‹å‹ã§ãã‚Œè‡ªèº«ãŒ<code>Subscriber</code>ã§ã™ã€‚<br> <code>LevelFilter</code>ã¯loggingã®enableåˆ¤æ–­ã‚’è¡Œã†<code>Layer</code>ã§ã™ã€‚<br> <code>fmt_layer::Layer</code>ã¯eventã®loggingã‚’æ‹…ã†<code>Layer</code>ã§<code>info!()</code>ãŒloggingã•ã‚Œã‚‹ã®ã¯ã“ã®<code>Layer</code>ã®å®Ÿè£…ã«ã‚ˆã‚Šã¾ã™ã€‚<br> <code>Register</code>ã¯root Layerã¨ã‚‚ã„ã†ã¹ãå½¹å‰²ã§ã€spanã®ç®¡ç†ã‚’ãŠã“ãªã„ã¾ã™ã€‚<h2 id=tracing-span-new><a aria-label="Anchor link for: tracing-span-new" class=zola-anchor href=#tracing-span-new><code>tracing::Span::new()</code></a></h2><p><code>FmtSubscriber</code>ã®æ¦‚è¦ã‚’æŠ¼ã•ãˆãŸã®ã§ã„ã‚ˆã„ã‚ˆtracingã®apiã‚’è¿½ã£ã¦ã„ãã¾ã™ã€‚ ã‚³ãƒ¼ãƒ‰ã®æ¦‚ç•¥ã‚’ã‚‚ã†ä¸€åº¦ã¿ã¦ã¿ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span>    tracing_subscriber</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>fmt</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>init</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> span</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        static</span><span> CALLSITE</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span><span style=color:#616e88> /* ... */</span><span style=color:#eceff4> };</span></span>
<span class=giallo-l><span>        tracing</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Span</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>CALLSITE</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    };</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> _guard</span><span style=color:#81a1c1> =</span><span> span</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>enter</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#eceff4>    {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        static</span><span> CALLSITE</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span><span style=color:#616e88> /* ... */</span><span style=color:#eceff4> }</span></span>
<span class=giallo-l><span>        tracing</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Event</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>dispatch</span><span style=color:#eceff4>(</span><span>CALLSITE</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>tracing_subscriber::fmt().init()</code>ãŒ<code>FmtSubscriber</code>ã®constructã¨globalå¤‰æ•°ã¸ã®ã‚»ãƒƒãƒˆã¨ã„ã†ã“ã¨ã‚’è¦‹ã¦ããŸã®ã§ã€<code>tracing::Span::new()</code>ã‚’ã¿ã¦ã„ãã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Span</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> new</span><span style=color:#eceff4>(</span><span>meta</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>static Metadata</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>>,</span><span> values</span><span style=color:#81a1c1>: &</span><span>field</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>ValueSet</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Span</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>        dispatcher</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>get_default</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>dispatch</span><span style=color:#81a1c1>| Self::</span><span style=color:#88c0d0>new_with</span><span style=color:#eceff4>(</span><span>meta</span><span style=color:#eceff4>,</span><span> values</span><span style=color:#eceff4>,</span><span> dispatch</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span>    </span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> new_with</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>        meta</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>static Metadata</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>        values</span><span style=color:#81a1c1>: &</span><span>field</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>ValueSet</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>        dispatch</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Dispatch</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    )</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Span</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> new_span</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Attributes</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>meta</span><span style=color:#eceff4>,</span><span> values</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>        Self::</span><span style=color:#88c0d0>make_with</span><span style=color:#eceff4>(</span><span>meta</span><span style=color:#eceff4>,</span><span> new_span</span><span style=color:#eceff4>,</span><span> dispatch</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> make_with</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>        meta</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>static Metadata</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>        new_span</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Attributes</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>        dispatch</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Dispatch</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    )</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Span</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> attrs</span><span style=color:#81a1c1> = &</span><span>new_span</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> id</span><span style=color:#81a1c1> =</span><span> dispatch</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>new_span</span><span style=color:#eceff4>(</span><span>attrs</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> inner</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Inner</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>id</span><span style=color:#eceff4>,</span><span> dispatch</span><span style=color:#eceff4>));</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> span</span><span style=color:#81a1c1> = Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            inner</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            meta</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>meta</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>        };</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>        // ...</span></span>
<span class=giallo-l><span>        </span></span>
<span class=giallo-l><span>        span</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing/src/span.rs#L436 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing/src/span.rs#L436</a><p><code>dispatcher::get_default()</code>ã«<code>Span::new_with()</code>ã§è‡ªèº«ã‚’constructã™ã‚‹å‡¦ç†ã‚’closureã§æ¸¡ã—ã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#88c0d0;font-weight:700>thread_local!</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    static</span><span> CURRENT_STATE</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> State</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> State</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>        default</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> RefCell</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>None</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span>        can_enter</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Cell</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>true</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>    };</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> State</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    default</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> RefCell</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Dispatch</span><span style=color:#eceff4>>>,</span></span>
<span class=giallo-l><span>    can_enter</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Cell</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>bool</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>pub fn</span><span style=color:#88c0d0> get_default</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> F</span><span style=color:#eceff4>>(</span><span style=color:#81a1c1>mut</span><span> f</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> F</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> T</span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    F</span><span style=color:#81a1c1>:</span><span style=color:#88c0d0> FnMut</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span style=color:#8fbcbb>Dispatch</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> T</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span>    CURRENT_STATE</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>try_with</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>state</span><span style=color:#81a1c1>|</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            if let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>entered</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> state</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>enter</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                return</span><span style=color:#88c0d0> f</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&*</span><span>entered</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>current</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>            f</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>Dispatch</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>none</span><span style=color:#eceff4>())</span></span>
<span class=giallo-l><span style=color:#eceff4>        })</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>unwrap_or_else</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>_</span><span style=color:#81a1c1>|</span><span style=color:#88c0d0> f</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>Dispatch</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>none</span><span style=color:#eceff4>()))</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-core/src/dispatcher.rs#L364 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-core/src/dispatcher.rs#L364</a><p><code>dispatcher::get_default()</code>ã®ä¸­ã§ã¯threadã”ã¨ã«ä¿æŒã—ã¦ã„ã‚‹<code>Dispatch</code>ã‚’å‚ç…§ã—ã¾ã™ã€‚<code>State.default</code>ã«ä¿æŒã•ã‚Œã¦ã„ã‚‹<code>RefCell&lt;Option&lt;Dispatch>></code>ã¯åˆæœŸçŠ¶æ…‹ã§ã¯<code>None</code>ã§ã™ã€‚<p><code>State</code>è‡ªä½“ã¯staticã§compileæ™‚ã«åˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€<code>State::enter()</code>ã®å‡¦ç†ã‚’ã¿ã¦ã¿ã‚‹ã¨<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> State</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> enter</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Entered</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    if self.</span><span>can_enter</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>replace</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>false</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Some</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>Entered</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        None</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-core/src/dispatcher.rs#L799 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-core/src/dispatcher.rs#L799</a><p><code>Entered</code>ã¨ã„ã†<code>State</code>ã®guardã‚’è¡¨ã™å‹ã‚’è¿”ã—ã€<code>Entered::current()</code>ã®æˆ»ã‚Šå€¤ã§<code>Span::new()</code>ã§æ¸¡ã—ãŸclosureã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Entered</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#5e81ac>    #[inline]</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> current</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> RefMut</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Dispatch</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> default</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> RefMut</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Dispatch</span><span style=color:#eceff4>>></span><span style=color:#81a1c1> = self.</span><span style=color:#b48ead>0</span><span style=color:#eceff4>.</span><span>default</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>borrow_mut</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#616e88>        // default is None</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        RefMut</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>map</span><span style=color:#eceff4>(</span><span>default</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> |</span><span>default</span><span style=color:#81a1c1>|</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            default</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>get_or_insert_with</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>||</span><span style=color:#88c0d0> get_global</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>cloned</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap_or_else</span><span style=color:#eceff4>(</span><span>Dispatch</span><span style=color:#81a1c1>::</span><span>none</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#eceff4>        })</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-core/src/dispatcher.rs#L811 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-core/src/dispatcher.rs#L811</a><p>ã‚ã‹ã‚Šã¥ã‚‰ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã“ã“ã«ãã¦ã‚ˆã†ã‚„ãæœ€åˆã«ã‚»ãƒƒãƒˆã—ãŸGlobalã®<code>Dispatch</code>ãŒå‚ç…§ã•ã‚Œã¾ã™ã€‚ä¸Šè¨˜ã®<code>default</code>å¤‰æ•°ã¯<code>None</code>ã§ã€<code>Option::get_or_insert_with()</code>ã¯Noneã®å ´åˆclosureã®æˆ»ã‚Šå€¤ã‚’è‡ªèº«ã«ã‚»ãƒƒãƒˆã—ãŸã†ã§ãã®mutå‚ç…§ã‚’è¿”ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> get_global</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>&</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>static Dispatch</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    if</span><span> GLOBAL_INIT</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>load</span><span style=color:#eceff4>(</span><span>Ordering</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>SeqCst</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> !=</span><span> INITIALIZED</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        return</span><span style=color:#8fbcbb> None</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#81a1c1>    unsafe</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>        // This is safe given the invariant that setting the global dispatcher</span></span>
<span class=giallo-l><span style=color:#616e88>        // also sets `GLOBAL_INIT` to `INITIALIZED`.</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Some</span><span style=color:#eceff4>(</span><span>GLOBAL_DISPATCH</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_ref</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>expect</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>            "</span><span style=color:#a3be8c>invariant violated: GLOBAL_DISPATCH must be initialized before GLOBAL_INIT is set</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>        ))</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-core/src/dispatcher.rs#L423 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-core/src/dispatcher.rs#L423</a><p>ã“ã‚Œã§ã‚ˆã†ã‚„ãæœ€åˆã®<code>tracing_subscriber::fmt().init()</code>ã§ã‚»ãƒƒãƒˆã—ãŸ<code>Dispatch</code>(<code>FmtSubscriber</code>)ãŒå‚ç…§ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚<p>ã‚ã‚‰ãŸã‚ã¦ã€<code>Span::new()</code>ã«æˆ»ã‚‹ã¨<code>new()</code> -> <code>new_with()</code> -> <code>make_with()</code>ã¨å‘¼ã°ã‚Œã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Span</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> make_with</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>        meta</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>static Metadata</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>        new_span</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Attributes</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>        dispatch</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Dispatch</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    )</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Span</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> attrs</span><span style=color:#81a1c1> = &</span><span>new_span</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> id</span><span style=color:#81a1c1> =</span><span> dispatch</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>new_span</span><span style=color:#eceff4>(</span><span>attrs</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> inner</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Inner</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>id</span><span style=color:#eceff4>,</span><span> dispatch</span><span style=color:#eceff4>));</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> span</span><span style=color:#81a1c1> = Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            inner</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            meta</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>meta</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>        };</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>        // ...</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>        span</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing/src/span.rs#L563 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing/src/span.rs#L563</a><p><code>Metadata</code>ã‚„<code>Attributes</code>ã¯<code>info_span!()</code>ã®æƒ…å ±ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>let</span><span> id</span><span style=color:#81a1c1> =</span><span> dispatch</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>new_span</span><span style=color:#eceff4>(</span><span>attrs</span><span style=color:#eceff4>);</span></span></code></pre><p>ã“ã“ã«ãã¦ã‚ˆã†ã‚„ã<code>tracing</code>ã¨<code>tracing_subscriber</code>ãŒã¤ãªãŒã‚Šã¾ã—ãŸã€‚<br> å¼•æ•°ã®<code>dispatch</code>ã¯globalã«ç¢ºä¿ã—ãŸ<code>Dispatch</code>ã§ã‚ã‚‹ã“ã¨ã‚’è¦‹ã¦ãã¦ãŠã‚Šã•ã‚‰ã«<code>Dispatch</code>ã¯<code>FmtSubscriber</code>ã®wrapperã§ã‚ã‚‹ã“ã¨ã‚‚ã‚ã‹ã£ã¦ã„ã¾ã™ã€‚ã¨ã„ã†ã“ã¨ã§<code>FmtSubscriber::new_span()</code>ã‚’ã¿ã¦ã„ãã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> Subscriber</span><span style=color:#eceff4>&lt;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    N</span><span style=color:#81a1c1> =</span><span> format</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>DefaultFields</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    E</span><span style=color:#81a1c1> =</span><span> format</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Format</span><span style=color:#eceff4>&lt;</span><span>format</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Full</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    F</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> LevelFilter</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    W</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> fn</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span> io</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Stdout</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span>    inner</span><span style=color:#81a1c1>:</span><span> layer</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Layered</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>F</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Formatter</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>N</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> E</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> W</span><span style=color:#eceff4>>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>N</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> E</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> F</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> W</span><span style=color:#eceff4>></span><span> tracing_core</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Subscriber</span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> Subscriber</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>N</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> E</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> F</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> W</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>    where</span><span style=color:#616e88> // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> new_span</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> attrs</span><span style=color:#81a1c1>: &</span><span>span</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Attributes</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>)</span><span style=color:#81a1c1> -></span><span> span</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Id</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>inner</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>new_span</span><span style=color:#eceff4>(</span><span>attrs</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/fmt/mod.rs#L387 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/fmt/mod.rs#L387</a><p><code>Subscriber</code>(<code>FmtSubscriber</code>)ã¯<code>Layered</code>ã®wrapperãªã®ã§åŸºæœ¬çš„ã«å‡¦ç†ã‚’ã™ã¹ã¦<code>inner</code>ã«å§”è­²ã—ã¾ã™ã€‚ã¨ã„ã†ã“ã¨ã§æ¬¡ã¯<code>Layered::new_span()</code>ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>L</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Subscriber</span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> Layered</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>L</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    L</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Layer</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    S</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Subscriber</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> new_span</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> span</span><span style=color:#81a1c1>: &</span><span>span</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Attributes</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>)</span><span style=color:#81a1c1> -></span><span> span</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Id</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> id</span><span style=color:#81a1c1> = self.</span><span>inner</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>new_span</span><span style=color:#eceff4>(</span><span>span</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>layer</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>on_new_span</span><span style=color:#eceff4>(</span><span>span</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> &</span><span>id</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> self.</span><span style=color:#88c0d0>ctx</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span>        id</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/layer/layered.rs#L125 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/layer/layered.rs#L125</a><p><code>Layered</code>ã®generics<code>S</code>ã¯è‡ªèº«ãŒwrapã—ã¦ã„ã‚‹<code>Subscriber</code>(or<code>Layer</code>)ã§ãã‚ŒãŒ<code>Subscriber</code>ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã£ã¦ã„ã¾ã™ã€‚<br> ã“ã“ã§æ³¨ç›®ã—ã¦ã„ãŸã ããŸã„ã®ãŒã€æœ€åˆã«<code>self.inner.new_span()</code>ã‚’å‘¼ã³å‡ºã—ãŸå¾Œè‡ªèº«ã®<code>self.layer.on_new_span()</code>ã‚’å‘¼ã‚“ã§ã„ã‚‹ç‚¹ã§ã™ã€‚<br> <code>FmtSubscriber</code>ã®æ§‹é€ ã®æ¦‚ç•¥ã‚’å†æ²ã™ã‚‹ã¨<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>Layered&lt;</span></span>
<span class=giallo-l><span>    LevelFilter,</span></span>
<span class=giallo-l><span>    Layered&lt;</span></span>
<span class=giallo-l><span>        fmt_layer::Layer,</span></span>
<span class=giallo-l><span>        Registry,</span></span>
<span class=giallo-l><span>    ></span></span>
<span class=giallo-l><span>></span></span></code></pre><p>ã®ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã®ã§ã€ä¸Šè¨˜ã®<code>self.inner</code>ã¯<code>Layered&lt;fmt_layer::Layer,Registry></code>ã‚’å‚ç…§ã—ã¾ã™ã€‚ãã—ã¦ã€ã“ã®nestã—ãŸ<code>Layered</code>ã®<code>new_span()</code>ã§ã‚‚<code>self.inner.new_span()</code>ãŒæœ€åˆã«ã‚ˆã°ã‚Œã‚‹ã®ã§çµå±€ã€<code>Registry::new_span()</code>ãŒå‘¼ã°ã‚Œã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Subscriber</span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> Registry</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> new_span</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> attrs</span><span style=color:#81a1c1>: &</span><span>span</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Attributes</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>)</span><span style=color:#81a1c1> -></span><span> span</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Id</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> parent</span><span style=color:#81a1c1> = if</span><span> attrs</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>is_root</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            None</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span><span style=color:#81a1c1> else if</span><span> attrs</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>is_contextual</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            self.</span><span style=color:#88c0d0>current_span</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>id</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>map</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>id</span><span style=color:#81a1c1>| self.</span><span style=color:#88c0d0>clone_span</span><span style=color:#eceff4>(</span><span>id</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            attrs</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>parent</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>map</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>id</span><span style=color:#81a1c1>| self.</span><span style=color:#88c0d0>clone_span</span><span style=color:#eceff4>(</span><span>id</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#eceff4>        };</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> id</span><span style=color:#81a1c1> = self</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span>spans</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>create_with</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>data</span><span style=color:#81a1c1>|</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                data</span><span style=color:#81a1c1>.</span><span>metadata </span><span style=color:#81a1c1>=</span><span> attrs</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>metadata</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span>                data</span><span style=color:#81a1c1>.</span><span>parent </span><span style=color:#81a1c1>=</span><span> parent</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span>                data</span><span style=color:#81a1c1>.</span><span>filter_map </span><span style=color:#81a1c1>= crate::</span><span>filter</span><span style=color:#81a1c1>::</span><span>FILTERING</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>with</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>filtering</span><span style=color:#81a1c1>|</span><span> filtering</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>filter_map</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#5e81ac>                #[cfg(debug_assertions)]</span></span>
<span class=giallo-l><span style=color:#eceff4>                {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    if</span><span> data</span><span style=color:#81a1c1>.</span><span>filter_map </span><span style=color:#81a1c1>!=</span><span> FilterMap</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>                        debug_assert!</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span style=color:#88c0d0>has_per_layer_filters</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#eceff4>                    }</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>                let</span><span> refs</span><span style=color:#81a1c1> =</span><span> data</span><span style=color:#81a1c1>.</span><span>ref_count</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>get_mut</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>                debug_assert_eq!</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>*</span><span>refs</span><span style=color:#eceff4>,</span><span style=color:#b48ead> 0</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>                *</span><span>refs</span><span style=color:#81a1c1> =</span><span style=color:#b48ead> 1</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>            })</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>expect</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Unable to allocate another span</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#88c0d0>        idx_to_id</span><span style=color:#eceff4>(</span><span>id</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã‚ˆã†ã‚„ãspanã®å®Ÿè³ªçš„ãªå‡¦ç†ã«ãŸã©ã‚Šç€ãã¾ã—ãŸã€‚<br> ã¾ãšã€<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>let</span><span> parent</span><span style=color:#81a1c1> = if</span><span> attrs</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>is_root</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    None</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span><span style=color:#81a1c1> else if</span><span> attrs</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>is_contextual</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    self.</span><span style=color:#88c0d0>current_span</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>id</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>map</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>id</span><span style=color:#81a1c1>| self.</span><span style=color:#88c0d0>clone_span</span><span style=color:#eceff4>(</span><span>id</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    attrs</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>parent</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>map</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>id</span><span style=color:#81a1c1>| self.</span><span style=color:#88c0d0>clone_span</span><span style=color:#eceff4>(</span><span>id</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#eceff4>};</span></span></code></pre><p>ã“ã®<code>parent</code>ã¯<code>None</code>ãŒå…¥ã‚Šã¾ã™ã€‚<code>info_span!()</code> macroã¯æ˜ç¤ºçš„ã«è¦ªã®spanã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã‚‚ã§ãã‚‹ã®ã§ã“ã“ã§è¦ªã®<code>span::Id</code>ã®åˆ¤å®šã‚’ã—ã¦ã„ã¾ã™ã€‚ä»Šå›ã®ä¾‹ã§ã¯ä»Šç”Ÿæˆã—ã¦ã„ã‚‹spanãŒrootãªã®ã§è¦ªã¯ã„ã¾ã›ã‚“ã€‚<br> é‡è¦ãªã®ã¯ä»¥ä¸‹ã®ç®‡æ‰€ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>let</span><span> id</span><span style=color:#81a1c1> = self</span></span>
<span class=giallo-l><span style=color:#81a1c1>    .</span><span>spans</span></span>
<span class=giallo-l><span style=color:#81a1c1>    .</span><span style=color:#88c0d0>create_with</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>data</span><span style=color:#81a1c1>: &mut</span><span style=color:#8fbcbb> DataInner</span><span style=color:#81a1c1>|</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>        data</span><span style=color:#81a1c1>.</span><span>metadata </span><span style=color:#81a1c1>=</span><span> attrs</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>metadata</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span>        data</span><span style=color:#81a1c1>.</span><span>parent </span><span style=color:#81a1c1>=</span><span> parent</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#616e88>        // ...</span></span></code></pre><p><code>Registry</code>ã®å®šç¾©ã‚’ç¢ºèªã™ã‚‹ã¨<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> sharded_slab</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span>pool</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Ref</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Clear</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Pool</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> Registry</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    spans</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Pool</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>DataInner</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>    current_spans</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> ThreadLocal</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>RefCell</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>SpanStack</span><span style=color:#eceff4>>>,</span></span>
<span class=giallo-l><span>    next_filter_id</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> u8</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã¨ãªã£ã¦ãŠã‚Šã€<code>self.span.create_with()</code>ã¯<code>shareded_slab::Pool::create_with()</code>ã‚’å‘¼ã‚“ã§ã„ã¾ã™ã€‚<br> ã“ã“ã§å‰æã§ãµã‚ŒãŸ<code>shareded_slab::Pool</code>ãŒã§ã¦ãã¾ã™ã€‚ <a href=https://docs.rs/sharded-slab/0.1.4/sharded_slab/pool/struct.Pool.html#method.create_with rel=external>doc</a>ã«ã¯<blockquote><p>Creates a new object in the pool with the provided initializer, returning a key that may be used to access the new object.</blockquote><p>ã¨ã‚ã‚‹ã®ã§ã€ã“ã®å‡¦ç†ã§<code>Registry</code>å†…ã«<code>DataInner</code>ãŒç”Ÿæˆã•ã‚Œã€ãã®<code>DataInner</code>ã‚’è­˜åˆ¥ã™ã‚‹ãŸã‚ã®idãŒè¿”ã•ã‚Œã¾ã™ã€‚<code>DataInner</code>ã®å®šç¾©ã‚’ã¿ã¦ã¿ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> DataInner</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    filter_map</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> FilterMap</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    metadata</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>static Metadata</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>    parent</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Id</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>    ref_count</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> AtomicUsize</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>crate</span><span style=color:#eceff4>)</span><span> extensions</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> RwLock</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>ExtensionsInner</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/registry/sharded.rs#L123 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/registry/sharded.rs#L123</a><p>ã“ã“ã§ã€<code>metadata</code>ã¨ã—ã¦ã€<code>info_span!()</code>ã§ç”Ÿæˆã—ãŸå‘¼ã³å‡ºã—å…ƒã®æƒ…å ±ã‚’ ä¿æŒã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚ã¾ãŸ<code>extensions</code>ã‚’é€šã˜ã¦ä»»æ„ã®å‹ã‚’ä¿æŒã§ãã‚‹æ©Ÿèƒ½ã‚‚ã‚ã‚‹ã®ã§ã™ãŒã“ã‚Œã¯<code>Span::enter()</code>ã§åˆ©ç”¨ã—ã¾ã™ã€‚<p>æœ€å¾Œã«<code>idx_to_id()</code>ã§<code>sharded_slab</code>ã®indexã‚’<code>Span::Id</code>ã«wrapã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> Id</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>NonZeroU64</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> idx_to_id</span><span style=color:#eceff4>(</span><span>idx</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> usize</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Id</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Id</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_u64</span><span style=color:#eceff4>(</span><span>idx</span><span style=color:#81a1c1> as</span><span style=color:#8fbcbb> u64</span><span style=color:#81a1c1> +</span><span style=color:#b48ead> 1</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã“ã®ç”Ÿæˆã•ã‚ŒãŸ<code>sharded_slab</code>ã®indexã‚’spanã®idã¨ã—ã¦å‘¼ã³å‡ºã—å…ƒã«è¿”ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Span</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> make_with</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>        meta</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>static Metadata</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>        new_span</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Attributes</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>        dispatch</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Dispatch</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    )</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Span</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> attrs</span><span style=color:#81a1c1> = &</span><span>new_span</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#616e88>        // ğŸ‘‡</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> id</span><span style=color:#81a1c1> =</span><span> dispatch</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>new_span</span><span style=color:#eceff4>(</span><span>attrs</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> inner</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Inner</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>id</span><span style=color:#eceff4>,</span><span> dispatch</span><span style=color:#eceff4>));</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> span</span><span style=color:#81a1c1> = Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            inner</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            meta</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>meta</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>        };</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>        // ...</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>        span</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã“ã®idã¨<code>Dispatch</code>ã¨<code>Metadata</code>ã‚’ä¿æŒã™ã‚‹<code>Span</code>ã‚’è¿”ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> Span</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    inner</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Inner</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>    meta</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>&</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>static Metadata</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Debug</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>crate</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> struct</span><span style=color:#8fbcbb> Inner</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    id</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Id</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    subscriber</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Dispatch</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing/src/span.rs#L348 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing/src/span.rs#L348</a><p>ã¨ã„ã†ã“ã¨ã§ã€<code>Spann::new()</code>ã‚’å‘¼ã³å‡ºã™ã¨globalã«ç¢ºä¿ã—ãŸ<code>FmtSubscriber</code>ã®innerã«ä¿æŒã—ã¦ã„ãŸ<code>Registry</code>å†…ã®<code>sharded_slab::Pool</code>ã«<code>Span</code>ã«é–¢ã™ã‚‹æƒ…å ±ãŒä¿æŒã•ã‚Œè­˜åˆ¥å­ã¨ã—ã¦<code>Span::Id</code>ãŒæŒ¯ã‚Šå‡ºã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚<br> ã“ã‚ŒãŒ<code>Registry</code>ã®docã«æ›¸ã„ã¦ã‚ã£ãŸ<blockquote><p>Registry is responsible for storing span metadata</blockquote><p>ã®å®Ÿä½“ã¨ã„ã†ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚<br> æ¬¡ã«<code>Span::enter()</code>ã‚’ã¿ã¦ã„ãã®ã§ã™ãŒã€ã“ã®å‡¦ç†ã‚’è¿½ã£ã¦ã„ãã¨docã®<blockquote><p>recording relationships between spans, and tracking which spans are active and which are closed.</blockquote><p>ã®å…·ä½“çš„ãªå‡¦ç†å†…å®¹ãŒã‚ã‹ã‚Šã¾ã™ã€‚<h2 id=tracing-span-enter><a aria-label="Anchor link for: tracing-span-enter" class=zola-anchor href=#tracing-span-enter><code>tracing::Span::enter()</code></a></h2><p><code>Span::enter()</code>ã®å†…å®¹ã¯ä»¥ä¸‹ã«ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Span</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> enter</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Entered</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span style=color:#88c0d0>do_enter</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Entered</span><span style=color:#eceff4> {</span><span> span</span><span style=color:#81a1c1>: self</span><span style=color:#eceff4> }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> do_enter</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>inner</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> = self.</span><span>inner</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_ref</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span>            inner</span><span style=color:#81a1c1>.</span><span>subscriber</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>enter</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>inner</span><span style=color:#81a1c1>.</span><span>id</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>        // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing/src/span.rs#L785 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing/src/span.rs#L785</a><p><code>Entered</code>ã¯guardç”¨ã®structã§<code>Drop</code>ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ã®ã§æœ€å¾Œã«è¦‹ã¾ã™ã€‚<code>Span</code>ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€<code>Span.inner.subscriber</code>ã¯<code>FmtSubscriber</code>ã‚’å‚ç…§ã—ã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Clone</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> Span</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    inner</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Inner</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>    meta</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>&</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>static Metadata</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Debug</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>crate</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> struct</span><span style=color:#8fbcbb> Inner</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    id</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Id</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    subscriber</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Dispatch</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ãã—ã¦ã€<code>FmtSubscriber</code>ã¯å‡¦ç†ã‚’<code>Layered</code>ã«å§”è­²ã—ã¦ãŠã‚Šã€<code>Layered</code>ã¯<code>Span::new()</code>ã§ã¿ãŸã¨ãŠã‚Šã€<code>inner</code>ã‚’ã¾ãšå‘¼ã³å‡ºã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>L</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Subscriber</span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> Layered</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>L</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>    where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        L</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Layer</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        S</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Subscriber</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> enter</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> span</span><span style=color:#81a1c1>: &</span><span>span</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Id</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>inner</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>enter</span><span style=color:#eceff4>(</span><span>span</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>layer</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>on_enter</span><span style=color:#eceff4>(</span><span>span</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> self.</span><span style=color:#88c0d0>ctx</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã¨ã„ã†ã“ã¨ã§ã€<code>Span::new()</code>åŒæ§˜ã€<code>Span::enter()</code>ã‚‚æœ€åˆã«<code>Registry</code>ã«ã‚ˆã£ã¦å‡¦ç†ã•ã‚Œã¾ã™ã€‚<br> <code>Registry</code>ãŒ<code>Span::enter()</code>ã§æ¸¡ã•ã‚ŒãŸ<code>Span::Id</code>ã‚’ã©ã®ã‚ˆã†ã«æ‰±ã†ã‹ã¿ã¦ã„ãã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> Registry</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    spans</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Pool</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>DataInner</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>    current_spans</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> ThreadLocal</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>RefCell</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>SpanStack</span><span style=color:#eceff4>>>,</span></span>
<span class=giallo-l><span>    next_filter_id</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> u8</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Subscriber</span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> Registry</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> enter</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> id</span><span style=color:#81a1c1>: &</span><span>span</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Id</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if self</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span>current_spans</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>get_or_default</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>borrow_mut</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>push</span><span style=color:#eceff4>(</span><span>id</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>())</span></span>
<span class=giallo-l><span style=color:#eceff4>        {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            self.</span><span style=color:#88c0d0>clone_span</span><span style=color:#eceff4>(</span><span>id</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/registry/sharded.rs#L289 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/registry/sharded.rs#L289</a><p><code>self.current_spans</code>ã¯<code>ThreadLocal</code>ã‚’å‚ç…§ã—ã¦ãŠã‚Šã€ä»¥ä¸‹ã®ã‚ˆã†ã«<code>ThreadLocal</code>ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«<code>ThreadLocal&lt;T></code>ã®<code>T</code>ãŒ<code>Default</code>ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹å ´åˆã€<code>ThreadLocal::get_or_default()</code>ã¯<code>T::default()</code>ã‚’è¿”ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Send</span><span style=color:#81a1c1> +</span><span style=color:#8fbcbb> Default</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> ThreadLocal</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> get_or_default</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> &</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span style=color:#88c0d0>get_or</span><span style=color:#eceff4>(</span><span>Default</span><span style=color:#81a1c1>::</span><span>default</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://docs.rs/thread_local/latest/thread_local/struct.ThreadLocal.html#method.get_or_default rel=external>https://docs.rs/thread_local/latest/thread_local/struct.ThreadLocal.html#method.get_or_default</a><p>åŒæ§˜ã«<code>RefCell&lt;T></code>ã‚‚<code>T</code>ãŒ<code>Default</code>ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹å ´åˆã€<code>T::default()</code>ã‚’è¿”ã™ã®ã§æœ€çµ‚çš„ã«ã¯<code>SpanStack::default()</code>ãŒå‘¼ã°ã‚Œã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>pub</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>crate</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> use</span><span> tracing_core</span><span style=color:#81a1c1>::</span><span>span</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Id</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Debug</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> ContextId</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    id</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Id</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    duplicate</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> bool</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Debug</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Default</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>crate</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> struct</span><span style=color:#8fbcbb> SpanStack</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    stack</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Vec</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>ContextId</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/registry/stack.rs#L14 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/registry/stack.rs#L14</a><p><code>SpanStack</code>ã¯<code>Vec&lt;ContextId></code>ã®wrapperã§ã€<code>ContextId</code>ã¯<code>span::Id</code>ã®wrapperãªã®ã§ã€å®Ÿä½“ã¨ã—ã¦ã¯<code>Vec&lt;span::Id></code>ã¨ã„ãˆã¾ã™ã€‚<br> ä»¥ä¸Šã‚’è¸ã¾ãˆã¦ã‚‚ã†ä¸€åº¦<code>Registry::enter()</code>ã‚’ã¿ã¦ã¿ã‚‹ã¨<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> enter</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> id</span><span style=color:#81a1c1>: &</span><span>span</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Id</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if self</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span>current_spans    </span><span style=color:#616e88>// ThreadLocal&lt;RefCell&lt;SpanStack>></span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>get_or_default</span><span style=color:#eceff4>()</span><span style=color:#616e88> // RefCell&lt;SpanStack></span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>borrow_mut</span><span style=color:#eceff4>()</span><span style=color:#616e88>     // RefMut&lt;SpanStack></span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>push</span><span style=color:#eceff4>(</span><span>id</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>())</span><span style=color:#616e88> // SpanStack::push()</span></span>
<span class=giallo-l><span style=color:#eceff4>        {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            self.</span><span style=color:#88c0d0>clone_span</span><span style=color:#eceff4>(</span><span>id</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span></code></pre><p>ã®ã‚ˆã†ã«ãªã£ã¦ãŠã‚Šã€<code>SpanStack</code>ã‚’constructã—ãŸã®ã¡ã€<code>span::Id</code>ã‚’<code>Vec</code>ã«pushã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> SpanStack</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#5e81ac>    #[inline]</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>super</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> fn</span><span style=color:#88c0d0> push</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> id</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Id</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> bool</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> duplicate</span><span style=color:#81a1c1> = self.</span><span>stack</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>iter</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>any</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>i</span><span style=color:#81a1c1>|</span><span> i</span><span style=color:#81a1c1>.</span><span>id </span><span style=color:#81a1c1>==</span><span> id</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>stack</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>push</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>ContextId</span><span style=color:#eceff4> {</span><span> id</span><span style=color:#eceff4>,</span><span> duplicate</span><span style=color:#eceff4> });</span></span>
<span class=giallo-l><span style=color:#81a1c1>        !</span><span>duplicate</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/registry/stack.rs#L20 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/registry/stack.rs#L20</a><p><code>SpanStack::push()</code>ã¯ç¾åœ¨ã®stackä¸Šã«é‡è¤‡ãŒã‚ã‚‹ã‹ã‚’åˆ¤å®šã—ãŸã®ã¡pushã—ã¾ã™ã€‚<br> ã“ã“ã§ãªãœé‡è¤‡ã‚’è€ƒæ…®ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã ã‚ã†ã¨ã„ã†ç–‘å•ãŒç”Ÿã˜ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>let</span><span> _guard_a</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0;font-weight:700> info_span!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>outer</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>entered</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> _guard_b</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0;font-weight:700> info_span!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>inner</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>entered</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã®ã‚ˆã†ã«<code>Span</code>ã¯macroã®å‘¼ã³å‡ºã—ã”ã¨ã«ç”Ÿæˆã•ã‚Œã‚‹ã®ã§ã€ä¸Šè¨˜ã®outer spanãŒdropã•ã‚Œã‚‹ã¾ã§ã¯outer spanã«å†ã³enterã™ã‚‹ã“ã¨ã¯ãªã„ã‚ˆã†ã«æ€ã‚ã‚Œã‚‹ã‹ã‚‰ã§ã™ã€‚<br> ã“ã“ãŒ<code>tracing</code>ã®æ³¨æ„ç‚¹ã§ã‚‚ã‚ã‚‹ã®ã§ã™ãŒã€<code>tracing</code>ã¯async/awaitã®ã‚³ãƒ¼ãƒ‰ã§ã¯ãã®ã¾ã¾ä½¿ãˆã¾ã›ã‚“ã€‚(æœ¬è¨˜äº‹ã®ä¾‹ã®ã‚ˆã†ã«ã¯)ã€‚async/awaitç”¨ã«<code>tracing_future</code> crateãŒç”¨æ„ã•ã‚Œãã¡ã‚‰ã‚’åˆã‚ã›ã¦ä½¿ã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚æœ¬è¨˜äº‹ã§ã¯<code>tracing_future</code>ã«ã¯ãµã‚Œã¾ã›ã‚“ã€‚(æ¬¡å›è¨€åŠã™ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“)<blockquote><p>Warning: in asynchronous code that uses async/await syntax, Span::enter should be used very carefully or avoided entirely. Holding the drop guard returned by Span::enter across .await points will result in incorrect traces</blockquote><p><a href=https://docs.rs/tracing/0.1.35/tracing/struct.Span.html#in-asynchronous-code rel=external>doc</a>ã«ã‚‚ä¸Šè¨˜ã®ã‚ˆã†ã«warningãŒæ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚<p>tracingã®ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚“ã§ã¿ã‚ˆã†ã¨ãŠã‚‚ã£ãŸãã£ã‹ã‘ã®ã²ã¨ã¤ã«ã©ã†ã—ã¦async/awaitã§ä½¿ã†ã¨ã†ã¾ãå‹•ä½œã—ãªã„ã®ã‹çŸ¥ã‚ŠãŸã„ã¨ã„ã†ã®ãŒä¸€ã¤ã‚ã‚Šã¾ã—ãŸã€‚ã“ã‚Œã¯ã‚ãã¾ã§æ¨æ¸¬ãªã®ã§ã™ãŒã€async fnã®ä¸­ã§<code>info_span!()</code>ã‚’æ›¸ãã¨æœ€çµ‚çš„ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã«ãªã‚‹ã‹ã‚‰ã§ã¯ã¨è€ƒãˆã¦ãŠã‚Šã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Future</span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> MyFuture</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Output</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> ();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> poll</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self:</span><span style=color:#8fbcbb> Pin</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>&mut Self</span><span style=color:#eceff4>>,</span><span> _cx</span><span style=color:#81a1c1>: &mut</span><span style=color:#8fbcbb> Context</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Poll</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>Self::</span><span style=color:#8fbcbb>Output</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        match self.</span><span style=color:#88c0d0>project</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span>state </span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#616e88>            // Running at thread A</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            MyFutureState</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>A</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>..</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span>span </span><span style=color:#81a1c1>=</span><span style=color:#88c0d0;font-weight:700> info_span!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>my_span</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span>guard </span><span style=color:#81a1c1>=</span><span> span</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>enter</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span>state </span><span style=color:#81a1c1>=</span><span style=color:#8fbcbb> MyFutureState</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>B</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#616e88>                // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#616e88>            // Running at thread B</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            MyFutureState</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>B</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>..</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span><span style=color:#616e88> /* ... */</span><span style=color:#eceff4> }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã®ã‚ˆã†ãª<code>Future::poll</code>ã«ãªã‚Šã€<code>Span::enter()</code>ãŒthread Aã§å®Ÿè¡Œã•ã‚Œã€guardã®dropãŒthread Bã§å®Ÿè¡Œã•ã‚Œã‚‹çµæœã€thread Aã®SpanStackä¸Šã®idãŒpopã•ã‚Œãšstackä¸Šã«ç•™ã¾ã‚Šç¶šã‘ã‚‹ã“ã¨ã«ãªã£ã¦ã—ã¾ã†ã€‚<p>è©±ã‚’<code>Registry::enter()</code>ã«æˆ»ã—ã¾ã™ã€‚ã“ã“ã§æ³¨æ„ã—ãŸã„ã®ãŒ<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> Registry</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    spans</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Pool</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>DataInner</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>    current_spans</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> ThreadLocal</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>RefCell</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>SpanStack</span><span style=color:#eceff4>>>,</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>spans</code>ã¯threadé–“ã§å…±æœ‰ã•ã‚Œã‚‹ã®ã«å¯¾ã—ã¦ã€<code>current_spans</code>ã¯<code>ThreadLocal</code>å‹ãªã®ã§threadã”ã¨ã«<code>SpanStack</code>ãŒç”Ÿæˆã•ã‚Œã‚‹ç‚¹ã§ã™ã€‚<p>ã“ã‚Œã§<code>Span::enter()</code>ã®ä¸­ã§ã€<code>Registry</code>ã®stackã«enterã—ãŸspanã®idã‚’ä¿æŒã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦<blockquote><p>tracking which spans are active</blockquote><p>ã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Span</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> enter</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Entered</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span style=color:#88c0d0>do_enter</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Entered</span><span style=color:#eceff4> {</span><span> span</span><span style=color:#81a1c1>: self</span><span style=color:#eceff4> }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>Span::enter()</code>ã¯æˆ»ã‚Šå€¤ã¨ã—ã¦<code>Entered</code>ã‚’è¿”ã—ã¾ã™ã€‚<code>Entered</code>ã¯dropæ™‚ã«spanã‚’é–‰ã˜ã‚‹è²¬å‹™ã‚’ã‚‚ã¤guardã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Drop</span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> Entered</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#5e81ac>    #[inline(always)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> drop</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>span</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>do_exit</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>Dropæ™‚ã«<code>Span::do_exit()</code>ã‚’å‘¼ã‚“ã§ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Span</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> do_exit</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>inner</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> = self.</span><span>inner</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_ref</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span>            inner</span><span style=color:#81a1c1>.</span><span>subscriber</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>exit</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>inner</span><span style=color:#81a1c1>.</span><span>id</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#616e88>        // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>Span::do_exit()</code>ã‚‚<code>enter()</code>åŒæ§˜subscriberã®exitã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚<code>exit()</code>ã®å®Ÿè£…ã‚‚èˆˆå‘³æ·±ã„ç‚¹(<code>Drop</code>æ™‚ç‰¹æœ‰ã®è€ƒæ…®äº‹é …)ãŒå¤šã„ã®ã§ã™ãŒeventã®loggingã®è¦³ç‚¹ã‹ã‚‰ã¯ãšã‚Œã¦ã—ã¾ã†ã®ã§è©³ç´°ã¯å‰²æ„›ã—ã¾ã™ã€‚åŸºæœ¬çš„ã«ã¯<code>SpanStack</code>ã‹ã‚‰å½“è©²idã‚’removeã—ã¾ã™ã€‚<p>ã“ã“ã¾ã§ã§ã‚ˆã†ã‚„ãspanã®ç”Ÿæˆã¨activate(enter)ã®å‡¦ç†å†…å®¹ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚<br> å‰æº–å‚™ãŒçµ‚ã‚ã£ãŸã®ã§ã¤ã„ã«<code>info!()</code>å‡¦ç†ã«å…¥ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚<h2 id=tracing-event-dispatch><a aria-label="Anchor link for: tracing-event-dispatch" class=zola-anchor href=#tracing-event-dispatch><code>tracing::Event::dispatch</code></a></h2><p>Macroã®expandã§ç¢ºèªã—ãŸã‚ˆã†ã«<code>info!()</code>ã¯æœ€çµ‚çš„ã«<code>Event::dispatch()</code>ã«å±•é–‹ã•ã‚Œã¾ã™ã€‚<br> <code>Metadada</code>ã¨<code>field::ValueSet</code>ã¯å‘¼ã³å‡ºã—æ™‚ã®æƒ…å ±ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Event</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#616e88>    /// Constructs a new `Event` with the specified metadata and set of values,</span></span>
<span class=giallo-l><span style=color:#616e88>    /// and observes it with the current subscriber.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> dispatch</span><span style=color:#eceff4>(</span><span>metadata</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>static Metadata</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>>,</span><span> fields</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>a</span><span> field</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>ValueSet</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> event</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Event</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>metadata</span><span style=color:#eceff4>,</span><span> fields</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>        crate::</span><span>dispatcher</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>get_default</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>current</span><span style=color:#81a1c1>|</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            current</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>event</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>event</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>        });</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>Event</code>ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚<code>field</code>ã¨<code>metadata</code>ã¯macroå‘¼ã³å‡ºã—æ™‚ã®æƒ…å ±ã§ã™ã€‚<code>parent</code>ã¯<code>Event</code>ãŒå«ã¾ã‚Œã¦ã„ã‚‹spanã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Debug</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> Event</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span>    fields</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>a</span><span> field</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>ValueSet</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>    metadata</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>static Metadata</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>    parent</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Parent</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Event</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> new</span><span style=color:#eceff4>(</span><span>metadata</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>static Metadata</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>>,</span><span> fields</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>a</span><span> field</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>ValueSet</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>>)</span><span style=color:#81a1c1> -> Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Event</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            fields</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            metadata</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            parent</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Parent</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Current</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-core/src/event.rs#L23 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-core/src/event.rs#L23</a><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>pub</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>crate</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> enum</span><span style=color:#8fbcbb> Parent</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Root</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Current</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#88c0d0>    Explicit</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Id</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>Parent</code>ã¯ä¸Šè¨˜ã®ã‚ˆã†ã«<code>Explicit</code>ã§æ˜ç¤ºçš„ã«æŒ‡å®šã™ã‚‹ã‹ã€<code>Current</code>ã§contextã‹ã‚‰åˆ¤æ–­ã™ã‚‹ã‹ã®æƒ…å ±ã§ã™ã€‚<code>info!()</code>ã¯å†…éƒ¨çš„ã«<code>event!()</code> macroå‘¼ã³å‡ºã—ã«å±•é–‹ã•ã‚Œã‚‹ã®ã§ã™ãŒ<code>event!()</code>ã§ã¯ç´ã¥ãspanã‚’ä¸‹è¨˜ã®ã‚ˆã†ã«æŒ‡å®šã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>let</span><span> span</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0;font-weight:700> span!</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Level</span><span style=color:#81a1c1>::</span><span>TRACE</span><span style=color:#eceff4>, "</span><span style=color:#a3be8c>my span</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>event!</span><span style=color:#eceff4>(</span><span>parent</span><span style=color:#81a1c1>: &</span><span>span</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Level</span><span style=color:#81a1c1>::</span><span>INFO</span><span style=color:#eceff4>, "</span><span style=color:#a3be8c>something has happened!</span><span style=color:#eceff4>");</span></span></code></pre><p><code>Event::dispatch()</code>ã¯<code>Dispatch::event()</code>ã‚’å‘¼ã³å‡ºã—ã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Dispatch</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> event</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> event</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Event</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if self.</span><span>subscriber</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>event_enabled</span><span style=color:#eceff4>(</span><span>event</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            self.</span><span>subscriber</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>event</span><span style=color:#eceff4>(</span><span>event</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span><span> </span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-core/src/dispatcher.rs#L584 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-core/src/dispatcher.rs#L584</a><p><code>Subscriber::event_enabled()</code>ã®enableåˆ¤å®šã¯ä¸€é€šã‚Šã®æµã‚Œã‚’ç¢ºèªã—ãŸã‚ã¨ã€<code>CALLSITE</code>ã®registerå‡¦ç†ã§ã¿ã‚‹ã®ã§ã“ã“ã§ã¯å‰²æ„›ã—ã¾ã™ã€‚<br> <code>Dispatch::event()</code> -> <code>FmtSubscriber::event()</code> -> <code>Layered::event()</code>ã®å§”è­²ã®æµã‚Œã¯spanã¨åŒæ§˜ã§ã™ã€‚ã¾ãŸ<code>Layered</code>ã®å‡¦ç†ã‚‚ã¾ãšinnerã«å…ˆã«å§”è­²ã™ã‚‹ã®ã‚‚åŒã˜ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>L</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Subscriber</span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> Layered</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>L</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    L</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Layer</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    S</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Subscriber</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> event</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> event</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Event</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>inner</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>event</span><span style=color:#eceff4>(</span><span>event</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>layer</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>on_event</span><span style=color:#eceff4>(</span><span>event</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> self.</span><span style=color:#88c0d0>ctx</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã¨ã„ã†ã“ã¨ã§ã€æœ€åˆã«<code>Registry</code>ã¯ãªã«ã‹ã—ã¦ã„ã‚‹ã§ã—ã‚‡ã†ã‹ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Subscriber</span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> Registry</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>    /// This is intentionally not implemented, as recording events</span></span>
<span class=giallo-l><span style=color:#616e88>    /// is the responsibility of layers atop of this registry.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> event</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> _</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Event</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>) {}</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã‚³ãƒ¡ãƒ³ãƒˆã«ã‚‚ã‚ã‚‹é€šã‚Šã€<code>Registry::event()</code>ã§ã¯ãªã«ã‚‚ã—ã¦ã„ã¾ã›ã‚“ã€‚eventã®handlingã¯layerã®è²¬å‹™ã§ã‚ã‚‹ã¨ã—ã¦ã„ã¾ã™ã€‚ã¨ã„ã†ã“ã¨ã§ã€æ¬¡ã¯<code>fmt_layer::Layer</code>ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> N</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> E</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> W</span><span style=color:#eceff4>></span><span> layer</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Layer</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>></span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> Layer</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> N</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> E</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> W</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>    where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        S</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Subscriber</span><span style=color:#81a1c1> + for</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> LookupSpan</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        N</span><span style=color:#81a1c1>: for</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>writer</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> FormatFields</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>writer</span><span style=color:#eceff4>></span><span style=color:#81a1c1> +</span><span style=color:#eceff4> '</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        E</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> FormatEvent</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> N</span><span style=color:#eceff4>></span><span style=color:#81a1c1> +</span><span style=color:#eceff4> '</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        W</span><span style=color:#81a1c1>: for</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>writer</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> MakeWriter</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>writer</span><span style=color:#eceff4>></span><span style=color:#81a1c1> +</span><span style=color:#eceff4> '</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> on_event</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> event</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Event</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>,</span><span> ctx</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Context</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>>) {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>        thread_local!</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                static</span><span> BUF</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> RefCell</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>></span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> RefCell</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>String</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>        BUF</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>with</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>buf</span><span style=color:#81a1c1>|</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let</span><span> borrow</span><span style=color:#81a1c1> =</span><span> buf</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>try_borrow_mut</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let mut</span><span> a</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let mut</span><span> b</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let mut</span><span> buf</span><span style=color:#81a1c1> = match</span><span> borrow</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Ok</span><span style=color:#eceff4>(</span><span>buf</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                    a</span><span style=color:#81a1c1> =</span><span> buf</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    &mut *</span><span>a</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span>                _</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                    b</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> String</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    &mut</span><span> b</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#eceff4>            };</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>            let</span><span> ctx</span><span style=color:#81a1c1> = self.</span><span style=color:#88c0d0>make_ctx</span><span style=color:#eceff4>(</span><span>ctx</span><span style=color:#eceff4>,</span><span> event</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>            if self</span></span>
<span class=giallo-l><span style=color:#81a1c1>                .</span><span>fmt_event</span></span>
<span class=giallo-l><span style=color:#81a1c1>                .</span><span style=color:#88c0d0>format_event</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    &</span><span>ctx</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>                    format</span><span style=color:#81a1c1>::</span><span>Writer</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut</span><span> buf</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>with_ansi</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span>is_ansi</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span>                    event</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>                )</span></span>
<span class=giallo-l><span style=color:#81a1c1>                .</span><span style=color:#88c0d0>is_ok</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>            {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                let mut</span><span> writer</span><span style=color:#81a1c1> = self.</span><span>make_writer</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>make_writer_for</span><span style=color:#eceff4>(</span><span>event</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>metadata</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#81a1c1>                let</span><span> res</span><span style=color:#81a1c1> =</span><span> io</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Write</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>write_all</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut</span><span> writer</span><span style=color:#eceff4>,</span><span> buf</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_bytes</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#81a1c1>                if self.</span><span>log_internal_errors </span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    if let</span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span>e</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> res</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>                        eprintln!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>[tracing-subscriber] Unable to write an event to the Writer for this Subscriber! Error: </span><span style=color:#ebcb8b>{}\n</span><span style=color:#eceff4>",</span><span> e</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>                    }</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span><span style=color:#81a1c1> else if self.</span><span>log_internal_errors </span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>                let</span><span> err_msg</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0;font-weight:700> format!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Unable to format the following event. Name: </span><span style=color:#ebcb8b>{}</span><span style=color:#a3be8c>; Fields: </span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>:?</span><span style=color:#ebcb8b>}\n</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span>                                      event</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>metadata</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>name</span><span style=color:#eceff4>(),</span><span> event</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>fields</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#81a1c1>                let mut</span><span> writer</span><span style=color:#81a1c1> = self.</span><span>make_writer</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>make_writer_for</span><span style=color:#eceff4>(</span><span>event</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>metadata</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#81a1c1>                let</span><span> res</span><span style=color:#81a1c1> =</span><span> io</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Write</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>write_all</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut</span><span> writer</span><span style=color:#eceff4>,</span><span> err_msg</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_bytes</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#81a1c1>                if let</span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span>e</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> res</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>                    eprintln!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>[tracing-subscriber] Unable to write an </span><span style=color:#ebcb8b>\"</span><span style=color:#a3be8c>event formatting error</span><span style=color:#ebcb8b>\"</span><span style=color:#a3be8c> to the Writer for this Subscriber! Error: </span><span style=color:#ebcb8b>{}\n</span><span style=color:#eceff4>",</span><span> e</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>            buf</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clear</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#eceff4>        });</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/fmt/fmt_layer.rs#L904 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/fmt/fmt_layer.rs#L904</a><p>ãŒã£ã¤ã‚Šå‡¦ç†ãŒæ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚ã¾ãŸ<code>io::Write::write_all()</code>ãŒã‚ã‚‹ã®ã§ã©ã†ã‚„ã‚‰ã“ã“ã§eventã®æ›¸ãè¾¼ã¿å‡¦ç†ã¾ã§å®Ÿæ–½ã—ã¦ã„ãã†ã§ã™ã€‚ã“ã“ãŒeventã®loggingå‡¦ç†ã¨æ€ã‚ã‚Œã‚‹ã§è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> on_event</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> event</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Event</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>,</span><span> ctx</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Context</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>>) { }</span></span></code></pre><p>ã¾ãš<code>on_event()</code>ã®å¼•æ•°ã§ã™ãŒã€<code>Event</code>ã¯<code>info!()</code>ã§ç”Ÿæˆã—ãŸ<code>Event</code>ãªã®ã¯è‰¯ã„ã¨ã—ã¦ã€<code>Context</code>ã¯ã©ã“ã‹ã‚‰æ¥ãŸã®ã§ã—ã‚‡ã†ã‹ã€‚<br> <code>Layered</code>ã®<code>event()</code>ã‚’ã‚‚ã†ä¸€åº¦ã¿ã¦ã¿ã‚‹ã¨<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> event</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> event</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Event</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>inner</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>event</span><span style=color:#eceff4>(</span><span>event</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>layer</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>on_event</span><span style=color:#eceff4>(</span><span>event</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> self.</span><span style=color:#88c0d0>ctx</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span></code></pre><p><code>fmt_layer::Layer::on_event()</code>ã«<code>self.ctx()</code>ã§<code>Context</code>ã‚’ç”Ÿæˆã—ã¦æ¸¡ã—ã¦ã„ã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>L</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Layered</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>L</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    S</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Subscriber</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> ctx</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Context</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Context</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self.</span><span>inner</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> Context</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span>    subscriber</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>&</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>a S</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#5e81ac>    #[cfg(all(feature = "</span><span style=color:#a3be8c>registry</span><span style=color:#5e81ac>", feature = "</span><span style=color:#a3be8c>std</span><span style=color:#5e81ac>"))]</span></span>
<span class=giallo-l><span>    filter</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> FilterId</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>// === impl Context ===</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Context</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>    where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        S</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Subscriber</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>super</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> fn</span><span style=color:#88c0d0> new</span><span style=color:#eceff4>(</span><span>subscriber</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>a S</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            subscriber</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>subscriber</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>            #[cfg(feature = "</span><span style=color:#a3be8c>registry</span><span style=color:#5e81ac>")]</span></span>
<span class=giallo-l><span>            filter</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> FilterId</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>none</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã¨ã„ã†ã“ã¨ã§ã€<code>Context</code>ã¯<code>Subscriber</code>ã®wrapperã§ã€ã“ã“ã§ã¯<code>Registry</code>ã‚’æ¸¡ã—ã¦ã„ã‚‹ã¨è€ƒãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> on_event</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> event</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Event</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>,</span><span> ctx</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Context</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>>) {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>        thread_local!</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                static</span><span> BUF</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> RefCell</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>></span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> RefCell</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>String</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>        BUF</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>with</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>buf</span><span style=color:#81a1c1>|</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let</span><span> borrow</span><span style=color:#81a1c1> =</span><span> buf</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>try_borrow_mut</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let mut</span><span> a</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let mut</span><span> b</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let mut</span><span> buf</span><span style=color:#81a1c1> = match</span><span> borrow</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Ok</span><span style=color:#eceff4>(</span><span>buf</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                    a</span><span style=color:#81a1c1> =</span><span> buf</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    &mut *</span><span>a</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span>                _</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                    b</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> String</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    &mut</span><span> b</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#eceff4>            };</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>            // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã“ã“ã¯å®Ÿè³ªçš„ã«formatã—ãŸeventã®æ›¸ãè¾¼ã¿bufferã®ç”Ÿæˆå‡¦ç†ã§ã™ã€‚thread localã¨<code>RefCell</code>ã®åˆã‚ã›æŠ€ã§<code>String</code>ã‚’ã“ã®æ§˜ã«å†åˆ©ç”¨ã™ã‚‹æ–¹æ³•ãŒå‚è€ƒã«ãªã‚Šã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>let</span><span> ctx</span><span style=color:#81a1c1> = self.</span><span style=color:#88c0d0>make_ctx</span><span style=color:#eceff4>(</span><span>ctx</span><span style=color:#eceff4>,</span><span> event</span><span style=color:#eceff4>);</span></span></code></pre><p><code>Context</code>ã¨<code>Event</code>ã‚’ä¿æŒã™ã‚‹<code>FmtContext</code>ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> FmtContext</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> N</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>crate</span><span style=color:#eceff4>)</span><span> ctx</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Context</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>crate</span><span style=color:#eceff4>)</span><span> fmt_fields</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>a N</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>crate</span><span style=color:#eceff4>)</span><span> event</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>a Event</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> N</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> E</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> W</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Layer</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> N</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> E</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> W</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    S</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Subscriber</span><span style=color:#81a1c1> + for</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> LookupSpan</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    N</span><span style=color:#81a1c1>: for</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>writer</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> FormatFields</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>writer</span><span style=color:#eceff4>></span><span style=color:#81a1c1> +</span><span style=color:#eceff4> '</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    E</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> FormatEvent</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> N</span><span style=color:#eceff4>></span><span style=color:#81a1c1> +</span><span style=color:#eceff4> '</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    W</span><span style=color:#81a1c1>: for</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>writer</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> MakeWriter</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>writer</span><span style=color:#eceff4>></span><span style=color:#81a1c1> +</span><span style=color:#eceff4> '</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#5e81ac>    #[inline]</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> make_ctx</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>>(</span><span style=color:#81a1c1>&</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>a</span><span style=color:#81a1c1> self</span><span style=color:#eceff4>,</span><span> ctx</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Context</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>>,</span><span> event</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>a Event</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> FmtContext</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> N</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        FmtContext</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            ctx</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            fmt_fields</span><span style=color:#81a1c1>: &self.</span><span>fmt_fields</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            event</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/fmt/fmt_layer.rs#L971 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/fmt/fmt_layer.rs#L971</a><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>if self</span></span>
<span class=giallo-l><span style=color:#81a1c1>    .</span><span>fmt_event</span></span>
<span class=giallo-l><span style=color:#81a1c1>    .</span><span style=color:#88c0d0>format_event</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#81a1c1>        &</span><span>ctx</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        format</span><span style=color:#81a1c1>::</span><span>Writer</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut</span><span> buf</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>with_ansi</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span>is_ansi</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span>        event</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    )</span></span>
<span class=giallo-l><span style=color:#81a1c1>    .</span><span style=color:#88c0d0>is_ok</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> writer</span><span style=color:#81a1c1> = self.</span><span>make_writer</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>make_writer_for</span><span style=color:#eceff4>(</span><span>event</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>metadata</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> res</span><span style=color:#81a1c1> =</span><span> io</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Write</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>write_all</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut</span><span> writer</span><span style=color:#eceff4>,</span><span> buf</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_bytes</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#81a1c1>    if self.</span><span>log_internal_errors </span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if let</span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span>e</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> res</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>            eprintln!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>[tracing-subscriber] Unable to write an event to the Writer for this Subscriber! Error: </span><span style=color:#ebcb8b>{}\n</span><span style=color:#eceff4>",</span><span> e</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span><span style=color:#81a1c1> else if self.</span><span>log_internal_errors </span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> err_msg</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0;font-weight:700> format!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Unable to format the following event. Name: </span><span style=color:#ebcb8b>{}</span><span style=color:#a3be8c>; Fields: </span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>:?</span><span style=color:#ebcb8b>}\n</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span>                          event</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>metadata</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>name</span><span style=color:#eceff4>(),</span><span> event</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>fields</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> writer</span><span style=color:#81a1c1> = self.</span><span>make_writer</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>make_writer_for</span><span style=color:#eceff4>(</span><span>event</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>metadata</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> res</span><span style=color:#81a1c1> =</span><span> io</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Write</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>write_all</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut</span><span> writer</span><span style=color:#eceff4>,</span><span> err_msg</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_bytes</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#81a1c1>    if let</span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span>e</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> res</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>        eprintln!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>[tracing-subscriber] Unable to write an </span><span style=color:#ebcb8b>\"</span><span style=color:#a3be8c>event formatting error</span><span style=color:#ebcb8b>\"</span><span style=color:#a3be8c> to the Writer for this Subscriber! Error: </span><span style=color:#ebcb8b>{}\n</span><span style=color:#eceff4>",</span><span> e</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>buf</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clear</span><span style=color:#eceff4>();</span></span></code></pre><p><code>self.fmt_event.format_event()</code>ã§ãŠãã‚‰ãã€ç¢ºä¿ã—ãŸ<code>String</code>ã«eventã®æƒ…å ±ã‚’æ›¸ãè¾¼ã‚“ã§ãŠã‚Šã€æˆåŠŸã—ãŸå ´åˆã¯<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>let mut</span><span> writer</span><span style=color:#81a1c1> = self.</span><span>make_writer</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>make_writer_for</span><span style=color:#eceff4>(</span><span>event</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>metadata</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#81a1c1>let</span><span> res</span><span style=color:#81a1c1> =</span><span> io</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Write</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>write_all</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut</span><span> writer</span><span style=color:#eceff4>,</span><span> buf</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_bytes</span><span style=color:#eceff4>());</span></span></code></pre><p><code>self.make_writer</code>ã§æ›¸ãè¾¼ã¿å…ˆã®writerã‚’ç”Ÿæˆã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> Subscriber</span><span style=color:#eceff4>&lt;</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    W</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> fn</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span> io</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Stdout</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>> {</span><span style=color:#616e88>/* ... */</span><span style=color:#eceff4> }</span></span></code></pre><p>ã¨ã—ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§<code>io::Stdout</code>ã‚’è¿”ã™é–¢æ•°ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹ã®ã§ã“ã“ã§ã¯<code>writer</code>ã¯<code>Stdout</code>ã«ãªã‚Šã¾ã™ã€‚æ®‹ã‚Šã®å‡¦ç†ã¯eventã®formatæ™‚ã®ã‚¨ãƒ©ãƒ¼ã‚„bufferæ›¸ãè¾¼ã¿æ™‚ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãªã®ã§çœç•¥ã—ã¾ã™ã€‚<br> async fnã®ä¸­ã§<code>info!()</code>ã‚’å‘¼ã¶ã¨ä¸Šè¨˜ã§ã¿ãŸã‚ˆã†ã«<code>io::Stdout</code>ã«æ›¸ãã“ã¿å‡¦ç†ãŒèµ°ã£ã¦ãŠã‚Šã“ã‚Œã¯blockingãªå‡¦ç†ã¨æ€ã‚ã‚Œã‚‹ã®ã§ã€async fnã®ä¸­ã§ã¯blockingãªå‡¦ç†ã‚’å‘¼ã°ãªã„ã¨ã„ã†åŸå‰‡ã«åã—ãªã„ã®ã‹ãªã¨ã„ã†ç–‘å•ãŒç”Ÿã˜ã¾ã—ãŸã€‚ã‚½ãƒ¼ã‚¹ã‚’èª­ã‚“ã é™ã‚Šã§ã™ã¨ã€<code>Event::dispatch()</code>ã¨ã„ã£ã¦ã‚‚åˆ¥threadã«é€ƒã™ã‚ˆã†ãªå‡¦ç†ã¯è¦‹å—ã‘ã‚‰ã‚Œãªã‹ã£ãŸã®ã§æ°—ã«ãªã‚Šã¾ã—ãŸã€‚<p>ã“ã®ç‚¹ã¯ã¨ã‚‚ã‹ãã¨ã—ã¦ã€ã¤ã„ã«eventã®æ›¸ãè¾¼ã¿å‡¦ç†ã‚’ã¿ã¤ã‘ãŸã®ã§æ®‹ã‚Šã¯ä»¥ä¸‹ã®eventã®formatå‡¦ç†ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>self</span></span>
<span class=giallo-l><span style=color:#81a1c1>    .</span><span>fmt_event</span></span>
<span class=giallo-l><span style=color:#81a1c1>    .</span><span style=color:#88c0d0>format_event</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#81a1c1>        &</span><span>ctx</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        format</span><span style=color:#81a1c1>::</span><span>Writer</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut</span><span> buf</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>with_ansi</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span>is_ansi</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span>        event</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>   )</span></span></code></pre><p><code>fmt_layer::Layer</code>ã®å®šç¾©ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ãŠã‚Šã€<code>fmt_event</code>ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯<code>format::Format&lt;format::Full></code>ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> Layer</span><span style=color:#eceff4>&lt;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    S</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    N</span><span style=color:#81a1c1> =</span><span> format</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>DefaultFields</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    E</span><span style=color:#81a1c1> =</span><span> format</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Format</span><span style=color:#eceff4>&lt;</span><span>format</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Full</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    W</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> fn</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span> io</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Stdout</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span>    make_writer</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> W</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    fmt_fields</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> N</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    fmt_event</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> E</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    fmt_span</span><span style=color:#81a1c1>:</span><span> format</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>FmtSpanConfig</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    is_ansi</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> bool</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    log_internal_errors</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> bool</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    _inner</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> PhantomData</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>fn</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>)>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã¾ãŸã€<code>format_event()</code>ã¯<code>FormatEvent</code> traitã¨ã—ã¦å®šç¾©ã•ã‚Œã¦ãŠã‚Šã€<code>format::Format&lt;format::Full></code>ã¯ã“ã‚Œã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>pub trait</span><span style=color:#8fbcbb;font-weight:700> FormatEvent</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> N</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    S</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Subscriber</span><span style=color:#81a1c1> + for</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> LookupSpan</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    N</span><span style=color:#81a1c1>: for</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> FormatFields</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>></span><span style=color:#81a1c1> +</span><span style=color:#eceff4> '</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#616e88>    /// Write a log message for `Event` in `Context` to the given [`Writer`].</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> format_event</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#81a1c1>        &self</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        ctx</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>FmtContext</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> N</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>        writer</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Writer</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>        event</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Event</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    )</span><span style=color:#81a1c1> -></span><span> fmt</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/fmt/format/mod.rs#L195 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/fmt/format/mod.rs#L195</a><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> N</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> T</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> FormatEvent</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> N</span><span style=color:#eceff4>></span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> Format</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Full</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> T</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    S</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Subscriber</span><span style=color:#81a1c1> + for</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> LookupSpan</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    N</span><span style=color:#81a1c1>: for</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> FormatFields</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>></span><span style=color:#81a1c1> +</span><span style=color:#eceff4> '</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    T</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> FormatTime</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> format_event</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#81a1c1>        &self</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        ctx</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>FmtContext</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> N</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>        mut</span><span> writer</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Writer</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>        event</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Event</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    )</span><span style=color:#81a1c1> -></span><span> fmt</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>        // ...</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> meta</span><span style=color:#81a1c1> =</span><span> event</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>metadata</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span>        </span></span>
<span class=giallo-l><span style=color:#81a1c1>        if let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>ansi</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> = self.</span><span>ansi </span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span>            writer</span><span style=color:#81a1c1> =</span><span> writer</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>with_ansi</span><span style=color:#eceff4>(</span><span>ansi</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span style=color:#88c0d0>format_timestamp</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut</span><span> writer</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        if self.</span><span>display_level </span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#616e88>            // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        if self.</span><span>display_thread_name </span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#616e88>            // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        if self.</span><span>display_thread_id </span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#616e88>            // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> dimmed</span><span style=color:#81a1c1> =</span><span> writer</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>dimmed</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        if let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>scope</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> ctx</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>event_scope</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#616e88>            // ...</span></span>
<span class=giallo-l><span style=color:#81a1c1>            for</span><span> span</span><span style=color:#81a1c1> in</span><span> scope</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>from_root</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>                write!</span><span style=color:#eceff4>(</span><span>writer</span><span style=color:#eceff4>, "</span><span style=color:#ebcb8b>{}</span><span style=color:#eceff4>",</span><span> bold</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>paint</span><span style=color:#eceff4>(</span><span>span</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>metadata</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>name</span><span style=color:#eceff4>()))</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#616e88>                // ...</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>                let</span><span> ext</span><span style=color:#81a1c1> =</span><span> span</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>extensions</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>                if let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>fields</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> = &</span><span>ext</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>get</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>FormattedFields</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>N</span><span style=color:#eceff4>>>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    if !</span><span>fields</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>is_empty</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>                        write!</span><span style=color:#eceff4>(</span><span>writer</span><span style=color:#eceff4>, "</span><span style=color:#ebcb8b>{}{}{}</span><span style=color:#eceff4>",</span><span> bold</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>paint</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>{</span><span style=color:#eceff4>"),</span><span> fields</span><span style=color:#eceff4>,</span><span> bold</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>paint</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>}</span><span style=color:#eceff4>"))</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>                    }</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#616e88>                // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#616e88>            // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>        };</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        if self.</span><span>display_target </span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#616e88>            // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>        // ...</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        if self.</span><span>display_filename </span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#616e88>            // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>        ctx</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>format_fields</span><span style=color:#eceff4>(</span><span>writer</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>by_ref</span><span style=color:#eceff4>(),</span><span> event</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>        writeln!</span><span style=color:#eceff4>(</span><span>writer</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/fmt/format/mod.rs#L890 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/fmt/format/mod.rs#L890</a><p>é•·ã„ã§ã™ãŒã€æ¦‚è¦ã¨ã—ã¦ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ­ã‚°ã®æƒ…å ±ã‚’è¨­å®šã«å¿œã˜ã¦æ›¸ãè¾¼ã‚“ã§ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>2022-11-11T08:39:02.198973Z</span><span style=color:#a3be8c>  INFO span_1{key=</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>hello</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>}: tracing_handson: hello</span></span></code></pre><p>ä»Šå›æ³¨ç›®ã™ã‚‹ã®ã¯ã€ã©ã®ã‚ˆã†ã«spanã®æƒ…å ±ã‚’æ›¸ãè¾¼ã‚“ã§ã„ã‚‹ã‹ã§ã™ãŒã€ãŠãã‚‰ãä»¥ä¸‹ã®å‡¦ç†ã¨æ€ã‚ã‚Œã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>if let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>scope</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> ctx</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>event_scope</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span style=color:#81a1c1>    for</span><span> span</span><span style=color:#81a1c1> in</span><span> scope</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>from_root</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#616e88>        // ...</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> ext</span><span style=color:#81a1c1> =</span><span> span</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>extensions</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>fields</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> = &</span><span>ext</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>get</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>FormattedFields</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>N</span><span style=color:#eceff4>>>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            if !</span><span>fields</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>is_empty</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>                write!</span><span style=color:#eceff4>(</span><span>writer</span><span style=color:#eceff4>, "</span><span style=color:#ebcb8b>{}{}{}</span><span style=color:#eceff4>",</span><span> bold</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>paint</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>{</span><span style=color:#eceff4>"),</span><span> fields</span><span style=color:#eceff4>,</span><span> bold</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>paint</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>}</span><span style=color:#eceff4>"))</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#616e88>        // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>};</span></span></code></pre><p>æ¦‚è¦ã¨ã—ã¦ã¯ã€<code>ctx</code>(<code>FmtContext</code>)ã‹ã‚‰<code>scope</code>ã‚’å–å¾—ã—ã€scopeã‹ã‚‰<code>Span</code>ã®iteratorã‚’å–å¾—ã—ãŸã®ã¡ã€<code>FormattedFields&lt;N></code>ãŒspanã®æƒ…å ±(key/value)ã‚’æ›¸ãè¾¼ã‚“ã§ã„ã¾ã™ã€‚<br> ã¨ã„ã†ã“ã¨ã§ã€ã¾ãšã¯<code>scope</code>ã‹ã‚‰è¦‹ã¦ã¿ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> N</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> FmtContext</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> N</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    S</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Subscriber</span><span style=color:#81a1c1> + for</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>lookup</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> LookupSpan</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>lookup</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    N</span><span style=color:#81a1c1>: for</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>writer</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> FormatFields</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>writer</span><span style=color:#eceff4>></span><span style=color:#81a1c1> +</span><span style=color:#eceff4> '</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> event_scope</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span>registry</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Scope</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>>></span></span>
<span class=giallo-l><span style=color:#81a1c1>        where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            S</span><span style=color:#81a1c1>: for</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>lookup</span><span style=color:#eceff4>></span><span> registry</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>LookupSpan</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>lookup</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>ctx</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>event_scope</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span>event</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span><span>    </span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/fmt/fmt_layer.rs#L1147 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/fmt/fmt_layer.rs#L1147</a><p>ã¾ãš<code>Context.event_scope()</code>ã«å§”è­²ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Context</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    S</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Subscriber</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> event_scope</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> event</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Event</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span>registry</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Scope</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>>></span></span>
<span class=giallo-l><span style=color:#81a1c1>        where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            S</span><span style=color:#81a1c1>: for</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>lookup</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> LookupSpan</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>lookup</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Some</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span style=color:#88c0d0>event_span</span><span style=color:#eceff4>(</span><span>event</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?.</span><span style=color:#88c0d0>scope</span><span style=color:#eceff4>())</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> event_span</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> event</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Event</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>SpanRef</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>>></span></span>
<span class=giallo-l><span style=color:#81a1c1>        where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            S</span><span style=color:#81a1c1>: for</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>lookup</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> LookupSpan</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>lookup</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if</span><span> event</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>is_root</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            None</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span><span style=color:#81a1c1> else if</span><span> event</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>is_contextual</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            self.</span><span style=color:#88c0d0>lookup_current</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            event</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>parent</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>and_then</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>id</span><span style=color:#81a1c1>| self.</span><span style=color:#88c0d0>span</span><span style=color:#eceff4>(</span><span>id</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/layer/context.rs#L364 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/layer/context.rs#L364</a><p><code>Context::event_scope()</code>ã¯<code>Context::event_span()</code>ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚<br> <code>is_root()</code>ã‚„<code>is_contextual()</code>ã¯<code>Event.parent</code>ã®åˆ¤å®šã§ã“ã“ã§ã¯ã€<code>Parent::Current</code>ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã®ã§ã€<code>is_contextual()</code>ãŒtrueã‚’è¿”ã—ã€<code>Context::lookup_current()</code>ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Context</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>    where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        S</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Subscriber</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> lookup_current</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span>registry</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>SpanRef</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>>></span></span>
<span class=giallo-l><span style=color:#81a1c1>        where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            S</span><span style=color:#81a1c1>: for</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>lookup</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> LookupSpan</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>lookup</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> subscriber</span><span style=color:#81a1c1> = *self.</span><span>subscriber</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_ref</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> current</span><span style=color:#81a1c1> =</span><span> subscriber</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>current_span</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> id</span><span style=color:#81a1c1> =</span><span> current</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>id</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> span</span><span style=color:#81a1c1> =</span><span> subscriber</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>span</span><span style=color:#eceff4>(</span><span>id</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>        debug_assert!</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>            span</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>is_some</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>            "</span><span style=color:#a3be8c>the subscriber should have data for the current span (</span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>:?</span><span style=color:#ebcb8b>}</span><span style=color:#a3be8c>)!</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span>            id</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>        );</span></span>
<span class=giallo-l><span>        </span></span>
<span class=giallo-l><span style=color:#616e88>        // ...</span></span>
<span class=giallo-l><span>        </span></span>
<span class=giallo-l><span>        span</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/layer/context.rs#L256 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/layer/context.rs#L256</a><p>ã¨ã„ã†ã“ã¨ã§ã‚ˆã†ã‚„ãå–å¾—å‡¦ç†ã«ãŸã©ã‚Šç€ãã¾ã—ãŸã€‚<br> <code>Context</code>ã¯<code>Subscriber</code>ã®wrapperã§ã“ã“ã§ã¯<code>Registry</code>ã‚’æŒ‡ã—ã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>let</span><span> current</span><span style=color:#81a1c1> =</span><span> subscriber</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>current_span</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>let</span><span> id</span><span style=color:#81a1c1> =</span><span> current</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>id</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>let</span><span> span</span><span style=color:#81a1c1> =</span><span> subscriber</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>span</span><span style=color:#eceff4>(</span><span>id</span><span style=color:#eceff4>);</span></span></code></pre><p>ä¸Šè¨˜ã§ã€<code>Registry::current_span()</code>ã§ç¾åœ¨ã®spanã®æƒ…å ±ã‚’å–å¾—ã—ãŸã®ã¡å½“è©²<code>span::Id</code>ã‹ã‚‰<code>SpanRef</code>ã‚’å–å¾—ã—ã¦è¿”ã—ã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Subscriber</span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> Registry</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> current_span</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Current</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>current_spans        </span><span style=color:#616e88>// ThreadLocal&lt;RefCell&lt;SpanStack>></span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>get</span><span style=color:#eceff4>()</span><span style=color:#616e88>                // Option&lt;&RefCell&lt;SpanStack>></span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>and_then</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>spans</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>RefCell</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>SpanStack</span><span style=color:#eceff4>></span><span style=color:#81a1c1>|</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                let</span><span> spans</span><span style=color:#81a1c1> =</span><span> spans</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>borrow</span><span style=color:#eceff4>();</span><span style=color:#616e88> // Ref&lt;SpanStack></span></span>
<span class=giallo-l><span style=color:#81a1c1>                let</span><span> id</span><span style=color:#81a1c1> =</span><span> spans</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>current</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>                let</span><span> span</span><span style=color:#81a1c1> = self.</span><span style=color:#88c0d0>get</span><span style=color:#eceff4>(</span><span>id</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Some</span><span style=color:#eceff4>(</span><span>Current</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>id</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>(),</span><span> span</span><span style=color:#81a1c1>.</span><span>metadata</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#eceff4>            })</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>unwrap_or_else</span><span style=color:#eceff4>(</span><span>Current</span><span style=color:#81a1c1>::</span><span>none</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/registry/sharded.rs#L330 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/registry/sharded.rs#L330</a><p><code>Registry::current_span()</code>ã®ä¸­ã§<code>SpanStack</code>ã®å…ˆé ­ã®<code>span::Id</code>ã‚’å–å¾—ã—ã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> SpanStack</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#5e81ac>    #[inline]</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>crate</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> fn</span><span style=color:#88c0d0> iter</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> impl</span><span style=color:#8fbcbb> Iterator</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Item</span><span style=color:#81a1c1> = &</span><span style=color:#8fbcbb>Id</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>stack</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>iter</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>rev</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>filter_map</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span style=color:#8fbcbb>ContextId</span><span style=color:#eceff4> {</span><span> id</span><span style=color:#eceff4>,</span><span> duplicate</span><span style=color:#eceff4> }</span><span style=color:#81a1c1>| if !*</span><span>duplicate</span><span style=color:#eceff4> {</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>id</span><span style=color:#eceff4>) }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span><span style=color:#8fbcbb> None</span><span style=color:#eceff4> })</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>    #[inline]</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>crate</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> fn</span><span style=color:#88c0d0> current</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>&</span><span style=color:#8fbcbb>Id</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span style=color:#88c0d0>iter</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>next</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/registry/stack.rs#L50 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/registry/stack.rs#L50</a><p><code>Current</code>ã¯<code>span::Id</code>ã®wrapperã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>let</span><span> current</span><span style=color:#81a1c1> =</span><span> subscriber</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>current_span</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>let</span><span> id</span><span style=color:#81a1c1> =</span><span> current</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>id</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>let</span><span> span</span><span style=color:#81a1c1> =</span><span> subscriber</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>span</span><span style=color:#eceff4>(</span><span>id</span><span style=color:#eceff4>);</span></span></code></pre><p><code>subscriber.span</code>ã§<code>span::Id</code>ã‹ã‚‰spanã®æƒ…å ±ã‚’å–å¾—ã—ã¾ã™ã€‚ã“ã®spanã®æƒ…å ±ã®å–å¾—ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«<code>LookupSpan</code>ã¨ã„ã†traitã§å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>pub trait</span><span style=color:#8fbcbb;font-weight:700> LookupSpan</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Data</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> SpanData</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> span_data</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>a</span><span style=color:#81a1c1> self</span><span style=color:#eceff4>,</span><span> id</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Id</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>Self::</span><span style=color:#8fbcbb>Data</span><span style=color:#eceff4>>;</span></span>
<span class=giallo-l><span>    </span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> span</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>a</span><span style=color:#81a1c1> self</span><span style=color:#eceff4>,</span><span> id</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Id</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>SpanRef</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> Self</span><span style=color:#eceff4>>></span></span>
<span class=giallo-l><span style=color:#81a1c1>    where</span></span>
<span class=giallo-l><span style=color:#81a1c1>        Self:</span><span style=color:#8fbcbb> Sized</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> data</span><span style=color:#81a1c1> = self.</span><span style=color:#88c0d0>span_data</span><span style=color:#eceff4>(</span><span>id</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Some</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>SpanRef</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            registry</span><span style=color:#81a1c1>: self</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            data</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#5e81ac>            #[cfg(feature = "</span><span style=color:#a3be8c>registry</span><span style=color:#5e81ac>")]</span></span>
<span class=giallo-l><span>            filter</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> FilterId</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>none</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>        })</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/registry/mod.rs#L92 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/registry/mod.rs#L92</a><p><code>LookupSpan::span()</code>ã¯defaultã®å®Ÿè£…ãŒæä¾›ã•ã‚Œã¦ãŠã‚Šã€å®Ÿè£…ã™ã‚‹å‹ã¯<code>span_data()</code>ã‚’implã™ã‚Œã°ã‚ˆã•ãã†ã§ã™ã€‚<br> <code>Registry::span_data()</code>ã®å®Ÿè£…ã¯ã‚·ãƒ³ãƒ—ãƒ«ã§<code>Pool&lt;DataInner></code>ã‹ã‚‰å–å¾—ã™ã‚‹ã ã‘ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> LookupSpan</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>></span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> Registry</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Data</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Data</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> span_data</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>a</span><span style=color:#81a1c1> self</span><span style=color:#eceff4>,</span><span> id</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Id</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>Self::</span><span style=color:#8fbcbb>Data</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> inner</span><span style=color:#81a1c1> = self.</span><span style=color:#88c0d0>get</span><span style=color:#eceff4>(</span><span>id</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Some</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Data</span><span style=color:#eceff4> {</span><span> inner</span><span style=color:#eceff4> })</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> register_filter</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> FilterId</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> id</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> FilterId</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span>next_filter_id</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>next_filter_id </span><span style=color:#81a1c1>+=</span><span style=color:#b48ead> 1</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span>        id</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/registry/sharded.rs#L369 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/registry/sharded.rs#L369</a><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Registry</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> get</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> id</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Id</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Ref</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> DataInner</span><span style=color:#eceff4>>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>spans</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>get</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>id_to_idx</span><span style=color:#eceff4>(</span><span>id</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/registry/sharded.rs#L182 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/registry/sharded.rs#L182</a><p>ã“ã“ã¾ã§ã§ã€<code>Registry</code>ã®<code>SpanStack</code>ã‹ã‚‰å…ˆé ­ã®<code>span::Id</code>ã‚’å–å¾—ã—ãŸã®ã¡ã€<code>Pool</code>ã«ç¢ºä¿ã—ã¦ã„ãŸ<code>Span</code>ã®æƒ…å ±ã‚’å–å¾—ã—ã¦ã€<code>SpanRef</code>ã¨ã—ã¦è¿”ã™ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚<br> å¿…è¦ãªã®ã¯ç¾åœ¨ã®eventã‚’å«ã‚“ã§ã„ã‚‹<code>Span</code>ã®iteratorãªã®ã§ã€ãã‚Œã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ã€<code>SpanRef::scope()</code>ãŒå‘¼ã°ã‚Œã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Context</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    S</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Subscriber</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> event_scope</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> event</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Event</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span>registry</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Scope</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>>></span></span>
<span class=giallo-l><span style=color:#81a1c1>        where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            S</span><span style=color:#81a1c1>: for</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>lookup</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> LookupSpan</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>lookup</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Some</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span style=color:#88c0d0>event_span</span><span style=color:#eceff4>(</span><span>event</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?.</span><span style=color:#88c0d0>scope</span><span style=color:#eceff4>())</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> R</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> SpanRef</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> R</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    R</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> LookupSpan</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> scope</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Scope</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> R</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Scope</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            registry</span><span style=color:#81a1c1>: self.</span><span>registry</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            next</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span style=color:#88c0d0>id</span><span style=color:#eceff4>()),</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>            #[cfg(feature = "</span><span style=color:#a3be8c>registry</span><span style=color:#5e81ac>")]</span></span>
<span class=giallo-l><span>            filter</span><span style=color:#81a1c1>: self.</span><span>filter</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/registry/mod.rs#L465 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/registry/mod.rs#L465</a><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Debug</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> Scope</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> R</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span>    registry</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>a R</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    next</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Id</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/registry/mod.rs#L210 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/registry/mod.rs#L210</a><p><code>Scope</code>ã¯spanã®iterateã™ã‚‹æ‰‹æ®µã‚’ã„ãã¤ã‹æä¾›ã—ã¦ãŠã‚Šã€ä»Šå›ã¯root(outer)ã‹ã‚‰å–å¾—ã—ãŸã„ã®ã§ã€<code>Scope::from_root()</code>ã‚’å‘¼ã³ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> R</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Scope</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> R</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    R</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> LookupSpan</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> from_root</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> ScopeFromRoot</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> R</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#5e81ac>        #[cfg(feature = "</span><span style=color:#a3be8c>smallvec</span><span style=color:#5e81ac>")]</span></span>
<span class=giallo-l><span style=color:#81a1c1>        type</span><span style=color:#8fbcbb> Buf</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>></span><span style=color:#81a1c1> =</span><span> smallvec</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>SmallVec</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>>;</span></span>
<span class=giallo-l><span style=color:#5e81ac>        #[cfg(not(feature = "</span><span style=color:#a3be8c>smallvec</span><span style=color:#5e81ac>"))]</span></span>
<span class=giallo-l><span style=color:#81a1c1>        type</span><span style=color:#8fbcbb> Buf</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>></span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Vec</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        ScopeFromRoot</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            spans</span><span style=color:#81a1c1>: self.</span><span style=color:#88c0d0>collect</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Buf</span><span style=color:#eceff4>&lt;</span><span>_</span><span style=color:#eceff4>>>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into_iter</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>rev</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/registry/mod.rs#L254 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/registry/mod.rs#L254</a><p>ã‚ã‹ã‚Šã¥ã‚‰ã„ã®ã§ã™ãŒã€<code>spans::self.collect::&lt;Buf&lt;_>>().into_iter().rev()</code>ã§<code>Scope</code>ã‹ã‚‰iteratorã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> SpanRef</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> R</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> LookupSpan</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>>> {</span></span>
<span class=giallo-l><span>    registry</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>a R</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    data</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> R</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Data</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> R</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Iterator</span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> Scope</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> R</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    R</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> LookupSpan</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Item</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> SpanRef</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> R</span><span style=color:#eceff4>>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> next</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>Self::</span><span style=color:#8fbcbb>Item</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        loop</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let</span><span> curr</span><span style=color:#81a1c1> = self.</span><span>registry</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>span</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span>next</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_ref</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>            // ...</span></span>
<span class=giallo-l><span style=color:#81a1c1>            self.</span><span>next </span><span style=color:#81a1c1>=</span><span> curr</span><span style=color:#81a1c1>.</span><span>data</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>parent</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>cloned</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span>            </span></span>
<span class=giallo-l><span style=color:#616e88>            // ...</span></span>
<span class=giallo-l><span>            </span></span>
<span class=giallo-l><span style=color:#81a1c1>            return</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>curr</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>wrapã—ã¦ã„ã‚‹<code>Registry</code>ã‹ã‚‰ç¾åœ¨ã®<code>span::Id</code>ã«å¯¾å¿œã™ã‚‹spanã®æƒ…å ±(<code>SpanRef</code>)ã‚’å–å¾—ã—ãŸã®ã¡ã€å½“è©²spanã®è¦ªã®æƒ…å ±ã‚’æ¬¡ã«è¿”ã™idã¨ã—ã¦ä¿æŒã—ã¾ã™ã€‚<p>ã„ã‚ã„ã‚å‹ãŒã§ã¦ãã¦ã‚ã‹ã‚Šã¥ã‚‰ã„ã§ã™ãŒã€æ¦‚è¦ã¨ã—ã¦ã¯ã€<code>Registry</code>ã§ç®¡ç†ã—ã¦ã„ã‚‹<code>SpanStack</code>ã®å…ˆé ­ã®<code>span::Id</code>ã‚’å–å¾—ã—ãŸã®ã¡ã€ãã“ã‹ã‚‰threadé–“ã§å…±æœ‰ã—ã¦ã„ã‚‹ã€<code>Span</code>ã®metadataã‚„è¦ªæƒ…å ±ã‚’ä¿æŒã—ã¦ã„ã‚‹<code>DataInner</code>ã‚’å–å¾—ã—ã¦è¦ªãŒãªããªã‚‹ã¾ã§iterateã—ã¦ã„ã‚‹ã¨ã„ãˆã¾ã™ã€‚<p>ã“ã“ã¾ã§ã§ã¦ä»¥ä¸‹ã®ã‚ˆã†ã«eventã‚’formatã—ã¦Stringã«æ›¸ãè¾¼ã‚€å‡¦ç†ã®ã†ã¡ã€å½“è©²eventã‚’scopeã«å«ã‚€spanã‚’iterateã™ã‚‹æ–¹æ³•ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> N</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> T</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> FormatEvent</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> N</span><span style=color:#eceff4>></span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> Format</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Full</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> T</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    S</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Subscriber</span><span style=color:#81a1c1> + for</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> LookupSpan</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    N</span><span style=color:#81a1c1>: for</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> FormatFields</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>></span><span style=color:#81a1c1> +</span><span style=color:#eceff4> '</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    T</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> FormatTime</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> format_event</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#81a1c1>        &self</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        ctx</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>FmtContext</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> N</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>        mut</span><span> writer</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Writer</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>        event</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Event</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    )</span><span style=color:#81a1c1> -></span><span> fmt</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>        // ...</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>scope</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> ctx</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>event_scope</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#616e88>            // ...</span></span>
<span class=giallo-l><span style=color:#81a1c1>            for</span><span> span</span><span style=color:#81a1c1> in</span><span> scope</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>from_root</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>                write!</span><span style=color:#eceff4>(</span><span>writer</span><span style=color:#eceff4>, "</span><span style=color:#ebcb8b>{}</span><span style=color:#eceff4>",</span><span> bold</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>paint</span><span style=color:#eceff4>(</span><span>span</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>metadata</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>name</span><span style=color:#eceff4>()))</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#616e88>                // ...</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>                let</span><span> ext</span><span style=color:#81a1c1> =</span><span> span</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>extensions</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>                if let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>fields</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> = &</span><span>ext</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>get</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>FormattedFields</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>N</span><span style=color:#eceff4>>>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    if !</span><span>fields</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>is_empty</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>                        write!</span><span style=color:#eceff4>(</span><span>writer</span><span style=color:#eceff4>, "</span><span style=color:#ebcb8b>{}{}{}</span><span style=color:#eceff4>",</span><span> bold</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>paint</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>{</span><span style=color:#eceff4>"),</span><span> fields</span><span style=color:#eceff4>,</span><span> bold</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>paint</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>}</span><span style=color:#eceff4>"))</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>                    }</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#616e88>                // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#616e88>            // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>        };</span></span>
<span class=giallo-l><span style=color:#616e88>        // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>for</span><span> span</span><span style=color:#81a1c1> in</span><span> scope</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>from_root</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> ext</span><span style=color:#81a1c1> =</span><span> span</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>extensions</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>    if let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>fields</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> = &</span><span>ext</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>get</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>FormattedFields</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>N</span><span style=color:#eceff4>>>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if !</span><span>fields</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>is_empty</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>            write!</span><span style=color:#eceff4>(</span><span>writer</span><span style=color:#eceff4>, "</span><span style=color:#ebcb8b>{}{}{}</span><span style=color:#eceff4>",</span><span> bold</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>paint</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>{</span><span style=color:#eceff4>"),</span><span> fields</span><span style=color:#eceff4>,</span><span> bold</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>paint</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>}</span><span style=color:#eceff4>"))</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>æ¬¡ã«<code>Span::extensions()</code>ã§ã™ã€‚ä»¥ä¸‹ã®ã‚ˆã†ã«ã“ã‚Œã¯<code>Extensions</code>ã‚’è¿”ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> R</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> SpanRef</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> R</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    R</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> LookupSpan</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> extensions</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Extensions</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>data</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>extensions</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/registry/mod.rs#L481 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/registry/mod.rs#L481</a><p><code>Extensions</code>ã¨ã¯ãªã‚“ã§ã—ã‚‡ã†ã‹ã€‚å®šç¾©ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>use crate::</span><span>sync</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>RwLockReadGuard</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> Extensions</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span>    inner</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> RwLockReadGuard</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> ExtensionsInner</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Extensions</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#5e81ac>    #[cfg(feature = "</span><span style=color:#a3be8c>registry</span><span style=color:#5e81ac>")]</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>crate</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> fn</span><span style=color:#88c0d0> new</span><span style=color:#eceff4>(</span><span>inner</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> RwLockReadGuard</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> ExtensionsInner</span><span style=color:#eceff4>>)</span><span style=color:#81a1c1> -> Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        Self</span><span style=color:#eceff4> {</span><span> inner</span><span style=color:#eceff4> }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    /// Immutably borrows a type previously inserted into this `Extensions`.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> get</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#81a1c1>:</span><span style=color:#eceff4> '</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>&</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>inner</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>get</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>>()</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/registry/extensions.rs#L39 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/registry/extensions.rs#L39</a><p><code>ExtensionsInner</code>ã‚’wrapã—ã¦ãŠã‚Šã€<code>Extension::get()</code>ã§ä»»æ„ã®<code>T</code>ã‚’å–å¾—ã§ãã‚‹apiã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>if let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>fields</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> = &</span><span>ext</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>get</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>FormattedFields</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>N</span><span style=color:#eceff4>>>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    if !</span><span>fields</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>is_empty</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>        write!</span><span style=color:#eceff4>(</span><span>writer</span><span style=color:#eceff4>, "</span><span style=color:#ebcb8b>{}{}{}</span><span style=color:#eceff4>",</span><span> bold</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>paint</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>{</span><span style=color:#eceff4>"),</span><span> fields</span><span style=color:#eceff4>,</span><span> bold</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>paint</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>}</span><span style=color:#eceff4>"))</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>eventã®formatæ™‚ã«ã€ã“ã®<code>get()</code>ã‚’åˆ©ç”¨ã—ã¦ã€<code>FormattedFields</code>ã‚’å–å¾—ã—ã¦ãŠã‚Šã€ã“ã®<code>FormattedFields</code>ãŒspanã®key/valueã®æƒ…å ±ã‚’<code>Display</code>ã¨ã—ã¦å®Ÿè£…ã—ã¦ã„ãã†ã§ã™ã€‚<p>ã¡ãªã¿ã«<code>ExtensionsInner</code>ã¯<code>std::any</code>ã‚’åˆ©ç”¨ã—ã¦ä»»æ„ã®å‹ã‚’å—ã‘æ¸¡ã›ã‚‹æ§˜ã«ãªã£ã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span>    any</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>Any</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> TypeId</span><span style=color:#eceff4>},</span></span>
<span class=giallo-l><span>    hash</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>BuildHasherDefault</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Hasher</span><span style=color:#eceff4>},</span></span>
<span class=giallo-l><span style=color:#eceff4>};</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>type</span><span style=color:#8fbcbb> AnyMap</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> HashMap</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>TypeId</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Box</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>dyn</span><span style=color:#8fbcbb> Any</span><span style=color:#81a1c1> +</span><span style=color:#8fbcbb> Send</span><span style=color:#81a1c1> +</span><span style=color:#8fbcbb> Sync</span><span style=color:#eceff4>>,</span><span style=color:#8fbcbb> BuildHasherDefault</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>IdHasher</span><span style=color:#eceff4>>>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>pub</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>crate</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> struct</span><span style=color:#8fbcbb> ExtensionsInner</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    map</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> AnyMap</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>æ¬¡ã«ã“ã®<code>Extensions</code>ã¯ã©ã“ã§ç”Ÿæˆã•ã‚Œã¦spanã«ä»˜ä¸ã•ã‚Œã¦ã„ã‚‹ã‹ãŒæ°—ã«ãªã‚Šã¾ã™ã€‚<br> spanã®key/valueã®å€¤ã¯<code>Span::new()</code>æ™‚ã«æ±ºã¾ã‚‹ã¯ãšãªã®ã§ã€<code>Span::new()</code>ã§ã‚ã‚‹ã¨ã‚ãŸã‚Šã‚’ã¤ã‘ã¾ã™ã€‚<br> SpanãŒenterã—ãŸéš›ã«<code>Registry::new_span()</code>ãŒå‘¼ã°ã‚ŒãŸã‚ã¨ã«ã€<code>Layered</code>ãŒ<code>fmt_layer::Layer</code>ã®<code>on_new_span()</code>ã‚’å‘¼ã¶ã®ã§ãã“ã‚’ã¿ã¦ã¿ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> N</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> E</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> W</span><span style=color:#eceff4>></span><span> layer</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Layer</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>></span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> Layer</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> N</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> E</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> W</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    S</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Subscriber</span><span style=color:#81a1c1> + for</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> LookupSpan</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    N</span><span style=color:#81a1c1>: for</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>writer</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> FormatFields</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>writer</span><span style=color:#eceff4>></span><span style=color:#81a1c1> +</span><span style=color:#eceff4> '</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    E</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> FormatEvent</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> N</span><span style=color:#eceff4>></span><span style=color:#81a1c1> +</span><span style=color:#eceff4> '</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    W</span><span style=color:#81a1c1>: for</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>writer</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> MakeWriter</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>writer</span><span style=color:#eceff4>></span><span style=color:#81a1c1> +</span><span style=color:#eceff4> '</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> on_new_span</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> attrs</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Attributes</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>,</span><span> id</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Id</span><span style=color:#eceff4>,</span><span> ctx</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Context</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> span</span><span style=color:#81a1c1> =</span><span> ctx</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>span</span><span style=color:#eceff4>(</span><span>id</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>expect</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Span not found, this is a bug</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> extensions</span><span style=color:#81a1c1> =</span><span> span</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>extensions_mut</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        if</span><span> extensions</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>get_mut</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>FormattedFields</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>N</span><span style=color:#eceff4>>>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>is_none</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let mut</span><span> fields</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> FormattedFields</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>N</span><span style=color:#eceff4>></span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>String</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#81a1c1>            if self</span></span>
<span class=giallo-l><span style=color:#81a1c1>                .</span><span>fmt_fields</span></span>
<span class=giallo-l><span style=color:#81a1c1>                .</span><span style=color:#88c0d0>format_fields</span><span style=color:#eceff4>(</span><span>fields</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_writer</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>with_ansi</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span>is_ansi</span><span style=color:#eceff4>),</span><span> attrs</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>                .</span><span style=color:#88c0d0>is_ok</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>            {</span></span>
<span class=giallo-l><span>                fields</span><span style=color:#81a1c1>.</span><span>was_ansi </span><span style=color:#81a1c1>= self.</span><span>is_ansi</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span>                extensions</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>insert</span><span style=color:#eceff4>(</span><span>fields</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>                eprintln!</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>                    "</span><span style=color:#a3be8c>[tracing-subscriber] Unable to format the following event, ignoring: </span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>:?</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span>                    attrs</span></span>
<span class=giallo-l><span style=color:#eceff4>                );</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#616e88>        // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/fmt/fmt_layer.rs#L771 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/fmt/fmt_layer.rs#L771</a><p>äºˆæƒ³é€šã‚Šã€<code>extensions.get_mut::&lt;FormattedFields&lt;N>>().is_none()</code>ã§åˆ¤å®šã—ã€<code>extension.insert(fields)</code>ã§ã‚»ãƒƒãƒˆã—ã¦ã„ã¾ã™ã€‚<br> <code>self.fmt_fields</code>ã¯<code>FormatFields</code> traitã‚’å®Ÿè£…ã—ã¦ãŠã‚Šã€<code>span::Attributes</code>ã®æ›¸ãè¾¼ã¿æ–¹æ³•ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚ spanã¨eventã®key/valueã®æ›¸ãè¾¼ã¿å‡¦ç†ã‚’å…±é€šåŒ–ã—ã¦ã„ã‚‹ã®ã§ã€è©³ç´°ã¯eventã®æ›¸ãè¾¼ã¿æ™‚ã«ã¿ã¦ã„ãã¾ã™ã€‚<p>ã“ã“ã¾ã§ã§ã¦ã€spanã®æƒ…å ±ã‚’æ›¸ãè¾¼ã‚ãŸã®ã§æœ€å¾Œã«<code>Event</code>ã®æƒ…å ±ã‚’æ›¸ãè¾¼ã‚€ã“ã¨ã§loggingå‡¦ç†ãŒå®Œäº†ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> N</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> T</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> FormatEvent</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> N</span><span style=color:#eceff4>></span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> Format</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Full</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> T</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    S</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Subscriber</span><span style=color:#81a1c1> + for</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> LookupSpan</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    N</span><span style=color:#81a1c1>: for</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> FormatFields</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>></span><span style=color:#81a1c1> +</span><span style=color:#eceff4> '</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    T</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> FormatTime</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> format_event</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#81a1c1>        &self</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        ctx</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>FmtContext</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> N</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>        mut</span><span> writer</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Writer</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>        event</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Event</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    )</span><span style=color:#81a1c1> -></span><span> fmt</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>        // ...</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>        ctx</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>format_fields</span><span style=color:#eceff4>(</span><span>writer</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>by_ref</span><span style=color:#eceff4>(),</span><span> event</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>        writeln!</span><span style=color:#eceff4>(</span><span>writer</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>FmtContext::format_fields()</code>ã¯wrapã—ã¦ã„ã‚‹<code>fmt_fields</code>ã«å‡¦ç†ã‚’å§”è­²ã—ã¦ãŠã‚Šã€å‹ã¯<code>DefaultFields</code>ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> FmtContext</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> N</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>crate</span><span style=color:#eceff4>)</span><span> fmt_fields</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>a N</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>cx</span><span style=color:#eceff4>, '</span><span style=color:#8fbcbb>writer</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> N</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> FormatFields</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>writer</span><span style=color:#eceff4>></span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> FmtContext</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>cx</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> N</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    S</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Subscriber</span><span style=color:#81a1c1> + for</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>lookup</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> LookupSpan</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>lookup</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    N</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> FormatFields</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>writer</span><span style=color:#eceff4>></span><span style=color:#81a1c1> +</span><span style=color:#eceff4> '</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> format_fields</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>R</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> RecordFields</span><span style=color:#eceff4>>(</span></span>
<span class=giallo-l><span style=color:#81a1c1>        &self</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        writer</span><span style=color:#81a1c1>:</span><span> format</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Writer</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>writer</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>        fields</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> R</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    )</span><span style=color:#81a1c1> -></span><span> fmt</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>fmt_fields</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>format_fields</span><span style=color:#eceff4>(</span><span>writer</span><span style=color:#eceff4>,</span><span> fields</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã¨ã„ã†ã“ã¨ã§ã€<code>DefaultFields</code>ã¯ã©ã†ã‚„ã£ã¦eventã¨spanã®key/valueã‚’formatã—ã¦ã„ã‚‹ã®ã‹ãªã¨ç¢ºèªã—ãŸã„ã¨ã“ã‚ã§ã™ãŒã€ã“ã®å‡¦ç†ã‚‚ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã§ãã‚‹ã‚ˆã†ã«genericã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>writer</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> M</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> FormatFields</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>writer</span><span style=color:#eceff4>></span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> M</span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    M</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> MakeOutput</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Writer</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>writer</span><span style=color:#eceff4>>,</span><span> fmt</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    M</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Visitor</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> VisitFmt</span><span style=color:#81a1c1> +</span><span style=color:#8fbcbb> VisitOutput</span><span style=color:#eceff4>&lt;</span><span>fmt</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> format_fields</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>R</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> RecordFields</span><span style=color:#eceff4>>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> writer</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Writer</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>writer</span><span style=color:#eceff4>>,</span><span> fields</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> R</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span> fmt</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> v</span><span style=color:#81a1c1> = self.</span><span style=color:#88c0d0>make_visitor</span><span style=color:#eceff4>(</span><span>writer</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span>        fields</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>record</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut</span><span> v</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span>        v</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>finish</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/fmt/format/mod.rs#L1141 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/fmt/format/mod.rs#L1141</a><p>ã¨ã„ã†ã“ã¨ã§<code>DefaultFields</code>ãŒ<code>FormatFields</code>ã‚’implã™ã‚‹å‡¦ç†ã‚’è¦‹ã«ã„ããŸã„ã¨ã“ã‚ã§ã™ãŒã€ã“ã®ã‚ãŸã‚Šã¯è¤‡é›‘ã«ãªã£ã¦ãŠã‚Šã€ã©ã®ã‚ˆã†ãªå•é¡Œæ„è­˜ã§ã“ã‚Œã‚‰ã®å‡¦ç†ãŒtraitã«åˆ‡ã‚Šå‡ºã•ã‚Œã¦ã„ã‚‹ã‹ç†è§£ã§ãã¦ã„ãªã„ã§ã™ã€‚å…·ä½“çš„ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚<p><code>FormatFields</code> traitã¯<code>MakeOutput&lt;_></code>ã‚’å®Ÿè£…ã™ã‚‹<code>M</code>ã«å¯¾ã—ã¦genericã«å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>writer</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> M</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> FormatFields</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>writer</span><span style=color:#eceff4>></span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> M</span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    M</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> MakeOutput</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Writer</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>writer</span><span style=color:#eceff4>>,</span><span> fmt</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    M</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Visitor</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> VisitFmt</span><span style=color:#81a1c1> +</span><span style=color:#8fbcbb> VisitOutput</span><span style=color:#eceff4>&lt;</span><span>fmt</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> format_fields</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>R</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> RecordFields</span><span style=color:#eceff4>>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> writer</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Writer</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>writer</span><span style=color:#eceff4>>,</span><span> fields</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> R</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span> fmt</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> v</span><span style=color:#81a1c1> = self.</span><span style=color:#88c0d0>make_visitor</span><span style=color:#eceff4>(</span><span>writer</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span>        fields</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>record</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut</span><span> v</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span>        v</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>finish</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/fmt/format/mod.rs#L1141 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/fmt/format/mod.rs#L1141</a><p>ãã‚Œãªã‚‰<code>DefaultFields</code>ãŒ<code>MakeOutput&lt;_></code>ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ã®ã‹ãªã¨æ€ã†ã®ã§ã™ãŒã‚‚ã†ä¸€æ®µã‹ã¾ã›ã¦ã‚ã‚Šã€<code>MakeOutput&lt;_></code>ã¯<code>MakeVisitor&lt;_></code>ã‚’å®Ÿè£…ã™ã‚‹<code>M</code>ã«å¯¾ã—ã¦å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Out</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> M</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> MakeOutput</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Out</span><span style=color:#eceff4>></span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> M</span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    M</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> MakeVisitor</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    M</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Visitor</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> VisitOutput</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Out</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{ }</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/field/mod.rs#L212 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/field/mod.rs#L212</a><p>ãã—ã¦ã€<code>DefaultFields</code>ã¯ã“ã®<code>MakeVisitor&lt;_></code>ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ã®ã§<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> MakeVisitor</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Writer</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>>></span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> DefaultFields</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Visitor</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> DefaultVisitor</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>    #[inline]</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> make_visitor</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> target</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Writer</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>>)</span><span style=color:#81a1c1> -> Self::</span><span style=color:#8fbcbb>Visitor</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        DefaultVisitor</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>target</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> true</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/fmt/format/mod.rs#L1187 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/fmt/format/mod.rs#L1187</a><p><code>DefaultFields</code> ->(impl) <code>MakeVisitor&lt;_></code> ->(blanket impl) <code>MakeOutput&lt;_></code> ->(blanket impl) <code>FormatFields</code>ã¨ã„ã†æµã‚Œã§ã€<code>DefaultFields</code>ãŒfieldsã®formatå‡¦ç†ã‚’å®Ÿæ–½ã—ã¦ã„ã‚‹ã¨ã„ã†ç†è§£ã§ã™ã€‚<p>ã‚ã‚‰ãŸã‚ã¦eventã®formatå‡¦ç†ã§ã™ãŒä»¥ä¸‹ã®ã‚ˆã†ã«visitorã‚’ç”Ÿæˆã—ã€<code>RecordFields::record()</code>ã«æ¸¡ã—ã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>writer</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> M</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> FormatFields</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>writer</span><span style=color:#eceff4>></span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> M</span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    M</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> MakeOutput</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Writer</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>writer</span><span style=color:#eceff4>>,</span><span> fmt</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    M</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Visitor</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> VisitFmt</span><span style=color:#81a1c1> +</span><span style=color:#8fbcbb> VisitOutput</span><span style=color:#eceff4>&lt;</span><span>fmt</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> format_fields</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>R</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> RecordFields</span><span style=color:#eceff4>>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> writer</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Writer</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>writer</span><span style=color:#eceff4>>,</span><span> fields</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> R</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span> fmt</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> v</span><span style=color:#81a1c1> = self.</span><span style=color:#88c0d0>make_visitor</span><span style=color:#eceff4>(</span><span>writer</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span>        fields</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>record</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut</span><span> v</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span>        v</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>finish</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>fields: R</code>ã«ã¯<code>Event</code>ãŒæ¸¡ã•ã‚Œã‚‹ã®ã§<code>Event</code>ã®å®Ÿè£…ã‚’ã¿ã¦ã¿ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> RecordFields</span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> Event</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> record</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> visitor</span><span style=color:#81a1c1>: &mut dyn</span><span style=color:#8fbcbb> Visit</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Event</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>record</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self</span><span style=color:#eceff4>,</span><span> visitor</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/field/mod.rs#L162 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/field/mod.rs#L162</a><p>å˜ç´”ã«<code>Event::record</code>ã«å§”è­²ã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Event</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> record</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> visitor</span><span style=color:#81a1c1>: &mut dyn</span><span> field</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Visit</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>fields</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>record</span><span style=color:#eceff4>(</span><span>visitor</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-core/src/event.rs#L86 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-core/src/event.rs#L86</a><p>ã•ã‚‰ã«ã€<code>Event.fields</code>ã«å§”è­²ã—ã¦ã„ã¾ã™ã€‚<code>Event</code>ã®å®šç¾©ã‚’ç¢ºèªã™ã‚‹ã¨<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> Event</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span>    fields</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>a</span><span> field</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>ValueSet</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>    metadata</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>static Metadata</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>    parent</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Parent</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-core/src/event.rs#L23 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-core/src/event.rs#L23</a><p><code>fields</code>ã¯<code>ValueSet</code>å‹ãªã®ã§ã€<code>ValueSet::record()</code>ã‚’è¦‹ã¦ã¿ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> ValueSet</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> record</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> visitor</span><span style=color:#81a1c1>: &mut dyn</span><span style=color:#8fbcbb> Visit</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> my_callsite</span><span style=color:#81a1c1> = self.</span><span style=color:#88c0d0>callsite</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>        for</span><span style=color:#eceff4> (</span><span>field</span><span style=color:#eceff4>,</span><span> value</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> in self.</span><span>values </span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>            if</span><span> field</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>callsite</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> !=</span><span> my_callsite</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                continue</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#81a1c1>            if let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>value</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> value</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                value</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>record</span><span style=color:#eceff4>(</span><span>field</span><span style=color:#eceff4>,</span><span> visitor</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-core/src/field.rs#L990 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-core/src/field.rs#L990</a><p><code>self.values</code>ã‚’iterateã—ã¦ã€ãã‚Œãã‚Œã®<code>value.record</code>ã«visitorã‚’æ¸¡ã—ã¦ã„ã¾ã™ã€‚<br> <code>ValueSet</code>ã®å®šç¾©ã‚’ç¢ºèªã™ã‚‹ã¨<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> ValueSet</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span>    values</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4> [(</span><span style=color:#81a1c1>&</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>a Field</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>&</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4> (</span><span style=color:#81a1c1>dyn</span><span style=color:#8fbcbb> Value</span><span style=color:#81a1c1> +</span><span style=color:#eceff4> '</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>)>)],</span></span>
<span class=giallo-l><span>    fields</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>a FieldSet</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-core/src/field.rs#L166 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-core/src/field.rs#L166</a><p><code>Field</code>ã¨<code>&dyn Value</code>ã®tupleã®sliceã«ãªã£ã¦ã„ã¾ã™ã€‚<p><code>Value</code>ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªtraitã§ã€visitorã«è‡ªèº«ã‚’è¨˜éŒ²ã™ã‚‹methodã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>pub trait</span><span style=color:#8fbcbb;font-weight:700> Value</span><span style=color:#81a1c1>: crate::</span><span>sealed</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Sealed</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>    /// Visits this value with the given `Visitor`.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> record</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> key</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Field</span><span style=color:#eceff4>,</span><span> visitor</span><span style=color:#81a1c1>: &mut dyn</span><span style=color:#8fbcbb> Visit</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-core/src/field.rs#L335 rel=external>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-core/src/field.rs#L335</a><p>ãã—ã¦ã€ã“ã®<code>Visit</code>ã®å®Ÿè£…ã¯<code>DefaultVisitor</code>ã¨ã—ã¦æä¾›ã•ã‚Œã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> tracing_core</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span>    field</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#81a1c1>self</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Field</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Visit</span><span style=color:#eceff4>},</span></span>
<span class=giallo-l><span style=color:#eceff4>};</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>// ...</span></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>></span><span> field</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Visit</span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> DefaultVisitor</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>> { }</span></span></code></pre><p>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/fmt/format/mod.rs#L1222<p>è©¦ã—ã«ã“ã®å‡¦ç†ã«ä»¥ä¸‹ã®ã‚ˆã†ã«ğŸ¦€ã‚’å‡ºåŠ›ã™ã‚‹å‡¦ç†ã‚’å…¥ã‚Œã¦ã¿ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> DefaultVisitor</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> record_debug</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> field</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Field</span><span style=color:#eceff4>,</span><span> value</span><span style=color:#81a1c1>: &dyn</span><span> fmt</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Debug</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if self.</span><span>result</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>is_err</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            return</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span style=color:#88c0d0>maybe_pad</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#616e88>        // ğŸ‘‡ğŸ‘‡</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>        write!</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span>writer</span><span style=color:#eceff4>, "</span><span style=color:#a3be8c>ğŸ¦€</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span>        </span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>result </span><span style=color:#81a1c1>= match</span><span> field</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>name</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#eceff4>            "</span><span style=color:#a3be8c>message</span><span style=color:#eceff4>"</span><span style=color:#81a1c1> =></span><span style=color:#88c0d0;font-weight:700> write!</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span>writer</span><span style=color:#eceff4>, "</span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>:?</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>",</span><span> value</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#616e88>            // Skip fields that are actually log metadata that have already been handled</span></span>
<span class=giallo-l><span style=color:#5e81ac>            #[cfg(feature = "</span><span style=color:#a3be8c>tracing-log</span><span style=color:#5e81ac>")]</span></span>
<span class=giallo-l><span>            name</span><span style=color:#81a1c1> if</span><span> name</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>starts_with</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>log.</span><span style=color:#eceff4>")</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>(()),</span></span>
<span class=giallo-l><span>            name</span><span style=color:#81a1c1> if</span><span> name</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>starts_with</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>r#</span><span style=color:#eceff4>")</span><span style=color:#81a1c1> =></span><span style=color:#88c0d0;font-weight:700> write!</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span>writer</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>                "</span><span style=color:#ebcb8b>{}{}{</span><span style=color:#a3be8c>:?</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span>writer</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>italic</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>paint</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>name</span><span style=color:#eceff4>[</span><span style=color:#b48ead>2</span><span style=color:#81a1c1>..</span><span style=color:#eceff4>]),</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span>writer</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>dimmed</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>paint</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>=</span><span style=color:#eceff4>"),</span></span>
<span class=giallo-l><span>                value</span></span>
<span class=giallo-l><span style=color:#eceff4>            ),</span></span>
<span class=giallo-l><span>            name</span><span style=color:#81a1c1> =></span><span style=color:#88c0d0;font-weight:700> write!</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span>writer</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>                "</span><span style=color:#ebcb8b>{}{}{</span><span style=color:#a3be8c>:?</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span>writer</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>italic</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>paint</span><span style=color:#eceff4>(</span><span>name</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span>writer</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>dimmed</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>paint</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>=</span><span style=color:#eceff4>"),</span></span>
<span class=giallo-l><span>                value</span></span>
<span class=giallo-l><span style=color:#eceff4>            ),</span></span>
<span class=giallo-l><span style=color:#eceff4>        };</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã“ã®ã‚ãŸã‚Šã¯<a href=https://burgers.io/custom-logging-in-rust-using-tracing rel=external>Custom Logging in Rust Using tracing and tracing-subscriber</a>ã¨ã„ã†ãƒ–ãƒ­ã‚°ã®èª¬æ˜ãŒã‚ã‹ã‚Šã‚„ã™ã„ã®ã§ãŠã™ã™ã‚ã§ã™ã€‚<p>ã™ã‚‹ã¨loggingã«ã‚‚ğŸ¦€ãŒå‡ºåŠ›ã•ã‚Œã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>2022-11-18T13:21:33.092617Z</span><span style=color:#a3be8c>  INFO span_1{ğŸ¦€key=</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>hello</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>}: tracing_handson: ğŸ¦€hello</span></span></code></pre><p>spanã¨eventä¸¡æ–¹ã«ğŸ¦€ãŒã„ã‚‹ã®ã§ã€fieldã®formatå‡¦ç†ãŒå…±é€šåŒ–ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚‚ã‚ã‹ã‚Šã¾ã™ã€‚<h2 id=rogunofiltering><a aria-label="Anchor link for: rogunofiltering" class=zola-anchor href=#rogunofiltering>ãƒ­ã‚°ã®filtering</a></h2><p>å®Ÿéš›ã®å‡¦ç†ã®é †ç•ªã¨ã¯å‰å¾Œã—ã¦ã—ã¾ã„ã¾ã™ãŒã€æœ€å¾Œã«ãƒ­ã‚°ã®filteringå‡¦ç†ã‚’ã¿ã¦ã„ãã¾ã™ã€‚<code>info!()</code>macroå±•é–‹å¾Œã®ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>    use ::</span><span>tracing</span><span style=color:#81a1c1>::</span><span>__macro_support</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Callsite</span><span style=color:#81a1c1> as</span><span> _</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    static</span><span> CALLSITE</span><span style=color:#81a1c1>: ::</span><span>tracing</span><span style=color:#81a1c1>::</span><span>callsite</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>DefaultCallsite</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span><span style=color:#616e88>/* ... */</span><span style=color:#eceff4> };</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> enabled</span><span style=color:#81a1c1> = ::</span><span>tracing</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Level</span><span style=color:#81a1c1>::</span><span>INFO</span><span style=color:#81a1c1> &lt;= ::</span><span>tracing</span><span style=color:#81a1c1>::</span><span>level_filters</span><span style=color:#81a1c1>::</span><span>STATIC_MAX_LEVEL</span></span>
<span class=giallo-l><span style=color:#81a1c1>        && ::</span><span>tracing</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Level</span><span style=color:#81a1c1>::</span><span>INFO</span><span style=color:#81a1c1> &lt;= ::</span><span>tracing</span><span style=color:#81a1c1>::</span><span>level_filters</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>LevelFilter</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>current</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>        &&</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let</span><span> interest</span><span style=color:#81a1c1> =</span><span> CALLSITE</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>interest</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>            !</span><span>interest</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>is_never</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>                && ::</span><span>tracing</span><span style=color:#81a1c1>::</span><span>__macro_support</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>__is_enabled</span><span style=color:#eceff4>(</span><span>CALLSITE</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>metadata</span><span style=color:#eceff4>(),</span><span> interest</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>        };</span></span>
<span class=giallo-l><span style=color:#81a1c1>    if</span><span> enabled</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>        // Event dispatch</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span></code></pre><p><code>enabled</code>ã‚’åˆ¤å®šã—ãŸã®ã¡ã€trueã®å ´åˆã®ã¿logging(<code>Event::dispatch()</code>)ã•ã‚Œã¾ã™ã€‚<br> åˆ¤å®šã¯ä»¥ä¸‹ã®æ¡ä»¶ã«ã¤ã„ã¦ãªã•ã‚Œã¾ã™ã€‚<ul><li><code>tracing::level_fiters::STATIC_MAX_LEVEL</code><li><code>tracing::level_filters::LevelFilter::current()</code><li><code>CALLISTE.interest()</code><li><code>tracing::__macro_support::__is_enabled()</code></ul><p>é †ç•ªã«ã¿ã¦ã„ãã¾ã™ã€‚<h3 id=tracing-level-fiters-static-max-level><a aria-label="Anchor link for: tracing-level-fiters-static-max-level" class=zola-anchor href=#tracing-level-fiters-static-max-level><code>tracing::level_fiters::STATIC_MAX_LEVEL</code></a></h3><p>ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚“ã§åˆã‚ã¦çŸ¥ã£ãŸã®ã§ã™ãŒloggingã®verbosityã‚’runtimeã§ãªãcompileæ™‚ã«æŒ‡å®šã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã®åˆ¤å®šã§ã™ã€‚ä»¥ä¸‹ã®ã‚ˆã†ã«featureæŒ‡å®šæ™‚ã«verbosityã‚’æŒ‡å®šã§ãã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=toml><span class=giallo-l><span style=color:#eceff4>[</span><span>dependencies</span><span style=color:#eceff4>]</span></span>
<span class=giallo-l><span>tracing</span><span style=color:#eceff4> = {</span><span> </span></span>
<span class=giallo-l><span>    version</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>0.1</span><span style=color:#eceff4>",</span><span> </span></span>
<span class=giallo-l><span>    features</span><span style=color:#eceff4> = ["</span><span style=color:#a3be8c>max_level_debug</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>release_max_level_warn</span><span style=color:#eceff4>"],</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>å®Ÿè£…æ–¹æ³•ã§ã™ãŒã€<code>cfg_if</code>ãŒä½¿ã‚ã‚Œã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span>cfg_if</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0;font-weight:700>cfg_if!</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    if</span><span style=color:#5e81ac> #[cfg(all(not(debug_assertions), feature = "</span><span style=color:#a3be8c>release_max_level_off</span><span style=color:#5e81ac>"))]</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        const</span><span> MAX_LEVEL</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> LevelFilter</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> LevelFilter</span><span style=color:#81a1c1>::</span><span>OFF</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span><span style=color:#81a1c1> else if</span><span style=color:#5e81ac> #[cfg(all(not(debug_assertions), feature = "</span><span style=color:#a3be8c>release_max_level_error</span><span style=color:#5e81ac>"))]</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        const</span><span> MAX_LEVEL</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> LevelFilter</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> LevelFilter</span><span style=color:#81a1c1>::</span><span>ERROR</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span><span style=color:#81a1c1> else if</span><span style=color:#5e81ac> #[cfg(all(not(debug_assertions), feature = "</span><span style=color:#a3be8c>release_max_level_warn</span><span style=color:#5e81ac>"))]</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        const</span><span> MAX_LEVEL</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> LevelFilter</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> LevelFilter</span><span style=color:#81a1c1>::</span><span>WARN</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span><span style=color:#81a1c1> else if</span><span style=color:#5e81ac> #[cfg(all(not(debug_assertions), feature = "</span><span style=color:#a3be8c>release_max_level_info</span><span style=color:#5e81ac>"))]</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        const</span><span> MAX_LEVEL</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> LevelFilter</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> LevelFilter</span><span style=color:#81a1c1>::</span><span>INFO</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...    </span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        const</span><span> MAX_LEVEL</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> LevelFilter</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> LevelFilter</span><span style=color:#81a1c1>::</span><span>TRACE</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>featureã§ç‰¹å®šã®è¨­å®šå€¤ã‚’æ±ºã‚ã‚‹å®Ÿè£…æ–¹æ³•ã¨ã—ã¦å‚è€ƒã«ãªã‚Šã¾ã—ãŸã€‚<h3 id=tracing-level-filters-levelfilter-current><a aria-label="Anchor link for: tracing-level-filters-levelfilter-current" class=zola-anchor href=#tracing-level-filters-levelfilter-current><code>tracing::level_filters::LevelFilter::current()</code></a></h3><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>static</span><span> MAX_LEVEL</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> AtomicUsize</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> AtomicUsize</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>LevelFilter</span><span style=color:#81a1c1>::</span><span>OFF_USIZE</span><span style=color:#eceff4>);</span></span></code></pre><p>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-core/src/metadata.rs#L246<p>åˆæœŸçŠ¶æ…‹ã§ã¯ã€OFFãªã®ã§å…¨ã¦ã®loggingãŒdisableã«ãªã‚Šã¾ã™ã€‚ã©ã®æ™‚ç‚¹ã§å€¤ãŒã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ã‚‹ã‹ã¨ã„ã†ã¨<code>tracing_subscriber::fmt().init()</code>ã®ä¸­ã§å®Ÿè¡Œã•ã‚Œã‚‹ã€<code>Dispatch::new()</code>ã§ã™<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Dispatch</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> new</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>>(</span><span>subscriber</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> Self</span></span>
<span class=giallo-l><span style=color:#81a1c1>        where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            S</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Subscriber</span><span style=color:#81a1c1> +</span><span style=color:#8fbcbb> Send</span><span style=color:#81a1c1> +</span><span style=color:#8fbcbb> Sync</span><span style=color:#81a1c1> +</span><span style=color:#eceff4> '</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> me</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Dispatch</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            subscriber</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Arc</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>subscriber</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>        };</span></span>
<span class=giallo-l><span>        callsite</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>register_dispatch</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>me</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span>        me</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-core/src/dispatcher.rs#L458<p><code>callsite::register_dispatch()</code>ã®ä¸­ã§<code>Dispatch</code>(=Subscriber)ãŒæ–°è¦ã«ç™»éŒ²ã•ã‚ŒãŸéš›ã®<code>Interest</code>ã®å†è¨ˆç®—ãŒè¡Œã‚ã‚Œã€ãã®éš›ã«<code>LevelFilter::set_max()</code>ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Callsites</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>    /// Rebuild `Interest`s for all callsites in the registry.</span></span>
<span class=giallo-l><span style=color:#616e88>    ///</span></span>
<span class=giallo-l><span style=color:#616e88>    /// This also re-computes the max level hint.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> rebuild_interest</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> dispatchers</span><span style=color:#81a1c1>:</span><span> dispatchers</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Rebuilder</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> max_level</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> LevelFilter</span><span style=color:#81a1c1>::</span><span>OFF</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span>        dispatchers</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>for_each</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>dispatch</span><span style=color:#81a1c1>|</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>            // If the subscriber did not provide a max level hint, assume</span></span>
<span class=giallo-l><span style=color:#616e88>            // that it may enable every level.</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let</span><span> level_hint</span><span style=color:#81a1c1> =</span><span> dispatch</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>max_level_hint</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap_or</span><span style=color:#eceff4>(</span><span>LevelFilter</span><span style=color:#81a1c1>::</span><span>TRACE</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>            if</span><span> level_hint</span><span style=color:#81a1c1> ></span><span> max_level</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                max_level</span><span style=color:#81a1c1> =</span><span> level_hint</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        });</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span style=color:#88c0d0>for_each</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>callsite</span><span style=color:#81a1c1>|</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0>            rebuild_callsite_interest</span><span style=color:#eceff4>(</span><span>callsite</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> &</span><span>dispatchers</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>        });</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        LevelFilter</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>set_max</span><span style=color:#eceff4>(</span><span>max_level</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-core/src/callsite.rs#L425<h3 id=calliste-interest><a aria-label="Anchor link for: calliste-interest" class=zola-anchor href=#calliste-interest><code>CALLISTE.interest()</code></a></h3><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> DefaultCallsite</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    interest</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> AtomicU8</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    registration</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> AtomicU8</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    meta</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>static Metadata</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>    next</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> AtomicPtr</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>Self</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> DefaultCallsite</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> interest</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>static</span><span style=color:#81a1c1> self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Interest</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        match self.</span><span>interest</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>load</span><span style=color:#eceff4>(</span><span>Ordering</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Relaxed</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            Self::</span><span>INTEREST_NEVER</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Interest</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>never</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#81a1c1>            Self::</span><span>INTEREST_SOMETIMES</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Interest</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>sometimes</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#81a1c1>            Self::</span><span>INTEREST_ALWAYS</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Interest</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>always</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>            _</span><span style=color:#81a1c1> => self.</span><span style=color:#88c0d0>register</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-core/src/callsite.rs#L351<p><code>DefaultCallsite::interest()</code>ã¯<code>Interest</code>ã‚’è¿”ã—ã¾ã™ã€‚<br> <code>Interest</code>ã¯<code>Subscriber</code>ã¨å½“è©²callsite(macroå‘¼ã³å‡ºã—)ã®é–¢ä¿‚ã§ã€å‡¦ç†ã®å¯¾è±¡ã¨ã™ã‚‹ã‹ã©ã†ã‹ã®åˆ¤å®šã§ã™ã€‚ä¸Šè¨˜ã®ã‚ˆã†ã«NEVER,SOMETIMES, ALWAYSãŒã‚ã‚Šã¾ã™ã€‚SOMETIMESã¯runtimeæ™‚ã«éƒ½åº¦åˆ¤å®šã™ã‚‹ã“ã¨ã‚’æ„å‘³ã™ã‚‹ã¨ç†è§£ã—ã¦ãŠã‚Šã¾ã™ã€‚çµæœã‚’cacheã—ã¦ãŠã‚Šã€åˆå›ã¯ã€<code>DefaultCallsite::register()</code>ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> DefaultCallsite</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> register</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>static</span><span style=color:#81a1c1> self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Interest</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>        // Attempt to advance the registration state to `REGISTERING`...</span></span>
<span class=giallo-l><span style=color:#81a1c1>        match self.</span><span>registration</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>compare_exchange</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#81a1c1>            Self::</span><span>UNREGISTERED</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>            Self::</span><span>REGISTERING</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            Ordering</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>AcqRel</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            Ordering</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Acquire</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>        ) {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Ok</span><span style=color:#eceff4>(</span><span>_</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>                // Okay, we advanced the state, try to register the callsite.</span></span>
<span class=giallo-l><span style=color:#88c0d0>                rebuild_callsite_interest</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> &</span><span>DISPATCHERS</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>rebuilder</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span>                CALLSITES</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>push_default</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span>registration</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>store</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>Self::</span><span>REGISTERED</span><span style=color:#eceff4>,</span><span> Ordering</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Release</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#616e88>            // Great, the callsite is already registered! Just load its</span></span>
<span class=giallo-l><span style=color:#616e88>            // previous cached interest.</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Err</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>Self::</span><span>REGISTERED</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {}</span></span>
<span class=giallo-l><span style=color:#616e88>            // Someone else is registering...</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Err</span><span style=color:#eceff4>(</span><span>_state</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>                debug_assert_eq!</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>                    _state</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    Self::</span><span>REGISTERING</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>                    "</span><span style=color:#a3be8c>weird callsite registration state</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#eceff4>                );</span></span>
<span class=giallo-l><span style=color:#616e88>                // Just hit `enabled` this time.</span></span>
<span class=giallo-l><span style=color:#81a1c1>                return</span><span style=color:#8fbcbb> Interest</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>sometimes</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        match self.</span><span>interest</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>load</span><span style=color:#eceff4>(</span><span>Ordering</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Relaxed</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            Self::</span><span>INTEREST_NEVER</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Interest</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>never</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#81a1c1>            Self::</span><span>INTEREST_ALWAYS</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Interest</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>always</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>            _</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Interest</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>sometimes</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>AtomicUsize</code>ã§çŠ¶æ…‹ã‚’åˆ¶å¾¡ã—ã¤ã¤ã€åˆå›ã¯<code>rebuild_callsite_interest()</code>ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚<p>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-core/src/callsite.rs#L312<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> rebuild_callsite_interest</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>    callsite</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>static</span><span style=color:#81a1c1> dyn</span><span style=color:#8fbcbb> Callsite</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    dispatchers</span><span style=color:#81a1c1>: &</span><span>dispatchers</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Rebuilder</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> meta</span><span style=color:#81a1c1> =</span><span> callsite</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>metadata</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> interest</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> None</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span>    dispatchers</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>for_each</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>dispatch</span><span style=color:#81a1c1>|</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> this_interest</span><span style=color:#81a1c1> =</span><span> dispatch</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>register_callsite</span><span style=color:#eceff4>(</span><span>meta</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span>        interest</span><span style=color:#81a1c1> = match</span><span> interest</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>take</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            None</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>this_interest</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Some</span><span style=color:#eceff4>(</span><span>that_interest</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>that_interest</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>and</span><span style=color:#eceff4>(</span><span>this_interest</span><span style=color:#eceff4>)),</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    });</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> interest</span><span style=color:#81a1c1> =</span><span> interest</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap_or_else</span><span style=color:#eceff4>(</span><span>Interest</span><span style=color:#81a1c1>::</span><span>never</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span>    callsite</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>set_interest</span><span style=color:#eceff4>(</span><span>interest</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-core/src/callsite.rs#L494<p><code>dispatchers::Rebuilder&lt;_></code>ãŒã‚ã‹ã‚Šã¥ã‚‰ã„ã§ã™ãŒã“ã“ã§ã¯ã€ã“ã‚Œã¾ã§ã¿ã¦ããŸ<code>Dispatch</code>(<code>FmtSubscriber</code>)ãŒå®Ÿä½“ã§ã™ã€‚ãªã®ã§ã€<code>Layered::register_callsite()</code>ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>L</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Subscriber</span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> Layered</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>L</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>    where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        L</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Layer</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        S</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Subscriber</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> register_callsite</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> metadata</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>static Metadata</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Interest</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span style=color:#88c0d0>pick_interest</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span>layer</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>register_callsite</span><span style=color:#eceff4>(</span><span>metadata</span><span style=color:#eceff4>),</span><span style=color:#81a1c1> ||</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            self.</span><span>inner</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>register_callsite</span><span style=color:#eceff4>(</span><span>metadata</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>        })</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/layer/layered.rs#L94<p><code>Layered::pick_interest()</code>ã¯ç¬¬ä¸€å¼•æ•°ã®çµæœã‚’ã†ã‘ã¦ç¬¬äºŒå¼•æ•°ã®closureã‚’å®Ÿè¡Œã™ã‚‹å‡¦ç†ã§ã™ã€‚<br> ã“ã“ã§ã¯innerã«å§”è­²ã™ã‚‹å‰ã«<code>self.layer</code>ã‚’å…ˆã«å‘¼ã³å‡ºã—ã¦ã„ã‚‹ç‚¹ãŒãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚<br> ä¸€ç•ªå¤–å´ã®layerã¯<code>LevelFilter</code>ãªã®ã§ã€<code>LevelFilter::register_callsite()</code>ã‚’è¦‹ã¦ã¿ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Subscriber</span><span style=color:#eceff4>></span><span style=color:#81a1c1> crate::</span><span style=color:#8fbcbb>Layer</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>></span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> LevelFilter</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> register_callsite</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> metadata</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>static Metadata</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Interest</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if self >=</span><span> metadata</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>level</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Interest</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>always</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Interest</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>never</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.16/tracing-subscriber/src/filter/level.rs#L11<p>è‡ªèº«ã®å€¤ã«å¿œã˜ã¦<code>Interest</code>ã‚’è¿”ã—ã¦ã„ã¾ã™ã€‚<br> ã“ã‚Œã§ã‚ˆã†ã‚„ãã€<code>FmtSubscriber</code>ã®å„layerã®å½¹å‰²åˆ†æ‹…ãŒç†è§£ã§ãã¾ã—ãŸã€‚<h3 id=tracing-macro-support-is-enabled><a aria-label="Anchor link for: tracing-macro-support-is-enabled" class=zola-anchor href=#tracing-macro-support-is-enabled><code>tracing::__macro_support::__is_enabled()</code></a></h3><p>ã“ã‚Œã¾ã§ã®åˆ¤å®šã§disableã¨åˆ¤å®šã•ã‚Œãªã‹ã£ãŸå ´åˆã«æœ€çµ‚çš„ã«å®Ÿè¡Œã•ã‚Œã‚‹runtimeã®åˆ¤å®šå‡¦ç†ã§ã™ã€‚<br> é€†ã«ã„ã†ã¨loggingæ¯ã®åˆ¤å®šå‡¦ç†ã‚’ã§ãã‚‹ã ã‘é¿ã‘ã‚‹æ§˜ã«å·¥å¤«ã•ã‚Œã¦ã„ã‚‹ã¨ã„ãˆã¾ã™ã€‚<br> ã‚³ãƒ¼ãƒ‰ã®è©³ç´°ã¯ã“ã“ã§ã¯ã¿ã¾ã›ã‚“ãŒã€å®Ÿè£…ã¯ä»Šã¾ã§ã®å§”è­²ã¨åŒã˜æµã‚Œã§ã™ã€‚<h2 id=matome><a aria-label="Anchor link for: matome" class=zola-anchor href=#matome>ã¾ã¨ã‚</a></h2><p>ã¨ã„ã†ã“ã¨ã§ã€<code>info!()</code>ã™ã‚‹ã¨<code>info_span!()</code>ã®æƒ…å ±ã‚‚ã‚ã‚ã›ã¦loggingã•ã‚Œã‚‹ã¾ã§ã®æµã‚Œã‚’ã¿ã¦ãã¾ã—ãŸã€‚<br> ä»¥ä¸‹ã®ç‚¹ãŒã‚ã‹ã‚Šã€macroã®ãƒ–ãƒ©ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹åº¦ãŒå°‘ã—æ¸›ã£ãŸã®ãŒã†ã‚Œã—ã„ã§ã™ã€‚<ul><li>globalå¤‰æ•°ã«tracingã®instruction(<code>info!()</code>,<code>info_span!()</code>)ã‚’å‡¦ç†ã™ã‚‹<code>Subscriber</code>ã®å®Ÿè£…ãŒä¿æŒã•ã‚Œã¦ã„ã‚‹ã€‚<li><code>tracing_subscriber</code>ã¯<code>Layer</code>ã¨ã„ã†æ¦‚å¿µã§ã€<code>Subscriber</code>ã‚’composableã«ã§ãã‚‹æ©Ÿæ§‹ã‚’æä¾›ã—ã¦ãã‚Œã¦ã„ã‚‹<li><code>tracing_subscriber::fmt::Subscriber(FmtSubscriber)</code>ã®å®Ÿä½“ã¯<code>Layered</code>ã§nestã•ã‚ŒãŸã€<code>LevelFilter </code> + <code>fmt_layer::Layer</code> + <code>Registry</code><li><code>Span</code>ã®ãƒ¡ã‚¿æƒ…å ±ã¨enterã®çŠ¶æ…‹ã¯<code>Registry</code>ã«ã‚ˆã£ã¦ç®¡ç†ã•ã‚Œã¦ã„ã‚‹ <ul><li><code>span::Id</code>ã®å®Ÿè£…ã¯<code>shareded_slab</code>ã®index<li><code>Registry</code>ã¯<code>ThreadLocal&lt;_></code>ã§enterã—ãŸspanã®idã‚’ç®¡ç†ã—ã¦ã„ã‚‹ã®ã§ã€futureã ã¨ã†ã¾ãå‹•ä½œã—ãªã„</ul></ul><p><code>tracing_core</code>,<code>tracing_suscriber</code>ã®å½¹å‰²ãŒãªã‚“ã¨ãªãã‚ã‹ã£ãŸã®ã§ã€<a href=https://github.com/tokio-rs/tracing/tree/tracing-subscriber-0.3.16 rel=external>tracing workspace</a>ã«ã‚ã‚‹ä»–ã®crateã‚‚ç†è§£ã§ãã‚‹ã‚ˆã†ã«èª­ã‚“ã§ã¿ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚</div></article></main><footer class=blog-footer><p>Â© 2026 <a href=https://blog.ymgyt.io> ymgyt </a> | Made with <a href=https://www.getzola.org rel=noopener target=_blank>Zola</a> | <a href=https://github.com/ymgyt/blog>Repository</a> | <a href=https://blog.ymgyt.io/atom.xml target=_blank title=rss> <svg viewbox="0 0 24 24" class=icon fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx=5 cy=19 r=1></circle></svg> </a></footer></div></div>