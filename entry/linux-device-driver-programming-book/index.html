<!doctype html><html lang=ja><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1" name=viewport><link href=https://blog.ymgyt.io/favicon.ico rel=icon sizes=any><link href=https://blog.ymgyt.io/icon.svg rel=icon type=image/svg+xml><link href=https://blog.ymgyt.io/apple-touch-icon.png rel=apple-touch-icon><link href=https://blog.ymgyt.io/manifest.webmanifest rel=manifest><link href=https://blog.ymgyt.io/style.css rel=stylesheet><link href=https://blog.ymgyt.io/atom.xml rel=alternate title=Atom type=application/atom+xml><script src="https://www.googletagmanager.com/gtag/js?id=G-GTB0KMLN90" async></script><script>window.dataLayer = window.dataLayer || [];
	function gtag() {dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-GTB0KMLN90');</script><title>ğŸ§ Linuxãƒ‡ãƒã‚¤ã‚¹ãƒ‰ãƒ©ã‚¤ãƒãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã‚’èª­ã‚“ã æ„Ÿæƒ³ | Happy developing</title><meta content=kernelã®samples/rust/rust_driver_*.rsã‚’èª­ã‚ã‚‹ã‚ˆã†ã«ãªã‚ŠãŸã„ name=description><meta content=summary name=twitter:card><meta content="@YAmaguchixt " name=twitter:site><meta content="ğŸ§ Linuxãƒ‡ãƒã‚¤ã‚¹ãƒ‰ãƒ©ã‚¤ãƒãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã‚’èª­ã‚“ã æ„Ÿæƒ³" name=twitter:title><meta content=kernelã®samples/rust/rust_driver_*.rsã‚’èª­ã‚ã‚‹ã‚ˆã†ã«ãªã‚ŠãŸã„ name=twitter:description><meta content=https://blog.ymgyt.io/images/emoji/penguin.png name=twitter:image><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><body><div class=world><div class=content-container><header class=blog-header-container><div class=blog-logo><a href=https://blog.ymgyt.io>Happy developing</a></div><div class=blog-nav><nav><ul><li><a href=https://blog.ymgyt.io/entry/>Entries</a><li><a href=https://blog.ymgyt.io/tags/>Tags</a><li><a href=https://blog.ymgyt.io/about/>About</a><li><a href=https://github.com/ymgyt> <img alt=Github class=icon src=https://blog.ymgyt.io/images/icon/github.svg> </a><li><a href="https://twitter.com/YAmaguchixt "> <img alt=Twitter class=icon src=https://blog.ymgyt.io/images/icon/twitter.svg> </a></ul></nav></div></header><main class=blog-main><article><header class=entry-header><h1 class=entry-title>ğŸ§ Linuxãƒ‡ãƒã‚¤ã‚¹ãƒ‰ãƒ©ã‚¤ãƒãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã‚’èª­ã‚“ã æ„Ÿæƒ³</h1><div class=entry-meta><p class=entry-meta-item>ğŸ—“ 2026-02-24<p class=entry-meta-item>ğŸ· <span class=tag><a href=https://blog.ymgyt.io/tags/linux/>linux</a></span> <span class=tag><a href=https://blog.ymgyt.io/tags/book/>book</a></span></div></header><aside class=entry-toc><nav><ul class=entry-toc-toplevel-list><li><a href=https://blog.ymgyt.io/entry/linux-device-driver-programming-book/#du-ndaben>èª­ã‚“ã æœ¬</a><li><a href=https://blog.ymgyt.io/entry/linux-device-driver-programming-book/#di-1zhang-linuxdebaisudoraibanogai-yao>ç¬¬1ç«  Linuxãƒ‡ãƒã‚¤ã‚¹ãƒ‰ãƒ©ã‚¤ãƒã®æ¦‚è¦</a><li><a href=https://blog.ymgyt.io/entry/linux-device-driver-programming-book/#di-2zhang-linuxnoraisensu>ç¬¬2ç«  Linuxã®ãƒ©ã‚¤ã‚»ãƒ³ã‚¹</a><li><a href=https://blog.ymgyt.io/entry/linux-device-driver-programming-book/#di-3zhang-debaisudoraibakai-fa-nozhun-bei>ç¬¬3ç«  ãƒ‡ãƒã‚¤ã‚¹ãƒ‰ãƒ©ã‚¤ãƒé–‹ç™ºã®æº–å‚™</a><li><a href=https://blog.ymgyt.io/entry/linux-device-driver-programming-book/#di-4zhang-debaisudoraibakai-fa-nodi-yi-bu>ç¬¬4ç«  ãƒ‡ãƒã‚¤ã‚¹ãƒ‰ãƒ©ã‚¤ãƒé–‹ç™ºã®ç¬¬ä¸€æ­©</a><li><a href=https://blog.ymgyt.io/entry/linux-device-driver-programming-book/#di-5zhang-doraibapuroguramingunoji-chu-zhi-shi>ç¬¬5ç«  ãƒ‰ãƒ©ã‚¤ãƒãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã®åŸºç¤çŸ¥è­˜</a><li><a href=https://blog.ymgyt.io/entry/linux-device-driver-programming-book/#di-6zhang-doraibapuroguramingunoshi-ji>ç¬¬6ç«  ãƒ‰ãƒ©ã‚¤ãƒãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã®å®Ÿéš›</a><li><a href=https://blog.ymgyt.io/entry/linux-device-driver-programming-book/#di-7zhang-hadoueazhi-yu>ç¬¬7ç«  ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢åˆ¶å¾¡</a><li><a href=https://blog.ymgyt.io/entry/linux-device-driver-programming-book/#di-8zhang-memori>ç¬¬8ç«  ãƒ¡ãƒ¢ãƒª</a><li><a href=https://blog.ymgyt.io/entry/linux-device-driver-programming-book/#di-9zhang-taima>ç¬¬9ç«  ã‚¿ã‚¤ãƒ</a><li><a href=https://blog.ymgyt.io/entry/linux-device-driver-programming-book/#di-10zhang-tong-qi-topai-ta>ç¬¬10ç«  åŒæœŸã¨æ’ä»–</a><li><a href=https://blog.ymgyt.io/entry/linux-device-driver-programming-book/#di-11zhang-ge-ip-mi>ç¬¬11ç«  å‰²è¾¼ã¿</a><li><a href=https://blog.ymgyt.io/entry/linux-device-driver-programming-book/#di-12zhang-pci>ç¬¬12ç«  PCI</a><li><a href=https://blog.ymgyt.io/entry/linux-device-driver-programming-book/#di-13zhang-siriarubasu>ç¬¬13ç«  ã‚·ãƒªã‚¢ãƒ«ãƒã‚¹</a><li><a href=https://blog.ymgyt.io/entry/linux-device-driver-programming-book/#di-14zhang-acpi>ç¬¬14ç«  ACPI</a><li><a href=https://blog.ymgyt.io/entry/linux-device-driver-programming-book/#di-15zhang-ipmi>ç¬¬15ç«  IPMI</a><li><a href=https://blog.ymgyt.io/entry/linux-device-driver-programming-book/#di-16zhang-tesutotodebatugu>ç¬¬16ç«  ãƒ†ã‚¹ãƒˆã¨ãƒ‡ãƒãƒƒã‚°</a><li><a href=https://blog.ymgyt.io/entry/linux-device-driver-programming-book/#di-17zhang-doraibashe-ji-toshi-zhuang-noshi-ji>ç¬¬17ç«  ãƒ‰ãƒ©ã‚¤ãƒè¨­è¨ˆã¨å®Ÿè£…ã®å®Ÿéš›</a><li><a href=https://blog.ymgyt.io/entry/linux-device-driver-programming-book/#matome>ã¾ã¨ã‚</a></ul></nav></aside><div class=entry-content><h2 id=du-ndaben><a aria-label="Anchor link for: du-ndaben" class=zola-anchor href=#du-ndaben>èª­ã‚“ã æœ¬</a></h2><a href=https://www.sbcr.jp/product/4797346428/> <figure><div class=fig-images-row><img , alt src=images/lddp.jpg width=50%,></div><figcaption>Linux ãƒ‡ãƒã‚¤ã‚¹ãƒ‰ãƒ©ã‚¤ãƒãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°</figcaption></figure> </a><p>è‘—è€…: å¹³ç”° è±Š<p><a href=https://lwn.net/Archives/ConferenceIndex/#Kernel_Maintainers_Summit-2025 rel=external>Kernel Maintainers Summit 2025</a>ã§Linux kernelã¸ã®Rustå°å…¥ã«ã¤ã„ã¦ã€"experimental" ãªæ‰±ã„ã‚’çµ‚ãˆã¦ã‚ˆã„ã®ã§ã¯ã¨ã„ã†ææ¡ˆãŒã‚ã‚Šã¾ã—ãŸã€‚<blockquote><p>Ojeda returned to his initial question: can the "experimental" status be ended? Torvalds said that, after nearly five years, the time had come.</blockquote><p><a href=https://lwn.net/Articles/1050174/ rel=external>The state of the kernel Rust experiment</a><p>ãã®å¾Œã€<a href=https://github.com/Rust-for-Linux/linux/blob/b8d687c7eeb52d0353ac27c4f71594a2e6aa365f/MAINTAINERS#L22887 rel=external>Rust subsystemã®maintainer</a>ã§ã‚ã‚‰ã‚Œã‚‹ Miguel Ojedaæ°ã«ã‚ˆã‚‹<a href=https://lore.kernel.org/lkml/20251213000042.23072-1-ojeda@kernel.org/ rel=external>[PATCH] rust: conclude the Rust experiment</a>ã§<blockquote><p>But the experiment is done, i.e. Rust is here to stay.</blockquote><p>ã¨ã—ã¦ã€<code>Documentation/rust/index.rst</code>ã‹ã‚‰ã€ <code>The Rust experiment</code> sectionã‚’å‰Šé™¤ã™ã‚‹å¤‰æ›´ãŒææ¡ˆã•ã‚Œã¾ã—ãŸã€‚<p>ã“ã®ã‚ˆã†ãª<a href=https://rust-for-linux.com/ rel=external>Rust for Linux</a>ã®å–ã‚Šçµ„ã¿ã‚’æ©Ÿã«Linux kernelã«ã¤ã„ã¦èª¿ã¹ã¦ã¿ãŸã„ã¨æ€ã†ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚ Rustã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã¨ã—ã¦ã€<a href=https://github.com/Rust-for-Linux/linux/blob/b8d687c7eeb52d0353ac27c4f71594a2e6aa365f/samples/rust/rust_driver_pci.rs rel=external>driverã‚’rustã§æ›¸ãå–ã‚Šçµ„ã¿</a>ãŒã‚ã‚‹ã“ã¨ã‚’çŸ¥ã‚Šã€kernel driverã®è§£èª¬ã‚’æ¢ã—ã¦ã„ã‚‹ä¸­ã§æœ¬æ›¸ã‚’è¦‹ã¤ã‘ã€èª­ã‚“ã§ã¿ã¦ãŠã‚‚ã—ã‚ã‹ã£ãŸã®ã§ã€æ„Ÿæƒ³ã‚’æ›¸ãã¾ã™ã€‚<p>æœ¬æ›¸ãŒå¯¾è±¡ã¨ã—ã¦ã„ã‚‹kernel versionã¯2.6.23.1ã§ã™ãŒã€è¨˜äº‹ä¸­ã®ã‚³ãƒ¼ãƒ‰ã¯6.18.6ã§å‹•ã‹ã—ã¾ã—ãŸã€‚<h2 id=di-1zhang-linuxdebaisudoraibanogai-yao><a aria-label="Anchor link for: di-1zhang-linuxdebaisudoraibanogai-yao" class=zola-anchor href=#di-1zhang-linuxdebaisudoraibanogai-yao>ç¬¬1ç«  Linuxãƒ‡ãƒã‚¤ã‚¹ãƒ‰ãƒ©ã‚¤ãƒã®æ¦‚è¦</a></h2><p>Linux kernelã®ç”Ÿã„ç«‹ã¡ã‚„ã€ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã«ã¤ã„ã¦ã€‚ ã¾ãŸã€ãƒ‡ãƒã‚¤ã‚¹ãƒ‰ãƒ©ã‚¤ãƒã®kernelå†…ã«ãŠã‘ã‚‹ä½ç½®ã¥ã‘ã«ã¤ã„ã¦ã€‚<h2 id=di-2zhang-linuxnoraisensu><a aria-label="Anchor link for: di-2zhang-linuxnoraisensu" class=zola-anchor href=#di-2zhang-linuxnoraisensu>ç¬¬2ç«  Linuxã®ãƒ©ã‚¤ã‚»ãƒ³ã‚¹</a></h2><p>GPLãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚„ãƒ‡ãƒã‚¤ã‚¹ãƒ‰ãƒ©ã‚¤ãƒã®ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã«ã¤ã„ã¦ã€‚ kernel moduleã®<code>MODULE_LICENSE</code> macroã®èª¬æ˜ãŒã‚ã‚Šã¾ã™ã€‚ <a href=https://web.archive.org/web/20070205223210/http://hp.vector.co.jp/authors/VA012337/misc/authdrv.html rel=external>éå»ã®GPLé•åã®äº‹ä¾‹</a>ç­‰ã‚‚ç´¹ä»‹ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚<h2 id=di-3zhang-debaisudoraibakai-fa-nozhun-bei><a aria-label="Anchor link for: di-3zhang-debaisudoraibakai-fa-nozhun-bei" class=zola-anchor href=#di-3zhang-debaisudoraibakai-fa-nozhun-bei>ç¬¬3ç«  ãƒ‡ãƒã‚¤ã‚¹ãƒ‰ãƒ©ã‚¤ãƒé–‹ç™ºã®æº–å‚™</a></h2><p>å®Ÿéš›ã«ãƒ‰ãƒ©ã‚¤ãƒã‚’æ›¸ããŸã‚ã®ç’°å¢ƒæ§‹ç¯‰æ–¹æ³•ã«ã¤ã„ã¦ã€‚ è‡ªåˆ†ã¯NixOSã‚’ä½¿ã£ã¦ã„ã‚‹ã®ã§ä»¥ä¸‹ã®ã‚ˆã†ãªNixOS moduleã‚’æº–å‚™ã—ã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=nix><span class=giallo-l><span style=color:#eceff4>{</span><span> pkgs</span><span style=color:#81a1c1>,</span><span> config</span><span style=color:#81a1c1>, ...</span><span style=color:#eceff4> }:</span></span>
<span class=giallo-l><span style=color:#81a1c1>let</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  kernel</span><span style=color:#81a1c1> =</span><span> config</span><span style=color:#81a1c1>.</span><span>boot</span><span style=color:#81a1c1>.</span><span>kernelPackages</span><span style=color:#81a1c1>.</span><span>kernel</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>in</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  environment</span><span>.</span><span style=color:#8fbcbb>systemPackages</span><span style=color:#81a1c1> = with</span><span> pkgs;</span><span style=color:#eceff4> [</span></span>
<span class=giallo-l><span>    kernel</span><span style=color:#81a1c1>.</span><span>dev</span></span>
<span class=giallo-l><span style=color:#eceff4>  ]</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  environment</span><span>.</span><span style=color:#8fbcbb>variables</span><span>.</span><span style=color:#8fbcbb>KDIR</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#81a1c1>${</span><span>kernel</span><span style=color:#81a1c1>.</span><span>dev</span><span style=color:#81a1c1>}</span><span style=color:#a3be8c>/lib/modules/</span><span style=color:#81a1c1>${</span><span>kernel</span><span style=color:#81a1c1>.</span><span>modDirVersion</span><span style=color:#81a1c1>}</span><span style=color:#a3be8c>/build</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã“ã†ã™ã‚‹ã¨å®Ÿè¡Œä¸­ã®kernel versionã«å¯¾å¿œã—ãŸã€module buildç”¨ã®fileãŒæƒã†ã®ã§ã€kernelè‡ªä½“ã‚’buildã›ãšã«æ¸ˆã¿ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>cd</span><span> $env</span><span style=color:#a3be8c>.KDIR</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>pwd</span></span>
<span class=giallo-l><span style=color:#88c0d0>/nix/store/cbc470bffdhc9wg1bgk54i6a3s5a1ygq-linux-6.18.6-dev/lib/modules/6.18.6/build</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>uname</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> get</span><span style=color:#a3be8c> kernel-release</span></span>
<span class=giallo-l><span style=color:#88c0d0>6.18.6</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>ls</span></span>
<span class=giallo-l><span style=color:#616e88> # |      name      |  type   |  size  |   modified</span></span>
<span class=giallo-l><span style=color:#88c0d0>---+----------------+---------+--------+--------------</span></span>
<span class=giallo-l><span style=color:#88c0d0> 0</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> Makefile</span><span style=color:#81a1c1>       |</span><span style=color:#88c0d0> file</span><span style=color:#81a1c1>    |</span><span style=color:#88c0d0>  350</span><span style=color:#a3be8c> B</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> 56</span><span style=color:#a3be8c> years ago</span></span>
<span class=giallo-l><span style=color:#88c0d0> 1</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> Module.symvers</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> file</span><span style=color:#81a1c1>    |</span><span style=color:#88c0d0> 2.3</span><span style=color:#a3be8c> MB</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> 56</span><span style=color:#a3be8c> years ago</span></span>
<span class=giallo-l><span style=color:#88c0d0> 2</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> arch</span><span style=color:#81a1c1>           |</span><span style=color:#88c0d0> dir</span><span style=color:#81a1c1>     |</span><span style=color:#88c0d0> 4.0</span><span style=color:#a3be8c> kB</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> 56</span><span style=color:#a3be8c> years ago</span></span>
<span class=giallo-l><span style=color:#88c0d0> 3</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> include</span><span style=color:#81a1c1>        |</span><span style=color:#88c0d0> dir</span><span style=color:#81a1c1>     |</span><span style=color:#88c0d0> 4.0</span><span style=color:#a3be8c> kB</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> 56</span><span style=color:#a3be8c> years ago</span></span>
<span class=giallo-l><span style=color:#88c0d0> 4</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> kernel</span><span style=color:#81a1c1>         |</span><span style=color:#88c0d0> dir</span><span style=color:#81a1c1>     |</span><span style=color:#88c0d0> 4.0</span><span style=color:#a3be8c> kB</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> 56</span><span style=color:#a3be8c> years ago</span></span>
<span class=giallo-l><span style=color:#88c0d0> 5</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> rust</span><span style=color:#81a1c1>           |</span><span style=color:#88c0d0> dir</span><span style=color:#81a1c1>     |</span><span style=color:#88c0d0> 4.0</span><span style=color:#a3be8c> kB</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> 56</span><span style=color:#a3be8c> years ago</span></span>
<span class=giallo-l><span style=color:#88c0d0> 6</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> scripts</span><span style=color:#81a1c1>        |</span><span style=color:#88c0d0> dir</span><span style=color:#81a1c1>     |</span><span style=color:#88c0d0> 4.0</span><span style=color:#a3be8c> kB</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> 56</span><span style=color:#a3be8c> years ago</span></span>
<span class=giallo-l><span style=color:#88c0d0> 7</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> source</span><span style=color:#81a1c1>         |</span><span style=color:#88c0d0> symlink</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0>    9</span><span style=color:#a3be8c> B</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> 56</span><span style=color:#a3be8c> years ago</span></span>
<span class=giallo-l><span style=color:#88c0d0> 8</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> tools</span><span style=color:#81a1c1>          |</span><span style=color:#88c0d0> dir</span><span style=color:#81a1c1>     |</span><span style=color:#88c0d0> 4.0</span><span style=color:#a3be8c> kB</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> 56</span><span style=color:#a3be8c> years ago</span><span>  </span></span></code></pre><h2 id=di-4zhang-debaisudoraibakai-fa-nodi-yi-bu><a aria-label="Anchor link for: di-4zhang-debaisudoraibakai-fa-nodi-yi-bu" class=zola-anchor href=#di-4zhang-debaisudoraibakai-fa-nodi-yi-bu>ç¬¬4ç«  ãƒ‡ãƒã‚¤ã‚¹ãƒ‰ãƒ©ã‚¤ãƒé–‹ç™ºã®ç¬¬ä¸€æ­©</a></h2><p>æœ¬ç« ã‹ã‚‰ã„ã‚ˆã„ã‚ˆãƒ‰ãƒ©ã‚¤ãƒé–‹ç™ºãŒã¯ã˜ã¾ã‚Šã¾ã™ã€‚ ãƒ­ã‚°å‡ºåŠ›ã ã‘ã‚’è¡Œã†ãƒ‰ãƒ©ã‚¤ãƒã€<code>hello</code><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=c><span class=giallo-l><span style=color:#5e81ac;font-weight:700>#</span><span style=color:#81a1c1>include</span><span style=color:#eceff4> &lt;</span><span style=color:#8fbcbb>linux/module.h</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#5e81ac;font-weight:700>#</span><span style=color:#81a1c1>include</span><span style=color:#eceff4> &lt;</span><span style=color:#8fbcbb>linux/kernel.h</span><span style=color:#eceff4>></span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>static int</span><span> __init </span><span style=color:#88c0d0>hello_init</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>void</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#88c0d0>  pr_info</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>hello: loaded</span><span style=color:#ebcb8b>\n</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>  return</span><span style=color:#b48ead> 0</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>static void</span><span> __exit </span><span style=color:#88c0d0>hello_exit</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>void</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#88c0d0>  pr_info</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>hello: unloaded</span><span style=color:#ebcb8b>\n</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>module_init</span><span style=color:#eceff4>(</span><span>hello_init</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#88c0d0>module_exit</span><span style=color:#eceff4>(</span><span>hello_exit</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>MODULE_LICENSE</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>GPL</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#88c0d0>MODULE_AUTHOR</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>ymgyt</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#88c0d0>MODULE_DESCRIPTION</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>hello module</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span></code></pre><p>Makefile<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=make><span class=giallo-l><span>obj-m</span><span style=color:#eceff4> :=</span><span> hello.o</span></span>
<span class=giallo-l><span>PWD</span><span style=color:#eceff4> :=</span><span style=color:#81a1c1> $(</span><span style=color:#88c0d0>shell</span><span style=color:#a3be8c> pwd</span><span style=color:#81a1c1>)</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>modules</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#81a1c1>	$(MAKE)</span><span> -C </span><span style=color:#81a1c1>$(</span><span>KDIR</span><span style=color:#81a1c1>)</span><span> M=</span><span style=color:#81a1c1>$(</span><span>PWD</span><span style=color:#81a1c1>)</span><span> modules</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>clean</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#81a1c1>	$(MAKE)</span><span> -C </span><span style=color:#81a1c1>$(</span><span>KDIR</span><span style=color:#81a1c1>)</span><span> M=</span><span style=color:#81a1c1>$(</span><span>PWD</span><span style=color:#81a1c1>)</span><span> clean</span></span></code></pre><p><code>make modules</code>ã§buildã—ã¦ã¿ã‚‹ã¨<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>make</span><span style=color:#a3be8c> modules</span></span>
<span class=giallo-l><span style=color:#88c0d0>/nix/store/mkm3my2067305hdh7rzmi10npwr7y17f-gnumake-4.4.1/bin/make</span><span style=color:#a3be8c> -C /nix/store/cbc470bffdhc9wg1bgk54i6a3s5a1ygq-linux-6.18.6-dev/lib/modules/6.18.6/build M=/home/ymgyt/rs/drivers/hello modules</span></span>
<span class=giallo-l><span style=color:#88c0d0>make[1]:</span><span style=color:#a3be8c> Entering directory</span><span style=color:#eceff4> '</span><span style=color:#a3be8c>/nix/store/cbc470bffdhc9wg1bgk54i6a3s5a1ygq-linux-6.18.6-dev/lib/modules/6.18.6/build</span><span style=color:#eceff4>'</span></span>
<span class=giallo-l><span style=color:#88c0d0>make[2]:</span><span style=color:#a3be8c> Entering directory</span><span style=color:#eceff4> '</span><span style=color:#a3be8c>/home/ymgyt/rs/drivers/hello</span><span style=color:#eceff4>'</span></span>
<span class=giallo-l><span style=color:#88c0d0>  CC</span><span> [M]  hello.o</span></span>
<span class=giallo-l><span style=color:#88c0d0>  MODPOST</span><span style=color:#a3be8c> Module.symvers</span></span>
<span class=giallo-l><span style=color:#88c0d0>  CC</span><span> [M]  hello.mod.o</span></span>
<span class=giallo-l><span style=color:#88c0d0>  CC</span><span> [M]  .module-common.o</span></span>
<span class=giallo-l><span style=color:#88c0d0>  LD</span><span> [M]  hello.ko</span></span>
<span class=giallo-l><span style=color:#88c0d0>  BTF</span><span> [M] hello.ko</span></span>
<span class=giallo-l><span style=color:#88c0d0>Skipping</span><span style=color:#a3be8c> BTF generation for hello.ko due to unavailability of vmlinux</span></span>
<span class=giallo-l><span style=color:#88c0d0>make[2]:</span><span style=color:#a3be8c> Leaving directory</span><span style=color:#eceff4> '</span><span style=color:#a3be8c>/home/ymgyt/rs/drivers/hello</span><span style=color:#eceff4>'</span></span>
<span class=giallo-l><span style=color:#88c0d0>make[1]:</span><span style=color:#a3be8c> Leaving directory</span><span style=color:#eceff4> '</span><span style=color:#a3be8c>/nix/store/cbc470bffdhc9wg1bgk54i6a3s5a1ygq-linux-6.18.6-dev/lib/modules/6.18.6/build</span><span style=color:#eceff4>'</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>ls</span></span>
<span class=giallo-l><span style=color:#616e88> # |      name      | type |   size   |    modified</span></span>
<span class=giallo-l><span style=color:#88c0d0>---+----------------+------+----------+----------------</span></span>
<span class=giallo-l><span style=color:#88c0d0> 0</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> Makefile</span><span style=color:#81a1c1>       |</span><span style=color:#88c0d0> file</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0>    262</span><span style=color:#a3be8c> B</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> 3</span><span style=color:#a3be8c> weeks ago</span></span>
<span class=giallo-l><span style=color:#88c0d0> 1</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> Module.symvers</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> file</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0>      0</span><span style=color:#a3be8c> B</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> 19</span><span style=color:#a3be8c> seconds ago</span></span>
<span class=giallo-l><span style=color:#88c0d0> 2</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> hello.c</span><span style=color:#81a1c1>        |</span><span style=color:#88c0d0> file</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0>    342</span><span style=color:#a3be8c> B</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> 3</span><span style=color:#a3be8c> weeks ago</span></span>
<span class=giallo-l><span style=color:#88c0d0> 3</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> hello.ko</span><span style=color:#81a1c1>       |</span><span style=color:#88c0d0> file</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> 179.6</span><span style=color:#a3be8c> kB</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> 18</span><span style=color:#a3be8c> seconds ago</span></span>
<span class=giallo-l><span style=color:#88c0d0> 4</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> hello.mod</span><span style=color:#81a1c1>      |</span><span style=color:#88c0d0> file</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0>     10</span><span style=color:#a3be8c> B</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> 19</span><span style=color:#a3be8c> seconds ago</span></span>
<span class=giallo-l><span style=color:#88c0d0> 5</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> hello.mod.c</span><span style=color:#81a1c1>    |</span><span style=color:#88c0d0> file</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0>    373</span><span style=color:#a3be8c> B</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> 19</span><span style=color:#a3be8c> seconds ago</span></span>
<span class=giallo-l><span style=color:#88c0d0> 6</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> hello.mod.o</span><span style=color:#81a1c1>    |</span><span style=color:#88c0d0> file</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> 106.5</span><span style=color:#a3be8c> kB</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> 18</span><span style=color:#a3be8c> seconds ago</span></span>
<span class=giallo-l><span style=color:#88c0d0> 7</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> hello.o</span><span style=color:#81a1c1>        |</span><span style=color:#88c0d0> file</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0>  14.0</span><span style=color:#a3be8c> kB</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> 19</span><span style=color:#a3be8c> seconds ago</span></span>
<span class=giallo-l><span style=color:#88c0d0> 8</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> modules.order</span><span style=color:#81a1c1>  |</span><span style=color:#88c0d0> file</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0>      8</span><span style=color:#a3be8c> B</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> 19</span><span style=color:#a3be8c> seconds ago</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>file</span><span style=color:#a3be8c> hello.ko</span></span>
<span class=giallo-l><span style=color:#88c0d0>hello.ko:</span><span style=color:#a3be8c> ELF 64-bit LSB relocatable, x86-64, version</span><span style=color:#b48ead> 1</span><span> (SYSV), BuildID</span><span style=color:#eceff4>[</span><span>sha1</span><span style=color:#eceff4>]</span><span style=color:#81a1c1>=</span><span style=color:#a3be8c>e328d799fd4e7da7538d9b81b324aac66b6ca788,</span><span style=color:#88c0d0> with</span><span style=color:#a3be8c> debug_info, not stripped</span><span>  </span></span></code></pre><p>ç„¡äº‹ã€<code>hello.ko</code> ELFãŒç”Ÿæˆã§ãã¾ã—ãŸã€‚<p><code>modinfo</code>ã—ã¦ã¿ã‚‹ã¨ã€<code>MODULE_</code> ãƒã‚¯ãƒ­ã®å†…å®¹ãŒåæ˜ ã—ã¦ã„ã‚‹ã“ã¨ãŒç¢ºã‹ã‚ã‚‰ã‚Œã¾ã™<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>modinfo</span><span style=color:#a3be8c> hello.ko</span></span>
<span class=giallo-l><span style=color:#88c0d0>filename:</span><span style=color:#a3be8c>       /home/ymgyt/rs/drivers/hello/hello.ko</span></span>
<span class=giallo-l><span style=color:#88c0d0>description:</span><span style=color:#a3be8c>    hello module</span></span>
<span class=giallo-l><span style=color:#88c0d0>author:</span><span style=color:#a3be8c>         ymgyt</span></span>
<span class=giallo-l><span style=color:#88c0d0>license:</span><span style=color:#a3be8c>        GPL</span></span>
<span class=giallo-l><span style=color:#88c0d0>depends:</span></span>
<span class=giallo-l><span style=color:#88c0d0>name:</span><span style=color:#a3be8c>           hello</span></span>
<span class=giallo-l><span style=color:#88c0d0>retpoline:</span><span style=color:#a3be8c>      Y</span></span>
<span class=giallo-l><span style=color:#88c0d0>vermagic:</span><span style=color:#b48ead>       6.18.6</span><span style=color:#a3be8c> SMP preempt mod_unload</span><span>  </span></span></code></pre><p>ã¡ãªã¿ã«rustã ã¨ã€kernel crateã«driverã®ç¨®åˆ¥ã”ã¨ã«macroãŒç”¨æ„ã—ã¦ã‚ã‚Šã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¦moduleã®metadataã‚’å®šç¾©ã§ãã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span>kernel</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0;font-weight:700>module_usb_driver!</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type:</span><span style=color:#8fbcbb> SampleDriver</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    name</span><span style=color:#81a1c1>:</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>rust_driver_usb</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span>    authors</span><span style=color:#81a1c1>:</span><span style=color:#eceff4> ["</span><span style=color:#a3be8c>Daniel Almeida</span><span style=color:#eceff4>"],</span></span>
<span class=giallo-l><span>    description</span><span style=color:#81a1c1>:</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>Rust USB driver sample</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span>    license</span><span style=color:#81a1c1>:</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>GPL v2</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ä½œæˆã—ãŸãƒ‰ãƒ©ã‚¤ãƒã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã«ã¯ã€<code>insmod</code>ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>sudo</span><span style=color:#a3be8c> insmod hello.ko</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>sudo</span><span style=color:#a3be8c> dmesg</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> tail</span><span style=color:#a3be8c> -n</span><span style=color:#b48ead> 10</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> rg</span><span style=color:#a3be8c> hello</span></span>
<span class=giallo-l><span style=color:#eceff4>[</span><span>883897.532805</span><span style=color:#eceff4>]</span><span> hello: loaded</span></span></code></pre><p>ç„¡äº‹ãƒ­ã‚°ã‚’ç¢ºèªã§ãã¾ã—ãŸã€‚<p>ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ‰ãƒ©ã‚¤ãƒã‚’ã‚¢ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã«ã¯<code>rmmod</code>ã‚’ä½¿ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>sudo</span><span style=color:#a3be8c> rmmod hello</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>sudo</span><span style=color:#a3be8c> dmesg</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> tail</span><span style=color:#a3be8c> -n</span><span style=color:#b48ead> 10</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> rg</span><span style=color:#a3be8c> hello</span></span>
<span class=giallo-l><span style=color:#eceff4>[</span><span>883897.532805</span><span style=color:#eceff4>]</span><span> hello: loaded</span></span>
<span class=giallo-l><span style=color:#eceff4>[</span><span>883981.712000</span><span style=color:#eceff4>]</span><span> hello: unloaded</span></span></code></pre><p>ã¨ã„ã†ã“ã¨ã§ãƒ‰ãƒ©ã‚¤ãƒã®ãƒãƒ­ãƒ¼ãƒ¯ãƒ¼ãƒ«ãƒ‰ãŒã§ãã¾ã—ãŸã€‚ æ¬¡ã«ã€é–¢æ•°ã‚’å®šç¾©ã—ã¦ã„ã‚‹headerã«jumpã§ãã‚‹ã¨ä¾¿åˆ©ãªã®ã§code jumpã®è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚ è‡ªåˆ†ã¯clangd lang serverã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ã®ã§<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>bear</span><span style=color:#a3be8c> --append --output -- make -C</span><span> $KDIR</span><span style=color:#a3be8c> M=</span><span style=color:#eceff4>$(</span><span style=color:#88c0d0>pwd</span><span style=color:#eceff4>)</span><span style=color:#a3be8c> HOSTCC=cc modules</span></span></code></pre><p>ã‚’å®Ÿè¡Œã—ã¦ã€<code>compile_commands.json</code>ã‚’ç”Ÿæˆã—ã¾ã—ãŸã€‚ ã¡ãªã¿ã«Rustã®å ´åˆã¯ã€kernelã®make targetã«<code>rust-analyzer</code>ãŒã‚ã‚Šã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>make</span><span style=color:#a3be8c> help</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> rg</span><span style=color:#a3be8c> rust-analyzer</span></span>
<span class=giallo-l><span style=color:#88c0d0>  rust-analyzer</span><span style=color:#a3be8c>   - Generate rust-project.json rust-analyzer support file</span></span></code></pre><p>æ¬¡ã«ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã«ã¤ã„ã¦ã®è§£èª¬ãŒã‚ã‚Šã¾ã™ã€‚ <code>insmod</code>æ™‚ã«å‘¼ã°ã‚Œã‚‹ã€<code>module_init</code>, <code>rmmod</code>æ™‚ã®<code>module_exit</code>ã ã‘ã§ãªãã€systemcall(open, close, ioctl, epoll, ...)æ™‚ã®handler, å‰²è¾¼ã¿,timerã‹ã‚‰ãƒ‡ãƒã‚¤ã‚¹ã®å‡¦ç†ãŒå‘¼ã°ã‚Œã¾ã™ã€‚<h2 id=di-5zhang-doraibapuroguramingunoji-chu-zhi-shi><a aria-label="Anchor link for: di-5zhang-doraibapuroguramingunoji-chu-zhi-shi" class=zola-anchor href=#di-5zhang-doraibapuroguramingunoji-chu-zhi-shi>ç¬¬5ç«  ãƒ‰ãƒ©ã‚¤ãƒãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã®åŸºç¤çŸ¥è­˜</a></h2><p>ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®æ¦‚å¿µãŒèª¬æ˜ã•ã‚Œã¾ã™ã€‚ ãƒ—ãƒ­ã‚»ã‚¹èµ·å› ã§å‘¼ã°ã‚Œã‚‹ã‹ã€å‰²è¾¼ã¿èµ·å› ã§å‘¼ã°ã‚Œã‚‹ã‹ã«ã‚ˆã£ã¦ã€ãƒ—ãƒ­ã‚»ã‚¹ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¨å‰²è¾¼ã¿ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«åˆ†é¡ã•ã‚Œã¾ã™ã€‚<p>ãƒ—ãƒ­ã‚»ã‚¹ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§ã¯ã€global å¤‰æ•°ã€<code>current</code> ã‹ã‚‰ç¾åœ¨å®Ÿè¡Œä¸­ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’è¡¨ã™<a href=https://github.com/Rust-for-Linux/linux/blob/b8d687c7eeb52d0353ac27c4f71594a2e6aa365f/include/linux/sched.h#L819 rel=external><code>task_struct</code></a>ã®å‚ç…§ãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚<p>ãƒ‰ãƒ©ã‚¤ãƒç‰¹æœ‰ã®è©±ã§ã¯ãªã„ã§ã™ãŒã€<code>int</code>ã‚„<code>long</code>ã¨ã„ã£ãŸãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«ã€ã‚¨ãƒ³ãƒ‡ã‚£ã‚¢ãƒ³ã€ã‚¢ãƒ©ã‚¤ãƒ³ãƒ¡ãƒ³ãƒˆã®è§£èª¬ã‚‚ã‚ã‚Šã¾ã™ã€‚<p>ãã—ã¦ã€æœ¬ç« ã§ã¯readã™ã‚‹ã¨1ã‚’è¿”ã™ã€devoneãƒ‰ãƒ©ã‚¤ãƒã‚’ä½œã£ã¦ã„ãã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>hexyl</span><span style=color:#a3be8c> -n</span><span style=color:#b48ead> 32</span><span style=color:#a3be8c> -v  /dev/devone0</span></span>
<span class=giallo-l><span style=color:#88c0d0>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span>
<span class=giallo-l><span style=color:#88c0d0>â”‚00000000â”‚</span><span style=color:#a3be8c> ff ff ff ff ff ff ff ff â”Š ff ff ff ff ff ff ff ff â”‚Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—â”ŠÃ—Ã—Ã—Ã—Ã—Ã—Ã—Ã—â”‚</span></span>
<span class=giallo-l><span style=color:#88c0d0>â”‚00000010â”‚</span><span style=color:#a3be8c> ff ff ff ff ff ff ff ff â”Š ff ff ff ff ff ff ff ff â”‚Ã—Ã—Ã—Ã—Ã—Ã—Ã—Ã—â”ŠÃ—Ã—Ã—Ã—Ã—Ã—Ã—Ã—â”‚</span></span>
<span class=giallo-l><span style=color:#88c0d0>â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span></code></pre><p>ã•ã£ããinitå‡¦ç†ã‹ã‚‰ã¿ã¦ã„ãã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=c><span class=giallo-l><span style=color:#81a1c1>static int</span><span> devone_major </span><span style=color:#81a1c1>=</span><span style=color:#b48ead> 0</span><span style=color:#81a1c1>;</span><span style=color:#616e88> /* dynamic allocation */</span></span>
<span class=giallo-l><span style=color:#81a1c1>static int</span><span> devone_minor </span><span style=color:#81a1c1>=</span><span style=color:#b48ead> 0</span><span style=color:#81a1c1>;</span><span style=color:#616e88> /* static allocation */</span></span>
<span class=giallo-l><span style=color:#81a1c1>static int</span><span> devone_devs </span><span style=color:#81a1c1>=</span><span style=color:#b48ead> 1</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>static int</span><span> __init </span><span style=color:#88c0d0>devone_init</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>void</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>  dev_t</span><span> dev </span><span style=color:#81a1c1>=</span><span style=color:#88c0d0> MKDEV</span><span style=color:#eceff4>(</span><span>devone_major</span><span style=color:#eceff4>,</span><span> devone_minor</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>  int</span><span> ret</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>  ret </span><span style=color:#81a1c1>=</span><span style=color:#88c0d0> alloc_chrdev_region</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>dev</span><span style=color:#eceff4>,</span><span style=color:#b48ead> 0</span><span style=color:#eceff4>,</span><span> devone_devs</span><span style=color:#eceff4>,</span><span> DRIVER_NAME</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>  if</span><span style=color:#eceff4> (</span><span>ret</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>    return</span><span> ret</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>  devone_major </span><span style=color:#81a1c1>=</span><span style=color:#88c0d0> MAJOR</span><span style=color:#eceff4>(</span><span>dev</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>  cdev_init</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>devone_cdev</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> &</span><span>devone_fops</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>  devone_cdev</span><span style=color:#eceff4>.</span><span>owner</span><span style=color:#81a1c1> =</span><span> THIS_MODULE</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>  devone_cdev</span><span style=color:#eceff4>.</span><span>ops</span><span style=color:#81a1c1> = &</span><span>devone_fops</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>  devone_class </span><span style=color:#81a1c1>=</span><span style=color:#88c0d0> class_create</span><span style=color:#eceff4>(</span><span>DRIVER_NAME</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>  if</span><span style=color:#eceff4> (</span><span style=color:#88c0d0>IS_ERR</span><span style=color:#eceff4>(</span><span>devone_class</span><span style=color:#eceff4>)) {</span></span>
<span class=giallo-l><span>    ret </span><span style=color:#81a1c1>=</span><span style=color:#88c0d0> PTR_ERR</span><span style=color:#eceff4>(</span><span>devone_class</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>    devone_class </span><span style=color:#81a1c1>= NULL;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    goto</span><span> err_unregister</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>  }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>  devone_device </span><span style=color:#81a1c1>=</span></span>
<span class=giallo-l><span style=color:#88c0d0>      device_create</span><span style=color:#eceff4>(</span><span>devone_class</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> NULL</span><span style=color:#eceff4>,</span><span> dev</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> NULL</span><span style=color:#eceff4>, "</span><span style=color:#a3be8c>devone%d</span><span style=color:#eceff4>",</span><span> devone_minor</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>  if</span><span style=color:#eceff4> (</span><span style=color:#88c0d0>IS_ERR</span><span style=color:#eceff4>(</span><span>devone_device</span><span style=color:#eceff4>)) {</span></span>
<span class=giallo-l><span>    ret </span><span style=color:#81a1c1>=</span><span style=color:#88c0d0> PTR_ERR</span><span style=color:#eceff4>(</span><span>devone_device</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>    devone_device </span><span style=color:#81a1c1>= NULL;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    goto</span><span> err_class</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>  }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>  ret </span><span style=color:#81a1c1>=</span><span style=color:#88c0d0> cdev_add</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>devone_cdev</span><span style=color:#eceff4>,</span><span> dev</span><span style=color:#eceff4>,</span><span> devone_devs</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>  if</span><span style=color:#eceff4> (</span><span>ret</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>    goto</span><span> err_device</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>  printk</span><span style=color:#eceff4>(</span><span>KERN_ALERT </span><span style=color:#eceff4>"</span><span style=color:#a3be8c>%s: driver(major %d) installed</span><span style=color:#ebcb8b>\n</span><span style=color:#eceff4>",</span><span> DRIVER_NAME</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>         devone_major</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>  return</span><span style=color:#b48ead> 0</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>err_device:</span></span>
<span class=giallo-l><span style=color:#88c0d0>  device_destroy</span><span style=color:#eceff4>(</span><span>devone_class</span><span style=color:#eceff4>,</span><span> dev</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>  devone_device </span><span style=color:#81a1c1>= NULL;</span></span>
<span class=giallo-l><span>err_class:</span></span>
<span class=giallo-l><span style=color:#88c0d0>  class_destroy</span><span style=color:#eceff4>(</span><span>devone_class</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>  devone_class </span><span style=color:#81a1c1>= NULL;</span></span>
<span class=giallo-l><span>err_unregister:</span></span>
<span class=giallo-l><span style=color:#88c0d0>  unregister_chrdev_region</span><span style=color:#eceff4>(</span><span>dev</span><span style=color:#eceff4>,</span><span> devone_devs</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>  return</span><span> ret</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>å„ç¨®é–¢æ•°ã‚’å‘¼ã¶ã¨ãªã«ãŒèµ·ãã‚‹ã‹ãŒä¸å¯§ã«è§£èª¬ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€æœ¬æ›¸ã‚’èª­ã‚€ã¨ã“ã®ã‚³ãƒ¼ãƒ‰ãŒèª­ã‚ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ æœ¬æ›¸ã§ã¯ã€<code>class_device_create()</code>é–¢æ•°ãŒä½¿ã‚ã‚Œã¦ã„ãŸã®ã§ã™ãŒã€ä»Šã¯å‰Šé™¤ã•ã‚Œã¦ãŠã‚Šã€ä»£ã‚ã‚Šã«<code>device_create()</code>ã‚’åˆ©ç”¨ã—ã¾ã—ãŸã€‚<p>pointerã‚’è¿”ã™é–¢æ•°ã§ã¯ã€ã‚¨ãƒ©ãƒ¼ã®æƒ…å ±ã‚‚åŒã˜pointerå‹ã§è¡¨ç¾ã™ã‚‹ã®ã§ã€åˆ¤å®šãŠã‚ˆã³ã€ã‚¨ãƒ©ãƒ¼æƒ…å ±ã¸ã®å¤‰æ›ç”¨ã®helperé–¢æ•°ã€<code>IS_ERR()</code>, <code>PTR_ERR()</code>ãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã«é™ã‚‰ãªã„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä¸€èˆ¬ã®è©±ã«ã¤ã„ã¦ã¯ã€<a href=https://www.oreilly.co.jp/books/9784814401109/ rel=external>Linuxã‚«ãƒ¼ãƒãƒ«ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ç¬¬2ç‰ˆ</a>ã®èª¬æ˜ãŒã‚ã‹ã‚Šã‚„ã™ã‹ã£ãŸã§ã™ã€‚<p>ãƒªã‚½ãƒ¼ã‚¹ã®å‰²å½“ã¨åˆæœŸåŒ–ã‚’é †ç•ªã«è¡Œã£ã¦ã„ãã®ã§ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ãƒªã‚½ãƒ¼ã‚¹ã®é–‹æ”¾ã‚’è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã†ã„ã†å‡¦ç†ã¯gotoã®ã»ã†ãŒæ›¸ãã‚„ã™ã„ã“ã¨ãŒã‚ã‹ã‚Šã€gotoã‚‚ã‚ãªãŒã¡æ‚ªã„ã‚‚ã®ã§ã¯ãªã„ã‚“ã ãªã¨æ€ã„ã¾ã—ãŸã€‚(è‡ªåˆ†ã§ã¯çµ¶å¯¾ãƒŸã‚¹ã‚Šãã†ã§ã™ãŒ)<p>ãã—ã¦ã€ä»¥ä¸‹ã®udev ruleã‚’é©ç”¨ã—ã¦ã‹ã‚‰ã€<code>insmod()</code>ã™ã‚‹ã¨ã€<code>/dev/devone0</code>fileã‚’<code>open()</code>ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>cat</span><span style=color:#81a1c1> &lt;&lt;</span><span style=color:#eceff4>EOF</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> sudo</span><span style=color:#a3be8c> tee /run/udev/rules.d/51-devone.rules</span><span style=color:#81a1c1> ></span><span style=color:#a3be8c> /dev/null</span></span>
<span class=giallo-l><span style=color:#a3be8c>KERNEL=="devone[0-9]*", GROUP="root",  MODE="0644"</span></span>
<span class=giallo-l><span style=color:#eceff4>EOF</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>sudo</span><span style=color:#a3be8c> insmod ./devone.ko</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>file</span><span style=color:#a3be8c> /dev/devone0</span></span>
<span class=giallo-l><span style=color:#88c0d0>/dev/devone0:</span><span style=color:#a3be8c> character special</span><span> (236/0)</span></span></code></pre><p>æ¬¡ã«openå‡¦ç†ã‚’å®Ÿè£…ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=c><span class=giallo-l><span style=color:#5e81ac;font-weight:700>#</span><span style=color:#81a1c1>include</span><span style=color:#eceff4> &lt;</span><span style=color:#8fbcbb>linux/fs.h</span><span style=color:#eceff4>></span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>static int</span><span style=color:#88c0d0> devone_open</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>struct</span><span> inode </span><span style=color:#81a1c1>*</span><span>inode</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> struct</span><span> file </span><span style=color:#81a1c1>*</span><span>file</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>  struct</span><span> devone_data </span><span style=color:#81a1c1>*</span><span>p</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>  p </span><span style=color:#81a1c1>=</span><span style=color:#88c0d0> kmalloc</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>sizeof</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>struct</span><span> devone_data</span><span style=color:#eceff4>),</span><span> GFP_KERNEL</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>  if</span><span style=color:#eceff4> (</span><span>p </span><span style=color:#81a1c1>== NULL</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#88c0d0>    printk</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>%s: No memory</span><span style=color:#ebcb8b>\n</span><span style=color:#eceff4>",</span><span> __func__</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    return -</span><span>ENOMEM</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>  }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>  p</span><span style=color:#81a1c1>-></span><span>val</span><span style=color:#81a1c1> = 0x</span><span style=color:#b48ead>ff</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#88c0d0>  rwlock_init</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>p</span><span style=color:#81a1c1>-></span><span>lock</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>  file</span><span style=color:#81a1c1>-></span><span>private_data</span><span style=color:#81a1c1> =</span><span> p</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>  return</span><span style=color:#b48ead> 0</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>å¼•æ•°ã«openã•ã‚ŒãŸfileã®<code>inode</code>ã¨file handlerãŒæ¸¡ã•ã‚Œã¾ã™ã€‚ å€‹äººçš„ã«ã¯åˆã‚ã¦ã€<code>inode</code>ã®å®šç¾©ã‚’èª­ã‚“ã ã®ã§ã€ã“ã‚ŒãŒä»Šã¾ã§inode,inodeã„ã£ã¦ã„ãŸå®Ÿä½“ã‹ã¨ãªã‚Šã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=c><span class=giallo-l><span style=color:#81a1c1>struct</span><span> file </span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>	void				*</span><span>private_data</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#616e88>  /* ... */</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>file</code>ã«ã¯<code>void *</code>ã‚’ä¿æŒã§ãã‚‹<code>private_data</code> ãŒã‚ã‚Šã€ã“ã“ã«ãƒ‰ãƒ©ã‚¤ãƒå´ã§å®šç¾©ã—ãŸå‡¦ç†ã«é–¢ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã™ã“ã¨ãŒã§ãã¾ã™ã€‚çµæ§‹è‡ªç”±ãªã‚“ã§ã™ã­ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=c><span class=giallo-l><span style=color:#81a1c1>struct</span><span> devone_data </span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>  unsigned char</span><span> val</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  rwlock_t</span><span> lock</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span><span style=color:#81a1c1>;</span></span></code></pre><p>1ã‚’å›ºå®šã§è¿”ã™ã€readå‡¦ç†ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=c><span class=giallo-l><span style=color:#81a1c1>static ssize_t</span><span style=color:#88c0d0> devone_read</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>struct</span><span> file </span><span style=color:#81a1c1>*</span><span>filep</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> char</span><span> __user </span><span style=color:#81a1c1>*</span><span>buf</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> size_t</span><span> count</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                           loff_t</span><span style=color:#81a1c1> *</span><span>f_pos</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>  struct</span><span> devone_data </span><span style=color:#81a1c1>*</span><span>p </span><span style=color:#81a1c1>=</span><span> filep</span><span style=color:#81a1c1>-></span><span>private_data</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>  int</span><span> i</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>  unsigned char</span><span> val</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>  int</span><span> retval</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>  </span></span>
<span class=giallo-l><span style=color:#88c0d0>  read_lock</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>p</span><span style=color:#81a1c1>-></span><span>lock</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>  val </span><span style=color:#81a1c1>=</span><span> p</span><span style=color:#81a1c1>-></span><span>val</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#88c0d0>  read_unlock</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>p</span><span style=color:#81a1c1>-></span><span>lock</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>  for</span><span style=color:#eceff4> (</span><span>i </span><span style=color:#81a1c1>=</span><span style=color:#b48ead> 0</span><span style=color:#81a1c1>;</span><span> i </span><span style=color:#81a1c1>&lt;</span><span> count</span><span style=color:#81a1c1>;</span><span> i</span><span style=color:#81a1c1>++</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    if</span><span style=color:#eceff4> (</span><span style=color:#88c0d0>copy_to_user</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>buf</span><span style=color:#eceff4>[</span><span>i</span><span style=color:#eceff4>],</span><span style=color:#81a1c1> &</span><span>val</span><span style=color:#eceff4>,</span><span style=color:#b48ead> 1</span><span style=color:#eceff4>)) {</span></span>
<span class=giallo-l><span>      retval </span><span style=color:#81a1c1>= -</span><span>EFAULT</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>      goto</span><span> out</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>  }</span></span>
<span class=giallo-l><span>  retval </span><span style=color:#81a1c1>=</span><span> count</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>out:</span></span>
<span class=giallo-l><span style=color:#81a1c1>  return</span><span style=color:#eceff4> (</span><span>retval</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>openæ™‚ã«åˆæœŸåŒ–ã—ãŸ<code>devone_data</code>ã‹ã‚‰å€¤(1)ã‚’å–ã‚Šå‡ºã—ã¦ã€ãƒ¦ãƒ¼ã‚¶é ˜åŸŸã«æ›¸ãè¾¼ã¿ã¾ã™ã€‚readã¯è¤‡æ•°threadã‹ã‚‰å‘¼ã°ã‚Œã‚‹ã®ã§ã€å…±æœ‰é ˜åŸŸã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å ´åˆã¯ãƒ­ãƒƒã‚¯ã‚’ã¨ã‚Šã¾ã™ã€‚ã“ã®ã‚ãŸã‚Šã®è€ƒãˆæ–¹ã¯é€šå¸¸ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã¨åŒã˜ã ã¨æ€ã„ã¾ã™ã€‚(sleepã®å¯å¦ã‚’é™¤ã„ã¦)<p>ä»Šå›ã¯readã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒæ±ºã‚æ‰“ã¡ãªã®ã§ã€å¸¸ã«å‡¦ç†ã§ãã¾ã™ãŒã€å®Ÿéš›ã®ãƒ‰ãƒ©ã‚¤ãƒã§ã¯ã“ã“ã‹ã‚‰ãƒ‡ãƒã‚¤ã‚¹ã‚’åˆ¶å¾¡ã™ã‚‹å‡¦ç†ãŒèµ°ã‚Šã€å ´åˆã«ã‚ˆã£ã¦ã¯ãƒ¦ãƒ¼ã‚¶ã«æƒ…å ±ã‚’è¿”ã›ãªã„ã§ã™ã€‚ãã®éš›ã«ãƒ‰ãƒ©ã‚¤ãƒå´ã§ã€CPUã®å‡¦ç†ã‚’æ‰‹æ”¾ã™ã“ã¨ã«ãªã‚Šã€ãƒ—ãƒ­ã‚»ã‚¹ãŒã‚¹ãƒªãƒ¼ãƒ—ã—ã¾ã™ã€‚<p>writeå‡¦ç†ã¯åŒæ§˜ã«ä¿æŒã—ã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã«æ›¸ãè¾¼ã‚€ã ã‘ã§ã™<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=c><span class=giallo-l><span style=color:#81a1c1>static ssize_t</span><span style=color:#88c0d0> devone_write</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>struct</span><span> file </span><span style=color:#81a1c1>*</span><span>filep</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> const char</span><span> __user </span><span style=color:#81a1c1>*</span><span>buf</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>                            size_t</span><span> count</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> loff_t</span><span style=color:#81a1c1> *</span><span>f_pos</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>  struct</span><span> devone_data </span><span style=color:#81a1c1>*</span><span>p </span><span style=color:#81a1c1>=</span><span> filep</span><span style=color:#81a1c1>-></span><span>private_data</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>  unsigned char</span><span> val</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>  int</span><span> retval </span><span style=color:#81a1c1>=</span><span style=color:#b48ead> 0</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>  if</span><span style=color:#eceff4> (</span><span>count </span><span style=color:#81a1c1>>=</span><span style=color:#b48ead> 1</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    if</span><span style=color:#eceff4> (</span><span style=color:#88c0d0>copy_from_user</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>val</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> &</span><span>buf</span><span style=color:#eceff4>[</span><span style=color:#b48ead>0</span><span style=color:#eceff4>],</span><span style=color:#b48ead> 1</span><span style=color:#eceff4>)) {</span></span>
<span class=giallo-l><span>      retval </span><span style=color:#81a1c1>= -</span><span>EFAULT</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>      goto</span><span> out</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#88c0d0>    write_lock</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>p</span><span style=color:#81a1c1>-></span><span>lock</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>    p</span><span style=color:#81a1c1>-></span><span>val</span><span style=color:#81a1c1> =</span><span> val</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#88c0d0>    write_unlock</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>p</span><span style=color:#81a1c1>-></span><span>lock</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>    retval </span><span style=color:#81a1c1>=</span><span> count</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>  }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>out:</span></span>
<span class=giallo-l><span style=color:#81a1c1>  return</span><span style=color:#eceff4> (</span><span>retval</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ä»¥ä¸‹ã®å‡¦ç†ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã‚‹ã¨<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span>    env</span><span style=color:#eceff4>,</span><span> fs</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    io</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>Read</span><span style=color:#81a1c1> as</span><span> _</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Write</span><span style=color:#81a1c1> as</span><span> _</span><span style=color:#eceff4>},</span></span>
<span class=giallo-l><span style=color:#eceff4>};</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> tracing</span><span style=color:#81a1c1>::</span><span>info</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span> anyhow</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span>    tracing_subscriber</span><span style=color:#81a1c1>::</span><span>fmt</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>init</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> dev_file</span><span style=color:#81a1c1> =</span><span> env</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>var</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>DEV_FILE</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap_or</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>/dev/devone0</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_owned</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> f</span><span style=color:#81a1c1> =</span><span> fs</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>OpenOptions</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>read</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>true</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>write</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>true</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>open</span><span style=color:#eceff4>(</span><span>dev_file</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> buf</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> [</span><span style=color:#b48ead>0</span><span style=color:#eceff4>;</span><span style=color:#b48ead> 8</span><span style=color:#eceff4>];</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>    f</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write_all</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>b</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>A</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span>    f</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>read_exact</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut</span><span> buf</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    info!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Read: </span><span style=color:#ebcb8b>{}</span><span style=color:#eceff4>",</span><span style=color:#8fbcbb> String</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_utf8_lossy</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>buf</span><span style=color:#eceff4>));</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>    f</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write_all</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>b</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>B</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span>    f</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>read_exact</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut</span><span> buf</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    info!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Read: </span><span style=color:#ebcb8b>{}</span><span style=color:#eceff4>",</span><span style=color:#8fbcbb> String</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_utf8_lossy</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>buf</span><span style=color:#eceff4>));</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>    Ok</span><span style=color:#eceff4>(())</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>2026-02-08T08:23:16.416004Z</span><span style=color:#a3be8c>  INFO devone: Read: AAAAAAAA</span></span>
<span class=giallo-l><span style=color:#88c0d0>2026-02-08T08:23:17.439580Z</span><span style=color:#a3be8c>  INFO devone: Read: BBBBBBBB</span></span></code></pre><p>ç„¡äº‹ä»»æ„ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãè¾¼ã‚€ã“ã¨ãŒã§ãã¾ã—ãŸã€‚<h2 id=di-6zhang-doraibapuroguramingunoshi-ji><a aria-label="Anchor link for: di-6zhang-doraibapuroguramingunoshi-ji" class=zola-anchor href=#di-6zhang-doraibapuroguramingunoshi-ji>ç¬¬6ç«  ãƒ‰ãƒ©ã‚¤ãƒãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã®å®Ÿéš›</a></h2><p>æœ¬ç« ã§ã¯ã€ioctlã®å®Ÿè£…æ–¹æ³•ã®è§£èª¬ãŒã‚ã‚Šã¾ã™ã€‚ ioctlã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ã‚¹ãƒšãƒ¼ã‚¹ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¨ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’å…±æœ‰ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§ã€ã¾ãšheader fileã‚’å®šç¾©ã—ã¾ã™ã€‚<p><code>devone_ioctl.h</code><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=c><span class=giallo-l><span style=color:#5e81ac;font-weight:700>#ifndef</span><span style=color:#88c0d0> _DEVONE_IOCTL_H</span></span>
<span class=giallo-l><span style=color:#5e81ac;font-weight:700>#</span><span style=color:#81a1c1>define</span><span style=color:#88c0d0> _DEVONE_IOCTL_H</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac;font-weight:700>#</span><span style=color:#81a1c1>include</span><span style=color:#eceff4> &lt;</span><span style=color:#8fbcbb>linux/ioctl.h</span><span style=color:#eceff4>></span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>struct</span><span> ioctl_cmd </span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>  unsigned int</span><span> reg</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>  unsigned int</span><span> offset</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>  unsigned int</span><span> val</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac;font-weight:700>#</span><span style=color:#81a1c1>define</span><span style=color:#88c0d0> IOC_MAGIC</span><span style=color:#eceff4> '</span><span style=color:#a3be8c>d</span><span style=color:#eceff4>'</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>enum</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>  IOCTL_VALSET </span><span style=color:#81a1c1>=</span><span style=color:#88c0d0> _IOW</span><span style=color:#eceff4>(</span><span>IOC_MAGIC</span><span style=color:#eceff4>,</span><span style=color:#b48ead> 1</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> struct</span><span> ioctl_cmd</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span>  IOCTL_VALGET </span><span style=color:#81a1c1>=</span><span style=color:#88c0d0> _IOR</span><span style=color:#eceff4>(</span><span>IOC_MAGIC</span><span style=color:#eceff4>,</span><span style=color:#b48ead> 2</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> struct</span><span> ioctl_cmd</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac;font-weight:700>#endif</span></span></code></pre><p>ioctl handler<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=c><span class=giallo-l><span style=color:#5e81ac;font-weight:700>#</span><span style=color:#81a1c1>include</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>devone_ioctl.h</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>static long int</span><span style=color:#88c0d0> devone_ioctl</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>struct</span><span> file </span><span style=color:#81a1c1>*</span><span>filep</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> unsigned int</span><span> cmd</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>                             unsigned long</span><span> arg</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>  struct</span><span> devone_data </span><span style=color:#81a1c1>*</span><span>dev </span><span style=color:#81a1c1>=</span><span> filep</span><span style=color:#81a1c1>-></span><span>private_data</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>  struct</span><span> ioctl_cmd data</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>  struct</span><span> ioctl_cmd __user </span><span style=color:#81a1c1>*</span><span>uarg </span><span style=color:#81a1c1>=</span><span style=color:#eceff4> (</span><span style=color:#81a1c1>struct</span><span> ioctl_cmd __user </span><span style=color:#81a1c1>*</span><span style=color:#eceff4>)</span><span>arg</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>  if</span><span style=color:#eceff4> (</span><span style=color:#88c0d0>_IOC_TYPE</span><span style=color:#eceff4>(</span><span>cmd</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> !=</span><span> IOC_MAGIC</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>    return -</span><span>ENOTTY</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>  if</span><span style=color:#eceff4> (</span><span style=color:#88c0d0>_IOC_SIZE</span><span style=color:#eceff4>(</span><span>cmd</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> != sizeof</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>struct</span><span> ioctl_cmd</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#81a1c1>    return -</span><span>EINVAL</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>  memset</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>data</span><span style=color:#eceff4>,</span><span style=color:#b48ead> 0</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> sizeof</span><span style=color:#eceff4>(</span><span>data</span><span style=color:#eceff4>))</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>  switch</span><span style=color:#eceff4> (</span><span>cmd</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#616e88>  /* userland write */</span></span>
<span class=giallo-l><span style=color:#81a1c1>  case</span><span> IOCTL_VALSET</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#81a1c1>    if</span><span style=color:#eceff4> (</span><span style=color:#81a1c1>!</span><span style=color:#88c0d0>capable</span><span style=color:#eceff4>(</span><span>CAP_SYS_ADMIN</span><span style=color:#eceff4>)) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>      return -</span><span>EPERM</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#81a1c1>    if</span><span style=color:#eceff4> (</span><span style=color:#88c0d0>copy_from_user</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>data</span><span style=color:#eceff4>,</span><span> uarg</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> sizeof</span><span style=color:#eceff4>(</span><span>data</span><span style=color:#eceff4>))) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>      return -</span><span>EFAULT</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>    write_lock</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>dev</span><span style=color:#81a1c1>-></span><span>lock</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>    dev</span><span style=color:#81a1c1>-></span><span>val</span><span style=color:#81a1c1> =</span><span> data</span><span style=color:#eceff4>.</span><span>val</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#88c0d0>    write_unlock</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>dev</span><span style=color:#81a1c1>-></span><span>lock</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    break;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>  /* userland read */</span></span>
<span class=giallo-l><span style=color:#81a1c1>  case</span><span> IOCTL_VALGET</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#88c0d0>    read_lock</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>dev</span><span style=color:#81a1c1>-></span><span>lock</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>    data</span><span style=color:#eceff4>.</span><span>val</span><span style=color:#81a1c1> =</span><span> dev</span><span style=color:#81a1c1>-></span><span>val</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#88c0d0>    read_unlock</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>dev</span><span style=color:#81a1c1>-></span><span>lock</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    if</span><span style=color:#eceff4> (</span><span style=color:#88c0d0>copy_to_user</span><span style=color:#eceff4>(</span><span>uarg</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> &</span><span>data</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> sizeof</span><span style=color:#eceff4>(</span><span>data</span><span style=color:#eceff4>))) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>      return -</span><span>EFAULT</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#81a1c1>    break;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>  default</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#81a1c1>    return -</span><span>ENOTTY</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    break;</span></span>
<span class=giallo-l><span style=color:#eceff4>  }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>  return</span><span style=color:#b48ead> 0</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã›ã£ã‹ãã®ioctlã§ã™ãŒã‚„ã£ã¦ã„ã‚‹ã“ã¨ã¯ã€read/writeã§ã™ã€‚ å€‹äººçš„ã«ã¯ã€<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=c><span class=giallo-l><span style=color:#81a1c1>    if</span><span style=color:#eceff4> (</span><span style=color:#81a1c1>!</span><span style=color:#88c0d0>capable</span><span style=color:#eceff4>(</span><span>CAP_SYS_ADMIN</span><span style=color:#eceff4>)) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>      return -</span><span>EPERM</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span></code></pre><p>ã®ã‚ˆã†ã«ã€capabilityã®ãƒã‚§ãƒƒã‚¯ãŒãƒ‰ãƒ©ã‚¤ãƒã®ifã§å®Ÿè£…ã§ãã‚‹ã¨ã„ã†ã“ã¨ã‚’çŸ¥ã‚Œã€ã†ã‚Œã—ã‹ã£ãŸã§ã™ã€‚<p>ã“ã®ioctlã‚’ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‹ã‚‰èª­ã‚“ã§ã¿ã¾ã™ã€‚ ã¾ãšã€<code>devone_ioctl.h</code>ã‚’Rustã‹ã‚‰èª­ã‚ã‚‹ã‚ˆã†ã«ã€<code>bindings</code>ã§<a href=https://github.com/ymgyt/drivers/blob/ae22c97d66cb1f20010d74db29f96bb53ec4346e/uapp/src/generated/devone_ioctl_bindings.rs rel=external><code>devone_ioctl_bindings.rs</code></a>ã‚’<a href=https://github.com/ymgyt/drivers/blob/ae22c97d66cb1f20010d74db29f96bb53ec4346e/uapp/build.rs rel=external>ç”Ÿæˆ</a>ã—ã¾ã™ã€‚<p>ãã®ä¸Šã§ã€ãƒ¦ãƒ¼ã‚¶å´ã‹ã‚‰ã€<code>libc::ioctl()</code>ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span>fs</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>OpenOptions</span><span style=color:#eceff4>,</span><span> io</span><span style=color:#eceff4>,</span><span> os</span><span style=color:#81a1c1>::</span><span>fd</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>AsRawFd</span><span style=color:#81a1c1> as</span><span> _</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> tracing</span><span style=color:#81a1c1>::</span><span>info</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> uapp</span><span style=color:#81a1c1>::</span><span>bindings</span><span style=color:#81a1c1>::</span><span>devone_ioctl</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>IOCTL_VALGET</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> IOCTL_VALSET</span><span style=color:#eceff4>,</span><span> ioctl_cmd</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> ioctl_valset</span><span style=color:#eceff4>(</span><span>fd</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> i32</span><span style=color:#eceff4>,</span><span> val</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> u32</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span> io</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> data</span><span style=color:#81a1c1> =</span><span> ioctl_cmd</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>        reg</span><span style=color:#81a1c1>:</span><span style=color:#b48ead> 0</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        offset</span><span style=color:#81a1c1>:</span><span style=color:#b48ead> 0</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        val</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    };</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> rc</span><span style=color:#81a1c1> = unsafe</span><span style=color:#eceff4> {</span><span> libc</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>ioctl</span><span style=color:#eceff4>(</span><span>fd</span><span style=color:#eceff4>,</span><span> IOCTL_VALSET</span><span style=color:#81a1c1> as</span><span> libc</span><span style=color:#81a1c1>::</span><span>c_ulong</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> &mut</span><span> data</span><span style=color:#eceff4>) };</span></span>
<span class=giallo-l><span style=color:#81a1c1>    if</span><span> rc</span><span style=color:#81a1c1> &lt;</span><span style=color:#b48ead> 0</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        return</span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span>io</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Error</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>last_os_error</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Ok</span><span style=color:#eceff4>(())</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> ioctl_valget</span><span style=color:#eceff4>(</span><span>fd</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> i32</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span> io</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>u32</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> data</span><span style=color:#81a1c1> =</span><span> ioctl_cmd</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>        reg</span><span style=color:#81a1c1>:</span><span style=color:#b48ead> 0</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        offset</span><span style=color:#81a1c1>:</span><span style=color:#b48ead> 0</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        val</span><span style=color:#81a1c1>:</span><span style=color:#b48ead> 0</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    };</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> rc</span><span style=color:#81a1c1> = unsafe</span><span style=color:#eceff4> {</span><span> libc</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>ioctl</span><span style=color:#eceff4>(</span><span>fd</span><span style=color:#eceff4>,</span><span> IOCTL_VALGET</span><span style=color:#81a1c1> as</span><span> libc</span><span style=color:#81a1c1>::</span><span>c_ulong</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> &mut</span><span> data</span><span style=color:#eceff4>) };</span></span>
<span class=giallo-l><span style=color:#81a1c1>    if</span><span> rc</span><span style=color:#81a1c1> &lt;</span><span style=color:#b48ead> 0</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        return</span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span>io</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Error</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>last_os_error</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Ok</span><span style=color:#eceff4>(</span><span>data</span><span style=color:#81a1c1>.</span><span>val</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span> anyhow</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span>    tracing_subscriber</span><span style=color:#81a1c1>::</span><span>fmt</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>init</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> f</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> OpenOptions</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>read</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>true</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>write</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>true</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>open</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>/dev/devone0</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> fd</span><span style=color:#81a1c1> =</span><span> f</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_raw_fd</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> got</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> ioctl_valget</span><span style=color:#eceff4>(</span><span>fd</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    info!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>IOCTL_VALGET: got val=0x</span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>got:02x</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> set_val</span><span style=color:#81a1c1> =</span><span style=color:#b48ead> 2_</span><span style=color:#8fbcbb>u32</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    info!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>IOCTL_VALSET: setting val=0x</span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>set_val:02x</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#88c0d0>    ioctl_valset</span><span style=color:#eceff4>(</span><span>fd</span><span style=color:#eceff4>,</span><span> set_val</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> got</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> ioctl_valget</span><span style=color:#eceff4>(</span><span>fd</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    info!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>IOCTL_VALGET: got val=0x</span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>got:02x</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>    Ok</span><span style=color:#eceff4>(())</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã“ã‚Œã‚’å®Ÿè¡Œã™ã‚‹ã¨<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>2026-02-08T09:12:35.854053Z</span><span style=color:#a3be8c>  INFO devone_ioctl: IOCTL_VALGET: got val=</span><span style=color:#b48ead>0xff</span></span>
<span class=giallo-l><span style=color:#88c0d0>2026-02-08T09:12:35.854128Z</span><span style=color:#a3be8c>  INFO devone_ioctl: IOCTL_VALSET: setting val=</span><span style=color:#b48ead>0x02</span></span>
<span class=giallo-l><span style=color:#88c0d0>2026-02-08T09:12:35.854159Z</span><span style=color:#a3be8c>  INFO devone_ioctl: IOCTL_VALGET: got val=</span><span style=color:#b48ead>0x02</span></span></code></pre><p>ç„¡äº‹ioctlã§ãã¾ã—ãŸã€‚<p>æ¬¡ã«ã€<code>poll()</code>ã§ã™ã€‚deviceå´ã¯å¸¸ã«read/writeå¯èƒ½ãªå®Ÿè£…ã§ã™<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=c><span class=giallo-l><span style=color:#81a1c1>static unsigned int</span><span style=color:#88c0d0> devone_poll</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>struct</span><span> file </span><span style=color:#81a1c1>*</span><span>filp</span><span style=color:#eceff4>,</span><span> poll_table </span><span style=color:#81a1c1>*</span><span>wait</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>  struct</span><span> devone_data </span><span style=color:#81a1c1>*</span><span>dev </span><span style=color:#81a1c1>=</span><span> filp</span><span style=color:#81a1c1>-></span><span>private_data</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>  if</span><span style=color:#eceff4> (</span><span>dev </span><span style=color:#81a1c1>== NULL</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>    return -</span><span>EBADFD</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>  return</span><span> POLLIN </span><span style=color:#81a1c1>|</span><span> POLLRDNORM </span><span style=color:#81a1c1>|</span><span> POLLOUT </span><span style=color:#81a1c1>|</span><span> POLLWRNORM</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã“ã‚Œã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¦å‘¼ã³å‡ºã—ã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span>fs</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>OpenOptions</span><span style=color:#eceff4>,</span><span> io</span><span style=color:#eceff4>,</span><span> mem</span><span style=color:#eceff4>,</span><span> os</span><span style=color:#81a1c1>::</span><span>fd</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>AsRawFd</span><span style=color:#81a1c1> as</span><span> _</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> anyhow</span><span style=color:#81a1c1>::</span><span>bail</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> tracing</span><span style=color:#81a1c1>::</span><span>info</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span> anyhow</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span>    tracing_subscriber</span><span style=color:#81a1c1>::</span><span>fmt</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>init</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> f</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> OpenOptions</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>read</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>true</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>write</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>true</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>open</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>/dev/devone0</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> fd</span><span style=color:#81a1c1> =</span><span> f</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_raw_fd</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> epfd</span><span style=color:#81a1c1> = unsafe</span><span style=color:#eceff4> {</span><span> libc</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>epoll_create1</span><span style=color:#eceff4>(</span><span style=color:#b48ead>0</span><span style=color:#eceff4>) };</span></span>
<span class=giallo-l><span style=color:#81a1c1>    if</span><span> epfd</span><span style=color:#81a1c1> &lt;</span><span style=color:#b48ead> 0</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>        bail!</span><span style=color:#eceff4>(</span><span>io</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Error</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>last_os_error</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> ev</span><span style=color:#81a1c1>:</span><span> libc</span><span style=color:#81a1c1>::</span><span>epoll_event</span><span style=color:#81a1c1> = unsafe</span><span style=color:#eceff4> {</span><span> mem</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>zeroed</span><span style=color:#eceff4>() };</span></span>
<span class=giallo-l><span>    ev</span><span style=color:#81a1c1>.</span><span>events </span><span style=color:#81a1c1>=</span><span> libc</span><span style=color:#81a1c1>::</span><span>EPOLLIN</span><span style=color:#81a1c1> as</span><span style=color:#8fbcbb> u32</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span>    ev</span><span style=color:#81a1c1>.</span><span style=color:#8fbcbb>u64</span><span style=color:#81a1c1> =</span><span> fd</span><span style=color:#81a1c1> as</span><span style=color:#8fbcbb> u64</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> rc</span><span style=color:#81a1c1> = unsafe</span><span style=color:#eceff4> {</span><span> libc</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>epoll_ctl</span><span style=color:#eceff4>(</span><span>epfd</span><span style=color:#eceff4>,</span><span> libc</span><span style=color:#81a1c1>::</span><span>EPOLL_CTL_ADD</span><span style=color:#eceff4>,</span><span> fd</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> &mut</span><span> ev</span><span style=color:#81a1c1> as *mut</span><span> _</span><span style=color:#eceff4>) };</span></span>
<span class=giallo-l><span style=color:#81a1c1>    if</span><span> rc</span><span style=color:#81a1c1> &lt;</span><span style=color:#b48ead> 0</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> err</span><span style=color:#81a1c1> =</span><span> io</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Error</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>last_os_error</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>        unsafe</span><span style=color:#eceff4> {</span><span> libc</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>close</span><span style=color:#eceff4>(</span><span>epfd</span><span style=color:#eceff4>) };</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>        bail!</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> events</span><span style=color:#81a1c1>:</span><span style=color:#eceff4> [</span><span>libc</span><span style=color:#81a1c1>::</span><span>epoll_event</span><span style=color:#eceff4>;</span><span style=color:#b48ead> 8</span><span style=color:#eceff4>]</span><span style=color:#81a1c1> = unsafe</span><span style=color:#eceff4> {</span><span> mem</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>zeroed</span><span style=color:#eceff4>() };</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> n</span><span style=color:#81a1c1> = unsafe</span><span style=color:#eceff4> {</span><span> libc</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>epoll_wait</span><span style=color:#eceff4>(</span><span>epfd</span><span style=color:#eceff4>,</span><span> events</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_mut_ptr</span><span style=color:#eceff4>(),</span><span> events</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>len</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> as</span><span style=color:#8fbcbb> i32</span><span style=color:#eceff4>,</span><span style=color:#b48ead> 0</span><span style=color:#eceff4>) };</span></span>
<span class=giallo-l><span style=color:#81a1c1>    if</span><span> n</span><span style=color:#81a1c1> &lt;</span><span style=color:#b48ead> 0</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> err</span><span style=color:#81a1c1> =</span><span> io</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Error</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>last_os_error</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>        unsafe</span><span style=color:#eceff4> {</span><span> libc</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>close</span><span style=color:#eceff4>(</span><span>epfd</span><span style=color:#eceff4>) };</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>        bail!</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    info!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>epoll_wait returned n=</span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>n</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#5e81ac>    #[expect(clippy::needless_range_loop)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>    for</span><span> i</span><span style=color:#81a1c1> in</span><span style=color:#b48ead> 0</span><span style=color:#81a1c1>..</span><span>n</span><span style=color:#81a1c1> as</span><span style=color:#8fbcbb> usize</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> ev</span><span style=color:#81a1c1> = &</span><span>events</span><span style=color:#eceff4>[</span><span>i</span><span style=color:#eceff4>];</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> ready</span><span style=color:#81a1c1> =</span><span> ev</span><span style=color:#81a1c1>.</span><span>events</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> token</span><span style=color:#81a1c1> =</span><span> ev</span><span style=color:#81a1c1>.</span><span style=color:#8fbcbb>u64</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>        info!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>event[</span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>i</span><span style=color:#ebcb8b>}</span><span style=color:#a3be8c>]: token=</span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>token</span><span style=color:#ebcb8b>}</span><span style=color:#a3be8c> events=0x</span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>ready:x</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if</span><span> ready</span><span style=color:#81a1c1> &</span><span style=color:#eceff4> (</span><span>libc</span><span style=color:#81a1c1>::</span><span>EPOLLIN</span><span style=color:#81a1c1> as</span><span style=color:#8fbcbb> u32</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> !=</span><span style=color:#b48ead> 0</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>            info!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>  => EPOLLIN (readable)</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    unsafe</span><span style=color:#eceff4> {</span><span> libc</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>close</span><span style=color:#eceff4>(</span><span>epfd</span><span style=color:#eceff4>) };</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Ok</span><span style=color:#eceff4>(())</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>epollã®è©³ç´°ã¯å‰²æ„›ã—ã¾ã™ãŒã€ã“ã‚Œã‚’å®Ÿè¡Œã™ã‚‹ã¨ç„¡äº‹readableã§ã‚ã‚‹ã“ã¨ã‚’ä¼ãˆã‚‰ã‚Œã¾ã—ãŸ<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>2026-02-08T09:24:22.709203Z</span><span style=color:#a3be8c>  INFO devone_epoll: epoll_wait returned n=</span><span style=color:#b48ead>1</span></span>
<span class=giallo-l><span style=color:#88c0d0>2026-02-08T09:24:22.709280Z</span><span style=color:#a3be8c>  INFO devone_epoll: event[0]: token=</span><span style=color:#b48ead>123</span><span style=color:#a3be8c> events=</span><span style=color:#b48ead>0x1</span></span>
<span class=giallo-l><span style=color:#88c0d0>2026-02-08T09:24:22.709301Z</span><span style=color:#a3be8c>  INFO devone_epoll:</span><span>   =</span><span style=color:#81a1c1>></span><span style=color:#a3be8c> EPOLLIN</span><span> (readable)</span></span></code></pre><p>ã“ã®ä»–ã«ã‚‚ã€proc_fs, seq_file, sleepã®è§£èª¬ãŒã‚ã‚Šã¾ã™ã€‚ æœ€å¾Œã«ãƒ‰ãƒ©ã‚¤ãƒã‹ã‚‰ç›´æ¥ã€<code>insmod</code>ã‚’å®Ÿè¡Œã—ãŸãƒ¦ãƒ¼ã‚¶ã®ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡ºåŠ›ã™ã‚‹æ–¹æ³•ãŒç´¹ä»‹ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=c><span class=giallo-l><span style=color:#81a1c1>static void</span><span style=color:#88c0d0> pr_tty_console</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>char *</span><span>msg</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>  struct</span><span> tty_struct </span><span style=color:#81a1c1>*</span><span>tty</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>  tty </span><span style=color:#81a1c1>=</span><span> current </span><span style=color:#81a1c1>-></span><span> signal</span><span style=color:#81a1c1> -></span><span> tty</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>  if</span><span style=color:#eceff4> (</span><span>tty </span><span style=color:#81a1c1>!= NULL</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#eceff4>    (</span><span>tty</span><span style=color:#81a1c1>-></span><span>driver</span><span style=color:#81a1c1>-></span><span>ops->write</span><span style=color:#eceff4>)(</span><span>tty</span><span style=color:#eceff4>,</span><span> msg</span><span style=color:#eceff4>,</span><span style=color:#88c0d0> strlen</span><span style=color:#eceff4>(</span><span>msg</span><span style=color:#eceff4>))</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    (</span><span>tty</span><span style=color:#81a1c1>-></span><span>driver</span><span style=color:#81a1c1>-></span><span>ops->write</span><span style=color:#eceff4>)(</span><span>tty</span><span style=color:#eceff4>, "</span><span style=color:#ebcb8b>\r\n</span><span style=color:#eceff4>",</span><span style=color:#b48ead> 2</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>  }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>static int</span><span> __init </span><span style=color:#88c0d0>devone_init</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>void</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#616e88>  /* ... */</span></span>
<span class=giallo-l><span style=color:#88c0d0>  pr_tty_console</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>devone loaded(from tty console)</span><span style=color:#ebcb8b>\n</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#616e88>  /* ... */</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ãŠãã‚‰ãéå¸¸ã«å±é™ºãªå‡¦ç†ã ã¨æ€ã„ã¾ã™ãŒã€å®Ÿè¡Œã—ã¦ã¿ã‚‹ã¨<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>sudo</span><span style=color:#a3be8c> insmod ./devone.ko</span></span>
<span class=giallo-l><span style=color:#88c0d0>devone</span><span style=color:#a3be8c> loaded</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>from</span><span style=color:#a3be8c> tty console</span><span style=color:#eceff4>)</span></span></code></pre><p>ã¨ã€è¡¨ç¤ºã«æˆåŠŸã—ã¾ã—ãŸã€‚ ã‚¿ã‚¤ãƒãƒ¼ã«é–¢ã™ã‚‹APIã¯ç¾åœ¨ã§ã¯å¤‰æ›´ã•ã‚Œã¦ãŠã‚Šã€å…·ä½“çš„ãªå¤‰æ›´ã«ã¤ã„ã¦ã¯ã€<a href="https://techbookfest.org/product/h9vV6JbABCHD6CurWp7ers?productVariantID=idaht7Yvyg0b0ujvsyS9Y2" rel=external>ã‚«ãƒ¼ãƒãƒ«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆã§å­¦ã¶Linuxã‚«ãƒ¼ãƒãƒ«é–‹ç™ºã®åŸºç¤çŸ¥è­˜ï¼šç¬¬3ç‰ˆ</a>ãŒã‚ã‹ã‚Šã‚„ã™ã‹ã£ãŸã§ã™ã€‚<h2 id=di-7zhang-hadoueazhi-yu><a aria-label="Anchor link for: di-7zhang-hadoueazhi-yu" class=zola-anchor href=#di-7zhang-hadoueazhi-yu>ç¬¬7ç«  ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢åˆ¶å¾¡</a></h2><p>æœ¬ç« ã§ã¯ãƒ‰ãƒ©ã‚¤ãƒã‹ã‚‰å®Ÿéš›ã«ãƒ‡ãƒã‚¤ã‚¹ã‚’åˆ¶å¾¡ã™ã‚‹ãŸã‚ã«ã€I/Oãƒãƒƒãƒ—ãƒ‰I/Oã€ãƒ¡ãƒ¢ãƒªãƒãƒƒãƒ—ãƒ‰I/Oã«ã¤ã„ã¦ã®è§£èª¬ãŒã‚ã‚Šã¾ã™ã€‚ ãƒ¡ãƒ¢ãƒªãƒãƒƒãƒ—ãƒ‰I/Oã®å ´åˆã€ãƒ‡ãƒã‚¤ã‚¹ã®ãƒ¬ã‚¸ã‚¹ã‚¿ã«å¯¾å¿œã—ãŸç‰©ç†ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŒ‡å®šã—ã¦å‘½ä»¤ã‚’å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€ãƒ‰ãƒ©ã‚¤ãƒã¯ä»®æƒ³ã‚¢ãƒ‰ãƒ¬ã‚¹ã§å‹•ã„ã¦ã„ã‚‹ã®ã§ã€<code>ioremap()</code>ãŒå¿…è¦ã¨ãªã‚Šã¾ã™ã€‚<p>ã¾ãŸã€ãƒ¡ãƒ¢ãƒªã‚¢ã‚¯ã‚»ã‚¹ã«å‰¯ä½œç”¨ã‚„ä¾å­˜é–¢ä¿‚ãŒæš—é»™çš„ã«ç”Ÿã˜ã‚‹ã®ã§ã€ãƒ¡ãƒ¢ãƒªãƒãƒªã‚¢ã‚„volatileã®è©±ãŒã§ã¦ãã¾ã™ã€‚<p><code>asm()</code>ã®è§£èª¬ã‚‚ã‚ã‚Šã€Rustã®<a href=https://doc.rust-lang.org/reference/inline-assembly.html rel=external><code>asm!()</code></a> macroã¯ã“ã“ã‹ã‚‰æ¥ãŸã®ã‹ã¨çŸ¥ã‚Œã¾ã—ãŸã€‚<h2 id=di-8zhang-memori><a aria-label="Anchor link for: di-8zhang-memori" class=zola-anchor href=#di-8zhang-memori>ç¬¬8ç«  ãƒ¡ãƒ¢ãƒª</a></h2><p>ã‚«ãƒ¼ãƒãƒ«ã®ãƒ¡ãƒ¢ãƒªç®¡ç†ã«ã¤ã„ã¦ã€‚å…·ä½“çš„ã«ã¯ã€<code>kmalloc()</code>,<code>kfree()</code>ã¨ã„ã£ãŸAPIã€ã‚¹ãƒ©ãƒ–ã‚¢ãƒ­ã‚±ãƒ¼ã‚¿ã€ãƒãƒ‡ã‚£ã‚·ã‚¹ãƒ†ãƒ ã€ã‚«ãƒ¼ãƒãƒ«ã‚¹ã‚¿ãƒƒã‚¯ã«ã¤ã„ã¦ã®è¨€åŠãŒã‚ã‚Šã¾ã™ã€‚<p>DMAã«ã¤ã„ã¦ã¯ã€å®Ÿéš›ã®ãƒ‰ãƒ©ã‚¤ãƒ(drivers/net/e100.c)ã§ã®åˆ©ç”¨ä¾‹ã‚„ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚³ãƒ’ãƒ¼ãƒ¬ãƒ³ã‚¹å•é¡Œã®è§£èª¬ãŒã‚ã‚Šã¾ã™ã€‚<h2 id=di-9zhang-taima><a aria-label="Anchor link for: di-9zhang-taima" class=zola-anchor href=#di-9zhang-taima>ç¬¬9ç«  ã‚¿ã‚¤ãƒ</a></h2><p>2.6æ™‚ç‚¹ã§ã®æ™‚é–“ç®¡ç†ã«ã¤ã„ã¦ã€‚ <code>jiffies</code>ã‚„<code>do_gettimeofday()</code>, <code>timeval</code>ãŒã§ã¦ãã¾ã™ã€‚ 2038å¹´å•é¡Œã‚„497æ—¥å•é¡Œã«ã‚‚ãµã‚Œã‚‰ã‚Œã¦ã„ã¾ã™ã€‚ ãƒ‰ãƒ©ã‚¤ãƒã§ã¯ã€ãƒ‡ãƒã‚¤ã‚¹ã«å¯¾ã—ã¦DMAã®é–‹å§‹ã‚’æŒ‡ç¤ºã—ã€é€šå¸¸ã§ã¯å®Œäº†æ™‚ã®å‰²è¾¼ã¿ã§å‡¦ç†ã‚’ã—ã¾ã™ã€‚ã—ã‹ã—ã“ã‚Œã¯æˆåŠŸã—ãŸã‚±ãƒ¼ã‚¹ã§ã€ãƒ‡ãƒã‚¤ã‚¹å´ã®ä¸å…·åˆã§å‰²è¾¼ã¿ãŒã‚ãŒã£ã¦ã“ãªã„ã‹ã‚‚ã—ã‚Œãªã„ã®ã§ã€å¿…ãšã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†ã‚’ã„ã‚Œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚<p>ä»Šå›ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¦ã€readæ™‚ã®ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãƒ¼ã‚’ãƒ¢ãƒƒã‚¯ã™ã‚‹ãŸã‚ã«ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†ã‚’ã„ã‚Œã¦ã¿ã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=c><span class=giallo-l><span style=color:#81a1c1>struct</span><span> devone_data </span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#616e88>  /* ... */</span></span>
<span class=giallo-l><span>  </span></span>
<span class=giallo-l><span style=color:#616e88>  /* mock read latency */</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  wait_queue_head_t</span><span> read_wq</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  atomic_t</span><span> read_ready</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>  struct</span><span> timer_list read_timer</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span><span style=color:#81a1c1>;</span></span></code></pre><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=c><span class=giallo-l><span style=color:#81a1c1>static int</span><span style=color:#88c0d0> devone_open</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>struct</span><span> inode </span><span style=color:#81a1c1>*</span><span>inode</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> struct</span><span> file </span><span style=color:#81a1c1>*</span><span>file</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>  struct</span><span> devone_data </span><span style=color:#81a1c1>*</span><span>p</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>  p </span><span style=color:#81a1c1>=</span><span style=color:#88c0d0> kmalloc</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>sizeof</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>struct</span><span> devone_data</span><span style=color:#eceff4>),</span><span> GFP_KERNEL</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>  if</span><span style=color:#eceff4> (</span><span>p </span><span style=color:#81a1c1>== NULL</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#88c0d0>    printk</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>%s: No memory</span><span style=color:#ebcb8b>\n</span><span style=color:#eceff4>",</span><span> __func__</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    return -</span><span>ENOMEM</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>  }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>  p</span><span style=color:#81a1c1>-></span><span>val</span><span style=color:#81a1c1> = 0x</span><span style=color:#b48ead>ff</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#88c0d0>  rwlock_init</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>p</span><span style=color:#81a1c1>-></span><span>lock</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>  /* prepare mock read latency */</span></span>
<span class=giallo-l><span style=color:#88c0d0>  init_waitqueue_head</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>p</span><span style=color:#81a1c1>-></span><span>read_wq</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#88c0d0>  atomic_set</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>p</span><span style=color:#81a1c1>-></span><span>read_ready</span><span style=color:#eceff4>,</span><span style=color:#b48ead> 1</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#88c0d0>  timer_setup</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>p</span><span style=color:#81a1c1>-></span><span>read_timer</span><span style=color:#eceff4>,</span><span> devone_read_timer_cb</span><span style=color:#eceff4>,</span><span style=color:#b48ead> 0</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>  file</span><span style=color:#81a1c1>-></span><span>private_data</span><span style=color:#81a1c1> =</span><span> p</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>  return</span><span style=color:#b48ead> 0</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>openæ™‚ã«ã€<code>timer_setup()</code>ã§<code>timer_list</code>ã«callbacké–¢æ•°ã€<code>devone_read_timer_cb</code>ã‚’ç™»éŒ²ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=c><span class=giallo-l><span style=color:#81a1c1>static void</span><span style=color:#88c0d0> devone_read_timer_cb</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>struct</span><span> timer_list </span><span style=color:#81a1c1>*</span><span>t</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>  struct</span><span> devone_data </span><span style=color:#81a1c1>*</span><span>p </span><span style=color:#81a1c1>=</span><span style=color:#88c0d0> container_of</span><span style=color:#eceff4>(</span><span>t</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> struct</span><span> devone_data</span><span style=color:#eceff4>,</span><span> read_timer</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#88c0d0>  atomic_set</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>p</span><span style=color:#81a1c1>-></span><span>read_ready</span><span style=color:#eceff4>,</span><span style=color:#b48ead> 1</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#88c0d0>  pr_info</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>%s: Wake up!</span><span style=color:#ebcb8b>\n</span><span style=color:#eceff4>",</span><span> __func__</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#88c0d0>  wake_up</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>p</span><span style=color:#81a1c1>-></span><span>read_wq</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>devone_read_timer_cb</code>ã¯flagå¤‰æ•°ã§å®Œäº†ã‚’è¨˜éŒ²ã—ã¦ã€<code>wake_up()</code>ã‚’å‘¼ã³ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=c><span class=giallo-l><span style=color:#5e81ac;font-weight:700>#</span><span style=color:#81a1c1>define</span><span style=color:#88c0d0> DEVONE_READ_DELAY_MS</span><span style=color:#b48ead> 1000</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>static ssize_t</span><span style=color:#88c0d0> devone_read</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>struct</span><span> file </span><span style=color:#81a1c1>*</span><span>filep</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> char</span><span> __user </span><span style=color:#81a1c1>*</span><span>buf</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> size_t</span><span> count</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                           loff_t</span><span style=color:#81a1c1> *</span><span>f_pos</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>  struct</span><span> devone_data </span><span style=color:#81a1c1>*</span><span>p </span><span style=color:#81a1c1>=</span><span> filep</span><span style=color:#81a1c1>-></span><span>private_data</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>  int</span><span> i</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>  unsigned char</span><span> val</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>  int</span><span> retval</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>  long</span><span> wr</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>  atomic_set</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>p</span><span style=color:#81a1c1>-></span><span>read_ready</span><span style=color:#eceff4>,</span><span style=color:#b48ead>0</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#88c0d0>  mod_timer</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>p</span><span style=color:#81a1c1>-></span><span>read_timer</span><span style=color:#eceff4>,</span><span> jiffies </span><span style=color:#81a1c1>+</span><span style=color:#88c0d0> msecs_to_jiffies</span><span style=color:#eceff4>(</span><span>DEVONE_READ_DELAY_MS</span><span style=color:#eceff4>))</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>  </span></span>
<span class=giallo-l><span>  wr </span><span style=color:#81a1c1>=</span><span style=color:#88c0d0> wait_event_interruptible_timeout</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>    p</span><span style=color:#81a1c1>-></span><span>read_wq</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#88c0d0>    atomic_read</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>p</span><span style=color:#81a1c1>-></span><span>read_ready</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> !=</span><span style=color:#b48ead> 0</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#88c0d0>    msecs_to_jiffies</span><span style=color:#eceff4>(</span><span>DEVONE_READ_DELAY_MS </span><span style=color:#81a1c1>+</span><span style=color:#b48ead> 1000</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>  )</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>  if</span><span style=color:#eceff4> (</span><span>wr </span><span style=color:#81a1c1>==</span><span style=color:#b48ead> 0</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>    return -</span><span>ETIMEDOUT</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>  if</span><span style=color:#eceff4> (</span><span>wr </span><span style=color:#81a1c1>&lt;</span><span style=color:#b48ead> 0</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>    return</span><span> wr</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>  /* readå‡¦ç† */</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>readæ™‚ã«ã€<code>mod_timer()</code>ã§timeoutå‡¦ç†ã‚’æœ‰åŠ¹åŒ–ã—ã¦ã€<code>wait_event_interruptible_timeout()</code>ã§ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã‚’ãƒ¢ãƒƒã‚¯ã—ã¾ã™ã€‚<p><code>#define DEVONE_READ_DELAY_MS 5000</code> ã§5ç§’ã‚’æŒ‡å®šã—ã¦ã¿ã‚‹ã¨ç„¡äº‹ã€ãƒ¢ãƒƒã‚¯ã§ãã¾ã—ãŸ<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#81a1c1>time</span><span> hexyl -n 1 /dev/devone0 out</span><span style=color:#81a1c1>></span><span> /dev/null</span></span>
<span class=giallo-l><span style=color:#88c0d0>0.00user</span><span style=color:#a3be8c> 0.00system 0:05.13elapsed 0%CPU</span><span> (0avgtext+0avgdata</span><span style=color:#a3be8c> 2676maxresident</span><span>)k</span></span>
<span class=giallo-l><span style=color:#88c0d0>0inputs+0outputs</span><span> (0major+130minor)pagefaults 0swaps</span></span></code></pre><p>ã¾ãŸã€timerãŒç™ºç«ã™ã‚‹å‰ã«closeã§ãƒªã‚½ãƒ¼ã‚¹ãŒé–‹æ”¾ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚‹ã®ã§ã€<code>timer_delete_sync()</code>ã‚’å‘¼ã³å‡ºã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚<h2 id=di-10zhang-tong-qi-topai-ta><a aria-label="Anchor link for: di-10zhang-tong-qi-topai-ta" class=zola-anchor href=#di-10zhang-tong-qi-topai-ta>ç¬¬10ç«  åŒæœŸã¨æ’ä»–</a></h2><p>å…±æœ‰ãƒªã‚½ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å ´åˆã«ã€ãƒ­ãƒƒã‚¯ã‚’ã¨ã£ãŸã‚Šã€ã‚¢ãƒˆãƒŸãƒƒã‚¯æ“ä½œã‚’è¡Œã†ã®ã¯ã€ä¸€èˆ¬çš„ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨åŒã˜ã§ã™ã€‚ ãƒ‰ãƒ©ã‚¤ãƒã§ç•°ãªã‚‹ã®ã¯ã€å‰²è¾¼ã¿ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§ã¯sleepã§ããªã„ã®ã§ã€spin_lockç³»ã®APIã‚’ç”¨ã„ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã¨ã€å‰²è¾¼ã¿ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’æ„è­˜ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã¨ã„ã†ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚ kthreadã®èª¬æ˜ã‚‚ã‚ã‚Šã¾ã—ãŸã€‚å‹•ã‹ã™ã ã‘ãªã‚‰ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=c><span class=giallo-l><span style=color:#5e81ac;font-weight:700>#</span><span style=color:#81a1c1>include</span><span style=color:#eceff4> &lt;</span><span style=color:#8fbcbb>linux/module.h</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#5e81ac;font-weight:700>#</span><span style=color:#81a1c1>include</span><span style=color:#eceff4> &lt;</span><span style=color:#8fbcbb>linux/delay.h</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#5e81ac;font-weight:700>#</span><span style=color:#81a1c1>include</span><span style=color:#eceff4> &lt;</span><span style=color:#8fbcbb>linux/kthread.h</span><span style=color:#eceff4>></span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>MODULE_LICENSE</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>GPL</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#88c0d0>MODULE_AUTHOR</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>ymgyt</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#88c0d0>MODULE_DESCRIPTION</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>kthread sample</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac;font-weight:700>#</span><span style=color:#81a1c1>define</span><span style=color:#88c0d0> DRIVER_NAME</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>kthread</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>static struct</span><span> task_struct </span><span style=color:#81a1c1>*</span><span>kmain_task </span><span style=color:#81a1c1>= NULL;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>static int</span><span style=color:#88c0d0> sample_thread</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>void *</span><span>num</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>  while</span><span style=color:#eceff4> (</span><span style=color:#81a1c1>!</span><span style=color:#88c0d0>kthread_should_stop</span><span style=color:#eceff4>()) {</span></span>
<span class=giallo-l><span style=color:#88c0d0>    msleep_interruptible</span><span style=color:#eceff4>(</span><span style=color:#b48ead>3000</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>  }</span></span>
<span class=giallo-l><span style=color:#81a1c1>  return</span><span style=color:#b48ead> 0</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>static int</span><span> __init </span><span style=color:#88c0d0>mykthread_init</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>void</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span>  kmain_task </span><span style=color:#81a1c1>=</span><span style=color:#88c0d0> kthread_create</span><span style=color:#eceff4>(</span><span>sample_thread</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> NULL</span><span style=color:#eceff4>, "</span><span style=color:#a3be8c>sample mykthread</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>  if</span><span style=color:#eceff4> (</span><span style=color:#88c0d0>IS_ERR</span><span style=color:#eceff4>(</span><span>kmain_task</span><span style=color:#eceff4>)) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    return</span><span style=color:#88c0d0> PTR_ERR</span><span style=color:#eceff4>(</span><span>kmain_task</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>  }</span></span>
<span class=giallo-l><span style=color:#88c0d0>  wake_up_process</span><span style=color:#eceff4>(</span><span>kmain_task</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>  return</span><span style=color:#b48ead> 0</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>static void</span><span> __exit </span><span style=color:#88c0d0>mykthread_exit</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>void</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>  if</span><span style=color:#eceff4> (</span><span>kmain_task</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#88c0d0>    kthread_stop</span><span style=color:#eceff4>(</span><span>kmain_task</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>  }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>module_init</span><span style=color:#eceff4>(</span><span>mykthread_init</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#88c0d0>module_exit</span><span style=color:#eceff4>(</span><span>mykthread_exit</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span></code></pre><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>sudo</span><span style=color:#a3be8c> insmod ./</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>kthread</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>.ko</span></span>
<span class=giallo-l><span style=color:#88c0d0>ps</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> where</span><span style=color:#a3be8c> name =~</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>sample mykthread</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#616e88> # |   pid   | ppid |       name       |  status  | cpu  | mem | virtual</span></span>
<span class=giallo-l><span style=color:#88c0d0>---+---------+------+------------------+----------+------+-----+---------</span></span>
<span class=giallo-l><span style=color:#88c0d0> 0</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> 1216364</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0>    2</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> sample</span><span style=color:#a3be8c> mykthread</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> Sleeping</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> 0.00</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> 0</span><span style=color:#a3be8c> B</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0>     0</span><span style=color:#a3be8c> B</span></span></code></pre><h2 id=di-11zhang-ge-ip-mi><a aria-label="Anchor link for: di-11zhang-ge-ip-mi" class=zola-anchor href=#di-11zhang-ge-ip-mi>ç¬¬11ç«  å‰²è¾¼ã¿</a></h2><p>ãƒ‰ãƒ©ã‚¤ãƒã¨ã„ãˆã°å‰²è¾¼ã¿ã¨ã„ã†ã“ã¨ã§å‰²è¾¼ã¿ã®æ¦‚å¿µã«ã¤ã„ã¦èª¬æ˜ã•ã‚Œã¾ã™ã€‚ ã¾ãŸå®Ÿéš›ã®å‰²è¾¼ã¿å‡¦ç†ã¨ã—ã¦ã€<code>drivers/net/8139too.c</code>ãŒå–ã‚Šä¸Šã’ã‚‰ã‚Œã¦ã„ã¾ã—ãŸã€‚ ä»¥ä¸‹ã¯ã€<a href=https://github.com/Rust-for-Linux/linux/blob/192c0159402e6bfbe13de6f8379546943297783d/drivers/net/ethernet/realtek/8139too.c#L2155 rel=external><code>drivers/net/ethernet/realtek/8139too.c</code></a>ã®<code>rtl8139_interrupt()</code>å‡¦ç†ã§ã™ã€‚æœ¬æ›¸ã®ã“ã‚Œã¾ã§ã®çŸ¥è­˜ã§é›°å›²æ°—ã§ã™ãŒèª­ã‚ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=c><span class=giallo-l><span style=color:#616e88>/* The interrupt handler does all of the Rx thread work and cleans up</span></span>
<span class=giallo-l><span style=color:#616e88>   after the Tx thread. */</span></span>
<span class=giallo-l><span style=color:#81a1c1>static</span><span style=color:#8fbcbb> irqreturn_t</span><span style=color:#88c0d0> rtl8139_interrupt</span><span style=color:#eceff4> (</span><span style=color:#81a1c1>int</span><span> irq</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> void *</span><span>dev_instance</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>	struct</span><span> net_device </span><span style=color:#81a1c1>*</span><span>dev </span><span style=color:#81a1c1>=</span><span style=color:#eceff4> (</span><span style=color:#81a1c1>struct</span><span> net_device </span><span style=color:#81a1c1>*</span><span style=color:#eceff4>)</span><span> dev_instance</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>	struct</span><span> rtl8139_private </span><span style=color:#81a1c1>*</span><span>tp </span><span style=color:#81a1c1>=</span><span style=color:#88c0d0> netdev_priv</span><span style=color:#eceff4>(</span><span>dev</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>	void</span><span> __iomem </span><span style=color:#81a1c1>*</span><span>ioaddr </span><span style=color:#81a1c1>=</span><span> tp</span><span style=color:#81a1c1>-></span><span>mmio_addr</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>	u16 status</span><span style=color:#eceff4>,</span><span> ackstat</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>	int</span><span> link_changed </span><span style=color:#81a1c1>=</span><span style=color:#b48ead> 0</span><span style=color:#81a1c1>;</span><span style=color:#616e88> /* avoid bogus "uninit" warning */</span></span>
<span class=giallo-l><span style=color:#81a1c1>	int</span><span> handled </span><span style=color:#81a1c1>=</span><span style=color:#b48ead> 0</span><span style=color:#81a1c1>;</span></span></code></pre><p>å¼•æ•°ã‹ã‚‰å‡¦ç†ç”¨ã®privateãªstructã‚’å–ã‚Šå‡ºã—ã€ãƒ¡ãƒ¢ãƒªãƒãƒƒãƒ—ãƒ‰I/Oç”¨ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä¿æŒã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=c><span class=giallo-l><span style=color:#88c0d0>	spin_lock</span><span style=color:#eceff4> (</span><span style=color:#81a1c1>&</span><span>tp</span><span style=color:#81a1c1>-></span><span>lock</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>	status </span><span style=color:#81a1c1>=</span><span style=color:#88c0d0> RTL_R16</span><span style=color:#eceff4> (</span><span>IntrStatus</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span></code></pre><p>ãƒ¬ã‚¸ã‚¹ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã«ã‚ãŸã£ã¦ã€lockã‚’å–å¾—ã—ã¾ã™ã€‚å‰²è¾¼ã¿å‡¦ç†å†…ãªã®ã§ã€irqsaveç­‰ã¯ä¸è¦ã¨æ€ã‚ã‚Œã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=c><span class=giallo-l><span style=color:#5e81ac;font-weight:700>#</span><span style=color:#81a1c1>define</span><span style=color:#88c0d0> RTL_R16</span><span style=color:#eceff4>(</span><span>reg</span><span style=color:#eceff4>)</span><span style=color:#88c0d0>		ioread16</span><span style=color:#eceff4> (</span><span style=color:#5e81ac>ioaddr </span><span style=color:#81a1c1>+</span><span style=color:#eceff4> (</span><span style=color:#5e81ac>reg</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>/* Symbolic offsets to registers. */</span></span>
<span class=giallo-l><span style=color:#81a1c1>enum</span><span> RTL8139_registers </span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#616e88>  /* ... */</span></span>
<span class=giallo-l><span>	IntrStatus	</span><span style=color:#81a1c1>= 0x</span><span style=color:#b48ead>3E</span><span style=color:#eceff4>,</span></span></code></pre><p><code>RTL_R16</code>ã¯ãƒ¬ã‚¸ã‚¹ã‚¿ã‚’readã™ã‚‹ãƒã‚¯ãƒ­ã§ã€<code>status</code>ã«ãŠãã‚‰ãå‰²è¾¼ã¿é–¢é€£ã®æƒ…å ±ãŒå…¥ã£ã¦ã„ã‚‹ã¨æ€ã‚ã‚Œã¾ã™ã€‚ <code>ioaddr</code>ã¯äº‹å‰ã«stackã«ç¢ºä¿ã—ã¦ã„ã‚‹å‰æã®ã‚ˆã†ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=c><span class=giallo-l><span style=color:#616e88>	/* shared irq? */</span></span>
<span class=giallo-l><span style=color:#81a1c1>	if</span><span style=color:#eceff4> (</span><span style=color:#88c0d0>unlikely</span><span style=color:#eceff4>((</span><span>status </span><span style=color:#81a1c1>&</span><span> rtl8139_intr_mask</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> ==</span><span style=color:#b48ead> 0</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#81a1c1>		goto</span><span> out</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>	handled </span><span style=color:#81a1c1>=</span><span style=color:#b48ead> 1</span><span style=color:#81a1c1>;</span></span></code></pre><p>irq(å‰²è¾¼ã¿ãƒãƒ³ãƒ‰ãƒ©)ã¯ã€å…±æœ‰ã•ã‚Œã†ã‚‹ã®ã§ã€å‡¦ç†ãŒä¸è¦ãªã‚‰return<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=c><span class=giallo-l><span style=color:#616e88>	/* h/w no longer present (hotplug?) or major error, bail */</span></span>
<span class=giallo-l><span style=color:#81a1c1>	if</span><span style=color:#eceff4> (</span><span style=color:#88c0d0>unlikely</span><span style=color:#eceff4>(</span><span>status </span><span style=color:#81a1c1>== 0x</span><span style=color:#b48ead>FFFF</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#81a1c1>		goto</span><span> out</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>	/* close possible race's with dev_close */</span></span>
<span class=giallo-l><span style=color:#81a1c1>	if</span><span style=color:#eceff4> (</span><span style=color:#88c0d0>unlikely</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>!</span><span style=color:#88c0d0>netif_running</span><span style=color:#eceff4>(</span><span>dev</span><span style=color:#eceff4>))) {</span></span>
<span class=giallo-l><span style=color:#88c0d0>		RTL_W16</span><span style=color:#eceff4> (</span><span>IntrMask</span><span style=color:#eceff4>,</span><span style=color:#b48ead> 0</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>		goto</span><span> out</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>	}</span></span></code></pre><p>å‡¦ç†ã‚’ç¶™ç¶šã§ãã‚‹ã‹ã®ç¢ºèªã¨æ€ã‚ã‚Œã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=c><span class=giallo-l><span>	ackstat </span><span style=color:#81a1c1>=</span><span> status </span><span style=color:#81a1c1>& ~</span><span style=color:#eceff4>(</span><span>RxAckBits </span><span style=color:#81a1c1>|</span><span> TxErr</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>	if</span><span style=color:#eceff4> (</span><span>ackstat</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#88c0d0>		RTL_W16</span><span style=color:#eceff4> (</span><span>IntrStatus</span><span style=color:#eceff4>,</span><span> ackstat</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span></code></pre><p>å‰²è¾¼ã¿è¦å› ã®ã‚¯ãƒªã‚¢ã€‚<code>RxAckBits</code>ã¨<code>TxErr</code>ã¯ã“ã®ã‚ã¨ã®å‡¦ç†ã§å‚ç…§ã™ã‚‹ã®ã§ãã‚Œä»¥å¤–ã®ACKå‡¦ç†ã§ã—ã‚‡ã†ã‹ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=c><span class=giallo-l><span style=color:#616e88>	/* Receive packets are processed by poll routine.</span></span>
<span class=giallo-l><span style=color:#616e88>	   If not running start it now. */</span></span>
<span class=giallo-l><span style=color:#81a1c1>	if</span><span style=color:#eceff4> (</span><span>status </span><span style=color:#81a1c1>&</span><span> RxAckBits</span><span style=color:#eceff4>){</span></span>
<span class=giallo-l><span style=color:#81a1c1>		if</span><span style=color:#eceff4> (</span><span style=color:#88c0d0>napi_schedule_prep</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>tp</span><span style=color:#81a1c1>-></span><span>napi</span><span style=color:#eceff4>)) {</span></span>
<span class=giallo-l><span style=color:#88c0d0>			RTL_W16_F</span><span style=color:#eceff4> (</span><span>IntrMask</span><span style=color:#eceff4>,</span><span> rtl8139_norx_intr_mask</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#88c0d0>			__napi_schedule</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>tp</span><span style=color:#81a1c1>-></span><span>napi</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>		}</span></span>
<span class=giallo-l><span style=color:#eceff4>	}</span></span></code></pre><p>å—ä¿¡å‡¦ç†ã¯ã€<a href=https://docs.kernel.org/networking/napi.html rel=external><code>NAPI</code></a> ã¨ã„ã†ä»•çµ„ã¿ã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ã‚‰ã—ãã€å‡¦ç†ã‚’ç§»è­²<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=c><span class=giallo-l><span style=color:#616e88>	/* Check uncommon events with one test. */</span></span>
<span class=giallo-l><span style=color:#81a1c1>	if</span><span style=color:#eceff4> (</span><span style=color:#88c0d0>unlikely</span><span style=color:#eceff4>(</span><span>status </span><span style=color:#81a1c1>&</span><span style=color:#eceff4> (</span><span>PCIErr </span><span style=color:#81a1c1>|</span><span> PCSTimeout </span><span style=color:#81a1c1>|</span><span> RxUnderrun </span><span style=color:#81a1c1>|</span><span> RxErr</span><span style=color:#eceff4>)))</span></span>
<span class=giallo-l><span style=color:#88c0d0>		rtl8139_weird_interrupt</span><span style=color:#eceff4> (</span><span>dev</span><span style=color:#eceff4>,</span><span> tp</span><span style=color:#eceff4>,</span><span> ioaddr</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>					 status</span><span style=color:#eceff4>,</span><span> link_changed</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span></code></pre><p>Uncommonãªå‰²è¾¼ã¿ã‚’å‡¦ç†<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=c><span class=giallo-l><span style=color:#81a1c1>	if</span><span style=color:#eceff4> (</span><span>status </span><span style=color:#81a1c1>&</span><span style=color:#eceff4> (</span><span>TxOK </span><span style=color:#81a1c1>|</span><span> TxErr</span><span style=color:#eceff4>)) {</span></span>
<span class=giallo-l><span style=color:#88c0d0>		rtl8139_tx_interrupt</span><span style=color:#eceff4> (</span><span>dev</span><span style=color:#eceff4>,</span><span> tp</span><span style=color:#eceff4>,</span><span> ioaddr</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>		if</span><span style=color:#eceff4> (</span><span>status </span><span style=color:#81a1c1>&</span><span> TxErr</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#88c0d0>			RTL_W16</span><span style=color:#eceff4> (</span><span>IntrStatus</span><span style=color:#eceff4>,</span><span> TxErr</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>	}</span></span>
<span class=giallo-l><span> out:</span></span>
<span class=giallo-l><span style=color:#88c0d0>	spin_unlock</span><span style=color:#eceff4> (</span><span style=color:#81a1c1>&</span><span>tp</span><span style=color:#81a1c1>-></span><span>lock</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>	netdev_dbg</span><span style=color:#eceff4>(</span><span>dev</span><span style=color:#eceff4>, "</span><span style=color:#a3be8c>exiting interrupt, intr_status=%#4.4x</span><span style=color:#ebcb8b>\n</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#88c0d0>		   RTL_R16</span><span style=color:#eceff4>(</span><span>IntrStatus</span><span style=color:#eceff4>))</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>	return</span><span style=color:#88c0d0> IRQ_RETVAL</span><span style=color:#eceff4>(</span><span>handled</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>}</span></span></code></pre><p>é€ä¿¡ãŒå®Œäº†ã—ã¦ã„ãŸå ´åˆã®å¾Œå‡¦ç†ã¨locké–‹æ”¾ã€‚ ã¨ã„ã†ã“ã¨ã§é›°å›²æ°—ã§ã™ãŒã©ã‚“ãªã“ã¨ã‚’ã—ã¦ã„ã‚‹ã®ã‹ã‚ã‹ã‚Šã¾ã—ãŸã€‚<p>ã¾ãŸã€å‰²è¾¼ã¿å‡¦ç†ã§ã¯æœ€ä½é™ã®å‡¦ç†ã‚’è¡Œã„ã€æ®‹ã‚Šã®å‡¦ç†ã‚’åˆ¥ã®æ©Ÿæ§‹ã«ã¾ã‹ã›ã‚‹ä»•çµ„ã¿ã¨ã—ã¦ã€<code>tasklet</code>ã¨<code>workqueue</code>ã®ç´¹ä»‹ã‚‚ã‚ã‚Šã¾ã—ãŸã€‚ å‰²è¾¼ã¿å‡¦ç†ã«ã¤ã„ã¦ã¯ã€<a href=https://www.valinux.co.jp/blog/entry/202406132 rel=external>æ–°Linuxã‚«ãƒ¼ãƒãƒ«è§£èª­å®¤ - ã‚½ãƒ•ãƒˆå‰²ã‚Šè¾¼ã¿å‡¦ç†</a>ã‚„ã€<a href=https://www.valinux.co.jp/blog/entry/20251106 rel=external>æ–°Linuxã‚«ãƒ¼ãƒãƒ«è§£èª­å®¤ - Workqueue</a>ã®è§£èª¬ã‚‚éå¸¸ã«ã‚ã‚ŠãŒãŸã‹ã£ãŸã§ã™ã€‚<h2 id=di-12zhang-pci><a aria-label="Anchor link for: di-12zhang-pci" class=zola-anchor href=#di-12zhang-pci>ç¬¬12ç«  PCI</a></h2><p>PCIãƒ‡ãƒã‚¤ã‚¹ã¨ãƒ‰ãƒ©ã‚¤ãƒã®å¯¾å¿œé–¢ä¿‚ã®èª¿ã¹æ–¹ã‹ã‚‰å§‹ã¾ã‚Šã¾ã™ã€‚ è©¦ã—ã«ã€Wi-Fiã®ãƒ‰ãƒ©ã‚¤ãƒã‚’èª¿ã¹ã¦ã¿ã‚‹ã¨<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#616e88># -k   Show kernel drivers handling each device and also kernel modules capable of handling it.</span></span>
<span class=giallo-l><span style=color:#616e88># -nn  Show PCI vendor and device codes as both numbers and names.</span></span>
<span class=giallo-l><span style=color:#88c0d0>lspci</span><span style=color:#a3be8c> -knn</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> rg</span><span style=color:#a3be8c> -i</span><span style=color:#eceff4> '</span><span style=color:#a3be8c>wireless network</span><span style=color:#eceff4>'</span><span style=color:#a3be8c> -A</span><span style=color:#b48ead> 3</span></span>
<span class=giallo-l><span style=color:#88c0d0>pcilib:</span><span style=color:#a3be8c> Error reading /sys/bus/pci/devices/0000:00:08.3/label: Operation not permitted</span></span>
<span class=giallo-l><span style=color:#88c0d0>01:00.0</span><span style=color:#a3be8c> Network controller</span><span> [0280]: MEDIATEK Corp. MT7922 802.11ax PCI Express Wireless Network Adapter </span><span style=color:#eceff4>[</span><span>14c3:0616</span><span style=color:#eceff4>]</span><span> (</span><span style=color:#88c0d0>rev</span><span style=color:#b48ead> 02</span><span>)</span></span>
<span class=giallo-l><span style=color:#88c0d0>        Subsystem:</span><span style=color:#a3be8c> MEDIATEK Corp. Device</span><span> [14c3:223c]</span></span>
<span class=giallo-l><span style=color:#88c0d0>        Kernel</span><span style=color:#a3be8c> driver in use: mt7921e</span></span>
<span class=giallo-l><span style=color:#88c0d0>        Kernel</span><span style=color:#a3be8c> modules: mt7921e</span></span></code></pre><blockquote><p>Wireless Network Adapter [14c3:0616] ã‹ã‚‰VendorIDãŒ<code>14c3</code> ã§device codeãŒ<code>0616</code>ã¨ã‚ã‹ã‚Šã¾ã—ãŸã€‚ ã¾ãŸã€moduleã¯<code>mt7921e</code>ãŒåˆ©ç”¨ã•ã‚Œã¦ã„ã‚‹ã®ã§ kernelã®<code> drivers/net/wireless/mediatek/mt76/mt7921/Makefile</code>ã‚’ã¿ã¦ã¿ã‚‹ã¨</blockquote><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=make><span class=giallo-l><span style=color:#616e88># ...</span></span>
<span class=giallo-l><span>obj-</span><span style=color:#81a1c1>$(</span><span>CONFIG_MT7921E</span><span style=color:#81a1c1>)</span><span style=color:#eceff4> +=</span><span> mt7921e.o</span></span>
<span class=giallo-l><span style=color:#616e88># ...</span></span>
<span class=giallo-l><span>mt7921e-y</span><span style=color:#eceff4> :=</span><span> pci.o pci_mac.o pci_mcu.o</span></span></code></pre><p>ã¨<code>mt7921e</code> ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒå®šç¾©ã•ã‚Œã¦ãŠã‚Šã€ãƒ‰ãƒ©ã‚¤ãƒå´ã§å¯¾å¿œã™ã‚‹ãƒ‡ãƒã‚¤ã‚¹ã‚’å®£è¨€ã™ã‚‹<code>pci_device_id[]</code>ã‚’ã¿ã‚‹ã¨<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>rg</span><span style=color:#eceff4> '</span><span style=color:#a3be8c>static const struct pci_device_id mt7921_pci_device_table</span><span style=color:#eceff4>'</span><span style=color:#a3be8c> -A</span><span style=color:#b48ead> 15</span><span style=color:#a3be8c> drivers/net/wireless/mediatek/mt76/mt7921/pci.c</span></span>
<span class=giallo-l><span style=color:#88c0d0>16:static</span><span style=color:#a3be8c> const struct pci_device_id mt7921_pci_device_table[] = {</span></span>
<span class=giallo-l><span style=color:#88c0d0>17-</span><span style=color:#a3be8c>     { PCI_DEVICE</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>PCI_VENDOR_ID_MEDIATEK,</span><span style=color:#b48ead> 0x7961</span><span style=color:#eceff4>)</span><span style=color:#a3be8c>,</span></span>
<span class=giallo-l><span style=color:#88c0d0>18-</span><span style=color:#a3be8c>             .driver_data =</span><span> (kernel_ulong_t)MT7921_FIRMWARE_WM },</span></span>
<span class=giallo-l><span style=color:#88c0d0>19-</span><span style=color:#a3be8c>     { PCI_DEVICE</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>PCI_VENDOR_ID_MEDIATEK,</span><span style=color:#b48ead> 0x7922</span><span style=color:#eceff4>)</span><span style=color:#a3be8c>,</span></span>
<span class=giallo-l><span style=color:#88c0d0>20-</span><span style=color:#a3be8c>             .driver_data =</span><span> (kernel_ulong_t)MT7922_FIRMWARE_WM },</span></span>
<span class=giallo-l><span style=color:#88c0d0>21-</span><span style=color:#a3be8c>     { PCI_DEVICE</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>PCI_VENDOR_ID_ITTIM,</span><span style=color:#b48ead> 0x7922</span><span style=color:#eceff4>)</span><span style=color:#a3be8c>,</span></span>
<span class=giallo-l><span style=color:#88c0d0>22-</span><span style=color:#a3be8c>             .driver_data =</span><span> (kernel_ulong_t)MT7922_FIRMWARE_WM },</span></span>
<span class=giallo-l><span style=color:#88c0d0>23-</span><span style=color:#a3be8c>     { PCI_DEVICE</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>PCI_VENDOR_ID_MEDIATEK,</span><span style=color:#b48ead> 0x0608</span><span style=color:#eceff4>)</span><span style=color:#a3be8c>,</span></span>
<span class=giallo-l><span style=color:#88c0d0>24-</span><span style=color:#a3be8c>             .driver_data =</span><span> (kernel_ulong_t)MT7921_FIRMWARE_WM },</span></span>
<span class=giallo-l><span style=color:#88c0d0>25-</span><span style=color:#a3be8c>     { PCI_DEVICE</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>PCI_VENDOR_ID_MEDIATEK,</span><span style=color:#b48ead> 0x0616</span><span style=color:#eceff4>)</span><span style=color:#a3be8c>,</span></span>
<span class=giallo-l><span style=color:#88c0d0>26-</span><span style=color:#a3be8c>             .driver_data =</span><span> (kernel_ulong_t)MT7922_FIRMWARE_WM },</span></span>
<span class=giallo-l><span style=color:#88c0d0>27-</span><span style=color:#a3be8c>     { PCI_DEVICE</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>PCI_VENDOR_ID_MEDIATEK,</span><span style=color:#b48ead> 0x7920</span><span style=color:#eceff4>)</span><span style=color:#a3be8c>,</span></span>
<span class=giallo-l><span style=color:#88c0d0>28-</span><span style=color:#a3be8c>             .driver_data =</span><span> (kernel_ulong_t)MT7920_FIRMWARE_WM },</span></span>
<span class=giallo-l><span style=color:#88c0d0>29-</span><span style=color:#a3be8c>     { },</span></span>
<span class=giallo-l><span style=color:#88c0d0>30-}</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#88c0d0>31-</span></span></code></pre><p>ã¨å®šç¾©ã•ã‚Œã¦ãŠã‚Šã€<code>include/linux/pci_ids.h</code>ã«<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=c><span class=giallo-l><span style=color:#5e81ac;font-weight:700>#</span><span style=color:#81a1c1>define</span><span style=color:#88c0d0> PCI_VENDOR_ID_MEDIATEK</span><span style=color:#81a1c1>		0x</span><span style=color:#b48ead>14c3</span></span></code></pre><p>ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚ã¾ãŸã€<code>pci_device_id</code>ã¯<code>include/linux/mod_devicetable.h</code>ã«ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=c><span class=giallo-l><span style=color:#81a1c1>struct</span><span> pci_device_id </span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span>	__u32 vendor</span><span style=color:#eceff4>,</span><span> device</span><span style=color:#81a1c1>;</span><span style=color:#616e88>		/* Vendor and device ID or PCI_ANY_ID*/</span></span>
<span class=giallo-l><span>	__u32 subvendor</span><span style=color:#eceff4>,</span><span> subdevice</span><span style=color:#81a1c1>;</span><span style=color:#616e88>	/* Subsystem ID's or PCI_ANY_ID */</span></span>
<span class=giallo-l><span>	__u32 class</span><span style=color:#eceff4>,</span><span> class_mask</span><span style=color:#81a1c1>;</span><span style=color:#616e88>	/* (class,subclass,prog-if) triplet */</span></span>
<span class=giallo-l><span style=color:#8fbcbb>	kernel_ulong_t</span><span> driver_data</span><span style=color:#81a1c1>;</span><span style=color:#616e88>	/* Data private to the driver */</span></span>
<span class=giallo-l><span>	__u32 override_only</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span><span style=color:#81a1c1>;</span></span></code></pre><p>ã“ã“ã‹ã‚‰<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>25-     { PCI_DEVICE(PCI_VENDOR_ID_MEDIATEK, 0x0616),</span></span>
<span class=giallo-l><span>26-             .driver_data = (kernel_ulong_t)MT7922_FIRMWARE_WM },</span></span></code></pre><p>ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãŒlspciã®<code>Wireless Network Adapter [14c3:0616]</code>ã«å¯¾å¿œã—ã¦ã„ãã†ãªã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚ (æœ¬æ›¸ã®ãŠã‹ã’ã§ãƒ‰ãƒ©ã‚¤ãƒã®ã‚³ãƒ¼ãƒ‰ã¡ã‚‡ã£ã¨è¦‹ã¦ã¿ã‚ˆã†ã¨ã„ã†æ°—æŒã¡ã«ãªã‚ŒãŸã®ãŒã†ã‚Œã—ã„ã§ã™ã€‚)<p>ã“ã®ã‚ã¨ã€MMIO, I/Oãƒãƒ¼ãƒˆã€PCIã‚³ãƒ³ãƒ•ã‚£ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç©ºé–“ã®è©³ã—ã„è§£èª¬ãŒç¶šãã¾ã™ã€‚<p>PCIãƒ‰ãƒ©ã‚¤ãƒã®å…·ä½“ä¾‹ã¨ã—ã¦ã€<code>8139too.c</code>ã®è§£èª¬ãŒã‚ã‚Šã¾ã™ã€‚ PCIãƒ‰ãƒ©ã‚¤ãƒã®åŸºæœ¬çš„ãªå‡¦ç†ã¨ã—ã¦ã€ãƒ‡ãƒã‚¤ã‚¹ã®ãƒ¬ã‚¸ã‚¹ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã«ã€PCIã‚³ãƒ³ãƒ•ã‚£ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç©ºé–“ã‹ã‚‰BARæƒ…å ±ã‚’å–å¾—ã—ã¦ã€<code>ioremap()</code>(BARã¯ç‰©ç†ã‚¢ãƒ‰ãƒ¬ã‚¹ãªã®ã§ãã®ã¾ã¾ã§ã¯ä»®æƒ³ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ã‹ã‚‰)ã™ã‚‹ã¨ã“ã‚Œã¾ã§ã®èª¬æ˜ã§ã‚ã‹ã‚Šã¾ã—ãŸã€‚ãã“ã§ã€<code>8139too.c</code>ã®å®Ÿè£…ã‚’ã¿ã¦ã¿ã‚‹ã¨<p><code>drivers/net/ethernet/realtek/8139too.c</code><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=c><span class=giallo-l><span style=color:#81a1c1>static struct</span><span> net_device </span><span style=color:#81a1c1>*</span><span style=color:#88c0d0>rtl8139_init_board</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>struct</span><span> pci_dev </span><span style=color:#81a1c1>*</span><span>pdev</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>	struct</span><span> device </span><span style=color:#81a1c1>*</span><span>d </span><span style=color:#81a1c1>= &</span><span>pdev</span><span style=color:#81a1c1>-></span><span>dev</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>	void</span><span> __iomem </span><span style=color:#81a1c1>*</span><span>ioaddr</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>	struct</span><span> net_device </span><span style=color:#81a1c1>*</span><span>dev</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>	struct</span><span> rtl8139_private </span><span style=color:#81a1c1>*</span><span>tp</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>	unsigned int</span><span> i</span><span style=color:#eceff4>,</span><span> bar</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>  /* omitted... */</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>	ioaddr </span><span style=color:#81a1c1>=</span><span style=color:#88c0d0> pci_iomap</span><span style=color:#eceff4>(</span><span>pdev</span><span style=color:#eceff4>,</span><span> bar</span><span style=color:#eceff4>,</span><span style=color:#b48ead> 0</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>	if</span><span style=color:#eceff4> (</span><span style=color:#81a1c1>!</span><span>ioaddr</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#616e88>    /* omitted... */</span></span>
<span class=giallo-l><span>		rc </span><span style=color:#81a1c1>= -</span><span>ENODEV</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>		goto</span><span> err_out</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>	}</span></span>
<span class=giallo-l><span>	tp</span><span style=color:#81a1c1>-></span><span>regs_len</span><span style=color:#81a1c1> =</span><span> io_len</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>	tp</span><span style=color:#81a1c1>-></span><span>mmio_addr</span><span style=color:#81a1c1> =</span><span> ioaddr</span><span style=color:#81a1c1>;</span></span></code></pre><p>ã¨<code>pci_iomap()</code>ã‚’åˆ©ç”¨ã—ã¦ãŠã‚Šã€<code>drivers/pci/iomap.c</code>ã‚’ã¿ã¦ã¿ã‚‹ã¨<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=c><span class=giallo-l><span style=color:#81a1c1>void</span><span> __iomem </span><span style=color:#81a1c1>*</span><span style=color:#88c0d0>pci_iomap</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>struct</span><span> pci_dev </span><span style=color:#81a1c1>*</span><span>dev</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> int</span><span> bar</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> unsigned long</span><span> maxlen</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>	return</span><span style=color:#88c0d0> pci_iomap_range</span><span style=color:#eceff4>(</span><span>dev</span><span style=color:#eceff4>,</span><span> bar</span><span style=color:#eceff4>,</span><span style=color:#b48ead> 0</span><span style=color:#eceff4>,</span><span> maxlen</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l><span style=color:#88c0d0>EXPORT_SYMBOL</span><span style=color:#eceff4>(</span><span>pci_iomap</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>void</span><span> __iomem </span><span style=color:#81a1c1>*</span><span style=color:#88c0d0>pci_iomap_range</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>struct</span><span> pci_dev </span><span style=color:#81a1c1>*</span><span>dev</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>			      int</span><span> bar</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>			      unsigned long</span><span> offset</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>			      unsigned long</span><span> maxlen</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#8fbcbb>	resource_size_t</span><span> start</span><span style=color:#eceff4>,</span><span> len</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>	unsigned long</span><span> flags</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>	if</span><span style=color:#eceff4> (</span><span style=color:#81a1c1>!</span><span style=color:#88c0d0>pci_bar_index_is_valid</span><span style=color:#eceff4>(</span><span>bar</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#81a1c1>		return NULL;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>	start </span><span style=color:#81a1c1>=</span><span style=color:#88c0d0> pci_resource_start</span><span style=color:#eceff4>(</span><span>dev</span><span style=color:#eceff4>,</span><span> bar</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>	len </span><span style=color:#81a1c1>=</span><span style=color:#88c0d0> pci_resource_len</span><span style=color:#eceff4>(</span><span>dev</span><span style=color:#eceff4>,</span><span> bar</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>	flags </span><span style=color:#81a1c1>=</span><span style=color:#88c0d0> pci_resource_flags</span><span style=color:#eceff4>(</span><span>dev</span><span style=color:#eceff4>,</span><span> bar</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>	if</span><span style=color:#eceff4> (</span><span>len </span><span style=color:#81a1c1>&lt;=</span><span> offset </span><span style=color:#81a1c1>|| !</span><span>start</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>		return NULL;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>	len </span><span style=color:#81a1c1>-=</span><span> offset</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span>	start </span><span style=color:#81a1c1>+=</span><span> offset</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>	if</span><span style=color:#eceff4> (</span><span>maxlen </span><span style=color:#81a1c1>&&</span><span> len </span><span style=color:#81a1c1>></span><span> maxlen</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span>		len </span><span style=color:#81a1c1>=</span><span> maxlen</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>	if</span><span style=color:#eceff4> (</span><span>flags </span><span style=color:#81a1c1>&</span><span> IORESOURCE_IO</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>		return</span><span style=color:#88c0d0> __pci_ioport_map</span><span style=color:#eceff4>(</span><span>dev</span><span style=color:#eceff4>,</span><span> start</span><span style=color:#eceff4>,</span><span> len</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>	if</span><span style=color:#eceff4> (</span><span>flags </span><span style=color:#81a1c1>&</span><span> IORESOURCE_MEM</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>		return</span><span style=color:#88c0d0> ioremap</span><span style=color:#eceff4>(</span><span>start</span><span style=color:#eceff4>,</span><span> len</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#616e88>	/* What? */</span></span>
<span class=giallo-l><span style=color:#81a1c1>	return NULL;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l><span style=color:#88c0d0>EXPORT_SYMBOL</span><span style=color:#eceff4>(</span><span>pci_iomap_range</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span></span></code></pre><p>ã¨<code>pci_resource_{start,len}</code>ã§BARã‚’å–å¾—ã—ã€MMIO,I/Oãƒãƒ¼ãƒˆã‚’åˆ¤å®šã—ã¦ã€<code>ioremap()</code>ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã—ãŸã€‚<p>ã“ã“ã¾ã§ã¯ã€PCIã®è©±ã§ã—ãŸãŒã€PCI Expressã‚‚èª¬æ˜ã•ã‚Œã¦ãŠã‚Šã©ã†ã„ã£ãŸæ‹¡å¼µãŒã‚ã£ãŸã®ã‹ã®è§£èª¬ãŒã‚ã‚Šã¾ã™ã€‚<h2 id=di-13zhang-siriarubasu><a aria-label="Anchor link for: di-13zhang-siriarubasu" class=zola-anchor href=#di-13zhang-siriarubasu>ç¬¬13ç«  ã‚·ãƒªã‚¢ãƒ«ãƒã‚¹</a></h2><p>I2C(SMBus)ã«ã¤ã„ã¦ã€‚ ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã®æ¦‚è¦ã‚„ã€ãƒã‚¹åˆ¶å¾¡æ–¹æ³•ã®èª¬æ˜ãŒã‚ã‚Šã¾ã™ã€‚è‡ªåˆ†ã¯çµ„ã¿è¾¼ã¿ã«é¦´æŸ“ã¿ãŒãªã„ã®ã§ã€ã“ã®ã‚ãŸã‚Šã®è§£èª¬ã¯éå¸¸ã«å‚è€ƒã«ãªã‚Šã¾ã—ãŸã€‚ ã¾ãŸã€lm_sensorsãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®èª¬æ˜ã‚‚ã‚ã‚Šã¾ã™ã€‚ å®Ÿè£…ã«ã¤ã„ã¦ã¯ã€kernelã®I2CãŒ<code>i2c-dev</code>, <code>i2c-core</code>, <code>i2c-algo</code>, i2c adapterã¨ã„ã£ãŸãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¹ã‚¿ãƒƒã‚¯ã‹ã‚‰ãªã‚‹ã¨ã„ã£ãŸè§£èª¬ãŒã‚ã‚Šã¾ã™ã€‚<h2 id=di-14zhang-acpi><a aria-label="Anchor link for: di-14zhang-acpi" class=zola-anchor href=#di-14zhang-acpi>ç¬¬14ç«  ACPI</a></h2><p>ACPI(Advanced Configuration and Power Interface)ã«ã¤ã„ã¦ã€‚ ACPIã¯é›»æºç®¡ç†ã ã‘ã§ãªãã€èµ·å‹•æ™‚ã« kernelãŒPCIeã‚’åˆ©ç”¨å¯èƒ½ã«ã™ã‚‹åˆæœŸåŒ–(ãƒ›ã‚¹ãƒˆå´ã®èªè­˜ã‚„è¨­å®šç©ºé–“ã‚¢ã‚¯ã‚»ã‚¹ã®æº–å‚™)ã«ã‚‚é–¢ä¸ã™ã‚‹ã‚‰ã—ã„ã€‚ é›»æºãƒœã‚¿ãƒ³æŠ¼ä¸‹ã‚‚ ACPI çµŒç”±ã§é€šçŸ¥ã•ã‚Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ç©ºé–“ã®ãƒãƒªã‚·ãƒ¼ã«å¾“ã£ã¦ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ç­‰ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã€‚<h2 id=di-15zhang-ipmi><a aria-label="Anchor link for: di-15zhang-ipmi" class=zola-anchor href=#di-15zhang-ipmi>ç¬¬15ç«  IPMI</a></h2><p>IPMI(Intelligent Platform Management Interface)ã«ã¤ã„ã¦ã€‚ ã“ã¡ã‚‰ã¯æ™®æ®µé–¢ã‚ã‚ŠãŒãªã„ã®ã§å‰²æ„›ã—ã¾ã—ãŸã€‚(74pç¨‹åº¦ã¨ã—ã£ã‹ã‚Šè§£èª¬ãŒã‚ã‚Šã¾ã™)<h2 id=di-16zhang-tesutotodebatugu><a aria-label="Anchor link for: di-16zhang-tesutotodebatugu" class=zola-anchor href=#di-16zhang-tesutotodebatugu>ç¬¬16ç«  ãƒ†ã‚¹ãƒˆã¨ãƒ‡ãƒãƒƒã‚°</a></h2><p>Kernelãƒ“ãƒ«ãƒ‰æ™‚ã®ãƒ•ãƒ©ã‚°ã‚„<code>printk</code>ã‚„Magic SysRqã‚­ãƒ¼ã€Oopsãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã¤ã„ã¦ã®è§£èª¬ãŒã‚ã‚Šã¾ã™ã€‚<h2 id=di-17zhang-doraibashe-ji-toshi-zhuang-noshi-ji><a aria-label="Anchor link for: di-17zhang-doraibashe-ji-toshi-zhuang-noshi-ji" class=zola-anchor href=#di-17zhang-doraibashe-ji-toshi-zhuang-noshi-ji>ç¬¬17ç«  ãƒ‰ãƒ©ã‚¤ãƒè¨­è¨ˆã¨å®Ÿè£…ã®å®Ÿéš›</a></h2><p><code>drivers/net/8139too.c</code>(ä»Šã ã¨<code>drivers/net/ethernet/realtek/8139too.c</code>)ã‚’ä¾‹ã«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ‰ãƒ©ã‚¤ãƒã®å®Ÿè£…ã®è§£èª¬ãŒã‚ã‚Šã¾ã™ã€‚<h2 id=matome><a aria-label="Anchor link for: matome" class=zola-anchor href=#matome>ã¾ã¨ã‚</a></h2><p>Rustã®sample driverã®ã‚³ãƒ¼ãƒ‰èª­ã‚€ãŸã‚ã«èª­ã‚“ã§ã¿ã¾ã—ãŸãŒã€ãƒ‰ãƒ©ã‚¤ãƒã«é™ã‚‰ãšå‚è€ƒã«ãªã‚‹ç‚¹ãŒå¤šãéå¸¸ã«ãŠã‚‚ã—ã‚ã‹ã£ãŸã§ã™ã€‚Kernelã«é–¢ã™ã‚‹æœ¬ã¯æœ€è¿‘<a href=https://www.oreilly.co.jp/books/9784814401109/ rel=external>Linuxã‚«ãƒ¼ãƒãƒ«ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ç¬¬2ç‰ˆ</a>ãŒå‡ºç‰ˆã•ã‚Œã¾ã—ãŸãŒã€ä¸€æ™‚æœŸé€”çµ¶ãˆã¦ã„ãŸå°è±¡ãŒã‚ã‚Šã€2000å¹´ä»£ã«å¤šãå‡ºç‰ˆã•ã‚Œã¦ã„ã‚‹å°è±¡ãŒã‚ã‚Šã¾ã™ã€‚(è‹±èªã ã¨ãŸãã•ã‚“ã‚ã‚Šã¾ã™ãŒ)<p>æœ¬æ›¸ã‚’èª­ã‚€ã«ã‚ãŸã‚Šã€<a href=https://www.amazon.com/Linux-Device-Driver-Development-development/dp/1803240067 rel=external>Linux Device Driver Development: Everything you need to start with device driver development for Linux kernel and embedded Linux, 2nd Edition</a>, <a href=https://techbookfest.org/product/h9vV6JbABCHD6CurWp7ers rel=external>ã‚«ãƒ¼ãƒãƒ«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆã§å­¦ã¶Linuxã‚«ãƒ¼ãƒãƒ«é–‹ç™ºã®åŸºç¤çŸ¥è­˜ï¼šç¬¬3ç‰ˆ</a>,<a href=https://techbookfest.org/product/5742284180029440 rel=external>Linuxã‚«ãƒ¼ãƒãƒ«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è‡ªä½œå…¥é–€</a>ç­‰ã‚’å‚è€ƒã«ã•ã›ã¦ã„ãŸã ãã¾ã—ãŸã€‚</div></article></main><footer class=blog-footer><p>Â© 2026 <a href=https://blog.ymgyt.io> ymgyt </a> | Made with <a href=https://www.getzola.org rel=noopener target=_blank>Zola</a> | <a href=https://github.com/ymgyt/blog>Repository</a> | <a href=https://blog.ymgyt.io/atom.xml target=_blank title=rss> <svg viewbox="0 0 24 24" class=icon fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx=5 cy=19 r=1></circle></svg> </a></footer></div></div>