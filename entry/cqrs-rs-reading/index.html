<!doctype html><html lang=ja><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1" name=viewport><link href=https://blog.ymgyt.io/favicon.ico rel=icon sizes=any><link href=https://blog.ymgyt.io/icon.svg rel=icon type=image/svg+xml><link href=https://blog.ymgyt.io/apple-touch-icon.png rel=apple-touch-icon><link href=https://blog.ymgyt.io/manifest.webmanifest rel=manifest><link href=https://blog.ymgyt.io/style.css rel=stylesheet><link href=https://blog.ymgyt.io/atom.xml rel=alternate title=Atom type=application/atom+xml><script src="https://www.googletagmanager.com/gtag/js?id=G-GTB0KMLN90" async></script><script>window.dataLayer = window.dataLayer || [];
	function gtag() {dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-GTB0KMLN90');</script><title>ğŸ“¥ cqrs-esã‹ã‚‰ã¿ã‚‹Rustã®CQRS & Event Sourceã®å®Ÿè£… | Happy developing</title><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><body><div class=world><div class=content-container><header class=blog-header-container><div class=blog-logo><a href=https://blog.ymgyt.io>Happy developing</a></div><div class=blog-nav><nav><ul><li><a href=https://blog.ymgyt.io/entry/>Entries</a><li><a href=https://blog.ymgyt.io/tags/>Tags</a><li><a href=https://blog.ymgyt.io/about/>About</a><li><a href=https://github.com/ymgyt> <img alt=Github class=icon src=https://blog.ymgyt.io/images/icon/github.svg> </a><li><a href="https://twitter.com/YAmaguchixt "> <img alt=Twitter class=icon src=https://blog.ymgyt.io/images/icon/twitter.svg> </a></ul></nav></div></header><main class=blog-main><article><header class=entry-header><h1 class=entry-title>ğŸ“¥ cqrs-esã‹ã‚‰ã¿ã‚‹Rustã®CQRS & Event Sourceã®å®Ÿè£…</h1><div class=entry-meta><p class=entry-meta-item>ğŸ—“ 2022-10-15<p class=entry-meta-item>ğŸ· <span class=tag><a href=https://blog.ymgyt.io/tags/rust/>rust</a></span></div></header><aside class=entry-toc><nav><ul class=entry-toc-toplevel-list><li><a href=https://blog.ymgyt.io/entry/cqrs-rs-reading/#yong-yu>ç”¨èª</a><li><a href=https://blog.ymgyt.io/entry/cqrs-rs-reading/#gai-yao>æ¦‚è¦</a> <ul><li><a href=https://blog.ymgyt.io/entry/cqrs-rs-reading/#aggregate>Aggregate</a><li><a href=https://blog.ymgyt.io/entry/cqrs-rs-reading/#command>Command</a><li><a href=https://blog.ymgyt.io/entry/cqrs-rs-reading/#event>Event</a><li><a href=https://blog.ymgyt.io/entry/cqrs-rs-reading/#1-execute>1 execute</a><li><a href=https://blog.ymgyt.io/entry/cqrs-rs-reading/#3-apply>3 apply</a><li><a href=https://blog.ymgyt.io/entry/cqrs-rs-reading/#4-handle>4 handle</a></ul><li><a href=https://blog.ymgyt.io/entry/cqrs-rs-reading/#cqrsframework-components-diagram>CQRSFramework Components Diagram</a><li><a href=https://blog.ymgyt.io/entry/cqrs-rs-reading/#cqrsframework-execute-with-metadata-sequence-diagram>CQRSFramework execute_with_metadata Sequence Diagram</a> <ul><li><a href=https://blog.ymgyt.io/entry/cqrs-rs-reading/#serializedevent>SerializedEvent</a><li><a href=https://blog.ymgyt.io/entry/cqrs-rs-reading/#event-upcast>event_upcast</a><li><a href=https://blog.ymgyt.io/entry/cqrs-rs-reading/#events-table>events table</a><li><a href=https://blog.ymgyt.io/entry/cqrs-rs-reading/#eventenvelope>EventEnvelope</a><li><a href=https://blog.ymgyt.io/entry/cqrs-rs-reading/#cqrs-init>Cqrs init</a></ul><li><a href=https://blog.ymgyt.io/entry/cqrs-rs-reading/#genericquery-component-diagram>GenericQuery Component Diagram</a><li><a href=https://blog.ymgyt.io/entry/cqrs-rs-reading/#genericquery-dispatch-sequence-diagram>GenericQuery dispatch Sequence Diagram</a><li><a href=https://blog.ymgyt.io/entry/cqrs-rs-reading/#test>Test</a><li><a href=https://blog.ymgyt.io/entry/cqrs-rs-reading/#wakatuteinaikoto>ã‚ã‹ã£ã¦ã„ãªã„ã“ã¨</a><li><a href=https://blog.ymgyt.io/entry/cqrs-rs-reading/#yu-tan>ä½™è«‡</a><li><a href=https://blog.ymgyt.io/entry/cqrs-rs-reading/#zi-fen-deshi-sitagan-xiang>è‡ªåˆ†ã§è©¦ã—ãŸæ„Ÿæƒ³</a><li><a href=https://blog.ymgyt.io/entry/cqrs-rs-reading/#matome>ã¾ã¨ã‚</a><li><a href=https://blog.ymgyt.io/entry/cqrs-rs-reading/#can-kao>å‚è€ƒ</a></ul></nav></aside><div class=entry-content><p>æœ€è¿‘ä¼šç¤¾ã§<a href=https://this-week-in-rust.org/ rel=external>This week in rust</a>ãªã‚‰ã¬This week in fraimã¨ã„ã†ä¼šãŒé€±1ã§è¡Œã‚ã‚Œã‚‹æ§˜ã«ãªã‚Šã¾ã—ãŸã€‚ãã“ã§<a href=https://doc.rust-cqrs.org/intro.html rel=external>CQRS and Event Sourcing using Rust</a>ã¨ã„ã†ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ•™ãˆã¦ã‚‚ã‚‰ã„ã¾ã—ãŸã€‚<br> ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯<a href=https://github.com/serverlesstechnology/cqrs rel=external>cqrs-rs</a>ã¨ã„ã†Rustã®CQRS lightweight frameworkã«ã¤ã„ã¦æ›¸ã‹ã‚Œã¦ãŠã‚Šã€Rustã«ãŠã‘ã‚‹CQRSã®å®Ÿè£…ã®å…·ä½“ä¾‹ã¨ã—ã¦ã¨ã¦ã‚‚å‚è€ƒã«ãªã‚Šã¾ã—ãŸã€‚<br> ãã“ã§æœ¬è¨˜äº‹ã§ã¯ã€cqrs-rsã¨ãƒ‡ãƒ¢å®Ÿè£…ã§ã‚ã‚‹<a href=https://github.com/serverlesstechnology/cqrs-demo rel=external>cqrs-demo</a>ã®ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚“ã§Rustã«ãŠã‘ã‚‹CQRSã®å®Ÿè£…ã‚’è¿½ã£ã¦ã„ãã¾ã™ã€‚<h2 id=yong-yu><a aria-label="Anchor link for: yong-yu" class=zola-anchor href=#yong-yu>ç”¨èª</a></h2><p>æœ¬è¨˜äº‹ã§åˆ©ç”¨ã™ã‚‹ç”¨èªã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã®æ„å‘³ã§åˆ©ç”¨ã—ã¾ã™ã€‚<table><thead><tr><th>ç”¨èª<th>ã“ã“ã§ã®æ„å‘³<tbody><tr><td>CQRS<td>application(domain)ã®modelã‚’writeã¨readã«åˆ†ã‘ã¦ã‚‹ãã‚‰ã„ã®æ„å‘³ã§ã™ã€‚ãã‚Œãã‚Œã®æ°¸ç¶šåŒ–ã«åˆ©ç”¨ã™ã‚‹backendã‚‚ç•°ãªã‚‹å ´åˆã‚‚ã‚ã‚Šã¾ã™ã€‚<tr><td>Aggregate<td>* DDDã«ãŠã‘ã‚‹é›†ç´„ã®Root<br> * é–¢é€£ã™ã‚‹Entityã¨ValueObjectã®é›†åˆã€‚å®Ÿè³ªEntity<br> * å¤‰æ›´ã¯Aggregateã«å¯¾ã—ã¦ã®ã¿Commandã‚’é©ç”¨ã™ã‚‹å½¢ã§ã®ã¿ãªã•ã‚Œã‚‹<tr><td>Command<td>Aggregateã«å¯¾ã™ã‚‹ä½œæˆ/æ›´æ–°ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ<tr><td>Event<td>Aggregateã«å¯¾ã—ã¦Commandã‚’é©ç”¨ã—ãŸçµæœã®è¡¨ç¾</table><h2 id=gai-yao><a aria-label="Anchor link for: gai-yao" class=zola-anchor href=#gai-yao>æ¦‚è¦</a></h2><figure><div class=fig-images-row><img , alt src=images/cqrs_overview.png></div><figcaption>cqrs-rsã®æ¦‚è¦</figcaption></figure><p>å…¨ä½“ã®ç™»å ´äººç‰©ã¨å‡¦ç†ã®æ¦‚è¦ã‚’èª¬æ˜ã—ã¾ã™ã€‚<ol><li>CommandHandlerã¯RESTã®handlerã‚„GraphQLã®resolverã®ã‚ˆã†ã«å¤–éƒ¨ã‹ã‚‰å‡¦ç†ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã†ã‘ã‚‹ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ã™ã€‚cqrs-esã¯ã“ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ç‰¹ã«é–¢ä¸ã—ã¾ã›ã‚“ã€‚<li>EventStoreã¯writeã®æ°¸ç¶šåŒ–å‡¦ç†ã‚’æ‹…ã†ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã™ã€‚EventStoreãŒå‡¦ç†å¯¾è±¡ã®aggregateã«é–¢ã™ã‚‹eventã‚’loadã—ã¦ãã¾ã™ã€‚<li>æ°¸ç¶šåŒ–å±¤ã‹ã‚‰å–å¾—ã—ãŸeventsã‚’aggregateã«é©ç”¨ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚ŠaggregateãŒæœ€æ–°ã®çŠ¶æ…‹ã«ãªã‚Šã¾ã™ã€‚<li>ä½œæˆ/æ›´æ–°ã‚’è¡¨ç¾ã—ãŸCommandã‚’é©ç”¨ã—ã¾ã™ã€‚<li>æˆåŠŸã—ãŸå ´åˆã¯æ–°ã—ã„eventsãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚<li>ç”Ÿæˆã•ã‚ŒãŸeventsã‚’æ°¸ç¶šåŒ–ã—ã¾ã™ã€‚åŒæ™‚ã«ç™ºã›ã‚‰ã‚ŒãŸcommandã®ã‚ˆã†ãªreadModifyWrite(conflict)ã®å‡¦ç†ã¯ã“ã“ã§è¡Œã„ã¾ã™ã€‚<li>æ°¸ç¶šåŒ–ãŒæˆåŠŸã—ãŸeventã‚’é–¢å¿ƒã®ã‚ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«å±Šã‘ã‚‹ãŸã‚ã«dispatchã•ã‚Œã¾ã™ã€‚<li>ä¸€èˆ¬çš„ã«ã¯writeã«å¯¾å¿œã™ã‚‹readã®modelã‚’æ›´æ–°ã™ã‚‹å‡¦ç†ãŒè¡Œã‚ã‚Œã¾ã™<li>Clientã‹ã‚‰ã®Readã®è¦æ±‚ã«å¯¾ã—ã¦æ›´æ–°ã•ã‚ŒãŸviewã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€commandã®é©ç”¨çµæœãŒã¿ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚</ol><p>ä»¥ä¸ŠãŒå‡¦ç†ã®æ¦‚è¦ã«ãªã‚Šã¾ã™ã€‚cqrs-esã¯ã“ã®å‡¦ç†ã®æµã‚Œã‚’æä¾›ã—ã¦ãã‚Œã¾ã™ã€‚applicationå…¨ä½“ã«çµ„ã¿è¾¼ã¾ã‚Œã‚‹ã¨ã„ã†ã‚ˆã‚Šaggregate(domain model)å˜ä½ã§åˆ©ç”¨ã§ãã‚‹ã¨ã“ã‚ãŒlightweightã¨è¨€ã‚ã‚Œã¦ã„ã‚‹ã¨ã“ã‚ãªã®ã‹ãªã¨æ€ã„ã¾ã™ã€‚<h3 id=aggregate><a aria-label="Anchor link for: aggregate" class=zola-anchor href=#aggregate>Aggregate</a></h3><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Serialize</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Deserialize</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> BankAccount</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    account_id</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    balance</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> f64</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/serverlesstechnology/cqrs-demo/blob/424acda6e3256c7967ca0d8cea97fd580617721e/src/domain/aggregate.rs#L10 rel=external>https://github.com/serverlesstechnology/cqrs-demo/blob/424acda6e3256c7967ca0d8cea97fd580617721e/src/domain/aggregate.rs#L10</a><p>cqrs-demoã§åˆ©ç”¨ã•ã‚Œã‚‹aggregateã¯BankAccountã§è­˜åˆ¥å­ã®<code>account_id</code>ã¨commandã«ã‚ˆã£ã¦å¤‰åŒ–ã™ã‚‹<code>balance</code>ã‚’ã‚‚ã£ã¦ãŠã‚Šã€<code>balance</code>ã®å¤‰æ›´ã«ã¯ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ãƒ«ãƒ¼ãƒ«(0ä»¥ä¸‹ã«ãªã‚‰ãªã„ç­‰)ãŒé©ç”¨ã•ã‚Œã¾ã™ã€‚<h3 id=command><a aria-label="Anchor link for: command" class=zola-anchor href=#command>Command</a></h3><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Debug</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Serialize</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Deserialize</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub enum</span><span style=color:#8fbcbb> BankAccountCommand</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    OpenAccount</span><span style=color:#eceff4> {</span><span> account_id</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4> },</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    DepositMoney</span><span style=color:#eceff4> {</span><span> amount</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> f64</span><span style=color:#eceff4> },</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    WithdrawMoney</span><span style=color:#eceff4> {</span><span> amount</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> f64</span><span style=color:#eceff4>,</span><span> atm_id</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4> },</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    WriteCheck</span><span style=color:#eceff4> {</span><span> check_number</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>,</span><span> amount</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> f64</span><span style=color:#eceff4> },</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/serverlesstechnology/cqrs-demo/blob/424acda6e3256c7967ca0d8cea97fd580617721e/src/domain/commands.rs#L4 rel=external>https://github.com/serverlesstechnology/cqrs-demo/blob/424acda6e3256c7967ca0d8cea97fd580617721e/src/domain/commands.rs#L4</a><p><code>BankAccount</code> aggregateã«å¯¾ã™ã‚‹å¤‰æ›´è¦æ±‚ã§ã™ã€‚<br> ä½œæˆã¨balanceã‚’å¤‰æ›´ã™ã‚‹commandãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚<br> enumã‚’ä½¿ã†ã“ã¨ãŒapiã‹ã‚‰å¼·åˆ¶ã•ã‚Œã¾ã™ã€‚<h3 id=event><a aria-label="Anchor link for: event" class=zola-anchor href=#event>Event</a></h3><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Debug</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Clone</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Serialize</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Deserialize</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> PartialEq</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub enum</span><span style=color:#8fbcbb> BankAccountEvent</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    AccountOpened</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>        account_id</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    },</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    CustomerDepositedMoney</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>        amount</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> f64</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        balance</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> f64</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    },</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    CustomerWithdrewCash</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>        amount</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> f64</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        balance</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> f64</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    },</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    CustomerWroteCheck</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>        check_number</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        amount</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> f64</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        balance</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> f64</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    },</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/serverlesstechnology/cqrs-demo/blob/424acda6e3256c7967ca0d8cea97fd580617721e/src/domain/events.rs#L6 rel=external>https://github.com/serverlesstechnology/cqrs-demo/blob/424acda6e3256c7967ca0d8cea97fd580617721e/src/domain/events.rs#L6</a><p><code>BankAccount</code> aggregateã«å¯¾ã—ã¦commandã‚’é©ç”¨ã—ãŸçµæœèµ·ãã‚‹eventã§ã™ã€‚<br> ã“ã“ã§ã¯commandã¨ç™ºç”Ÿã™ã‚‹eventãŒ1:1ã«ãªã£ã¦ã„ã¾ã™ãŒã€commandã«å¯¾ã—ã¦eventãŒç™ºç”Ÿã—ãªã„å ´åˆã‚„è¤‡æ•°èµ·ãã‚‹å ´åˆã‚‚ã‚ã‚Šã¾ã™ã€‚<h3 id=1-execute><a aria-label="Anchor link for: 1-execute" class=zola-anchor href=#1-execute>1 execute</a></h3><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#616e88>// pub type PostgresCqrs&lt;A> = CqrsFramework&lt;A, PersistedEventStore&lt;PostgresEventRepository, A>>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> command_handler</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#88c0d0>    Path</span><span style=color:#eceff4>(</span><span>account_id</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Path</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#88c0d0>    Json</span><span style=color:#eceff4>(</span><span>command</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Json</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>BankAccountCommand</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#88c0d0>    Extension</span><span style=color:#eceff4>(</span><span>cqrs</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Extension</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Arc</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>PostgresCqrs</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>BankAccount</span><span style=color:#eceff4>>>>,</span></span>
<span class=giallo-l><span style=color:#88c0d0>    MetadataExtension</span><span style=color:#eceff4>(</span><span>metadata</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> MetadataExtension</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Response</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    match</span><span> cqrs</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>execute_with_metadata</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>account_id</span><span style=color:#eceff4>,</span><span> command</span><span style=color:#eceff4>,</span><span> metadata</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .await</span></span>
<span class=giallo-l><span style=color:#eceff4>    {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Ok</span><span style=color:#eceff4>(</span><span>_</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> StatusCode</span><span style=color:#81a1c1>::</span><span>NO_CONTENT</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into_response</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Err</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> (</span><span style=color:#8fbcbb>StatusCode</span><span style=color:#81a1c1>::</span><span>BAD_REQUEST</span><span style=color:#eceff4>,</span><span> err</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_string</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into_response</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/serverlesstechnology/cqrs-demo/blob/424acda6e3256c7967ca0d8cea97fd580617721e/src/main.rs#L74 rel=external>https://github.com/serverlesstechnology/cqrs-demo/blob/424acda6e3256c7967ca0d8cea97fd580617721e/src/main.rs#L74</a><p><a href=https://github.com/serverlesstechnology/cqrs-demo/blob/424acda6e3256c7967ca0d8cea97fd580617721e/src/metadata_extension.rs#L15 rel=external>https://github.com/serverlesstechnology/cqrs-demo/blob/424acda6e3256c7967ca0d8cea97fd580617721e/src/metadata_extension.rs#L15</a><p>axumã®handlerã§commandã‚’deserializeã—ã¦aggregate(bank account)ã®cqrs instanceã‚’å‘¼ã³å‡ºã™ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚ ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã«aggregateã®è­˜åˆ¥å­(<code>aggregate_id</code>), command(<code>BankAccountCommand</code>), cqrs instance(<code>PostgresCqrs&lt;BankAccount></code>)ãŒã‚ã‚Œã°ã‚ˆã„ã§ã™ã€‚<p>MetadataExtensionã¯requestã‹ã‚‰Useragentã‚„ç¾åœ¨æ™‚åˆ»ã‚’ä»˜åŠ ã™ã‚‹æƒ…å ±ã§ã™ã€‚<br> writeå±¤ã§æ°¸ç¶šåŒ–ã•ã‚Œã‚‹ã®ã¯ã‚ãã¾ã§eventã§ã™ãŒã€auditã‚„é‹ç”¨ã®è¦³ç‚¹ã‹ã‚‰æ°¸ç¶šåŒ–ã—ãŸã„æƒ…å ±(å‡¦ç†æ™‚åˆ»ã‚„client ipç­‰)ã¯metadataã¨ã—ã¦è¡¨ç¾ã—ã¾ã™ã€‚<h3 id=3-apply><a aria-label="Anchor link for: 3-apply" class=zola-anchor href=#3-apply>3 apply</a></h3><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> cqrs_es</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Aggregate</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[async_trait]</span></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Aggregate</span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> BankAccount</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Command</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> BankAccountCommand</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Event</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> BankAccountEvent</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Error</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> BankAccountError</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Services</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> BankAccountServices</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    // ... </span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> apply</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> event</span><span style=color:#81a1c1>: Self::</span><span style=color:#8fbcbb>Event</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        match</span><span> event</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            BankAccountEvent</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>AccountOpened</span><span style=color:#eceff4> {</span><span> account_id</span><span style=color:#eceff4> }</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span>account_id </span><span style=color:#81a1c1>=</span><span> account_id</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            BankAccountEvent</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>CustomerDepositedMoney</span><span style=color:#eceff4> {</span><span> amount</span><span style=color:#81a1c1>:</span><span> _</span><span style=color:#eceff4>,</span><span> balance</span><span style=color:#eceff4> }</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span>balance </span><span style=color:#81a1c1>=</span><span> balance</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            BankAccountEvent</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>CustomerWithdrewCash</span><span style=color:#eceff4> {</span><span> amount</span><span style=color:#81a1c1>:</span><span> _</span><span style=color:#eceff4>,</span><span> balance</span><span style=color:#eceff4> }</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span>balance </span><span style=color:#81a1c1>=</span><span> balance</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            BankAccountEvent</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>CustomerWroteCheck</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                check_number</span><span style=color:#81a1c1>:</span><span> _</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>                amount</span><span style=color:#81a1c1>:</span><span> _</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>                balance</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span>balance </span><span style=color:#81a1c1>=</span><span> balance</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/serverlesstechnology/cqrs-demo/blob/424acda6e3256c7967ca0d8cea97fd580617721e/src/domain/aggregate.rs#L88 rel=external>https://github.com/serverlesstechnology/cqrs-demo/blob/424acda6e3256c7967ca0d8cea97fd580617721e/src/domain/aggregate.rs#L88</a><p>Eventã‚’aggregateã«é©ç”¨ã—ã¦ã€çŠ¶æ…‹ã‚’æ›´æ–°ã™ã‚‹ã€‚ã‚¨ãƒ©ãƒ¼ã¯è¿”ã›ãªã„ã®ã§çµ¶å¯¾ã«æˆåŠŸã™ã‚‹ã€‚ cqrs frameworkãŒéå»ã®eventã§applyã‚’å‘¼ã‚“ã§ãã‚Œã‚‹ã®ã§aggregateã¯æœ€æ–°ã®çŠ¶æ…‹ã«ãªã‚‹ã€‚<br> ã¾ãŸã€å„aggregateã¯<code>cqrs_es::Aggregate</code>ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ãŒè¦æ±‚ã•ã‚Œã€ãã®ä¸­ã§Command, Event,Error, Servicesã‚’ãã‚Œãã‚Œassociate typeã§æŒ‡å®šã™ã‚‹ã€‚<br> Commandã¨Eventã¯ã“ã‚Œã¾ã§è¿°ã¹ã¦ããŸã‚‚ã®ã§ã€Errorã¯commandé©ç”¨æ™‚ã«ç™ºç”Ÿã™ã‚‹ã‚¨ãƒ©ãƒ¼ã€‚Servicesã¯Commandé©ç”¨æ™‚ã®ä¾å­˜(api callç­‰)ã€‚<h3 id=4-handle><a aria-label="Anchor link for: 4-handle" class=zola-anchor href=#4-handle>4 handle</a></h3><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[async_trait]</span></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Aggregate</span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> BankAccount</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span style=color:#81a1c1>    async fn</span><span style=color:#88c0d0> handle</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#81a1c1>        &self</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        command</span><span style=color:#81a1c1>: Self::</span><span style=color:#8fbcbb>Command</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        services</span><span style=color:#81a1c1>: &Self::</span><span style=color:#8fbcbb>Services</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    )</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Vec</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>Self::</span><span style=color:#8fbcbb>Event</span><span style=color:#eceff4>>,</span><span style=color:#81a1c1> Self::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        match</span><span> command</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            BankAccountCommand</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>OpenAccount</span><span style=color:#eceff4> {</span><span> account_id</span><span style=color:#eceff4> }</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Ok</span><span style=color:#eceff4>(</span><span style=color:#88c0d0;font-weight:700>vec!</span><span style=color:#eceff4>[</span><span style=color:#8fbcbb>BankAccountEvent</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>AccountOpened</span><span style=color:#eceff4> {</span><span> account_id</span><span style=color:#eceff4> }])</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            BankAccountCommand</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>DepositMoney</span><span style=color:#eceff4> {</span><span> amount</span><span style=color:#eceff4> }</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                let</span><span> balance</span><span style=color:#81a1c1> = self.</span><span>balance </span><span style=color:#81a1c1>+</span><span> amount</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Ok</span><span style=color:#eceff4>(</span><span style=color:#88c0d0;font-weight:700>vec!</span><span style=color:#eceff4>[</span><span style=color:#8fbcbb>BankAccountEvent</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>CustomerDepositedMoney</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                    amount</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>                    balance</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>                }])</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            BankAccountCommand</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>WithdrawMoney</span><span style=color:#eceff4> {</span><span> amount</span><span style=color:#eceff4>,</span><span> atm_id</span><span style=color:#eceff4> }</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                let</span><span> balance</span><span style=color:#81a1c1> = self.</span><span>balance </span><span style=color:#81a1c1>-</span><span> amount</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>                if</span><span> balance</span><span style=color:#81a1c1> &lt;</span><span style=color:#b48ead> 0_</span><span style=color:#8fbcbb>f64</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    return</span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>funds not available</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#81a1c1>                if</span><span> services</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    .</span><span>services</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    .</span><span style=color:#88c0d0>atm_withdrawal</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>atm_id</span><span style=color:#eceff4>,</span><span> amount</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    .await</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    .</span><span style=color:#88c0d0>is_err</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>                {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    return</span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>atm rule violation</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#eceff4>                };</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Ok</span><span style=color:#eceff4>(</span><span style=color:#88c0d0;font-weight:700>vec!</span><span style=color:#eceff4>[</span><span style=color:#8fbcbb>BankAccountEvent</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>CustomerWithdrewCash</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                    amount</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>                    balance</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>                }])</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            BankAccountCommand</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>WriteCheck</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                check_number</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>                amount</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                let</span><span> balance</span><span style=color:#81a1c1> = self.</span><span>balance </span><span style=color:#81a1c1>-</span><span> amount</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>                if</span><span> balance</span><span style=color:#81a1c1> &lt;</span><span style=color:#b48ead> 0_</span><span style=color:#8fbcbb>f64</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    return</span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>funds not available</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#81a1c1>                if</span><span> services</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    .</span><span>services</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    .</span><span style=color:#88c0d0>validate_check</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self.</span><span>account_id</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> &</span><span>check_number</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    .await</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    .</span><span style=color:#88c0d0>is_err</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>                {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    return</span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>check invalid</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#eceff4>                };</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Ok</span><span style=color:#eceff4>(</span><span style=color:#88c0d0;font-weight:700>vec!</span><span style=color:#eceff4>[</span><span style=color:#8fbcbb>BankAccountEvent</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>CustomerWroteCheck</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                    check_number</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>                    amount</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>                    balance</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>                }])</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span></code></pre><p><a href=https://github.com/serverlesstechnology/cqrs-demo/blob/424acda6e3256c7967ca0d8cea97fd580617721e/src/domain/aggregate.rs#L29 rel=external>https://github.com/serverlesstechnology/cqrs-demo/blob/424acda6e3256c7967ca0d8cea97fd580617721e/src/domain/aggregate.rs#L29</a><p>æœ€æ–°ã®aggregateã«å¯¾ã—ã¦commandã‚’handleã™ã‚‹ã“ã¨ã§eventã‚’ç®—å‡ºã™ã‚‹å‡¦ç†ã€‚å¼•æ•°ã¯<code>&self</code> ãªã®ã§aggregateè‡ªèº«ã®çŠ¶æ…‹ã¯æ›´æ–°ã§ããšæ›´æ–°ã¯eventã§è¡¨ç¾ã™ã‚‹ã€‚<h2 id=cqrsframework-components-diagram><a aria-label="Anchor link for: cqrsframework-components-diagram" class=zola-anchor href=#cqrsframework-components-diagram>CQRSFramework Components Diagram</a></h2><figure><div class=fig-images-row><img , alt src=images/cqrs_component_diagram.png></div><figcaption>Component diagram</figcaption></figure><p>1aggregateã‚’æ‹…å½“ã™ã‚‹<code>CqrsFramework</code>ã®componenté–“ã®æ¦‚è¦ã€‚<ul><li>ãƒ¦ãƒ¼ã‚¶ãŒå®Ÿè£…ã™ã‚‹ã®ã¯ <ul><li><code>DynamoEventRepository</code> <code>PosgresEventRepository</code> ã¨ã„ã£ãŸæ°¸ç¶šåŒ–å±¤ã‹ã‚‰event(SerializedEvent)ã®record/itemã‚’å–å¾—ã™ã‚‹å‡¦ç† <ul><li>Dynamo, Postgres, MySqlã®å®Ÿè£…ã¯cqrsã®åˆ¥ãƒªãƒã‚¸ãƒˆãƒªã§ç”¨æ„ã•ã‚Œã¦ã„ã‚‹ã€‚</ul><li><code>Query</code> commitã•ã‚Œã¦æ°¸ç¶šåŒ–ã«æˆåŠŸã—ãŸeventã‚’åæ˜ ã•ã›ã‚‹å‡¦ç†</ul><li>cqrs instanceã®åˆæœŸåŒ–å‡¦ç† <ul><li><a href=https://github.com/serverlesstechnology/cqrs-demo/blob/424acda6e3256c7967ca0d8cea97fd580617721e/src/config.rs rel=external>https://github.com/serverlesstechnology/cqrs-demo/blob/424acda6e3256c7967ca0d8cea97fd580617721e/src/config.rs</a></ul></ul><h2 id=cqrsframework-execute-with-metadata-sequence-diagram><a aria-label="Anchor link for: cqrsframework-execute-with-metadata-sequence-diagram" class=zola-anchor href=#cqrsframework-execute-with-metadata-sequence-diagram>CQRSFramework execute_with_metadata Sequence Diagram</a></h2><figure><div class=fig-images-row><img , alt src=images/cqrs_execute_sequence_diagram.png></div><figcaption>Sequence diagram</figcaption></figure><p>ãƒ¦ãƒ¼ã‚¶ã¯aggregateã«å¯¾ã—ã¦ã®applyã¨handleã‚’å®šç¾©ã™ã‚Œã°ã‚ã¨ã®å–ã‚Šå›ã—ã¯frameworkå´ãŒè¡Œã£ã¦ãã‚Œã‚‹ã€‚<br> ãŸã ã—ã€EventRepositoryã®å®Ÿè£…ã§eventã®conflictã‚’å‡¦ç†ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚<h3 id=serializedevent><a aria-label="Anchor link for: serializedevent" class=zola-anchor href=#serializedevent>SerializedEvent</a></h3><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Clone</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Debug</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> PartialEq</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Eq</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> SerializedEvent</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>    /// The id of the aggregate instance.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> aggregate_id</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#616e88>    /// The sequence number of the event for this aggregate instance.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> sequence</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> usize</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#616e88>    /// The type of aggregate the event applies to.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> aggregate_type</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#616e88>    /// The type of event that is serialized.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> event_type</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#616e88>    /// The version of event that is serialized.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> event_version</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#616e88>    /// The serialized domain event.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> payload</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Value</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#616e88>    /// Additional metadata, serialized from a HashMap&lt;String,String>.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> metadata</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Value</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/serverlesstechnology/cqrs/blob/master/src/persist/serialized_event.rs#L11 rel=external>https://github.com/serverlesstechnology/cqrs/blob/master/src/persist/serialized_event.rs#L11</a><p>å„ç¨®Eventã‚’ç›´æ¥serializeã™ã‚‹ã®ã§ã¯ãªãã€<code>SerializedEvent</code>ã¨ã„ã†ä¸­é–“è¡¨ç¾ã«ã—ã¦å–ã‚Šå›ã™ã€‚<br> ã—ãŸãŒã£ã¦ã€writeã®æ°¸ç¶šåŒ–ã§ã¯modelã”ã¨ã«table(collection)ã‚’åˆ†ã‘ã‚‹ã®ã§ã¯ãªãä¸€ã¤ã®tableã§ã™ã¹ã¦ã®modelã®eventã‚’æ°¸ç¶šåŒ–ã§ãã‚‹ã€‚(åˆ†ã‘ã‚ˆã†ã¨æ€ãˆã°åˆ†ã‘ã‚Œã‚‹)<h3 id=event-upcast><a aria-label="Anchor link for: event-upcast" class=zola-anchor href=#event-upcast>event_upcast</a></h3><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>pub trait</span><span style=color:#8fbcbb;font-weight:700> EventUpcaster</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Send</span><span style=color:#81a1c1> +</span><span style=color:#8fbcbb> Sync</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>    /// Examines and event type and version to understand if the event should be upcasted.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> can_upcast</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> event_type</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>str</span><span style=color:#eceff4>,</span><span> event_version</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>str</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> bool</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    /// Modifies the serialized event to conform the the new structure.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> upcast</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> event</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> SerializedEvent</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> SerializedEvent</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>pub</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>crate</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> fn</span><span style=color:#88c0d0> deserialize_events</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>A</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Aggregate</span><span style=color:#eceff4>>(</span></span>
<span class=giallo-l><span>    events</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Vec</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>SerializedEvent</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>    upcasters</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Vec</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Box</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>dyn</span><span style=color:#8fbcbb> EventUpcaster</span><span style=color:#eceff4>>>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Vec</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>EventEnvelope</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>A</span><span style=color:#eceff4>>>,</span><span style=color:#8fbcbb> PersistenceError</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> result</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Vec</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>EventEnvelope</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>A</span><span style=color:#eceff4>>></span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Default</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>    for</span><span> event</span><span style=color:#81a1c1> in</span><span> events</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> upcasted_event</span><span style=color:#81a1c1> = match</span><span> upcasters</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            None</span><span style=color:#81a1c1> =></span><span> event</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Some</span><span style=color:#eceff4>(</span><span>upcasters</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                let mut</span><span> upcasted_event</span><span style=color:#81a1c1> =</span><span> event</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>                for</span><span> upcaster</span><span style=color:#81a1c1> in</span><span> upcasters</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    if</span><span> upcaster</span></span>
<span class=giallo-l><span style=color:#81a1c1>                        .</span><span style=color:#88c0d0>can_upcast</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>upcasted_event</span><span style=color:#81a1c1>.</span><span>event_type</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> &</span><span>upcasted_event</span><span style=color:#81a1c1>.</span><span>event_version</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>                    {</span></span>
<span class=giallo-l><span>                        upcasted_event</span><span style=color:#81a1c1> =</span><span> upcaster</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>upcast</span><span style=color:#eceff4>(</span><span>upcasted_event</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>                    }</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span>                upcasted_event</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        };</span></span>
<span class=giallo-l><span>        result</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>push</span><span style=color:#eceff4>(</span><span>EventEnvelope</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>A</span><span style=color:#eceff4>></span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>try_from</span><span style=color:#eceff4>(</span><span>upcasted_event</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Ok</span><span style=color:#eceff4>(</span><span>result</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>// impl example</span></span>
<span class=giallo-l><span style=color:#616e88>/*</span></span>
<span class=giallo-l><span style=color:#616e88>{</span></span>
<span class=giallo-l><span style=color:#616e88>  "UpdateAddress": {</span></span>
<span class=giallo-l><span style=color:#616e88>    "address": "912 Spring St",</span></span>
<span class=giallo-l><span style=color:#616e88>    "city": "Seattle",</span></span>
<span class=giallo-l><span style=color:#616e88>    "state": "WA"</span></span>
<span class=giallo-l><span style=color:#616e88>  }</span></span>
<span class=giallo-l><span style=color:#616e88>}</span></span>
<span class=giallo-l><span style=color:#616e88>*/</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>let</span><span> upcaster</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> SemanticVersionEventUpcaster</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>UpdateAddress</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>0.3.0</span><span style=color:#eceff4>",</span><span> Box</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>my_upcaster</span><span style=color:#eceff4>));</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> my_upcast_fn</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>mut</span><span> payload</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Value</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Value</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    match</span><span> payload</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>get_mut</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>UpdateAddress</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Value</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Object</span><span style=color:#eceff4>(</span><span>object</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            object</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>insert</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>state</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_string</span><span style=color:#eceff4>(),</span><span> Value</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>String</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>WA</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_string</span><span style=color:#eceff4>()));</span></span>
<span class=giallo-l><span>            payload</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span>        _</span><span style=color:#81a1c1> =></span><span style=color:#88c0d0;font-weight:700> panic!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>invalid payload encountered</span><span style=color:#eceff4>"),</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/serverlesstechnology/cqrs/blob/master/src/persist/serialized_event.rs#L61 rel=external>https://github.com/serverlesstechnology/cqrs/blob/master/src/persist/serialized_event.rs#L61</a><p><a href=https://doc.rust-cqrs.org/advanced_event_upcasters.html rel=external>https://doc.rust-cqrs.org/advanced_event_upcasters.html</a><p>applicationã‚’é‹ç”¨ã—ã¦ã„ãä¸­ã§Eventã«fieldã‚’è¿½åŠ ã—ãŸããªã‚‹å ´åˆã®æ©Ÿæ§‹ã€‚enumãªã®ã§ã€UpdateAddress,UpdateAddressV2ã®ã‚ˆã†ã«variantã‚’å¢—ã‚„ã™ã“ã¨ã‚‚ã§ãã‚‹ãŒãã†ã§ã¯ãªãã€<code>SerializedEvent</code>ã‚’deserializeã™ã‚‹éš›ã«ç›´æ¥å€¤ã‚’åŠ å·¥ã™ã‚‹ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒç”¨æ„ã•ã‚Œã¦ã„ã‚‹ã€‚<br> ã“ã®ã‚ãŸã‚Šã®è€ƒæ…®ã¯CQRSç‹¬è‡ªã®ã‚‚ã®ã ã¨æ€ã„ã¾ã—ãŸã€‚<h3 id=events-table><a aria-label="Anchor link for: events-table" class=zola-anchor href=#events-table>events table</a></h3><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=sql><span class=giallo-l><span style=color:#81a1c1>CREATE TABLE</span><span style=color:#88c0d0> events</span></span>
<span class=giallo-l><span>(</span></span>
<span class=giallo-l><span>    aggregate_type </span><span style=color:#81a1c1>text                         NOT NULL</span><span>,</span></span>
<span class=giallo-l><span>    aggregate_id   </span><span style=color:#81a1c1>text                         NOT NULL</span><span>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>    sequence       bigint CHECK</span><span> (</span><span style=color:#81a1c1>sequence >=</span><span style=color:#b48ead> 0</span><span>) </span><span style=color:#81a1c1>NOT NULL</span><span>,</span></span>
<span class=giallo-l><span>    event_type     </span><span style=color:#81a1c1>text                         NOT NULL</span><span>,</span></span>
<span class=giallo-l><span>    event_version  </span><span style=color:#81a1c1>text                         NOT NULL</span><span>,</span></span>
<span class=giallo-l><span>    payload        </span><span style=color:#81a1c1>json                         NOT NULL</span><span>,</span></span>
<span class=giallo-l><span>    metadata       </span><span style=color:#81a1c1>json                         NOT NULL</span><span>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>    PRIMARY KEY</span><span> (aggregate_type, aggregate_id, </span><span style=color:#81a1c1>sequence</span><span>)</span></span>
<span class=giallo-l><span>);</span></span></code></pre><p>å…·ä½“ä¾‹ã¨ã—ã¦<code>SerializedEvent</code>ã‚’æ°¸ç¶šåŒ–ã™ã‚‹å ´åˆã®DDLã€‚<br> aggregate_type, aggregate_id, sequenceã«å¯¾ã—ã¦primary key(=ä¸€æ„æ€§åˆ¶ç´„)ãŒè²¼ã£ã¦ã‚ã‚‹ã®ã§ã€ç«¶åˆã™ã‚‹eventã®æ›¸ãè¾¼ã¿ãŒã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã€‚<br> ã“ã®ã‚ˆã†ã«æ°¸ç¶šåŒ–å±¤ã«ä¸€æ„æ€§åˆ¶ç´„ãŒä»˜ä¸ã§ãã‚Œã°å®Ÿè£…ã¯ã¨ã¦ã‚‚æ¥½ã«ãªã‚‹ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> From</span><span style=color:#eceff4>&lt;</span><span>sqlx</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>></span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> PostgresAggregateError</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> from</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#81a1c1>:</span><span> sqlx</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>        // TODO: improve error handling</span></span>
<span class=giallo-l><span style=color:#81a1c1>        match &</span><span>err</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Error</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Database</span><span style=color:#eceff4>(</span><span>database_error</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                if let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>code</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> database_error</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>code</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    if</span><span> code</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_ref</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> ==</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>23505</span><span style=color:#eceff4>" {</span><span style=color:#616e88> // 23505ã¯Postgresã«ãŠã‘ã‚‹ä¸€æ„æ€§åˆ¶ç´„é•å</span></span>
<span class=giallo-l><span style=color:#81a1c1>                        return</span><span style=color:#8fbcbb> PostgresAggregateError</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>OptimisticLock</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>                    }</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                PostgresAggregateError</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>UnknownError</span><span style=color:#eceff4>(</span><span>Box</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Error</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Io</span><span style=color:#eceff4>(</span><span>_</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> |</span><span style=color:#8fbcbb> Error</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Tls</span><span style=color:#eceff4>(</span><span>_</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> PostgresAggregateError</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>ConnectionError</span><span style=color:#eceff4>(</span><span>Box</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#eceff4>)),</span></span>
<span class=giallo-l><span>            _</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> PostgresAggregateError</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>UnknownError</span><span style=color:#eceff4>(</span><span>Box</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#eceff4>)),</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ãƒ‡ãƒ¢ã§ã¯Postgresã®ä¸€æ„æ€§åˆ¶ç´„é•åã‚’ãã®ã¾ã¾åˆ©ç”¨ã—ã¦ã„ãŸã€‚<br> Eventsã®æ›¸ãè¾¼ã¿ç«¶åˆã‚’Postgresã®æ©Ÿèƒ½ã§è§£æ±ºã—ã¦ã„ã‚‹ã®ã§CqrsFrameworkã¨ã—ã¦ã¯EventRepositoryã®å®Ÿè£…ã«ç«¶åˆã®è§£æ±ºã‚’å§”ã­ã¦ã„ã‚‹ã€‚<p><a href=https://github.com/serverlesstechnology/postgres-es/blob/f99103368850689313b9b06a5c8762f4bc619ff2/src/error.rs#L28 rel=external>https://github.com/serverlesstechnology/postgres-es/blob/f99103368850689313b9b06a5c8762f4bc619ff2/src/error.rs#L28</a><h3 id=eventenvelope><a aria-label="Anchor link for: eventenvelope" class=zola-anchor href=#eventenvelope>EventEnvelope</a></h3><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> EventEnvelope</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>A</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    A</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Aggregate</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#616e88>    /// The id of the aggregate instance.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> aggregate_id</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#616e88>    /// The sequence number for an aggregate instance.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> sequence</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> usize</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#616e88>    /// The event payload with all business information.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> payload</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> A</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Event</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#616e88>    /// Additional metadata for use in auditing, logging or debugging purposes.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> metadata</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> HashMap</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/serverlesstechnology/cqrs/blob/master/src/event.rs#L61 rel=external>https://github.com/serverlesstechnology/cqrs/blob/master/src/event.rs#L61</a><p>Eventã®æ°¸ç¶šåŒ–ãŒæˆåŠŸã™ã‚‹ã¨å„Queryã«æ¸¡ã•ã‚Œã‚‹Eventã€‚metadataã‚„sequenceã‚’æ¸¡ã™ãŸã‚ã«<code>EventEnvelope</code>ã¨ã—ã¦wrapã•ã‚Œã¦ã„ã‚‹ã€‚<br> <code>HashMap&lt;String,String></code>ãªã®ã§ä½•ãŒå…¥ã£ã¦ã„ã‚‹ã‹å‹ã§è¡¨ç¾ã§ããªã„ã€‚ã“ã®ã‚ãŸã‚ŠãŒopinionatedãªã¨ã“ã‚ãªã®ã‹ãªã¨æ€ã£ãŸã€‚<h3 id=cqrs-init><a aria-label="Anchor link for: cqrs-init" class=zola-anchor href=#cqrs-init>Cqrs init</a></h3><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>pub fn</span><span style=color:#88c0d0> cqrs_framework</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>    pool</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Pool</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Postgres</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#eceff4> (</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Arc</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>PostgresCqrs</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>BankAccount</span><span style=color:#eceff4>>>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Arc</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>PostgresViewRepository</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>BankAccountView</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> BankAccount</span><span style=color:#eceff4>>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#616e88>    // A very simple query that writes each event to stdout.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> simple_query</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> SimpleLoggingQuery</span><span style=color:#eceff4> {};</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    // A query that stores the current state of an individual account.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> account_view_repo</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Arc</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>PostgresViewRepository</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>account_query</span><span style=color:#eceff4>",</span><span> pool</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>()));</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> account_query</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> AccountQuery</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>account_view_repo</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    // Without a query error handler there will be no indication if an</span></span>
<span class=giallo-l><span style=color:#616e88>    // error occurs (e.g., database connection failure, missing columns or table).</span></span>
<span class=giallo-l><span style=color:#616e88>    // Consider logging an error or panicking in your own application.</span></span>
<span class=giallo-l><span>    account_query</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>use_error_handler</span><span style=color:#eceff4>(</span><span>Box</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>e</span><span style=color:#81a1c1>|</span><span style=color:#88c0d0;font-weight:700> println!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{}</span><span style=color:#eceff4>",</span><span> e</span><span style=color:#eceff4>)));</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    // Create and return an event-sourced `CqrsFramework`.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> queries</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Vec</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Box</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>dyn</span><span style=color:#8fbcbb> Query</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>BankAccount</span><span style=color:#eceff4>>>></span><span style=color:#81a1c1> =</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>        vec!</span><span style=color:#eceff4>[</span><span style=color:#8fbcbb>Box</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>simple_query</span><span style=color:#eceff4>),</span><span style=color:#8fbcbb> Box</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>account_query</span><span style=color:#eceff4>)];</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> services</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> BankAccountServices</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>Box</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>HappyPathBankAccountServices</span><span style=color:#eceff4>));</span></span>
<span class=giallo-l><span style=color:#eceff4>    (</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Arc</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>postgres_es</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>postgres_cqrs</span><span style=color:#eceff4>(</span><span>pool</span><span style=color:#eceff4>,</span><span> queries</span><span style=color:#eceff4>,</span><span> services</span><span style=color:#eceff4>)),</span></span>
<span class=giallo-l><span>        account_view_repo</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    )</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/serverlesstechnology/cqrs-demo/blob/master/src/config.rs rel=external>https://github.com/serverlesstechnology/cqrs-demo/blob/master/src/config.rs</a><p>ã‚ã‹ã‚Šã«ãã„ãŒã€cqrs instanceã®åˆæœŸåŒ–å‡¦ç†ã€‚viewã¨queryã§åŒã˜å®Ÿè£…ã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ã®ã§åŒã˜å‡¦ç†ã§constructã—ã¦ã„ã‚‹ã€‚<h2 id=genericquery-component-diagram><a aria-label="Anchor link for: genericquery-component-diagram" class=zola-anchor href=#genericquery-component-diagram>GenericQuery Component Diagram</a></h2><figure><div class=fig-images-row><img , alt src=images/cqrs_generic_query_component_diagram.png></div><figcaption>Component diagram</figcaption></figure><p>Aggregateã‚’æ›´æ–°ã—ãŸå¾Œã«å¯¾å¿œã™ã‚‹viewã‚’æ›´æ–°ã™ã‚‹å‡¦ç†ã¯ä¸€èˆ¬çš„ãªãƒ•ãƒ­ãƒ¼ãªã®ã§ã€ãã®ãŸã‚ã®æ±ç”¨çš„ãªå‡¦ç†ã¯<code>GenericQuery</code>ã¨ã—ã¦æä¾›ã•ã‚Œã¦ã„ã‚‹ã€‚<h2 id=genericquery-dispatch-sequence-diagram><a aria-label="Anchor link for: genericquery-dispatch-sequence-diagram" class=zola-anchor href=#genericquery-dispatch-sequence-diagram>GenericQuery dispatch Sequence Diagram</a></h2><figure><div class=fig-images-row><img , alt src=images/cqrs_generic_query_dispatch_sequence_diagram.png></div><figcaption>Sequence diagram</figcaption></figure><p>ã“ã“ã§ã‚‚ãƒ¦ãƒ¼ã‚¶ã¯viewã®å–å¾—ã¨æ›´æ–°å‡¦ç†ã€æ°¸ç¶šåŒ–ã‚’ãã‚Œãã‚Œå®Ÿè£…ã—ã¦ãŠã‘ã°ã‚ˆã„ã€‚<br> é›£ã—ã„ã®ãŒã€<code>Query::dispatch</code>ã¯ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã›ãªã„ã®ã§ã€viewã®æ›´æ–°ã«å¤±æ•—ã—ã¦ã‚‚commandã®å‡¦ç†è‡ªä½“ã¯å®Œçµã—ã¦ã„ã‚‹ã®ã§ã€retryã—ãªã„é™ã‚Šwriteã¨readã§æ•´åˆæ€§ãŒã¨ã‚Œãªããªã£ã¦ã—ã¾ã†ã€‚<h2 id=test><a aria-label="Anchor link for: test" class=zola-anchor href=#test>Test</a></h2><p>ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ãƒ«ãƒ¼ãƒ«ã¯Eventã®é©ç”¨ã¨Commandã®å‡¦ç†ã«é›†ç´„ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€éå»ã®eventsã¨ç¾åœ¨ã®commandã«å¯¾ã—ã¦å‡ºåŠ›ã•ã‚Œã‚‹eventsã®å½¢ã§ã™ã¹ã¦å®šç¾©ã§ãã‚‹ã€‚ãã®ãŸã‚ã®test helperã‚‚ç”¨æ„ã•ã‚Œã¦ã„ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[cfg(test)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>mod</span><span> tests</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    use</span><span> cqrs_es</span><span style=color:#81a1c1>::</span><span>test</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>TestFramework</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    use super::*</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    use crate::</span><span>domain</span><span style=color:#81a1c1>::</span><span>services</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>MockUserApi</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> UserTestFramework</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> TestFramework</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>User</span><span style=color:#eceff4>>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>    #[test]</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> create_user</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> services</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> UserServices</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>Box</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>MockUserApi</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>()));</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> command</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> UserCommand</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>CreateUser</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            user_id</span><span style=color:#81a1c1>:</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>Xxx</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>            email</span><span style=color:#81a1c1>:</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>xxx@ymgyt.io</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>        };</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> expected</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> UserCreatedEvent</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            user_id</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> UserId</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>try_from</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Xxx</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>            email</span><span style=color:#81a1c1>:</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>xxx@ymgyt.io</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>parse</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>            user_status</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> UserStatus</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Active</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>        };</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        UserTestFramework</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>with</span><span style=color:#eceff4>(</span><span>services</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>given_no_previous_events</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>when</span><span style=color:#eceff4>(</span><span>command</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>then_expect_events</span><span style=color:#eceff4>(</span><span style=color:#88c0d0;font-weight:700>vec!</span><span style=color:#eceff4>[</span><span>expected</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>()])</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>    #[test]</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> test_deactivate</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> services</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> UserServices</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>Box</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>MockUserApi</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>()));</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> previous</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> UserCreatedEvent</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            user_id</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> UserId</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>try_from</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Xxx</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>            email</span><span style=color:#81a1c1>:</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>xxx@ymgyt.io</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>parse</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>            user_status</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> UserStatus</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Active</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>        };</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> command</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> UserCommand</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>DeactivateUser</span><span style=color:#eceff4> {};</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> expected</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> UserDeactivatedEvent</span><span style=color:#eceff4> {};</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        UserTestFramework</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>with</span><span style=color:#eceff4>(</span><span>services</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>given</span><span style=color:#eceff4>(</span><span style=color:#88c0d0;font-weight:700>vec!</span><span style=color:#eceff4>[</span><span>previous</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>()])</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>when</span><span style=color:#eceff4>(</span><span>command</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>then_expect_events</span><span style=color:#eceff4>(</span><span style=color:#88c0d0;font-weight:700>vec!</span><span style=color:#eceff4>[</span><span>expected</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>()])</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><ul><li>éå»ã®event, serviceã®mock, é©ç”¨ã•ã‚Œã‚‹commandã‹ã‚‰æœŸå¾…é€šã‚Šã®eventãŒè¿”ã•ã‚Œã‚‹ã‹ã®testãŒunit testã§æ›¸ã‘ã‚‹ã€‚ <ul><li>å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã®å‘¼ã³å‡ºã—ã¯mockã‚’æ›¸ãå¿…è¦ã¯ã‚ã‚‹</ul><li><code>cqrs_es::test::TestFramework</code> ãŒç”¨æ„ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€eventã®applyã‚„commandã®handleã¾ã‚ã‚Šã‚’æ›¸ã‹ãªãã¦ã‚ˆã„ã€‚</ul><h2 id=wakatuteinaikoto><a aria-label="Anchor link for: wakatuteinaikoto" class=zola-anchor href=#wakatuteinaikoto>ã‚ã‹ã£ã¦ã„ãªã„ã“ã¨</a></h2><p>å®Ÿè£…ä¸Šã¯Snapshoté–¢é€£ã®è¨˜è¿°ãŒã‚ã‚‹ã‚‚ã®ã®ã€demoã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã§ã¯ã§ã¦ã“ãªã‹ã£ãŸ(ã¨æ€ã‚ã‚Œã‚‹)ã®ã§ã€ã©ã®ã‚ˆã†ã«æ´»ç”¨ã™ã‚‹ã‹ç†è§£ã§ããªã‹ã£ãŸã€‚<h2 id=yu-tan><a aria-label="Anchor link for: yu-tan" class=zola-anchor href=#yu-tan>ä½™è«‡</a></h2><p>SourceOfTruthã¨ã„ã†å‹åãŒã‹ã£ã“ã„ã„ã¨æ€ã£ãŸ<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>enum</span><span style=color:#8fbcbb> SourceOfTruth</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    EventStore</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#88c0d0>    Snapshot</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>usize</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    AggregateStore</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://docs.rs/cqrs-es/latest/src/cqrs_es/persist/event_store.rs.html#13 rel=external>https://docs.rs/cqrs-es/latest/src/cqrs_es/persist/event_store.rs.html#13</a><h2 id=zi-fen-deshi-sitagan-xiang><a aria-label="Anchor link for: zi-fen-deshi-sitagan-xiang" class=zola-anchor href=#zi-fen-deshi-sitagan-xiang>è‡ªåˆ†ã§è©¦ã—ãŸæ„Ÿæƒ³</a></h2><ul><li>Frameworkã¨ã„ã„ã¤ã¤ã€applicationå…¨ä½“ã‚’åˆ¶å¾¡ã™ã‚‹ã‚‚ã®ã§ãªã„ã®ã§å‰²ã¨è–„ã„ <ul><li>Read(view)ã«é–¢ã—ã¦ã¯ã‹ãªã‚Šè‡ªç”±ã€‚</ul><li>readModifyWrite(eventæ›´æ–°ã®è¡çª)ã«ã¤ã„ã¦ã¯ã€aggregate_type,aggregate_id,sequenceã«ä¸€æ„åˆ¶ç´„ä»˜ä¸ã§ãã‚Œã°ã‚ˆã„ã®ã§ãã‚ŒãŒã§ãã‚Œã°ã‚ã‚Šã¨å®Ÿè£…ã¯ç°¡å˜ãã†ã ã£ãŸã€‚<li>Aggregateé–¢é€£ã¯genericã«ãªã£ã¦ã„ã‚‹ãŒã€trait object(dyn)ã‚‚ã§ã¦ãã‚‹ã€‚ <ul><li>metadatadateã«é–¢ã—ã¦ã¯HashMap&lt;String,String></ul><li>writeã®model(aggregate)ã«é–¢ã—ã¦ã¯å¤‰æ›´ãŒã—ã‚„ã™ã„ã€‚fieldã®å‹ã‚’å¤‰ãˆã¦ã‚‚applyã§å¯¾å¿œã™ã‚Œã°ã‚ˆã„ <ul><li>Eventã¯deserializeã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§äº’æ›æ€§ã®ãªã„å¤‰æ›´ã¯ã—ã«ãã„(ãã®ãŸã‚ã®event_upcaster)</ul><li>writeã¨viewã§å®Ÿè³ªmodelã®å®šç¾©ãŒäºŒã¤ã§ã¦ãã‚‹ã€‚ <ul><li>ãƒ¡ãƒªãƒƒãƒˆã§ã‚‚ãƒ‡ãƒ¡ãƒªãƒƒãƒˆã§ã‚‚ã‚ã‚‹ã¨æ€ã†ã€‚viewã®ã¨ãã ã‘æ¬²ã—ã„è¿½åŠ ã®æƒ…å ±ã®ã›ãŸã‚Šã§ãã‚‹ãŒã€å¤§æŠµã¯writeã¨readä¸¡æ–¹ã«ã¯ã­ã‚‹ã¨ãŠã‚‚ã†ã€‚</ul><li>query dispatchã§ã‚¨ãƒ©ãƒ¼ã«ãªã£ã¦ã‚‚writeã®å‡¦ç†ã¯å®Œäº†ã™ã‚‹ã®ã§ã€é©åˆ‡ã«retryã™ã‚‹å¿…è¦ãŒã‚ã‚Šãã†ã€‚<li>ãŒã‚“ã°ã£ãŸåˆ†ã€command â†’ apply â†’ resultant_event ã®å‡¦ç†ã«fieldã®æ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯ãŒé›†ä¸­ã™ã‚‹ã®ã§ã‚ˆã„ã¨æ€ã£ãŸ</ul><h2 id=matome><a aria-label="Anchor link for: matome" class=zola-anchor href=#matome>ã¾ã¨ã‚</a></h2><p>CQRSã¯æ¦‚å¿µã¨ã—ã¦ã—ã‹çŸ¥ã‚‰ãªã‹ã£ãŸã®ã§Rustã§ã®å…·ä½“çš„ãªå®Ÿè£…ã‚’çŸ¥ã‚Œã¦ã†ã‚Œã—ã‹ã£ãŸã€‚<br> Aggregateã«commandã‚’é©ç”¨ã—ã¦çµæœã‚’Eventã¨ã—ã¦è¡¨ç¾ã—ã€ã“ã‚Œã‚’SourceOfTruthã¨ã—ã¦æ°¸ç¶šåŒ–ã™ã‚‹ã¨ã„ã†ç™ºæƒ³ã¯ã‚·ãƒ³ãƒ—ãƒ«ã§ã‚ã‹ã‚Šã‚„ã™ã„ã¨æ€ã£ãŸã€‚ ã“ã†ãªã£ã¦ãã‚‹ã¨é‹ç”¨ã—ã¦ã¿ãŸã„ã®ã§ã€CQRSã®è¨­è¨ˆã«é–¢ã™ã‚‹æœ¬ã‚‚èª­ã‚“ã§ã¿ã‚ˆã†ã¨æ€ã£ãŸã€‚(ä¾‹ãˆã°<a href=https://www.immutablearchitecture.com/ rel=external>The Art of Immutable Architecture</a>)<h2 id=can-kao><a aria-label="Anchor link for: can-kao" class=zola-anchor href=#can-kao>å‚è€ƒ</a></h2><ul><li><a href=https://doc.rust-cqrs.org/intro.html rel=external>CQRS and Events Sourcing using Rust</a><li><a href=https://github.com/serverlesstechnology/cqrs-demo rel=external>cqrs-demo</a><li><a href=https://github.com/serverlesstechnology/cqrs rel=external>cqrs-es</a> <ul><li>github repositoryåãŒcqrsã ãŒã€cargo(package)ã¯cqrs-es</ul><li>https://github.com/serverlesstechnology/postgres-espostgresã®PersistedEventRepositoryã®å®Ÿè£…</ul></div></article></main><footer class=blog-footer><p>Â© 2026 <a href=https://blog.ymgyt.io> ymgyt </a> | Made with <a href=https://www.getzola.org rel=noopener target=_blank>Zola</a> | <a href=https://github.com/ymgyt/blog>Repository</a> | <a href=https://blog.ymgyt.io/atom.xml target=_blank title=rss> <svg viewbox="0 0 24 24" class=icon fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx=5 cy=19 r=1></circle></svg> </a></footer></div></div>