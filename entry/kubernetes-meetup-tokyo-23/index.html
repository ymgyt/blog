<!doctype html><html lang=ja><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1" name=viewport><link href=https://blog.ymgyt.io/favicon.ico rel=icon sizes=any><link href=https://blog.ymgyt.io/icon.svg rel=icon type=image/svg+xml><link href=https://blog.ymgyt.io/apple-touch-icon.png rel=apple-touch-icon><link href=https://blog.ymgyt.io/manifest.webmanifest rel=manifest><link href=https://blog.ymgyt.io/style.css rel=stylesheet><link href=https://blog.ymgyt.io/atom.xml rel=alternate title=Atom type=application/atom+xml><script src="https://www.googletagmanager.com/gtag/js?id=G-GTB0KMLN90" async></script><script>window.dataLayer = window.dataLayer || [];
	function gtag() {dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-GTB0KMLN90');</script><title>ğŸ—¼ Kubernetes Meetup Tokyo #23ã«ã„ã£ã¦ãã¾ã—ãŸ | Happy developing</title><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><body><div class=world><div class=content-container><header class=blog-header-container><div class=blog-logo><a href=https://blog.ymgyt.io>Happy developing</a></div><div class=blog-nav><nav><ul><li><a href=https://blog.ymgyt.io/entry/>Entries</a><li><a href=https://blog.ymgyt.io/tags/>Tags</a><li><a href=https://blog.ymgyt.io/about/>About</a><li><a href=https://github.com/ymgyt> <img alt=Github class=icon src=https://blog.ymgyt.io/images/icon/github.svg> </a><li><a href="https://twitter.com/YAmaguchixt "> <img alt=Twitter class=icon src=https://blog.ymgyt.io/images/icon/twitter.svg> </a></ul></nav></div></header><main class=blog-main><article><header class=entry-header><h1 class=entry-title>ğŸ—¼ Kubernetes Meetup Tokyo #23ã«ã„ã£ã¦ãã¾ã—ãŸ</h1><div class=entry-meta><p class=entry-meta-item>ğŸ—“ 2019-09-27<p class=entry-meta-item>ğŸ· <span class=tag><a href=https://blog.ymgyt.io/tags/cncf/>cncf</a></span> <span class=tag><a href=https://blog.ymgyt.io/tags/event/>event</a></span></div></header><aside class=entry-toc><nav><ul class=entry-toc-toplevel-list><li><a href=https://blog.ymgyt.io/entry/kubernetes-meetup-tokyo-23/#hui-chang>ä¼šå ´</a><li><a href=https://blog.ymgyt.io/entry/kubernetes-meetup-tokyo-23/#session>Session</a> <ul><li><a href=https://blog.ymgyt.io/entry/kubernetes-meetup-tokyo-23/#zerokarashi-merukubernetes-controller>ã‚¼ãƒ­ã‹ã‚‰å§‹ã‚ã‚‹Kubernetes Controller</a><li><a href=https://blog.ymgyt.io/entry/kubernetes-meetup-tokyo-23/#kubebuilder-controller-runtimeru-men-with-v2-updates>kubebuilder/controller-runtimeå…¥é–€ with v2 updates</a></ul><li><a href=https://blog.ymgyt.io/entry/kubernetes-meetup-tokyo-23/#kubernetes-1-16-sig-api-machinerynobian-geng-nei-rong>Kubernetes 1.16: SIG-API Machineryã®å¤‰æ›´å†…å®¹</a><li><a href=https://blog.ymgyt.io/entry/kubernetes-meetup-tokyo-23/#kubernetes-1-16-sig-cli-nobian-geng-nei-rong>Kubernetes 1.16: SIG-CLI ã®å¤‰æ›´å†…å®¹</a><li><a href=https://blog.ymgyt.io/entry/kubernetes-meetup-tokyo-23/#lt>LT</a> <ul><li><a href=https://blog.ymgyt.io/entry/kubernetes-meetup-tokyo-23/#clusterapi-v1alpha1-v1alpha2>ClusterAPI v1alpha1 â†’ v1alpha2</a><li><a href=https://blog.ymgyt.io/entry/kubernetes-meetup-tokyo-23/#zi-dong-hua-hashell-operator-totomoni>è‡ªå‹•åŒ–ã¯shell-operator ã¨ã¨ã‚‚ã«ã€‚</a><li><a href=https://blog.ymgyt.io/entry/kubernetes-meetup-tokyo-23/#zi-zuo-controller-niyoru-secret-nopei-bu-toshou-ji-unblee>è‡ªä½œ Controller ã«ã‚ˆã‚‹ Secret ã®é…å¸ƒã¨åé›† - unblee</a></ul><li><a href=https://blog.ymgyt.io/entry/kubernetes-meetup-tokyo-23/#ken-tan-hui>æ‡‡è«‡ä¼š</a><li><a href=https://blog.ymgyt.io/entry/kubernetes-meetup-tokyo-23/#ci-hui>æ¬¡å›</a><li><a href=https://blog.ymgyt.io/entry/kubernetes-meetup-tokyo-23/#matome>ã¾ã¨ã‚</a><li><a href=https://blog.ymgyt.io/entry/kubernetes-meetup-tokyo-23/#setukakunanodezerokarashi-merukubernetes-controllerwootutemiru>ã›ã£ã‹ããªã®ã§ã‚¼ãƒ­ã‹ã‚‰å§‹ã‚ã‚‹Kubernetes Controllerã‚’ãŠã£ã¦ã¿ã‚‹</a> <ul><li><a href=https://blog.ymgyt.io/entry/kubernetes-meetup-tokyo-23/#kubectl-apply>kubectl apply</a><li><a href=https://blog.ymgyt.io/entry/kubernetes-meetup-tokyo-23/#replicaset-controllernoqi-dong>ReplicaSet Controllerã®èµ·å‹•</a><li><a href=https://blog.ymgyt.io/entry/kubernetes-meetup-tokyo-23/#replicasetcontroller-managereplicas>ReplicaSetController.manageReplicas()</a><li><a href=https://blog.ymgyt.io/entry/kubernetes-meetup-tokyo-23/#schedulergaenqueue>SchedulerãŒenqueue</a><li><a href=https://blog.ymgyt.io/entry/kubernetes-meetup-tokyo-23/#kubelethaskip>kubeletã¯skip</a><li><a href=https://blog.ymgyt.io/entry/kubernetes-meetup-tokyo-23/#schedulerganode-namewoshe-ding>SchedulerãŒnode nameã‚’è¨­å®š</a><li><a href=https://blog.ymgyt.io/entry/kubernetes-meetup-tokyo-23/#kubeletgakontenawoqi-dong>kubeletãŒã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•</a><li><a href=https://blog.ymgyt.io/entry/kubernetes-meetup-tokyo-23/#kubeletgapodnostatuswogeng-xin>kubeletãŒPodã®statusã‚’æ›´æ–°</a><li><a href=https://blog.ymgyt.io/entry/kubernetes-meetup-tokyo-23/#podnoterminating>Podã®Terminating</a><li><a href=https://blog.ymgyt.io/entry/kubernetes-meetup-tokyo-23/#replicasetcontrollergapodwoxue-chu>ReplicaSetControllerãŒPodã‚’å‰Šé™¤</a><li><a href=https://blog.ymgyt.io/entry/kubernetes-meetup-tokyo-23/#reconcile>Reconcile</a></ul></ul></nav></aside><div class=entry-content><p>2019å¹´9æœˆ27æ—¥ã«é–‹å‚¬ã•ã‚ŒãŸ<a href=https://k8sjp.connpass.com/event/145942/ rel=external>Kubernetes Meetup Tokyo #23</a>ã«ãƒ–ãƒ­ã‚°æ ã§å‚åŠ ã•ã›ã¦ã„ãŸã ã„ãŸã®ã§ã€ãã®æ¨¡æ§˜ã«ã¤ã„ã¦æ›¸ã„ã¦ã„ãã¾ã™ã€‚<h2 id=hui-chang><a aria-label="Anchor link for: hui-chang" class=zola-anchor href=#hui-chang>ä¼šå ´</a></h2><p>ä¼šå ´ã¯æ¸‹è°·ã‚¹ãƒˆãƒªãƒ¼ãƒ ã®éš£ã«èª•ç”Ÿã—ãŸæ¸‹è°·ã‚¹ã‚¯ãƒ©ãƒ³ãƒ–ãƒ«ã‚¹ã‚¯ã‚¨ã‚¢ã§ã™ã€‚ãƒ“ãƒ«ã®æ­£å¼ã‚ªãƒ¼ãƒ—ãƒ³ãŒ11æœˆã‹ã‚‰ã¨ã®ã“ã¨ã§çµ¶è³›å†…è£…å·¥äº‹ä¸­ã§ã—ãŸã€‚ æ¸‹è°·é§…ç›´çµã§ã¨ã¦ã‚‚ä¾¿åˆ©ãªç«‹åœ°ã§ã™ã€‚ã‚¹ãƒãƒ³ã‚µãƒ¼ã¯<strong>CyberAgent</strong>ç¤¾ã§ã™ã€‚<figure><div class=fig-images-row><img , alt src=images/site_1.jpeg width=32%,><img , alt src=images/site_2.jpeg width=32%,><img , alt src=images/site_3.jpeg width=32%,></div><figcaption>Sessionå¾Œã®æ‡‡è«‡ä¼šã®æ§˜å­</figcaption></figure><h2 id=session><a aria-label="Anchor link for: session" class=zola-anchor href=#session>Session</a></h2><h3 id=zerokarashi-merukubernetes-controller><a aria-label="Anchor link for: zerokarashi-merukubernetes-controller" class=zola-anchor href=#zerokarashi-merukubernetes-controller>ã‚¼ãƒ­ã‹ã‚‰å§‹ã‚ã‚‹Kubernetes Controller</a></h3><p><a href=https://techbookfest.org/event/tbf07 rel=external>æŠ€è¡“æ›¸å…¸7</a>ã§è²·ã‚ã›ã¦ã„ãŸã ã„ãŸã€<a href=https://go-vargo.booth.pm/items/1566979 rel=external>å®Ÿè·µå…¥é–€Kubernetes ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã¸ã®é“</a>ã®è‘—è€…ã§ã‚ã‚‰ã‚Œã‚‹<a href=https://twitter.com/go_vargo rel=external>ãƒãƒ«ã‚´ã•ã‚“</a>ã«ã‚ˆã‚‹Kubernetes Controllerã«ã¤ã„ã¦ã®ç™ºè¡¨ã€‚<figure><div class=fig-images-row><img , alt src=images/load_to_custom_controller.jpeg></div></figure><iframe style="aspect-ratio:560/420;background:#0000001a padding-box padding-box;border:0;border-radius:6px;width:100%;height:auto;margin:0;padding:0;box-shadow:0 5px 40px #0003" title="ã‚¼ãƒ­ã‹ã‚‰å§‹ã‚ã‚‹Kubernetes Controller / Under the Kubernetes  Controller" allowfullscreen class=speakerdeck-iframe data-ratio=1.3333333333333333 frameborder=0 mozallowfullscreen=true src=https://speakerdeck.com/player/173fdf8b50f445ba895b82fb6650825c webkitallowfullscreen=true></iframe><p>Controllerã®æ¦‚è¦ã‹ã‚‰å†…éƒ¨ã®å®Ÿè£…ã«ã¤ã„ã¦ã¾ã§èª¬æ˜ã•ã‚Œã¦ã„ã‚‹100Pè¶…ãˆã®åŠ›ä½œã‚¹ãƒ©ã‚¤ãƒ‰ã§ã™ã€‚ ReplicaSetã‚’applyã—ã¦ã‹ã‚‰ãƒ‡ãƒªãƒãƒªã•ã‚Œã‚‹ã¾ã§ã®å‡¦ç†ã‚’è©²å½“ã‚½ãƒ¼ã‚¹ã¸ã®å‚ç…§ç®‡æ‰€ã¾ã§æ·»ãˆã¦èª¬æ˜ã—ã¦ãã‚Œã¦ãŠã‚Šé–‹å§‹10åˆ†ã§ã“ã‚Œã¦ã‚ˆã‹ã£ãŸã¨æ€ãˆã¾ã—ãŸã€‚<h3 id=kubebuilder-controller-runtimeru-men-with-v2-updates><a aria-label="Anchor link for: kubebuilder-controller-runtimeru-men-with-v2-updates" class=zola-anchor href=#kubebuilder-controller-runtimeru-men-with-v2-updates>kubebuilder/controller-runtimeå…¥é–€ with v2 updates</a></h3><p><a href=https://github.com/kfyharukz rel=external>kfyharukzã•ã‚“</a>ã«ã‚ˆã‚‹kubebuilder v2ã®ç´¹ä»‹/ãƒ‡ãƒ¢ã€‚<p>kubernetesã®APIã‚’æ‹¡å¼µã™ã‚‹ãŸã‚ã®SDK <a href=https://github.com/kubernetes-sigs/kubebuilder rel=external>kubebuilder</a>ã«ã¤ã„ã¦ã®ç™ºè¡¨ã§ã™ã€‚</p><iframe style="border:1px solid #ccc;max-width:100%;margin-bottom:5px" allowfullscreen frameborder=0 height=485 marginheight=0 marginwidth=0 scrolling=no src=//www.slideshare.net/slideshow/embed_code/key/fl9arNMEK2OZya width=595></iframe><div style=margin-bottom:5px><strong> <a title="Kubernetes Meetup Tokyo #23 kubebuilder-v2" href=//www.slideshare.net/KazuhitoMatsuda1/kubernetes-meetup-tokyo-23-kubebuilderv2 target=_blank>Kubernetes Meetup Tokyo #23 kubebuilder-v2</a> </strong> from <strong><a href=//www.slideshare.net/KazuhitoMatsuda1 target=_blank>Kazuhito Matsuda</a></strong></div><p>Kubernetesã®builtin Resouceã®ç†è§£ã‚‚ã¾ã ã‚ã‚„ã—ã„è‡ªåˆ†ã«ã¨ã£ã¦ã¯ç™ºå±•çš„ãªå†…å®¹ã§ã—ãŸã€‚CKAåˆæ ¼ã§ããŸã‚‰Custom Resourceã«ã‚‚æŒ‘æˆ¦ã—ãŸã„ã§ã™ã€‚<h2 id=kubernetes-1-16-sig-api-machinerynobian-geng-nei-rong><a aria-label="Anchor link for: kubernetes-1-16-sig-api-machinerynobian-geng-nei-rong" class=zola-anchor href=#kubernetes-1-16-sig-api-machinerynobian-geng-nei-rong>Kubernetes 1.16: SIG-API Machineryã®å¤‰æ›´å†…å®¹</a></h2><p>Introduction of Operator FrameworkãŒè¡Œã‚ã‚Œã‚‹äºˆå®šã§ã—ãŸãŒã€ç™ºè¡¨è€…ã®æ–¹ãŒä½“èª¿ä¸è‰¯ã¨ã®ã“ã¨ã§å†…å®¹ãŒå¤‰æ›´ã«ãªã‚Šã¾ã—ãŸã€‚<p><a href=https://twitter.com/Ladicle rel=external>Ladicleã•ã‚“</a>ã«ã‚ˆã‚‹<a href=https://qiita.com/Ladicle/items/f192d266b80e873eb0a8 rel=external>Kubernetes 1.16: SIG-API Machineryã®å¤‰æ›´å†…å®¹</a> ãã‚‚ãã‚‚SIGã¨ã„ã†å˜èªãŒã‚ã‹ã£ã¦ã„ã¾ã›ã‚“ã§ã—ãŸã€‚èª¿ã¹ã¦ã¿ãŸã¨ã“ã‚Kubernetes Projectã®é–‹ç™ºå˜ä½ã¨ã„ã†æ„Ÿã˜ã§ã—ã‚‡ã†ã‹ã€‚ èˆˆå‘³ãŒã‚ã‚‹SIGã‹ã‚‰è¿½ã„ã‹ã‘ã¦ã¿ã‚‹ã¨ã¨ã£ã‹ã‹ã‚Šã¨ã—ã¦ã¯ã‚ˆã„ã¨ã„ã†ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚‚ã„ãŸã ãã¾ã—ãŸã€‚<ul><li><a href=https://github.com/kubernetes/community/blob/master/sig-list.md rel=external>sig-list</a></ul><p><a href=https://qiita.com/organizations/zlab rel=external>zlabç¤¾</a>ãŒQiitaã§Kubernetesã‚„Goé–¢é€£ã§å‚è€ƒã«ãªã‚‹è¨˜äº‹ã‚’ãŸãã•ã‚“ã‚ã’ã¦ãã‚Œã¦ã„ã‚‹ã®ã§ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ã„ã“ã†ã¨æ€ã„ã¾ã—ãŸã€‚<ul><li><a href=https://qiita.com/organizations/zlab rel=external>zlab</a></ul><h2 id=kubernetes-1-16-sig-cli-nobian-geng-nei-rong><a aria-label="Anchor link for: kubernetes-1-16-sig-cli-nobian-geng-nei-rong" class=zola-anchor href=#kubernetes-1-16-sig-cli-nobian-geng-nei-rong>Kubernetes 1.16: SIG-CLI ã®å¤‰æ›´å†…å®¹</a></h2><p>åŒã˜ã<a href=https://qiita.com/organizations/zlab rel=external>zlabç¤¾</a>ã®<a href=https://twitter.com/superbrothers rel=external>ã™ã±ã¶ã‚‰ã•ã‚“</a>ã«ã‚ˆã‚‹<a href=https://qiita.com/superbrothers/items/e78a8a04347e57900fd9 rel=external>Kubernetes 1.16: SIG-CLI ã®å¤‰æ›´å†…å®¹</a>ã§ã™ã€‚<p>kubectlã®å®Ÿè·µçš„ãªè§£èª¬ã§è‡ªåˆ†ãŒæ‰“ã£ãŸã“ã¨ãŒãªã„ã‚³ãƒãƒ³ãƒ‰ã‚„ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã°ã‹ã‚Šã§ã—ãŸã€‚<br> <code>kubectl debug</code> ã¯åˆ©ç”¨ã§ããŸã‚‰ã¨ã¦ã‚‚ä¾¿åˆ©ãã†ãªã®ã§å¾…ã¡é ã—ã„ã§ã™ã€‚<h2 id=lt><a aria-label="Anchor link for: lt" class=zola-anchor href=#lt>LT</a></h2><h3 id=clusterapi-v1alpha1-v1alpha2><a aria-label="Anchor link for: clusterapi-v1alpha1-v1alpha2" class=zola-anchor href=#clusterapi-v1alpha1-v1alpha2>ClusterAPI v1alpha1 â†’ v1alpha2</a></h3><p><a href=https://twitter.com/r_takaishi rel=external>r_takaishiã•ã‚“</a>ã«ã‚ˆã‚‹ClusterAPIã«ã¤ã„ã¦ã€‚ ç™ºè¡¨è³‡æ–™ã®ãƒªãƒ³ã‚¯ãŒè¦‹ã¤ã‘ã‚‰ã‚Œãšã€‚ ClusterAPIã«ã¤ã„ã¦ã¯ã¾ã£ãŸãã‚ã‹ã£ã¦ãŠã‚‰ãšã€‚ãã‚‚ãã‚‚Kubernetesã£ã¦Cluster(ç‰¹ã«controll plane)ã¯ä½œæˆã•ã‚Œã¦ã„ã‚‹å‰æã ã¨è€ƒãˆã¦ã„ãŸã®ã§æ°—ã«ãªã‚‹ã¨ã“ã‚ã§ã™ã€‚ æŠ€è¡“æ›¸å…¸7ã§ã¯è²·ãˆã¦ã„ãªã‹ã£ãŸ<a href=https://techiemedia.booth.pm/items/1579677 rel=external>ã¯ã˜ã‚ã‚‹Cluster API</a>èª­ã‚“ã§å‡ºç›´ã—ã¾ã™ã€‚<figure><div class=fig-images-row><img , alt src=images/cluster_api_book.jpeg></div></figure><h3 id=zi-dong-hua-hashell-operator-totomoni><a aria-label="Anchor link for: zi-dong-hua-hashell-operator-totomoni" class=zola-anchor href=#zi-dong-hua-hashell-operator-totomoni>è‡ªå‹•åŒ–ã¯shell-operator ã¨ã¨ã‚‚ã«ã€‚</a></h3><p><a href=https://twitter.com/nwiizo rel=external>nwiizoã•ã‚“</a>ã•ã‚“ã«ã‚ˆã‚‹shell(bash)ã¨kubernetesã«ã¤ã„ã¦ã€‚ ãã‚‚ãã‚‚ã€operatorã«ã¤ã„ã¦ã®ã‚ã‹ã£ã¦ã„ãªã„ã®ã§ã€ãªã‚“ã‹bashã§ã‚‚kubernetesã®å‡¦ç†ã«ã¯ã•ã‚ã‚‹ã‚“ã ãªãã‚‰ã„ã®ç†è§£ã—ã‹ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ ã“ã“ã¯è­°è«–ã®ã‚ã‚‹ã¨ã“ã‚ã ã¨æ€ã„ã¾ã™ãŒã€è‡ªåˆ†ã¯ä»¥ä¸‹ã®ç‚¹ã‹ã‚‰ã‚ã¾ã‚Šbashã‚’æœ¬ç•ªé–¢é€£ã®å‡¦ç†ã«çµ„ã¿è¾¼ã¿ãŸããªã„ã¨è€ƒãˆã¦ã„ã‚‹ã®ã§ã™ãŒã©ã†ãªã‚“ã§ã—ã‚‡ã†ã‹ã€‚<ul><li>networkå‡¦ç†ã«ã¯å¿…ãštimeoutè¨­å®šã—ãŸã„<li>error handling<li>logging(structured, leveling,...)<li>signal handling(gracefully shutdown, resource cleanupç­‰)<li>testæ›¸ããŸã„<li>ä¾å­˜ã‚’æ˜ç¤º</ul><p>(bashã§ã§ããªã„ã“ã¨ã¯ãªã„ã¨æ€ã†ã®ã§ã™ãŒä¸Šè¨˜ã®ã“ã¨ã‚„ã‚ã†ã¨ã™ã‚‹ã¨è‚¥å¤§åŒ–ã™ã‚‹ã‹scriptã®æ‰‹è»½ã•ãŒçµå±€å¤±ã‚ã‚Œã‚‹)<h3 id=zi-zuo-controller-niyoru-secret-nopei-bu-toshou-ji-unblee><a aria-label="Anchor link for: zi-zuo-controller-niyoru-secret-nopei-bu-toshou-ji-unblee" class=zola-anchor href=#zi-zuo-controller-niyoru-secret-nopei-bu-toshou-ji-unblee>è‡ªä½œ Controller ã«ã‚ˆã‚‹ Secret ã®é…å¸ƒã¨åé›† - unblee</a></h3><p><a href=https://twitter.com/unblee rel=external>unbleeã•ã‚“</a>ã«ã‚ˆã‚‹<a href=https://speakerdeck.com/unblee/distributing-and-collecting-secrets-with-self-made-controller rel=external>è‡ªä½œ Controller ã«ã‚ˆã‚‹ Secret ã®é…å¸ƒã¨åé›†</a><p>wantedlyç¤¾ã§ã®Kubernetesé‹ç”¨ä¸Šã®èª²é¡Œã‚’Controllerã‚’ä½œæˆã—ã¦è§£æ±ºã•ã‚ŒãŸãŠè©±ã§ã—ãŸã€‚<br> 1-MicroService 1-Namespaceã§é‹ç”¨ã•ã‚Œã¦ã„ã‚‹ãã†ã§ã™ã€å®Ÿé‹ç”¨ã•ã‚Œã¦ã„ã‚‹æ–¹ã€…ã®Namespaceã®åˆ‡ã‚Šæ–¹ã«ã¤ã„ã¦ã¯ã‚‚ã£ã¨ãŠè©±ã‚’ä¼ºã£ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã—ãŸã€‚<h2 id=ken-tan-hui><a aria-label="Anchor link for: ken-tan-hui" class=zola-anchor href=#ken-tan-hui>æ‡‡è«‡ä¼š</a></h2><p>Sessionã¨LTã®é–“ã«30åˆ†ç¨‹åº¦ã®æ‡‡è«‡ä¼šã®æ™‚é–“ãŒè¨­ã‘ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚(é£²é£Ÿç‰©ã®æä¾›ã¯<strong>CyberAgent</strong>ç¤¾) ãŸã¾ãŸã¾æŠ€è¡“æ›¸å…¸7ã§è²·ã£ã¦ã€å½“æ—¥ã‚‚èª­ã‚“ã§ã„ãŸã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã¸ã®é“ã®è‘—è€…ã®<a href=https://twitter.com/go_vargo rel=external>ãƒãƒ«ã‚´ã•ã‚“</a>ãŒç™ºè¡¨ã•ã‚Œã¦ã„ãŸã®ã§ã€æœ¬è²·ã„ã¾ã—ãŸã¨ã”æŒ¨æ‹¶ã•ã›ã¦ã„ãŸã ãã¾ã—ãŸã€‚ã¾ãŸCKAã€CKADã‚’ãŠæŒã¡ã¨ã®ã“ã¨ã§ã€<a href=https://qiita.com/go_vargo/items/3644c3a44734e2c155f4 rel=external>CKAã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹</a>ã‚‚èã‘ã¾ã—ãŸã€‚<p><a href=https://twitter.com/Ladicle rel=external>Ladicleã•ã‚“</a>ã®ç™ºè¡¨ã®éš›ã«ç”¨ã„ã‚‰ã‚Œã¦ã„ãŸQiitaã®iconã©ã“ã‹ã§ã¿ãŸã“ã¨ã‚ã‚‹ãªãƒ¼æ€ã£ã¦ã„ãŸã®ã§ã™ãŒã€<a href=https://gihyo.jp/dp/ebook/2017/978-4-7741-8845-4 rel=external>Software Design 2017å¹´9æœˆå·</a>ã®ç‰¹é›† WebæŠ€è¡“ã€è¶…ã€‘å…¥é–€ã„ã¾ä¸€åº¦æŒ¯ã‚Šè¿”ã‚‹Webã®ã—ãã¿ã¨é–‹ç™ºæ–¹æ³•ã§<a href=https://github.com/Ladicle/http-handson rel=external>web serverã®å®Ÿè£…</a>ã‚’goã§ã‚„ã‚‰ã‚Œã¦ã„ã‚‹æ–¹ã§ã‚ã‚‹ã“ã¨ã‚’æ€ã„å‡ºã—ã¾ã—ãŸã€‚<br> <code>go-bindata</code>ã§é™çš„ã‚¢ã‚»ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’goã®ãƒã‚¤ãƒŠãƒªãƒ¼ã«çµ„ã¿è¾¼ã‚€ã‚„ã‚Šæ–¹ã‚’ã“ã“ã§ã¯ã˜ã‚ã¦çŸ¥ã‚Šã¾ã—ãŸã€‚<h2 id=ci-hui><a aria-label="Anchor link for: ci-hui" class=zola-anchor href=#ci-hui>æ¬¡å›</a></h2><p>æ¬¡å›ã¯10æœˆ24æ—¥ã§ã€Kubernetesä¸Šã§å‹•ã‹ã™ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™ºã®ãƒ‡ãƒãƒƒã‚¯ã¨ãƒ†ã‚¹ãƒˆã«ã¤ã„ã¦ã ãã†ã§ã™ã€‚ ã“ã¡ã‚‰ã‚‚æ¥½ã—ã¿ã§ã™ã­ã€‚<h2 id=matome><a aria-label="Anchor link for: matome" class=zola-anchor href=#matome>ã¾ã¨ã‚</a></h2><p>Kubernetes Meetup Tokyoã«ã¯åˆå‚åŠ ã§ã€è‡ªåˆ†ã®Kubernetesã«ã¤ã„ã¦ã®ç†è§£ãŒã€GKEã«slack botã‚’deployã—ã¦ã¿ã‚‹ç¨‹åº¦(<a href=http://blog.howtelevision.co.jp/entry/2019/04/30/193747 rel=external>ä¼šç¤¾ã®ãƒ–ãƒ­ã‚°ã§è¨˜äº‹</a>ã«ã—ã¾ã—ãŸã€‚) ã§ã—ãŸãŒã¨ã¦ã‚‚å‹‰å¼·ã«ãªã‚Šå‚åŠ ã—ã¦ã‚ˆã‹ã£ãŸã§ã™ã€‚<h2 id=setukakunanodezerokarashi-merukubernetes-controllerwootutemiru><a aria-label="Anchor link for: setukakunanodezerokarashi-merukubernetes-controllerwootutemiru" class=zola-anchor href=#setukakunanodezerokarashi-merukubernetes-controllerwootutemiru>ã›ã£ã‹ããªã®ã§ã‚¼ãƒ­ã‹ã‚‰å§‹ã‚ã‚‹Kubernetes Controllerã‚’ãŠã£ã¦ã¿ã‚‹</a></h2><p><a href=https://speakerdeck.com/govargo/under-the-kubernetes-controller-36f9b71b-9781-4846-9625-23c31da93014 rel=external>ã‚¼ãƒ­ã‹ã‚‰å§‹ã‚ã‚‹Kubernetes Controller</a>ã§ã€ReplicaSetã‚’applyã—ãŸéš›ã®Controllerã®æŒ™å‹•ãŒè©²å½“ã‚³ãƒ¼ãƒ‰ã®ãƒªãƒ³ã‚¯ã¤ãã§è§£èª¬ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€è¿½ãˆã‚‹ã¨ã“ã‚ã¾ã§ãŠã£ã¦ã¿ã¾ã—ãŸã€‚<a href=https://github.com/kubernetes/kubernetes/tree/release-1.16 rel=external>kubernetesã®versionã¯1.16ã§ã™</a><h3 id=kubectl-apply><a aria-label="Anchor link for: kubectl-apply" class=zola-anchor href=#kubectl-apply><code>kubectl apply</code></a></h3><a href="https://speakerdeck.com/govargo/under-the-kubernetes-controller-36f9b71b-9781-4846-9625-23c31da93014?slide=19"> <figure><div class=fig-images-row><img , alt src=images/controller_1.jpeg></div></figure> </a><p><code>kubectl</code>ã§ReplicaSetã‚’applyã—ã¦ã€api-serverã§å‡¦ç†ã•ã‚Œã¦ã„ã‚‹å‰æã§ã™ã€‚<h3 id=replicaset-controllernoqi-dong><a aria-label="Anchor link for: replicaset-controllernoqi-dong" class=zola-anchor href=#replicaset-controllernoqi-dong><code>ReplicaSet Controller</code>ã®èµ·å‹•</a></h3><p>slideã§ã¯ã€<code>ReplicaSetController</code>ãŒ<code>ReplicaSet</code>ãŒç”Ÿæˆã•ã‚ŒãŸã“ã¨ã‚’æ¤œçŸ¥ã—ãŸã¨ã“ã‚ã‹ã‚‰è§£èª¬ã•ã‚Œã¦ã„ã¾ã™ãŒã€èµ·å‹•å‡¦ç†ã‚’ç°¡å˜ã«ãŠã£ã¦ã¿ã¾ã—ãŸã€‚<p><code>ReplicaSetController</code>è‡ªä½“ã¯ã€<code>kube-controller-manager</code> binaryã«å«ã¾ã‚Œã¦ã„ã‚‹ã®ã§ã€èµ·å‹•å‡¦ç†ã¯<code>kube-controller-manager</code>ã‚³ãƒãƒ³ãƒ‰ã‹ã‚‰å§‹ã¾ã‚Šã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=go><span class=giallo-l><span style=color:#616e88>// Run runs the KubeControllerManagerOptions.  This should never exit.</span></span>
<span class=giallo-l><span style=color:#81a1c1>func</span><span style=color:#88c0d0> Run</span><span style=color:#eceff4>(</span><span>c</span><span style=color:#81a1c1> *</span><span>config</span><span style=color:#eceff4>.</span><span>CompletedConfig</span><span style=color:#eceff4>,</span><span> stopCh</span><span style=color:#81a1c1> &lt;-chan struct</span><span style=color:#eceff4>{})</span><span style=color:#81a1c1> error</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>  // ...</span></span>
<span class=giallo-l><span style=color:#81a1c1>  if</span><span> err</span><span style=color:#81a1c1> :=</span><span style=color:#88c0d0> StartControllers</span><span style=color:#eceff4>(</span><span>controllerContext</span><span style=color:#eceff4>,</span><span> saTokenControllerInitFunc</span><span style=color:#eceff4>,</span><span style=color:#88c0d0> NewControllerInitializers</span><span style=color:#eceff4>(</span><span>controllerContext</span><span style=color:#eceff4>.</span><span>LoopMode</span><span style=color:#eceff4>),</span><span> unsecuredMux</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span><span> err</span><span style=color:#81a1c1> != nil</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>			klog</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>Fatalf</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>error starting controllers: </span><span style=color:#ebcb8b>%v</span><span style=color:#eceff4>",</span><span> err</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>	}</span></span>
<span class=giallo-l><span style=color:#616e88>  // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/cmd/kube-controller-manager/app/controllermanager.go#L234 rel=external>https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/cmd/kube-controller-manager/app/controllermanager.go#L234</a><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=go><span class=giallo-l><span style=color:#81a1c1>func</span><span style=color:#88c0d0> NewControllerInitializers</span><span style=color:#eceff4>(</span><span>loopMode ControllerLoopMode</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> map</span><span style=color:#eceff4>[</span><span style=color:#81a1c1>string</span><span style=color:#eceff4>]</span><span>InitFunc</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>  controllers</span><span style=color:#81a1c1> := map</span><span style=color:#eceff4>[</span><span style=color:#81a1c1>string</span><span style=color:#eceff4>]</span><span>InitFunc</span><span style=color:#eceff4>{}</span></span>
<span class=giallo-l><span style=color:#616e88>  // ...</span></span>
<span class=giallo-l><span>  controllers</span><span style=color:#eceff4>["</span><span style=color:#a3be8c>replicaset</span><span style=color:#eceff4>"]</span><span style=color:#81a1c1> =</span><span> startReplicaSetController</span></span>
<span class=giallo-l><span style=color:#616e88>  // ...</span></span>
<span class=giallo-l><span style=color:#81a1c1>  return</span><span> controllers</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/cmd/kube-controller-manager/app/controllermanager.go#L386 rel=external>https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/cmd/kube-controller-manager/app/controllermanager.go#L386</a><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=go><span class=giallo-l><span style=color:#81a1c1>func</span><span style=color:#88c0d0> StartControllers</span><span style=color:#eceff4>(</span><span>ctx ControllerContext</span><span style=color:#eceff4>,</span><span> startSATokenController InitFunc</span><span style=color:#eceff4>,</span><span> controllers</span><span style=color:#81a1c1> map</span><span style=color:#eceff4>[</span><span style=color:#81a1c1>string</span><span style=color:#eceff4>]</span><span>InitFunc</span><span style=color:#eceff4>,</span><span> unsecuredMux</span><span style=color:#81a1c1> *</span><span>mux</span><span style=color:#eceff4>.</span><span>PathRecorderMux</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> error</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>   // ...</span></span>
<span class=giallo-l><span style=color:#81a1c1>  for</span><span> controllerName</span><span style=color:#eceff4>,</span><span> initFn</span><span style=color:#81a1c1> := range</span><span> controllers</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>		// ...</span></span>
<span class=giallo-l><span>		debugHandler</span><span style=color:#eceff4>,</span><span> started</span><span style=color:#eceff4>,</span><span> err</span><span style=color:#81a1c1> :=</span><span style=color:#88c0d0> initFn</span><span style=color:#eceff4>(</span><span>ctx</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#616e88>		// ...</span></span>
<span class=giallo-l><span style=color:#eceff4>  }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>  return nil</span></span></code></pre><p><a href=https://github.com/kubernetes/kubernetes/blob/release-1.16//cmd/kube-controller-manager/app/controllermanager.go#L498 rel=external>https://github.com/kubernetes/kubernetes/blob/release-1.16//cmd/kube-controller-manager/app/controllermanager.go#L498:6:title</a><p>å„controllerã®èµ·å‹•å‡¦ç†ã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚ è‚å¿ƒã®<code>ReplicaSetController</code>ã®èµ·å‹•å‡¦ç†ã‚’ã¿ã¦ã¿ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=go><span class=giallo-l><span style=color:#81a1c1>func</span><span style=color:#88c0d0> startReplicaSetController</span><span style=color:#eceff4>(</span><span>ctx ControllerContext</span><span style=color:#eceff4>) (</span><span>http</span><span style=color:#eceff4>.</span><span>Handler</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> bool</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> error</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#616e88>	// ...</span></span>
<span class=giallo-l><span style=color:#81a1c1>	go</span><span> replicaset</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>NewReplicaSetController</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>		ctx</span><span style=color:#eceff4>.</span><span>InformerFactory</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>Apps</span><span style=color:#eceff4>().</span><span style=color:#88c0d0>V1</span><span style=color:#eceff4>().</span><span style=color:#88c0d0>ReplicaSets</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>		ctx</span><span style=color:#eceff4>.</span><span>InformerFactory</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>Core</span><span style=color:#eceff4>().</span><span style=color:#88c0d0>V1</span><span style=color:#eceff4>().</span><span style=color:#88c0d0>Pods</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>		ctx</span><span style=color:#eceff4>.</span><span>ClientBuilder</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>ClientOrDie</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>replicaset-controller</span><span style=color:#eceff4>"),</span></span>
<span class=giallo-l><span>		replicaset</span><span style=color:#eceff4>.</span><span>BurstReplicas</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>	).</span><span style=color:#88c0d0>Run</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>int</span><span style=color:#eceff4>(</span><span>ctx</span><span style=color:#eceff4>.</span><span>ComponentConfig</span><span style=color:#eceff4>.</span><span>ReplicaSetController</span><span style=color:#eceff4>.</span><span>ConcurrentRSSyncs</span><span style=color:#eceff4>),</span><span> ctx</span><span style=color:#eceff4>.</span><span>Stop</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>	return nil</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> true</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> nil</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/cmd/kube-controller-manager/app/apps.go#L69 rel=external>https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/cmd/kube-controller-manager/app/apps.go#L69</a><p><code>ReplicaSetController</code>ã®ç”Ÿæˆã¨èµ·å‹•å‡¦ç†ã‚’åˆ¥goroutineã§å®Ÿè¡Œã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=go><span class=giallo-l><span style=color:#81a1c1>func</span><span style=color:#eceff4> (</span><span>rsc </span><span style=color:#81a1c1>*</span><span>ReplicaSetController</span><span style=color:#eceff4>)</span><span style=color:#88c0d0> Run</span><span style=color:#eceff4>(</span><span>workers</span><span style=color:#81a1c1> int</span><span style=color:#eceff4>,</span><span> stopCh</span><span style=color:#81a1c1> &lt;-chan struct</span><span style=color:#eceff4>{}) {</span></span>
<span class=giallo-l><span style=color:#616e88>	// ...</span></span>
<span class=giallo-l><span style=color:#81a1c1>	for</span><span> i</span><span style=color:#81a1c1> :=</span><span style=color:#b48ead> 0</span><span style=color:#81a1c1>;</span><span> i</span><span style=color:#81a1c1> &lt;</span><span> workers</span><span style=color:#81a1c1>;</span><span> i</span><span style=color:#81a1c1>++</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>		go</span><span> wait</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>Until</span><span style=color:#eceff4>(</span><span>rsc</span><span style=color:#eceff4>.</span><span>worker</span><span style=color:#eceff4>,</span><span> time</span><span style=color:#eceff4>.</span><span>Second</span><span style=color:#eceff4>,</span><span> stopCh</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>	}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>	&lt;-</span><span>stopCh</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/controller/replicaset/replica_set.go#L177 rel=external>https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/controller/replicaset/replica_set.go#L177:34</a><p>æŒ‡å®šã•ã‚ŒãŸæ•°ã®workerã‚’èµ·å‹•ã—ã¦ã€<code>stopCh</code>ã§blockã—ã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=go><span class=giallo-l><span style=color:#81a1c1>func</span><span style=color:#eceff4> (</span><span>rsc </span><span style=color:#81a1c1>*</span><span>ReplicaSetController</span><span style=color:#eceff4>)</span><span style=color:#88c0d0> worker</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>	for</span><span> rsc</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>processNextWorkItem</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#eceff4>	}</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>func</span><span style=color:#eceff4> (</span><span>rsc </span><span style=color:#81a1c1>*</span><span>ReplicaSetController</span><span style=color:#eceff4>)</span><span style=color:#88c0d0> processNextWorkItem</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> bool</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>	key</span><span style=color:#eceff4>,</span><span> quit</span><span style=color:#81a1c1> :=</span><span> rsc</span><span style=color:#eceff4>.</span><span>queue</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>Get</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>	if</span><span> quit</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>		return false</span></span>
<span class=giallo-l><span style=color:#eceff4>	}</span></span>
<span class=giallo-l><span style=color:#81a1c1>	defer</span><span> rsc</span><span style=color:#eceff4>.</span><span>queue</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>Done</span><span style=color:#eceff4>(</span><span>key</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>	err</span><span style=color:#81a1c1> :=</span><span> rsc</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>syncHandler</span><span style=color:#eceff4>(</span><span>key</span><span style=color:#eceff4>.(</span><span style=color:#81a1c1>string</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#81a1c1>	if</span><span> err</span><span style=color:#81a1c1> == nil</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>		rsc</span><span style=color:#eceff4>.</span><span>queue</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>Forget</span><span style=color:#eceff4>(</span><span>key</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>		return true</span></span>
<span class=giallo-l><span style=color:#eceff4>	}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>	utilruntime</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>HandleError</span><span style=color:#eceff4>(</span><span>fmt</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>Errorf</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Sync </span><span style=color:#ebcb8b>%q</span><span style=color:#a3be8c> failed with </span><span style=color:#ebcb8b>%v</span><span style=color:#eceff4>",</span><span> key</span><span style=color:#eceff4>,</span><span> err</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span>	rsc</span><span style=color:#eceff4>.</span><span>queue</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>AddRateLimited</span><span style=color:#eceff4>(</span><span>key</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>	return true</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/controller/replicaset/replica_set.go#L432 rel=external>https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/controller/replicaset/replica_set.go#L432:34</a><p>è‚å¿ƒã®workerã¯queueã‹ã‚‰taskã‚’å–å¾—ã—ã¦ã€<code>ReplicaSetController.syncHandler()</code>å‡¦ç†ã‚’å‘¼ã³å‡ºã—ã¦ã„ã¾ã™ã€‚ ã“ã®queueã¾ã‚ã‚Šã‚‚slideã®å¾ŒåŠã§è§£èª¬ã•ã‚Œã¦ã„ã¾ã—ãŸãŒã€æ¦‚è¦ã¨ã—ã¦ã¯api-serverã‹ã‚‰controllerãŒé–¢å¿ƒã®ã‚ã‚‹Eventã«çµã£ã¦å–å¾—ã—ã¦ã„ã‚‹ã¨ç†è§£ã—ã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=go><span class=giallo-l><span style=color:#81a1c1>func</span><span style=color:#88c0d0> NewBaseController</span><span style=color:#eceff4>(</span><span>rsInformer appsinformers</span><span style=color:#eceff4>.</span><span>ReplicaSetInformer</span><span style=color:#eceff4>,</span><span> podInformer coreinformers</span><span style=color:#eceff4>.</span><span>PodInformer</span><span style=color:#eceff4>,</span><span> kubeClient clientset</span><span style=color:#eceff4>.</span><span>Interface</span><span style=color:#eceff4>,</span><span> burstReplicas</span><span style=color:#81a1c1> int</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>	gvk schema</span><span style=color:#eceff4>.</span><span>GroupVersionKind</span><span style=color:#eceff4>,</span><span> metricOwnerName</span><span style=color:#eceff4>,</span><span> queueName</span><span style=color:#81a1c1> string</span><span style=color:#eceff4>,</span><span> podControl controller</span><span style=color:#eceff4>.</span><span>PodControlInterface</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> *</span><span>ReplicaSetController</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>    //...</span></span>
<span class=giallo-l><span>    rsc</span><span style=color:#eceff4>.</span><span>syncHandler</span><span style=color:#81a1c1> =</span><span> rsc</span><span style=color:#eceff4>.</span><span>syncReplicaSet</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>	return</span><span> rsc</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/controller/replicaset/replica_set.go#L163 rel=external>https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/controller/replicaset/replica_set.go#L163</a><p><code>ReplicaSetController.syncHandler</code>ã«ã¯<code>syncReplicaSet</code>ãŒç”Ÿæˆå‡¦ç†æ™‚ã«ã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=go><span class=giallo-l><span style=color:#616e88>// syncReplicaSet will sync the ReplicaSet with the given key if it has had its expectations fulfilled,</span></span>
<span class=giallo-l><span style=color:#616e88>// meaning it did not expect to see any more of its pods created or deleted. This function is not meant to be</span></span>
<span class=giallo-l><span style=color:#616e88>// invoked concurrently with the same key.</span></span>
<span class=giallo-l><span style=color:#81a1c1>func</span><span style=color:#eceff4> (</span><span>rsc </span><span style=color:#81a1c1>*</span><span>ReplicaSetController</span><span style=color:#eceff4>)</span><span style=color:#88c0d0> syncReplicaSet</span><span style=color:#eceff4>(</span><span>key</span><span style=color:#81a1c1> string</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> error</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>	// ...</span></span>
<span class=giallo-l><span>	namespace</span><span style=color:#eceff4>,</span><span> name</span><span style=color:#eceff4>,</span><span> err</span><span style=color:#81a1c1> :=</span><span> cache</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>SplitMetaNamespaceKey</span><span style=color:#eceff4>(</span><span>key</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#616e88>	// ...</span></span>
<span class=giallo-l><span>	rs</span><span style=color:#eceff4>,</span><span> err</span><span style=color:#81a1c1> :=</span><span> rsc</span><span style=color:#eceff4>.</span><span>rsLister</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>ReplicaSets</span><span style=color:#eceff4>(</span><span>namespace</span><span style=color:#eceff4>).</span><span style=color:#88c0d0>Get</span><span style=color:#eceff4>(</span><span>name</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#616e88>	// ...</span></span>
<span class=giallo-l><span>	selector</span><span style=color:#eceff4>,</span><span> err</span><span style=color:#81a1c1> :=</span><span> metav1</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>LabelSelectorAsSelector</span><span style=color:#eceff4>(</span><span>rs</span><span style=color:#eceff4>.</span><span>Spec</span><span style=color:#eceff4>.</span><span>Selector</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#616e88>	// ...</span></span>
<span class=giallo-l><span>	allPods</span><span style=color:#eceff4>,</span><span> err</span><span style=color:#81a1c1> :=</span><span> rsc</span><span style=color:#eceff4>.</span><span>podLister</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>Pods</span><span style=color:#eceff4>(</span><span>rs</span><span style=color:#eceff4>.</span><span>Namespace</span><span style=color:#eceff4>).</span><span style=color:#88c0d0>List</span><span style=color:#eceff4>(</span><span>labels</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>Everything</span><span style=color:#eceff4>())</span></span>
<span class=giallo-l><span style=color:#616e88>	// ...</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>	// Ignore inactive pods.</span></span>
<span class=giallo-l><span>	filteredPods</span><span style=color:#81a1c1> :=</span><span> controller</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>FilterActivePods</span><span style=color:#eceff4>(</span><span>allPods</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>	// NOTE: filteredPods are pointing to objects from cache - if you need to</span></span>
<span class=giallo-l><span style=color:#616e88>	// modify them, you need to copy it first.</span></span>
<span class=giallo-l><span>	filteredPods</span><span style=color:#eceff4>,</span><span> err</span><span style=color:#81a1c1> =</span><span> rsc</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>claimPods</span><span style=color:#eceff4>(</span><span>rs</span><span style=color:#eceff4>,</span><span> selector</span><span style=color:#eceff4>,</span><span> filteredPods</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#616e88>	// ...</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>	var</span><span> manageReplicasErr</span><span style=color:#81a1c1> error</span></span>
<span class=giallo-l><span style=color:#81a1c1>	if</span><span> rsNeedsSync</span><span style=color:#81a1c1> &&</span><span> rs</span><span style=color:#eceff4>.</span><span>DeletionTimestamp</span><span style=color:#81a1c1> == nil</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>		manageReplicasErr</span><span style=color:#81a1c1> =</span><span> rsc</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>manageReplicas</span><span style=color:#eceff4>(</span><span>filteredPods</span><span style=color:#eceff4>,</span><span> rs</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>	}</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span></code></pre><p>æ¦‚è¦ã¨ã—ã¦ã¯ã€å‡¦ç†å¯¾è±¡ã®<code>ReplicaSet</code>ã¨filterlingã—ãŸ<code>Pod</code>ã‚’å–å¾—ã—ã¦ã€<code>ReplicaSetController.manageReplicas()</code>ã‚’å‘¼ã‚“ã§ã„ã¾ã™ã€‚ ã“ã‚Œã§ã‚ˆã†ã‚„ãslideã®æœ€åˆã®å‡¦ç†ã®ãŸã©ã‚Šç€ãã¾ã—ãŸã€‚<h3 id=replicasetcontroller-managereplicas><a aria-label="Anchor link for: replicasetcontroller-managereplicas" class=zola-anchor href=#replicasetcontroller-managereplicas><code>ReplicaSetController.manageReplicas()</code></a></h3><a href="https://speakerdeck.com/govargo/under-the-kubernetes-controller-36f9b71b-9781-4846-9625-23c31da93014?slide=20"> <figure><div class=fig-images-row><img , alt src=images/controller_2.jpeg></div></figure> </a><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=go><span class=giallo-l><span style=color:#616e88>// manageReplicas checks and updates replicas for the given ReplicaSet.</span></span>
<span class=giallo-l><span style=color:#616e88>// Does NOT modify &lt;filteredPods>.</span></span>
<span class=giallo-l><span style=color:#616e88>// It will requeue the replica set in case of an error while creating/deleting pods.</span></span>
<span class=giallo-l><span style=color:#81a1c1>func</span><span style=color:#eceff4> (</span><span>rsc </span><span style=color:#81a1c1>*</span><span>ReplicaSetController</span><span style=color:#eceff4>)</span><span style=color:#88c0d0> manageReplicas</span><span style=color:#eceff4>(</span><span>filteredPods</span><span style=color:#eceff4> []</span><span style=color:#81a1c1>*</span><span>v1</span><span style=color:#eceff4>.</span><span>Pod</span><span style=color:#eceff4>,</span><span> rs</span><span style=color:#81a1c1> *</span><span>apps</span><span style=color:#eceff4>.</span><span>ReplicaSet</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> error</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>	diff</span><span style=color:#81a1c1> :=</span><span style=color:#88c0d0> len</span><span style=color:#eceff4>(</span><span>filteredPods</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> - int</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>*</span><span style=color:#eceff4>(</span><span>rs</span><span style=color:#eceff4>.</span><span>Spec</span><span style=color:#eceff4>.</span><span>Replicas</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span>	rsKey</span><span style=color:#eceff4>,</span><span> err</span><span style=color:#81a1c1> :=</span><span> controller</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>KeyFunc</span><span style=color:#eceff4>(</span><span>rs</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#616e88>	// ...</span></span>
<span class=giallo-l><span style=color:#81a1c1>	if</span><span> diff</span><span style=color:#81a1c1> &lt;</span><span style=color:#b48ead> 0</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>		diff</span><span style=color:#81a1c1> *= -</span><span style=color:#b48ead>1</span></span>
<span class=giallo-l><span style=color:#616e88>		// ...</span></span>
<span class=giallo-l><span>		successfulCreations</span><span style=color:#eceff4>,</span><span> err</span><span style=color:#81a1c1> :=</span><span style=color:#88c0d0> slowStartBatch</span><span style=color:#eceff4>(</span><span>diff</span><span style=color:#eceff4>,</span><span> controller</span><span style=color:#eceff4>.</span><span>SlowStartInitialBatchSize</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> func</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> error</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>			err</span><span style=color:#81a1c1> :=</span><span> rsc</span><span style=color:#eceff4>.</span><span>podControl</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>CreatePodsWithControllerRef</span><span style=color:#eceff4>(</span><span>rs</span><span style=color:#eceff4>.</span><span>Namespace</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> &</span><span>rs</span><span style=color:#eceff4>.</span><span>Spec</span><span style=color:#eceff4>.</span><span>Template</span><span style=color:#eceff4>,</span><span> rs</span><span style=color:#eceff4>,</span><span> metav1</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>NewControllerRef</span><span style=color:#eceff4>(</span><span>rs</span><span style=color:#eceff4>,</span><span> rsc</span><span style=color:#eceff4>.</span><span>GroupVersionKind</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#81a1c1>			if</span><span> err</span><span style=color:#81a1c1> != nil &&</span><span> errors</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>IsTimeout</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#616e88>				// ...</span></span>
<span class=giallo-l><span style=color:#81a1c1>				return nil</span></span>
<span class=giallo-l><span style=color:#eceff4>			}</span></span>
<span class=giallo-l><span style=color:#81a1c1>			return</span><span> err</span></span>
<span class=giallo-l><span style=color:#eceff4>		})</span></span>
<span class=giallo-l><span style=color:#616e88>		// ...</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>		return</span><span> err</span></span></code></pre><p><a href=https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/controller/replicaset/replica_set.go#L459 rel=external>https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/controller/replicaset/replica_set.go#L459:34</a><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=go><span class=giallo-l><span style=color:#81a1c1>func</span><span style=color:#88c0d0> slowStartBatch</span><span style=color:#eceff4>(</span><span>count</span><span style=color:#81a1c1> int</span><span style=color:#eceff4>,</span><span> initialBatchSize</span><span style=color:#81a1c1> int</span><span style=color:#eceff4>,</span><span> fn</span><span style=color:#81a1c1> func</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> error</span><span style=color:#eceff4>) (</span><span style=color:#81a1c1>int</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> error</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span>	remaining</span><span style=color:#81a1c1> :=</span><span> count</span></span>
<span class=giallo-l><span>	successes</span><span style=color:#81a1c1> :=</span><span style=color:#b48ead> 0</span></span>
<span class=giallo-l><span style=color:#81a1c1>	for</span><span> batchSize</span><span style=color:#81a1c1> :=</span><span> integer</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>IntMin</span><span style=color:#eceff4>(</span><span>remaining</span><span style=color:#eceff4>,</span><span> initialBatchSize</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span><span> batchSize</span><span style=color:#81a1c1> ></span><span style=color:#b48ead> 0</span><span style=color:#81a1c1>;</span><span> batchSize</span><span style=color:#81a1c1> =</span><span> integer</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>IntMin</span><span style=color:#eceff4>(</span><span style=color:#b48ead>2</span><span style=color:#81a1c1>*</span><span>batchSize</span><span style=color:#eceff4>,</span><span> remaining</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span>		errCh</span><span style=color:#81a1c1> :=</span><span style=color:#88c0d0> make</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>chan error</span><span style=color:#eceff4>,</span><span> batchSize</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>		var</span><span> wg sync</span><span style=color:#eceff4>.</span><span>WaitGroup</span></span>
<span class=giallo-l><span>		wg</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>Add</span><span style=color:#eceff4>(</span><span>batchSize</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>		for</span><span> i</span><span style=color:#81a1c1> :=</span><span style=color:#b48ead> 0</span><span style=color:#81a1c1>;</span><span> i</span><span style=color:#81a1c1> &lt;</span><span> batchSize</span><span style=color:#81a1c1>;</span><span> i</span><span style=color:#81a1c1>++</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>			go func</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>				defer</span><span> wg</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>Done</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>				if</span><span> err</span><span style=color:#81a1c1> :=</span><span style=color:#88c0d0> fn</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>;</span><span> err</span><span style=color:#81a1c1> != nil</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>					errCh</span><span style=color:#81a1c1> &lt;-</span><span> err</span></span>
<span class=giallo-l><span style=color:#eceff4>				}</span></span>
<span class=giallo-l><span style=color:#eceff4>			}()</span></span>
<span class=giallo-l><span style=color:#eceff4>		}</span></span>
<span class=giallo-l><span>		wg</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>Wait</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span>		curSuccesses</span><span style=color:#81a1c1> :=</span><span> batchSize</span><span style=color:#81a1c1> -</span><span style=color:#88c0d0> len</span><span style=color:#eceff4>(</span><span>errCh</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span>		successes</span><span style=color:#81a1c1> +=</span><span> curSuccesses</span></span>
<span class=giallo-l><span style=color:#81a1c1>		if</span><span style=color:#88c0d0> len</span><span style=color:#eceff4>(</span><span>errCh</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> ></span><span style=color:#b48ead> 0</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>			return</span><span> successes</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> &lt;-</span><span>errCh</span></span>
<span class=giallo-l><span style=color:#eceff4>		}</span></span>
<span class=giallo-l><span>		remaining</span><span style=color:#81a1c1> -=</span><span> batchSize</span></span>
<span class=giallo-l><span style=color:#eceff4>	}</span></span>
<span class=giallo-l><span style=color:#81a1c1>	return</span><span> successes</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> nil</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/controller/replicaset/replica_set.go#L658 rel=external>https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/controller/replicaset/replica_set.go#L658</a><p><code>Pod</code>ã¨<code>ReplicaSet</code>ã®replicaæ•°ã®å·®åˆ†ã‚’ã¨ã£ã¦ã€<code>Pod</code>ã®ä½œæˆå‡¦ç†ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™ã­ã€‚ <code>slowStartBatch()</code>ã¯ä½œæˆå‡¦ç†ã‚’ä¸¦åˆ—ã§èµ°ã‚‰ã›ã‚‹helperé–¢æ•°ã®ã‚ˆã†ã§ã™ã€‚ æ®µéšçš„ã«ä¸€åº¦ã«èµ·å‹•ã™ã‚‹goroutineã®æ•°ã‚’å¢—ã‚„ã—ã¦ã„ãå‡¦ç†ã®æ›¸ãæ–¹ã¨ã—ã¦éå¸¸ã«å‚è€ƒã«ãªã‚Šã¾ã™ã€‚(<code>IntMin()</code>ã®ã‚ˆã†ãªå‡¦ç†ã¯std libã§æ¬²ã—ã„ã¨æ€ã£ã¦ã—ã¾ã†) <code>ReplicaSetController.podControl</code>ã¯interfaceã§ã€å®Ÿéš›ã®<code>Pod</code>ä½œæˆå‡¦ç†ã¯<code>ReadPodControl</code>ãŒå®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=go><span class=giallo-l><span style=color:#81a1c1>func</span><span style=color:#eceff4> (</span><span>r RealPodControl</span><span style=color:#eceff4>)</span><span style=color:#88c0d0> CreatePodsWithControllerRef</span><span style=color:#eceff4>(</span><span>namespace</span><span style=color:#81a1c1> string</span><span style=color:#eceff4>,</span><span> template</span><span style=color:#81a1c1> *</span><span>v1</span><span style=color:#eceff4>.</span><span>PodTemplateSpec</span><span style=color:#eceff4>,</span><span> controllerObject runtime</span><span style=color:#eceff4>.</span><span>Object</span><span style=color:#eceff4>,</span><span> controllerRef</span><span style=color:#81a1c1> *</span><span>metav1</span><span style=color:#eceff4>.</span><span>OwnerReference</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> error</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>	if</span><span> err</span><span style=color:#81a1c1> :=</span><span style=color:#88c0d0> validateControllerRef</span><span style=color:#eceff4>(</span><span>controllerRef</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span><span> err</span><span style=color:#81a1c1> != nil</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>		return</span><span> err</span></span>
<span class=giallo-l><span style=color:#eceff4>	}</span></span>
<span class=giallo-l><span style=color:#81a1c1>	return</span><span> r</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>createPods</span><span style=color:#eceff4>("",</span><span> namespace</span><span style=color:#eceff4>,</span><span> template</span><span style=color:#eceff4>,</span><span> controllerObject</span><span style=color:#eceff4>,</span><span> controllerRef</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href="https://speakerdeck.com/govargo/under-the-kubernetes-controller-36f9b71b-9781-4846-9625-23c31da93014?slide=19" rel=external>https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/controller/controller_utils.go#L523</a><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=go><span class=giallo-l><span style=color:#81a1c1>func</span><span style=color:#eceff4> (</span><span>r RealPodControl</span><span style=color:#eceff4>)</span><span style=color:#88c0d0> createPods</span><span style=color:#eceff4>(</span><span>nodeName</span><span style=color:#eceff4>,</span><span> namespace</span><span style=color:#81a1c1> string</span><span style=color:#eceff4>,</span><span> template</span><span style=color:#81a1c1> *</span><span>v1</span><span style=color:#eceff4>.</span><span>PodTemplateSpec</span><span style=color:#eceff4>,</span><span> object runtime</span><span style=color:#eceff4>.</span><span>Object</span><span style=color:#eceff4>,</span><span> controllerRef</span><span style=color:#81a1c1> *</span><span>metav1</span><span style=color:#eceff4>.</span><span>OwnerReference</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> error</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>	pod</span><span style=color:#eceff4>,</span><span> err</span><span style=color:#81a1c1> :=</span><span style=color:#88c0d0> GetPodFromTemplate</span><span style=color:#eceff4>(</span><span>template</span><span style=color:#eceff4>,</span><span> object</span><span style=color:#eceff4>,</span><span> controllerRef</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#616e88>	// ...</span></span>
<span class=giallo-l><span style=color:#81a1c1>	if</span><span style=color:#88c0d0> len</span><span style=color:#eceff4>(</span><span>nodeName</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> !=</span><span style=color:#b48ead> 0</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>		pod</span><span style=color:#eceff4>.</span><span>Spec</span><span style=color:#eceff4>.</span><span>NodeName</span><span style=color:#81a1c1> =</span><span> nodeName</span></span>
<span class=giallo-l><span style=color:#eceff4>	}</span></span>
<span class=giallo-l><span style=color:#616e88>	// ...</span></span>
<span class=giallo-l><span>	newPod</span><span style=color:#eceff4>,</span><span> err</span><span style=color:#81a1c1> :=</span><span> r</span><span style=color:#eceff4>.</span><span>KubeClient</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>CoreV1</span><span style=color:#eceff4>().</span><span style=color:#88c0d0>Pods</span><span style=color:#eceff4>(</span><span>namespace</span><span style=color:#eceff4>).</span><span style=color:#88c0d0>Create</span><span style=color:#eceff4>(</span><span>pod</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>	if</span><span> err</span><span style=color:#81a1c1> != nil</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>		r</span><span style=color:#eceff4>.</span><span>Recorder</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>Eventf</span><span style=color:#eceff4>(</span><span>object</span><span style=color:#eceff4>,</span><span> v1</span><span style=color:#eceff4>.</span><span>EventTypeWarning</span><span style=color:#eceff4>,</span><span> FailedCreatePodReason</span><span style=color:#eceff4>, "</span><span style=color:#a3be8c>Error creating: </span><span style=color:#ebcb8b>%v</span><span style=color:#eceff4>",</span><span> err</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>		return</span><span> err</span></span>
<span class=giallo-l><span style=color:#eceff4>	}</span></span>
<span class=giallo-l><span style=color:#616e88>	// ...</span></span>
<span class=giallo-l><span style=color:#81a1c1>	return nil</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href="https://speakerdeck.com/govargo/under-the-kubernetes-controller-36f9b71b-9781-4846-9625-23c31da93014?slide=19" rel=external>https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/controller/controller_utils.go#L567</a><p>ç¢ºã‹ã«slideã®ã¨ãŠã‚Šã€<code>r.createPods("", namespace, template, controllerObject, controllerRef)</code> ã¨ã—ã¦<code>nodeName</code>ãŒç©ºã®<code>Pod</code>ã‚’ç”Ÿæˆã—ã¦ã„ã‚‹ã®ãŒã‚ã‹ã‚Šã¾ã™ã€‚<h3 id=schedulergaenqueue><a aria-label="Anchor link for: schedulergaenqueue" class=zola-anchor href=#schedulergaenqueue>SchedulerãŒenqueue</a></h3><a href="https://speakerdeck.com/govargo/under-the-kubernetes-controller-36f9b71b-9781-4846-9625-23c31da93014?slide=21"> <figure><div class=fig-images-row><img , alt src=images/controller_3.jpeg></div></figure> </a><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=go><span class=giallo-l><span style=color:#81a1c1>func</span><span style=color:#88c0d0> AddAllEventHandlers</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>...</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span>	podInformer</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>Informer</span><span style=color:#eceff4>().</span><span style=color:#88c0d0>AddEventHandler</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>		cache</span><span style=color:#eceff4>.</span><span>FilteringResourceEventHandler</span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span>			FilterFunc</span><span style=color:#eceff4>:</span><span style=color:#81a1c1> func</span><span style=color:#eceff4>(</span><span>obj</span><span style=color:#81a1c1> interface</span><span style=color:#eceff4>{})</span><span style=color:#81a1c1> bool</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>				switch</span><span> t</span><span style=color:#81a1c1> :=</span><span> obj</span><span style=color:#eceff4>.(</span><span style=color:#81a1c1>type</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>				case *</span><span>v1</span><span style=color:#eceff4>.</span><span>Pod</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#81a1c1>					return !</span><span style=color:#88c0d0>assignedPod</span><span style=color:#eceff4>(</span><span>t</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> &&</span><span style=color:#88c0d0> responsibleForPod</span><span style=color:#eceff4>(</span><span>t</span><span style=color:#eceff4>,</span><span> schedulerName</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>				case</span><span> cache</span><span style=color:#eceff4>.</span><span>DeletedFinalStateUnknown</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#81a1c1>					if</span><span> pod</span><span style=color:#eceff4>,</span><span> ok</span><span style=color:#81a1c1> :=</span><span> t</span><span style=color:#eceff4>.</span><span>Obj</span><span style=color:#eceff4>.(</span><span style=color:#81a1c1>*</span><span>v1</span><span style=color:#eceff4>.</span><span>Pod</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span><span> ok</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>						return !</span><span style=color:#88c0d0>assignedPod</span><span style=color:#eceff4>(</span><span>pod</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> &&</span><span style=color:#88c0d0> responsibleForPod</span><span style=color:#eceff4>(</span><span>pod</span><span style=color:#eceff4>,</span><span> schedulerName</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>					}</span></span>
<span class=giallo-l><span>					utilruntime</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>HandleError</span><span style=color:#eceff4>(</span><span>fmt</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>Errorf</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>unable to convert object </span><span style=color:#ebcb8b>%T</span><span style=color:#a3be8c> to *v1.Pod in </span><span style=color:#ebcb8b>%T</span><span style=color:#eceff4>",</span><span> obj</span><span style=color:#eceff4>,</span><span> sched</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#81a1c1>					return false</span></span>
<span class=giallo-l><span style=color:#81a1c1>				default</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span>					utilruntime</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>HandleError</span><span style=color:#eceff4>(</span><span>fmt</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>Errorf</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>unable to handle object in </span><span style=color:#ebcb8b>%T</span><span style=color:#a3be8c>: </span><span style=color:#ebcb8b>%T</span><span style=color:#eceff4>",</span><span> sched</span><span style=color:#eceff4>,</span><span> obj</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#81a1c1>					return false</span></span>
<span class=giallo-l><span style=color:#eceff4>				}</span></span>
<span class=giallo-l><span style=color:#eceff4>			},</span></span>
<span class=giallo-l><span>			Handler</span><span style=color:#eceff4>:</span><span> cache</span><span style=color:#eceff4>.</span><span>ResourceEventHandlerFuncs</span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span>				AddFunc</span><span style=color:#eceff4>:</span><span>    sched</span><span style=color:#eceff4>.</span><span>addPodToSchedulingQueue</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>				UpdateFunc</span><span style=color:#eceff4>:</span><span> sched</span><span style=color:#eceff4>.</span><span>updatePodInSchedulingQueue</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>				DeleteFunc</span><span style=color:#eceff4>:</span><span> sched</span><span style=color:#eceff4>.</span><span>deletePodFromSchedulingQueue</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>			},</span></span>
<span class=giallo-l><span style=color:#eceff4>		},</span></span>
<span class=giallo-l><span style=color:#eceff4>	)</span></span></code></pre><p><a href=https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/scheduler/eventhandlers.go#L418 rel=external>https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/scheduler/eventhandlers.go#L418</a><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=go><span class=giallo-l><span style=color:#81a1c1>func</span><span style=color:#88c0d0> assignedPod</span><span style=color:#eceff4>(</span><span>pod</span><span style=color:#81a1c1> *</span><span>v1</span><span style=color:#eceff4>.</span><span>Pod</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> bool</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>	return</span><span style=color:#88c0d0> len</span><span style=color:#eceff4>(</span><span>pod</span><span style=color:#eceff4>.</span><span>Spec</span><span style=color:#eceff4>.</span><span>NodeName</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> !=</span><span style=color:#b48ead> 0</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/scheduler/eventhandlers.go#L418 rel=external>https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/scheduler/eventhandlers.go#L323</a><p><code>Scheduler</code>ãŒ<code>podInformer</code>ã«event handlerã‚’ç™»éŒ²ã™ã‚‹éš›ã«ã€podãŒassigne(<code>NodeName</code>ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹)ã•ã‚Œã¦ã„ãªã„ã“ã¨ã‚’æ¡ä»¶ã¨ã™ã‚‹filterã‚’è¨­å®šã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚<h3 id=kubelethaskip><a aria-label="Anchor link for: kubelethaskip" class=zola-anchor href=#kubelethaskip>kubeletã¯skip</a></h3><a href="https://speakerdeck.com/govargo/under-the-kubernetes-controller-36f9b71b-9781-4846-9625-23c31da93014?slide=22"> <figure><div class=fig-images-row><img , alt src=images/controller_4.jpeg></div></figure> </a><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=go><span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>// NewSourceApiserver creates a config source that watches and pulls from the apiserver.</span></span>
<span class=giallo-l><span style=color:#81a1c1>func</span><span style=color:#88c0d0> NewSourceApiserver</span><span style=color:#eceff4>(</span><span>c clientset</span><span style=color:#eceff4>.</span><span>Interface</span><span style=color:#eceff4>,</span><span> nodeName types</span><span style=color:#eceff4>.</span><span>NodeName</span><span style=color:#eceff4>,</span><span> updates</span><span style=color:#81a1c1> chan&lt;- interface</span><span style=color:#eceff4>{}) {</span></span>
<span class=giallo-l><span>	lw</span><span style=color:#81a1c1> :=</span><span> cache</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>NewListWatchFromClient</span><span style=color:#eceff4>(</span><span>c</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>CoreV1</span><span style=color:#eceff4>().</span><span style=color:#88c0d0>RESTClient</span><span style=color:#eceff4>(), "</span><span style=color:#a3be8c>pods</span><span style=color:#eceff4>",</span><span> metav1</span><span style=color:#eceff4>.</span><span>NamespaceAll</span><span style=color:#eceff4>,</span><span> fields</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>OneTermEqualSelector</span><span style=color:#eceff4>(</span><span>api</span><span style=color:#eceff4>.</span><span>PodHostField</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> string</span><span style=color:#eceff4>(</span><span>nodeName</span><span style=color:#eceff4>)))</span></span>
<span class=giallo-l><span style=color:#88c0d0>	newSourceApiserverFromLW</span><span style=color:#eceff4>(</span><span>lw</span><span style=color:#eceff4>,</span><span> updates</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/kubelet/config/apiserver.go#L32 rel=external>https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/kubelet/config/apiserver.go#L32</a><p><code>kubelet</code>ã®api serverã¸ã®clientç”Ÿæˆå‡¦ç†æ™‚ã«ã€<code>Pod</code>ã®HoståãŒ(ãŠãã‚‰ã)è‡ªèº«ã®nodeåã¨ä¸€è‡´ã™ã‚‹Filterã‚’è¨­å®šã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚<h3 id=schedulerganode-namewoshe-ding><a aria-label="Anchor link for: schedulerganode-namewoshe-ding" class=zola-anchor href=#schedulerganode-namewoshe-ding>SchedulerãŒnode nameã‚’è¨­å®š</a></h3><a href="https://speakerdeck.com/govargo/under-the-kubernetes-controller-36f9b71b-9781-4846-9625-23c31da93014?slide=23"> <figure><div class=fig-images-row><img , alt src=images/controller_5.jpeg></div></figure> </a><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=go><span class=giallo-l><span style=color:#81a1c1>func</span><span style=color:#eceff4> (</span><span>sched </span><span style=color:#81a1c1>*</span><span>Scheduler</span><span style=color:#eceff4>)</span><span style=color:#88c0d0> scheduleOne</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#616e88>	// ...</span></span>
<span class=giallo-l><span>	pod</span><span style=color:#81a1c1> :=</span><span> sched</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>NextPod</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#616e88>	// ...</span></span>
<span class=giallo-l><span>	scheduleResult</span><span style=color:#eceff4>,</span><span> err</span><span style=color:#81a1c1> :=</span><span> sched</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>schedule</span><span style=color:#eceff4>(</span><span>pod</span><span style=color:#eceff4>,</span><span> pluginContext</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#616e88>	// ...</span></span>
<span class=giallo-l><span>	assumedPod</span><span style=color:#81a1c1> :=</span><span> pod</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>DeepCopy</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#616e88>	// ...</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>	// assume modifies `assumedPod` by setting NodeName=scheduleResult.SuggestedHost</span></span>
<span class=giallo-l><span>	err</span><span style=color:#81a1c1> =</span><span> sched</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>assume</span><span style=color:#eceff4>(</span><span>assumedPod</span><span style=color:#eceff4>,</span><span> scheduleResult</span><span style=color:#eceff4>.</span><span>SuggestedHost</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#616e88>	// ...</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span></code></pre><p>[https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/scheduler/scheduler.go#L516](white-space:nowrap; overflow:scroll;)<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=go><span class=giallo-l><span style=color:#81a1c1>func</span><span style=color:#eceff4> (</span><span>sched </span><span style=color:#81a1c1>*</span><span>Scheduler</span><span style=color:#eceff4>)</span><span style=color:#88c0d0> assume</span><span style=color:#eceff4>(</span><span>assumed</span><span style=color:#81a1c1> *</span><span>v1</span><span style=color:#eceff4>.</span><span>Pod</span><span style=color:#eceff4>,</span><span> host</span><span style=color:#81a1c1> string</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> error</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span>	assumed</span><span style=color:#eceff4>.</span><span>Spec</span><span style=color:#eceff4>.</span><span>NodeName</span><span style=color:#81a1c1> =</span><span> host</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span style=color:#81a1c1>	return nil</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>[https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/scheduler/scheduler.go#L447](white-space:nowrap; overflow:scroll;)<p>Schedulingå‡¦ç†è‡ªä½“ã¯ä¸€å¤§Topicã§ã™ãŒã€æµã‚Œã¨ã—ã¦ã¯ã€ãªã‚“ã‚‰ã‹ã®æ–¹æ³•ã§Nodeåã‚’é¸å‡ºã—ã¦ã€<code>Pod</code>ã®nodeåã«æŒ‡å®šã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚<h3 id=kubeletgakontenawoqi-dong><a aria-label="Anchor link for: kubeletgakontenawoqi-dong" class=zola-anchor href=#kubeletgakontenawoqi-dong><code>kubelet</code>ãŒã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•</a></h3><a href="https://speakerdeck.com/govargo/under-the-kubernetes-controller-36f9b71b-9781-4846-9625-23c31da93014?slide=24"> <figure><div class=fig-images-row><img , alt src=images/controller_6.jpeg></div></figure> </a><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=go><span class=giallo-l><span style=color:#81a1c1>func</span><span style=color:#eceff4> (</span><span>m </span><span style=color:#81a1c1>*</span><span>kubeGenericRuntimeManager</span><span style=color:#eceff4>)</span><span style=color:#88c0d0> SyncPod</span><span style=color:#eceff4>(</span><span>pod</span><span style=color:#81a1c1> *</span><span>v1</span><span style=color:#eceff4>.</span><span>Pod</span><span style=color:#eceff4>,</span><span> podStatus</span><span style=color:#81a1c1> *</span><span>kubecontainer</span><span style=color:#eceff4>.</span><span>PodStatus</span><span style=color:#eceff4>,</span><span> pullSecrets</span><span style=color:#eceff4> []</span><span>v1</span><span style=color:#eceff4>.</span><span>Secret</span><span style=color:#eceff4>,</span><span> backOff</span><span style=color:#81a1c1> *</span><span>flowcontrol</span><span style=color:#eceff4>.</span><span>Backoff</span><span style=color:#eceff4>) (</span><span>result kubecontainer</span><span style=color:#eceff4>.</span><span>PodSyncResult</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#616e88> 	// ...</span></span>
<span class=giallo-l><span style=color:#616e88>	// Step 6: start the init container.</span></span>
<span class=giallo-l><span style=color:#81a1c1>	if</span><span> container</span><span style=color:#81a1c1> :=</span><span> podContainerChanges</span><span style=color:#eceff4>.</span><span>NextInitContainerToStart</span><span style=color:#81a1c1>;</span><span> container</span><span style=color:#81a1c1> != nil</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>		// Start the next init container.</span></span>
<span class=giallo-l><span style=color:#81a1c1>		if</span><span> err</span><span style=color:#81a1c1> :=</span><span style=color:#88c0d0> start</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>init container</span><span style=color:#eceff4>",</span><span> container</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span><span> err</span><span style=color:#81a1c1> != nil</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>			return</span></span>
<span class=giallo-l><span style=color:#eceff4>		}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>		// Successfully started the container; clear the entry in the failure</span></span>
<span class=giallo-l><span>		klog</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>V</span><span style=color:#eceff4>(</span><span style=color:#b48ead>4</span><span style=color:#eceff4>).</span><span style=color:#88c0d0>Infof</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Completed init container </span><span style=color:#ebcb8b>%q</span><span style=color:#a3be8c> for pod </span><span style=color:#ebcb8b>%q</span><span style=color:#eceff4>",</span><span> container</span><span style=color:#eceff4>.</span><span>Name</span><span style=color:#eceff4>,</span><span> format</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>Pod</span><span style=color:#eceff4>(</span><span>pod</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#eceff4>	}</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span></code></pre><p><a href=https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/kubelet/kuberuntime/kuberuntime_manager.go#L803 rel=external>https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/kubelet/kuberuntime/kuberuntime_manager.go#L803</a><p><code>kubelet</code>ã®å‡¦ç†ã¯ã¾ã£ãŸãè¿½ãˆã¦ã„ãªã„ã®ã§ã™ãŒã€ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã—ã¦ã„ã‚‹ã‚ˆã†ãªå‡¦ç†ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚<h3 id=kubeletgapodnostatuswogeng-xin><a aria-label="Anchor link for: kubeletgapodnostatuswogeng-xin" class=zola-anchor href=#kubeletgapodnostatuswogeng-xin><code>kubelet</code>ãŒ<code>Pod</code>ã®statusã‚’æ›´æ–°</a></h3><p><a href="https://speakerd.s3.amazonaws.com/presentations/173fdf8b50f445ba895b82fb6650825c/preview_slide_24.jpg?13730934:image=https://speakerd.s3.amazonaws.com/presentations/173fdf8b50f445ba895b82fb6650825c/preview_slide_24.jpg?13730934" rel=external>https://speakerd.s3.amazonaws.com/presentations/173fdf8b50f445ba895b82fb6650825c/preview_slide_24.jpg?13730934:image=https://speakerd.s3.amazonaws.com/presentations/173fdf8b50f445ba895b82fb6650825c/preview_slide_24.jpg?13730934</a><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=go><span class=giallo-l><span style=color:#81a1c1>func</span><span style=color:#eceff4> (</span><span>kl </span><span style=color:#81a1c1>*</span><span>Kubelet</span><span style=color:#eceff4>)</span><span style=color:#88c0d0> syncPod</span><span style=color:#eceff4>(</span><span>o syncPodOptions</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> error</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>	// pull out the required options</span></span>
<span class=giallo-l><span>	pod</span><span style=color:#81a1c1> :=</span><span> o</span><span style=color:#eceff4>.</span><span>pod</span></span>
<span class=giallo-l><span>	mirrorPod</span><span style=color:#81a1c1> :=</span><span> o</span><span style=color:#eceff4>.</span><span>mirrorPod</span></span>
<span class=giallo-l><span>	podStatus</span><span style=color:#81a1c1> :=</span><span> o</span><span style=color:#eceff4>.</span><span>podStatus</span></span>
<span class=giallo-l><span>	updateType</span><span style=color:#81a1c1> :=</span><span> o</span><span style=color:#eceff4>.</span><span>updateType</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>	// ...</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>	// Generate final API pod status with pod and status manager status</span></span>
<span class=giallo-l><span>	apiPodStatus</span><span style=color:#81a1c1> :=</span><span> kl</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>generateAPIPodStatus</span><span style=color:#eceff4>(</span><span>pod</span><span style=color:#eceff4>,</span><span> podStatus</span><span style=color:#eceff4>)</span></span></code></pre><p><a href=https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/kubelet/kubelet.go#L1481 rel=external>https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/kubelet/kubelet.go#L1481</a><h3 id=podnoterminating><a aria-label="Anchor link for: podnoterminating" class=zola-anchor href=#podnoterminating><code>Pod</code>ã®Terminating</a></h3><a href="https://speakerdeck.com/govargo/under-the-kubernetes-controller-36f9b71b-9781-4846-9625-23c31da93014?slide=26"> <figure><div class=fig-images-row><img , alt src=images/controller_7.jpeg></div></figure> </a><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=go><span class=giallo-l><span style=color:#616e88>// dispatchWork starts the asynchronous sync of the pod in a pod worker.</span></span>
<span class=giallo-l><span style=color:#616e88>// If the pod is terminated, dispatchWork</span></span>
<span class=giallo-l><span style=color:#81a1c1>func</span><span style=color:#eceff4> (</span><span>kl </span><span style=color:#81a1c1>*</span><span>Kubelet</span><span style=color:#eceff4>)</span><span style=color:#88c0d0> dispatchWork</span><span style=color:#eceff4>(</span><span>pod</span><span style=color:#81a1c1> *</span><span>v1</span><span style=color:#eceff4>.</span><span>Pod</span><span style=color:#eceff4>,</span><span> syncType kubetypes</span><span style=color:#eceff4>.</span><span>SyncPodType</span><span style=color:#eceff4>,</span><span> mirrorPod</span><span style=color:#81a1c1> *</span><span>v1</span><span style=color:#eceff4>.</span><span>Pod</span><span style=color:#eceff4>,</span><span> start time</span><span style=color:#eceff4>.</span><span>Time</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>	if</span><span> kl</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>podIsTerminated</span><span style=color:#eceff4>(</span><span>pod</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>		if</span><span> pod</span><span style=color:#eceff4>.</span><span>DeletionTimestamp</span><span style=color:#81a1c1> != nil</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>			// If the pod is in a terminated state, there is no pod worker to</span></span>
<span class=giallo-l><span style=color:#616e88>			// handle the work item. Check if the DeletionTimestamp has been</span></span>
<span class=giallo-l><span style=color:#616e88>			// set, and force a status update to trigger a pod deletion request</span></span>
<span class=giallo-l><span style=color:#616e88>			// to the apiserver.</span></span>
<span class=giallo-l><span>			kl</span><span style=color:#eceff4>.</span><span>statusManager</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>TerminatePod</span><span style=color:#eceff4>(</span><span>pod</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>		}</span></span>
<span class=giallo-l><span style=color:#81a1c1>		return</span></span>
<span class=giallo-l><span style=color:#eceff4>	}</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span></code></pre><p><a href=https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/kubelet/kubelet.go#L1999 rel=external>https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/kubelet/kubelet.go#L1999</a><h3 id=replicasetcontrollergapodwoxue-chu><a aria-label="Anchor link for: replicasetcontrollergapodwoxue-chu" class=zola-anchor href=#replicasetcontrollergapodwoxue-chu><code>ReplicaSetController</code>ãŒ<code>Pod</code>ã‚’å‰Šé™¤</a></h3><a href="https://speakerdeck.com/govargo/under-the-kubernetes-controller-36f9b71b-9781-4846-9625-23c31da93014?slide=28"> <figure><div class=fig-images-row><img , alt src=images/controller_8.jpeg></div></figure> </a><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=go><span class=giallo-l><span style=color:#81a1c1>func</span><span style=color:#eceff4> (</span><span>rsc </span><span style=color:#81a1c1>*</span><span>ReplicaSetController</span><span style=color:#eceff4>)</span><span style=color:#88c0d0> manageReplicas</span><span style=color:#eceff4>(</span><span>filteredPods</span><span style=color:#eceff4> []</span><span style=color:#81a1c1>*</span><span>v1</span><span style=color:#eceff4>.</span><span>Pod</span><span style=color:#eceff4>,</span><span> rs</span><span style=color:#81a1c1> *</span><span>apps</span><span style=color:#eceff4>.</span><span>ReplicaSet</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> error</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>	diff</span><span style=color:#81a1c1> :=</span><span style=color:#88c0d0> len</span><span style=color:#eceff4>(</span><span>filteredPods</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> - int</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>*</span><span style=color:#eceff4>(</span><span>rs</span><span style=color:#eceff4>.</span><span>Spec</span><span style=color:#eceff4>.</span><span>Replicas</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span>	rsKey</span><span style=color:#eceff4>,</span><span> err</span><span style=color:#81a1c1> :=</span><span> controller</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>KeyFunc</span><span style=color:#eceff4>(</span><span>rs</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#616e88>	// ...</span></span>
<span class=giallo-l><span style=color:#eceff4>	}</span></span>
<span class=giallo-l><span style=color:#81a1c1>	if</span><span> diff</span><span style=color:#81a1c1> &lt;</span><span style=color:#b48ead> 0</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>		// ...</span></span>
<span class=giallo-l><span style=color:#eceff4>	}</span><span style=color:#81a1c1> else if</span><span> diff</span><span style=color:#81a1c1> ></span><span style=color:#b48ead> 0</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>		// ...</span></span>
<span class=giallo-l><span style=color:#616e88>		// Choose which Pods to delete, preferring those in earlier phases of startup.</span></span>
<span class=giallo-l><span>		podsToDelete</span><span style=color:#81a1c1> :=</span><span style=color:#88c0d0> getPodsToDelete</span><span style=color:#eceff4>(</span><span>filteredPods</span><span style=color:#eceff4>,</span><span> diff</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#616e88>		// ...</span></span>
<span class=giallo-l><span>		errCh</span><span style=color:#81a1c1> :=</span><span style=color:#88c0d0> make</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>chan error</span><span style=color:#eceff4>,</span><span> diff</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>		var</span><span> wg sync</span><span style=color:#eceff4>.</span><span>WaitGroup</span></span>
<span class=giallo-l><span>		wg</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>Add</span><span style=color:#eceff4>(</span><span>diff</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>		for</span><span> _</span><span style=color:#eceff4>,</span><span> pod</span><span style=color:#81a1c1> := range</span><span> podsToDelete</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>			go func</span><span style=color:#eceff4>(</span><span>targetPod</span><span style=color:#81a1c1> *</span><span>v1</span><span style=color:#eceff4>.</span><span>Pod</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>				defer</span><span> wg</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>Done</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>				if</span><span> err</span><span style=color:#81a1c1> :=</span><span> rsc</span><span style=color:#eceff4>.</span><span>podControl</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>DeletePod</span><span style=color:#eceff4>(</span><span>rs</span><span style=color:#eceff4>.</span><span>Namespace</span><span style=color:#eceff4>,</span><span> targetPod</span><span style=color:#eceff4>.</span><span>Name</span><span style=color:#eceff4>,</span><span> rs</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span><span> err</span><span style=color:#81a1c1> != nil</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>					// ...</span></span>
<span class=giallo-l><span>					errCh</span><span style=color:#81a1c1> &lt;-</span><span> err</span></span>
<span class=giallo-l><span style=color:#eceff4>				}</span></span>
<span class=giallo-l><span style=color:#eceff4>			}(</span><span>pod</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>		}</span></span>
<span class=giallo-l><span>		wg</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>Wait</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>		select</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>		case</span><span> err</span><span style=color:#81a1c1> := &lt;-</span><span>errCh</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#616e88>			// all errors have been reported before and they're likely to be the same, so we'll only return the first one we hit.</span></span>
<span class=giallo-l><span style=color:#81a1c1>			if</span><span> err</span><span style=color:#81a1c1> != nil</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>				return</span><span> err</span></span>
<span class=giallo-l><span style=color:#eceff4>			}</span></span>
<span class=giallo-l><span style=color:#81a1c1>		default</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#eceff4>		}</span></span>
<span class=giallo-l><span style=color:#eceff4>	}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>	return nil</span></span>
<span class=giallo-l><span>}</span></span></code></pre><p><a href=https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/controller/replicaset/replica_set.go#L459 rel=external>https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/controller/replicaset/replica_set.go#L459</a><p>ã“ã“ã§å†ã³ã€<code>ReplicaSetController.manageReplicas()</code>ã«æˆ»ã£ã¦ãã¾ã—ãŸã€‚ä»Šåº¦ã¯ã€specã‚ˆã‚Šã‚‚å®Ÿéš›ã®<code>Pod</code>ãŒå¤šã„ã®ã§ã€å‰Šé™¤å‡¦ç†ãŒèµ°ã‚‹ã‚ˆã†ã§ã™ã€‚å‰Šé™¤å‡¦ç†ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«å‰Šé™¤ã™ã‚‹æ•°ã ã‘goroutineã‚’èµ·å‹•ã™ã‚‹ã‚ˆã†ã§ã™ã€‚<h3 id=reconcile><a aria-label="Anchor link for: reconcile" class=zola-anchor href=#reconcile>Reconcile</a></h3><a href="https://speakerd.s3.amazonaws.com/presentations/173fdf8b50f445ba895b82fb6650825c/preview_slide_29.jpg?13730939:image=https://speakerd.s3.amazonaws.com/presentations/173fdf8b50f445ba895b82fb6650825c/preview_slide_29.jpg?13730939"> <figure><div class=fig-images-row><img , alt src=images/controller_9.jpeg></div></figure> </a><p>ã“ã“ã¾ã§ã€éå¸¸ã«ç°¡å˜ã«ã§ã™ãŒslideã«ãã£ã¦ã€<code>ReplicaSetController</code>ã‚’ä¸­å¿ƒã«è©²å½“ã‚³ãƒ¼ãƒ‰ã‚’è¿½ã„ã‹ã‘ã¦ã¿ã¾ã—ãŸã€‚ kubernetesã®codeã‚’åˆã‚ã¦èª­ã‚“ã ã®ã§ã™ãŒã€å„componentã®å®Ÿè£…ãŒã ã„ãŸã„ã©ã®ã‚ãŸã‚Šã‚ã‚‹ã®ã‹ã‚’çŸ¥ã‚‹ãŸã‚ã®ã¨ã£ã‹ã‹ã‚Šã¨ã—ã¦éå¸¸ã«å‚è€ƒã«ãªã‚Šã¾ã—ãŸã€‚slideã®å¾ŒåŠã§ã¯ã€<code>Informer</code>ã‚„<code>WorkQueue</code>ã«ã¤ã„ã¦ã‚‚è§£èª¬ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€æ˜¯éãã¡ã‚‰ã‚‚è¿½ã„ã‹ã‘ã¦ã¿ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚</div></article></main><footer class=blog-footer><p>Â© 2026 <a href=https://blog.ymgyt.io> ymgyt </a> | Made with <a href=https://www.getzola.org rel=noopener target=_blank>Zola</a> | <a href=https://github.com/ymgyt/blog>Repository</a> | <a href=https://blog.ymgyt.io/atom.xml target=_blank title=rss> <svg viewbox="0 0 24 24" class=icon fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx=5 cy=19 r=1></circle></svg> </a></footer></div></div>