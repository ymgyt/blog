<!doctype html><html lang=ja><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1" name=viewport><link href=https://blog.ymgyt.io/favicon.ico rel=icon sizes=any><link href=https://blog.ymgyt.io/icon.svg rel=icon type=image/svg+xml><link href=https://blog.ymgyt.io/apple-touch-icon.png rel=apple-touch-icon><link href=https://blog.ymgyt.io/manifest.webmanifest rel=manifest><link href=https://blog.ymgyt.io/style.css rel=stylesheet><link href=https://blog.ymgyt.io/atom.xml rel=alternate title=Atom type=application/atom+xml><script src="https://www.googletagmanager.com/gtag/js?id=G-GTB0KMLN90" async></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[];gtag(`js`,new Date());gtag(`config`,`G-GTB0KMLN90`)</script><title>🗼 Kubernetes Meetup Tokyo #23にいってきました | Happy developing</title><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><body><div class=world><div class=content-container><header class=blog-header-container><div class=blog-logo><a href=https://blog.ymgyt.io>Happy developing</a></div><div class=blog-nav><nav><ul><li><a href=https://blog.ymgyt.io/entry/>Entries</a><li><a href=https://blog.ymgyt.io/tags/>Tags</a><li><a href=https://blog.ymgyt.io/about/>About</a><li><a href=https://github.com/ymgyt> <img alt=Github class=icon src=https://blog.ymgyt.io/images/icon/github.svg> </a><li><a href="https://twitter.com/YAmaguchixt "> <img alt=Twitter class=icon src=https://blog.ymgyt.io/images/icon/twitter.svg> </a></ul></nav></div></header><main class=blog-main><article><header class=entry-header><h1 class=entry-title>🗼 Kubernetes Meetup Tokyo #23にいってきました</h1><div class=entry-meta><p class=entry-meta-item>🗓 2019-09-27<p class=entry-meta-item>🏷 <span class=tag><a href=https://blog.ymgyt.io/tags/cncf/>cncf</a></span> <span class=tag><a href=https://blog.ymgyt.io/tags/event/>event</a></span></div></header><aside class=entry-toc><nav><ul class=entry-toc-toplevel-list><li><a href=https://blog.ymgyt.io/entry/kubernetes-meetup-tokyo-23/#hui-chang>会場</a><li><a href=https://blog.ymgyt.io/entry/kubernetes-meetup-tokyo-23/#session>Session</a> <ul><li><a href=https://blog.ymgyt.io/entry/kubernetes-meetup-tokyo-23/#zerokarashi-merukubernetes-controller>ゼロから始めるKubernetes Controller</a><li><a href=https://blog.ymgyt.io/entry/kubernetes-meetup-tokyo-23/#kubebuilder-controller-runtimeru-men-with-v2-updates>kubebuilder/controller-runtime入門 with v2 updates</a></ul><li><a href=https://blog.ymgyt.io/entry/kubernetes-meetup-tokyo-23/#kubernetes-1-16-sig-api-machinerynobian-geng-nei-rong>Kubernetes 1.16: SIG-API Machineryの変更内容</a><li><a href=https://blog.ymgyt.io/entry/kubernetes-meetup-tokyo-23/#kubernetes-1-16-sig-cli-nobian-geng-nei-rong>Kubernetes 1.16: SIG-CLI の変更内容</a><li><a href=https://blog.ymgyt.io/entry/kubernetes-meetup-tokyo-23/#lt>LT</a> <ul><li><a href=https://blog.ymgyt.io/entry/kubernetes-meetup-tokyo-23/#clusterapi-v1alpha1-v1alpha2>ClusterAPI v1alpha1 → v1alpha2</a><li><a href=https://blog.ymgyt.io/entry/kubernetes-meetup-tokyo-23/#zi-dong-hua-hashell-operator-totomoni>自動化はshell-operator とともに。</a><li><a href=https://blog.ymgyt.io/entry/kubernetes-meetup-tokyo-23/#zi-zuo-controller-niyoru-secret-nopei-bu-toshou-ji-unblee>自作 Controller による Secret の配布と収集 - unblee</a></ul><li><a href=https://blog.ymgyt.io/entry/kubernetes-meetup-tokyo-23/#ken-tan-hui>懇談会</a><li><a href=https://blog.ymgyt.io/entry/kubernetes-meetup-tokyo-23/#ci-hui>次回</a><li><a href=https://blog.ymgyt.io/entry/kubernetes-meetup-tokyo-23/#matome>まとめ</a><li><a href=https://blog.ymgyt.io/entry/kubernetes-meetup-tokyo-23/#setukakunanodezerokarashi-merukubernetes-controllerwootutemiru>せっかくなのでゼロから始めるKubernetes Controllerをおってみる</a> <ul><li><a href=https://blog.ymgyt.io/entry/kubernetes-meetup-tokyo-23/#kubectl-apply>kubectl apply</a><li><a href=https://blog.ymgyt.io/entry/kubernetes-meetup-tokyo-23/#replicaset-controllernoqi-dong>ReplicaSet Controllerの起動</a><li><a href=https://blog.ymgyt.io/entry/kubernetes-meetup-tokyo-23/#replicasetcontroller-managereplicas>ReplicaSetController.manageReplicas()</a><li><a href=https://blog.ymgyt.io/entry/kubernetes-meetup-tokyo-23/#schedulergaenqueue>Schedulerがenqueue</a><li><a href=https://blog.ymgyt.io/entry/kubernetes-meetup-tokyo-23/#kubelethaskip>kubeletはskip</a><li><a href=https://blog.ymgyt.io/entry/kubernetes-meetup-tokyo-23/#schedulerganode-namewoshe-ding>Schedulerがnode nameを設定</a><li><a href=https://blog.ymgyt.io/entry/kubernetes-meetup-tokyo-23/#kubeletgakontenawoqi-dong>kubeletがコンテナを起動</a><li><a href=https://blog.ymgyt.io/entry/kubernetes-meetup-tokyo-23/#kubeletgapodnostatuswogeng-xin>kubeletがPodのstatusを更新</a><li><a href=https://blog.ymgyt.io/entry/kubernetes-meetup-tokyo-23/#podnoterminating>PodのTerminating</a><li><a href=https://blog.ymgyt.io/entry/kubernetes-meetup-tokyo-23/#replicasetcontrollergapodwoxue-chu>ReplicaSetControllerがPodを削除</a><li><a href=https://blog.ymgyt.io/entry/kubernetes-meetup-tokyo-23/#reconcile>Reconcile</a></ul></ul></nav></aside><div class=entry-content><p>2019年9月27日に開催された<a href=https://k8sjp.connpass.com/event/145942/>Kubernetes Meetup Tokyo #23</a>にブログ枠で参加させていただいたので、その模様について書いていきます。<h2 id=hui-chang><a aria-label="Anchor link for: hui-chang" class=zola-anchor href=#hui-chang>会場</a></h2><p>会場は渋谷ストリームの隣に誕生した渋谷スクランブルスクエアです。ビルの正式オープンが11月からとのことで絶賛内装工事中でした。 渋谷駅直結でとても便利な立地です。スポンサーは<strong>CyberAgent</strong>社です。<figure><div class=fig-images-row><img , alt src=images/site_1.jpeg width=32%,><img , alt src=images/site_2.jpeg width=32%,><img , alt src=images/site_3.jpeg width=32%,></div><figcaption>Session後の懇談会の様子</figcaption></figure><h2 id=session><a aria-label="Anchor link for: session" class=zola-anchor href=#session>Session</a></h2><h3 id=zerokarashi-merukubernetes-controller><a aria-label="Anchor link for: zerokarashi-merukubernetes-controller" class=zola-anchor href=#zerokarashi-merukubernetes-controller>ゼロから始めるKubernetes Controller</a></h3><p><a href=https://techbookfest.org/event/tbf07>技術書典7</a>で買わせていただいた、<a href=https://go-vargo.booth.pm/items/1566979>実践入門Kubernetes カスタムコントローラへの道</a>の著者であられる<a href=https://twitter.com/go_vargo>バルゴさん</a>によるKubernetes Controllerについての発表。<figure><div class=fig-images-row><img , alt src=images/load_to_custom_controller.jpeg></div></figure><iframe style="aspect-ratio:560/420;background:#0000001a padding-box padding-box;border:0;border-radius:6px;width:100%;height:auto;margin:0;padding:0;box-shadow:0 5px 40px #0003" title="ゼロから始めるKubernetes Controller / Under the Kubernetes  Controller" allowfullscreen class=speakerdeck-iframe data-ratio=1.3333333333333333 frameborder=0 mozallowfullscreen=true src=https://speakerdeck.com/player/173fdf8b50f445ba895b82fb6650825c webkitallowfullscreen=true></iframe><p>Controllerの概要から内部の実装についてまで説明されている100P超えの力作スライドです。 ReplicaSetをapplyしてからデリバリされるまでの処理を該当ソースへの参照箇所まで添えて説明してくれており開始10分でこれてよかったと思えました。<h3 id=kubebuilder-controller-runtimeru-men-with-v2-updates><a aria-label="Anchor link for: kubebuilder-controller-runtimeru-men-with-v2-updates" class=zola-anchor href=#kubebuilder-controller-runtimeru-men-with-v2-updates>kubebuilder/controller-runtime入門 with v2 updates</a></h3><p><a href=https://github.com/kfyharukz>kfyharukzさん</a>によるkubebuilder v2の紹介/デモ。<p>kubernetesのAPIを拡張するためのSDK <a href=https://github.com/kubernetes-sigs/kubebuilder>kubebuilder</a>についての発表です。</p><iframe style="border:1px solid #ccc;max-width:100%;margin-bottom:5px" allowfullscreen frameborder=0 height=485 marginheight=0 marginwidth=0 scrolling=no src=//www.slideshare.net/slideshow/embed_code/key/fl9arNMEK2OZya width=595></iframe><div style=margin-bottom:5px><strong> <a title="Kubernetes Meetup Tokyo #23 kubebuilder-v2" href=//www.slideshare.net/KazuhitoMatsuda1/kubernetes-meetup-tokyo-23-kubebuilderv2 target=_blank>Kubernetes Meetup Tokyo #23 kubebuilder-v2</a> </strong> from <strong><a href=//www.slideshare.net/KazuhitoMatsuda1 target=_blank>Kazuhito Matsuda</a></strong></div><p>Kubernetesのbuiltin Resouceの理解もまだあやしい自分にとっては発展的な内容でした。CKA合格できたらCustom Resourceにも挑戦したいです。<h2 id=kubernetes-1-16-sig-api-machinerynobian-geng-nei-rong><a aria-label="Anchor link for: kubernetes-1-16-sig-api-machinerynobian-geng-nei-rong" class=zola-anchor href=#kubernetes-1-16-sig-api-machinerynobian-geng-nei-rong>Kubernetes 1.16: SIG-API Machineryの変更内容</a></h2><p>Introduction of Operator Frameworkが行われる予定でしたが、発表者の方が体調不良とのことで内容が変更になりました。<p><a href=https://twitter.com/Ladicle>Ladicleさん</a>による<a href=https://qiita.com/Ladicle/items/f192d266b80e873eb0a8>Kubernetes 1.16: SIG-API Machineryの変更内容</a> そもそもSIGという単語がわかっていませんでした。調べてみたところKubernetes Projectの開発単位という感じでしょうか。 興味があるSIGから追いかけてみるととっかかりとしてはよいというアドバイスもいただきました。<ul><li><a href=https://github.com/kubernetes/community/blob/master/sig-list.md>sig-list</a></ul><p><a href=https://qiita.com/organizations/zlab>zlab社</a>がQiitaでKubernetesやGo関連で参考になる記事をたくさんあげてくれているのでフォローしていこうと思いました。<ul><li><a href=https://qiita.com/organizations/zlab>zlab</a></ul><h2 id=kubernetes-1-16-sig-cli-nobian-geng-nei-rong><a aria-label="Anchor link for: kubernetes-1-16-sig-cli-nobian-geng-nei-rong" class=zola-anchor href=#kubernetes-1-16-sig-cli-nobian-geng-nei-rong>Kubernetes 1.16: SIG-CLI の変更内容</a></h2><p>同じく<a href=https://qiita.com/organizations/zlab>zlab社</a>の<a href=https://twitter.com/superbrothers>すぱぶらさん</a>による<a href=https://qiita.com/superbrothers/items/e78a8a04347e57900fd9>Kubernetes 1.16: SIG-CLI の変更内容</a>です。<p>kubectlの実践的な解説で自分が打ったことがないコマンドやオプションばかりでした。<br> <code>kubectl debug</code> は利用できたらとても便利そうなので待ち遠しいです。<h2 id=lt><a aria-label="Anchor link for: lt" class=zola-anchor href=#lt>LT</a></h2><h3 id=clusterapi-v1alpha1-v1alpha2><a aria-label="Anchor link for: clusterapi-v1alpha1-v1alpha2" class=zola-anchor href=#clusterapi-v1alpha1-v1alpha2>ClusterAPI v1alpha1 → v1alpha2</a></h3><p><a href=https://twitter.com/r_takaishi>r_takaishiさん</a>によるClusterAPIについて。 発表資料のリンクが見つけられず。 ClusterAPIについてはまったくわかっておらず。そもそもKubernetesってCluster(特にcontroll plane)は作成されている前提だと考えていたので気になるところです。 技術書典7では買えていなかった<a href=https://techiemedia.booth.pm/items/1579677>はじめるCluster API</a>読んで出直します。<figure><div class=fig-images-row><img , alt src=images/cluster_api_book.jpeg></div></figure><h3 id=zi-dong-hua-hashell-operator-totomoni><a aria-label="Anchor link for: zi-dong-hua-hashell-operator-totomoni" class=zola-anchor href=#zi-dong-hua-hashell-operator-totomoni>自動化はshell-operator とともに。</a></h3><p><a href=https://twitter.com/nwiizo>nwiizoさん</a>さんによるshell(bash)とkubernetesについて。 そもそも、operatorについてのわかっていないので、なんかbashでもkubernetesの処理にはさめるんだなくらいの理解しかできませんでした。 ここは議論のあるところだと思いますが、自分は以下の点からあまりbashを本番関連の処理に組み込みたくないと考えているのですがどうなんでしょうか。<ul><li>network処理には必ずtimeout設定したい<li>error handling<li>logging(structured, leveling,...)<li>signal handling(gracefully shutdown, resource cleanup等)<li>test書きたい<li>依存を明示</ul><p>(bashでできないことはないと思うのですが上記のことやろうとすると肥大化するかscriptの手軽さが結局失われる)<h3 id=zi-zuo-controller-niyoru-secret-nopei-bu-toshou-ji-unblee><a aria-label="Anchor link for: zi-zuo-controller-niyoru-secret-nopei-bu-toshou-ji-unblee" class=zola-anchor href=#zi-zuo-controller-niyoru-secret-nopei-bu-toshou-ji-unblee>自作 Controller による Secret の配布と収集 - unblee</a></h3><p><a href=https://twitter.com/unblee>unbleeさん</a>による<a href=https://speakerdeck.com/unblee/distributing-and-collecting-secrets-with-self-made-controller>自作 Controller による Secret の配布と収集</a><p>wantedly社でのKubernetes運用上の課題をControllerを作成して解決されたお話でした。<br> 1-MicroService 1-Namespaceで運用されているそうです、実運用されている方々のNamespaceの切り方についてはもっとお話を伺ってみたいと思いました。<h2 id=ken-tan-hui><a aria-label="Anchor link for: ken-tan-hui" class=zola-anchor href=#ken-tan-hui>懇談会</a></h2><p>SessionとLTの間に30分程度の懇談会の時間が設けられています。(飲食物の提供は<strong>CyberAgent</strong>社) たまたま技術書典7で買って、当日も読んでいたカスタムコントローラへの道の著者の<a href=https://twitter.com/go_vargo>バルゴさん</a>が発表されていたので、本買いましたとご挨拶させていただきました。またCKA、CKADをお持ちとのことで、<a href=https://qiita.com/go_vargo/items/3644c3a44734e2c155f4>CKAのアドバイス</a>も聞けました。<p><a href=https://twitter.com/Ladicle>Ladicleさん</a>の発表の際に用いられていたQiitaのiconどこかでみたことあるなー思っていたのですが、<a href=https://gihyo.jp/dp/ebook/2017/978-4-7741-8845-4>Software Design 2017年9月号</a>の特集 Web技術【超】入門いま一度振り返るWebのしくみと開発方法で<a href=https://github.com/Ladicle/http-handson>web serverの実装</a>をgoでやられている方であることを思い出しました。<br> <code>go-bindata</code>で静的アセットファイルをgoのバイナリーに組み込むやり方をここではじめて知りました。<h2 id=ci-hui><a aria-label="Anchor link for: ci-hui" class=zola-anchor href=#ci-hui>次回</a></h2><p>次回は10月24日で、Kubernetes上で動かすアプリケーション開発のデバックとテストについてだそうです。 こちらも楽しみですね。<h2 id=matome><a aria-label="Anchor link for: matome" class=zola-anchor href=#matome>まとめ</a></h2><p>Kubernetes Meetup Tokyoには初参加で、自分のKubernetesについての理解が、GKEにslack botをdeployしてみる程度(<a href=http://blog.howtelevision.co.jp/entry/2019/04/30/193747>会社のブログで記事</a>にしました。) でしたがとても勉強になり参加してよかったです。<h2 id=setukakunanodezerokarashi-merukubernetes-controllerwootutemiru><a aria-label="Anchor link for: setukakunanodezerokarashi-merukubernetes-controllerwootutemiru" class=zola-anchor href=#setukakunanodezerokarashi-merukubernetes-controllerwootutemiru>せっかくなのでゼロから始めるKubernetes Controllerをおってみる</a></h2><p><a href=https://speakerdeck.com/govargo/under-the-kubernetes-controller-36f9b71b-9781-4846-9625-23c31da93014>ゼロから始めるKubernetes Controller</a>で、ReplicaSetをapplyした際のControllerの挙動が該当コードのリンクつきで解説されているので、追えるところまでおってみました。<a href=https://github.com/kubernetes/kubernetes/tree/release-1.16>kubernetesのversionは1.16です</a><h3 id=kubectl-apply><a aria-label="Anchor link for: kubectl-apply" class=zola-anchor href=#kubectl-apply><code>kubectl apply</code></a></h3><a href="https://speakerdeck.com/govargo/under-the-kubernetes-controller-36f9b71b-9781-4846-9625-23c31da93014?slide=19"> <figure><div class=fig-images-row><img , alt src=images/controller_1.jpeg></div></figure> </a><p><code>kubectl</code>でReplicaSetをapplyして、api-serverで処理されている前提です。<h3 id=replicaset-controllernoqi-dong><a aria-label="Anchor link for: replicaset-controllernoqi-dong" class=zola-anchor href=#replicaset-controllernoqi-dong><code>ReplicaSet Controller</code>の起動</a></h3><p>slideでは、<code>ReplicaSetController</code>が<code>ReplicaSet</code>が生成されたことを検知したところから解説されていますが、起動処理を簡単におってみました。<p><code>ReplicaSetController</code>自体は、<code>kube-controller-manager</code> binaryに含まれているので、起動処理は<code>kube-controller-manager</code>コマンドから始まります。<pre class="language-go z-code" data-lang=go><code class=language-go data-lang=go><span class="z-source z-go"><span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> Run runs the KubeControllerManagerOptions.  This should never exit.
</span></span><span class="z-source z-go"><span class="z-storage z-type z-keyword z-function z-go">func</span> <span class="z-entity z-name z-function z-go">Run</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-parameter z-go">c</span> <span class="z-keyword z-operator z-go">*</span><span class="z-variable z-other z-go">config</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-storage z-type z-go">CompletedConfig</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-parameter z-go">stopCh</span> <span class="z-keyword z-operator z-go">&LT-</span><span class="z-storage z-type z-keyword z-chan z-go">chan</span> <span class="z-storage z-type z-keyword z-struct z-go">struct</span><span class="z-meta z-type z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span><span class="z-punctuation z-section z-braces z-end z-go">}</span></span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">error</span></span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">  <span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> ...
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go">  <span class="z-keyword z-control z-go">if</span> <span class="z-variable z-declaration z-go">err</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-function z-go">StartControllers</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">controllerContext</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">saTokenControllerInitFunc</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-function z-go">NewControllerInitializers</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">controllerContext</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">LoopMode</span><span class="z-punctuation z-section z-parens z-end z-go">)</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">unsecuredMux</span><span class="z-punctuation z-section z-parens z-end z-go">)</span><span class="z-punctuation z-terminator z-go">;</span> <span class="z-variable z-other z-go">err</span> <span class="z-keyword z-operator z-go">!=</span> <span class="z-constant z-language z-go">nil</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-variable z-other z-go">klog</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Fatalf</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">"</span>error starting controllers: <span class="z-constant z-other z-placeholder z-go">%v</span><span class="z-punctuation z-definition z-string z-end z-go">"</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">err</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">	<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">  <span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> ...
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></code></pre><p><a href=https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/cmd/kube-controller-manager/app/controllermanager.go#L234>https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/cmd/kube-controller-manager/app/controllermanager.go#L234</a><pre class="language-go z-code" data-lang=go><code class=language-go data-lang=go><span class="z-source z-go"><span class="z-storage z-type z-keyword z-function z-go">func</span> <span class="z-entity z-name z-function z-go">NewControllerInitializers</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-parameter z-go">loopMode</span> <span class="z-storage z-type z-go">ControllerLoopMode</span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-storage z-type z-keyword z-map z-go">map</span><span class="z-punctuation z-section z-brackets z-begin z-go">[</span><span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">string</span></span><span class="z-punctuation z-section z-brackets z-end z-go">]</span><span class="z-storage z-type z-go">InitFunc</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">  <span class="z-variable z-declaration z-go">controllers</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-storage z-type z-keyword z-map z-go">map</span><span class="z-punctuation z-section z-brackets z-begin z-go">[</span><span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">string</span></span><span class="z-punctuation z-section z-brackets z-end z-go">]</span><span class="z-storage z-type z-go">InitFunc</span><span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span><span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">  <span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> ...
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go">  <span class="z-variable z-other z-go">controllers</span><span class="z-punctuation z-section z-brackets z-begin z-go">[</span><span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">"</span>replicaset<span class="z-punctuation z-definition z-string z-end z-go">"</span></span><span class="z-punctuation z-section z-brackets z-end z-go">]</span> <span class="z-keyword z-operator z-assignment z-go">=</span> <span class="z-variable z-other z-go">startReplicaSetController</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">  <span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> ...
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go">  <span class="z-keyword z-control z-go">return</span> <span class="z-variable z-other z-go">controllers</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></code></pre><p><a href=https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/cmd/kube-controller-manager/app/controllermanager.go#L386>https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/cmd/kube-controller-manager/app/controllermanager.go#L386</a><pre class="language-go z-code" data-lang=go><code class=language-go data-lang=go><span class="z-source z-go"><span class="z-storage z-type z-keyword z-function z-go">func</span> <span class="z-entity z-name z-function z-go">StartControllers</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-parameter z-go">ctx</span> <span class="z-storage z-type z-go">ControllerContext</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-parameter z-go">startSATokenController</span> <span class="z-storage z-type z-go">InitFunc</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-parameter z-go">controllers</span> <span class="z-storage z-type z-keyword z-map z-go">map</span><span class="z-punctuation z-section z-brackets z-begin z-go">[</span><span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">string</span></span><span class="z-punctuation z-section z-brackets z-end z-go">]</span><span class="z-storage z-type z-go">InitFunc</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-parameter z-go">unsecuredMux</span> <span class="z-keyword z-operator z-go">*</span><span class="z-variable z-other z-go">mux</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-storage z-type z-go">PathRecorderMux</span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">error</span></span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">   <span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> ...
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go">  <span class="z-keyword z-control z-go">for</span> <span class="z-variable z-declaration z-go">controllerName</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-declaration z-go">initFn</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-keyword z-other z-go">range</span> <span class="z-variable z-other z-go">controllers</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> ...
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-declaration z-go">debugHandler</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-declaration z-go">started</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-declaration z-go">err</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-function z-go">initFn</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">ctx</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> ...
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">  <span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">  <span class="z-keyword z-control z-go">return</span> <span class="z-constant z-language z-go">nil</span>
</span></span></code></pre><p><a href=https://github.com/kubernetes/kubernetes/blob/release-1.16//cmd/kube-controller-manager/app/controllermanager.go#L498>https://github.com/kubernetes/kubernetes/blob/release-1.16//cmd/kube-controller-manager/app/controllermanager.go#L498:6:title</a><p>各controllerの起動処理を実行しているようです。 肝心の<code>ReplicaSetController</code>の起動処理をみてみます。<pre class="language-go z-code" data-lang=go><code class=language-go data-lang=go><span class="z-source z-go"><span class="z-storage z-type z-keyword z-function z-go">func</span> <span class="z-entity z-name z-function z-go">startReplicaSetController</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-parameter z-go">ctx</span> <span class="z-storage z-type z-go">ControllerContext</span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">http</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-storage z-type z-go">Handler</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">bool</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">error</span></span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> ...
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-keyword z-control z-go">go</span> <span class="z-variable z-other z-go">replicaset</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">NewReplicaSetController</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-other z-go">ctx</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">InformerFactory</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Apps</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-parens z-end z-go">)</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">V1</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-parens z-end z-go">)</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">ReplicaSets</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-parens z-end z-go">)</span><span class="z-punctuation z-separator z-go">,</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-other z-go">ctx</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">InformerFactory</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Core</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-parens z-end z-go">)</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">V1</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-parens z-end z-go">)</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Pods</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-parens z-end z-go">)</span><span class="z-punctuation z-separator z-go">,</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-other z-go">ctx</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">ClientBuilder</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">ClientOrDie</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">"</span>replicaset-controller<span class="z-punctuation z-definition z-string z-end z-go">"</span></span><span class="z-punctuation z-section z-parens z-end z-go">)</span><span class="z-punctuation z-separator z-go">,</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-other z-go">replicaset</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">BurstReplicas</span><span class="z-punctuation z-separator z-go">,</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-punctuation z-section z-parens z-end z-go">)</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Run</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-function z-go"><span class="z-support z-type z-builtin z-go">int</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">ctx</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">ComponentConfig</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">ReplicaSetController</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">ConcurrentRSSyncs</span><span class="z-punctuation z-section z-parens z-end z-go">)</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">ctx</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">Stop</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-keyword z-control z-go">return</span> <span class="z-constant z-language z-go">nil</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-constant z-language z-go">true</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-constant z-language z-go">nil</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></code></pre><p><a href=https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/cmd/kube-controller-manager/app/apps.go#L69>https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/cmd/kube-controller-manager/app/apps.go#L69</a><p><code>ReplicaSetController</code>の生成と起動処理を別goroutineで実行しているようです。<pre class="language-go z-code" data-lang=go><code class=language-go data-lang=go><span class="z-source z-go"><span class="z-storage z-type z-keyword z-function z-go">func</span> <span class="z-meta z-function z-declaration z-go"><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-parameter z-go">rsc</span> <span class="z-keyword z-operator z-go">*</span><span class="z-storage z-type z-go">ReplicaSetController</span><span class="z-punctuation z-section z-parens z-end z-go">)</span></span><span class="z-meta z-function z-declaration z-go"> <span class="z-entity z-name z-function z-go">Run</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-parameter z-go">workers</span> <span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">int</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-parameter z-go">stopCh</span> <span class="z-keyword z-operator z-go">&LT-</span><span class="z-storage z-type z-keyword z-chan z-go">chan</span> <span class="z-storage z-type z-keyword z-struct z-go">struct</span><span class="z-meta z-type z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span><span class="z-punctuation z-section z-braces z-end z-go">}</span></span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> ...
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-keyword z-control z-go">for</span> <span class="z-variable z-declaration z-go">i</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-constant z-numeric z-integer z-decimal z-go">0</span><span class="z-punctuation z-terminator z-go">;</span> <span class="z-variable z-other z-go">i</span> <span class="z-keyword z-operator z-go"><</span> <span class="z-variable z-other z-go">workers</span><span class="z-punctuation z-terminator z-go">;</span> <span class="z-variable z-other z-go">i</span><span class="z-keyword z-operator z-go">++</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-keyword z-control z-go">go</span> <span class="z-variable z-other z-go">wait</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Until</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">rsc</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">worker</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">time</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">Second</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">stopCh</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">	<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-keyword z-operator z-go">&LT-</span><span class="z-variable z-other z-go">stopCh</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></code></pre><p><a href=https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/controller/replicaset/replica_set.go#L177>https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/controller/replicaset/replica_set.go#L177:34</a><p>指定された数のworkerを起動して、<code>stopCh</code>でblockしています。<pre class="language-go z-code" data-lang=go><code class=language-go data-lang=go><span class="z-source z-go"><span class="z-storage z-type z-keyword z-function z-go">func</span> <span class="z-meta z-function z-declaration z-go"><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-parameter z-go">rsc</span> <span class="z-keyword z-operator z-go">*</span><span class="z-storage z-type z-go">ReplicaSetController</span><span class="z-punctuation z-section z-parens z-end z-go">)</span></span><span class="z-meta z-function z-declaration z-go"> <span class="z-entity z-name z-function z-go">worker</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-keyword z-control z-go">for</span> <span class="z-variable z-other z-go">rsc</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">processNextWorkItem</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">	<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span><span class="z-source z-go">
</span><span class="z-source z-go"><span class="z-storage z-type z-keyword z-function z-go">func</span> <span class="z-meta z-function z-declaration z-go"><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-parameter z-go">rsc</span> <span class="z-keyword z-operator z-go">*</span><span class="z-storage z-type z-go">ReplicaSetController</span><span class="z-punctuation z-section z-parens z-end z-go">)</span></span><span class="z-meta z-function z-declaration z-go"> <span class="z-entity z-name z-function z-go">processNextWorkItem</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">bool</span></span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-declaration z-go">key</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-declaration z-go">quit</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">rsc</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">queue</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Get</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-keyword z-control z-go">if</span> <span class="z-variable z-other z-go">quit</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-keyword z-control z-go">return</span> <span class="z-constant z-language z-go">false</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">	<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-keyword z-control z-go">defer</span> <span class="z-variable z-other z-go">rsc</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">queue</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Done</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">key</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-declaration z-go">err</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">rsc</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">syncHandler</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">key</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">string</span></span><span class="z-punctuation z-section z-parens z-end z-go">)</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-keyword z-control z-go">if</span> <span class="z-variable z-other z-go">err</span> <span class="z-keyword z-operator z-go">==</span> <span class="z-constant z-language z-go">nil</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-other z-go">rsc</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">queue</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Forget</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">key</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-keyword z-control z-go">return</span> <span class="z-constant z-language z-go">true</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">	<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-other z-go">utilruntime</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">HandleError</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">fmt</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Errorf</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">"</span>Sync <span class="z-constant z-other z-placeholder z-go">%q</span> failed with <span class="z-constant z-other z-placeholder z-go">%v</span><span class="z-punctuation z-definition z-string z-end z-go">"</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">key</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">err</span><span class="z-punctuation z-section z-parens z-end z-go">)</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-other z-go">rsc</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">queue</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">AddRateLimited</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">key</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-keyword z-control z-go">return</span> <span class="z-constant z-language z-go">true</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></code></pre><p><a href=https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/controller/replicaset/replica_set.go#L432>https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/controller/replicaset/replica_set.go#L432:34</a><p>肝心のworkerはqueueからtaskを取得して、<code>ReplicaSetController.syncHandler()</code>処理を呼び出しています。 このqueueまわりもslideの後半で解説されていましたが、概要としてはapi-serverからcontrollerが関心のあるEventに絞って取得していると理解しています。<pre class="language-go z-code" data-lang=go><code class=language-go data-lang=go><span class="z-source z-go"><span class="z-storage z-type z-keyword z-function z-go">func</span> <span class="z-entity z-name z-function z-go">NewBaseController</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-parameter z-go">rsInformer</span> <span class="z-variable z-other z-go">appsinformers</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-storage z-type z-go">ReplicaSetInformer</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-parameter z-go">podInformer</span> <span class="z-variable z-other z-go">coreinformers</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-storage z-type z-go">PodInformer</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-parameter z-go">kubeClient</span> <span class="z-variable z-other z-go">clientset</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-storage z-type z-go">Interface</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-parameter z-go">burstReplicas</span> <span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">int</span></span><span class="z-punctuation z-separator z-go">,</span>
</span><span class="z-source z-go">	<span class="z-variable z-parameter z-go">gvk</span> <span class="z-variable z-other z-go">schema</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-storage z-type z-go">GroupVersionKind</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-parameter z-go">metricOwnerName</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-parameter z-go">queueName</span> <span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">string</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-parameter z-go">podControl</span> <span class="z-variable z-other z-go">controller</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-storage z-type z-go">PodControlInterface</span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-keyword z-operator z-go">*</span><span class="z-storage z-type z-go">ReplicaSetController</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">    <span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span>...
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go">    <span class="z-variable z-other z-go">rsc</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">syncHandler</span> <span class="z-keyword z-operator z-assignment z-go">=</span> <span class="z-variable z-other z-go">rsc</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">syncReplicaSet</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-keyword z-control z-go">return</span> <span class="z-variable z-other z-go">rsc</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></code></pre><p><a href=https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/controller/replicaset/replica_set.go#L163>https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/controller/replicaset/replica_set.go#L163</a><p><code>ReplicaSetController.syncHandler</code>には<code>syncReplicaSet</code>が生成処理時にセットされています。<pre class="language-go z-code" data-lang=go><code class=language-go data-lang=go><span class="z-source z-go"><span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> syncReplicaSet will sync the ReplicaSet with the given key if it has had its expectations fulfilled,
</span></span><span class="z-source z-go"><span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> meaning it did not expect to see any more of its pods created or deleted. This function is not meant to be
</span></span><span class="z-source z-go"><span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> invoked concurrently with the same key.
</span></span><span class="z-source z-go"><span class="z-storage z-type z-keyword z-function z-go">func</span> <span class="z-meta z-function z-declaration z-go"><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-parameter z-go">rsc</span> <span class="z-keyword z-operator z-go">*</span><span class="z-storage z-type z-go">ReplicaSetController</span><span class="z-punctuation z-section z-parens z-end z-go">)</span></span><span class="z-meta z-function z-declaration z-go"> <span class="z-entity z-name z-function z-go">syncReplicaSet</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-parameter z-go">key</span> <span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">string</span></span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">error</span></span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> ...
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-declaration z-go">namespace</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-declaration z-go">name</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-declaration z-go">err</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">cache</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">SplitMetaNamespaceKey</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">key</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> ...
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-declaration z-go">rs</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-declaration z-go">err</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">rsc</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">rsLister</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">ReplicaSets</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">namespace</span><span class="z-punctuation z-section z-parens z-end z-go">)</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Get</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">name</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> ...
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-declaration z-go">selector</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-declaration z-go">err</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">metav1</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">LabelSelectorAsSelector</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">rs</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">Spec</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">Selector</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> ...
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-declaration z-go">allPods</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-declaration z-go">err</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">rsc</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">podLister</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Pods</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">rs</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">Namespace</span><span class="z-punctuation z-section z-parens z-end z-go">)</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">List</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">labels</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Everything</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-parens z-end z-go">)</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> ...
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go">
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> Ignore inactive pods.
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-declaration z-go">filteredPods</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">controller</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">FilterActivePods</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">allPods</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> NOTE: filteredPods are pointing to objects from cache - if you need to
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> modify them, you need to copy it first.
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-other z-go">filteredPods</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">err</span> <span class="z-keyword z-operator z-assignment z-go">=</span> <span class="z-variable z-other z-go">rsc</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">claimPods</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">rs</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">selector</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">filteredPods</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> ...
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go">
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-storage z-type z-keyword z-var z-go">var</span> <span class="z-variable z-declaration z-go">manageReplicasErr</span> <span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">error</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-keyword z-control z-go">if</span> <span class="z-variable z-other z-go">rsNeedsSync</span> <span class="z-keyword z-operator z-go">&&</span> <span class="z-variable z-other z-go">rs</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">DeletionTimestamp</span> <span class="z-keyword z-operator z-go">==</span> <span class="z-constant z-language z-go">nil</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-other z-go">manageReplicasErr</span> <span class="z-keyword z-operator z-assignment z-go">=</span> <span class="z-variable z-other z-go">rsc</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">manageReplicas</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">filteredPods</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">rs</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">	<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">    <span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> ...
</span></span></span></code></pre><p>概要としては、処理対象の<code>ReplicaSet</code>とfilterlingした<code>Pod</code>を取得して、<code>ReplicaSetController.manageReplicas()</code>を呼んでいます。 これでようやくslideの最初の処理のたどり着きました。<h3 id=replicasetcontroller-managereplicas><a aria-label="Anchor link for: replicasetcontroller-managereplicas" class=zola-anchor href=#replicasetcontroller-managereplicas><code>ReplicaSetController.manageReplicas()</code></a></h3><a href="https://speakerdeck.com/govargo/under-the-kubernetes-controller-36f9b71b-9781-4846-9625-23c31da93014?slide=20"> <figure><div class=fig-images-row><img , alt src=images/controller_2.jpeg></div></figure> </a><pre class="language-go z-code" data-lang=go><code class=language-go data-lang=go><span class="z-source z-go"><span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> manageReplicas checks and updates replicas for the given ReplicaSet.
</span></span><span class="z-source z-go"><span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> Does NOT modify &LTfilteredPods>.
</span></span><span class="z-source z-go"><span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> It will requeue the replica set in case of an error while creating/deleting pods.
</span></span><span class="z-source z-go"><span class="z-storage z-type z-keyword z-function z-go">func</span> <span class="z-meta z-function z-declaration z-go"><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-parameter z-go">rsc</span> <span class="z-keyword z-operator z-go">*</span><span class="z-storage z-type z-go">ReplicaSetController</span><span class="z-punctuation z-section z-parens z-end z-go">)</span></span><span class="z-meta z-function z-declaration z-go"> <span class="z-entity z-name z-function z-go">manageReplicas</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-parameter z-go">filteredPods</span> <span class="z-punctuation z-section z-brackets z-begin z-go">[</span><span class="z-punctuation z-section z-brackets z-end z-go">]</span><span class="z-keyword z-operator z-go">*</span><span class="z-variable z-other z-go">v1</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-storage z-type z-go">Pod</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-parameter z-go">rs</span> <span class="z-keyword z-operator z-go">*</span><span class="z-variable z-other z-go">apps</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-storage z-type z-go">ReplicaSet</span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">error</span></span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-declaration z-go">diff</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-function z-go"><span class="z-support z-function z-builtin z-go">len</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">filteredPods</span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-keyword z-operator z-go">-</span> <span class="z-variable z-function z-go"><span class="z-support z-type z-builtin z-go">int</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-keyword z-operator z-go">*</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">rs</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">Spec</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">Replicas</span><span class="z-punctuation z-section z-parens z-end z-go">)</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-declaration z-go">rsKey</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-declaration z-go">err</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">controller</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">KeyFunc</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">rs</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> ...
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-keyword z-control z-go">if</span> <span class="z-variable z-other z-go">diff</span> <span class="z-keyword z-operator z-go"><</span> <span class="z-constant z-numeric z-integer z-decimal z-go">0</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-other z-go">diff</span> <span class="z-keyword z-operator z-assignment z-go">*=</span> <span class="z-keyword z-operator z-go">-</span><span class="z-constant z-numeric z-integer z-decimal z-go">1</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> ...
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-declaration z-go">successfulCreations</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-declaration z-go">err</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-function z-go">slowStartBatch</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">diff</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">controller</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">SlowStartInitialBatchSize</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-storage z-type z-keyword z-function z-go">func</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">error</span></span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-variable z-declaration z-go">err</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">rsc</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">podControl</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">CreatePodsWithControllerRef</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">rs</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">Namespace</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-keyword z-operator z-go">&</span><span class="z-variable z-other z-go">rs</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">Spec</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">Template</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">rs</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">metav1</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">NewControllerRef</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">rs</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">rsc</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">GroupVersionKind</span><span class="z-punctuation z-section z-parens z-end z-go">)</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-keyword z-control z-go">if</span> <span class="z-variable z-other z-go">err</span> <span class="z-keyword z-operator z-go">!=</span> <span class="z-constant z-language z-go">nil</span> <span class="z-keyword z-operator z-go">&&</span> <span class="z-variable z-other z-go">errors</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">IsTimeout</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">err</span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">				<span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> ...
</span></span></span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">				<span class="z-keyword z-control z-go">return</span> <span class="z-constant z-language z-go">nil</span>
</span></span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-keyword z-control z-go">return</span> <span class="z-variable z-other z-go">err</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-punctuation z-section z-braces z-end z-go">}</span></span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> ...
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-keyword z-control z-go">return</span> <span class="z-variable z-other z-go">err</span>
</span></span></span></code></pre><p><a href=https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/controller/replicaset/replica_set.go#L459>https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/controller/replicaset/replica_set.go#L459:34</a><pre class="language-go z-code" data-lang=go><code class=language-go data-lang=go><span class="z-source z-go"><span class="z-storage z-type z-keyword z-function z-go">func</span> <span class="z-entity z-name z-function z-go">slowStartBatch</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-parameter z-go">count</span> <span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">int</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-parameter z-go">initialBatchSize</span> <span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">int</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-parameter z-go">fn</span> <span class="z-storage z-type z-keyword z-function z-go">func</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">error</span></span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">int</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">error</span></span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-declaration z-go">remaining</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">count</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-declaration z-go">successes</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-constant z-numeric z-integer z-decimal z-go">0</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-keyword z-control z-go">for</span> <span class="z-variable z-declaration z-go">batchSize</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">integer</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">IntMin</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">remaining</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">initialBatchSize</span><span class="z-punctuation z-section z-parens z-end z-go">)</span><span class="z-punctuation z-terminator z-go">;</span> <span class="z-variable z-other z-go">batchSize</span> <span class="z-keyword z-operator z-go">></span> <span class="z-constant z-numeric z-integer z-decimal z-go">0</span><span class="z-punctuation z-terminator z-go">;</span> <span class="z-variable z-other z-go">batchSize</span> <span class="z-keyword z-operator z-assignment z-go">=</span> <span class="z-variable z-other z-go">integer</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">IntMin</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-constant z-numeric z-integer z-decimal z-go">2</span><span class="z-keyword z-operator z-go">*</span><span class="z-variable z-other z-go">batchSize</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">remaining</span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-declaration z-go">errCh</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-function z-go"><span class="z-support z-function z-builtin z-go">make</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-storage z-type z-keyword z-chan z-go">chan</span> <span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">error</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">batchSize</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-storage z-type z-keyword z-var z-go">var</span> <span class="z-variable z-declaration z-go">wg</span> <span class="z-variable z-other z-go">sync</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-storage z-type z-go">WaitGroup</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-other z-go">wg</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Add</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">batchSize</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-keyword z-control z-go">for</span> <span class="z-variable z-declaration z-go">i</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-constant z-numeric z-integer z-decimal z-go">0</span><span class="z-punctuation z-terminator z-go">;</span> <span class="z-variable z-other z-go">i</span> <span class="z-keyword z-operator z-go"><</span> <span class="z-variable z-other z-go">batchSize</span><span class="z-punctuation z-terminator z-go">;</span> <span class="z-variable z-other z-go">i</span><span class="z-keyword z-operator z-go">++</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-keyword z-control z-go">go</span> <span class="z-storage z-type z-keyword z-function z-go">func</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">				<span class="z-keyword z-control z-go">defer</span> <span class="z-variable z-other z-go">wg</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Done</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">				<span class="z-keyword z-control z-go">if</span> <span class="z-variable z-declaration z-go">err</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-function z-go">fn</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-parens z-end z-go">)</span><span class="z-punctuation z-terminator z-go">;</span> <span class="z-variable z-other z-go">err</span> <span class="z-keyword z-operator z-go">!=</span> <span class="z-constant z-language z-go">nil</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">					<span class="z-variable z-other z-go">errCh</span> <span class="z-keyword z-operator z-go">&LT-</span> <span class="z-variable z-other z-go">err</span>
</span></span></span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">				<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-punctuation z-section z-braces z-end z-go">}</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-other z-go">wg</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Wait</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-declaration z-go">curSuccesses</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">batchSize</span> <span class="z-keyword z-operator z-go">-</span> <span class="z-variable z-function z-go"><span class="z-support z-function z-builtin z-go">len</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">errCh</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-other z-go">successes</span> <span class="z-keyword z-operator z-assignment z-go">+=</span> <span class="z-variable z-other z-go">curSuccesses</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-keyword z-control z-go">if</span> <span class="z-variable z-function z-go"><span class="z-support z-function z-builtin z-go">len</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">errCh</span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-keyword z-operator z-go">></span> <span class="z-constant z-numeric z-integer z-decimal z-go">0</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-keyword z-control z-go">return</span> <span class="z-variable z-other z-go">successes</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-keyword z-operator z-go">&LT-</span><span class="z-variable z-other z-go">errCh</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-other z-go">remaining</span> <span class="z-keyword z-operator z-assignment z-go">-=</span> <span class="z-variable z-other z-go">batchSize</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">	<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-keyword z-control z-go">return</span> <span class="z-variable z-other z-go">successes</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-constant z-language z-go">nil</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></code></pre><p><a href=https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/controller/replicaset/replica_set.go#L658>https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/controller/replicaset/replica_set.go#L658</a><p><code>Pod</code>と<code>ReplicaSet</code>のreplica数の差分をとって、<code>Pod</code>の作成処理を実行していますね。 <code>slowStartBatch()</code>は作成処理を並列で走らせるhelper関数のようです。 段階的に一度に起動するgoroutineの数を増やしていく処理の書き方として非常に参考になります。(<code>IntMin()</code>のような処理はstd libで欲しいと思ってしまう) <code>ReplicaSetController.podControl</code>はinterfaceで、実際の<code>Pod</code>作成処理は<code>ReadPodControl</code>が実装しています。<pre class="language-go z-code" data-lang=go><code class=language-go data-lang=go><span class="z-source z-go"><span class="z-storage z-type z-keyword z-function z-go">func</span> <span class="z-meta z-function z-declaration z-go"><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-parameter z-go">r</span> <span class="z-storage z-type z-go">RealPodControl</span><span class="z-punctuation z-section z-parens z-end z-go">)</span></span><span class="z-meta z-function z-declaration z-go"> <span class="z-entity z-name z-function z-go">CreatePodsWithControllerRef</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-parameter z-go">namespace</span> <span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">string</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-parameter z-go">template</span> <span class="z-keyword z-operator z-go">*</span><span class="z-variable z-other z-go">v1</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-storage z-type z-go">PodTemplateSpec</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-parameter z-go">controllerObject</span> <span class="z-variable z-other z-go">runtime</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-storage z-type z-go">Object</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-parameter z-go">controllerRef</span> <span class="z-keyword z-operator z-go">*</span><span class="z-variable z-other z-go">metav1</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-storage z-type z-go">OwnerReference</span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">error</span></span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-keyword z-control z-go">if</span> <span class="z-variable z-declaration z-go">err</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-function z-go">validateControllerRef</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">controllerRef</span><span class="z-punctuation z-section z-parens z-end z-go">)</span><span class="z-punctuation z-terminator z-go">;</span> <span class="z-variable z-other z-go">err</span> <span class="z-keyword z-operator z-go">!=</span> <span class="z-constant z-language z-go">nil</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-keyword z-control z-go">return</span> <span class="z-variable z-other z-go">err</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">	<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-keyword z-control z-go">return</span> <span class="z-variable z-other z-go">r</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">createPods</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">"</span><span class="z-punctuation z-definition z-string z-end z-go">"</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">namespace</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">template</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">controllerObject</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">controllerRef</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></code></pre><p><a href="https://speakerdeck.com/govargo/under-the-kubernetes-controller-36f9b71b-9781-4846-9625-23c31da93014?slide=19">https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/controller/controller_utils.go#L523</a><pre class="language-go z-code" data-lang=go><code class=language-go data-lang=go><span class="z-source z-go"><span class="z-storage z-type z-keyword z-function z-go">func</span> <span class="z-meta z-function z-declaration z-go"><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-parameter z-go">r</span> <span class="z-storage z-type z-go">RealPodControl</span><span class="z-punctuation z-section z-parens z-end z-go">)</span></span><span class="z-meta z-function z-declaration z-go"> <span class="z-entity z-name z-function z-go">createPods</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-parameter z-go">nodeName</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-parameter z-go">namespace</span> <span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">string</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-parameter z-go">template</span> <span class="z-keyword z-operator z-go">*</span><span class="z-variable z-other z-go">v1</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-storage z-type z-go">PodTemplateSpec</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-parameter z-go">object</span> <span class="z-variable z-other z-go">runtime</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-storage z-type z-go">Object</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-parameter z-go">controllerRef</span> <span class="z-keyword z-operator z-go">*</span><span class="z-variable z-other z-go">metav1</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-storage z-type z-go">OwnerReference</span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">error</span></span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-declaration z-go">pod</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-declaration z-go">err</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-function z-go">GetPodFromTemplate</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">template</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">object</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">controllerRef</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> ...
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-keyword z-control z-go">if</span> <span class="z-variable z-function z-go"><span class="z-support z-function z-builtin z-go">len</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">nodeName</span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-keyword z-operator z-go">!=</span> <span class="z-constant z-numeric z-integer z-decimal z-go">0</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-other z-go">pod</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">Spec</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">NodeName</span> <span class="z-keyword z-operator z-assignment z-go">=</span> <span class="z-variable z-other z-go">nodeName</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">	<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> ...
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-declaration z-go">newPod</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-declaration z-go">err</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">r</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">KubeClient</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">CoreV1</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-parens z-end z-go">)</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Pods</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">namespace</span><span class="z-punctuation z-section z-parens z-end z-go">)</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Create</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">pod</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-keyword z-control z-go">if</span> <span class="z-variable z-other z-go">err</span> <span class="z-keyword z-operator z-go">!=</span> <span class="z-constant z-language z-go">nil</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-other z-go">r</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">Recorder</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Eventf</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">object</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">v1</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">EventTypeWarning</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">FailedCreatePodReason</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">"</span>Error creating: <span class="z-constant z-other z-placeholder z-go">%v</span><span class="z-punctuation z-definition z-string z-end z-go">"</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">err</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-keyword z-control z-go">return</span> <span class="z-variable z-other z-go">err</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">	<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> ...
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-keyword z-control z-go">return</span> <span class="z-constant z-language z-go">nil</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></code></pre><p><a href="https://speakerdeck.com/govargo/under-the-kubernetes-controller-36f9b71b-9781-4846-9625-23c31da93014?slide=19">https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/controller/controller_utils.go#L567</a><p>確かにslideのとおり、<code>r.createPods("", namespace, template, controllerObject, controllerRef)</code> として<code>nodeName</code>が空の<code>Pod</code>を生成しているのがわかります。<h3 id=schedulergaenqueue><a aria-label="Anchor link for: schedulergaenqueue" class=zola-anchor href=#schedulergaenqueue>Schedulerがenqueue</a></h3><a href="https://speakerdeck.com/govargo/under-the-kubernetes-controller-36f9b71b-9781-4846-9625-23c31da93014?slide=21"> <figure><div class=fig-images-row><img , alt src=images/controller_3.jpeg></div></figure> </a><pre class="language-go z-code" data-lang=go><code class=language-go data-lang=go><span class="z-source z-go"><span class="z-storage z-type z-keyword z-function z-go">func</span> <span class="z-entity z-name z-function z-go">AddAllEventHandlers</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-keyword z-operator z-variadic z-go">...</span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">    <span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> ...
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-other z-go">podInformer</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Informer</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-parens z-end z-go">)</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">AddEventHandler</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-other z-go">cache</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">FilteringResourceEventHandler</span><span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-variable z-other z-go">FilterFunc</span><span class="z-punctuation z-separator z-go">:</span> <span class="z-storage z-type z-keyword z-function z-go">func</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-parameter z-go">obj</span> <span class="z-storage z-type z-keyword z-interface z-go">interface</span><span class="z-meta z-type z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span><span class="z-punctuation z-section z-braces z-end z-go">}</span></span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">bool</span></span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">				<span class="z-keyword z-control z-go">switch</span> <span class="z-variable z-declaration z-go">t</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">obj</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-storage z-type z-keyword z-type z-go">type</span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">				<span class="z-keyword z-control z-go">case</span> <span class="z-keyword z-operator z-go">*</span><span class="z-variable z-other z-go">v1</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">Pod</span><span class="z-punctuation z-separator z-go">:</span>
</span></span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">					<span class="z-keyword z-control z-go">return</span> <span class="z-keyword z-operator z-go">!</span><span class="z-variable z-function z-go">assignedPod</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">t</span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-keyword z-operator z-go">&&</span> <span class="z-variable z-function z-go">responsibleForPod</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">t</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">schedulerName</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">				<span class="z-keyword z-control z-go">case</span> <span class="z-variable z-other z-go">cache</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">DeletedFinalStateUnknown</span><span class="z-punctuation z-separator z-go">:</span>
</span></span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">					<span class="z-keyword z-control z-go">if</span> <span class="z-variable z-declaration z-go">pod</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-declaration z-go">ok</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">t</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">Obj</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-keyword z-operator z-go">*</span><span class="z-variable z-other z-go">v1</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-storage z-type z-go">Pod</span><span class="z-punctuation z-section z-parens z-end z-go">)</span><span class="z-punctuation z-terminator z-go">;</span> <span class="z-variable z-other z-go">ok</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">						<span class="z-keyword z-control z-go">return</span> <span class="z-keyword z-operator z-go">!</span><span class="z-variable z-function z-go">assignedPod</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">pod</span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-keyword z-operator z-go">&&</span> <span class="z-variable z-function z-go">responsibleForPod</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">pod</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">schedulerName</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">					<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">					<span class="z-variable z-other z-go">utilruntime</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">HandleError</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">fmt</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Errorf</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">"</span>unable to convert object <span class="z-constant z-other z-placeholder z-go">%T</span> to *v1.Pod in <span class="z-constant z-other z-placeholder z-go">%T</span><span class="z-punctuation z-definition z-string z-end z-go">"</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">obj</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">sched</span><span class="z-punctuation z-section z-parens z-end z-go">)</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">					<span class="z-keyword z-control z-go">return</span> <span class="z-constant z-language z-go">false</span>
</span></span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">				<span class="z-keyword z-control z-go">default</span><span class="z-punctuation z-separator z-go">:</span>
</span></span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">					<span class="z-variable z-other z-go">utilruntime</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">HandleError</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">fmt</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Errorf</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">"</span>unable to handle object in <span class="z-constant z-other z-placeholder z-go">%T</span>: <span class="z-constant z-other z-placeholder z-go">%T</span><span class="z-punctuation z-definition z-string z-end z-go">"</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">sched</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">obj</span><span class="z-punctuation z-section z-parens z-end z-go">)</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">					<span class="z-keyword z-control z-go">return</span> <span class="z-constant z-language z-go">false</span>
</span></span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">				<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-punctuation z-section z-braces z-end z-go">}</span></span><span class="z-punctuation z-separator z-go">,</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-variable z-other z-go">Handler</span><span class="z-punctuation z-separator z-go">:</span> <span class="z-variable z-other z-go">cache</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">ResourceEventHandlerFuncs</span><span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">				<span class="z-variable z-other z-go">AddFunc</span><span class="z-punctuation z-separator z-go">:</span>    <span class="z-variable z-other z-go">sched</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">addPodToSchedulingQueue</span><span class="z-punctuation z-separator z-go">,</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">				<span class="z-variable z-other z-go">UpdateFunc</span><span class="z-punctuation z-separator z-go">:</span> <span class="z-variable z-other z-go">sched</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">updatePodInSchedulingQueue</span><span class="z-punctuation z-separator z-go">,</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">				<span class="z-variable z-other z-go">DeleteFunc</span><span class="z-punctuation z-separator z-go">:</span> <span class="z-variable z-other z-go">sched</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">deletePodFromSchedulingQueue</span><span class="z-punctuation z-separator z-go">,</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-punctuation z-section z-braces z-end z-go">}</span></span><span class="z-punctuation z-separator z-go">,</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-punctuation z-section z-braces z-end z-go">}</span></span><span class="z-punctuation z-separator z-go">,</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></code></pre><p><a href=https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/scheduler/eventhandlers.go#L418>https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/scheduler/eventhandlers.go#L418</a><pre class="language-go z-code" data-lang=go><code class=language-go data-lang=go><span class="z-source z-go"><span class="z-storage z-type z-keyword z-function z-go">func</span> <span class="z-entity z-name z-function z-go">assignedPod</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-parameter z-go">pod</span> <span class="z-keyword z-operator z-go">*</span><span class="z-variable z-other z-go">v1</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-storage z-type z-go">Pod</span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">bool</span></span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-keyword z-control z-go">return</span> <span class="z-variable z-function z-go"><span class="z-support z-function z-builtin z-go">len</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">pod</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">Spec</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">NodeName</span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-keyword z-operator z-go">!=</span> <span class="z-constant z-numeric z-integer z-decimal z-go">0</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></code></pre><p><a href=https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/scheduler/eventhandlers.go#L418>https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/scheduler/eventhandlers.go#L323</a><p><code>Scheduler</code>が<code>podInformer</code>にevent handlerを登録する際に、podがassigne(<code>NodeName</code>が設定されている)されていないことを条件とするfilterを設定していることがわかります。<h3 id=kubelethaskip><a aria-label="Anchor link for: kubelethaskip" class=zola-anchor href=#kubelethaskip>kubeletはskip</a></h3><a href="https://speakerdeck.com/govargo/under-the-kubernetes-controller-36f9b71b-9781-4846-9625-23c31da93014?slide=22"> <figure><div class=fig-images-row><img , alt src=images/controller_4.jpeg></div></figure> </a><pre class="language-go z-code" data-lang=go><code class=language-go data-lang=go><span class="z-source z-go">
</span><span class="z-source z-go"><span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> NewSourceApiserver creates a config source that watches and pulls from the apiserver.
</span></span><span class="z-source z-go"><span class="z-storage z-type z-keyword z-function z-go">func</span> <span class="z-entity z-name z-function z-go">NewSourceApiserver</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-parameter z-go">c</span> <span class="z-variable z-other z-go">clientset</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-storage z-type z-go">Interface</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-parameter z-go">nodeName</span> <span class="z-variable z-other z-go">types</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-storage z-type z-go">NodeName</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-parameter z-go">updates</span> <span class="z-storage z-type z-keyword z-chan z-go">chan</span><span class="z-keyword z-operator z-go">&LT-</span> <span class="z-storage z-type z-keyword z-interface z-go">interface</span><span class="z-meta z-type z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span><span class="z-punctuation z-section z-braces z-end z-go">}</span></span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-declaration z-go">lw</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">cache</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">NewListWatchFromClient</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">c</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">CoreV1</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-parens z-end z-go">)</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">RESTClient</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-parens z-end z-go">)</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">"</span>pods<span class="z-punctuation z-definition z-string z-end z-go">"</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">metav1</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">NamespaceAll</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">fields</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">OneTermEqualSelector</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">api</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">PodHostField</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-function z-go"><span class="z-support z-type z-builtin z-go">string</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">nodeName</span><span class="z-punctuation z-section z-parens z-end z-go">)</span><span class="z-punctuation z-section z-parens z-end z-go">)</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-function z-go">newSourceApiserverFromLW</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">lw</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">updates</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></code></pre><p><a href=https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/kubelet/config/apiserver.go#L32>https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/kubelet/config/apiserver.go#L32</a><p><code>kubelet</code>のapi serverへのclient生成処理時に、<code>Pod</code>のHost名が(おそらく)自身のnode名と一致するFilterを設定しているようです。<h3 id=schedulerganode-namewoshe-ding><a aria-label="Anchor link for: schedulerganode-namewoshe-ding" class=zola-anchor href=#schedulerganode-namewoshe-ding>Schedulerがnode nameを設定</a></h3><a href="https://speakerdeck.com/govargo/under-the-kubernetes-controller-36f9b71b-9781-4846-9625-23c31da93014?slide=23"> <figure><div class=fig-images-row><img , alt src=images/controller_5.jpeg></div></figure> </a><pre class="language-go z-code" data-lang=go><code class=language-go data-lang=go><span class="z-source z-go"><span class="z-storage z-type z-keyword z-function z-go">func</span> <span class="z-meta z-function z-declaration z-go"><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-parameter z-go">sched</span> <span class="z-keyword z-operator z-go">*</span><span class="z-storage z-type z-go">Scheduler</span><span class="z-punctuation z-section z-parens z-end z-go">)</span></span><span class="z-meta z-function z-declaration z-go"> <span class="z-entity z-name z-function z-go">scheduleOne</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> ...
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-declaration z-go">pod</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">sched</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">NextPod</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> ...
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-declaration z-go">scheduleResult</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-declaration z-go">err</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">sched</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">schedule</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">pod</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">pluginContext</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> ...
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-declaration z-go">assumedPod</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">pod</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">DeepCopy</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> ...
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go">
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> assume modifies `assumedPod` by setting NodeName=scheduleResult.SuggestedHost
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-other z-go">err</span> <span class="z-keyword z-operator z-assignment z-go">=</span> <span class="z-variable z-other z-go">sched</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">assume</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">assumedPod</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">scheduleResult</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">SuggestedHost</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> ...
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span><span class="z-source z-go">
</span></code></pre><p>[https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/scheduler/scheduler.go#L516](white-space:nowrap; overflow:scroll;)<pre class="language-go z-code" data-lang=go><code class=language-go data-lang=go><span class="z-source z-go"><span class="z-storage z-type z-keyword z-function z-go">func</span> <span class="z-meta z-function z-declaration z-go"><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-parameter z-go">sched</span> <span class="z-keyword z-operator z-go">*</span><span class="z-storage z-type z-go">Scheduler</span><span class="z-punctuation z-section z-parens z-end z-go">)</span></span><span class="z-meta z-function z-declaration z-go"> <span class="z-entity z-name z-function z-go">assume</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-parameter z-go">assumed</span> <span class="z-keyword z-operator z-go">*</span><span class="z-variable z-other z-go">v1</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-storage z-type z-go">Pod</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-parameter z-go">host</span> <span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">string</span></span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">error</span></span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">    <span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> ...
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-other z-go">assumed</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">Spec</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">NodeName</span> <span class="z-keyword z-operator z-assignment z-go">=</span> <span class="z-variable z-other z-go">host</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">    <span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> ...
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-keyword z-control z-go">return</span> <span class="z-constant z-language z-go">nil</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></code></pre><p>[https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/scheduler/scheduler.go#L447](white-space:nowrap; overflow:scroll;)<p>Scheduling処理自体は一大Topicですが、流れとしては、なんらかの方法でNode名を選出して、<code>Pod</code>のnode名に指定していることがわかります。<h3 id=kubeletgakontenawoqi-dong><a aria-label="Anchor link for: kubeletgakontenawoqi-dong" class=zola-anchor href=#kubeletgakontenawoqi-dong><code>kubelet</code>がコンテナを起動</a></h3><a href="https://speakerdeck.com/govargo/under-the-kubernetes-controller-36f9b71b-9781-4846-9625-23c31da93014?slide=24"> <figure><div class=fig-images-row><img , alt src=images/controller_6.jpeg></div></figure> </a><pre class="language-go z-code" data-lang=go><code class=language-go data-lang=go><span class="z-source z-go"><span class="z-storage z-type z-keyword z-function z-go">func</span> <span class="z-meta z-function z-declaration z-go"><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-parameter z-go">m</span> <span class="z-keyword z-operator z-go">*</span><span class="z-storage z-type z-go">kubeGenericRuntimeManager</span><span class="z-punctuation z-section z-parens z-end z-go">)</span></span><span class="z-meta z-function z-declaration z-go"> <span class="z-entity z-name z-function z-go">SyncPod</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-parameter z-go">pod</span> <span class="z-keyword z-operator z-go">*</span><span class="z-variable z-other z-go">v1</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-storage z-type z-go">Pod</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-parameter z-go">podStatus</span> <span class="z-keyword z-operator z-go">*</span><span class="z-variable z-other z-go">kubecontainer</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-storage z-type z-go">PodStatus</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-parameter z-go">pullSecrets</span> <span class="z-punctuation z-section z-brackets z-begin z-go">[</span><span class="z-punctuation z-section z-brackets z-end z-go">]</span><span class="z-variable z-other z-go">v1</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-storage z-type z-go">Secret</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-parameter z-go">backOff</span> <span class="z-keyword z-operator z-go">*</span><span class="z-variable z-other z-go">flowcontrol</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-storage z-type z-go">Backoff</span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-parameter z-go">result</span> <span class="z-variable z-other z-go">kubecontainer</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-storage z-type z-go">PodSyncResult</span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go"> 	<span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> ...
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> Step 6: start the init container.
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-keyword z-control z-go">if</span> <span class="z-variable z-declaration z-go">container</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">podContainerChanges</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">NextInitContainerToStart</span><span class="z-punctuation z-terminator z-go">;</span> <span class="z-variable z-other z-go">container</span> <span class="z-keyword z-operator z-go">!=</span> <span class="z-constant z-language z-go">nil</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> Start the next init container.
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-keyword z-control z-go">if</span> <span class="z-variable z-declaration z-go">err</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-function z-go">start</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">"</span>init container<span class="z-punctuation z-definition z-string z-end z-go">"</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">container</span><span class="z-punctuation z-section z-parens z-end z-go">)</span><span class="z-punctuation z-terminator z-go">;</span> <span class="z-variable z-other z-go">err</span> <span class="z-keyword z-operator z-go">!=</span> <span class="z-constant z-language z-go">nil</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-keyword z-control z-go">return</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> Successfully started the container; clear the entry in the failure
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-other z-go">klog</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">V</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-constant z-numeric z-integer z-decimal z-go">4</span><span class="z-punctuation z-section z-parens z-end z-go">)</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Infof</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-string z-quoted z-double z-go"><span class="z-punctuation z-definition z-string z-begin z-go">"</span>Completed init container <span class="z-constant z-other z-placeholder z-go">%q</span> for pod <span class="z-constant z-other z-placeholder z-go">%q</span><span class="z-punctuation z-definition z-string z-end z-go">"</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">container</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">Name</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">format</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Pod</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">pod</span><span class="z-punctuation z-section z-parens z-end z-go">)</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">	<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">    <span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> ...
</span></span></span></code></pre><p><a href=https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/kubelet/kuberuntime/kuberuntime_manager.go#L803>https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/kubelet/kuberuntime/kuberuntime_manager.go#L803</a><p><code>kubelet</code>の処理はまったく追えていないのですが、コンテナを起動しているような処理を実行しています。<h3 id=kubeletgapodnostatuswogeng-xin><a aria-label="Anchor link for: kubeletgapodnostatuswogeng-xin" class=zola-anchor href=#kubeletgapodnostatuswogeng-xin><code>kubelet</code>が<code>Pod</code>のstatusを更新</a></h3><p><a href="https://speakerd.s3.amazonaws.com/presentations/173fdf8b50f445ba895b82fb6650825c/preview_slide_24.jpg?13730934:image=https://speakerd.s3.amazonaws.com/presentations/173fdf8b50f445ba895b82fb6650825c/preview_slide_24.jpg?13730934">https://speakerd.s3.amazonaws.com/presentations/173fdf8b50f445ba895b82fb6650825c/preview_slide_24.jpg?13730934:image=https://speakerd.s3.amazonaws.com/presentations/173fdf8b50f445ba895b82fb6650825c/preview_slide_24.jpg?13730934</a><pre class="language-go z-code" data-lang=go><code class=language-go data-lang=go><span class="z-source z-go"><span class="z-storage z-type z-keyword z-function z-go">func</span> <span class="z-meta z-function z-declaration z-go"><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-parameter z-go">kl</span> <span class="z-keyword z-operator z-go">*</span><span class="z-storage z-type z-go">Kubelet</span><span class="z-punctuation z-section z-parens z-end z-go">)</span></span><span class="z-meta z-function z-declaration z-go"> <span class="z-entity z-name z-function z-go">syncPod</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-parameter z-go">o</span> <span class="z-storage z-type z-go">syncPodOptions</span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">error</span></span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> pull out the required options
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-declaration z-go">pod</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">o</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">pod</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-declaration z-go">mirrorPod</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">o</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">mirrorPod</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-declaration z-go">podStatus</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">o</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">podStatus</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-declaration z-go">updateType</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">o</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">updateType</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> ...
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go">
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> Generate final API pod status with pod and status manager status
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-declaration z-go">apiPodStatus</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">kl</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">generateAPIPodStatus</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">pod</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">podStatus</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></code></pre><p><a href=https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/kubelet/kubelet.go#L1481>https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/kubelet/kubelet.go#L1481</a><h3 id=podnoterminating><a aria-label="Anchor link for: podnoterminating" class=zola-anchor href=#podnoterminating><code>Pod</code>のTerminating</a></h3><a href="https://speakerdeck.com/govargo/under-the-kubernetes-controller-36f9b71b-9781-4846-9625-23c31da93014?slide=26"> <figure><div class=fig-images-row><img , alt src=images/controller_7.jpeg></div></figure> </a><pre class="language-go z-code" data-lang=go><code class=language-go data-lang=go><span class="z-source z-go"><span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> dispatchWork starts the asynchronous sync of the pod in a pod worker.
</span></span><span class="z-source z-go"><span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> If the pod is terminated, dispatchWork
</span></span><span class="z-source z-go"><span class="z-storage z-type z-keyword z-function z-go">func</span> <span class="z-meta z-function z-declaration z-go"><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-parameter z-go">kl</span> <span class="z-keyword z-operator z-go">*</span><span class="z-storage z-type z-go">Kubelet</span><span class="z-punctuation z-section z-parens z-end z-go">)</span></span><span class="z-meta z-function z-declaration z-go"> <span class="z-entity z-name z-function z-go">dispatchWork</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-parameter z-go">pod</span> <span class="z-keyword z-operator z-go">*</span><span class="z-variable z-other z-go">v1</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-storage z-type z-go">Pod</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-parameter z-go">syncType</span> <span class="z-variable z-other z-go">kubetypes</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-storage z-type z-go">SyncPodType</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-parameter z-go">mirrorPod</span> <span class="z-keyword z-operator z-go">*</span><span class="z-variable z-other z-go">v1</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-storage z-type z-go">Pod</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-parameter z-go">start</span> <span class="z-variable z-other z-go">time</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-storage z-type z-go">Time</span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-keyword z-control z-go">if</span> <span class="z-variable z-other z-go">kl</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">podIsTerminated</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">pod</span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-keyword z-control z-go">if</span> <span class="z-variable z-other z-go">pod</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">DeletionTimestamp</span> <span class="z-keyword z-operator z-go">!=</span> <span class="z-constant z-language z-go">nil</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> If the pod is in a terminated state, there is no pod worker to
</span></span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> handle the work item. Check if the DeletionTimestamp has been
</span></span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> set, and force a status update to trigger a pod deletion request
</span></span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> to the apiserver.
</span></span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-variable z-other z-go">kl</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">statusManager</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">TerminatePod</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">pod</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-keyword z-control z-go">return</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">	<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">    <span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> ...
</span></span></span></code></pre><p><a href=https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/kubelet/kubelet.go#L1999>https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/kubelet/kubelet.go#L1999</a><h3 id=replicasetcontrollergapodwoxue-chu><a aria-label="Anchor link for: replicasetcontrollergapodwoxue-chu" class=zola-anchor href=#replicasetcontrollergapodwoxue-chu><code>ReplicaSetController</code>が<code>Pod</code>を削除</a></h3><a href="https://speakerdeck.com/govargo/under-the-kubernetes-controller-36f9b71b-9781-4846-9625-23c31da93014?slide=28"> <figure><div class=fig-images-row><img , alt src=images/controller_8.jpeg></div></figure> </a><pre class="language-go z-code" data-lang=go><code class=language-go data-lang=go><span class="z-source z-go"><span class="z-storage z-type z-keyword z-function z-go">func</span> <span class="z-meta z-function z-declaration z-go"><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-parameter z-go">rsc</span> <span class="z-keyword z-operator z-go">*</span><span class="z-storage z-type z-go">ReplicaSetController</span><span class="z-punctuation z-section z-parens z-end z-go">)</span></span><span class="z-meta z-function z-declaration z-go"> <span class="z-entity z-name z-function z-go">manageReplicas</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-parameter z-go">filteredPods</span> <span class="z-punctuation z-section z-brackets z-begin z-go">[</span><span class="z-punctuation z-section z-brackets z-end z-go">]</span><span class="z-keyword z-operator z-go">*</span><span class="z-variable z-other z-go">v1</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-storage z-type z-go">Pod</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-parameter z-go">rs</span> <span class="z-keyword z-operator z-go">*</span><span class="z-variable z-other z-go">apps</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-storage z-type z-go">ReplicaSet</span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">error</span></span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-declaration z-go">diff</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-function z-go"><span class="z-support z-function z-builtin z-go">len</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">filteredPods</span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-keyword z-operator z-go">-</span> <span class="z-variable z-function z-go"><span class="z-support z-type z-builtin z-go">int</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-keyword z-operator z-go">*</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">rs</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">Spec</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">Replicas</span><span class="z-punctuation z-section z-parens z-end z-go">)</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-variable z-declaration z-go">rsKey</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-declaration z-go">err</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">controller</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">KeyFunc</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">rs</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> ...
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span><span class="z-source z-go">	<span class="z-keyword z-control z-go">if</span> <span class="z-variable z-other z-go">diff</span> <span class="z-keyword z-operator z-go"><</span> <span class="z-constant z-numeric z-integer z-decimal z-go">0</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">		<span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> ...
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-punctuation z-section z-braces z-end z-go">}</span></span> <span class="z-keyword z-control z-go">else</span> <span class="z-keyword z-control z-go">if</span> <span class="z-variable z-other z-go">diff</span> <span class="z-keyword z-operator z-go">></span> <span class="z-constant z-numeric z-integer z-decimal z-go">0</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">		<span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> ...
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go">		<span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> Choose which Pods to delete, preferring those in earlier phases of startup.
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-declaration z-go">podsToDelete</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-function z-go">getPodsToDelete</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">filteredPods</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">diff</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">		<span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> ...
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-declaration z-go">errCh</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-function z-go"><span class="z-support z-function z-builtin z-go">make</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-storage z-type z-keyword z-chan z-go">chan</span> <span class="z-storage z-type z-go"><span class="z-support z-type z-builtin z-go">error</span></span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">diff</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">		<span class="z-storage z-type z-keyword z-var z-go">var</span> <span class="z-variable z-declaration z-go">wg</span> <span class="z-variable z-other z-go">sync</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-storage z-type z-go">WaitGroup</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-other z-go">wg</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Add</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">diff</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">		<span class="z-keyword z-control z-go">for</span> <span class="z-variable z-language z-blank z-go">_</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-declaration z-go">pod</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-keyword z-other z-go">range</span> <span class="z-variable z-other z-go">podsToDelete</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-keyword z-control z-go">go</span> <span class="z-storage z-type z-keyword z-function z-go">func</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-parameter z-go">targetPod</span> <span class="z-keyword z-operator z-go">*</span><span class="z-variable z-other z-go">v1</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-storage z-type z-go">Pod</span><span class="z-punctuation z-section z-parens z-end z-go">)</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">				<span class="z-keyword z-control z-go">defer</span> <span class="z-variable z-other z-go">wg</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Done</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">				<span class="z-keyword z-control z-go">if</span> <span class="z-variable z-declaration z-go">err</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-variable z-other z-go">rsc</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">podControl</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">DeletePod</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">rs</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">Namespace</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">targetPod</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-other z-member z-go">Name</span><span class="z-punctuation z-separator z-go">,</span> <span class="z-variable z-other z-go">rs</span><span class="z-punctuation z-section z-parens z-end z-go">)</span><span class="z-punctuation z-terminator z-go">;</span> <span class="z-variable z-other z-go">err</span> <span class="z-keyword z-operator z-go">!=</span> <span class="z-constant z-language z-go">nil</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">					<span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> ...
</span></span></span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">					<span class="z-variable z-other z-go">errCh</span> <span class="z-keyword z-operator z-go">&LT-</span> <span class="z-variable z-other z-go">err</span>
</span></span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">				<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-punctuation z-section z-braces z-end z-go">}</span></span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-variable z-other z-go">pod</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">		<span class="z-variable z-other z-go">wg</span><span class="z-punctuation z-accessor z-dot z-go">.</span><span class="z-variable z-function z-go">Wait</span><span class="z-punctuation z-section z-parens z-begin z-go">(</span><span class="z-punctuation z-section z-parens z-end z-go">)</span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">		<span class="z-keyword z-control z-go">select</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-keyword z-control z-go">case</span> <span class="z-variable z-declaration z-go">err</span> <span class="z-keyword z-operator z-assignment z-go">:=</span> <span class="z-keyword z-operator z-go">&LT-</span><span class="z-variable z-other z-go">errCh</span><span class="z-punctuation z-separator z-go">:</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-comment z-line z-go"><span class="z-punctuation z-definition z-comment z-go">//</span> all errors have been reported before and they're likely to be the same, so we'll only return the first one we hit.
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-keyword z-control z-go">if</span> <span class="z-variable z-other z-go">err</span> <span class="z-keyword z-operator z-go">!=</span> <span class="z-constant z-language z-go">nil</span> <span class="z-meta z-block z-go"><span class="z-punctuation z-section z-braces z-begin z-go">{</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">				<span class="z-keyword z-control z-go">return</span> <span class="z-variable z-other z-go">err</span>
</span></span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">			<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-keyword z-control z-go">default</span><span class="z-punctuation z-separator z-go">:</span>
</span></span></span><span class="z-source z-go"><span class="z-meta z-block z-go"><span class="z-meta z-block z-go">		<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span></span><span class="z-source z-go"><span class="z-meta z-block z-go">	<span class="z-punctuation z-section z-braces z-end z-go">}</span></span>
</span><span class="z-source z-go">
</span><span class="z-source z-go">	<span class="z-keyword z-control z-go">return</span> <span class="z-constant z-language z-go">nil</span>
</span><span class="z-source z-go"><span class="z-punctuation z-section z-braces z-end z-go">}</span>
</span></code></pre><p><a href=https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/controller/replicaset/replica_set.go#L459>https://github.com/kubernetes/kubernetes/blob/2f76f5e63872a40ac08056289a6c52b4f6250154/pkg/controller/replicaset/replica_set.go#L459</a><p>ここで再び、<code>ReplicaSetController.manageReplicas()</code>に戻ってきました。今度は、specよりも実際の<code>Pod</code>が多いので、削除処理が走るようです。削除処理はシンプルに削除する数だけgoroutineを起動するようです。<h3 id=reconcile><a aria-label="Anchor link for: reconcile" class=zola-anchor href=#reconcile>Reconcile</a></h3><a href="https://speakerd.s3.amazonaws.com/presentations/173fdf8b50f445ba895b82fb6650825c/preview_slide_29.jpg?13730939:image=https://speakerd.s3.amazonaws.com/presentations/173fdf8b50f445ba895b82fb6650825c/preview_slide_29.jpg?13730939"> <figure><div class=fig-images-row><img , alt src=images/controller_9.jpeg></div></figure> </a><p>ここまで、非常に簡単にですがslideにそって、<code>ReplicaSetController</code>を中心に該当コードを追いかけてみました。 kubernetesのcodeを初めて読んだのですが、各componentの実装がだいたいどのあたりあるのかを知るためのとっかかりとして非常に参考になりました。slideの後半では、<code>Informer</code>や<code>WorkQueue</code>についても解説されているので、是非そちらも追いかけてみようと思います。</div></article></main><footer class=blog-footer><p>© 2025 <a href=https://blog.ymgyt.io> ymgyt </a> | Made with <a href=https://www.getzola.org rel=noopener target=_blank>Zola</a> | <a href=https://github.com/ymgyt/blog>Repository</a> | <a href=https://blog.ymgyt.io/atom.xml target=_blank title=rss> <svg viewbox="0 0 24 24" class=icon fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx=5 cy=19 r=1></circle></svg> </a></footer></div></div>