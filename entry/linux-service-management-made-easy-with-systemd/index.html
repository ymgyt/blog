<!doctype html><html lang=ja><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1" name=viewport><link href=https://blog.ymgyt.io/favicon.ico rel=icon sizes=any><link href=https://blog.ymgyt.io/icon.svg rel=icon type=image/svg+xml><link href=https://blog.ymgyt.io/apple-touch-icon.png rel=apple-touch-icon><link href=https://blog.ymgyt.io/manifest.webmanifest rel=manifest><link href=https://blog.ymgyt.io/style.css rel=stylesheet><link href=https://blog.ymgyt.io/atom.xml rel=alternate title=Atom type=application/atom+xml><script src="https://www.googletagmanager.com/gtag/js?id=G-GTB0KMLN90" async></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[];gtag(`js`,new Date());gtag(`config`,`G-GTB0KMLN90`)</script><title>📗 Linux Service Management Made Easy with systemdを読んだ感想 | Happy developing</title><meta content="Linux Service Management Made Easy with systemd本の概要だったり良かったところについて" name=description><meta content=summary name=twitter:card><meta content="@YAmaguchixt " name=twitter:site><meta content="📗 Linux Service Management Made Easy with systemdを読んだ感想" name=twitter:title><meta content="Linux Service Management Made Easy with systemd本の概要だったり良かったところについて" name=twitter:description><meta content=https://blog.ymgyt.io/images/emoji/green_book.png name=twitter:image><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><body><div class=world><div class=content-container><header class=blog-header-container><div class=blog-logo><a href=https://blog.ymgyt.io>Happy developing</a></div><div class=blog-nav><nav><ul><li><a href=https://blog.ymgyt.io/entry/>Entries</a><li><a href=https://blog.ymgyt.io/tags/>Tags</a><li><a href=https://blog.ymgyt.io/about/>About</a><li><a href=https://github.com/ymgyt> <img alt=Github class=icon src=https://blog.ymgyt.io/images/icon/github.svg> </a><li><a href="https://twitter.com/YAmaguchixt "> <img alt=Twitter class=icon src=https://blog.ymgyt.io/images/icon/twitter.svg> </a></ul></nav></div></header><main class=blog-main><article><header class=entry-header><h1 class=entry-title>📗 Linux Service Management Made Easy with systemdを読んだ感想</h1><div class=entry-meta><p class=entry-meta-item>🗓 2023-10-15<p class=entry-meta-item>🏷 <span class=tag><a href=https://blog.ymgyt.io/tags/book/>book</a></span></div></header><aside class=entry-toc><nav><ul class=entry-toc-toplevel-list><li><a href=https://blog.ymgyt.io/entry/linux-service-management-made-easy-with-systemd/#du-ndaben>読んだ本</a><li><a href=https://blog.ymgyt.io/entry/linux-service-management-made-easy-with-systemd/#chapter-1-understanding-the-need-for-systemd>Chapter 1 Understanding the Need for systemd</a><li><a href=https://blog.ymgyt.io/entry/linux-service-management-made-easy-with-systemd/#chapter-2-understanding-systemd-directories-and-files>Chapter 2 Understanding systemd Directories and Files</a><li><a href=https://blog.ymgyt.io/entry/linux-service-management-made-easy-with-systemd/#chapter-3-understanding-service-path-and-socket-units>Chapter 3 Understanding Service, Path, and Socket Units</a><li><a href=https://blog.ymgyt.io/entry/linux-service-management-made-easy-with-systemd/#chapter-4-controlling-systemd-services>Chapter 4 Controlling systemd Services</a><li><a href=https://blog.ymgyt.io/entry/linux-service-management-made-easy-with-systemd/#chapter-5-creating-and-editing-services>Chapter 5 Creating and Editing Services</a><li><a href=https://blog.ymgyt.io/entry/linux-service-management-made-easy-with-systemd/#chapter-6-understanding-systemd-targets>Chapter 6 Understanding systemd Targets</a><li><a href=https://blog.ymgyt.io/entry/linux-service-management-made-easy-with-systemd/#chapter-7-understanding-systemd-timers>Chapter 7 Understanding systemd Timers</a><li><a href=https://blog.ymgyt.io/entry/linux-service-management-made-easy-with-systemd/#chapter-8-understanding-the-systemd-boot-process>Chapter 8 Understanding the systemd Boot Process</a><li><a href=https://blog.ymgyt.io/entry/linux-service-management-made-easy-with-systemd/#chapter-9-setting-system-parameters>Chapter 9 Setting System Parameters</a><li><a href=https://blog.ymgyt.io/entry/linux-service-management-made-easy-with-systemd/#chapter-10-understanding-shutdown-and-reboot-commands>Chapter 10 Understanding Shutdown and Reboot Commands</a><li><a href=https://blog.ymgyt.io/entry/linux-service-management-made-easy-with-systemd/#chapter-11-understanding-cgroups-version-1>Chapter 11 Understanding cgroups Version 1</a><li><a href=https://blog.ymgyt.io/entry/linux-service-management-made-easy-with-systemd/#chapter-12-controlling-resource-usage-with-cgroups-version-1>Chapter 12 Controlling Resource Usage with cgroups Version 1</a><li><a href=https://blog.ymgyt.io/entry/linux-service-management-made-easy-with-systemd/#chapter-13-understanding-cgroup-version-2>Chapter 13 Understanding cgroup Version 2</a><li><a href=https://blog.ymgyt.io/entry/linux-service-management-made-easy-with-systemd/#chapter-14-using-journald>Chapter 14 Using journald</a><li><a href=https://blog.ymgyt.io/entry/linux-service-management-made-easy-with-systemd/#chapter-15-using-systemd-networkd-and-systemd-resolved>Chapter 15 Using systemd-networkd and systemd-resolved</a><li><a href=https://blog.ymgyt.io/entry/linux-service-management-made-easy-with-systemd/#chapter-16-understanding-timekeeping-with-systemd>Chapter 16 Understanding Timekeeping with systemd</a><li><a href=https://blog.ymgyt.io/entry/linux-service-management-made-easy-with-systemd/#chapter-17-understanding-systemd-and-bootloaders>Chapter 17 Understanding systemd and Bootloaders</a><li><a href=https://blog.ymgyt.io/entry/linux-service-management-made-easy-with-systemd/#chapter-18-understanding-systemd-logind>Chapter 18 Understanding systemd-logind</a><li><a href=https://blog.ymgyt.io/entry/linux-service-management-made-easy-with-systemd/#matome>まとめ</a></ul></nav></aside><div class=entry-content><h2 id=du-ndaben><a aria-label="Anchor link for: du-ndaben" class=zola-anchor href=#du-ndaben>読んだ本</a></h2><figure><div class=fig-images-row><img , alt src=images/systemd-book.jpg></div></figure><p><a href=https://learning.oreilly.com/library/view/linux-service-management/9781801811644/>Linux Service Management Made Easy with systemd</a><p>systemdについて説明してくれている本、ないかなと思っていたら見つけたので読んでみました。　　<h2 id=chapter-1-understanding-the-need-for-systemd><a aria-label="Anchor link for: chapter-1-understanding-the-need-for-systemd" class=zola-anchor href=#chapter-1-understanding-the-need-for-systemd>Chapter 1 Understanding the Need for systemd</a></h2><p>SysV Initやupstartの歴史について。<br> 特にSysVの問題点としては<ul><li>serviceの起動処理がsequentialであることから起動時間が長くなってしまうこと<li>serviceの制御がbashのscriptで行なわれるので複雑</ul><p>bashのscriptにしても<pre class="language-sh z-code" data-lang=sh><code class=language-sh data-lang=sh><span class="z-source z-shell z-bash"><span class="z-meta z-conditional z-case z-shell"><span class="z-keyword z-control z-conditional z-case z-shell">case</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">ARG</span></span><span class="z-punctuation z-definition z-string z-end z-shell">"</span></span> <span class="z-keyword z-control z-in z-shell">in</span>
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-conditional z-case z-shell">  </span><span class="z-meta z-conditional z-case z-clause z-patterns z-shell">start<span class="z-meta z-conditional z-case z-shell"><span class="z-keyword z-control z-conditional z-patterns z-end z-shell">)</span></span></span><span class="z-meta z-conditional z-case z-clause z-commands z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-conditional z-case z-clause z-commands z-shell">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">start</span></span>
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-conditional z-case z-clause z-commands z-shell">    </span><span class="z-meta z-conditional z-case z-clause z-commands z-shell"><span class="z-punctuation z-terminator z-case z-clause z-shell">;;</span></span><span class="z-meta z-conditional z-case z-clause z-patterns z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-conditional z-case z-clause z-patterns z-shell">  </span><span class="z-meta z-conditional z-case z-clause z-patterns z-shell">status<span class="z-meta z-conditional z-case z-clause z-patterns z-shell"><span class="z-keyword z-control z-conditional z-patterns z-end z-shell">)</span></span></span><span class="z-meta z-conditional z-case z-clause z-commands z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-conditional z-case z-clause z-commands z-shell">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">status</span></span>
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-conditional z-case z-clause z-commands z-shell">    </span><span class="z-meta z-conditional z-case z-clause z-commands z-shell"><span class="z-punctuation z-terminator z-case z-clause z-shell">;;</span></span><span class="z-meta z-conditional z-case z-clause z-patterns z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-conditional z-case z-clause z-patterns z-shell">  <span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> ...</span><span class="z-comment z-line z-number-sign z-shell">
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-conditional z-case z-clause z-patterns z-shell"><span class="z-keyword z-control z-conditional z-end z-shell">esac</span></span>
</span></code></pre><p>のようにそれぞれのscriptで実装しているのでstatusの出力になにか決まったformatがあるわけではなかった。<p>systemdの利点の一つとして、linux distributions間での統一性にも言及されていた。用はdistroに限らず同じsystemdのcommandだけ覚えればよくなる。<br> また、processをkillする際もsystemdが対象processのchild processも考慮してくれるのでzombieを気にしなくてよい。<p>securityという観点からも、accessできるdirectoryを制限できたり、namespaces, cgroups, capabilitiesといった機能を利用できるように設計されている。<p>systemd最高..!とおもいきや、systemdの採用には議論もあった。<br> そのひとつにsystemdは多くを行いすぎており、unixのconceptである一つのことをうまくやるに反しているというものがあった。<br> この点については、確かにinit systemを超えて、networkやbootloader, logging, loginまでsystemdは行なっているが、これらはoptionalであると反論されていた。<p>systemdに関してはいろいろと議論もあるし、嫌いな人もいるが、主要なdistributionでは結局採用されているよねという感じで結ばれていました。<p>といったようにsystemdが解決しようとした課題であったり、現在の状況が整理されておりこういった情報は自分のようなlinux弱者にはとてもありがたいです。<h2 id=chapter-2-understanding-systemd-directories-and-files><a aria-label="Anchor link for: chapter-2-understanding-systemd-directories-and-files" class=zola-anchor href=#chapter-2-understanding-systemd-directories-and-files>Chapter 2 Understanding systemd Directories and Files</a></h2><p>systemdによってinterfaceは統一されたが、distributionsによって有効にしているcomponentは違うのでそこで差が生じる。<br> というわけで設定fileを確認してみる。<br> NixOSの<code>/etc/systemd/system.conf</code>を確認してみたところ以下の内容だった<pre class="language-text z-code" data-lang=text><code class=language-text data-lang=text><span class="z-text z-plain">[Manager]
</span><span class="z-text z-plain">ManagerEnvironment=LOCALE_ARCHIVE='/run/current-system/sw/lib/locale/locale-archive' PATH='/nix/store/jq4cqqgggw3x4rl67ib0zs8mbgczhqqg-e2fsprogs-1.47.0-bin/bin:/nix/store/p27k6zns5rrv80326zkv88yfmfw1zb9v-dosfstools-4.2/bin:/nix/store/ixjl0rdryakqci8rf70i6zh0h9qg3c43-util-linux-minimal-2.39.2-bin/bin' TZDIR='/etc/zoneinfo'
</span><span class="z-text z-plain">DefaultCPUAccounting=yes
</span><span class="z-text z-plain">DefaultIOAccounting=yes
</span><span class="z-text z-plain">DefaultBlockIOAccounting=yes
</span><span class="z-text z-plain">DefaultIPAccounting=yes
</span><span class="z-text z-plain">DefaultLimitCORE=infinity
</span></code></pre><p>この設定値の意味については<code>man systemd-system.conf</code>で調べられる。<br> <code>ManagerEnvironment</code>はmanager processにsetされる環境変数とのことだった。 nixらしく、<code>PATH</code>をnix storeにむけていて、globalをみないという意思を感じられる。<p>ここでsystemdにおけるunit fileの概要が説明される。 defaultでは<code>/lib/systemd/system/</code>配下に格納されており、変更や追加したい場合は<code>/etc/systemd/system/</code>を利用する。<p>これはどうしてかというと<code>man systemd.unit</code>に書いてあるから。<br> この本の素晴らしい点は概要を説明したのち、詳しいことについては読むべき<code>man systed.*</code>を教えてくれるところだった。<br> 特に、設定file中でわからない項目は<code>man systed.directives</code>を調べるとそれがどのmanに載っているか教えてくれるというアドバイスが非常にありがたかった。<p>例えば、serviceに設定する環境変数をfileで指定する<code>EnvironmentFile</code>については<pre class="language-sh z-code" data-lang=sh><code class=language-sh data-lang=sh><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">man</span></span><span class="z-meta z-function-call z-arguments z-shell"> systemd.directives</span> <span class="z-keyword z-operator z-logical z-pipe z-shell">|</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">grep</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">'</span>EnvironmentFile=<span class="z-punctuation z-definition z-string z-end z-shell">'</span></span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>A</span> 2</span>
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash"> <span class="z-variable z-other z-readwrite z-assignment z-shell">EnvironmentFile</span><span class="z-keyword z-operator z-assignment z-shell">=</span>
</span><span class="z-source z-shell z-bash">           <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">systemd.exec</span></span><span class="z-meta z-function-call z-arguments z-shell">(5</span><span class="z-meta z-function-call z-shell"></span>)
</span></code></pre><p>と表示され、<code>man systemd.exec</code>をみればよいことがわかる。<br> また、unit fileがどのdirectoryから取得されるかは、<code>systemd-analyze unit-paths</code>で表示できることもわかった。<br> stackoverflowのsystemd関連の回答ではこのmanの説明と同じことが説明されていた場合が結構多く、調べ方を教えてくれるのが一番助かる。<p>unit fileは以下のtypeをもっている。<br> 逆にいうとunit fileとはこれらの設定を抽象化したものともいえると思った。<ul><li>service<li>socket<li>slice<li>mount<li>target<li>timer<li>path<li>swap</ul><p>systemでどんなunitが動いているかは<code>systemctl list-units</code>で調べられる。<br> <code>-t</code>でtypeを指定できたり、<code>--all</code>で有効にされていないものも表示できる<br> 他にもいろいろな使い方があり、とても参考になった。<br> 詳しくは<code>systemctl -h</code>と<code>man systemctl</code><h2 id=chapter-3-understanding-service-path-and-socket-units><a aria-label="Anchor link for: chapter-3-understanding-service-path-and-socket-units" class=zola-anchor href=#chapter-3-understanding-service-path-and-socket-units>Chapter 3 Understanding Service, Path, and Socket Units</a></h2><p>Service unitはSysVのinit scriptの役割を果たす。つまりdaemonを制御する。<br> 設定でわからない項目は<code>man systemd.directives</code>で調べられる。<br> <code>[Unit]</code>については、<code>man systemd.unit</code>、<code>[Service]</code>については<code>man systemd.service</code>で調べられる。また、実行時に共通する話は<code>man systemd.exec</code>にも説明がある。<p>httpdやsshd serviceの具体例をみながらどんな項目があるのかの概要を説明してくれる。最初からmanをみるのは大変なので、説明があった箇所のmanあたりから読んでいくのが自分にはよかった。<p>また、<code>systemd-timesyncd</code>ではcapabilitiesの設定がなされており、それについても説明があった。<pre class="language-ini z-code" data-lang=ini><code class=language-ini data-lang=ini><span class="z-source z-genconfig"><span class="z-meta z-comment z-genconfig"><span class="z-comment z-line z-number-sign z-genconfig"># ...
</span></span></span><span class="z-source z-genconfig"><span class="z-storage z-type z-genconfig">[Service]
</span></span><span class="z-source z-genconfig"><span class="z-meta z-param z-genconfig"><span class="z-variable z-parameter z-genconfig">AmbientCapabilities</span><span class="z-keyword z-operator z-genconfig">=</span></span><span class="z-support z-constant z-genconfig">CAP_SYS_TIME</span>
</span><span class="z-source z-genconfig"><span class="z-meta z-param z-genconfig"><span class="z-variable z-parameter z-genconfig">CapabilityBoundingSet</span><span class="z-keyword z-operator z-genconfig">=</span></span><span class="z-support z-constant z-genconfig">CAP_SYS_TIME</span>
</span><span class="z-source z-genconfig"><span class="z-meta z-param z-genconfig"><span class="z-variable z-parameter z-genconfig">ExecStart</span><span class="z-keyword z-operator z-genconfig">=</span></span><span class="z-keyword z-operator z-genconfig">!</span><span class="z-keyword z-operator z-genconfig">!</span><span class="z-keyword z-operator z-genconfig">/</span>nix<span class="z-keyword z-operator z-genconfig">/</span>store<span class="z-keyword z-operator z-genconfig">/</span>qyxcg96wg1a21sj0sgbaxcapqc1vyq65<span class="z-keyword z-operator z-genconfig">-</span>systemd<span class="z-keyword z-operator z-genconfig">-</span><span class="z-constant z-numeric z-genconfig">253</span><span class="z-keyword z-operator z-genconfig">.</span><span class="z-constant z-numeric z-genconfig">6</span><span class="z-keyword z-operator z-genconfig">/</span>lib<span class="z-keyword z-operator z-genconfig">/</span>systemd<span class="z-keyword z-operator z-genconfig">/</span>systemd<span class="z-keyword z-operator z-genconfig">-</span>timesyncd
</span><span class="z-source z-genconfig"><span class="z-meta z-comment z-genconfig"><span class="z-comment z-line z-number-sign z-genconfig"># ...
</span></span></span><span class="z-source z-genconfig"><span class="z-meta z-param z-genconfig"><span class="z-variable z-parameter z-genconfig">User</span><span class="z-keyword z-operator z-genconfig">=</span></span>systemd<span class="z-keyword z-operator z-genconfig">-</span>timesync
</span></code></pre><p>自分でserviceを定義する際は、root userを利用せずにcapabilitiesをセットできるようにしていきたい。<br> (<code>ExecStart=!!</code>の<code>!!</code>については<code>man systemd.service</code>に説明があった)<p>socket unitについても説明がある。<br> が、いまいち使いどころがわかっていない。<p>path unitは、指定のfile pathの変更を監視して、変更があった場合に指定のserviceを起動してくれるものとのことです。<br> これもいまいち使いどころがわかっていないです。<h2 id=chapter-4-controlling-systemd-services><a aria-label="Anchor link for: chapter-4-controlling-systemd-services" class=zola-anchor href=#chapter-4-controlling-systemd-services>Chapter 4 Controlling systemd Services</a></h2><p><code>systemctl</code>の使い方についての解説があります。<br> serviceをserver起動時に起動する<code>systemctl enable</code>を実行した際に、<code>/etc/systemd/system/multi-user.target.wants/</code>配下にsymlinkが作成されるといった点も解説されます。<h2 id=chapter-5-creating-and-editing-services><a aria-label="Anchor link for: chapter-5-creating-and-editing-services" class=zola-anchor href=#chapter-5-creating-and-editing-services>Chapter 5 Creating and Editing Services</a></h2><p>本章ではserviceをつくる過程の解説があります。<br> <code>systemctl edit [--full]</code>で既存を直接編集することもできるみたいです。<p><code>systemd-analyze security opentelemetry-collector</code>のように実行するとserviceの設定のsecurity的な評価を表示してくれます。<br> 試しに実行してみたところ<pre class=z-code><code><span class="z-text z-plain">systemd-analyze security opentelemetry-collector
</span><span class="z-text z-plain">  NAME                                                        DESCRIPTION                                                             EXPOSURE
</span><span class="z-text z-plain">✗ RemoveIPC=                                                  Service user may leave SysV IPC objects around                               0.1
</span><span class="z-text z-plain">✗ RootDirectory=/RootImage=                                   Service runs within the host's root directory                                0.1
</span><span class="z-text z-plain">✓ User=/DynamicUser=                                          Service runs under a static non-root user identity
</span><span class="z-text z-plain">✗ CapabilityBoundingSet=~CAP_SYS_TIME                         Service processes may change the system clock                                0.2
</span><span class="z-text z-plain">✓ NoNewPrivileges=                                            Service processes cannot acquire new privileges
</span><span class="z-text z-plain">✓ AmbientCapabilities=                                        Service process does not receive ambient capabilities
</span><span class="z-text z-plain"># ...
</span></code></pre><p>上記のような出力を得ました。<br> 設定fileの改善の余地がありそうです。<p>また、podmanを使って新しいserviceを作る例も解説されています。<br> kubernetesのようなcontainer orchestration使うほどでもない場合はsystemdのserviceからcontainer起動するでいいかもと思ってしまいました。<h2 id=chapter-6-understanding-systemd-targets><a aria-label="Anchor link for: chapter-6-understanding-systemd-targets" class=zola-anchor href=#chapter-6-understanding-systemd-targets>Chapter 6 Understanding systemd Targets</a></h2><p>targetについて。<br> targetとはなにかというと<blockquote><p>In systemd, a target is a unit that groups together other systemd units for a particular purpose. The units that a target can group together include services, paths, mount points, sockets, and even other targets.</blockquote><p><a href="https://learning.oreilly.com/library/view/linux-service-management/9781801811644/B17491_06_Final_NM_ePub.xhtml#:-:text=In%20systemd%2C%20a,even%20other%20targets.">link</a><p>ということで、他のserviceやpathといったunitをまとめる役割を果たすのがtargetということです。<p><code>systemctl list-units -t target</code>で確認できます。<pre class="language-sh z-code" data-lang=sh><code class=language-sh data-lang=sh><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">systemctl</span></span><span class="z-meta z-function-call z-arguments z-shell"> list-units<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>t</span> target</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">UNIT</span></span><span class="z-meta z-function-call z-arguments z-shell">                      LOAD   ACTIVE SUB    DESCRIPTION</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">basic.target</span></span><span class="z-meta z-function-call z-arguments z-shell">              loaded active active Basic System</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">cryptsetup.target</span></span><span class="z-meta z-function-call z-arguments z-shell">         loaded active active Local Encrypted Volumes</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">getty.target</span></span><span class="z-meta z-function-call z-arguments z-shell">              loaded active active Login Prompts</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">local-fs-pre.target</span></span><span class="z-meta z-function-call z-arguments z-shell">       loaded active active Preparation for Local File Systems</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">local-fs.target</span></span><span class="z-meta z-function-call z-arguments z-shell">           loaded active active Local File Systems</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">machines.target</span></span><span class="z-meta z-function-call z-arguments z-shell">           loaded active active Containers</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">multi-user.target</span></span><span class="z-meta z-function-call z-arguments z-shell">         loaded active active Multi-User System</span>
</span><span class="z-source z-shell z-bash">  <span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> ...</span><span class="z-comment z-line z-number-sign z-shell">
</span></span></code></pre><p><code>strings systemd | grep '\.target'</code>を実行することでいくつかのtargetはsystemdのsourceに直接定義されていることもわかりました。<br> ただ、手元のNixOSで実行してみたところ、本文より出力されるtargetが少なかったです。<pre class="language-sh z-code" data-lang=sh><code class=language-sh data-lang=sh><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">strings</span></span><span class="z-meta z-function-call z-arguments z-shell">  /nix/store/410cjrblagp3kbzlfwn6qxxn5m663jg5-systemd-253.3/lib/systemd/systemd</span> <span class="z-keyword z-operator z-logical z-pipe z-shell">|</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">rg</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">'</span>\.target<span class="z-punctuation z-definition z-string z-end z-shell">'</span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">initrd.target</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">default.target</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">rescue.target</span></span><span class="z-meta z-function-call z-arguments z-shell"> masked</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Failed</span></span><span class="z-meta z-function-call z-arguments z-shell"> to load rescue.target</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Falling</span></span><span class="z-meta z-function-call z-arguments z-shell"> back to default.target.</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Falling</span></span><span class="z-meta z-function-call z-arguments z-shell"> back to rescue.target.</span>
</span></code></pre><p><code>man systemd.special</code>にsystemdに特別扱いされるtargetの説明もあります。<p>また、SysV initのrunlevelとsystemd targetの比較も参考になりました。<p>target間の依存関係のvisualizeには<br> <code>systemd-analyze dot default.target | dot -Tsvg out> /tmp/target.svg</code><br> が便利でした。<h2 id=chapter-7-understanding-systemd-timers><a aria-label="Anchor link for: chapter-7-understanding-systemd-timers" class=zola-anchor href=#chapter-7-understanding-systemd-timers>Chapter 7 Understanding systemd Timers</a></h2><p>systemd timerを使うことでcronのようなscheduling処理ができる。<p>NixOS上で有効なtimerを確認したところ、logrotationとtmpfileのclean処理が起動していた。<pre class="language-sh z-code" data-lang=sh><code class=language-sh data-lang=sh><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> systemctl list-units<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>t</span> timer</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">UNIT</span></span><span class="z-meta z-function-call z-arguments z-shell">                         LOAD   ACTIVE SUB     DESCRIPTION</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">logrotate.timer</span></span><span class="z-meta z-function-call z-arguments z-shell">              loaded active waiting logrotate.timer</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">systemd-tmpfiles-clean.timer</span></span><span class="z-meta z-function-call z-arguments z-shell"> loaded active waiting Daily Cleanup of Temporary Directories</span>
</span></code></pre><p>systemdでtimerを利用して処理をschedulingするには、まずtimer unitを作成してそこからservice unitを起動するという構成にするらしい。<p>ということで、logroate.timerを確認してみる。<pre class="language-ini z-code" data-lang=ini><code class=language-ini data-lang=ini><span class="z-source z-genconfig">$ systemctl cat logrotate<span class="z-keyword z-operator z-genconfig">.</span>timer
</span><span class="z-source z-genconfig">
</span><span class="z-source z-genconfig"><span class="z-meta z-comment z-genconfig"><span class="z-comment z-line z-number-sign z-genconfig"># /etc/systemd/system/logrotate.timer
</span></span></span><span class="z-source z-genconfig"><span class="z-storage z-type z-genconfig">[Unit]
</span></span><span class="z-source z-genconfig">
</span><span class="z-source z-genconfig"><span class="z-storage z-type z-genconfig">[Timer]
</span></span><span class="z-source z-genconfig"><span class="z-meta z-param z-genconfig"><span class="z-variable z-parameter z-genconfig">OnCalendar</span><span class="z-keyword z-operator z-genconfig">=</span></span>hourly
</span></code></pre><p>起動する処理が指定されていないが、<code>man systemd.timer</code>によると<blockquote><p>For each timer file, a matching unit file must exist, describing the unit to activate when the timer elapses. By default, a service by the same name as the timer (except for the suffix) is activated. Example: a timer file foo.timer activates a matching service foo.service.</blockquote><p>ということで、<code>logrotate.timer</code>は<code>logrotate.service</code>を起動するようだった。<p><code>OnCalendar=hourly</code>と指定した場合、具体的にいつ実行されるかは<code>man systemd.time</code>の<code>CALENDAR EVENTS</code>に説明があり、<code>hourly → *-*-* *:00:00</code>と解釈されるようだった。<p><code>AccuracySec=1h</code>のようにどの程度schedulingされた時間に対して精度を要求するかも指定できる。manによると消費電力を最適化するためにできるだけ大きい値を設定しておくのが望ましいらしい。<p>また、<code>Persistent=true</code>でschedulingされた期間に電源がoffだった場合、起動時に実行するかも制御できそうだった。<p><code>Nice=</code>,<code>IOSchedulingClass=</code>,<code>SchedulingPriority</code>等で、実行するserviceの優先度も指定できそうだったので、設定する際は調べておきたい。<h2 id=chapter-8-understanding-the-systemd-boot-process><a aria-label="Anchor link for: chapter-8-understanding-the-systemd-boot-process" class=zola-anchor href=#chapter-8-understanding-the-systemd-boot-process>Chapter 8 Understanding the systemd Boot Process</a></h2><p>systemdのboot時の挙動について。<br> <code>default.target</code>が起動の対象となり、その依存関係が解決されていく。 <code>default.target</code>は大抵、<code>graphical.target</code>か<code>multi-user.target</code>へのsymlinkになっている。<br> <code>man systemd.special</code>や<code>man bootup</code>にも解説がある。<p><code>man bootup</code>のこの図がわかりやすかった。　<pre class="language-text z-code" data-lang=text><code class=language-text data-lang=text><span class="z-text z-plain">                                       cryptsetup-pre.target veritysetup-pre.target                                                             |
</span><span class="z-text z-plain">           (various low-level                                v
</span><span class="z-text z-plain">            API VFS mounts:             (various cryptsetup/veritysetup devices...)
</span><span class="z-text z-plain">            mqueue, configfs,                                |    |
</span><span class="z-text z-plain">            debugfs, ...)                                    v    |
</span><span class="z-text z-plain">            |                                  cryptsetup.target  |
</span><span class="z-text z-plain">            |  (various swap                                 |    |    remote-fs-pre.target
</span><span class="z-text z-plain">            |   devices...)                                  |    |     |        |
</span><span class="z-text z-plain">            |    |                                           |    |     |        v
</span><span class="z-text z-plain">            |    v                       local-fs-pre.target |    |     |  (network file systems)
</span><span class="z-text z-plain">            |  swap.target                       |           |    v     v                 |
</span><span class="z-text z-plain">            |    |                               v           |  remote-cryptsetup.target  |
</span><span class="z-text z-plain">            |    |  (various low-level  (various mounts and  |  remote-veritysetup.target |
</span><span class="z-text z-plain">            |    |   services: udevd,    fsck services...)   |             |              |
</span><span class="z-text z-plain">            |    |   tmpfiles, random            |           |             |    remote-fs.target
</span><span class="z-text z-plain">            |    |   seed, sysctl, ...)          v           |             |              |
</span><span class="z-text z-plain">            |    |      |                 local-fs.target    |             | _____________/
</span><span class="z-text z-plain">            |    |      |                        |           |             |/
</span><span class="z-text z-plain">            \____|______|_______________   ______|___________/             |
</span><span class="z-text z-plain">                                        \ /                                |
</span><span class="z-text z-plain">                                         v                                 |
</span><span class="z-text z-plain">                                  sysinit.target                           |
</span><span class="z-text z-plain">                                         |                                 |
</span><span class="z-text z-plain">                  ______________________/|\_____________________           |
</span><span class="z-text z-plain">                 /              |        |      |               \          |
</span><span class="z-text z-plain">                 |              |        |      |               |          |
</span><span class="z-text z-plain">                 v              v        |      v               |          |
</span><span class="z-text z-plain">            (various       (various      |  (various            |          |
</span><span class="z-text z-plain">             timers...)      paths...)   |   sockets...)        |          |
</span><span class="z-text z-plain">                 |              |        |      |               |          |
</span><span class="z-text z-plain">                 v              v        |      v               |          |
</span><span class="z-text z-plain">           timers.target  paths.target   |  sockets.target      |          |
</span><span class="z-text z-plain">                 |              |        |      |               v          |
</span><span class="z-text z-plain">                 v              \_______ | _____/         rescue.service   |
</span><span class="z-text z-plain">                                        \|/                     |          |
</span><span class="z-text z-plain">                                         v                      v          |
</span><span class="z-text z-plain">                                     basic.target         rescue.target    |
</span><span class="z-text z-plain">                                         |                                 |
</span><span class="z-text z-plain">                                 ________v____________________             |
</span><span class="z-text z-plain">                                /              |              \            |
</span><span class="z-text z-plain">                                |              |              |            |
</span><span class="z-text z-plain">                                v              v              v            |
</span><span class="z-text z-plain">                            display-    (various system   (various system  |
</span><span class="z-text z-plain">                        manager.service     services        services)      |
</span><span class="z-text z-plain">                                |         required for        |            |
</span><span class="z-text z-plain">                                |        graphical UIs)       v            v
</span><span class="z-text z-plain">                                |              |            multi-user.target
</span><span class="z-text z-plain">           emergency.service    |              |              |
</span><span class="z-text z-plain">                   |            \_____________ | _____________/
</span><span class="z-text z-plain">                   v                          \|/
</span><span class="z-text z-plain">           emergency.target                    v
</span><span class="z-text z-plain">                                       graphical.target
</span></code></pre><p>ここでも<code>systemd-analyze</code>が登場する。<br> 引数をつけないと<code>systemd-analyze time</code>が実行され起動時の実行時間を出力してくれる。<pre class="language-sh z-code" data-lang=sh><code class=language-sh data-lang=sh><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> 手元のlaptop</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-keyword z-operator z-assignment z-redirection z-shell">></span> systemd-analyze
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Startup</span></span><span class="z-meta z-function-call z-arguments z-shell"> finished in 5.128s (firmware</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">+</span></span><span class="z-meta z-function-call z-arguments z-shell"> 5.824s (loader</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">+</span></span><span class="z-meta z-function-call z-arguments z-shell"> 2.590s (kernel</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">+</span></span><span class="z-meta z-function-call z-arguments z-shell"> 7.575s (userspace</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-keyword z-operator z-assignment z-shell">=</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">21.118s</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">graphical.target</span></span><span class="z-meta z-function-call z-arguments z-shell"> reached after 7.551s in userspace.</span>
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> raspi</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> systemd-analyze</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Startup</span></span><span class="z-meta z-function-call z-arguments z-shell"> finished in 5.496s (kernel</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">+</span></span><span class="z-meta z-function-call z-arguments z-shell"> 33.766s (userspace</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-keyword z-operator z-assignment z-shell">=</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">39.263s</span></span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">multi-user.target</span></span><span class="z-meta z-function-call z-arguments z-shell"> reached after 33.766s in userspace.</span>
</span></code></pre><p>さらに<code>systemd-analyze blame</code>で何に時間を要しているかもわかる。<pre class="language-sh z-code" data-lang=sh><code class=language-sh data-lang=sh><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> systemd-analyze blame</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">30.169s</span></span><span class="z-meta z-function-call z-arguments z-shell"> dhcpcd.service</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">1.646s</span></span><span class="z-meta z-function-call z-arguments z-shell"> mount-pstore.service</span>
</span><span class="z-source z-shell z-bash"> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">1.220s</span></span><span class="z-meta z-function-call z-arguments z-shell"> firewall.service</span>
</span><span class="z-source z-shell z-bash"> <span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> ...</span><span class="z-comment z-line z-number-sign z-shell">
</span></span></code></pre><p>手元のraspiの場合、dhcp関連で時間がかかっているようだった。<br> <code>systemd-analyze critical-chain</code>というのもあり、実行してみたところ以下の出力をえた。<pre class="language-sh z-code" data-lang=sh><code class=language-sh data-lang=sh><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">systemd-analyze</span></span><span class="z-meta z-function-call z-arguments z-shell"> critical-chain</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">The</span></span><span class="z-meta z-function-call z-arguments z-shell"> time when unit became active or started is printed after the <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>@<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span> character.</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">The</span></span><span class="z-meta z-function-call z-arguments z-shell"> time the unit took to start is printed after the <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>+<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span> character.</span>
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">multi-user.target</span></span><span class="z-meta z-function-call z-arguments z-shell"> @33.766s</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">└─network-online.target</span></span><span class="z-meta z-function-call z-arguments z-shell"> @33.765s</span>
</span><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">└─network.target</span></span><span class="z-meta z-function-call z-arguments z-shell"> @3.106s</span>
</span><span class="z-source z-shell z-bash">    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">└─network-pre.target</span></span><span class="z-meta z-function-call z-arguments z-shell"> @2.822s</span>
</span><span class="z-source z-shell z-bash">      <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">└─firewall.service</span></span><span class="z-meta z-function-call z-arguments z-shell"> @964ms +1.220s</span>
</span><span class="z-source z-shell z-bash">        <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">└─systemd-journald.socket</span></span><span class="z-meta z-function-call z-arguments z-shell"> @764ms</span>
</span><span class="z-source z-shell z-bash">          <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">└─system.slice</span></span><span class="z-meta z-function-call z-arguments z-shell"> @726ms</span>
</span><span class="z-source z-shell z-bash">            <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">└─-.slice</span></span><span class="z-meta z-function-call z-arguments z-shell"> @726ms</span>
</span></code></pre><p><code>blame</code>だとdhcpが遅そうだったが、そういうわけでもないのだろうか。manをもう少し読んで見方を理解したい。<p>また、systemd generatorの解説もありました。<h2 id=chapter-9-setting-system-parameters><a aria-label="Anchor link for: chapter-9-setting-system-parameters" class=zola-anchor href=#chapter-9-setting-system-parameters>Chapter 9 Setting System Parameters</a></h2><p>systemの設定にまつわる話。<br> 以下の解説があります。<ul><li>localeを制御できる<code>localectl</code><li>timezone関連の<code>timedatectl</code><li>hostname関連の<code>hostnamectl</code></ul><p>この手の話もlinux弱者の自分には非常にありがたいです。<h2 id=chapter-10-understanding-shutdown-and-reboot-commands><a aria-label="Anchor link for: chapter-10-understanding-shutdown-and-reboot-commands" class=zola-anchor href=#chapter-10-understanding-shutdown-and-reboot-commands>Chapter 10 Understanding Shutdown and Reboot Commands</a></h2><p>systemdのshutdownは<code>systemctl poweroff</code>で実行できる。<br> <code>man systemctl</code>のpoweroffの説明によるとこのcommandは<code>systemctl start poweroff.target --job-mode=replace-irreversibly --no-block</code>とほぼ同じらしい。<p>rebootは<code>systemctl reboot</code>。こちらも同様に実際にはreboot.targetの起動になっている。<p>また、<code>shutdown</code>コマンドもsystemctlへのsymlinkになっていることがわかった。ただ、<code>systemctl now</code>を実行してもshutdownが実行されるわけではないので、おそらくsystemctl側で、自身の実行commandを取得して、shutdownとして振る舞うような処理があるのではと思われる。<p>systemdのtargetの仕組みを利用して、終了時に実行したい処理を定義する例ものっている。<h2 id=chapter-11-understanding-cgroups-version-1><a aria-label="Anchor link for: chapter-11-understanding-cgroups-version-1" class=zola-anchor href=#chapter-11-understanding-cgroups-version-1>Chapter 11 Understanding cgroups Version 1</a></h2><p>systemdとcgroupについて。 cgroupの歴史についても説明してくれます。 執筆時点(2021)ではFedora, Arch, Debian, Ubuntu 21.10がcgroup v2を利用しているそうです。<p>cgroupを用いることでsystem管理者は例えば以下のことができる。<ul><li>resourceの使用をuserやprocess単位で行える<li>multi-tenantのようなシステムにおいてbillingのための正確なresourceの利用量を追跡できる<li>実行中のprocessを隔離できる<li>processを同じCPUで実行することでperformanceを向上</ul><p><code>systemd-cgls</code>でsystemで実行中のcgroupを表示できる。<h2 id=chapter-12-controlling-resource-usage-with-cgroups-version-1><a aria-label="Anchor link for: chapter-12-controlling-resource-usage-with-cgroups-version-1" class=zola-anchor href=#chapter-12-controlling-resource-usage-with-cgroups-version-1>Chapter 12 Controlling Resource Usage with cgroups Version 1</a></h2><p>本章では実際にcgroupのcontrollerを利用して、cpuやmemory割当を変えてみる例が解説されます。<h2 id=chapter-13-understanding-cgroup-version-2><a aria-label="Anchor link for: chapter-13-understanding-cgroup-version-2" class=zola-anchor href=#chapter-13-understanding-cgroup-version-2>Chapter 13 Understanding cgroup Version 2</a></h2><p>本章ではcgroup Version 2について扱います。<br> ちなみにcgroup<strong>s</strong> Version 1とcgroup Version 2は意図的な変更のようです。<br> cgroup難しい。<h2 id=chapter-14-using-journald><a aria-label="Anchor link for: chapter-14-using-journald" class=zola-anchor href=#chapter-14-using-journald>Chapter 14 Using journald</a></h2><p>本章ではjournald,journalctlの説明をしてくれます。<br> journaldとrsyslogの比較の話は勉強になりました。本書執筆時点(2021)では、journaldに完全移行したdistroはないそうで、journaldとrsyslogが並行稼働しているのが実情のようでした。<p><code>journalctl --disk-usage</code>でlogのdisk使用量みれたりするのも知らなかったので、<code>man journald.conf</code>と<code>man journalctl</code>を読まないとだめだなと思いました。<p><code>journalctl --flush</code>して、<code>journalctl --rotate --vacuum-time=5d</code>のようにしてlogをrotateされる方法等についても解説されています。 <code>journalctl</code>についてもいろいろな使い方の具体例がのっているので、一度読んだ後man読むとだいぶ使い方がわかりそうです。<p>自分はもっぱら、<code>journalctl -u opentelemetry-collector -f</code>のような感じでserviceごとのlogの見方がわかっただけで大変助かりました。<br> logがどこに出力されるのかをきにしなくていいのが良いですね。<h2 id=chapter-15-using-systemd-networkd-and-systemd-resolved><a aria-label="Anchor link for: chapter-15-using-systemd-networkd-and-systemd-resolved" class=zola-anchor href=#chapter-15-using-systemd-networkd-and-systemd-resolved>Chapter 15 Using systemd-networkd and systemd-resolved</a></h2><p>networkdとresolvedの概要について。<br> ubuntuのnetplanの説明やnetworkctl, resolvectlの使い方の説明もあります。<h2 id=chapter-16-understanding-timekeeping-with-systemd><a aria-label="Anchor link for: chapter-16-understanding-timekeeping-with-systemd" class=zola-anchor href=#chapter-16-understanding-timekeeping-with-systemd>Chapter 16 Understanding Timekeeping with systemd</a></h2><p>Network Time Protocol(NTP)について。<br> systemd-timesyncdだけでなく、ntpdやchronyについての概要の説明もあります。<p>NixOSだと<code>/etc/systemd/timesyncd.conf</code>は以下のように設定されていました。<pre class="language-ini z-code" data-lang=ini><code class=language-ini data-lang=ini><span class="z-source z-genconfig"><span class="z-storage z-type z-genconfig">[Time]
</span></span><span class="z-source z-genconfig"><span class="z-support z-constant z-genconfig">NTP</span><span class="z-keyword z-operator z-genconfig">=</span><span class="z-constant z-numeric z-genconfig">0</span><span class="z-keyword z-operator z-genconfig">.</span>nixos<span class="z-keyword z-operator z-genconfig">.</span>pool<span class="z-keyword z-operator z-genconfig">.</span>ntp<span class="z-keyword z-operator z-genconfig">.</span>org <span class="z-constant z-numeric z-genconfig">1</span><span class="z-keyword z-operator z-genconfig">.</span>nixos<span class="z-keyword z-operator z-genconfig">.</span>pool<span class="z-keyword z-operator z-genconfig">.</span>ntp<span class="z-keyword z-operator z-genconfig">.</span>org <span class="z-constant z-numeric z-genconfig">2</span><span class="z-keyword z-operator z-genconfig">.</span>nixos<span class="z-keyword z-operator z-genconfig">.</span>pool<span class="z-keyword z-operator z-genconfig">.</span>ntp<span class="z-keyword z-operator z-genconfig">.</span>org <span class="z-constant z-numeric z-genconfig">3</span><span class="z-keyword z-operator z-genconfig">.</span>nixos<span class="z-keyword z-operator z-genconfig">.</span>pool<span class="z-keyword z-operator z-genconfig">.</span>ntp<span class="z-keyword z-operator z-genconfig">.</span>org
</span></code></pre><h2 id=chapter-17-understanding-systemd-and-bootloaders><a aria-label="Anchor link for: chapter-17-understanding-systemd-and-bootloaders" class=zola-anchor href=#chapter-17-understanding-systemd-and-bootloaders>Chapter 17 Understanding systemd and Bootloaders</a></h2><p>systemd-bootについて。systemd-boot<strong>d</strong>ではない。<br> systemd-bootの話に入る前にGRUB2についての解説もありありがたい。<h2 id=chapter-18-understanding-systemd-logind><a aria-label="Anchor link for: chapter-18-understanding-systemd-logind" class=zola-anchor href=#chapter-18-understanding-systemd-logind>Chapter 18 Understanding systemd-logind</a></h2><p>systemdがloginまで管理するのはcgroupと関連するからという話。<br> loginctlやpolkitの説明もあります。<h2 id=matome><a aria-label="Anchor link for: matome" class=zola-anchor href=#matome>まとめ</a></h2><p>簡単にですが感想を書いてみました。<br> 当初はRaspberry PiでNixOSを動かす際に、<a href="https://search.nixos.org/options?channel=23.05&from=0&size=50&sort=relevance&type=packages&query=systemd.services">systemd.services</a>の設定を理解したいと思い読んだのですが、services以外にもいろいろな解説があったので非常に参考になりました。<p>systemctlやjournalctlだけでなく、systemd-analyze,localectl,timedatactl,loginctl,networkctl等も使えるようになっていきたいです。<br> 自分の理解が至らない箇所も多かったですが、ひとまずsystemd関連わからないことがあればまずはman読んでみようという心持ちになれたのがよかったです。<p><del>ちなみに筆者は読者の心を読む能力をもっているので注意してください。</del></div></article></main><footer class=blog-footer><p>© 2025 <a href=https://blog.ymgyt.io> ymgyt </a> | Made with <a href=https://www.getzola.org rel=noopener target=_blank>Zola</a> | <a href=https://github.com/ymgyt/blog>Repository</a> | <a href=https://blog.ymgyt.io/atom.xml target=_blank title=rss> <svg viewbox="0 0 24 24" class=icon fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx=5 cy=19 r=1></circle></svg> </a></footer></div></div>