<!doctype html><html lang=ja><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1" name=viewport><link href=https://blog.ymgyt.io/favicon.ico rel=icon sizes=any><link href=https://blog.ymgyt.io/icon.svg rel=icon type=image/svg+xml><link href=https://blog.ymgyt.io/apple-touch-icon.png rel=apple-touch-icon><link href=https://blog.ymgyt.io/manifest.webmanifest rel=manifest><link href=https://blog.ymgyt.io/style.css rel=stylesheet><link href=https://blog.ymgyt.io/atom.xml rel=alternate title=Atom type=application/atom+xml><script src="https://www.googletagmanager.com/gtag/js?id=G-GTB0KMLN90" async></script><script>window.dataLayer = window.dataLayer || [];
	function gtag() {dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-GTB0KMLN90');</script><title>ğŸ‡ RabbitMQ Tutorialsã‚’Rustã§ã‚„ã£ã¦ã¿ã‚‹ | Happy developing</title><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><body><div class=world><div class=content-container><header class=blog-header-container><div class=blog-logo><a href=https://blog.ymgyt.io>Happy developing</a></div><div class=blog-nav><nav><ul><li><a href=https://blog.ymgyt.io/entry/>Entries</a><li><a href=https://blog.ymgyt.io/tags/>Tags</a><li><a href=https://blog.ymgyt.io/about/>About</a><li><a href=https://github.com/ymgyt> <img alt=Github class=icon src=https://blog.ymgyt.io/images/icon/github.svg> </a><li><a href="https://twitter.com/YAmaguchixt "> <img alt=Twitter class=icon src=https://blog.ymgyt.io/images/icon/twitter.svg> </a></ul></nav></div></header><main class=blog-main><article><header class=entry-header><h1 class=entry-title>ğŸ‡ RabbitMQ Tutorialsã‚’Rustã§ã‚„ã£ã¦ã¿ã‚‹</h1><div class=entry-meta><p class=entry-meta-item>ğŸ—“ 2022-08-12<p class=entry-meta-item>ğŸ· <span class=tag><a href=https://blog.ymgyt.io/tags/rust/>rust</a></span></div></header><aside class=entry-toc><nav><ul class=entry-toc-toplevel-list><li><a href=https://blog.ymgyt.io/entry/rabbitmq_tutorials_with_rust/#zhun-bei>æº–å‚™</a> <ul><li><a href=https://blog.ymgyt.io/entry/rabbitmq_tutorials_with_rust/#docker-compose-yaml>docker-compose.yaml</a><li><a href=https://blog.ymgyt.io/entry/rabbitmq_tutorials_with_rust/#cargo-toml>Cargo.toml</a><li><a href=https://blog.ymgyt.io/entry/rabbitmq_tutorials_with_rust/#jie-sok-chu-li>æ¥ç¶šå‡¦ç†</a></ul><li><a href=https://blog.ymgyt.io/entry/rabbitmq_tutorials_with_rust/#hello-world>"Hello World!"</a><li><a href=https://blog.ymgyt.io/entry/rabbitmq_tutorials_with_rust/#work-queues>Work queues</a><li><a href=https://blog.ymgyt.io/entry/rabbitmq_tutorials_with_rust/#publish-subscribe>Publish/Subscribe</a><li><a href=https://blog.ymgyt.io/entry/rabbitmq_tutorials_with_rust/#routing>Routing</a><li><a href=https://blog.ymgyt.io/entry/rabbitmq_tutorials_with_rust/#topics>Topics</a><li><a href=https://blog.ymgyt.io/entry/rabbitmq_tutorials_with_rust/#rpc>RPC</a><li><a href=https://blog.ymgyt.io/entry/rabbitmq_tutorials_with_rust/#publisher-confirms>Publisher Confirms</a><li><a href=https://blog.ymgyt.io/entry/rabbitmq_tutorials_with_rust/#matome>ã¾ã¨ã‚</a></ul></nav></aside><div class=entry-content><p>æœ¬è¨˜äº‹ã§ã¯<a href=https://www.rabbitmq.com/getstarted.html rel=external>RabbitMQ Tutorials</a>ã‚’Rustã§ã‚„ã£ã¦ã„ãã¾ã™ã€‚ RabbitMQã¯<a href=https://www.rabbitmq.com/resources/specs/amqp0-9-1.pdf rel=external>AMQP 0-9-1</a>ã¨ã„ã†ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã®å®Ÿè£…ã¨ã„ã†ä½ç½®ã¥ã‘ãªã®ã§ã€ç™»å ´ã™ã‚‹ã‚³ãƒ³ã‚»ãƒ—ãƒˆã«ã¤ã„ã¦ã¯AMQPã«åŸºã¥ã„ã¦ç†è§£ã—ã¦ã„ãã¾ã™ã€‚(ä»¥é™AMQPã¯AMQP 0-9-1ã‚’å‰æã«ã—ã¾ã™) Tutorialsã¯ä»¥ä¸‹ã®7ã¤ã‹ã‚‰æ§‹æˆã•ã‚Œã¦ã„ã‚‹ã®ã§é †ç•ªã«ã¿ã¦ã„ãã¾ã™ã€‚<ol><li><a href=https://www.rabbitmq.com/tutorials/tutorial-one-python.html rel=external>"Hello World!"</a><li><a href=https://www.rabbitmq.com/tutorials/tutorial-two-python.html rel=external>Work queues</a><li><a href=https://www.rabbitmq.com/tutorials/tutorial-three-python.html rel=external>Publish/Subscribe</a><li><a href=https://www.rabbitmq.com/tutorials/tutorial-four-python.html rel=external>Routing</a><li><a href=https://www.rabbitmq.com/tutorials/tutorial-five-python.html rel=external>Topics</a><li><a href=https://www.rabbitmq.com/tutorials/tutorial-six-python.html rel=external>RPC</a><li><a href=https://www.rabbitmq.com/tutorials/tutorial-seven-java.html rel=external>Publisher Confirms</a></ol><h2 id=zhun-bei><a aria-label="Anchor link for: zhun-bei" class=zola-anchor href=#zhun-bei>æº–å‚™</a></h2><p>Tutorialã«å…¥ã‚‹å‰ã«RabbitMQã‚’localã«ç«‹ã¡ä¸Šã’ã¦æ¥ç¶šã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ãã¾ã™ã€‚<h3 id=docker-compose-yaml><a aria-label="Anchor link for: docker-compose-yaml" class=zola-anchor href=#docker-compose-yaml>docker-compose.yaml</a></h3><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=yaml><span class=giallo-l><span style=color:#8fbcbb>version</span><span style=color:#eceff4>: '</span><span style=color:#a3be8c>3</span><span style=color:#eceff4>'</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>services</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  rabbitmq</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    image</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> rabbitmq:3.9.13-management-alpine</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    ports</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#eceff4>    - "</span><span style=color:#a3be8c>5672:5672</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#eceff4>    - "</span><span style=color:#a3be8c>15672:15672</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    environment</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      RABBITMQ_DEFAULT_USER</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> guest</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      RABBITMQ_DEFAULT_PASS</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> guest</span></span></code></pre><p><code>docker compose up [-d]</code>ã§èµ·å‹•ã§ããŸã‚‰OKã§ã™ã€‚<br> <code>5672</code>ã¯ApplicationãŒæ¥ç¶šã—ã«ã„ãportã§ã™ã€‚AMQP 4.1ã«<code>5672</code>ã‚’åˆ©ç”¨ã™ã‚‹ã¨å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚<br> <code>15672</code>ã¯RabbitMQã®WebUIã§ã™ã€‚<code>localhost:15672</code>ã«ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ç¢ºèªã§ãã¾ã™ã€‚<br> <code>environment.RABBITMQ_DEFAULT_{USER,PASS}</code>ã¯ã“ã®ã‚ã¨ã®æ¥ç¶šæ™‚ã«åˆ©ç”¨ã—ã¾ã™ã€‚<h3 id=cargo-toml><a aria-label="Anchor link for: cargo-toml" class=zola-anchor href=#cargo-toml><code>Cargo.toml</code></a></h3><p>åˆ©ç”¨ã™ã‚‹crateã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=toml><span class=giallo-l><span style=color:#eceff4>[</span><span>dependencies</span><span style=color:#eceff4>]</span></span>
<span class=giallo-l><span>anyhow</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>1</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span>deadpool</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>=0.8.0</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span>deadpool-lapin</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>=0.8.0</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span>futures</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>0.3.21</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span>tokio</span><span style=color:#eceff4> = {</span><span> version</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>1.17.0</span><span style=color:#eceff4>",</span><span> features</span><span style=color:#eceff4> = ["</span><span style=color:#a3be8c>full</span><span style=color:#eceff4>"] }</span></span>
<span class=giallo-l><span>tracing</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>0.1.35</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#eceff4>[</span><span>dev-dependencies</span><span style=color:#eceff4>]</span></span>
<span class=giallo-l><span>tracing-init</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>0.1.0</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span>async-trait</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>0.1.56</span><span style=color:#eceff4>"</span></span></code></pre><p>async runtimeã¯tokioã‚’åˆ©ç”¨ã—ã¾ã™ã€‚<br> RabbitMQã®clientã¨ã—ã¦ã¯lapinã‚’deadpoolã‚ˆã†ã«wrapã—ãŸdeadpool-lapinã‚’åˆ©ç”¨ã—ã¾ã™ã€‚<br> deadpoolã«é–¢ã—ã¦ã¯<a href=https://blog.ymgyt.io/entry/deadpool rel=external>ä»¥å‰ã®è¨˜äº‹</a>ã§ä½¿ã„æ–¹ã‚’èª¿ã¹ãŸã®ã§ã‚ˆã‹ã£ãŸã‚‰èª­ã‚“ã§ã¿ã¦ãã ã•ã„ã€‚<h3 id=jie-sok-chu-li><a aria-label="Anchor link for: jie-sok-chu-li" class=zola-anchor href=#jie-sok-chu-li>æ¥ç¶šå‡¦ç†</a></h3><p>Clientã‹ã‚‰RabbitMQ Serverã¸ã®æ¥ç¶šå‡¦ç†ã«ã¤ã„ã¦ã€‚Publisher/Consumerã§å…±é€šã§ã™ã€‚<p><code>lib.rs</code><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> deadpool</span><span style=color:#81a1c1>::</span><span>managed</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>PoolConfig</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Timeouts</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> deadpool_lapin</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span>lapin</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Channel</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Config</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>pub fn</span><span style=color:#88c0d0> config</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Config</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> config</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Config</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>        // vhostã¯uri encodeã•ã‚Œã‚‹ã®ã§%2f => "/"</span></span>
<span class=giallo-l><span>        url</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>String</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>amqp://guest:guest@localhost:5672/%2f</span><span style=color:#eceff4>")),</span></span>
<span class=giallo-l><span>        pool</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>PoolConfig</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            max_size</span><span style=color:#81a1c1>:</span><span style=color:#b48ead> 100</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            runtime</span><span style=color:#81a1c1>:</span><span> deadpool</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Runtime</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Tokio1</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            timeouts</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Timeouts</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>        }),</span></span>
<span class=giallo-l><span style=color:#81a1c1>        ..</span><span style=color:#8fbcbb>Default</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>    };</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>    config</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>pub async fn</span><span style=color:#88c0d0> channel</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span> anyhow</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Channel</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> pool</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> config</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>create_pool</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> connection</span><span style=color:#81a1c1> =</span><span> pool</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>get</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> channel</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Channel</span><span style=color:#81a1c1> =</span><span> connection</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>create_channel</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>    Ok</span><span style=color:#eceff4>(</span><span>channel</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã¾ãšRabbitMQã¸ã®Connection Poolã‚’ä½œã‚‹ãŸã‚ã«<code>deapool_lapin::Config</code>ã‚’ä½œã‚Šã¾ã™ã€‚ RabbitMQã¸ã®æ¥ç¶šæƒ…å ±ã¨Connection Poolã«é–¢ã™ã‚‹è¨­å®šã‚’æ¸¡ã™ã“ã¨ãŒã§ãã‚‹ã®ã§é †ç•ªã«ã¿ã¦ã„ãã¾ã™ã€‚<br> ã¾ãšã€ <code>url: Some(String::from("amqp://guest:guest@localhost:5672/%2f"))</code>ã®ã‚ˆã†ã«æ¥ç¶šå…ˆã®Serverã®æƒ…å ±ã‚’æ¸¡ã—ã¾ã™ã€‚<br> formatã¯<a href=https://www.rabbitmq.com/uri-spec.html rel=external>RabbitMQ URI Specification</a>ã«ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>amqp_URI</span><span style=color:#a3be8c>       =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>amqp://</span><span style=color:#eceff4>"</span><span style=color:#a3be8c> amqp_authority</span><span> [</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>/</span><span style=color:#eceff4>"</span><span style=color:#a3be8c> vhost ]</span><span> [</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>?</span><span style=color:#eceff4>"</span><span style=color:#a3be8c> query ]</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>amqp_authority</span><span style=color:#a3be8c> =</span><span> [</span><span style=color:#a3be8c> amqp_userinfo</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>@</span><span style=color:#eceff4>"</span><span style=color:#a3be8c> ] host</span><span> [</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>:</span><span style=color:#eceff4>"</span><span style=color:#a3be8c> port ]</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>amqp_userinfo</span><span style=color:#a3be8c>  = username</span><span> [</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>:</span><span style=color:#eceff4>"</span><span style=color:#a3be8c> password ]</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>username</span><span style=color:#a3be8c>       =</span><span style=color:#81a1c1> *</span><span style=color:#eceff4>(</span><span style=color:#88c0d0> unreserved</span><span style=color:#a3be8c> / pct-encoded / sub-delims</span><span style=color:#eceff4> )</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>password</span><span style=color:#a3be8c>       =</span><span style=color:#81a1c1> *</span><span style=color:#eceff4>(</span><span style=color:#88c0d0> unreserved</span><span style=color:#a3be8c> / pct-encoded / sub-delims</span><span style=color:#eceff4> )</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>vhost</span><span style=color:#a3be8c>          = segment</span></span></code></pre><p>ã–ã£ãã‚Šç†è§£ã™ã‚‹ã¨<code>amqp://&lt;user>:&lt;pass>@&lt;host>:&lt;port>/&lt;vhost></code>ã®ã‚ˆã†ãªformatã§ã™ã€‚<br> user,passã¯docker-compose.yamlã§å®šç¾©ã—ãŸ<code>environment.RABBITMQ_DEFAULT_{USER,PASS}</code>ã§host,portã¯æ¥ç¶šå…ˆã®nodeã¨TCP portã ã¨ã‚ã‹ã‚‹ã®ã§ã™ãŒã€<code>vhost</code>ãŒèãæ…£ã‚Œã¾ã›ã‚“ã€‚<h4 id=vhost><a aria-label="Anchor link for: vhost" class=zola-anchor href=#vhost><code>vhost</code></a></h4><p><code>vhost</code>ã¯kubernetesã§ã„ã†ã¨ã“ã‚ã®namespaceã«ã‚ãŸã‚‹æ¦‚å¿µã ã¨ç†è§£ã—ã¦ã„ã¾ã™ã€‚<p>AMQP 0-9-1 3.1.2 Virtual Hostsã«ã¯<blockquote><p>A virtual host comprises its own name space, a set of exchanges, message queues, and all associated objects. Each connection MUST BE associated with a single virtual host.</blockquote><p>ã¨ã‚ã‚Šã¾ã™ã€‚<br> ä¸Šã®ä¾‹ã§ã¯<code>localhost:5672/%2f</code>ã¨<code>%2f</code>ã‚’æŒ‡å®šã—ã¦ã„ã‚‹ã®ã§ã™ãŒã“ã“ã«ã¯URL encodeã•ã‚ŒãŸå€¤ã‚’æ¸¡ã™ã“ã¨ã«ãªã£ã¦ãŠã‚Šã€<code>%2f</code>ã¯<code>/</code>ã‚’è¡¨ã—ã¦ã„ã¾ã™ã€‚RabbitMQã®<a href=https://www.rabbitmq.com/access-control.html#default-state rel=external>Default Virtual Host and User</a>ã§ã¯<code>/</code>ãŒserverã®èµ·å‹•æ™‚ã«ä½œã‚‰ã‚Œã‚‹ã¨ã‚ã‚Šã¾ã™ã€‚<h4 id=pool-config><a aria-label="Anchor link for: pool-config" class=zola-anchor href=#pool-config>Pool Config</a></h4><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span>pool</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>PoolConfig</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    max_size</span><span style=color:#81a1c1>:</span><span style=color:#b48ead> 100</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    runtime</span><span style=color:#81a1c1>:</span><span> deadpool</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Runtime</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Tokio1</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    timeouts</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Timeouts</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>}),</span></span></code></pre><p>lapinã®ConnectionPoolã«é–¢ã™ã‚‹è¨­å®šã«ã¤ã„ã¦ã¯ã€æœ€å¤§ã§ä¿æŒã™ã‚‹Connectionæ•°ã€runtime(tokio or async-std),å„ç¨®operationã®timeoutã‚’æŒ‡å®šã—ã¾ã™ã€‚<code>Timeouts::default()</code>ã ã¨timeoutã‚’æŒ‡å®šã—ãªã„ã“ã¨ã«ãªã‚‹ã®ã§ã€productionæ™‚ã¯å¿…ãšæŒ‡å®šã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚<h4 id=channel><a aria-label="Anchor link for: channel" class=zola-anchor href=#channel>Channel</a></h4><p>RabbitMQ Serverã¸ã®å„ç¨®operationã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ã€<code>Channel</code>ã‚’å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>pub async fn</span><span style=color:#88c0d0> channel</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span> anyhow</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Channel</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> pool</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> config</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>create_pool</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> connection</span><span style=color:#81a1c1> =</span><span> pool</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>get</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> channel</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Channel</span><span style=color:#81a1c1> =</span><span> connection</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>create_channel</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>    Ok</span><span style=color:#eceff4>(</span><span>channel</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã®ã‚ˆã†ã«ã€ConnectionPoolConfig -> ConnectionPool -> Connectionå–å¾— -> Channelä½œæˆã¨é€²ã¿ã¾ã™ã€‚ã€€ Channelã¯TCP Connectionã‚’å…±æœ‰ã™ã‚‹ä»®æƒ³çš„ãªConnectionã§ã™ã€‚å®Ÿæ…‹ã¨ã—ã¦ã¯AMQP protocolã§è¦å®šã•ã‚Œã¦ã„ã‚‹Data Frameã«channelIDã‚’æŒ‡å®šã™ã‚‹ç®‡æ‰€ãŒã‚ã‚Šã€ã‚ãŸã‹ã‚‚è¤‡æ•°ã®æ¥ç¶šãŒåŒæ™‚ã«æ©Ÿèƒ½ã—ã¦ã„ã‚‹ã‹ã®ã‚ˆã†ã«æŒ¯ã‚‹èˆã„ã¾ã™ã€‚<p>ChannelãŒç„¡äº‹å–å¾—ã§ãã‚Œã°æº–å‚™å®Œäº†ã§ã™ã€‚ä»¥é™ã®å„tutorialã§ã¯ã“ã®channelå–å¾—ã‹ã‚‰å§‹ã‚ã¾ã™ã€‚<h2 id=hello-world><a aria-label="Anchor link for: hello-world" class=zola-anchor href=#hello-world><code>"Hello World!"</code></a></h2><figure><div class=fig-images-row><img , alt src=images/rabbitmq_hello_world.png></div><figcaption>Hello World!</figcaption></figure><p>ã¾ãšã¯Hello Worldã‹ã‚‰ã€‚Producerã‹ã‚‰1 messageã‚’publishã—ã¦consumerãŒconsumeã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[tokio::main]</span></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span> anyhow</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> channel</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> channel</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> _queue</span><span style=color:#81a1c1> =</span><span> channel</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>queue_declare</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>            "</span><span style=color:#a3be8c>hello</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span>            QueueDeclareOptions</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>            FieldTable</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>        )</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã¾ãšã€publisherã‹ã‚‰ã€‚channelã‚’ä½œæˆå¾Œã«æœ€åˆã«è¡Œã†ã®ã¯ã€<code>queue_declare</code>ã§ã™ã€‚<br> <code>queue_declare</code>ã¯æŒ‡å®šã•ã‚ŒãŸqueueãŒç„¡ã‘ã‚Œã°ä½œæˆã€å­˜åœ¨ã—ã¦ã‹ã¤æŒ‡å®šã•ã‚ŒãŸè¨­å®šã¨ä¸€è‡´ã—ã¦ã„ã‚Œã°ã€ãªã«ã‚‚ã—ãªã„ã¨ã„ã†æŒ™å‹•ã«ãªã‚Šã¾ã™ã€‚<br> ã“ã“ã§ã¯ã€<code>hello</code>ã¨ã„ã†queueãŒä½œæˆã•ã‚Œã¾ã™ã€‚<p>æ¬¡ã«consumerã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> consumer</span><span style=color:#eceff4>(</span><span>channel</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Channel</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span> anyhow</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> consumer</span><span style=color:#81a1c1> =</span><span> channel</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>basic_consume</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>            "</span><span style=color:#a3be8c>hello</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>            "",</span></span>
<span class=giallo-l><span>            BasicConsumeOptions</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>            FieldTable</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>        )</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    if let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>delivery</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> consumer</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>next</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if let</span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>((</span><span>_channel</span><span style=color:#eceff4>,</span><span> delivery</span><span style=color:#eceff4>))</span><span style=color:#81a1c1> =</span><span> delivery</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let</span><span> data</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> String</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_utf8_lossy</span><span style=color:#eceff4>(</span><span>delivery</span><span style=color:#81a1c1>.</span><span>data</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_slice</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>            tracing</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0;font-weight:700>info!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>data</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>            delivery</span></span>
<span class=giallo-l><span style=color:#81a1c1>                .</span><span style=color:#88c0d0>ack</span><span style=color:#eceff4>(</span><span>BasicAckOptions</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>())</span></span>
<span class=giallo-l><span style=color:#81a1c1>                .await</span></span>
<span class=giallo-l><span style=color:#81a1c1>                .</span><span style=color:#88c0d0>expect</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>basic_ack</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>    Ok</span><span style=color:#eceff4>(())</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>Queueã‹ã‚‰messageã‚’å–å¾—ã™ã‚‹ã«ã¯ã€<code>basic_consume</code>ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚å¯¾è±¡ã®queueã¯å…ˆã»ã©å®£è¨€ã—ãŸ<code>hello</code>ã‚’æŒ‡å®šã—ã¾ã™ã€‚<br> <code>delivery.ack(BasicAckOptions::default())</code>ã‚’å®Ÿè¡Œã™ã‚‹ã¨consumerã‹ã‚‰RabbitMQ serverã«messageã®å‡¦ç†ãŒæˆåŠŸã—ãŸã“ã¨ãŒä¼ã‚ã‚Šqueueã‹ã‚‰messageãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚<br> ã“ã®å‡¦ç†ã‚’ã„ã‚Œãªãã¦ã‚‚å‹•ãã®ã§ã™ãŒèµ·å‹•ã™ã‚‹ãŸã³ã«messageãŒå¢—ãˆã¦ã„ã£ã¦ã—ã¾ã„ã¾ã™ã€‚<p>consumerã‚’èµ·å‹•ã—ãŸã‚‰messageã®publishã‚’è¡Œã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>    let</span><span> _publish_confirm</span><span style=color:#81a1c1> =</span><span> channel</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>basic_publish</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>            "",</span></span>
<span class=giallo-l><span style=color:#eceff4>            "</span><span style=color:#a3be8c>hello</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span>            BasicPublishOptions</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>            Vec</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Hello World!</span><span style=color:#eceff4>"),</span></span>
<span class=giallo-l><span>            BasicProperties</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>        )</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .await?</span><span style=color:#eceff4>;</span></span></code></pre><p>messageã®publishã¯<code>basic_publish</code>ã§è¡Œã„ã¾ã™ã€‚<br> ç¬¬ä¸€å¼•æ•°ã«ã¯å¯¾è±¡ã®exchange,ç¬¬äºŒå¼•æ•°ã«ã¯routing_keyã‚’æŒ‡å®šã—ã¾ã™ã€‚<br> ã“ã“ã§exchangeãŒã§ã¦ããŸã®ã§ã€exchangeã«ã¤ã„ã¦è§£èª¬ã—ã¾ã™ã€‚<p>AMQP 3.1.3ã«ã¯<blockquote><p>An exchange is a message routing agent within a virtual host. An exchange instance (which we commonly call "an exchange") accepts messages and routing information - principally a routing key - and either passes the messages to message queues, or to internal services.</blockquote><p>ã¨ã‚ã‚Šã¾ã™ã€‚RabbitMQã§ã¯publisherã¯messageã‚’publishã™ã‚‹éš›ã«queueã§ã¯ãªãã“ã®exchangeã‚’å¯¾è±¡ã«messageã‚’publishã—ã¾ã™ã€‚<br> exchangeã‚’å¯¾è±¡ã«ã™ã‚‹ã¨ã„ã£ã¦ãŠããªãŒã‚‰ä¸Šã®ä¾‹ã§ã¯ç¬¬ä¸€å¼•æ•°ã§æŒ‡å®šã—ã¦ã„ã‚‹exchangeã«ç©ºæ–‡å­—(<code>""</code>)ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚ ã“ã“ãŒå°‘ã€…æš—é»™çš„ãªã¨ã“ã‚ãªã®ã§ã™ãŒã€exchangeã«ç©ºæ–‡å­—ã‚’æŒ‡å®šã™ã‚‹ã¨ãã‚Œã¯default exchangeã‚’æŒ‡ã™ã“ã¨ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚ ã•ã‚‰ã«ã“ã®default exchangeã¯direct exchangeã¨ã„ã†ç¨®é¡ã®exchangeã§ã€publishæ™‚ã®routing_keyã‚’å‚ç…§ã—ã¦ãã‚Œã¨åŒåã®queueã«messageã‚’routingã—ã¾ã™ã€‚ ãªã®ã§çµæœçš„ã«ã¯publisherãŒexchangeã‚’æŒ‡å®šã›ãšã«ã€routing_keyã«queueã‚’æŒ‡å®šã™ã‚‹ã¨å¯¾è±¡ã®queueã«messageã‚’publishã§ãã‚‹ã‚ã‘ã§ã™ã€‚<br> exchangeã¨ã„ã†layerã‚’ç”¨æ„ã—ã¦ã€publisherã¨queueã‚’ç›´æ¥çµåˆã•ã›ãªã„ã‚ˆã†ã«ã—ã¤ã¤ã‚‚ã€é€éçš„ã«queueã«publishã§ãã‚‹ã‚ˆã†ã«ã‚‚ãªã£ã¦ã„ã¾ã™ã€‚<p>ã“ã®æŒ™å‹•ã¯AMQP 3.1.3.1ã§ä»¥ä¸‹ã®ã‚ˆã†ã«æŒ‡å®šã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã§ã™ã€‚<blockquote><p>The direct exchange type works as follows:</blockquote><ol><li>A message queue binds to the exchange using a routing key, K.<li>A publisher sends the exchange a message with the routing key R.<li>The message is passed to the message queue if K = R. The server MUST implement the direct exchange type and MUST pre-declare within each virtual host at least two direct exchanges: one named amq.direct, and one with no public name that serves as the default exchange for Publish methods</ol><p>ã¾ã¨ã‚ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚<br> <code>examples/tutorial_helo_worlds.rs</code><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> deadpool_lapin</span><span style=color:#81a1c1>::</span><span>lapin</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    BasicProperties</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Channel</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    options</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        BasicAckOptions</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> BasicConsumeOptions</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> BasicPublishOptions</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        QueueDeclareOptions</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    },</span><span> types</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>FieldTable</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>};</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> futures</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>StreamExt</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> rabbitmq_handson</span><span style=color:#81a1c1>::</span><span>channel</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[tokio::main]</span></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span> anyhow</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span>    tracing_init</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>init</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> channel</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> channel</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> _queue</span><span style=color:#81a1c1> =</span><span> channel</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>queue_declare</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>            "</span><span style=color:#a3be8c>hello</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span>            QueueDeclareOptions</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>            FieldTable</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>        )</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    // Spawn consumer task.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> consumer_handle</span><span style=color:#81a1c1> =</span><span> tokio</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>spawn</span><span style=color:#eceff4>({</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> channel</span><span style=color:#81a1c1> =</span><span> channel</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>        async move</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            if let</span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> consumer</span><span style=color:#eceff4>(</span><span>channel</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                tracing</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0;font-weight:700>error!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>err:?</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    });</span></span>
<span class=giallo-l></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> _publish_confirm</span><span style=color:#81a1c1> =</span><span> channel</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>basic_publish</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>            "",</span></span>
<span class=giallo-l><span style=color:#eceff4>            "</span><span style=color:#a3be8c>hello</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span>            BasicPublishOptions</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>            Vec</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Hello World!</span><span style=color:#eceff4>"),</span></span>
<span class=giallo-l><span>            BasicProperties</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>        )</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    // Wait forever</span></span>
<span class=giallo-l><span>    consumer_handle</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>    Ok</span><span style=color:#eceff4>(())</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> consumer</span><span style=color:#eceff4>(</span><span>channel</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Channel</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span> anyhow</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> consumer</span><span style=color:#81a1c1> =</span><span> channel</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>basic_consume</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>            "</span><span style=color:#a3be8c>hello</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>            "",</span></span>
<span class=giallo-l><span>            BasicConsumeOptions</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>            FieldTable</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>        )</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    if let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>delivery</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> consumer</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>next</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if let</span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>((</span><span>_channel</span><span style=color:#eceff4>,</span><span> delivery</span><span style=color:#eceff4>))</span><span style=color:#81a1c1> =</span><span> delivery</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let</span><span> data</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> String</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_utf8_lossy</span><span style=color:#eceff4>(</span><span>delivery</span><span style=color:#81a1c1>.</span><span>data</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_slice</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>            tracing</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0;font-weight:700>info!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>data</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>            delivery</span></span>
<span class=giallo-l><span style=color:#81a1c1>                .</span><span style=color:#88c0d0>ack</span><span style=color:#eceff4>(</span><span>BasicAckOptions</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>())</span></span>
<span class=giallo-l><span style=color:#81a1c1>                .await</span></span>
<span class=giallo-l><span style=color:#81a1c1>                .</span><span style=color:#88c0d0>expect</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>basic_ack</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>    Ok</span><span style=color:#eceff4>(())</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>å®Ÿè¡Œã—ã¦ã¿ã‚‹ã¨ç„¡äº‹consumeã§ãã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>â¯</span><span style=color:#a3be8c> cargo run --quiet --example tutorial_hello_world</span></span>
<span class=giallo-l><span style=color:#88c0d0>2022-08-10T10:52:58.05527Z</span><span style=color:#a3be8c>  INFO examples/tutorial_hello_world.rs:69: Hello World!</span></span></code></pre><h2 id=work-queues><a aria-label="Anchor link for: work-queues" class=zola-anchor href=#work-queues><code>Work queues</code></a></h2><figure><div class=fig-images-row><img , alt src=images/rabbitmq_work_queues.png></div><figcaption>Work queues</figcaption></figure><p>æ¬¡ã¯ã„ã‚ã‚†ã‚‹Single Producer Multi Consumerã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å®Ÿè£…ã—ã¦ã¿ã¾ã™ã€‚<br> åŸºæœ¬çš„ã«ã¯å…ˆã»ã©ã®ä¾‹ã®consumerã‚’äºŒã¤èµ·å‹•ã™ã‚‹ã ã‘ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> deadpool_lapin</span><span style=color:#81a1c1>::</span><span>lapin</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    BasicProperties</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Channel</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    options</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        BasicAckOptions</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> BasicConsumeOptions</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> BasicPublishOptions</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> BasicQosOptions</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        QueueDeclareOptions</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    },</span><span> types</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>FieldTable</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>};</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> futures</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>StreamExt</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> rabbitmq_handson</span><span style=color:#81a1c1>::</span><span>channel</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[tokio::main]</span></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span> anyhow</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> channel</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> channel</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> _queue</span><span style=color:#81a1c1> =</span><span> channel</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>queue_declare</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>            "</span><span style=color:#a3be8c>task_queue</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            QueueDeclareOptions</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                durable</span><span style=color:#81a1c1>: true</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>                ..</span><span>Default</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>            },</span></span>
<span class=giallo-l><span>            FieldTable</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>        )</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    // Spawn consumer tasks.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> consumer1_handle</span><span style=color:#81a1c1> =</span><span> tokio</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>spawn</span><span style=color:#eceff4>({</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> channel</span><span style=color:#81a1c1> =</span><span> channel</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>        async move</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            if let</span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> consumer</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>worker1</span><span style=color:#eceff4>",</span><span> channel</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>                eprintln!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>err:?</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    });</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> consumer2_handle</span><span style=color:#81a1c1> =</span><span> tokio</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>spawn</span><span style=color:#eceff4>({</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> channel</span><span style=color:#81a1c1> =</span><span> channel</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>        async move</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            if let</span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> consumer</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>worker2</span><span style=color:#eceff4>",</span><span> channel</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>                eprintln!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>err:?</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    });</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    for</span><span> i</span><span style=color:#81a1c1> in</span><span style=color:#b48ead> 0</span><span style=color:#81a1c1>..</span><span style=color:#b48ead>10</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> _publish_confirm</span><span style=color:#81a1c1> =</span><span> channel</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>basic_publish</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>                "",</span></span>
<span class=giallo-l><span style=color:#eceff4>                "</span><span style=color:#a3be8c>task_queue</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span>                BasicPublishOptions</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>                Vec</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from</span><span style=color:#eceff4>(</span><span style=color:#88c0d0;font-weight:700>format!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>task </span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>i</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>")),</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                BasicProperties</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>with_delivery_mode</span><span style=color:#eceff4>(</span><span style=color:#b48ead>2</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>            )</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    // Wait forever</span></span>
<span class=giallo-l><span>    consumer1_handle</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span>    consumer2_handle</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>    Ok</span><span style=color:#eceff4>(())</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> consumer</span><span style=color:#eceff4>(</span><span>name</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>str</span><span style=color:#eceff4>,</span><span> channel</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Channel</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span> anyhow</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span>    channel</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>basic_qos</span><span style=color:#eceff4>(</span><span style=color:#b48ead>1</span><span style=color:#eceff4>,</span><span> BasicQosOptions</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> consumer</span><span style=color:#81a1c1> =</span><span> channel</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>basic_consume</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>            "</span><span style=color:#a3be8c>task_queue</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>            "",</span></span>
<span class=giallo-l><span>            BasicConsumeOptions</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>            FieldTable</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>        )</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    while let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>delivery</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> consumer</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>next</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if let</span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>((</span><span>_channel</span><span style=color:#eceff4>,</span><span> delivery</span><span style=color:#eceff4>))</span><span style=color:#81a1c1> =</span><span> delivery</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let</span><span> data</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> String</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_utf8_lossy</span><span style=color:#eceff4>(</span><span>delivery</span><span style=color:#81a1c1>.</span><span>data</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_slice</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>            println!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>name</span><span style=color:#ebcb8b>} {</span><span style=color:#a3be8c>data</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span>            delivery</span></span>
<span class=giallo-l><span style=color:#81a1c1>                .</span><span style=color:#88c0d0>ack</span><span style=color:#eceff4>(</span><span>BasicAckOptions</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>())</span></span>
<span class=giallo-l><span style=color:#81a1c1>                .await</span></span>
<span class=giallo-l><span style=color:#81a1c1>                .</span><span style=color:#88c0d0>expect</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>basic_ack</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>    Ok</span><span style=color:#eceff4>(())</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>consumerã§æ–°ãŸã«è¡Œã£ã¦ã„ã‚‹ã®ãŒ<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span>channel</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>basic_qos</span><span style=color:#eceff4>(</span><span style=color:#b48ead>1</span><span style=color:#eceff4>,</span><span> BasicQosOptions</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span></code></pre><p>ã®ã¨ã“ã‚ã§ã™ã€‚<code>basic_qos</code>ã¯consumerãŒqueueã‹ã‚‰messageã‚’å–å¾—ã™ã‚‹éš›ã«ä¸€åº¦ã«ã„ãã¤ã‚’å–å¾—ã™ã‚‹ã‹ã‚’æŒ‡å®šã—ã¾ã™ã€‚ã“ã“ã§ã¯1ã‚’æŒ‡å®šã—ã¦ã„ã‚‹ã®ã§ã€queueã®messageã¯consumer1,2ã«é †ç•ªã«æŒ¯ã‚Šåˆ†ã‘ã‚‰ã‚Œã¾ã™ã€‚<p>å®Ÿè¡Œã—ã¦ã¿ã‚‹ã¨<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>â¯</span><span style=color:#a3be8c> cargo run --quiet --example tutorial_work_queues</span></span>
<span class=giallo-l><span style=color:#88c0d0>worker1</span><span style=color:#a3be8c> task</span><span style=color:#b48ead> 0</span></span>
<span class=giallo-l><span style=color:#88c0d0>worker2</span><span style=color:#a3be8c> task</span><span style=color:#b48ead> 1</span></span>
<span class=giallo-l><span style=color:#88c0d0>worker1</span><span style=color:#a3be8c> task</span><span style=color:#b48ead> 2</span></span>
<span class=giallo-l><span style=color:#88c0d0>worker2</span><span style=color:#a3be8c> task</span><span style=color:#b48ead> 3</span></span>
<span class=giallo-l><span style=color:#88c0d0>worker1</span><span style=color:#a3be8c> task</span><span style=color:#b48ead> 4</span></span>
<span class=giallo-l><span style=color:#88c0d0>worker2</span><span style=color:#a3be8c> task</span><span style=color:#b48ead> 5</span></span>
<span class=giallo-l><span style=color:#88c0d0>worker1</span><span style=color:#a3be8c> task</span><span style=color:#b48ead> 6</span></span>
<span class=giallo-l><span style=color:#88c0d0>worker2</span><span style=color:#a3be8c> task</span><span style=color:#b48ead> 7</span></span>
<span class=giallo-l><span style=color:#88c0d0>worker1</span><span style=color:#a3be8c> task</span><span style=color:#b48ead> 8</span></span>
<span class=giallo-l><span style=color:#88c0d0>worker2</span><span style=color:#a3be8c> task</span><span style=color:#b48ead> 9</span></span></code></pre><p>messageãŒå‡ç­‰ã«åˆ†æ•£ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚<h2 id=publish-subscribe><a aria-label="Anchor link for: publish-subscribe" class=zola-anchor href=#publish-subscribe><code>Publish/Subscribe</code></a></h2><figure><div class=fig-images-row><img , alt src=images/rabbitmq_pubsub.png></div><figcaption>PubSub</figcaption></figure><p>Worker queuesã§ã¯ä¸€ã¤ã®queueã‚’consumerãŒå…±æœ‰ã—ã¦ã„ã¾ã—ãŸã€‚ä»Šå›ã¯consumerã”ã¨ã«queueã‚’ç‹¬ç«‹ã•ã›ã¦ã€ä¸€ã¤ã®messageã‚’è¤‡æ•°ã®queueã«é€ã‚‹ã€ã„ã‚ã‚†ã‚‹Pub/Subãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å®Ÿè£…ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> deadpool_lapin</span><span style=color:#81a1c1>::</span><span>lapin</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    BasicProperties</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Channel</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    ExchangeKind</span><span style=color:#eceff4>,</span><span> options</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        BasicAckOptions</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> BasicConsumeOptions</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> BasicPublishOptions</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> ExchangeDeclareOptions</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        QueueBindOptions</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> QueueDeclareOptions</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    },</span><span> types</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>FieldTable</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>};</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> futures</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>StreamExt</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> tokio</span><span style=color:#81a1c1>::</span><span>sync</span><span style=color:#81a1c1>::</span><span>mpsc</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> rabbitmq_handson</span><span style=color:#81a1c1>::</span><span>channel</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[tokio::main]</span></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span> anyhow</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span>    tracing_init</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>init</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> channel</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Channel</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> channel</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>    channel</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>exchange_declare</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>            "</span><span style=color:#a3be8c>logs</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span>            ExchangeKind</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Fanout</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            ExchangeDeclareOptions</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>            FieldTable</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>        )</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> worker_count</span><span style=color:#81a1c1> =</span><span style=color:#b48ead> 3</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span style=color:#eceff4> (</span><span>tx</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> mut</span><span> rx</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> mpsc</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>unbounded_channel</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> worker_handles</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Vec</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>with_capacity</span><span style=color:#eceff4>(</span><span>worker_count</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    for</span><span> i</span><span style=color:#81a1c1> in</span><span style=color:#b48ead> 0</span><span style=color:#81a1c1>..</span><span>worker_count</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> tx</span><span style=color:#81a1c1> =</span><span> tx</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> channel</span><span style=color:#81a1c1> =</span><span> channel</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> handle</span><span style=color:#81a1c1> =</span><span> tokio</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>spawn</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>consumer</span><span style=color:#eceff4>(</span><span style=color:#88c0d0;font-weight:700>format!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>worker </span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>i</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>"),</span><span> channel</span><span style=color:#eceff4>,</span><span> tx</span><span style=color:#eceff4>));</span></span>
<span class=giallo-l><span>        worker_handles</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>push</span><span style=color:#eceff4>(</span><span>handle</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    for</span><span> _</span><span style=color:#81a1c1> in</span><span style=color:#b48ead> 0</span><span style=color:#81a1c1>..</span><span>worker_count</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>        rx</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>recv</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    for</span><span> i</span><span style=color:#81a1c1> in</span><span style=color:#b48ead> 0</span><span style=color:#81a1c1>..</span><span style=color:#b48ead>3</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>        channel</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>basic_publish</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>                "</span><span style=color:#a3be8c>logs</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>                "",</span></span>
<span class=giallo-l><span>                BasicPublishOptions</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>                Vec</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from</span><span style=color:#eceff4>(</span><span style=color:#88c0d0;font-weight:700>format!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>message </span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>i</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>")),</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                BasicProperties</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>            )</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    for</span><span> handle</span><span style=color:#81a1c1> in</span><span> worker_handles</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>        handle</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>    Ok</span><span style=color:#eceff4>(())</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> consumer</span><span style=color:#eceff4>(</span><span>name</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>,</span><span> channel</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Channel</span><span style=color:#eceff4>,</span><span> ready</span><span style=color:#81a1c1>:</span><span> mpsc</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>UnboundedSender</span><span style=color:#eceff4>&lt;()>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> queue</span><span style=color:#81a1c1> =</span><span> channel</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>queue_declare</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>            "",</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            QueueDeclareOptions</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                exclusive</span><span style=color:#81a1c1>: true</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>                ..</span><span>Default</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>            },</span></span>
<span class=giallo-l><span>            FieldTable</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>        )</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .await</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>    channel</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>queue_bind</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>            queue</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>name</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_str</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>            "</span><span style=color:#a3be8c>logs</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>            "",</span></span>
<span class=giallo-l><span>            QueueBindOptions</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>            FieldTable</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>        )</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .await</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> consumer</span><span style=color:#81a1c1> =</span><span> channel</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>basic_consume</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>            queue</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>name</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_str</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>            "",</span></span>
<span class=giallo-l><span>            BasicConsumeOptions</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>            FieldTable</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>        )</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .await</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>    ready</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>send</span><span style=color:#eceff4>(())</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    while let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>delivery</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> consumer</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>next</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if let</span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>((</span><span>_channel</span><span style=color:#eceff4>,</span><span> delivery</span><span style=color:#eceff4>))</span><span style=color:#81a1c1> =</span><span> delivery</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let</span><span> message</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> String</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_utf8_lossy</span><span style=color:#eceff4>(</span><span>delivery</span><span style=color:#81a1c1>.</span><span>data</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_slice</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span>            tracing</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0;font-weight:700>info!</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>?</span><span>name</span><span style=color:#eceff4>, "</span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>message</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>            delivery</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>ack</span><span style=color:#eceff4>(</span><span>BasicAckOptions</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>.await.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>è¤‡æ•°ã®queueã«messageã‚’é€ã‚‹å ´åˆã«publisherå´ã§queueã®å­˜åœ¨ã‚’æ„è­˜ã™ã‚‹å¿…è¦ã¯ãªãã€ã“ã‚Œã¾ã§åŒæ§˜exchangeã‚’æŒ‡å®šã™ã‚‹ã ã‘ã§ã™ã€‚<br> ä»Šå›ã®ã‚ˆã†ãªPub/Subã®ã‚±ãƒ¼ã‚¹ã§ã¯exchange type fanoutã‚’æŒ‡å®šã—ã¾ã™ã€‚ ã¾ãŸã€consumerå´ã§ã®queue_declareã§ã™ãŒä»¥ä¸‹ã®ã‚ˆã†ã«è¡Œã£ã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>    let</span><span> queue</span><span style=color:#81a1c1> =</span><span> channel</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>queue_declare</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>            "",</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            QueueDeclareOptions</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                exclusive</span><span style=color:#81a1c1>: true</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>                ..</span><span>Default</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>            },</span></span>
<span class=giallo-l><span>            FieldTable</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>        )</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .await</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span></code></pre><p>queueã®åå‰ã«ç©ºæ–‡å­—ã‚’æŒ‡å®šã™ã‚‹ã¨RabbitMQå´ã§æ–°è¦ã®queueã‚’ä½œæˆã—ã¤ã¤åå‰ã‚’ç”Ÿæˆã—ã¦ã‹ãˆã—ã¦ãã‚Œã¾ã™ã€‚ã¾ãŸã€exclusiveã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§å½“è©²consumerå°‚ç”¨ã®queueã¨ãªã‚Šã¾ã™ã€‚ã‚ã¨ã¯ã“ã‚Œã¾ã§ã©ãŠã‚Šexchangeã¨queueã‚’bindã™ã‚‹ã“ã¨ã§messageãŒpublishã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚<p>å®Ÿè¡Œã—ã¦ã¿ã‚‹ã¨<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>â¯</span><span style=color:#a3be8c> cargo run --quiet --example tutorial_pub_sub</span><span>    </span></span>
<span class=giallo-l><span style=color:#88c0d0>2022-08-11T02:37:07.643985Z</span><span style=color:#a3be8c>  INFO examples/tutorial_pub_sub.rs:102: message</span><span style=color:#b48ead> 0</span><span style=color:#a3be8c> name=</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>worker 1</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#88c0d0>2022-08-11T02:37:07.644035Z</span><span style=color:#a3be8c>  INFO examples/tutorial_pub_sub.rs:102: message</span><span style=color:#b48ead> 0</span><span style=color:#a3be8c> name=</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>worker 2</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#88c0d0>2022-08-11T02:37:07.644006Z</span><span style=color:#a3be8c>  INFO examples/tutorial_pub_sub.rs:102: message</span><span style=color:#b48ead> 0</span><span style=color:#a3be8c> name=</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>worker 0</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#88c0d0>2022-08-11T02:37:07.644526Z</span><span style=color:#a3be8c>  INFO examples/tutorial_pub_sub.rs:102: message</span><span style=color:#b48ead> 1</span><span style=color:#a3be8c> name=</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>worker 1</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#88c0d0>2022-08-11T02:37:07.644581Z</span><span style=color:#a3be8c>  INFO examples/tutorial_pub_sub.rs:102: message</span><span style=color:#b48ead> 1</span><span style=color:#a3be8c> name=</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>worker 0</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#88c0d0>2022-08-11T02:37:07.644689Z</span><span style=color:#a3be8c>  INFO examples/tutorial_pub_sub.rs:102: message</span><span style=color:#b48ead> 1</span><span style=color:#a3be8c> name=</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>worker 2</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#88c0d0>2022-08-11T02:37:07.644879Z</span><span style=color:#a3be8c>  INFO examples/tutorial_pub_sub.rs:102: message</span><span style=color:#b48ead> 2</span><span style=color:#a3be8c> name=</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>worker 0</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#88c0d0>2022-08-11T02:37:07.644899Z</span><span style=color:#a3be8c>  INFO examples/tutorial_pub_sub.rs:102: message</span><span style=color:#b48ead> 2</span><span style=color:#a3be8c> name=</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>worker 1</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#88c0d0>2022-08-11T02:37:07.644908Z</span><span style=color:#a3be8c>  INFO examples/tutorial_pub_sub.rs:102: message</span><span style=color:#b48ead> 2</span><span style=color:#a3be8c> name=</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>worker 2</span><span style=color:#eceff4>"</span></span></code></pre><p>messageãŒconsumerãã‚Œãã‚Œã«publishã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸã€‚<h2 id=routing><a aria-label="Anchor link for: routing" class=zola-anchor href=#routing><code>Routing</code></a></h2><figure><div class=fig-images-row><img , alt src=images/rabbitmq_routing.png></div><figcaption>Routing</figcaption></figure><p>Pub/Subã®ä¾‹ã§ã¯consumerã¯publishã•ã‚ŒãŸmessageã‚’ã™ã¹ã¦å—ã‘å–ã£ã¦ã„ã¾ã—ãŸã€‚Routingã§ã¯ã“ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã‚’ã™ã“ã—ä¿®æ­£ã—ã¦ã€consumerãŒé–¢å¿ƒã®ã‚ã‚‹messageã ã‘ã‚’ã†ã‘ã¨ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚<br> ä¾‹ã¨ã—ã¦ã€ãƒ­ã‚®ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ã‚’è€ƒãˆã¾ã™ã€‚å„messageã«ã¯logã®severity(info,warn, error)ãŒä»˜ä¸ã•ã‚Œã¦ãŠã‚Šconsumerã¯ãã‚Œãã‚Œè‡ªèº«ãŒé–¢å¿ƒã®ã‚ã‚‹severityã‚’subscribeã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚ Pub/Subã§ã¯fanout exchangeã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã—ãŸãŒã€ä»Šå›ã¯direct exchangeã‚’åˆ©ç”¨ã—ã¾ã™ã€‚consumerã¯è‡ªèº«å°‚ç”¨ã®queueã‚’å®£è¨€ã—ãŸã‚ã¨ã€é–¢å¿ƒã®ã‚ã‚‹severityã§queueã‚’bindã—ã¾ã™ã€‚ã“ã®ã¨ãã€åŒã˜exchangeã¨queueã‚’ç•°ãªã‚‹routing keyã§è¤‡æ•°å›bindã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚<br> exampleã®codeã§ã¯worker1ã¯errorã®ã¿ã‚’ã€worker2ã¯info,warn,errorãã‚Œãã‚Œã‚’subscribeã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> deadpool_lapin</span><span style=color:#81a1c1>::</span><span>lapin</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>BasicProperties</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Channel</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> ExchangeKind</span><span style=color:#eceff4>,</span><span> options</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>BasicConsumeOptions</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> ExchangeDeclareOptions</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> QueueBindOptions</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> QueueDeclareOptions</span><span style=color:#eceff4>},</span><span> types</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>FieldTable</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> deadpool_lapin</span><span style=color:#81a1c1>::</span><span>lapin</span><span style=color:#81a1c1>::</span><span>options</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>BasicPublishOptions</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> futures</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>StreamExt</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> tokio</span><span style=color:#81a1c1>::</span><span>sync</span><span style=color:#81a1c1>::</span><span>mpsc</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>UnboundedSender</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> rabbitmq_handson</span><span style=color:#81a1c1>::</span><span>channel</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[tokio::main]</span></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span> anyhow</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span>    tracing_init</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>init</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> channel</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Channel</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> channel</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>    channel</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>exchange_declare</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>            "</span><span style=color:#a3be8c>direct_logs</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span>            ExchangeKind</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Direct</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            ExchangeDeclareOptions</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>            FieldTable</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>        )</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span style=color:#eceff4> (</span><span>tx</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> mut</span><span> rx</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> tokio</span><span style=color:#81a1c1>::</span><span>sync</span><span style=color:#81a1c1>::</span><span>mpsc</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>unbounded_channel</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> consumer_handle1</span><span style=color:#81a1c1> =</span><span> tokio</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>spawn</span><span style=color:#eceff4>({</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> channel</span><span style=color:#81a1c1> =</span><span> channel</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> tx</span><span style=color:#81a1c1> =</span><span> tx</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>        async move</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0>            consume</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>worker1</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>(),</span><span> channel</span><span style=color:#eceff4>,</span><span style=color:#88c0d0;font-weight:700> vec!</span><span style=color:#eceff4>["</span><span style=color:#a3be8c>error</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>()],</span><span> tx</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    });</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> consumer_handle2</span><span style=color:#81a1c1> =</span><span> tokio</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>spawn</span><span style=color:#eceff4>({</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> channel</span><span style=color:#81a1c1> =</span><span> channel</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> tx</span><span style=color:#81a1c1> =</span><span> tx</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>        async move</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0>            consume</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>worker2</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>(),</span><span> channel</span><span style=color:#eceff4>,</span><span style=color:#88c0d0;font-weight:700> vec!</span><span style=color:#eceff4>["</span><span style=color:#a3be8c>info</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>(), "</span><span style=color:#a3be8c>warn</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>(), "</span><span style=color:#a3be8c>error</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>()],</span><span> tx</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    });</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>    rx</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>recv</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span>    rx</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>recv</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> messages</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0;font-weight:700> vec!</span><span style=color:#eceff4>[</span></span>
<span class=giallo-l><span style=color:#eceff4>        ("</span><span style=color:#a3be8c>info</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>info message</span><span style=color:#eceff4>"),</span></span>
<span class=giallo-l><span style=color:#eceff4>        ("</span><span style=color:#a3be8c>warn</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>warn message</span><span style=color:#eceff4>"),</span></span>
<span class=giallo-l><span style=color:#eceff4>        ("</span><span style=color:#a3be8c>error</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>error message</span><span style=color:#eceff4>"),</span></span>
<span class=giallo-l><span style=color:#eceff4>    ];</span></span>
<span class=giallo-l><span style=color:#81a1c1>    for</span><span style=color:#eceff4> (</span><span>severity</span><span style=color:#eceff4>,</span><span> message</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> in</span><span> messages</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> _publish_confirm</span><span style=color:#81a1c1> =</span><span> channel</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>basic_publish</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>                "</span><span style=color:#a3be8c>direct_logs</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span>                severity</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>                BasicPublishOptions</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>                Vec</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from</span><span style=color:#eceff4>(</span><span>message</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span>                BasicProperties</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>with_delivery_mode</span><span style=color:#eceff4>(</span><span style=color:#b48ead>2</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>            )</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>    consumer_handle1</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span>    consumer_handle2</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>    Ok</span><span style=color:#eceff4>(())</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> consume</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>    name</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    channel</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Channel</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    severities</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Vec</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>    tx</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> UnboundedSender</span><span style=color:#eceff4>&lt;()>,</span></span>
<span class=giallo-l><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> queue</span><span style=color:#81a1c1> =</span><span> channel</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>queue_declare</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>            "",</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            QueueDeclareOptions</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                exclusive</span><span style=color:#81a1c1>: true</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>                ..</span><span>Default</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>            },</span></span>
<span class=giallo-l><span>            FieldTable</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>        )</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .await</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    for</span><span> severity</span><span style=color:#81a1c1> in</span><span> severities</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>        channel</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>queue_bind</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>                queue</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>name</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_str</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>                "</span><span style=color:#a3be8c>direct_logs</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#81a1c1>                &</span><span>severity</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>                QueueBindOptions</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>                FieldTable</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>            )</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .await</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>    tx</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>send</span><span style=color:#eceff4>(())</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> consume</span><span style=color:#81a1c1> =</span><span> channel</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>basic_consume</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>            queue</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>name</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_str</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>            "",</span></span>
<span class=giallo-l><span>            BasicConsumeOptions</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>            FieldTable</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>        )</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .await</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    while let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>delivery</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> consume</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>next</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if let</span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>((</span><span>_consume</span><span style=color:#eceff4>,</span><span> delivery</span><span style=color:#eceff4>))</span><span style=color:#81a1c1> =</span><span> delivery</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let</span><span> msg</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> String</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_utf8_lossy</span><span style=color:#eceff4>(</span><span>delivery</span><span style=color:#81a1c1>.</span><span>data</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_slice</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span>            tracing</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0;font-weight:700>info!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>name</span><span style=color:#ebcb8b>} {</span><span style=color:#a3be8c>msg</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>å®Ÿè¡Œã—ã¦ã¿ã‚‹ã¨<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>â¯</span><span style=color:#a3be8c> cargo run --quiet --example tutorial_routing</span></span>
<span class=giallo-l><span style=color:#88c0d0>2022-08-12T02:05:15.350635Z</span><span style=color:#a3be8c>  INFO examples/tutorial_routing.rs:113: worker2 info message</span></span>
<span class=giallo-l><span style=color:#88c0d0>2022-08-12T02:05:15.351025Z</span><span style=color:#a3be8c>  INFO examples/tutorial_routing.rs:113: worker2 warn message</span></span>
<span class=giallo-l><span style=color:#88c0d0>2022-08-12T02:05:15.351074Z</span><span style=color:#a3be8c>  INFO examples/tutorial_routing.rs:113: worker2 error message</span></span>
<span class=giallo-l><span style=color:#88c0d0>2022-08-12T02:05:15.351099Z</span><span style=color:#a3be8c>  INFO examples/tutorial_routing.rs:113: worker1 error message</span></span></code></pre><p>worker1ã¯errorã®ã¿ã‚’ã€worker2ã¯å„ç¨®severityã®messageã‚’consumeã§ãã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸã€‚<h2 id=topics><a aria-label="Anchor link for: topics" class=zola-anchor href=#topics><code>Topics</code></a></h2><figure><div class=fig-images-row><img , alt src=images/rabbitmq_topics.png></div><figcaption>Topics</figcaption></figure><p>queueã«bindã™ã‚‹éš›ã®routing keyã§é¸æŠçš„ã«messageã‚’subscribeã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚<br> ã—ã‹ã—ãªãŒã‚‰Routingã®ä¾‹ã§ã¿ãŸã‚ˆã†ã«messageã®routing keyã¨å®Œå…¨ä¸€è‡´ã•ã›ã‚‹å¿…è¦ãŒã‚ã‚Šã€severityã®ã‚ˆã†ãªå˜ç´”ãªä¾‹ä»¥å¤–ã§ã¯ä½¿ã„ã¥ã‚‰ã„é¢ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®filteringã®æ©Ÿèƒ½ã‚’æ‹¡å¼µã—ãŸã®ãŒTopic exchangeã§ã™ã€‚<p>Topic exchangeã«ãŠã‘ã‚‹routing keyã¯ãƒ”ãƒªã‚ªãƒ‰(<code>.</code>)ã‚’delimiterã¨ã—ã¦ä»»æ„ã®éšå±¤ã‚’è¡¨ç¾ã§ãã¾ã™ã€‚ä¾‹ãˆã°<code>aaa.bbb.ccc</code>ç­‰ã§ã™ã€‚<br> bindã™ã‚‹å´ã¯wildcardã‚’åˆ©ç”¨ã§ãã€<code>*</code>ã¯ä¸€éšå±¤ã«ãƒãƒƒãƒã—ã€<code>#</code>ã¯ä»»æ„ã®éšå±¤ã«ãƒãƒƒãƒã—ã¾ã™ã€‚<br> ã“ã“ã§ã¯ã€ã‚ã‚‹eventã‚’messageã¨ã—ã¦ã€routing keyã¨ã—ã¦ã€<code>&lt;domain>.&lt;tenant>.&lt;event></code>ã®ã‚ˆã†ãªformatã‚’åˆ©ç”¨ã—ã¾ã™ã€‚<p>consumer1ã¯<code>tracking.#</code>ã‚’bindã—ã¾ã™ã€‚ã“ã‚Œã¯ä»»æ„ã®tracking domainã®eventã‚’subscribeã—ã¾ã™ã€‚<br> consumer2ã¯<code>*.xxx.*</code>ã‚’bindã—ã¾ã™ã€‚domainã‚„eventã®ç¨®åˆ¥ã«é–¢ã‚ã‚‰ãštenant xxxã‚’å¯¾è±¡ã«ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> deadpool_lapin</span><span style=color:#81a1c1>::</span><span>lapin</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>BasicProperties</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Channel</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> ExchangeKind</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> deadpool_lapin</span><span style=color:#81a1c1>::</span><span>lapin</span><span style=color:#81a1c1>::</span><span>options</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    BasicConsumeOptions</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> BasicPublishOptions</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> ExchangeDeclareOptions</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> QueueBindOptions</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    QueueDeclareOptions</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>};</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> deadpool_lapin</span><span style=color:#81a1c1>::</span><span>lapin</span><span style=color:#81a1c1>::</span><span>types</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>FieldTable</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> futures</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>StreamExt</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> tokio</span><span style=color:#81a1c1>::</span><span>sync</span><span style=color:#81a1c1>::</span><span>mpsc</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>UnboundedSender</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> rabbitmq_handson</span><span style=color:#81a1c1>::</span><span>channel</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[tokio::main]</span></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span> anyhow</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span>    tracing_init</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>init</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> channel</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> channel</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>    channel</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>exchange_declare</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>            "</span><span style=color:#a3be8c>topic_events</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span>            ExchangeKind</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Topic</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            ExchangeDeclareOptions</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>            FieldTable</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>        )</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span style=color:#eceff4> (</span><span>tx</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> mut</span><span> rx</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> tokio</span><span style=color:#81a1c1>::</span><span>sync</span><span style=color:#81a1c1>::</span><span>mpsc</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>unbounded_channel</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> consumer1_handle</span><span style=color:#81a1c1> =</span><span> tokio</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>spawn</span><span style=color:#eceff4>({</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> channel</span><span style=color:#81a1c1> =</span><span> channel</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> tx</span><span style=color:#81a1c1> =</span><span> tx</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>        async move</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            if let</span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> consumer_1</span><span style=color:#eceff4>(</span><span>channel</span><span style=color:#eceff4>,</span><span> tx</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                tracing</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0;font-weight:700>error!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>err</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>")</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    });</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> consumer2_handle</span><span style=color:#81a1c1> =</span><span> tokio</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>spawn</span><span style=color:#eceff4>({</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> channel</span><span style=color:#81a1c1> =</span><span> channel</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> tx</span><span style=color:#81a1c1> =</span><span> tx</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>        async move</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            if let</span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> consumer_2</span><span style=color:#eceff4>(</span><span>channel</span><span style=color:#eceff4>,</span><span>tx</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                tracing</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0;font-weight:700>error!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>err</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    });</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>    rx</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>recv</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span>    rx</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>recv</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> events</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0;font-weight:700> vec!</span><span style=color:#eceff4>[</span></span>
<span class=giallo-l><span style=color:#eceff4>        "</span><span style=color:#a3be8c>tracking.aaa.arrived</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>        "</span><span style=color:#a3be8c>tracking.xxx.departed</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>        "</span><span style=color:#a3be8c>dispatch.aaa.delivered</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>        "</span><span style=color:#a3be8c>dispatch.xxx.delivered</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>    ];</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    for</span><span> event</span><span style=color:#81a1c1> in</span><span> events</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>        channel</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>basic_publish</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>                "</span><span style=color:#a3be8c>topic_events</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span>                event</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>                BasicPublishOptions</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>                Vec</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from</span><span style=color:#eceff4>(</span><span>event</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span>                BasicProperties</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>            )</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>        tracing</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0;font-weight:700>info!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>event</span><span style=color:#ebcb8b>}</span><span style=color:#a3be8c> published</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>    consumer1_handle</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span>    consumer2_handle</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>    Ok</span><span style=color:#eceff4>(())</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> consumer_1</span><span style=color:#eceff4>(</span><span>channel</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Channel</span><span style=color:#eceff4>,</span><span> tx</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> UnboundedSender</span><span style=color:#eceff4>&lt;()>)</span><span style=color:#81a1c1> -></span><span> anyhow</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> queue</span><span style=color:#81a1c1> =</span><span> channel</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>queue_declare</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>            "",</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            QueueDeclareOptions</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                exclusive</span><span style=color:#81a1c1>: true</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>                ..</span><span>Default</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>            },</span></span>
<span class=giallo-l><span>            FieldTable</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>        )</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>    channel</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>queue_bind</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>            queue</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>name</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_str</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>            "</span><span style=color:#a3be8c>topic_events</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>            "</span><span style=color:#a3be8c>tracking.#</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span>            QueueBindOptions</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>            FieldTable</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>        )</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>    tx</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>send</span><span style=color:#eceff4>(())</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> consume</span><span style=color:#81a1c1> =</span><span> channel</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>basic_consume</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>            queue</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>name</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_str</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>            "",</span></span>
<span class=giallo-l><span>            BasicConsumeOptions</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>            FieldTable</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>        )</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    while let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>delivery</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> consume</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>next</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if let</span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>((</span><span>_consume</span><span style=color:#eceff4>,</span><span> delivery</span><span style=color:#eceff4>))</span><span style=color:#81a1c1> =</span><span> delivery</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let</span><span> msg</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> String</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_utf8_lossy</span><span style=color:#eceff4>(</span><span>delivery</span><span style=color:#81a1c1>.</span><span>data</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_slice</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>            tracing</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0;font-weight:700>info!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>consumer_1: </span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>msg</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>    Ok</span><span style=color:#eceff4>(())</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> consumer_2</span><span style=color:#eceff4>(</span><span>channel</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Channel</span><span style=color:#eceff4>,</span><span> tx</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> UnboundedSender</span><span style=color:#eceff4>&lt;()>)</span><span style=color:#81a1c1> -></span><span> anyhow</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> queue</span><span style=color:#81a1c1> =</span><span> channel</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>queue_declare</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>            "",</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            QueueDeclareOptions</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                exclusive</span><span style=color:#81a1c1>: true</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>                ..</span><span>Default</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>            },</span></span>
<span class=giallo-l><span>            FieldTable</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>        )</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>    channel</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>queue_bind</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>            queue</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>name</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_str</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>            "</span><span style=color:#a3be8c>topic_events</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>            "</span><span style=color:#a3be8c>*.xxx.*</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span>            QueueBindOptions</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>            FieldTable</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>        )</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>    tx</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>send</span><span style=color:#eceff4>(())</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> consume</span><span style=color:#81a1c1> =</span><span> channel</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>basic_consume</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>            queue</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>name</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_str</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>            "",</span></span>
<span class=giallo-l><span>            BasicConsumeOptions</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>            FieldTable</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>        )</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    while let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>delivery</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> consume</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>next</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if let</span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>((</span><span>_consume</span><span style=color:#eceff4>,</span><span> delivery</span><span style=color:#eceff4>))</span><span style=color:#81a1c1> =</span><span> delivery</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let</span><span> msg</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> String</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_utf8_lossy</span><span style=color:#eceff4>(</span><span>delivery</span><span style=color:#81a1c1>.</span><span>data</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_slice</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>            tracing</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0;font-weight:700>info!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>consumer_2: </span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>msg</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>    Ok</span><span style=color:#eceff4>(())</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>å®Ÿè¡Œã—ã¦ã¿ã‚‹ã¨<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>â¯</span><span style=color:#a3be8c> cargo run --quiet --example tutorial_topic</span></span>
<span class=giallo-l><span style=color:#88c0d0>2022-08-12T02:57:31.23669Z</span><span style=color:#a3be8c>  INFO examples/tutorial_topic.rs:70: tracking.aaa.arrived published</span></span>
<span class=giallo-l><span style=color:#88c0d0>2022-08-12T02:57:31.236836Z</span><span style=color:#a3be8c>  INFO examples/tutorial_topic.rs:70: tracking.xxx.departed published</span></span>
<span class=giallo-l><span style=color:#88c0d0>2022-08-12T02:57:31.23701Z</span><span style=color:#a3be8c>  INFO examples/tutorial_topic.rs:70: dispatch.aaa.delivered published</span></span>
<span class=giallo-l><span style=color:#88c0d0>2022-08-12T02:57:31.237143Z</span><span style=color:#a3be8c>  INFO examples/tutorial_topic.rs:70: dispatch.xxx.delivered published</span></span>
<span class=giallo-l><span style=color:#88c0d0>2022-08-12T02:57:31.239124Z</span><span style=color:#a3be8c>  INFO examples/tutorial_topic.rs:116: consumer_1: tracking.aaa.arrived</span></span>
<span class=giallo-l><span style=color:#88c0d0>2022-08-12T02:57:31.239151Z</span><span style=color:#a3be8c>  INFO examples/tutorial_topic.rs:116: consumer_1: tracking.xxx.departed</span></span>
<span class=giallo-l><span style=color:#88c0d0>2022-08-12T02:57:31.239212Z</span><span style=color:#a3be8c>  INFO examples/tutorial_topic.rs:160: consumer_2: tracking.xxx.departed</span></span>
<span class=giallo-l><span style=color:#88c0d0>2022-08-12T02:57:31.239245Z</span><span style=color:#a3be8c>  INFO examples/tutorial_topic.rs:160: consumer_2: dispatch.xxx.delivered</span></span></code></pre><p>consumer1ã¯<code>tracing</code> domainã®eventã‚’, consumer2ã¯xxx tenantã®eventã‚’ãã‚Œãã‚Œsubscribeã§ãã‚‹ã„ã¾ã™ã€‚<br> Topic exchangeã¯è¨­è¨ˆæ¬¡ç¬¬ã§ã„ã‚ã„ã‚ãªãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã«å¯¾å¿œã§ããã†ã§ã™ã€‚<h2 id=rpc><a aria-label="Anchor link for: rpc" class=zola-anchor href=#rpc><code>RPC</code></a></h2><figure><div class=fig-images-row><img , alt src=images/rabbitmq_rpc.png></div><figcaption>RPC</figcaption></figure><p>ã“ã‚Œã¾ã§ã®ä¾‹ã¯ã„ã‚ã‚†ã‚‹fire and forgetã§ã€publisherã¯publishã—ãŸmessageã«ã¤ã„ã¦æ°—ã«ã—ã¦ã„ã¾ã›ã‚“ã§ã—ãŸã€‚RPCã®ä¾‹ã§ã¯éåŒæœŸã§ã¯ã‚ã‚‹ã‚‚ã®ã®ã€publishã—ãŸmessageã®å‡¦ç†çµæœã«é–¢å¿ƒãŒã‚ã‚Šconsumerã¯å‡¦ç†çµæœã‚’publisherã«ä¼ãˆã¾ã™ã€‚<p>ä»Šã¾ã§ã¨ç•°ãªã‚‹ç‚¹ã¯ã€messageã‚’publishã™ã‚‹éš›ã«responseç”¨ã®queueã‚’<code>reply_to</code>ã§æŒ‡å®šã™ã‚‹ç‚¹ã§ã™ã€‚ã•ã‚‰ã«responseã¯éåŒæœŸã§è¿”ã£ã¦ãã‚‹ã®ã§requestã¨responseã®å¯¾å¿œé–¢ä¿‚ã‚’<code>correlation_id</code>ã§è¡¨ç¾ã—ã¾ã™ã€‚<p>ã“ã‚Œã‚‰ã®messageã®propertiesã«é–¢ã—ã¦ã¯<a href=https://www.rabbitmq.com/protocol.html rel=external>AMQP 0-9-1 Protocol Specification</a>ã®<a href=https://www.rabbitmq.com/resources/specs/amqp-xml-doc0-9-1.pdf rel=external>Generated Doc</a>ã«è¨˜è¼‰ãŒã‚ã‚Šã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> deadpool_lapin</span><span style=color:#81a1c1>::</span><span>lapin</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>BasicProperties</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Channel</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> deadpool_lapin</span><span style=color:#81a1c1>::</span><span>lapin</span><span style=color:#81a1c1>::</span><span>options</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>BasicConsumeOptions</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> BasicPublishOptions</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> QueueDeclareOptions</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> deadpool_lapin</span><span style=color:#81a1c1>::</span><span>lapin</span><span style=color:#81a1c1>::</span><span>types</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>FieldTable</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> futures</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>StreamExt</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> rabbitmq_handson</span><span style=color:#81a1c1>::</span><span>channel</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[tokio::main]</span></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span> anyhow</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span>    tracing_init</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>init</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> channel</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> channel</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> rpc_queue</span><span style=color:#81a1c1> =</span><span> channel</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>queue_declare</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>rpc_queue</span><span style=color:#eceff4>",</span><span> QueueDeclareOptions</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span><span> FieldTable</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> response_queue</span><span style=color:#81a1c1> =</span><span> channel</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>queue_declare</span><span style=color:#eceff4>("",</span><span style=color:#8fbcbb> QueueDeclareOptions</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>        exclusive</span><span style=color:#81a1c1>: true</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>        ..</span><span>Default</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>    },</span><span> FieldTable</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>    tokio</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>spawn</span><span style=color:#eceff4>({</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> channel</span><span style=color:#81a1c1> =</span><span> channel</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>        async move</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            if let</span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> server</span><span style=color:#eceff4>(</span><span>channel</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                tracing</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0;font-weight:700>error!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>err</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    });</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>    channel</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>basic_publish</span><span style=color:#eceff4>("",</span><span> rpc_queue</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>name</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_str</span><span style=color:#eceff4>(),</span><span> BasicPublishOptions</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>                          Vec</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>10</span><span style=color:#eceff4>"),</span><span> BasicProperties</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>with_reply_to</span><span style=color:#eceff4>(</span><span>response_queue</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>name</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>with_correlation_id</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>1</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>()))</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> response_consumer</span><span style=color:#81a1c1> =</span><span> channel</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>basic_consume</span><span style=color:#eceff4>(</span><span>response_queue</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>name</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_str</span><span style=color:#eceff4>(), "",</span><span> BasicConsumeOptions</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span><span> FieldTable</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> response</span><span style=color:#81a1c1> =</span><span> response_consumer</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>next</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    if let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>response</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> response</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if let</span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>((</span><span>_channel</span><span style=color:#eceff4>,</span><span> delivery</span><span style=color:#eceff4>))</span><span style=color:#81a1c1> =</span><span> response</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let</span><span> response</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> String</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_utf8_lossy</span><span style=color:#eceff4>(</span><span>delivery</span><span style=color:#81a1c1>.</span><span>data</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_slice</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span>            tracing</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0;font-weight:700>info!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>fib(10) = </span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>response</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>    Ok</span><span style=color:#eceff4>(())</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> fib</span><span style=color:#eceff4>(</span><span>n</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> usize</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> u64</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#eceff4>    (</span><span style=color:#b48ead>0</span><span style=color:#81a1c1>..</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into_iter</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>scan</span><span style=color:#eceff4>((</span><span style=color:#b48ead>0_</span><span style=color:#8fbcbb>u64</span><span style=color:#eceff4>,</span><span style=color:#b48ead> 1_</span><span style=color:#8fbcbb>u64</span><span style=color:#eceff4>),</span><span style=color:#81a1c1> |</span><span>state</span><span style=color:#eceff4>,</span><span> _</span><span style=color:#81a1c1>|</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let &mut</span><span style=color:#eceff4> (</span><span>a</span><span style=color:#eceff4>,</span><span> b</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> state</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> next</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> (</span><span>a</span><span style=color:#eceff4>,</span><span> b</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        *</span><span>state</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> (</span><span>b</span><span style=color:#eceff4>, (</span><span>a</span><span style=color:#81a1c1> +</span><span> b</span><span style=color:#eceff4>));</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Some</span><span style=color:#eceff4>(</span><span>next</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    })</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>nth</span><span style=color:#eceff4>(</span><span>n</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>map</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span style=color:#eceff4>(</span><span>a</span><span style=color:#eceff4>,</span><span> _</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>|</span><span> a</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> server</span><span style=color:#eceff4>(</span><span>channel</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Channel</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span> anyhow</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> consumer</span><span style=color:#81a1c1> =</span><span> channel</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>basic_consume</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>rpc_queue</span><span style=color:#eceff4>", "",</span><span> BasicConsumeOptions</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span><span> FieldTable</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    while let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>delivery</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> consumer</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>next</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if let</span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>((</span><span>_channel</span><span style=color:#eceff4>,</span><span> delivery</span><span style=color:#eceff4>))</span><span style=color:#81a1c1> =</span><span> delivery</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let</span><span> msg</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> String</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_utf8_lossy</span><span style=color:#eceff4>(</span><span>delivery</span><span style=color:#81a1c1>.</span><span>data</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_slice</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_string</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let</span><span> response</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> fib</span><span style=color:#eceff4>(</span><span>msg</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>parse</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let</span><span> correlation_id</span><span style=color:#81a1c1> =</span><span> delivery</span><span style=color:#81a1c1>.</span><span>properties</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>correlation_id</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>            channel</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>basic_publish</span><span style=color:#eceff4>("",</span><span> delivery</span><span style=color:#81a1c1>.</span><span>properties</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>reply_to</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_str</span><span style=color:#eceff4>(),</span><span> BasicPublishOptions</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span><span> Vec</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from</span><span style=color:#eceff4>(</span><span>response</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_string</span><span style=color:#eceff4>()),</span><span> BasicProperties</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>with_correlation_id</span><span style=color:#eceff4>(</span><span>correlation_id</span><span style=color:#eceff4>))</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>    Ok</span><span style=color:#eceff4>(())</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>fibonacciã‚’è¿”ã™serverã‚’rpcã§åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚<br> responseç”¨ã®queueã¯exclusiveã«ã—ã¦åå‰ã¯RabbitMQå´ã§ç”Ÿæˆã—ã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>â¯</span><span style=color:#a3be8c> cargo run --quiet --example tutorial_rpc</span></span>
<span class=giallo-l><span style=color:#88c0d0>2022-08-12T08:49:10.864598Z</span><span style=color:#a3be8c>  INFO examples/tutorial_rpc.rs:38: fib</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>10</span><span style=color:#eceff4>)</span><span style=color:#a3be8c> =</span><span style=color:#b48ead> 55</span></span></code></pre><p>å®Ÿè¡Œã—ã¦ã¿ã‚‹ã¨ç„¡äº‹responseã‚’ã†ã‘ã¨ã‚Œã¾ã—ãŸã€‚<h2 id=publisher-confirms><a aria-label="Anchor link for: publisher-confirms" class=zola-anchor href=#publisher-confirms><code>Publisher Confirms</code></a></h2><p>æœ€å¾Œã®tutorialã¯publisher confirmã«ã¤ã„ã¦ã€‚ã“ã‚Œã¯consumerã«ã‚ˆã‚‹ackã®publisherç‰ˆã§ã€RabbitMQã®AMQPã®æ‹¡å¼µæ©Ÿèƒ½ã«ãªã‚Šã¾ã™ã€‚tutorialè‡ªä½“ã§ã¯batchã‚„éåŒæœŸã«ã‚ˆã‚‹æ€§èƒ½æ¯”è¼ƒã«ã¤ã„ã¦è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã®ã§ã™ãŒã€lapinã®APIã§ã¯éé“ã§publishã”ã¨ã«confirmã™ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ãŸã®ã§ã€ãã®æ–¹å¼ã®ã¿ã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚(ä»–ã«ã‚‚æ–¹æ³•ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“)<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> anyhow</span><span style=color:#81a1c1>::</span><span>anyhow</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> async_trait</span><span style=color:#81a1c1>::</span><span>async_trait</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> deadpool_lapin</span><span style=color:#81a1c1>::</span><span>lapin</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>BasicProperties</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> deadpool_lapin</span><span style=color:#81a1c1>::</span><span>lapin</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Channel</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> deadpool_lapin</span><span style=color:#81a1c1>::</span><span>lapin</span><span style=color:#81a1c1>::</span><span>options</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>BasicPublishOptions</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> ConfirmSelectOptions</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> deadpool_lapin</span><span style=color:#81a1c1>::</span><span>lapin</span><span style=color:#81a1c1>::</span><span>publisher_confirm</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Confirmation</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> rabbitmq_handson</span><span style=color:#81a1c1>::</span><span>channel</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[async_trait]</span></span>
<span class=giallo-l><span style=color:#81a1c1>trait</span><span style=color:#8fbcbb;font-weight:700> Publish</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    async fn</span><span style=color:#88c0d0> publish</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> message</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span> anyhow</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;()>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> Confirm</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    channel</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Channel</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[async_trait]</span></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Publish</span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> Confirm</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    async fn</span><span style=color:#88c0d0> publish</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> message</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span> anyhow</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> confirm</span><span style=color:#81a1c1> = self.</span><span>channel</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>basic_publish</span><span style=color:#eceff4>("", "</span><span style=color:#a3be8c>queue</span><span style=color:#eceff4>",</span><span> BasicPublishOptions</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span><span> Vec</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from</span><span style=color:#eceff4>(</span><span>message</span><span style=color:#eceff4>),</span><span> BasicProperties</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        match</span><span> confirm</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Confirmation</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Ack</span><span style=color:#eceff4>(</span><span>_ack</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Ok</span><span style=color:#eceff4>(())</span></span>
<span class=giallo-l><span style=color:#eceff4>            },</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Confirmation</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Nack</span><span style=color:#eceff4>(</span><span>_</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span style=color:#88c0d0;font-weight:700>anyhow!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>confirmation failed</span><span style=color:#eceff4>")),</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Confirmation</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>NotRequested</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span style=color:#88c0d0;font-weight:700>anyhow!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>confirmation not requested</span><span style=color:#eceff4>")),</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[tokio::main]</span></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span> anyhow</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span>   tracing_init</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>init</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> channel</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> channel</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span>    channel</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>confirm_select</span><span style=color:#eceff4>(</span><span>ConfirmSelectOptions</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>    publish</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Confirm</span><span style=color:#eceff4> {</span><span> channel</span><span style=color:#eceff4> })</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>    Ok</span><span style=color:#eceff4>(())</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> publish</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>P</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Publish</span><span style=color:#eceff4>>(</span><span>publisher</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> P</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span> anyhow</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> messages</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Vec</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>></span><span style=color:#81a1c1> =</span><span> std</span><span style=color:#81a1c1>::</span><span>iter</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>repeat</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>message</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_owned</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>take</span><span style=color:#eceff4>(</span><span style=color:#b48ead>500</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>collect</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    for</span><span> message</span><span style=color:#81a1c1> in</span><span> messages</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>        publisher</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>publish</span><span style=color:#eceff4>(</span><span>message</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>    Ok</span><span style=color:#eceff4>(())</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>channel.confirm_select(ConfirmSelectOptions::default()).await?</code>ã®ã‚ˆã†ã«channelä½œæˆå¾Œã«publisher confirmã‚’æœ‰åŠ¹ã«ã—ã¾ã™ã€‚<br> performanceçš„ã«å•é¡Œãªã‘ã‚Œã°åŸºæœ¬çš„ã«ã¯æœ‰åŠ¹ã«ã—ã¨ãŠã‘ã°ã‚ˆã„ã®ã§ã—ã‚‡ã†ã‹ã€‚<h2 id=matome><a aria-label="Anchor link for: matome" class=zola-anchor href=#matome>ã¾ã¨ã‚</a></h2><p>ç°¡å˜ã§ã¯ã‚ã‚Šã¾ã™ãŒã€RabbitMQ tutorialsã‚’Rustã§ã‚„ã£ã¦ã¿ã¾ã—ãŸã€‚<br> å®Ÿé‹ç”¨ã™ã‚‹ã«ã‚ãŸã£ã¦ã¯TTLã‚„Dead Letter Queue, Metricsç­‰ã€…ã¾ã ã¾ã èª¿ã¹ã¦ã¿ãŸã„ã“ã¨ãŒã‚ã‚Šã¾ã™ãŒã€ã¨ã‚Šã‚ãˆãšè§¦ã£ã¦å‹•ã‹ã—ã¦ã¿ã‚‹ã¨ã„ã†ç›®çš„ã¯é”ã›ã‚‰ã‚ŒãŸã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚<br> æ¬¡ã¯<a href=https://www.packtpub.com/product/rabbitmq-essentials-second-edition/9781789131666 rel=external>RabbitMQ Essentials Second Edition</a>ã‚’èª­ã‚“ã§ã¿ã‚ˆã†ã¨æ€ã£ã¦ã„ã‚‹ã®ã§ã€èª­ã¿çµ‚ã‚ã£ãŸã‚‰æ„Ÿæƒ³ã‚’æ›¸ãã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚</div></article></main><footer class=blog-footer><p>Â© 2026 <a href=https://blog.ymgyt.io> ymgyt </a> | Made with <a href=https://www.getzola.org rel=noopener target=_blank>Zola</a> | <a href=https://github.com/ymgyt/blog>Repository</a> | <a href=https://blog.ymgyt.io/atom.xml target=_blank title=rss> <svg viewbox="0 0 24 24" class=icon fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx=5 cy=19 r=1></circle></svg> </a></footer></div></div>