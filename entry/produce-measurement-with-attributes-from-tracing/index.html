<!doctype html><html lang=ja><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1" name=viewport><link href=https://blog.ymgyt.io/favicon.ico rel=icon sizes=any><link href=https://blog.ymgyt.io/icon.svg rel=icon type=image/svg+xml><link href=https://blog.ymgyt.io/apple-touch-icon.png rel=apple-touch-icon><link href=https://blog.ymgyt.io/manifest.webmanifest rel=manifest><link href=https://blog.ymgyt.io/style.css rel=stylesheet><link href=https://blog.ymgyt.io/atom.xml rel=alternate title=Atom type=application/atom+xml><script src="https://www.googletagmanager.com/gtag/js?id=G-GTB0KMLN90" async></script><script>window.dataLayer = window.dataLayer || [];
	function gtag() {dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-GTB0KMLN90');</script><title>ğŸ”­ tracingã‹ã‚‰Attributesã‚’ä»˜ä¸ã—ã¦metricsã‚’å‡ºåŠ›ã§ãã‚‹ã‚ˆã†ã«tracing-opentelemetryã«PRã‚’é€ã£ãŸ | Happy developing</title><meta content=tracing-opentelemetryã®MetricsLayerã«æ©Ÿèƒ½ã‚’è¿½åŠ ã™ã‚‹PRã‚’é€ã£ãŸè©± name=description><meta content=summary name=twitter:card><meta content="@YAmaguchixt " name=twitter:site><meta content="ğŸ”­ tracingã‹ã‚‰Attributesã‚’ä»˜ä¸ã—ã¦metricsã‚’å‡ºåŠ›ã§ãã‚‹ã‚ˆã†ã«tracing-opentelemetryã«PRã‚’é€ã£ãŸ" name=twitter:title><meta content=tracing-opentelemetryã®MetricsLayerã«æ©Ÿèƒ½ã‚’è¿½åŠ ã™ã‚‹PRã‚’é€ã£ãŸè©± name=twitter:description><meta content=https://blog.ymgyt.io/images/emoji/telescope.png name=twitter:image><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><body><div class=world><div class=content-container><header class=blog-header-container><div class=blog-logo><a href=https://blog.ymgyt.io>Happy developing</a></div><div class=blog-nav><nav><ul><li><a href=https://blog.ymgyt.io/entry/>Entries</a><li><a href=https://blog.ymgyt.io/tags/>Tags</a><li><a href=https://blog.ymgyt.io/about/>About</a><li><a href=https://github.com/ymgyt> <img alt=Github class=icon src=https://blog.ymgyt.io/images/icon/github.svg> </a><li><a href="https://twitter.com/YAmaguchixt "> <img alt=Twitter class=icon src=https://blog.ymgyt.io/images/icon/twitter.svg> </a></ul></nav></div></header><main class=blog-main><article><header class=entry-header><h1 class=entry-title>ğŸ”­ tracingã‹ã‚‰Attributesã‚’ä»˜ä¸ã—ã¦metricsã‚’å‡ºåŠ›ã§ãã‚‹ã‚ˆã†ã«tracing-opentelemetryã«PRã‚’é€ã£ãŸ</h1><div class=entry-meta><p class=entry-meta-item>ğŸ—“ 2023-08-26<p class=entry-meta-item>ğŸ· <span class=tag><a href=https://blog.ymgyt.io/tags/rust/>rust</a></span> <span class=tag><a href=https://blog.ymgyt.io/tags/opentelemetry/>opentelemetry</a></span></div></header><aside class=entry-toc><nav><ul class=entry-toc-toplevel-list><li><a href=https://blog.ymgyt.io/entry/produce-measurement-with-attributes-from-tracing/#tl-dr>TL;DR</a><li><a href=https://blog.ymgyt.io/entry/produce-measurement-with-attributes-from-tracing/#qian-ti>å‰æ</a><li><a href=https://blog.ymgyt.io/entry/produce-measurement-with-attributes-from-tracing/#prdeshi-zhuang-sitaji-neng-nogai-yao>PRã§å®Ÿè£…ã—ãŸæ©Ÿèƒ½ã®æ¦‚è¦</a><li><a href=https://blog.ymgyt.io/entry/produce-measurement-with-attributes-from-tracing/#metricslayernoshi-zu-mi>MetricsLayerã®ä»•çµ„ã¿</a> <ul><li><a href=https://blog.ymgyt.io/entry/produce-measurement-with-attributes-from-tracing/#instrumentsnoshi-zu-mi>Instrumentsã®ä»•çµ„ã¿</a></ul><li><a href=https://blog.ymgyt.io/entry/produce-measurement-with-attributes-from-tracing/#ji-neng-wozhui-jia-surushang-denowen-ti-dian>æ©Ÿèƒ½ã‚’è¿½åŠ ã™ã‚‹ä¸Šã§ã®å•é¡Œç‚¹</a> <ul><li><a href=https://blog.ymgyt.io/entry/produce-measurement-with-attributes-from-tracing/#visitorpatantoxiang-xing-gae-i>Visitorãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ç›¸æ€§ãŒæ‚ªã„</a><li><a href=https://blog.ymgyt.io/entry/produce-measurement-with-attributes-from-tracing/#eventchu-qi-hua-shi-nipan-ding-suru>EventåˆæœŸåŒ–æ™‚ã«åˆ¤å®šã™ã‚‹</a></ul><li><a href=https://blog.ymgyt.io/entry/produce-measurement-with-attributes-from-tracing/#per-layer-filtering>Per-Layer Filtering</a> <ul><li><a href=https://blog.ymgyt.io/entry/produce-measurement-with-attributes-from-tracing/#filtertofiltered>Filterã¨Filtered</a></ul><li><a href=https://blog.ymgyt.io/entry/produce-measurement-with-attributes-from-tracing/#allocationmobi-ketai>Allocationã‚‚é¿ã‘ãŸã„</a><li><a href=https://blog.ymgyt.io/entry/produce-measurement-with-attributes-from-tracing/#benchmark>Benchmark</a><li><a href=https://blog.ymgyt.io/entry/produce-measurement-with-attributes-from-tracing/#flamegraph>Flamegraph</a><li><a href=https://blog.ymgyt.io/entry/produce-measurement-with-attributes-from-tracing/#matome>ã¾ã¨ã‚</a></ul></nav></aside><div class=entry-content><p>ä»Šã„ã‚‹<a href=https://fraim.co.jp/ rel=external>FRAIM</a>ã¨ã„ã†ä¼šç¤¾ã§ã¯<a href=https://opentelemetry.io/ rel=external>OpenTelemetry</a>ã®å°å…¥ã‚’é€²ã‚ã¦ã„ã¾ã™ã€‚<br> Backendã¯Rustã§æ›¸ã‹ã‚Œã¦ãŠã‚Šã€Applicationã‹ã‚‰å‡ºåŠ›ã™ã‚‹Metricsã«é–¢ã—ã¦ã‚‚<a href=https://opentelemetry.io/ rel=external>OpenTelemetry</a>ã®<a href=https://github.com/open-telemetry/opentelemetry-specification/tree/v1.24.0/specification/metrics rel=external>Metrics</a>ã‚’åˆ©ç”¨ã—ãŸã„ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚<br> æ—¢ã«<a href=https://github.com/tokio-rs/tracing rel=external>tracing</a>ã‚’å°å…¥ã—ã¦ã„ã‚‹ã®ã§ã€<a href=https://github.com/tokio-rs/tracing-opentelemetry rel=external>tracing-opentelemetry</a>ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§Applicationã«<a href=https://github.com/open-telemetry/opentelemetry-specification/tree/v1.24.0/specification/metrics rel=external>Metrics</a>ã‚’çµ„ã¿è¾¼ã‚ãªã„ã‹æ¤œè¨ã—ã¦ã„ã¾ã—ãŸã€‚<br> ãã®éš›ã«å¿…è¦ãªæ©Ÿèƒ½ãŒã‚ã£ãŸã®ã§<a href=https://github.com/tokio-rs/tracing-opentelemetry/pull/43 rel=external>PR</a>ã‚’<a href=https://github.com/tokio-rs/tracing-opentelemetry rel=external>tracing-opentelemetry</a>ã«é€ã£ãŸã¨ã“ã‚ãƒãƒ¼ã‚¸ã—ã¦ã‚‚ã‚‰ãˆã¾ã—ãŸã€‚<br> æœ¬è¨˜äº‹ã§ã¯ãã®éš›ã«è€ƒãˆãŸã“ã¨ã‚„å­¦ã³ã«ã¤ã„ã¦æ›¸ã„ã¦ã„ãã¾ã™ã€‚<h1 id=tl-dr><a aria-label="Anchor link for: tl-dr" class=zola-anchor href=#tl-dr>TL;DR</a></h1><p>Rustã®applicationã§<a href=https://opentelemetry.io/ rel=external>OpenTelemetry</a>ã®<a href=https://github.com/open-telemetry/opentelemetry-specification/tree/v1.24.0/specification/metrics rel=external>Metrics</a>ã‚’<a href=https://github.com/tokio-rs/tracing rel=external>tracing</a>ã‹ã‚‰å‡ºåŠ›ã™ã‚‹ãŸã‚ã«<a href=https://github.com/tokio-rs/tracing-opentelemetry rel=external>tracing-opentelemetry</a>ã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ã€‚<br> ãã®éš›ã«<a href=https://github.com/open-telemetry/opentelemetry-specification/tree/v1.24.0/specification/common#attribute rel=external>Attribute</a>ã‚’<a href=https://github.com/open-telemetry/opentelemetry-specification/tree/v1.24.0/specification/metrics rel=external>Metrics</a>ã«é–¢é€£ã¥ã‘ã‚‹<a href=https://www.cncf.io/blog/2023/08/03/streamlining-observability-the-journey-towards-query-language-standardization/ rel=external>æ©Ÿèƒ½</a>ãŒå¿…è¦ã ã£ãŸã®ã§ã€<a href=https://github.com/tokio-rs/tracing/tree/tracing-subscriber-0.3.17/tracing-subscriber rel=external>tracing-subscriber</a>ã®<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/layer/index.html#per-layer-filtering rel=external>Per-Layer Filtering</a>ã‚’åˆ©ç”¨ã—ã¦<a href=https://github.com/tokio-rs/tracing-opentelemetry/pull/43 rel=external>å®Ÿè£…</a>ã—ãŸã€‚<h1 id=qian-ti><a aria-label="Anchor link for: qian-ti" class=zola-anchor href=#qian-ti>å‰æ</a></h1><p>ã¾ãšå‰æã¨ã—ã¦<a href=https://github.com/tokio-rs/tracing-opentelemetry rel=external>tracing-opentelemetry</a>ã®<a href=https://docs.rs/tracing-opentelemetry/0.20.0/tracing_opentelemetry/struct.MetricsLayer.html rel=external><code>MetricsLayer</code></a>ã‚’åˆ©ç”¨ã™ã‚‹ã¨ã€<a href=https://github.com/tokio-rs/tracing rel=external>tracing</a>ã®<a href=https://docs.rs/tracing/0.1.37/tracing/struct.Event.html rel=external><code>Event</code></a>ã‚’åˆ©ç”¨ã—ã¦<a href=https://opentelemetry.io/ rel=external>OpenTelemetry</a>ã®<a href=https://github.com/open-telemetry/opentelemetry-specification/tree/v1.24.0/specification/metrics rel=external>Metrics</a>ã‚’å‡ºåŠ›ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚<br> ä¾‹ãˆã°<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>let</span><span> provider</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> MeterProvider</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>builder</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>build</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span>tracing_subscriber</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>registry</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>with</span><span style=color:#eceff4>(</span><span>MetricsLayer</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>provider</span><span style=color:#eceff4>))</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>init</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>tracing</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0;font-weight:700>info!</span><span style=color:#eceff4>(</span><span>monotonic_counter</span><span style=color:#81a1c1>.</span><span>foo </span><span style=color:#81a1c1>=</span><span style=color:#b48ead> 1</span><span style=color:#eceff4>);</span></span></code></pre><p>ã¨ã™ã‚‹ã¨ã€<code>foo</code> <a href=https://github.com/open-telemetry/opentelemetry-specification/blob/v1.24.0/specification/metrics/api.md#counter rel=external>Counter</a>ã‚’incrementã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚<p><a href=https://github.com/tokio-rs/tracing-opentelemetry rel=external>tracing-opentelemetry</a>ã®versionã¯<code>0.20.0</code>ã§ã™ã€‚ ãã®ä»–ã®é–¢é€£crateã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=toml><span class=giallo-l><span style=color:#eceff4>[</span><span>dependencies</span><span style=color:#eceff4>]</span></span>
<span class=giallo-l><span>opentelemetry</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>0.20.0</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span>tracing</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>0.1.35</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span>tracing-subscriber</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>0.3.0</span><span style=color:#eceff4>"</span></span></code></pre><h1 id=prdeshi-zhuang-sitaji-neng-nogai-yao><a aria-label="Anchor link for: prdeshi-zhuang-sitaji-neng-nogai-yao" class=zola-anchor href=#prdeshi-zhuang-sitaji-neng-nogai-yao>PRã§å®Ÿè£…ã—ãŸæ©Ÿèƒ½ã®æ¦‚è¦</a></h1><p><a href=https://github.com/tokio-rs/tracing rel=external>tracing</a>ã‹ã‚‰<a href=https://github.com/open-telemetry/opentelemetry-specification/tree/v1.24.0/specification/metrics rel=external>Metrics</a>ã‚’å‡ºåŠ›ã™ã‚‹éš›ã«ã€<a href=https://github.com/open-telemetry/opentelemetry-specification/tree/v1.24.0/specification/common#attribute rel=external>Attribute</a>ã‚’ä»˜ä¸ã§ããªã„ã¨ã„ã£ãŸåˆ¶ç´„ãŒã‚ã‚Šã¾ã—ãŸã€‚ <a href=https://github.com/open-telemetry/opentelemetry-specification/tree/v1.24.0/specification/common#attribute rel=external>Attribute</a>ã¨ã¯ã€<a href=https://opentelemetry.io/ rel=external>OpenTelemetry</a>ã«ãŠã‘ã‚‹key valueã®ãƒšã‚¢ã§ã™ã€‚<p>ä¾‹ãˆã°<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span>tracing</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0;font-weight:700>info!</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>  monotonic_counter</span><span style=color:#81a1c1>.</span><span>request_count </span><span style=color:#81a1c1>=</span><span style=color:#b48ead> 1</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>  http</span><span style=color:#81a1c1>.</span><span>route </span><span style=color:#81a1c1>=</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>/foo</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span>  http</span><span style=color:#81a1c1>.</span><span>response</span><span style=color:#81a1c1>.</span><span>status_code </span><span style=color:#81a1c1>=</span><span style=color:#b48ead> 200</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>);</span></span></code></pre><p>ã¨ã—ãŸå ´åˆã«ã€<code>request_count</code> <a href=https://github.com/open-telemetry/opentelemetry-specification/blob/v1.24.0/specification/metrics/api.md#counter rel=external>Counter</a>ã¯å‡ºåŠ›ã•ã‚Œã‚‹ã®ã§ã™ãŒã€<code>http.route="/foo"</code>ã‚„<code>http.response.sattus_code=200</code>ã¨ã„ã£ãŸæƒ…å ±ã‚’metricsã«ä»˜ä¸ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚<br> ã“ã®ç‚¹ã«ã¤ã„ã¦ã¯ã€<a href=https://github.com/tokio-rs/tracing-opentelemetry/issues/32 rel=external>feature requestã®issue</a>ã‚‚ä¸ŠãŒã£ã¦ãŠã‚Šã€<a href=https://docs.rs/tracing-opentelemetry/0.20.0/tracing_opentelemetry/struct.MetricsLayer.html rel=external><code>MetricsLayer</code></a>ã«<a href=https://docs.rs/tracing/0.1.37/tracing/struct.Event.html rel=external><code>Event</code></a>ã®key valueã‚’metricsã«ç´ä»˜ã‘ã‚‹æ©Ÿèƒ½ãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆã•ã‚Œã¦ã„ã¾ã—ãŸã€‚<br> ã“ã®æ©Ÿèƒ½ã«ã¤ã„ã¦ã¯è‡ªåˆ†ã‚‚å¿…è¦ã ã£ãŸã®ã§ã€ã‚„ã£ã¦ã¿ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚<h1 id=metricslayernoshi-zu-mi><a aria-label="Anchor link for: metricslayernoshi-zu-mi" class=zola-anchor href=#metricslayernoshi-zu-mi><a href=https://docs.rs/tracing-opentelemetry/0.20.0/tracing_opentelemetry/struct.MetricsLayer.html rel=external><code>MetricsLayer</code></a>ã®ä»•çµ„ã¿</a></h1><p>ã¾ãš<a href=https://docs.rs/tracing-opentelemetry/0.20.0/tracing_opentelemetry/struct.MetricsLayer.html rel=external><code>MetricsLayer</code></a>ã®ä»•çµ„ã¿ã«ã¤ã„ã¦ã¿ã¦ã„ãã¾ã™ã€‚<br> <a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/layer/trait.Layer.html rel=external><code>tracing_subscriber::layer::Layer</code></a> traitã‚’å®Ÿè£…ã—ã¦ã€tracing-subscriberã¨composeã™ã‚‹ã“ã¨ã§ã€Userã¯<a href=https://docs.rs/tracing/0.1.37/tracing/struct.Event.html rel=external><code>Event</code></a>ã®å„ç¨®lifecycleæ™‚ã«ä»»æ„ã®å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚<br> ä¾‹ãˆã°ã€<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/layer/trait.Layer.html#method.on_event rel=external><code>on_event()</code></a>ã¯<code>tracing::info!()</code>ç­‰ã§<a href=https://docs.rs/tracing/0.1.37/tracing/struct.Event.html rel=external><code>Event</code></a>ãŒä½œæˆã•ã‚ŒãŸéš›ã«å‘¼ã°ã‚Œã¾ã™ã€‚ tracing/tracing-subscriberã®è©³ç´°ãªä»•çµ„ã¿ã«ã¤ã„ã¦ã¯ä»¥å‰<a href=https://blog.ymgyt.io/entry/how-tracing-and-tracing-subscriber-write-events/ rel=external>ãƒ–ãƒ­ã‚°</a>ã«æ›¸ã„ãŸã®ã§ã‚ˆã‘ã‚Œã°èª­ã‚“ã§ã¿ã¦ãã ã•ã„ã€‚<br> <a href=https://docs.rs/tracing-opentelemetry/0.20.0/tracing_opentelemetry/struct.MetricsLayer.html rel=external><code>MetricsLayer</code></a>ã¯Spanã‚’å‡¦ç†ã—ãªã„ã®ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ã«<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/layer/trait.Layer.html#method.on_event rel=external><code>on_event()</code></a>ã®ã¿ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Layer</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>></span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> MetricsLayer</span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    S</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Subscriber</span><span style=color:#81a1c1> + for</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>span</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> LookupSpan</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>span</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> on_event</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> event</span><span style=color:#81a1c1>: &</span><span>tracing</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Event</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>,</span><span> _ctx</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Context</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> metric_visitor</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> MetricVisitor</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            instruments</span><span style=color:#81a1c1>: &self.</span><span>instruments</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            meter</span><span style=color:#81a1c1>: &self.</span><span>meter</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>        };</span></span>
<span class=giallo-l><span>        event</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>record</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut</span><span> metric_visitor</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing-opentelemetry/blob/d9b18f2aeddbab1b26c2794503a2c6423a2426e0/src/metrics.rs#L346 rel=external>source</a><br> <code>S: Subscriber + for&lt;'span> LookupSpan&lt;'span></code>ã¨ã—ã¦<code>Layer&lt;S></code>ã§Layerã«æ¸¡ã—ã¦ã„ã‚‹<code>S</code>ã¯LayerãŒtracing_subscriberã®<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/registry/struct.Registry.html rel=external><code>Registry</code></a>ã«composeã•ã‚Œã‚‹ã“ã¨ã‚’è¡¨ç¾ã—ã¦ãŠã‚Šã€ã“ã‚Œã«ã‚ˆã£ã¦Eventå‡¦ç†æ™‚ã«ä»Šã„ã‚‹Spanã®æƒ…å ±ã‚’åˆ©ç”¨ã§ãã¾ã™ã€‚ãŒã€ä»Šå›ã¯ç‰¹ã«åˆ©ç”¨ã—ãªã„ã®ã§æ°—ã«ã—ãªãã¦å¤§ä¸ˆå¤«ã§ã™ã€‚<br> <a href=https://github.com/tokio-rs/tracing rel=external>tracing</a>ã¯<a href=https://docs.rs/tracing/0.1.37/tracing/struct.Event.html rel=external><code>Event</code></a>ã«æ ¼ç´ã•ã‚ŒãŸ<a href=https://docs.rs/tracing/0.1.37/tracing/field/struct.Field.html rel=external><code>Field</code></a>ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹æ‰‹æ®µã¨ã—ã¦<a href=https://docs.rs/tracing/0.1.37/tracing/field/trait.Visit.html rel=external><code>Visit</code></a> traitã‚’ç”¨æ„ã—ã¦ãã‚Œã¦ã„ã¾ã™ã€‚<br> ã“ã®ä»•çµ„ã¿ã«ã‚ˆã‚Šã€<code>tracing::info!(key = "foo")</code>ã®ã‚ˆã†ã«strå‹ã®fieldã‚’ä½¿ã†ã¨ã€<a href=https://github.com/tokio-rs/tracing rel=external>tracing</a>å´ã§ã€<code>Visit::record_str()</code>ã‚’å‘¼ã‚“ã§ãã‚Œã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Visit</span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> MetricVisitor</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> record_debug</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> _field</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Field</span><span style=color:#eceff4>,</span><span> _value</span><span style=color:#81a1c1>: &dyn</span><span> fmt</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Debug</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#616e88>        // Do nothing</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> record_u64</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> field</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Field</span><span style=color:#eceff4>,</span><span> value</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> u64</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#616e88>      /* ... */</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> record_f64</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> field</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Field</span><span style=color:#eceff4>,</span><span> value</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> f64</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#616e88>      /* ... */</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> record_i64</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> field</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Field</span><span style=color:#eceff4>,</span><span> value</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> i64</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#616e88>      /* ...*/</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing-opentelemetry/blob/d9b18f2aeddbab1b26c2794503a2c6423a2426e0/src/metrics.rs#L136 rel=external>source</a><p><code>MetricVisitor</code>ã§ã‚‚ã“ã®ã‚ˆã†ã«<code>Visit</code>ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚<br> <a href=https://github.com/open-telemetry/opentelemetry-specification/tree/v1.24.0/specification/metrics rel=external>Metrics</a>ã¯æ•°å€¤ãªã®ã§ã€<code>record_bool()</code>ã‚„<code>record_str()</code>ã¯å®Ÿè£…ã•ã‚Œã¦ã„ãªã„ã“ã¨ã‚‚ã‚ã‹ã‚Šã¾ã™ã€‚<br> ã•ã‚‰ã«å‡¦ç†ã‚’è¿½ã£ã¦ã„ãã¾ã™ã€‚ä¾‹ã¨ã—ã¦ã€<code>record_i64()</code>ã‚’ã¿ã¦ã¿ã‚‹ã¨<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>const</span><span> METRIC_PREFIX_MONOTONIC_COUNTER</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>str</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>monotonic_counter.</span><span style=color:#eceff4>";</span></span>
<span class=giallo-l><span style=color:#81a1c1>const</span><span> METRIC_PREFIX_COUNTER</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>str</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>counter.</span><span style=color:#eceff4>";</span></span>
<span class=giallo-l><span style=color:#81a1c1>const</span><span> METRIC_PREFIX_HISTOGRAM</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>str</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>histogram.</span><span style=color:#eceff4>";</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Layer</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>></span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> MetricsLayer</span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    S</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Subscriber</span><span style=color:#81a1c1> + for</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>span</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> LookupSpan</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>span</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> record_i64</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> field</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Field</span><span style=color:#eceff4>,</span><span> value</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> i64</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>metric_name</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> field</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>name</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>strip_prefix</span><span style=color:#eceff4>(</span><span>METRIC_PREFIX_MONOTONIC_COUNTER</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            self.</span><span>instruments</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>update_metric</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span>meter</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>                InstrumentType</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>CounterU64</span><span style=color:#eceff4>(</span><span>value</span><span style=color:#81a1c1> as</span><span style=color:#8fbcbb> u64</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span>                metric_name</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>            );</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span><span style=color:#81a1c1> else if let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>metric_name</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> field</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>name</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>strip_prefix</span><span style=color:#eceff4>(</span><span>METRIC_PREFIX_COUNTER</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>          self.</span><span>instruments</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>update_metric</span><span style=color:#eceff4>(</span><span style=color:#616e88>/* ... */</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span><span style=color:#81a1c1> else if let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>metric_name</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> field</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>name</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>strip_prefix</span><span style=color:#eceff4>(</span><span>METRIC_PREFIX_HISTOGRAM</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>          self.</span><span>instruments</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>update_metric</span><span style=color:#eceff4>(</span><span style=color:#616e88>/* ... */</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing-opentelemetry/blob/d9b18f2aeddbab1b26c2794503a2c6423a2426e0/src/metrics.rs#L194C4-L194C4 rel=external>source</a><p>ã¨ãªã£ã¦ãŠã‚Šã€fieldåã«<a href=https://docs.rs/tracing-opentelemetry/0.20.0/tracing_opentelemetry/struct.MetricsLayer.html rel=external><code>MetricsLayer</code></a>ãŒå‡¦ç†ã®å¯¾è±¡ã¨ã™ã‚‹prefix(<code>monotonic_counter,counter,histogram</code>)ãŒåˆ©ç”¨ã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ã€<code>self.instruments.update_metric()</code>ã§metricsã®å‡¦ç†ã‚’å®Ÿæ–½ã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚<h2 id=instrumentsnoshi-zu-mi><a aria-label="Anchor link for: instrumentsnoshi-zu-mi" class=zola-anchor href=#instrumentsnoshi-zu-mi><a href=https://github.com/tokio-rs/tracing-opentelemetry/blob/d9b18f2aeddbab1b26c2794503a2c6423a2426e0/src/metrics.rs#L17 rel=external><code>Instruments</code></a>ã®ä»•çµ„ã¿</a></h2><p>ã¨ã„ã†ã‚ã‘ã§æ¬¡ã«<a href=https://github.com/tokio-rs/tracing-opentelemetry/blob/d9b18f2aeddbab1b26c2794503a2c6423a2426e0/src/metrics.rs#L17 rel=external><code>Instruments</code></a>ã«ã¤ã„ã¦è¦‹ã¦ã„ãã¾ã™ã€‚<a href=https://github.com/tokio-rs/tracing-opentelemetry/blob/d9b18f2aeddbab1b26c2794503a2c6423a2426e0/src/metrics.rs#L17 rel=external><code>Instruments</code></a>ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> opentelemetry</span><span style=color:#81a1c1>::</span><span>metrics</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>Counter</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Histogram</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Meter</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> MeterProvider</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> UpDownCounter</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>type</span><span style=color:#8fbcbb> MetricsMap</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>></span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> RwLock</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>HashMap</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>&</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>static str</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> T</span><span style=color:#eceff4>>>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Default</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>crate</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> struct</span><span style=color:#8fbcbb> Instruments</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    u64_counter</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> MetricsMap</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Counter</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>u64</span><span style=color:#eceff4>>>,</span></span>
<span class=giallo-l><span>    f64_counter</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> MetricsMap</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Counter</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>f64</span><span style=color:#eceff4>>>,</span></span>
<span class=giallo-l><span>    i64_up_down_counter</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> MetricsMap</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>UpDownCounter</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>i64</span><span style=color:#eceff4>>>,</span></span>
<span class=giallo-l><span>    f64_up_down_counter</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> MetricsMap</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>UpDownCounter</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>f64</span><span style=color:#eceff4>>>,</span></span>
<span class=giallo-l><span>    u64_histogram</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> MetricsMap</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Histogram</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>u64</span><span style=color:#eceff4>>>,</span></span>
<span class=giallo-l><span>    i64_histogram</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> MetricsMap</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Histogram</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>i64</span><span style=color:#eceff4>>>,</span></span>
<span class=giallo-l><span>    f64_histogram</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> MetricsMap</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Histogram</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>f64</span><span style=color:#eceff4>>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing-opentelemetry/blob/d9b18f2aeddbab1b26c2794503a2c6423a2426e0/src/metrics.rs#L17 rel=external>source</a><p><a href=https://github.com/open-telemetry/opentelemetry-specification/tree/v1.24.0/specification/metrics rel=external>Metrics</a>ã®ç¨®åˆ¥(<a href=https://github.com/open-telemetry/opentelemetry-specification/blob/v1.24.0/specification/metrics/api.md#instrument rel=external>Instrument</a>)ã”ã¨ã«metricsåã¨metricsã®å®Ÿè£…(<code>Counter</code>ç­‰)ã‚’<code>HashMap</code>ã§ä¿æŒã—ã¦ã„ã¾ã™ã€‚<br> <code>opentelemetry::metrics</code>ã‹ã‚‰åˆ©ç”¨ã—ã¦ã„ã‚‹ã€<code>{Counter, UpDownCounter, Histogram}</code>ã¯metricsã®å®Ÿè£…ã§ã™ã€‚<br> <code>opentelemetry_{api,sdk}</code> crateã§metricsãŒã©ã†å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‹ã«ã¤ã„ã¦ã‚‚æ›¸ããŸã„ã®ã§ã™ãŒã‹ãªã‚Šè¤‡é›‘ãªã®ã§ã€ä»Šå›ã¯ãµã‚Œã¾ã›ã‚“ã€‚<br> (ä»¥ä¸‹ã¯Metricsé–¢é€£ã®å‡¦ç†ã‚’èª­ã‚“ã§ã„ã¦ã€metricsãŒç”Ÿæˆã•ã‚Œã¦ã‹ã‚‰exportã•ã‚Œã‚‹ã¾ã§ã®æµã‚Œã‚’è¿½ã†éš›ã®ãƒ¡ãƒ¢ã§ã™)<p><img alt="metrics pipeline" src=https://storage.googleapis.com/zenn-user-upload/99fd1a21adc4-20230813.png> <em>Metricsã®ç”Ÿæˆã‹ã‚‰exportã¾ã§ã®æµã‚Œ</em><p><img alt="opentelemetry metrics overview" src=https://storage.googleapis.com/zenn-user-upload/2489bfdb2dcc-20230813.png> <em>Metricsé–¢é€£ã®structã®é–¢ä¿‚</em><p><code>Counter</code>ã¯ãƒ¡ãƒ¢ãƒªã«ç¾åœ¨ã®å€¤ã‚’ä¿æŒã—ã¦ã€incrementã—ã¤ã¤ã€å®šæœŸçš„ã«exportã—ã¦ã„ãã ã‘ãªã®ã§ã‚·ãƒ³ãƒ—ãƒ«ã‹ã¨è€ƒãˆã¦ã„ãŸã®ã§ã™ãŒæ€ã£ãŸã‚ˆã‚Šè‰²ã€…ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒé–¢ä¸ã—ã¦ã„ã¾ã—ãŸã€‚<br> ãªã®ã§æœ¬è¨˜äº‹ã§ã¯<code>Counter::add()</code>ã—ãŸã‚‰ã€<a href=https://github.com/open-telemetry/opentelemetry-specification/tree/v1.24.0/specification/metrics rel=external>Metrics</a>ãŒå‡ºåŠ›ã•ã‚Œã‚‹ãã‚‰ã„ã®ç†è§£ã§ã„ãã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> opentelemetry</span><span style=color:#81a1c1>::</span><span>metrics</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Meter</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>type</span><span style=color:#8fbcbb> MetricsMap</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>></span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> RwLock</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>HashMap</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>&</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>static str</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> T</span><span style=color:#eceff4>>>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Instruments</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>crate</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> fn</span><span style=color:#88c0d0> update_metric</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#81a1c1>        &self</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        meter</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Meter</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        instrument_type</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> InstrumentType</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        metric_name</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>static str</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    ) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        fn</span><span style=color:#88c0d0> update_or_insert</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>>(</span></span>
<span class=giallo-l><span>            map</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>MetricsMap</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>            name</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>static str</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            insert</span><span style=color:#81a1c1>: impl</span><span style=color:#88c0d0> FnOnce</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> T</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            update</span><span style=color:#81a1c1>: impl</span><span style=color:#88c0d0> FnOnce</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>        ) {</span></span>
<span class=giallo-l><span style=color:#eceff4>            {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                let</span><span> lock</span><span style=color:#81a1c1> =</span><span> map</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>read</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>                if let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>metric</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> lock</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>get</span><span style=color:#eceff4>(</span><span>name</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#88c0d0>                    update</span><span style=color:#eceff4>(</span><span>metric</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    return</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>            // that metric did not already exist, so we have to acquire a write lock to</span></span>
<span class=giallo-l><span style=color:#616e88>            // create it.</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let mut</span><span> lock</span><span style=color:#81a1c1> =</span><span> map</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#616e88>            // handle the case where the entry was created while we were waiting to</span></span>
<span class=giallo-l><span style=color:#616e88>            // acquire the write lock</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let</span><span> metric</span><span style=color:#81a1c1> =</span><span> lock</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>entry</span><span style=color:#eceff4>(</span><span>name</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>or_insert_with</span><span style=color:#eceff4>(</span><span>insert</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#88c0d0>            update</span><span style=color:#eceff4>(</span><span>metric</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        match</span><span> instrument_type</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            InstrumentType</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>CounterU64</span><span style=color:#eceff4>(</span><span>value</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0>                update_or_insert</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    &self.</span><span>u64_counter</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>                    metric_name</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    ||</span><span> meter</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>u64_counter</span><span style=color:#eceff4>(</span><span>metric_name</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>init</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    |</span><span>ctr</span><span style=color:#81a1c1>|</span><span> ctr</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>add</span><span style=color:#eceff4>(</span><span>value</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> &</span><span style=color:#eceff4>[]),</span></span>
<span class=giallo-l><span style=color:#eceff4>                );</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#616e88>            /* ...*/</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing-opentelemetry/blob/d9b18f2aeddbab1b26c2794503a2c6423a2426e0/src/metrics.rs#L40 rel=external>source</a><p><a href=https://docs.rs/tracing-opentelemetry/0.20.0/tracing_opentelemetry/struct.MetricsLayer.html rel=external><code>MetricsLayer</code></a>ãŒmetricsã‚’å‡¦ç†ã™ã‚‹éš›ã«ã‚ˆã°ã‚Œã‚‹<code>self.instruments.update_metric()</code>ã¯ä¸Šè¨˜ã®ã‚ˆã†ãªå‡¦ç†ã¨ãªã£ã¦ã„ã¾ã™ã€‚æ¦‚ã­ä»¥ä¸‹ã®ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚<ul><li>æ¯å›<code>RwLock::read()</code>ã«ã‚ˆã‚‹lockãŒç™ºç”Ÿã™ã‚‹<li>åˆå›ã¯<code>Meter</code>ã«ã‚ˆã‚‹Instrument(Counterç­‰)ã®ç”Ÿæˆå‡¦ç†ãŒå®Ÿè¡Œã•ã‚Œã‚‹<li><code>Counter::add()</code>ã™ã‚‹éš›ã®ç¬¬äºŒå¼•æ•°ã«ã¯ç©ºsliceãŒæ¸¡ã•ã‚Œã¦ã„ã‚‹(ä»Šå›ã®å¤‰æ›´ç‚¹ã«é–¢é€£ã™ã‚‹)</ul><p>ã“ã®å‡¦ç†ã‚’ç¢ºèªã—ãŸã“ã¨ã§ã€<a href=https://docs.rs/tracing-opentelemetry/0.20.0/tracing_opentelemetry/struct.MetricsLayer.html rel=external><code>MetricsLayer</code></a>ã®documentã®èª¬æ˜ãŒã‚ˆã‚Šç†è§£ã§ãã¾ã™ã€‚<br> ä¾‹ãˆã°<blockquote><p>No configuration is needed for this Layer, as it's only responsible for pushing data out to the <code>opentelemetry</code> family of crates.</blockquote><p>ã¨ã‚ã‚‹ã‚ˆã†ã«<a href=https://docs.rs/tracing-opentelemetry/0.20.0/tracing_opentelemetry/struct.MetricsLayer.html rel=external><code>MetricsLayer</code></a>ã¯ç‰¹ã«å®Ÿè³ªçš„ãªå‡¦ç†ã‚’è¡Œã£ã¦ãŠã‚‰ãš<a href=https://github.com/tokio-rs/tracing-opentelemetry rel=external>tracing-opentelemetry</a>ã¨ã„ã†crateåã®é€šã‚Šã€tracingã¨opentelemetryã®ecosystemã‚’ã¤ãªãå½¹å‰²ã®ã¿ã‚’æ‹…ã£ã¦ã„ã¾ã™ã€‚<br> ã¾ãŸ<blockquote><p># Implementation Details <code>MetricsLayer</code> holds a set of maps, with each map corresponding to a type of metric supported by OpenTelemetry. These maps are populated lazily. The first time that a metric is emitted by the instrumentation, a <code>Metric</code> instance will be created and added to the corresponding map. This means that any time a metric is emitted by the instrumentation, one map lookup has to be performed. In the future, this can be improved by associating each <code>Metric</code> instance to its callsite, eliminating the need for any maps.</blockquote><p>(æ„è¨³: <code>MetricLayer</code>ã¯OpenTelemetryã§ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹metricã®ç¨®åˆ¥ã”ã¨ã«mapã‚’ä¿æŒã—ã¦ã„ã‚‹ã€‚metricsãŒå‡ºåŠ›ã•ã‚Œã‚‹éš›ã«<code>Metric</code>ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒç”Ÿæˆã•ã‚Œã€ã“ã‚Œã‚‰ã®mapã«è¿½åŠ ã•ã‚Œã‚‹ã€‚ã“ã‚Œã¯metricsãŒå‡ºåŠ›ã•ã‚Œã‚‹ãŸã³ã«mapã®lookupãŒå®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã‚’æ„å‘³ã™ã‚‹ã€‚å°†æ¥çš„ã«ã¯<code>Metric</code>ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’callsiteã«ç´ä»˜ã‘ã‚‹ã“ã¨ã§mapãŒå¿…è¦ãªããªã‚Šæ”¹å–„ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã€‚) ã¨ã„ã†èª¬æ˜ã‚‚ãªã‚‹ã»ã©ã¨ç†è§£ã§ãã¾ã™ã€‚<br> ã¡ãªã¿ã«callsiteã¨ã„ã†ã®ã¯ã€<code>tracing::info!()</code> macroå‘¼ã³å‡ºã—æ™‚ã«staticã§ç”Ÿæˆã•ã‚Œã‚‹macroå‘¼ã³å‡ºã—æ™‚ã®æƒ…å ±ã‚’æŒ‡ã—ã¦ã„ã¾ã™ã€‚<p>ã¨ã„ã†ã‚ã‘ã§ã€<a href=https://docs.rs/tracing-opentelemetry/0.20.0/tracing_opentelemetry/struct.MetricsLayer.html rel=external><code>MetricsLayer</code></a>ãŒmetricsã‚’å‡ºåŠ›ã™ã‚‹æ–¹æ³•ã®æ¦‚è¦ãŒç†è§£ã§ãã¾ã—ãŸã€‚<h1 id=ji-neng-wozhui-jia-surushang-denowen-ti-dian><a aria-label="Anchor link for: ji-neng-wozhui-jia-surushang-denowen-ti-dian" class=zola-anchor href=#ji-neng-wozhui-jia-surushang-denowen-ti-dian>æ©Ÿèƒ½ã‚’è¿½åŠ ã™ã‚‹ä¸Šã§ã®å•é¡Œç‚¹</a></h1><p>ã¾ãšä»Šå›è¿½åŠ ã—ãŸã„æ©Ÿèƒ½ã‚’æ•´ç†ã—ã¾ã™ã€‚<br> <a href=https://github.com/open-telemetry/opentelemetry-specification/blob/v1.24.0/specification/metrics/api.md#counter-operations rel=external>Counterã«é–¢ã™ã‚‹ä»•æ§˜</a>ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å®šã‚ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚<blockquote><p>Counter operations Add This API MUST accept the following parameter: * A numeric increment value. * Attributes to associate with the increment value.<br> Users can provide attributes to associate with the increment value, but it is up to their discretion. Therefore, this API MUST be structured to accept a variable number of attributes, including none.</blockquote><p>ã¨ã—ã¦ã€Counterã‚’incrementã™ã‚‹éš›ã«<a href=https://github.com/open-telemetry/opentelemetry-specification/tree/v1.24.0/specification/common#attribute rel=external>Attributes</a>ã‚’æ¸¡ã›ãªã‘ã‚Œã°ãªã‚‰ãªã„ã¨ã•ã‚Œã¦ã„ã¾ã™ã€‚<br> ã“ã‚Œã‚’å—ã‘ã¦ã€Rustã®OpenTelemetryã®å®Ÿè£…ã§ã‚‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Counter</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#616e88>    /// Records an increment to the counter.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> add</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> value</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> T</span><span style=color:#eceff4>,</span><span> attributes</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>[</span><span style=color:#8fbcbb>KeyValue</span><span style=color:#eceff4>]) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span style=color:#b48ead>0</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>add</span><span style=color:#eceff4>(</span><span>value</span><span style=color:#eceff4>,</span><span> attributes</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/open-telemetry/opentelemetry-rust/blob/dfeac078ff7853e7dc814778524b93470dfa5c9c/opentelemetry-api/src/metrics/instruments/counter.rs#L28 rel=external>source</a><p>ã®ã‚ˆã†ã«incrementæ™‚ã«attributeã¨ã—ã¦ã€<a href=https://docs.rs/opentelemetry/latest/opentelemetry/struct.KeyValue.html rel=external><code>KeyValue</code></a>ã‚’æ¸¡ã›ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚<br> ã¨ã„ã†ã“ã¨ã§ã€è¿½åŠ ã—ãŸã„æ©Ÿèƒ½ã¯<a href=https://docs.rs/tracing-opentelemetry/0.20.0/tracing_opentelemetry/struct.MetricsLayer.html rel=external><code>MetricsLayer</code></a>ã§<a href=https://docs.rs/opentelemetry/latest/opentelemetry/struct.KeyValue.html rel=external><code>KeyValue</code></a>ã‚’ä½œã£ã¦ã€<code>Counter:add()</code>æ™‚ã«æ¸¡ã›ã°è‰¯ã•ãã†ã§ã™ã€‚<br> ãã‚“ãªã«é›£ã—ããªã•ãã†ã¨æ€ã„ã€æ•°è¡Œã®å¤‰æ›´ã§ã„ã‘ã‚‹ã®ã§ã¯ã¨æ€ã£ã¦ã„ã¾ã—ãŸã€‚<h2 id=visitorpatantoxiang-xing-gae-i><a aria-label="Anchor link for: visitorpatantoxiang-xing-gae-i" class=zola-anchor href=#visitorpatantoxiang-xing-gae-i>Visitorãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ç›¸æ€§ãŒæ‚ªã„</a></h2><p>ç€æ‰‹ã—ã¦ã‚ã‹ã£ãŸã“ã¨ã§ã™ãŒã€<code>Counter::add()</code>å‘¼ã³å‡ºã—æ™‚ã«metrics(<code>counter.foo</code>)ä»¥å¤–ã®fieldã‚’<a href=https://docs.rs/opentelemetry/latest/opentelemetry/struct.KeyValue.html rel=external><code>KeyValue</code></a>ã«å¤‰æ›ã—ã¦æ¸¡ã™ã¨ã„ã†ã®ã¯Visitorãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ç›¸æ€§ãŒæ‚ªã„ã¨ã„ã†ã“ã¨ã§ã—ãŸã€‚<br> ã¨ã„ã†ã®ã‚‚ã€ä¾‹ãˆã°ä»¥ä¸‹ã®ã‚ˆã†ãª<a href=https://docs.rs/tracing/0.1.37/tracing/struct.Event.html rel=external><code>Event</code></a>ã‚’è€ƒãˆã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span>tracing</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0;font-weight:700>info!</span><span style=color:#eceff4>(</span><span>monotonic_counter</span><span style=color:#81a1c1>.</span><span>foo </span><span style=color:#81a1c1>=</span><span style=color:#b48ead> 1</span><span style=color:#eceff4>,</span><span> bar</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>baz</span><span style=color:#eceff4>",</span><span> qux</span><span style=color:#81a1c1> =</span><span style=color:#b48ead> 2</span><span style=color:#eceff4>)</span></span></code></pre><p>ã“ã®<a href=https://docs.rs/tracing/0.1.37/tracing/struct.Event.html rel=external><code>Event</code></a>ã‚’å‡¦ç†ã™ã‚‹éš›ã€ã•ãã»ã©ã¿ãŸ<code>MetricVisitor</code>ã¯<code>monotonic_counter.foo</code>ã‚’å‡¦ç†ã™ã‚‹éš›ã¯ã¾ã ã€<code>bar,qux</code> fieldã‚’å‡¦ç†ã—ã¦ã„ãªã„ã®ã§ã€<code>Counter::add()</code>ã‚’å‘¼ã³å‡ºã›ãªã„ã¨ã„ã†ã“ã¨ã§ã™ã€‚<br> ãã®ãŸã‚ã€visitæ™‚ã«å¯¾è±¡ã®fieldãŒå‡¦ç†å¯¾è±¡ãªã‚‰å‡¦ç†ã™ã‚‹ã®ã§ã¯ãªãã€ä¸€åº¦ã€ã™ã¹ã¦ã®fieldã®visitã‚’å®Œäº†ã•ã›ãŸã®ã¡ã«ã€<code>Counter::add()</code>ã‚’å‘¼ã³å‡ºã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ ãã†ãªã‚‹ã¨ã€visitæ™‚ã«<code>Vec</code>ç­‰ã«metricsã®æƒ…å ±ã‚„å¤‰æ›ã—ãŸ<a href=https://docs.rs/opentelemetry/latest/opentelemetry/struct.KeyValue.html rel=external><code>KeyValue</code></a>ã‚’ä¿æŒã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚<br> ã—ã‹ã—ãªãŒã‚‰ã€ãã†ã—ã¦ã—ã¾ã†ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«metricsã‚’å«ã¾ãªã„<a href=https://docs.rs/tracing/0.1.37/tracing/struct.Event.html rel=external><code>Event</code></a>ã‚’å‡¦ç†ã™ã‚‹éš›ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span>tracing</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0;font-weight:700>info!</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>  http</span><span style=color:#81a1c1>.</span><span>route </span><span style=color:#81a1c1>=</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>/foo</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span>  http</span><span style=color:#81a1c1>.</span><span>response</span><span style=color:#81a1c1>.</span><span>status_code </span><span style=color:#81a1c1>=</span><span style=color:#b48ead> 200</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>  "</span><span style=color:#a3be8c>Handle request</span><span style=color:#eceff4>"</span><span>  </span></span>
<span class=giallo-l><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span></code></pre><p><a href=https://docs.rs/tracing/0.1.37/tracing/struct.Event.html rel=external><code>Event</code></a>ã¨ã—ã¦ã¯ã€metricsã‚’å«ã¾ãªã„æ–¹ãŒå¤šã„ã®ãŒè‡ªç„¶ã§ã™ãŒã€<a href=https://docs.rs/tracing-opentelemetry/0.20.0/tracing_opentelemetry/struct.MetricsLayer.html rel=external><code>MetricsLayer</code></a>ã¨ã—ã¦ã¯ã€visitã—ã¦ã„ã‚‹é€”ä¸­ã§ã¯ãã®<a href=https://docs.rs/tracing/0.1.37/tracing/struct.Event.html rel=external><code>Event</code></a>ã«metricsãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ã‚ã‹ã‚‰ãªã„ã®ã§ã€<code>Vec</code>ã®ç¢ºä¿ã‚„pushç­‰ã‚’è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚<br> (ã¾ãšvisitã—ãŸã®ã¡ã€metricsãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯ã‚‚ã†ä¸€åº¦visitã™ã‚‹æ–¹æ³•ã‚‚è€ƒãˆã‚‰ã‚Œã¾ã™ãŒéåŠ¹ç‡)<h2 id=eventchu-qi-hua-shi-nipan-ding-suru><a aria-label="Anchor link for: eventchu-qi-hua-shi-nipan-ding-suru" class=zola-anchor href=#eventchu-qi-hua-shi-nipan-ding-suru><a href=https://docs.rs/tracing/0.1.37/tracing/struct.Event.html rel=external><code>Event</code></a>åˆæœŸåŒ–æ™‚ã«åˆ¤å®šã™ã‚‹</a></h2><p>å•é¡Œã¨ã—ã¦ã¯ã€ã‚ã‚‹Layerã¯ç‰¹å®šã®<a href=https://docs.rs/tracing/0.1.37/tracing/struct.Event.html rel=external><code>Event</code></a>ã«ã®ã¿é–¢å¿ƒãŒã‚ã‚Šã€ãã®åˆ¤å®šã‚’<a href=https://docs.rs/tracing/0.1.37/tracing/struct.Event.html rel=external><code>Event</code></a>å‡¦ç†æ™‚ã§ã¯ãªãã€ã„ãšã‚Œã‹ã®åˆæœŸåŒ–æ™‚ã«ä¸€åº¦ã ã‘è¡Œã„ãŸã„ã¨ã„ã†çŠ¶æ³ã§ã™ã€‚<br> ã“ã‚Œã¯ç‰¹å®šã®æ©Ÿèƒ½ã‚’æä¾›ã™ã‚‹Layerã¨ã—ã¦ã¯ä¸€èˆ¬ã«å¿…è¦ã«ãªã‚Šãã†ãªã®ã§ã€<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/layer/trait.Layer.html rel=external><code>Layer</code></a> traitã«ãã†ã„ã£ãŸmethodãŒãªã„ã‹ã¿ã¦ã„ãŸã¨ã“ã‚ã€ãã‚Œã‚‰ã—ãã‚‚ã®ãŒã‚ã‚Šã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> register_callsite</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> metadata</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>static Metadata</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Interest</span></span></code></pre><p><a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/layer/trait.Layer.html#method.register_callsite rel=external>docs</a><blockquote><p>Registers a new callsite with this layer, returning whether or not the layer is interested in being notified about the callsite, similarly to Subscriber::register_callsite.</blockquote><p>ã¨ã‚ã‚‹ã®ã§ã€<code>tracing::info!()</code>ã‚’å‘¼ã³å‡ºã™ã¨ä¸€åº¦ã ã‘ã€<code>MetricsLayer::register_callsite()</code>ã‚’å‘¼ã‚“ã§ãã‚Œãã†ã§ã™ã€‚<br> ã¾ãŸ<a href=https://docs.rs/tracing-core/0.1.30/tracing_core/metadata/struct.Metadata.html#method.callsite rel=external><code>Metadata::callsite() -> Identirifer</code></a>ã‹ã‚‰ã€<a href=https://docs.rs/tracing/0.1.37/tracing/struct.Event.html rel=external><code>Event</code></a>ã®è­˜åˆ¥å­ã‚‚å–å¾—ã§ãã‚‹ã®ã§<a href=https://docs.rs/tracing/0.1.37/tracing/struct.Event.html rel=external><code>Event</code></a>ãŒmetricsã‹ã©ã†ã‹äº‹å‰ã«ä¸€åº¦ã ã‘åˆ¤å®šã—ãŸã„ã¨ã„ã†æ©Ÿèƒ½ã¯å®Ÿç¾ã§ããã†ã«æ€ã‚ã‚Œã¾ã—ãŸã€‚<br> ã‚‚ã£ã¨ã‚‚ã€æ³¨æ„ãŒå¿…è¦ãªã®ã¯<blockquote><p>Note: This method (and Layer::enabled) determine whether a span or event is globally enabled, not whether the individual layer will be notified about that span or event. This is intended to be used by layers that implement filtering for the entire stack. Layers which do not wish to be notified about certain spans or events but do not wish to globally disable them should ignore those spans or events in their on_event, on_enter, on_exit, and other notification methods.</blockquote><p>(æ„è¨³: ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯spanã‚„eventãŒã‚°ãƒ­ãƒ¼ãƒãƒ«ã§æœ‰åŠ¹ã‹ã‚’åˆ¤å®šã™ã‚‹ã‚‚ã®ã§ã€ãƒ¬ã‚¤ãƒ¤ãƒ¼å˜ä½ã§spanã‚„eventã®é€šçŸ¥ã‚’åˆ¶å¾¡ã™ã‚‹ã‚‚ã®ã§ã¯ãªã„ã€‚ã“ã‚Œã¯ã‚¹ã‚¿ãƒƒã‚¯å…¨ä½“ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’å®Ÿè£…ã™ã‚‹ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æ„å›³ã—ãŸã‚‚ã®ã€‚ç‰¹å®šã®spanã‚„eventã‚’å‡¦ç†ã®å¯¾è±¡ã¨ã¯ã—ãªã„ãŒã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ã§ç„¡åŠ¹ã«ã—ãŸããªã„ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯å˜ã«on_eventã§ãã‚Œã‚‰ã‚’ç„¡è¦–ã™ã‚Œã°ã‚ˆã„ã€‚)<p>ã¨ã‚ã‚‹ã‚ˆã†ã«ã€<code>register_callsite()</code>ã‚’åˆ©ç”¨ã—ã¦ã‚‚ã€<a href=https://docs.rs/tracing-opentelemetry/0.20.0/tracing_opentelemetry/struct.MetricsLayer.html rel=external><code>MetricsLayer</code></a>ã§metricsä»¥å¤–ã®eventã§<code>on_event()</code>ãŒå‘¼ã°ã‚Œãªããªã‚‹ã‚ã‘ã§ã¯ãªã„ã¨ã„ã†ã“ã¨ã§ã™ã€‚(ãã®ã‚ˆã†ãªä»•çµ„ã¿ã¯åˆ¥ã§ã‚ã‚Šã€ã®ã¡ã»ã©è¨€åŠã—ã¾ã™ã€‚) ã“ã®ä»•çµ„ã¿ã¯<a href=https://docs.rs/tracing/0.1.37/tracing/struct.Event.html rel=external><code>Event</code></a>ã‚„<a href=https://docs.rs/tracing/0.1.37/tracing/struct.Span.html rel=external><code>Span</code></a>ã‚’ç‰¹å®šã®Levelã§filterã™ã‚‹(DEBUGã‚’ç„¡è¦–ã™ã‚‹ç­‰) <a href=https://docs.rs/tracing-subscriber/latest/tracing_subscriber/filter/struct.LevelFilter.html rel=external><code>LevelFilter</code></a>å‘ã‘ã§ã‚ã‚‹ã¨æ€ã‚ã‚Œã¾ã™ã€‚ ã¨ã„ã†ã“ã¨ã§ã€ã‚ã‚‹<a href=https://docs.rs/tracing/0.1.37/tracing/struct.Event.html rel=external><code>Event</code></a>ãŒmetricsã‚’å«ã‚“ã§ãŠã‚Šå‡¦ç†å¯¾è±¡ã‹ã©ã†ã‹ã¯è‡ªå‰ã§ç®¡ç†ã™ã‚‹å¿…è¦ãŒã‚ã‚Šãã†ã¨ã„ã†ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚<p>ã“ã†ã—ãŸèƒŒæ™¯ã‹ã‚‰ã€æœ€åˆã®PRã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã€callsiteã”ã¨ã®åˆ¤å®šçµæœã‚’<code>RwLock</code>ã§ä¿æŒã™ã‚‹<a href=https://github.com/tokio-rs/tracing-opentelemetry/pull/43/commits/c0357cb7726548f4bb822ce2b433e7c96c75e5e2 rel=external>å®Ÿè£…</a>ã‚’è¡Œã„ã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> tracing</span><span style=color:#81a1c1>::</span><span>callsite</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Identifier</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> Callsites</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    callsites</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> RwLock</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>HashMap</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Identifier</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> CallsiteInfo</span><span style=color:#eceff4>>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Default</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> CallsiteInfo</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    has_metrics_fields</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> bool</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Callsites</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> new</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -> Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Callsites</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            callsites</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Default</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> register_metrics_callsite</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> callsite</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Identifier</span><span style=color:#eceff4>,</span><span> info</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> CallsiteInfo</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>callsites</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>insert</span><span style=color:#eceff4>(</span><span>callsite</span><span style=color:#eceff4>,</span><span> info</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> has_metrics_field</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> callsite</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Identifier</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> bool</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>callsites</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>read</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>get</span><span style=color:#eceff4>(</span><span>callsite</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>map</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>info</span><span style=color:#81a1c1>|</span><span> info</span><span style=color:#81a1c1>.</span><span>has_metrics_fields</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>unwrap_or</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>false</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Layer</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>></span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> MetricsLayer</span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    S</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Subscriber</span><span style=color:#81a1c1> + for</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>span</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> LookupSpan</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>span</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>     fn</span><span style=color:#88c0d0> register_callsite</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> metadata</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>static</span><span> tracing</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Metadata</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Interest</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if</span><span> metadata</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>is_event</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> && self.</span><span style=color:#88c0d0>has_metrics_fields</span><span style=color:#eceff4>(</span><span>metadata</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>fields</span><span style=color:#eceff4>()) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            self.</span><span>callsites</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>register_metrics_callsite</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>                metadata</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>callsite</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                CallsiteInfo</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                    has_metrics_fields</span><span style=color:#81a1c1>: true</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>                },</span></span>
<span class=giallo-l><span style=color:#eceff4>            );</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        Interest</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>always</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> on_event</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> event</span><span style=color:#81a1c1>: &</span><span>tracing</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Event</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>,</span><span> _ctx</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Context</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>         if self</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span>callsites</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>has_metrics_field</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>event</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>metadata</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>callsite</span><span style=color:#eceff4>())</span></span>
<span class=giallo-l><span style=color:#eceff4>        {</span><span style=color:#616e88>/* ...*/</span><span style=color:#eceff4> }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>è‡ªåˆ†ã¨ã—ã¦ã‚‚<a href=https://docs.rs/tracing/0.1.37/tracing/struct.Event.html rel=external><code>Event</code></a>æ¯ã«<code>RwLocl::read()</code>ãŒèµ°ã‚‹å®Ÿè£…ã¯å³ã—ã„ã ã‚ã†ãªã¨æ€ã„ã¤ã¤ã€<a href=https://github.com/tokio-rs/tracing-opentelemetry/pull/43/commits/c0357cb7726548f4bb822ce2b433e7c96c75e5e2#r1284671386 rel=external>ãƒ¬ãƒ“ãƒ¥ãƒ¼</a>ã‚’ãŠé¡˜ã„ã—ã¾ã—ãŸãŒã€ã‚„ã¯ã‚Šåˆ¥ã®æ–¹æ³•ã‚’è€ƒãˆã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚ <img alt="PR review" src=https://storage.googleapis.com/zenn-user-upload/44ec2fbf187b-20230813.png> <em>jtescherã•ã‚“ã¯tracing-opentelemetryã®maintainer</em><h1 id=per-layer-filtering><a aria-label="Anchor link for: per-layer-filtering" class=zola-anchor href=#per-layer-filtering><a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/layer/index.html#per-layer-filtering rel=external>Per-Layer Filtering</a></a></h1><p>ãªã«ã‹è‰¯ã„æ–¹æ³•ãŒãªã„ã‹ã¨æ€ã„<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/layer/trait.Layer.html rel=external><code>Layer</code></a>ã®<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/layer/index.html rel=external>doc</a>ã‚’èª­ã‚“ã§ã„ã‚‹ã¨ã€<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/layer/index.html#per-layer-filtering rel=external>Per-Layer Filtering</a>ã¨ã„ã†ã‚‚ã®ã‚’è¦‹ã¤ã‘ã¾ã—ãŸã€‚<blockquote><p>Sometimes, it may be desirable for one Layer to record a particular subset of spans and events, while a different subset of spans and events are recorded by other Layers.</blockquote><p>(æ„è¨³: æ™‚ã«ã€ã‚ã‚‹ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ç‰¹å®šã®spanã‚„eventsã®ã¿ã‚’å‡¦ç†ã—ã¤ã¤ã€ä»–ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ã¯å½±éŸ¿ã‚’ã‚ãŸãˆãŸããªã„å ´åˆãŒã‚ã‚‹)<p>ã¾ã•ã«ã€ä»Šã“ã®çŠ¶æ³ãªã®ã§ã“ã®æ©Ÿèƒ½ä½¿ãˆã‚‹ã®ã§ã¯ã¨æ€ã„ã¾ã—ãŸã€‚<br> ã•ã‚‰ã«ã“ã®æ©Ÿèƒ½ã¯<a href=https://github.com/tokio-rs/tracing/tree/tracing-subscriber-0.3.17/tracing-subscriber rel=external>tracing-subscriber</a>ã®<code>registry</code> featureãŒå¿…è¦ãªã®ã§ã™ãŒ<a href=https://github.com/tokio-rs/tracing-opentelemetry rel=external>tracing-opentelemetry</a>ã¯æ—¢ã«ã“ã®featureã«ä¾å­˜ã—ã¦ã„ã‚‹ã®ã§ã€breaking changeã¨ã‚‚ãªã‚‰ãªãã†ã§ã—ãŸã€‚<br> Metricsã‚’å«ã‚€<a href=https://docs.rs/tracing/0.1.37/tracing/struct.Event.html rel=external><code>Event</code></a>ã«é™å®šã§ãã‚Œã°ã€<code>on_event()</code>ã®å‡¦ç†é–‹å§‹æ™‚ã«<a href=https://docs.rs/tracing/0.1.37/tracing/field/struct.Field.html rel=external><code>Field</code></a>ã«metricsãŒå«ã¾ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚‹ã®ã§ã€visitæ™‚ã«ãã‚Œãã‚Œã®å€¤ã‚’ä¿æŒã—ã¦ãŠãã‚¢ãƒ—ãƒ­ãƒ¼ãƒãŒã¨ã‚Œã‚‹ã®ã§ã€ã“ã®æ©Ÿèƒ½ã‚’çµ„ã¿è¾¼ã‚“ã§ã¿ã‚ˆã†ã¨æ€ã„ã¾ã—ãŸã€‚<h2 id=filtertofiltered><a aria-label="Anchor link for: filtertofiltered" class=zola-anchor href=#filtertofiltered><a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/layer/trait.Filter.html rel=external><code>Filter</code></a>ã¨<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/filter/struct.Filtered.html rel=external><code>Filtered</code></a></a></h2><p>ã¾ãšè€ƒãˆãŸã®ãŒã€<a href=https://docs.rs/tracing-opentelemetry/0.20.0/tracing_opentelemetry/struct.MetricsLayer.html rel=external><code>MetricsLayer</code></a>ã«<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/layer/trait.Filter.html rel=external><code>Filter</code></a> traitã‚’å®Ÿè£…ã™ã‚‹ã¨ã„ã†ã“ã¨ã§ã—ãŸã€‚<br> ã—ã‹ã—ãªãŒã‚‰ã€docã‚’èª­ã‚“ã ã‚Šæ‰‹å…ƒã§å‹•ã‹ã—ã¦ã¿ãŸã‚Šã—ã¦ã‚ã‹ã£ãŸã®ã§ã™ãŒã€ã‚ã‚‹<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/layer/trait.Layer.html rel=external><code>Layer</code></a>ã«<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/layer/trait.Filter.html rel=external><code>Filter</code></a>ã‚’å®Ÿè£…ã—ã¦ã€tracing subscriberã«composeã—ã¦ã‚‚æ„å›³ã—ãŸåŠ¹æœã¯å¾—ã‚‰ã‚Œãªã„ã¨ã„ã†ã“ã¨ã§ã—ãŸã€‚<br> ã¨ã„ã†ã®ã‚‚ã€tracing subscriberã¸ã®composeã¯å®Ÿè£…çš„ã«ã¯ã€<code>Layered</code>ã¨ã„ã†å‹ã«å¤‰æ›ã•ã‚Œã¦ãã‚Œã‚‰ãŒå…¨ä½“ã¨ã—ã¦ã€tracingã®<code>Subscriber</code> traitã‚’å®Ÿè£…ã™ã‚‹ã¨ã„ã†å½¢ã«ãªã£ã¦ã„ã‚‹ã®ã§ã™ãŒã€ãã®å®Ÿè£…ã®ä¸­ã§ã€<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/layer/trait.Filter.html rel=external><code>Filter</code></a> traitã¯ç‰¹ã«å‚ç…§ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<br> <a href=https://github.com/tokio-rs/tracing/tree/tracing-subscriber-0.3.17/tracing-subscriber rel=external>tracing-subscriber</a>ã®APIè¨­è¨ˆçš„ã«ã€<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/layer/trait.Filter.html rel=external><code>Filter</code></a>ã®å®Ÿè£…ã‚’æ¸¡ã—ã¦ã€<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/filter/struct.Filtered.html rel=external><code>Filtered</code></a>ã¨ã„ã†<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/layer/trait.Layer.html rel=external><code>Layer</code></a>ã‚’ä½¿ã†å¿…è¦ãŒã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚<br> ãã‚ŒãŒãªãœã‹ã¨ã„ã„ã¾ã™ã¨<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#88c0d0;font-weight:700>thread_local!</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>crate</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> static</span><span> FILTERING</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> FilterState</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> FilterState</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> L</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> F</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Layer</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>></span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> Filtered</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>L</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> F</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    S</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Subscriber</span><span style=color:#81a1c1> + for</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>span</span><span style=color:#eceff4>></span><span> registry</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>LookupSpan</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>span</span><span style=color:#eceff4>></span><span style=color:#81a1c1> +</span><span style=color:#eceff4> '</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    F</span><span style=color:#81a1c1>:</span><span> layer</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Filter</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>></span><span style=color:#81a1c1> +</span><span style=color:#eceff4> '</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    L</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Layer</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>        fn</span><span style=color:#88c0d0> enabled</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> metadata</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Metadata</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>,</span><span> cx</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Context</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> bool</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let</span><span> cx</span><span style=color:#81a1c1> =</span><span> cx</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>with_filter</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span style=color:#88c0d0>id</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let</span><span> enabled</span><span style=color:#81a1c1> = self.</span><span>filter</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>enabled</span><span style=color:#eceff4>(</span><span>metadata</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> &</span><span>cx</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span>            FILTERING</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>with</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>filtering</span><span style=color:#81a1c1>|</span><span> filtering</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>set</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span style=color:#88c0d0>id</span><span style=color:#eceff4>(),</span><span> enabled</span><span style=color:#eceff4>));</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>            if</span><span> enabled</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>                // If the filter enabled this metadata, ask the wrapped layer if</span></span>
<span class=giallo-l><span style=color:#616e88>                // _it_ wants it --- it might have a global filter.</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span>layer</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>enabled</span><span style=color:#eceff4>(</span><span>metadata</span><span style=color:#eceff4>,</span><span> cx</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>                // Otherwise, return `true`. The _per-layer_ filter disabled this</span></span>
<span class=giallo-l><span style=color:#616e88>                // metadata, but returning `false` in `Layer::enabled` will</span></span>
<span class=giallo-l><span style=color:#616e88>                // short-circuit and globally disable the span or event. This is</span></span>
<span class=giallo-l><span style=color:#616e88>                // *not* what we want for per-layer filters, as other layers may</span></span>
<span class=giallo-l><span style=color:#616e88>                // still want this event. Returning `true` here means we'll continue</span></span>
<span class=giallo-l><span style=color:#616e88>                // asking the next layer in the stack.</span></span>
<span class=giallo-l><span style=color:#616e88>                //</span></span>
<span class=giallo-l><span style=color:#616e88>                // Once all per-layer filters have been evaluated, the `Registry`</span></span>
<span class=giallo-l><span style=color:#616e88>                // at the root of the stack will return `false` from its `enabled`</span></span>
<span class=giallo-l><span style=color:#616e88>                // method if *every* per-layer  filter disabled this metadata.</span></span>
<span class=giallo-l><span style=color:#616e88>                // Otherwise, the individual per-layer filters will skip the next</span></span>
<span class=giallo-l><span style=color:#616e88>                // `new_span` or `on_event` call for their layer if *they* disabled</span></span>
<span class=giallo-l><span style=color:#616e88>                // the span or event, but it was not globally disabled.</span></span>
<span class=giallo-l><span style=color:#81a1c1>                true</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        fn</span><span style=color:#88c0d0> on_event</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> event</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Event</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>,</span><span> cx</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Context</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            self.</span><span style=color:#88c0d0>did_enable</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>||</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span>layer</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>on_event</span><span style=color:#eceff4>(</span><span>event</span><span style=color:#eceff4>,</span><span> cx</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>with_filter</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span style=color:#88c0d0>id</span><span style=color:#eceff4>()));</span></span>
<span class=giallo-l><span style=color:#eceff4>            })</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>L</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> F</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Filtered</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>L</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> F</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> did_enable</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> f</span><span style=color:#81a1c1>: impl</span><span style=color:#88c0d0> FnOnce</span><span style=color:#eceff4>()) {</span></span>
<span class=giallo-l><span>        FILTERING</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>with</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>filtering</span><span style=color:#81a1c1>|</span><span> filtering</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>did_enable</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span style=color:#88c0d0>id</span><span style=color:#eceff4>(),</span><span> f</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing/blob/tracing-subscriber-0.3.17/tracing-subscriber/src/filter/layer_filters/mod.rs rel=external>source</a><p>ã‚ã¾ã‚Šå®Ÿè£…ã®è©³ç´°ã«ã¯è¸ã¿è¾¼ã¿ã¾ã›ã‚“ãŒã€æ¦‚ã­ä»¥ä¸‹ã®ç‚¹ãŒã‚ã‹ã‚Šã¾ã™ã€‚<ul><li><code>Filtered</code>ã¯<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/layer/trait.Layer.html rel=external><code>Layer</code></a>ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ã®ã§ã€Layerã¨ã—ã¦æŒ¯ã‚‹èˆã†<li><code>enabled()</code>ã§ã¯ä¾‹ãˆã€wrapã—ã¦ã„ã‚‹<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/layer/trait.Filter.html rel=external><code>Filter</code></a>ã®å®Ÿè£…ãŒfalseã‚’è¿”ã—ã¦ã‚‚æˆ»ã‚Šå€¤ã¨ã—ã¦ã¯trueã‚’è¿”ã™(Globalã§ç„¡åŠ¹ã«ãªã‚‰ãªã„)<li>Thread localã¨ã¯ã„ãˆGlobalã«å€¤ã‚’ä¿æŒã—ã¦ã„ã‚‹(<code>FILTERING</code>)<li><code>on_event()</code>å®Ÿè£…æ™‚ã«Globalã®<code>FILTERING</code>ã‚’å‚ç…§ã—ã¦Per Filteræ©Ÿèƒ½ã‚’å®Ÿç¾</ul><p>ã¨ä¸­ã€…hackçš„ãªå®Ÿè£…ã¨ãªã£ã¦ãŠã‚Šã€è‡ªå‰ã§<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/layer/trait.Filter.html rel=external><code>Filter</code></a>ã‚’å®Ÿè£…ã™ã‚‹ã ã‘ã§ã¯ã ã‚ã§ã€ã‚ãã¾ã§<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/filter/struct.Filtered.html rel=external><code>Filtered</code></a>ã‚’ä½¿ã‚ãªã„ã¨ã„ã‘ãªã„ã¨ã„ã†ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚<p>ã¨ã„ã†ã“ã¨ã§ã€<a href=https://docs.rs/tracing-opentelemetry/0.20.0/tracing_opentelemetry/struct.MetricsLayer.html rel=external><code>MetricsLayer</code></a>ã‹ã‚‰<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/filter/struct.Filtered.html rel=external><code>Filtered</code></a>ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ãŒæ¬¡ã®ç›®æ¨™ã§ã™ã€‚<br> <a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/filter/struct.Filtered.html rel=external><code>Filtered</code></a>ã®ç”Ÿæˆã«ã¤ã„ã¦ã¯<a href=https://github.com/tokio-rs/tracing/tree/tracing-subscriber-0.3.17/tracing-subscriber rel=external>tracing-subscriber</a>ãŒ<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/layer/trait.Layer.html#method.with_filter rel=external><code>with_filter()</code></a>ã‚’ç”¨æ„ã—ã¦ãã‚Œã¦ã„ã‚‹ã®ã§ã™ãŒã€å•é¡Œã¯è¿”ã‚Šå€¤ãŒ<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/filter/struct.Filtered.html rel=external><code>Filtered</code></a>ã¨ã„ã†ã“ã¨ã§ã™ã€‚<br> ã©ã†ã„ã†ã“ã¨ã‹ã¨ã„ã„ã¾ã™ã¨ã€ä»Šã‚„ã‚ŠãŸã„ã“ã¨ã¯ã€<code>Filtered&lt;MetricsLayer,F,S></code>ã¨ã„ã†å‹ã‚’<a href=https://github.com/tokio-rs/tracing-opentelemetry rel=external>tracing-opentelemetry</a>ã®userã«è¿”ã—ãŸã„ã¨ã„ã†ã“ã¨ãªã®ã§ã™ãŒ<br> <a href=https://github.com/tokio-rs/tracing-opentelemetry rel=external>tracing-opentelemetry</a>ã¨ã—ã¦ã¯<code>MetricsLayer::new()</code>ãŒpublicãªAPIãªã®ã§ã“ã“ã‚’å¤‰ãˆã¦ã—ã¾ã†ã¨ç ´å£Šçš„å¤‰æ›´ã¨ãªã£ã¦ã—ã¾ã†ã“ã¨ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>pub type</span><span style=color:#8fbcbb> MetricLayer</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>></span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Filtered</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>MetricLayerInner</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb>Filter</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>></span><span>`</span></span></code></pre><p>ä¸Šè¨˜ã®ã‚ˆã†ã«aliasã‚’ä½¿ã†ã‹ã‚‚è€ƒãˆãŸã®ã§ã™ãŒã€ã“ã‚Œã«ã‚‚å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚ãŸã¨ãˆã°å°†æ¥çš„ã«ã€<a href=https://docs.rs/tracing-opentelemetry/0.20.0/tracing_opentelemetry/struct.MetricsLayer.html rel=external><code>MetricsLayer</code></a>ã«è¿½åŠ ã®è¨­å®šãŒå¿…è¦ã¨ãªã‚Š<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>let</span><span> layer</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> MetricsLayer</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>meter_provider</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>with_foo</span><span style=color:#eceff4>();</span></span></code></pre><p>ã®ã‚ˆã†ã«<code>with_</code>ã§è¨­å®šã§ãã‚‹APIãŒå¿…è¦ã«ãªã£ãŸå ´åˆã€<code>Filtered</code>ã¯å¤–éƒ¨ã®å‹ãªã®ã§ã€methodã¯è¿½åŠ ã§ããªã„ã¨ã„ã†ã“ã¨ã§ã™ã€‚<p>ã“ã“ã§æ€ã£ãŸã®ãŒã€å®Ÿä½“ã¨ã—ã¦ã¯<a href=https://github.com/tokio-rs/tracing/tree/tracing-subscriber-0.3.17/tracing-subscriber rel=external>tracing-subscriber</a>ã®<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/filter/struct.Filtered.html rel=external><code>Filtered</code></a>ãªã®ã ã‘ã©ã€å‹ã¨ã—ã¦ã¯userã«ãã‚Œã‚’ã¿ã›ãŸããªã„ã¨ã„ã†çŠ¶æ³ã©ã“ã‹ã§ã¿ãŸã“ã¨ã‚ã‚‹ã¨ã„ã†ã“ã¨ã§ã—ãŸã€‚<br> ãã†ã§ã™ã€<a href=https://github.com/tokio-rs/tracing/tree/tracing-subscriber-0.3.17/tracing-subscriber rel=external>tracing-subscriber</a>ã®<a href=https://docs.rs/tracing-subscriber/0.3.17/src/tracing_subscriber/fmt/mod.rs.html#225-232 rel=external><code>Subscriber</code></a>ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> Subscriber</span><span style=color:#eceff4>&lt;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    N</span><span style=color:#81a1c1> =</span><span> format</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>DefaultFields</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    E</span><span style=color:#81a1c1> =</span><span> format</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Format</span><span style=color:#eceff4>&lt;</span><span>format</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Full</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    F</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> LevelFilter</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    W</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> fn</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span> io</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Stdout</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span>    inner</span><span style=color:#81a1c1>:</span><span> layer</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Layered</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>F</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Formatter</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>N</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> E</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> W</span><span style=color:#eceff4>>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://docs.rs/tracing-subscriber/0.3.17/src/tracing_subscriber/fmt/mod.rs.html#225-232 rel=external>source</a><p>Genericsã¯ç„¡è¦–ã—ã¦ã€ç€ç›®ã—ãŸã„ã®ãŒã€å®Ÿä½“ã¨ã—ã¦ã¯ã€<code>Layered</code>ãªã®ã§ã™ãŒã€ãã‚Œã‚’innerã¨ã—ã¦wrapã—ãŸå‹ã‚’userã«ã¿ã›ã¦ã„ã‚‹ã¨ã„ã†ã“ã¨ã§ã™ã€‚<br> ã“ã®æ™‚åˆã‚ã¦ã€<a href=https://github.com/tokio-rs/tracing/tree/tracing-subscriber-0.3.17/tracing-subscriber rel=external>tracing-subscriber</a>ãŒã©ã†ã—ã¦ã“ã†ã®ã‚ˆã†ã«å®Ÿè£…ã—ã¦ã„ã‚‹ã‹ã®æ°—æŒã¡ãŒã‚ã‹ã‚Šã¾ã—ãŸ(å‹æ‰‹ã«)ã€‚<p>ã¨ã„ã†ã“ã¨ã§ã€<a href=https://docs.rs/tracing-opentelemetry/0.20.0/tracing_opentelemetry/struct.MetricsLayer.html rel=external><code>MetricsLayer</code></a>ã«<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/filter/struct.Filtered.html rel=external><code>Filtered</code></a>ã‚’çµ„ã¿è¾¼ã‚“ã çµæœä»¥ä¸‹ã®ã‚ˆã†ãªå®Ÿè£…ã¨ãªã‚Šã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> MetricsLayer</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span>    inner</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Filtered</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>InstrumentLayer</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> MetricsFilter</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing-opentelemetry/blob/e9148988fc053c617cc50f957599e5dc943c3811/src/metrics.rs#L335C1-L337C2 rel=external>source</a><p>å½¢ã¨ã—ã¦ã¯åŒã˜ã§ã™ã€‚ä»Šã¾ã§ã®<a href=https://docs.rs/tracing-opentelemetry/0.20.0/tracing_opentelemetry/struct.MetricsLayer.html rel=external><code>MetricsLayer</code></a>ã®è²¬å‹™ã¯<code>InstrumentLayer</code>ãŒæ‹…ã„ã€<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/layer/trait.Filter.html rel=external><code>Filter</code></a>ã¯<code>MetricsFilter</code>ã«å®Ÿè£…ã™ã‚‹å½¢ã«ã—ã¾ã—ãŸã€‚<br> ãƒ‡ãƒ¡ãƒªãƒƒãƒˆã¨ã—ã¦ã€ã™ã¹ã¦innerã«ç§»è­²ã™ã‚‹å½¢ã§ã€<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/layer/trait.Layer.html rel=external><code>Layer</code></a>ã‚’å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€Subscriberã‚‚ãã†ã—ã¦ã„ãŸã®ã§å—ã‘å…¥ã‚Œã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚<p>ã“ã‚Œã§ã€ç ´å£Šçš„å¤‰æ›´ã‚’è¡Œã†ã“ã¨ãªãã€<a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/layer/index.html#per-layer-filtering rel=external>Per-Layer Filtering</a>ã®æ©Ÿèƒ½ã‚’å–ã‚Šè¾¼ã‚€ã“ã¨ãŒã§ãã¾ã—ãŸã€‚<h1 id=allocationmobi-ketai><a aria-label="Anchor link for: allocationmobi-ketai" class=zola-anchor href=#allocationmobi-ketai>Allocationã‚‚é¿ã‘ãŸã„</a></h1><p>ã“ã“ã¾ã§ã§ã€æ©Ÿèƒ½çš„ã«ã¯ç›®æ¨™ã‚’é”æˆã§ããŸã®ã§ã™ãŒã€1ç‚¹ä¸æº€ãŒã‚ã‚Šã¾ã—ãŸã€‚<br> ãã‚Œã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã€<a href=https://docs.rs/tracing/0.1.37/tracing/struct.Event.html rel=external><code>Event</code></a> visitå‰ã«ã€<code>Vec</code>ã®allocationãŒç™ºç”Ÿã—ã¦ã—ã¾ã†ç‚¹ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Layer</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>></span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> InstrumentLayer</span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    S</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Subscriber</span><span style=color:#81a1c1> + for</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>span</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> LookupSpan</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>span</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> on_event</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> event</span><span style=color:#81a1c1>: &</span><span>tracing</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Event</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>,</span><span> _ctx</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Context</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> attributes</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Vec</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>();</span><span style=color:#616e88>        // ğŸ‘ˆ ã‚³ã‚³</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> visited_metrics</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Vec</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>();</span><span style=color:#616e88>   // ğŸ‘ˆ</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> metric_visitor</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> MetricVisitor</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            attributes</span><span style=color:#81a1c1>: &mut</span><span> attributes</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            visited_metrics</span><span style=color:#81a1c1>: &mut</span><span> visited_metrics</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>        };</span></span>
<span class=giallo-l><span>        event</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>record</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut</span><span> metric_visitor</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>        // associate attrivutes with visited metrics</span></span>
<span class=giallo-l><span>        visited_metrics</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>into_iter</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>for_each</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span style=color:#eceff4>(</span><span>metric_name</span><span style=color:#eceff4>,</span><span> value</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>|</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span>instruments</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>update_metric</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    &self.</span><span>meter</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>                    value</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>                    metric_name</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>                    attributes</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_slice</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>                );</span></span>
<span class=giallo-l><span style=color:#eceff4>            })</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing-opentelemetry/blob/e9148988fc053c617cc50f957599e5dc943c3811/src/metrics.rs#L399C1-L424C2 rel=external>source</a><p><code>Vec</code>ãŒå¿…è¦ãªã®ã¯ã€<code>tracing::info!()</code>ã®ä¸­ã«metricsã¨ä»–ã®fieldãŒã„ãã¤ã‚ã‚‹ã‹ã‚ã‹ã‚‰ãªã„ã‹ã‚‰ã§ã™ã€‚ä¾‹ãˆã°ã€ä»¥ä¸‹ã®ã‚ˆã†ãªå…¥åŠ›ã¯å¯èƒ½ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span>tracing</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0;font-weight:700>info!</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>    counter</span><span style=color:#81a1c1>.</span><span>foo </span><span style=color:#81a1c1>=</span><span style=color:#b48ead> 1</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    counter</span><span style=color:#81a1c1>.</span><span>bar </span><span style=color:#81a1c1>=</span><span style=color:#b48ead> 2</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    abc</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>abc</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span>    xyz</span><span style=color:#81a1c1> =</span><span style=color:#b48ead> 123</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>);</span></span></code></pre><p>ä¸€å¿œã€<a href=https://github.com/tokio-rs/tracing rel=external>tracing</a>å´ã§ã€æœ€å¤§fieldæ•°ã®åˆ¶é™(32)ãŒã‚ã‚‹ã®ã§ã™ãŒã€ãã®åˆ†ã®Arrayã‚’ç¢ºä¿ã™ã‚‹ã®ã‚‚resourceã®åŠ¹ç‡çš„ãªåˆ©ç”¨ã®è¦³ç‚¹ã‹ã‚‰å¾Œé€€ã—ã¦ã—ã¾ã†ã‚ˆã†ã«æ€ã‚ã‚Œã¾ã—ãŸã€‚ã¾ãŸæœ€å¤§fieldæ•°ãŒå¢—ãˆã‚‹å¯èƒ½æ€§ã‚‚ã‚ã‚Šã¾ã™ã€‚<br> ã“ã“ã§ã®å•é¡Œã¯ã€å¤šãã®å ´åˆã€é«˜ã€…æ•°å€‹ã ãŒã€ä¾‹å¤–ã«å¯¾å¿œã§ãã‚‹ã‚ˆã†ã«å€‹æ•°åˆ¶é™ã¯è¨­ã‘ã‚‰ã‚Œãªã„ã¨ã„ã†çŠ¶æ…‹ã§ã™ã€‚<br> ã“ã†ã„ã†ã‚±ãƒ¼ã‚¹ã«ã¯ã¾ã‚‹ã‚‚ã®ãªã„ã‹ãªã¨èª¿ã¹ã¦ã„ã¦ã¿ã¤ã‘ãŸã®ãŒ<a href=https://docs.rs/smallvec/latest/smallvec/ rel=external>smallvec</a> crateã§ã™ã€‚<br> <a href=https://docs.rs/smallvec/latest/smallvec/ rel=external>smallvec</a>ã®èª¬æ˜ã«ã¯<blockquote><p>Small vectors in various sizes. These store a certain number of elements inline, and fall back to the heap for larger allocations. This can be a useful optimization for improving cache locality and reducing allocator traffic for workloads that fit within the inline buffer.</blockquote><p>ã¨ã‚ã‚‹ã®ã§ã€è‡ªåˆ†ã®ç†è§£ãŒæ­£ã—ã‘ã‚Œã°ã€æŒ‡å®šã®æ•°ã¾ã§ã¯stackä¸Šã«ç¢ºä¿ã•ã‚Œã€ãã‚Œã‚’è¶…ãˆãŸå ´åˆã®ã¿ã€é€šå¸¸ã®<code>Vec</code>ã®ã‚ˆã†ã«heapã®allocationãŒç™ºç”Ÿã™ã‚‹ã¨ã„ã†ã‚‚ã®ã§ã™ã€‚<p>ã¨ã„ã†ã“ã¨ã§ã€<code>SmallVec</code>ã‚’visitæ™‚ã«åˆ©ç”¨ã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>pub</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>crate</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> struct</span><span style=color:#8fbcbb> MetricVisitor</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span>    attributes</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>a</span><span style=color:#81a1c1> mut</span><span style=color:#8fbcbb> SmallVec</span><span style=color:#eceff4>&lt;[</span><span style=color:#8fbcbb>KeyValue</span><span style=color:#eceff4>;</span><span> 8</span><span style=color:#eceff4>]>,</span></span>
<span class=giallo-l><span>    visited_metrics</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>a</span><span style=color:#81a1c1> mut</span><span style=color:#8fbcbb> SmallVec</span><span style=color:#eceff4>&lt;[(</span><span style=color:#81a1c1>&</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>static str</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> InstrumentType</span><span style=color:#eceff4>);</span><span> 2</span><span style=color:#eceff4>]>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1> fn</span><span style=color:#88c0d0> on_event</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> event</span><span style=color:#81a1c1>: &</span><span>tracing</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Event</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>,</span><span> _ctx</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Context</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> attributes</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> SmallVec</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> visited_metrics</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> SmallVec</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> metric_visitor</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> MetricVisitor</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            attributes</span><span style=color:#81a1c1>: &mut</span><span> attributes</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            visited_metrics</span><span style=color:#81a1c1>: &mut</span><span> visited_metrics</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>        };</span></span>
<span class=giallo-l><span>        event</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>record</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut</span><span> metric_visitor</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#616e88>        /* ...*/</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span><span>        </span></span></code></pre><p>ã“ã®ã‚ã¨ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ ã—ã€ç„¡äº‹ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒé€šã‚Šã¾ã—ãŸã€‚<h1 id=benchmark><a aria-label="Anchor link for: benchmark" class=zola-anchor href=#benchmark>Benchmark</a></h1><p>traceç”¨ã®layerã®benchmarkã¯ã‚ã£ãŸã®ã§ã™ãŒ<a href=https://docs.rs/tracing-opentelemetry/0.20.0/tracing_opentelemetry/struct.MetricsLayer.html rel=external><code>MetricsLayer</code></a>ã®benchmarkã¯ãªã‹ã£ãŸã®ã§ã€è¿½åŠ ã—ã¾ã—ãŸã€‚<br> <img alt="Metricslayer Benchmark" src=https://storage.googleapis.com/zenn-user-upload/aebd6e928416-20230814.png><br> æœ¬æ¥ã¯æ—§å®Ÿè£…ã¨æ¯”è¼ƒã—ãŸã‹ã£ãŸã®ã§ã™ãŒã€benchmarkã™ã‚‹ã«ã¯ã€ãªã‚“ã‚‰ã‹ã®å½¢ã§æ—§å®Ÿè£…ã‚’å…¬é–‹ã™ã‚‹å¿…è¦ãŒã‚ã£ãŸã®ã§æ–­å¿µã—ã¾ã—ãŸã€‚<br> ã“ã†ã„ã†ã¨ãã©ã†ã™ã‚Œã°ã„ã„ã‚“ã§ã™ã‹ã­?<h1 id=flamegraph><a aria-label="Anchor link for: flamegraph" class=zola-anchor href=#flamegraph>Flamegraph</a></h1><p>criterionã®benchmarkã«pprofã‚’è¨­å®šã§ãã‚‹ã®ã¯çŸ¥ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚åˆ©ç”¨ã—ã¦ã¿ãŸã¨ã“ã‚ä»¥ä¸‹ã®ã‚ˆã†ãªçµæœã‚’å¾—ã‚‰ã‚Œã¾ã—ãŸã€‚ <img alt="Metricslayer Flame Graph" src=https://storage.googleapis.com/zenn-user-upload/dbb8b2dc8703-20230814.png> Metricsæ›´æ–°æ™‚ã®lockå‡¦ç†ã«æ™‚é–“ã‚’ä½¿ã£ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚<h1 id=matome><a aria-label="Anchor link for: matome" class=zola-anchor href=#matome>ã¾ã¨ã‚</a></h1><p><a href=https://github.com/tokio-rs/tracing-opentelemetry rel=external>tracing-opentelemetry</a>ã«PRã‚’å‡ºã—ã¦ã¿ãŸéš›è€ƒãˆãŸã“ã¨ã‚’æ›¸ã„ã¦ã¿ã¾ã—ãŸã€‚<br> <a href=https://docs.rs/tracing-subscriber/0.3.17/tracing_subscriber/layer/index.html#per-layer-filtering rel=external>Per-Layer Filtering</a>ã®ä»•çµ„ã¿ã‚’çŸ¥ã‚ŒãŸã“ã¨ã‚„ã€<a href=https://opentelemetry.io/ rel=external>OpenTelemetry</a>ã®metricsé–¢é€£ã®å®Ÿè£…ã«ã¤ã„ã¦ã®å­¦ã³ãŒã‚ã‚Šã¾ã—ãŸã€‚<br> ä»Šå¾Œã‚‚<a href=https://opentelemetry.io/ rel=external>OpenTelemetry</a>ã‚„<a href=https://github.com/tokio-rs/tracing rel=external>tracing</a> ecosystemã¸ã®ç†è§£ã‚’æ·±ã‚ã‚‰ã‚Œã‚Œã°ã¨æ€ã£ã¦ãŠã‚Šã¾ã™ã€‚</div></article></main><footer class=blog-footer><p>Â© 2026 <a href=https://blog.ymgyt.io> ymgyt </a> | Made with <a href=https://www.getzola.org rel=noopener target=_blank>Zola</a> | <a href=https://github.com/ymgyt/blog>Repository</a> | <a href=https://blog.ymgyt.io/atom.xml target=_blank title=rss> <svg viewbox="0 0 24 24" class=icon fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx=5 cy=19 r=1></circle></svg> </a></footer></div></div>