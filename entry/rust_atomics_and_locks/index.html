<!doctype html><html lang=ja><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1" name=viewport><link href=https://blog.ymgyt.io/favicon.ico rel=icon sizes=any><link href=https://blog.ymgyt.io/icon.svg rel=icon type=image/svg+xml><link href=https://blog.ymgyt.io/apple-touch-icon.png rel=apple-touch-icon><link href=https://blog.ymgyt.io/manifest.webmanifest rel=manifest><link href=https://blog.ymgyt.io/style.css rel=stylesheet><link href=https://blog.ymgyt.io/atom.xml rel=alternate title=Atom type=application/atom+xml><script src="https://www.googletagmanager.com/gtag/js?id=G-GTB0KMLN90" async></script><script>window.dataLayer = window.dataLayer || [];
	function gtag() {dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-GTB0KMLN90');</script><title>ğŸ“• Rust Atomics and Locksã‚’èª­ã‚“ã æ„Ÿæƒ³ | Happy developing</title><meta content="Rust Atomics and LocksãŒéå¸¸ã«ã‚ˆã‹ã£ãŸã®ã§æ„Ÿæƒ³ã‚’æ›¸ã„ãŸ" name=description><meta content=summary name=twitter:card><meta content="@YAmaguchixt " name=twitter:site><meta content="ğŸ“• Rust Atomics and Locksã‚’èª­ã‚“ã æ„Ÿæƒ³" name=twitter:title><meta content="Rust Atomics and LocksãŒéå¸¸ã«ã‚ˆã‹ã£ãŸã®ã§æ„Ÿæƒ³ã‚’æ›¸ã„ãŸ" name=twitter:description><meta content=https://blog.ymgyt.io/images/emoji/closed_book.png name=twitter:image><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><body><div class=world><div class=content-container><header class=blog-header-container><div class=blog-logo><a href=https://blog.ymgyt.io>Happy developing</a></div><div class=blog-nav><nav><ul><li><a href=https://blog.ymgyt.io/entry/>Entries</a><li><a href=https://blog.ymgyt.io/tags/>Tags</a><li><a href=https://blog.ymgyt.io/about/>About</a><li><a href=https://github.com/ymgyt> <img alt=Github class=icon src=https://blog.ymgyt.io/images/icon/github.svg> </a><li><a href="https://twitter.com/YAmaguchixt "> <img alt=Twitter class=icon src=https://blog.ymgyt.io/images/icon/twitter.svg> </a></ul></nav></div></header><main class=blog-main><article><header class=entry-header><h1 class=entry-title>ğŸ“• Rust Atomics and Locksã‚’èª­ã‚“ã æ„Ÿæƒ³</h1><div class=entry-meta><p class=entry-meta-item>ğŸ—“ 2022-12-31<p class=entry-meta-item>ğŸ· <span class=tag><a href=https://blog.ymgyt.io/tags/rust/>rust</a></span> <span class=tag><a href=https://blog.ymgyt.io/tags/book/>book</a></span></div></header><aside class=entry-toc><nav><ul class=entry-toc-toplevel-list><li><a href=https://blog.ymgyt.io/entry/rust_atomics_and_locks/#du-ndaben>èª­ã‚“ã æœ¬</a><li><a href=https://blog.ymgyt.io/entry/rust_atomics_and_locks/#matome>ã¾ã¨ã‚</a><li><a href=https://blog.ymgyt.io/entry/rust_atomics_and_locks/#chapter-1-basics-of-rust-concurrency>Chapter 1 Basics of Rust Concurrency</a> <ul><li><a href=https://blog.ymgyt.io/entry/rust_atomics_and_locks/#interior-mutability>Interior mutability</a><li><a href=https://blog.ymgyt.io/entry/rust_atomics_and_locks/#unsafecell>UnsafeCell</a><li><a href=https://blog.ymgyt.io/entry/rust_atomics_and_locks/#thread-parking>Thread parking</a><li><a href=https://blog.ymgyt.io/entry/rust_atomics_and_locks/#std-sync-condvar>std::sync::Condvar</a></ul><li><a href=https://blog.ymgyt.io/entry/rust_atomics_and_locks/#chapter-2-atomics>Chapter 2 Atomics</a> <ul><li><a href=https://blog.ymgyt.io/entry/rust_atomics_and_locks/#compare-and-exchange-operations>Compare-and-Exchange Operations</a></ul><li><a href=https://blog.ymgyt.io/entry/rust_atomics_and_locks/#chapter-3-memory-ordering>Chapter 3 Memory Ordering</a> <ul><li><a href=https://blog.ymgyt.io/entry/rust_atomics_and_locks/#reordering>Reordering</a><li><a href=https://blog.ymgyt.io/entry/rust_atomics_and_locks/#happens-before-relationship>Happens-Before Relationship</a><li><a href=https://blog.ymgyt.io/entry/rust_atomics_and_locks/#release-and-acquire-ordering>Release and Acquire Ordering</a><li><a href=https://blog.ymgyt.io/entry/rust_atomics_and_locks/#fences>Fences</a><li><a href=https://blog.ymgyt.io/entry/rust_atomics_and_locks/#common-misconceptions>Common Misconceptions</a></ul><li><a href=https://blog.ymgyt.io/entry/rust_atomics_and_locks/#chapter-4-building-our-own-spin-lock>Chapter 4 Building Our Own Spin Lock</a><li><a href=https://blog.ymgyt.io/entry/rust_atomics_and_locks/#chapter-5-build-our-own-channels>Chapter 5 Build Our Own Channels</a><li><a href=https://blog.ymgyt.io/entry/rust_atomics_and_locks/#chapter-6-building-our-own-arc>Chapter 6 Building Our Own "Arc"</a><li><a href=https://blog.ymgyt.io/entry/rust_atomics_and_locks/#chapter-7-understanding-the-processor>Chapter 7 Understanding the Processor</a> <ul><li><a href=https://blog.ymgyt.io/entry/rust_atomics_and_locks/#caching>Caching</a></ul><li><a href=https://blog.ymgyt.io/entry/rust_atomics_and_locks/#chapter-8-operating-system-primitives>Chapter 8 Operating System Primitives</a><li><a href=https://blog.ymgyt.io/entry/rust_atomics_and_locks/#chapter-9-building-our-own-locks>Chapter 9 Building Our Own Locks</a><li><a href=https://blog.ymgyt.io/entry/rust_atomics_and_locks/#chapter-10-ideas-and-inspiration>Chapter 10 Ideas and Inspiration</a><li><a href=https://blog.ymgyt.io/entry/rust_atomics_and_locks/#zui-hou-ni>æœ€å¾Œã«</a><li><a href=https://blog.ymgyt.io/entry/rust_atomics_and_locks/#can-kao>å‚è€ƒ</a></ul></nav></aside><div class=entry-content><h2 id=du-ndaben><a aria-label="Anchor link for: du-ndaben" class=zola-anchor href=#du-ndaben>èª­ã‚“ã æœ¬</a></h2><a href=https://marabos.nl/atomics/> <figure><div class=fig-images-row><img , alt src=images/rust_atomics_and_locks_book.jpeg></div></figure> </a><p><a href=https://marabos.nl/atomics/ rel=external>Rust Atomics and Locks</a><br> è‘—è€…: <a href=https://m-ou.se/ rel=external>Mara Bos</a><p>æ¥½ã—ã¿ã«ã—ã¦ã„ãŸRust Atomics and Locksã‚’èª­ã‚“ã ã®ã§æ„Ÿæƒ³ã‚’æ›¸ã„ã¦ã„ãã¾ã™ã€‚<br> Kindleç‰ˆã® 2022-12-14 First Releaseã‚’èª­ã¿ã¾ã—ãŸã€‚<h2 id=matome><a aria-label="Anchor link for: matome" class=zola-anchor href=#matome>ã¾ã¨ã‚</a></h2><p>éå¸¸ã«ãŠã‚‚ã—ã‚ãæ˜¯éãŠã™ã™ã‚ã—ãŸã„æœ¬ã§ã™ã€‚<br> ãªã‚“ã¨ã„ã£ã¦ã‚‚ã€ä¸€å†Šã¾ã‚‹ã”ã¨Atomicã¨Lockã«ã¤ã„ã¦æ›¸ã‹ã‚Œã¦ãŠã‚Š<a href=https://doc.rust-lang.org/std/sync/atomic/enum.Ordering.html rel=external><code>std::sync::atomic::Ordering</code></a>ãŒã‚ã‹ã‚‰ãªã„è‡ªåˆ†ã®ãŸã‚ã«æ›¸ã‹ã‚ŒãŸã®ã§ã¯ã¨éŒ¯è¦šã—ã¦ã—ã¾ã†ã»ã©ã«åˆºã•ã‚Šã¾ã—ãŸã€‚<br> ã¾ãŸã€èª¬æ˜ã®å¾Œã«ã¯å¿…ãšå…·ä½“ä¾‹ã‚’ã¤ã‘ã¦ãã‚Œã‚‹ã®ã§ç†è§£ã‚’ç¢ºã‹ã‚ã‚‰ã‚ŒãªãŒã‚‰èª­ã¿é€²ã‚ã‚‰ã‚Œã‚‹ç‚¹ã‚‚ã†ã‚Œã—ã„ã§ã™ã€‚<br> ç‰¹ã«ä»¥ä¸‹ã®ã‚ˆã†ãªæ–¹ã«ãŠã™ã™ã‚ã—ãŸã„ã§ã™ã€‚(å…¨ã¦è‡ªåˆ†ã®ã“ã¨ãªã®ã§ã™ãŒ)<ul><li><code>atomic</code> api(<code>AtomicI32::{compare_exchange,load,...}</code>)ã‚’ä½¿ã†éš›ã®<code>Ordering</code>(<code>Relaxed</code>,<code>Acquire</code>,<code>SeqCst</code>,...)ã«è‡ªä¿¡ãŒãªã‹ã£ãŸã‚Šã€ãã®æ„å›³ãŒã‚ã‹ã‚‰ãªã„ <ul><li><code>Ordering</code>ã‚ˆãã‚ã‹ã‚‰ãªã„ãŒã€å›°ã£ãŸã‚‰<code>SeqCst</code>æ¸¡ã—ã¦ãŠã‘ã°ã‚ˆã„ã¨æ€ã£ã¦ã„ã‚‹<li><a href=https://doc.rust-lang.org/std/sync/atomic/struct.AtomicBool.html#method.compare_exchange rel=external><code>compare_exchange</code></a>ã®api documentã®èª¬æ˜ã‚’èª­ã‚“ã§ã‚‚ãƒ”ãƒ³ã¨ã“ãªã„</ul><li>happens-before relationshipsã¨ã„ã†ç”¨èªã‚’èã„ãŸã“ã¨ã¯ã‚ã‚‹ãŒã‚ˆãã‚ã‹ã£ã¦ã„ãªã„<li><a href=https://qiita.com/qnighy/items/b3b728adf5e4a3f1a841# rel=external><code>qnighyå…ˆç”Ÿã®ã‚¢ãƒˆãƒŸãƒƒã‚¯å¤‰æ•°ã¨ãƒ¡ãƒ¢ãƒªé †åº</code></a>ãŒé›£ã—ã‹ã£ãŸ<li>Building Our Own <code>{Spin Lock,Oneshot Channel,Arc,Condvar,Mutex,RwLock}</code>ã‚’ã‚„ã£ã¦ã¿ãŸã„</ul><h2 id=chapter-1-basics-of-rust-concurrency><a aria-label="Anchor link for: chapter-1-basics-of-rust-concurrency" class=zola-anchor href=#chapter-1-basics-of-rust-concurrency>Chapter 1 Basics of Rust Concurrency</a></h2><p>æœ¬æ›¸ã§ç™»å ´ã™ã‚‹Rustã®å‹ã‚„æ¦‚å¿µã«ã¤ã„ã¦èª¬æ˜ã•ã‚Œã¾ã™ã€‚<br> å…·ä½“çš„ã«ã¯ä»¥ä¸‹ã§ã™ã€‚<ul><li><code>std::thread</code>ã®<code>spawn()</code>ã‚„<code>scope()</code>ã®ä½¿ã„æ–¹<li><code>Rc</code>ã€<code>Arc</code>ã‚„Interior mutability(<code>RefCell</code>,<code>Mutex</code>,...)<li>thread safety(<code>Send</code>,<code>Sync</code>)<li><code>std::sync::{Mutex, Condvar}</code>ã®åŸºæœ¬<li><code>thread::park()</code>ã‚„<code>Thread::unpark()</code>ã®ä½¿ã„æ–¹</ul><p>Rustã«ã¤ã„ã¦ã®æœ¬ã§ã‚ã‚ŠãŒã¡ãª<a href=https://doc.rust-lang.org/book/ rel=external>the book</a>ã«æ›¸ã‹ã‚Œã¦ã„ã‚‹ã“ã¨ã¨åŒã˜å†…å®¹ãŒæ•°ç« ã«æ¸¡ã£ã¦ç¶šãã€traitã®è§£èª¬ãŒçµ‚ã‚ã£ã¦ã‚ˆã†ã‚„ããã®æœ¬ç‹¬è‡ªã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¿ãŸã„ãªã“ã¨ã¯ãªã„ã§ã™ã€‚<br> <a href=https://blog.rust-lang.org/2022/08/11/Rust-1.63.0.html rel=external><code>1.63.0</code>ã§stableã«ãªã£ãŸ</a><code>std::thread::scope</code>ã‚‚æ²¢å±±ã§ã¦ãã¾ã™ã€‚<h3 id=interior-mutability><a aria-label="Anchor link for: interior-mutability" class=zola-anchor href=#interior-mutability>Interior mutability</a></h3><p>Interior Mutabilityã®ã¨ã“ã‚ã§ã€ä»Šã¾ã§<code>&</code>ã¯immutable referenceã¨èª¬æ˜ã•ã‚Œã¦ããŸãŒã€<code>Arc</code>ç­‰ã®interior mutabilityãŒå‡ºã¦ãã‚‹ã¨ã“ã®è¡¨ç¾ã¯æ··ä¹±ã‚’æ‹›ãã¨è¨€åŠã•ã‚Œã¦ã„ã¾ã™ã€‚<br> ã“ã®ç‚¹ã¯<a href=https://docs.rs/dtolnay/latest/dtolnay/macro._02__reference_types.html#accurate-mental-model-for-rusts-reference-types rel=external>dtolnayå…ˆç”Ÿã®essay</a>ã§ã‚‚è¨€åŠã•ã‚Œã¦ãŠã‚Šã€immutable/mutable referenceã¨ã„ã†è¡¨ç¾ã¯Ruståˆå­¦è€…ã«ã¯ç›´æ„Ÿçš„ã ãŒã€shared reference/exclusive referenceã¨ã„ã†åç§°ãŒã‚ˆã‚Šå¥½ã¾ã—ã„ã¨ã—ã¦ã„ã¾ã™ã€‚(essayã‚’rust docã¨ã—ã¦å…¬é–‹ã™ã‚‹ç™ºæƒ³ãŒæœ€é«˜ã ã¨æ€ã„ã¾ã™) ã¨ã„ã†ã“ã¨ã§è‡ªåˆ†ã‚‚ã€<code>&</code>ã¯shared referenceã§åŸºæœ¬çš„ã«ã¯å¤‰æ›´ã•ã‚Œãªã„ãŒä¾‹å¤–ã‚‚ã‚ã‚‹ã€<code>&mut</code>ã¯exclusive referenceã§exclusive borrowingã§ã‚ã‚‹ã“ã¨ãŒä¿è¨¼ã•ã‚Œã‚‹ã¨ã„ã†ç†è§£ã§ã„ã“ã†ã¨æ€ã„ã¾ã™ã€‚<h3 id=unsafecell><a aria-label="Anchor link for: unsafecell" class=zola-anchor href=#unsafecell>UnsafeCell</a></h3><p><code>UnsafeCell</code>ã¯interior mutability(<code>&self</code>ã§è‡ªèº«ã®çŠ¶æ…‹ã‚’å¤‰æ›´ã™ã‚‹)ã®primitive building blockã§ã‚ã‚‹ã¨ã•ã‚Œã€ã“ã®ã‚ã¨ã®Lockã‚„Arcã‚’å®Ÿè£…ã®å…·ä½“ä¾‹ã§ã‚‚å¿…ãšç™»å ´ã—ã¾ã™ã€‚å½¹å‰²ã¯ã€<code>UnsafeCell&lt;T></code>ã¨ã—ã¦ã€<code>get()</code>ã§<code>T</code>ã®raw pointer(<code>*mut</code>)ã‚’æä¾›ã™ã‚‹ã“ã¨ã§ã™ã€‚raw pointerã®dereferenceã¯unsafe blockã®ä¸­ã§ã—ã‹ã§ããªã„ã®ã§ã€å®Ÿè£…è€…ãŒundefined behaviorã‚’é¿ã‘ãªã‘ã‚Œã°ãªã‚‰ãªã„ã§ã™ã€‚<br> Rustã§interior mutabilityã‚’æä¾›ã—ã¦ã„ã‚‹å‹ã¯ã™ã¹ã¦<code>UnsafeCell</code>ã®wrapperã§ã™ã€‚<h3 id=thread-parking><a aria-label="Anchor link for: thread-parking" class=zola-anchor href=#thread-parking>Thread parking</a></h3><p>thread parkã«ã¤ã„ã¦ã¯ä½¿ã£ãŸã“ã¨ãŒãªãã€çŸ¥ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚<br> taskã‚’è¤‡æ•°ã®threadã«åˆ†å‰²ã™ã‚‹ã¨ã€ã©ã“ã‹ã§çµæœã‚’å—ã‘å–ã‚‹threadã«taskã®å®Œäº†ã‚’é€šçŸ¥ã—ãŸããªã‚Šã¾ã™ã€thread parkingã¯ãã‚“ãªæ™‚ã«åˆ©ç”¨ã§ãã‚‹threadé–“ã®é€šä¿¡æ©Ÿæ§‹ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>collections</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>VecDeque</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>sync</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Mutex</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>thread</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>time</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Duration</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> queue</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Mutex</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>VecDeque</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>    thread</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>scope</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>s</span><span style=color:#81a1c1>|</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>        // Consuming thread</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> t</span><span style=color:#81a1c1> =</span><span> s</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>spawn</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|| loop</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let</span><span> item</span><span style=color:#81a1c1> =</span><span> queue</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>lock</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>pop_front</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>            if let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>item</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> item</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>                dbg!</span><span style=color:#eceff4>(</span><span>item</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                thread</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>park</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        });</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>        // Producing thread</span></span>
<span class=giallo-l><span style=color:#81a1c1>        for</span><span> i</span><span style=color:#81a1c1> in</span><span style=color:#b48ead> 0</span><span style=color:#81a1c1>..</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            queue</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>lock</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>push_back</span><span style=color:#eceff4>(</span><span>i</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span>            t</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>thread</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unpark</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span>            thread</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>sleep</span><span style=color:#eceff4>(</span><span>Duration</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_secs</span><span style=color:#eceff4>(</span><span style=color:#b48ead>1</span><span style=color:#eceff4>));</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    });</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/m-ou-se/rust-atomics-and-locks/blob/main/examples/ch1-11-thread-parking.rs rel=external>https://github.com/m-ou-se/rust-atomics-and-locks/blob/main/examples/ch1-11-thread-parking.rs</a><p>consuming threadã¯queueã‹ã‚‰messageã‚’å—ã‘å–ã‚Šã€consume(<code>dbg!()</code>)ã—ã¾ã™ã€‚queueãŒç©ºã®å ´åˆã¯ã€<code>thread::park()</code>ã‚’å‘¼ã³å‡ºã—ã€sleepã—ã¾ã™ã€‚<br> producing threadã¯å®šæœŸçš„ã«queueã«messageã‚’enqueueã—ã¾ã™ã€‚enqueueã—ãŸã‚ã¨ã«<code>Thread::unpark()</code>ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚<code>thread::spawn()</code>ã®æˆ»ã‚Šå€¤ã®<code>JoinHandle</code>ã‚’ä¿æŒã™ã‚‹ã“ã¨ã§unparkã™ã‚‹threadã‚’æŒ‡å®šã—ã¾ã™ã€‚<p>thread parkingã§é‡è¦ãªã®ã¯ã€thread-1ãŒ<code>park()</code>ã™ã‚‹å‰ã«thread-2ãŒ<code>unpark()</code>ã‚’å‘¼ã³å‡ºã—ã¦ã‚‚ã€<code>unpark()</code>ãŒå‘¼ã³å‡ºã•ã‚ŒãŸã¨ã„ã†æƒ…å ±ãŒä¿æŒã•ã‚Œã€thread-1ãŒ<code>park()</code>ã—ã¦ã‚‚sleepã™ã‚‹ã“ã¨ãªãã™ãã«returnã—ã¦ãã‚Œã‚‹ã“ã¨ã§ã™ã€‚ã“ã®ç‰¹æ€§ã®ãŠã‹ã’ã§ã€<code>unpark()</code>ã™ã‚‹å´ã®threadã¯å¯¾è±¡ã®threadãŒå®Ÿéš›ã«<code>park()</code>ã§sleepã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’æ°—ã«ã—ãªãã¦ã‚ˆããªã‚Šã¾ã™ã€‚ãŸã ã—ã€<code>unpark()</code>ã‚’è¤‡æ•°å›å‘¼ã³å‡ºã—ã¦ã‚‚ã€ä¸€åº¦<code>park()</code>ãŒå‘¼ã°ã‚Œã‚‹ã¨ã€æ¬¡ã®<code>park()</code>ã§ã¯sleepã—ã¾ã™ã€‚<h3 id=std-sync-condvar><a aria-label="Anchor link for: std-sync-condvar" class=zola-anchor href=#std-sync-condvar><code>std::sync::Condvar</code></a></h3><p><code>std::sync::Condvar</code>ã«ã¤ã„ã¦ã®è§£èª¬ã‚‚ã‚ã‚Šã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>collections</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>VecDeque</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>sync</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Condvar</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>sync</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Mutex</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>thread</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>time</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Duration</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> queue</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Mutex</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>VecDeque</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> not_empty</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Condvar</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>    thread</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>scope</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>s</span><span style=color:#81a1c1>|</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>        s</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>spawn</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>||</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            loop</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                let mut</span><span> q</span><span style=color:#81a1c1> =</span><span> queue</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>lock</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>                let</span><span> item</span><span style=color:#81a1c1> = loop</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    if let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>item</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> q</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>pop_front</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                        break</span><span> item</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>                    }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                        q</span><span style=color:#81a1c1> =</span><span> not_empty</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>wait</span><span style=color:#eceff4>(</span><span>q</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#eceff4>                    }</span></span>
<span class=giallo-l><span style=color:#eceff4>                };</span></span>
<span class=giallo-l><span style=color:#88c0d0>                drop</span><span style=color:#eceff4>(</span><span>q</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>                dbg!</span><span style=color:#eceff4>(</span><span>item</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        });</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        for</span><span> i</span><span style=color:#81a1c1> in</span><span style=color:#b48ead> 0</span><span style=color:#81a1c1>..</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            queue</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>lock</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>push_back</span><span style=color:#eceff4>(</span><span>i</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span>            not_empty</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>notify_one</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span>            thread</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>sleep</span><span style=color:#eceff4>(</span><span>Duration</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_secs</span><span style=color:#eceff4>(</span><span style=color:#b48ead>1</span><span style=color:#eceff4>));</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    });</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/m-ou-se/rust-atomics-and-locks/blob/main/examples/ch1-12-condvar.rs rel=external>https://github.com/m-ou-se/rust-atomics-and-locks/blob/main/examples/ch1-12-condvar.rs</a><p>thread parkingã¨åŒæ§˜ã®ä¾‹ã§ã€queueãŒç©ºã®å ´åˆã«<code>Condvar</code>ã‚’åˆ©ç”¨ã—ã¦åŒæœŸã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>let mut</span><span> q</span><span style=color:#81a1c1> =</span><span> queue</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>lock</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>let</span><span> item</span><span style=color:#81a1c1> = loop</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    if let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>item</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> q</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>pop_front</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        break</span><span> item</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>        q</span><span style=color:#81a1c1> =</span><span> not_empty</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>wait</span><span style=color:#eceff4>(</span><span>q</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>};</span></span></code></pre><p><code>Condvar::wait</code>ã¯äº‹å‰ã«<code>Mutex::lock()</code>ã§å–å¾—ã—ãŸ<code>MutexGuard</code>ã‚’æ¸¡ã—ã¦ã€å¾…æ©Ÿã—ã¦æ¡ä»¶ãŒæº€ãŸã•ã‚Œã‚‹ã¨å†ã³ã€æˆ»ã‚Šå€¤ã¨ã—ã¦<code>MutexGuard</code>ãŒè¿”ã•ã‚Œå‡¦ç†ã‚’å†é–‹ã§ãã‚‹ã€æœ€åˆã«ã¿ã‚‹ã¨ä¸æ€è­°ãªapiã‚’ã—ã¦ã„ã¾ã™ã€‚<code>wait()</code>ã®ä¸­ã§æ¸¡ã—ãŸ<code>MutexGuard</code>ãŒdropã•ã‚Œ<code>Mutex</code>ãŒunlockã•ã‚Œã‚‹ã®ã§ã€lockã‚’ä¿æŒã—ãŸã¾ã¾sleepã™ã‚‹ã‚ã‘ã§ã¯ãªã„ã®ã§ã™ãŒã€ãã®ã‚ãŸã‚Šã®æŒ™å‹•ãŒã‚ã‹ã‚Šã¥ã‚‰ã„ã§ã™ã€‚<br> Chapter 9ã§å®Ÿéš›ã«Own <code>Condvar</code>ã‚’å®Ÿè£…ã—ã¦ã„ãã®ã§ã€ã©ã†ã—ã¦ã“ã®ã‚ˆã†ãªapiã«ãªã£ã¦ã„ã‚‹ã‹ã®ç†è§£ãŒæ·±ã¾ã‚Šã¾ã™ã€‚<h2 id=chapter-2-atomics><a aria-label="Anchor link for: chapter-2-atomics" class=zola-anchor href=#chapter-2-atomics>Chapter 2 Atomics</a></h2><p>ã„ã‚ˆã„ã‚ˆæœ¬é¡Œã®atomicã«ã¤ã„ã¦ã§ã™ã€‚<br> Rustã«ãŠã‘ã‚‹atomic operationã¯<code>std::sync::atomic::Ordering</code>ã‚’å¼•æ•°ã«ã¨ã‚Šã¾ã™ã€‚<br> ã“ã‚Œã¯operationã®orderã«é–¢ã—ã¦ã©ã®ã‚ˆã†ãªä¿è¨¼ãŒå¿…è¦ã‹ã‚’å®£è¨€ã™ã‚‹ãŸã‚ã«å¿…è¦ã§ã™ã€‚<br> Chapter 2ã§ã¯orderingã¨ã—ã¦<code>Relaxed</code>ã ã‘ã‚’ä½¿ã„ã¾ã™ã€‚<code>Relaxed</code>ã¯äºŒã¤ã®å¤‰æ•°ã«é–¢ã™ã‚‹operationã®é †ç•ªã‚’ä¿è¨¼ã—ã¦ãã‚Œã¾ã›ã‚“ã€‚thread-1ãŒå¤‰æ•°a->bã¨å¤‰æ›´ã—ãŸå ´åˆã§ã‚‚ã€thread-2ã‹ã‚‰ã¯å¤‰æ›´å‰ã®å¤‰æ•°aã¨å¤‰æ›´å¾Œã®å¤‰æ•°bãŒã¿ãˆã‚‹å ´åˆãŒã‚ã‚Šãˆã‚‹ã¨ã„ã†æ„å‘³ã§ã™ã€‚<br> ãŸã <code>Relaxed</code>ã§è¶³ã‚Šã‚‹å ´é¢ã‚‚ã‚‚ã¡ã‚ã‚“ã‚ã‚Šã€Chapter 2ã§ã¯orderingã®è©±ã‚’ãŠã„ã¦ãŠã„ã¦atomic apiã«æ…£ã‚Œã¦ã„ãã¾ã™ã€‚ã“ã®ç« æ§‹æˆã¯éå¸¸ã«ã‚ã‹ã‚Šã‚„ã™ã„ã¨æ„Ÿã˜ã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>sync</span><span style=color:#81a1c1>::</span><span>atomic</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>AtomicUsize</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>sync</span><span style=color:#81a1c1>::</span><span>atomic</span><span style=color:#81a1c1>::</span><span>Ordering</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Relaxed</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>thread</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>time</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Duration</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> num_done</span><span style=color:#81a1c1> = &</span><span style=color:#8fbcbb>AtomicUsize</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span style=color:#b48ead>0</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>    thread</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>scope</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>s</span><span style=color:#81a1c1>|</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>        // Four background threads to process all 100 items, 25 each.</span></span>
<span class=giallo-l><span style=color:#81a1c1>        for</span><span> t</span><span style=color:#81a1c1> in</span><span style=color:#b48ead> 0</span><span style=color:#81a1c1>..</span><span style=color:#b48ead>4</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            s</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>spawn</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>move ||</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                for</span><span> i</span><span style=color:#81a1c1> in</span><span style=color:#b48ead> 0</span><span style=color:#81a1c1>..</span><span style=color:#b48ead>25</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0>                    process_item</span><span style=color:#eceff4>(</span><span>t</span><span style=color:#81a1c1> *</span><span style=color:#b48ead> 25</span><span style=color:#81a1c1> +</span><span> i</span><span style=color:#eceff4>);</span><span style=color:#616e88> // Assuming this takes some time.</span></span>
<span class=giallo-l><span>                    num_done</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>fetch_add</span><span style=color:#eceff4>(</span><span style=color:#b48ead>1</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Relaxed</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#eceff4>            });</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>        // The main thread shows status updates, every second.</span></span>
<span class=giallo-l><span style=color:#81a1c1>        loop</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let</span><span> n</span><span style=color:#81a1c1> =</span><span> num_done</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>load</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Relaxed</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>            if</span><span> n</span><span style=color:#81a1c1> ==</span><span style=color:#b48ead> 100</span><span style=color:#eceff4> {</span><span style=color:#81a1c1> break</span><span style=color:#eceff4>; }</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>            println!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Working.. </span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>n</span><span style=color:#ebcb8b>}</span><span style=color:#a3be8c>/100 done</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span>            thread</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>sleep</span><span style=color:#eceff4>(</span><span>Duration</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_secs</span><span style=color:#eceff4>(</span><span style=color:#b48ead>1</span><span style=color:#eceff4>));</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    });</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    println!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Done!</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> process_item</span><span style=color:#eceff4>(</span><span>_</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> usize</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span>    thread</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>sleep</span><span style=color:#eceff4>(</span><span>Duration</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_millis</span><span style=color:#eceff4>(</span><span style=color:#b48ead>123</span><span style=color:#eceff4>));</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/m-ou-se/rust-atomics-and-locks/blob/main/examples/ch2-06-progress-reporting-multiple-threads.rs rel=external>https://github.com/m-ou-se/rust-atomics-and-locks/blob/main/examples/ch2-06-progress-reporting-multiple-threads.rs</a><p><code>Relaxed</code>ã§å•é¡Œãªã„å ´åˆã®ä¸€ä¾‹ã¨ã—ã¦ã€threadé–“ã§å…±æœ‰ã•ã‚Œã‚‹å¤‰æ•°ãŒ1ã¤ã®å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ä¸Šè¨˜ã§ã¯<code>num_done</code>ã ã‘ãŒé–¢å¿ƒã®å¯¾è±¡ãªã®ã§<code>Relaxed</code>ã§ç‰¹ã«å•é¡ŒãŒç”Ÿã˜ã¾ã›ã‚“ã€‚<h3 id=compare-and-exchange-operations><a aria-label="Anchor link for: compare-and-exchange-operations" class=zola-anchor href=#compare-and-exchange-operations>Compare-and-Exchange Operations</a></h3><p>ä»Šå¾Œã‚‚é »ç¹ã«ç™»å ´ã—ã€æœ€ã‚‚flexibleãªatomic operationã§ã‚ã‚‹<code>compare_exchange</code>ã«ã¤ã„ã¦ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> AtomicI32</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> compare_exchange</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#81a1c1>        &self</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        expected</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> i32</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        new</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> i32</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        success_order</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Ordering</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        failure_order</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Ordering</span></span>
<span class=giallo-l><span style=color:#eceff4>    )</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>i32</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> i32</span><span style=color:#eceff4>>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>Bos, Mara. Rust Atomics and Locks (p. 80). O'Reilly Media. Kindle Edition.<p><code>compare_exchange</code>ã¯è‡ªèº«ã®å€¤ãŒ<code>expected</code>ã§æŒ‡å®šã•ã‚ŒãŸå€¤ã¨åŒã˜å ´åˆã«é™ã£ã¦ã€<code>new</code>ã®å€¤ã‚’æ›¸ãè¾¼ã¿ã€æ›¸ãè¾¼ã¿å‰ã®å€¤ã‚’è¿”ã—ã¾ã™ã€‚æˆ»ã‚Šå€¤ã¯ä»¥å‰ã®å€¤ã§ã€exchangeãŒæˆåŠŸã—ãŸå ´åˆã¯ã“ã‚Œã¯<code>expected</code>ã¨ä¸€è‡´ã—ã¾ã™ã€‚<br> é›£ã—ã„ã®ã¯ã€<code>Ordering</code>ã‚’äºŒã¤æ¸¡ã™å¿…è¦ãŒã‚ã‚‹ã¨ã“ã‚ã§ã™ã€‚å¤±æ•—æ™‚(ç¾åœ¨ã®å€¤ã¨<code>expected</code>ãŒä¸€è‡´ã—ãªã„)ã«ã¯ã€ç¾åœ¨ã®å€¤ã‚’loadã™ã‚‹å‡¦ç†ã®ã¿ãŒèµ°ã‚‹ã¯ãšãªã®ã§ã€<code>Ordering</code>ã®æŒ‡å®šã¯ä¸€ã¤ã ã¨æ€ã„ã¾ã™ãŒã€æˆåŠŸæ™‚ã¯loadã—ã¦ã€storeã™ã‚‹ã¯ãšãªã®ã«ã€<code>Ordering</code>ã®æŒ‡å®šã¯1ã¤ãªã¨ã“ã‚ãŒç²’åº¦ãŒã‚ã£ã¦ã„ãªãã¦ãƒ”ãƒ³ã¨ãã¦ã„ã¾ã›ã‚“ã§ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>sync</span><span style=color:#81a1c1>::</span><span>atomic</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>AtomicU32</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>sync</span><span style=color:#81a1c1>::</span><span>atomic</span><span style=color:#81a1c1>::</span><span>Ordering</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Relaxed</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> increment</span><span style=color:#eceff4>(</span><span>a</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>AtomicU32</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> current</span><span style=color:#81a1c1> =</span><span> a</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>load</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Relaxed</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>    loop</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> new</span><span style=color:#81a1c1> =</span><span> current</span><span style=color:#81a1c1> +</span><span style=color:#b48ead> 1</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        match</span><span> a</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>compare_exchange</span><span style=color:#eceff4>(</span><span>current</span><span style=color:#eceff4>,</span><span> new</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Relaxed</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Relaxed</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Ok</span><span style=color:#eceff4>(</span><span>_</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> => return</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Err</span><span style=color:#eceff4>(</span><span>v</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span> current</span><span style=color:#81a1c1> =</span><span> v</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> a</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> AtomicU32</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span style=color:#b48ead>0</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#88c0d0>    increment</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>a</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#88c0d0>    increment</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>a</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    assert_eq!</span><span style=color:#eceff4>(</span><span>a</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into_inner</span><span style=color:#eceff4>(),</span><span style=color:#b48ead> 2</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/m-ou-se/rust-atomics-and-locks/blob/main/examples/ch2-11-increment-with-compare-exchange.rs rel=external>https://github.com/m-ou-se/rust-atomics-and-locks/blob/main/examples/ch2-11-increment-with-compare-exchange.rs</a><p>ä¸Šè¨˜ã¯ã€<code>compare_exchange</code>ã‚’åˆ©ç”¨ã—ã¦å¤‰æ•°aã‚’incrementã™ã‚‹ä¾‹ã§ã™ã€‚å¤±æ•—ã—ãŸå ´åˆã®æˆ»ã‚Šå€¤ã‚’<code>current</code>ã«ä»£å…¥ã—ã¦loopã‚’å†é–‹ã—ã¦ã„ã‚‹ã¨ã“ã‚ãŒãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚<p><code>compare_exchage</code>ã«ã¯<code>compare_exchange_weak</code>ã¨ã„ã†ä¼¼ã¦ã„ã‚‹å‡¦ç†ãŒã‚ã‚Šã¾ã™ã€‚<br> ã“ã‚Œã¯ç¾åœ¨ã®å€¤ã¨<code>expected</code>ãŒä¸€è‡´ã™ã‚‹å ´åˆã§ã‚‚ã€exchangeãŒå¤±æ•—ã™ã‚‹å ´åˆãŒã‚ã‚‹å‡¦ç†ã§ã™ã€‚<br> ä¸Šè¨˜ã®incrementã®ä¾‹ã¯å¤±æ•—ã—ãŸå ´åˆã§ã®retryã®costãŒå®‰ã„ã®ã§weakã®ã»ã†ãŒå¥½ã¾ã—ã„ã¨ã•ã‚Œã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>sync</span><span style=color:#81a1c1>::</span><span>atomic</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>AtomicU64</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>sync</span><span style=color:#81a1c1>::</span><span>atomic</span><span style=color:#81a1c1>::</span><span>Ordering</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Relaxed</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> get_key</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> u64</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    static</span><span> KEY</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> AtomicU64</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> AtomicU64</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span style=color:#b48ead>0</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> key</span><span style=color:#81a1c1> =</span><span> KEY</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>load</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Relaxed</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>    if</span><span> key</span><span style=color:#81a1c1> ==</span><span style=color:#b48ead> 0</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> new_key</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> generate_random_key</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>        match</span><span> KEY</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>compare_exchange</span><span style=color:#eceff4>(</span><span style=color:#b48ead>0</span><span style=color:#eceff4>,</span><span> new_key</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Relaxed</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Relaxed</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Ok</span><span style=color:#eceff4>(</span><span>_</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span> new_key</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Err</span><span style=color:#eceff4>(</span><span>k</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span> k</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>        key</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> generate_random_key</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> u64</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#b48ead>    123</span></span>
<span class=giallo-l><span style=color:#616e88>    // TODO</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    dbg!</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>get_key</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    dbg!</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>get_key</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    dbg!</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>get_key</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/m-ou-se/rust-atomics-and-locks/blob/main/examples/ch2-13-lazy-one-time-init.rs rel=external>https://github.com/m-ou-se/rust-atomics-and-locks/blob/main/examples/ch2-13-lazy-one-time-init.rs</a><p><code>compare_exchange_weak</code>ã§ã¯é©ã•ãšã€<code>compare_exchange</code>ã‚’ä½¿ã†ã¹ãå ´é¢ã®ä¸€ä¾‹ã¨ã—ã¦ã€lazy initializationã®ä¾‹ãŒæŒ™ã’ã‚‰ã‚Œã¦ã„ã¾ã—ãŸã€‚<br> <code>get_key</code>ã¯applicationã§åˆ©ç”¨ã™ã‚‹keyã‚’è¿”ã™å‡¦ç†ã§ã€æœ€åˆã«å–å¾—ã‚’è¦æ±‚ã—ãŸã¨ãã«ç”Ÿæˆã•ã‚Œã¾ã™ã€‚(lazy)<br> ãŸã ã—ã€ä¸€åº¦ç”Ÿæˆã•ã‚ŒãŸå ´åˆã¯å¿…ãšåŒã˜å€¤ã‚’è¿”ã™å¿…è¦ãŒã‚ã‚Šã€åŒæ™‚ã«äºŒã¤ã®threadã‹ã‚‰å‘¼ã°ã‚ŒãŸå ´åˆã«åŒæ™‚ã«ç”Ÿæˆå‡¦ç†ãŒèµ°ã‚Šã€ç•°ãªã‚‹å€¤ã‚’è¿”ã™ã¨ã„ã£ãŸã“ã¨ã¯è¨±å®¹ã•ã‚Œãªã„ã‚±ãƒ¼ã‚¹ã§ã™ã€‚<br> ã“ã®å ´åˆã§ã‚‚é–¢å¿ƒã®å¯¾è±¡ã®å¤‰æ•°ã¯1ã¤ãªã®ã§<code>Relaxed</code>ã§å•é¡Œãªã„ã®ã§ã™ãŒã€ç”Ÿæˆæ™‚ã«ã€<code>compare_exchange</code>ã§å¿…ãšç¾åœ¨ã®å€¤ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„(0)ã“ã¨ã‚’å³å¯†ã«ç¢ºã‹ã‚ãŸã„ã®ã§ã“ã“ã§ã¯weakãŒä½¿ãˆã¾ã›ã‚“ã€‚<p>ã“ã®ä»–ã«ã‚‚overflowã¸ã®å¯¾å‡¦ã®ä»•æ–¹ç­‰ãŠã‚‚ã—ã‚ã„è©±ãŒã®ã£ã¦ã„ã¾ã™ã€‚<br> compare_exchangeã®ä½¿ã„æ–¹ã‚‚ã‚ã‹ã£ãŸã®ã§æ¬¡ã¯ã„ã‚ˆã„ã‚ˆMemory Orderingã§ã™ã€‚<h2 id=chapter-3-memory-ordering><a aria-label="Anchor link for: chapter-3-memory-ordering" class=zola-anchor href=#chapter-3-memory-ordering>Chapter 3 Memory Ordering</a></h2><p>ã„ã‚ˆã„ã‚ˆmemory orderingã«ã¤ã„ã¦ã§ã™ã€‚<br> ã“ã®ç« ã ã‘ã§ã‚‚æœ¬æ›¸ã‚’è²·ã†ä¾¡å€¤ãŒã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚<h3 id=reordering><a aria-label="Anchor link for: reordering" class=zola-anchor href=#reordering>Reordering</a></h3><p>ã¾ãšå‰æã¨ã—ã¦compilerã‚‚cpu processorã‚‚programã‚’æ›¸ã‹ã‚ŒãŸé€šã‚Šã®é †ç•ªã§å®Ÿè¡Œã—ã¦ãã‚Œã‚‹ã¨ã¯é™ã‚Šã¾ã›ã‚“ã€‚<br> ã“ã®ç‚¹ã¯<a href=https://tech.unifa-e.com/entry/2018/07/24/120258 rel=external>ãªãœé•ã†å€¤ã‚’è¦‹ãŸã®ã‹ãƒ¼ãƒ¼ä¸¦åˆ—å®Ÿè¡Œã«ãŠã‘ã‚‹CPUã®å‹•ä½œ</a>ã§<blockquote><ol><li>ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«<li>CPUã§å®Ÿè¡Œã™ã‚‹<li>CPUã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ã‚ˆã‚‹reorderã‚ˆã†ãªç¾è±¡</ol></blockquote><p>ã¨ã„ã†CPUå´ã§ã‚‚2æ®µéšã‚ã‚‹ã¨ã„ã†èª¬æ˜ãŒã‚ã‹ã‚Šã‚„ã™ã‹ã£ãŸã§ã™ã€‚<br> CPUã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ã‚ˆã‚‹reorderã®ã‚ˆã†ãªç¾è±¡ã«é–¢ã—ã¦ã¯ä¸Šè¨˜ãƒ–ãƒ­ã‚°ã§å‚ç…§ã•ã‚Œã¦ã„ãŸ<a href=http://www.rdrop.com/users/paulmck/scalability/paper/whymb.2010.07.23a.pdf rel=external>Memory Barriers: a Hardware View for Software Hackers</a>ã®èª¬æ˜ã‚’èª­ã‚“ã§ç¢ºã‹ã«reorderã•ã‚Œã¾ã™ã­..ã¨ã„ã†æ°—æŒã¡ã«ãªã‚Šã¾ã—ãŸã€‚<p>ãã—ã¦Rustã«ãŠã„ã¦compilerã¨processorã«reorderã«é–¢ã—ã¦åˆ¶ç´„ã‚’ä¼ãˆãŸã„å ´åˆã«åˆ©ç”¨ã§ãã‚‹ã®ã¯<ul><li><code>Relaxed</code><li><code>Release, Acquire, AcqRel</code><li><code>SeqCst</code></ul><p>ã®3ç¨®é¡ã§ã™ã€‚C++ã§ã¯consume orderingã¨ã„ã†ã‚‚ã®ã‚‚ã‚ã‚‹ã¨ã®ã“ã¨ã§ã™ãŒã€Rustã«ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚<h3 id=happens-before-relationship><a aria-label="Anchor link for: happens-before-relationship" class=zola-anchor href=#happens-before-relationship>Happens-Before Relationship</a></h3><p>processorã®æ§˜ã€…ãªæ©Ÿæ§‹ã«ã‚ˆã‚Šreorderã¯èµ·ãã‚‹ã®ã§ã™ãŒã€ãã‚Œã‚‰ã‚’ã™ã¹ã¦æŠ½è±¡åŒ–ã—ã¦ã€è¦ã¯ä»–ã®threadã§è¡Œã‚ã‚ŒãŸå¤‰æ•°ã¸ã®å¤‰æ›´ãŒç¾åœ¨å®Ÿè¡Œä¸­ã®threadã‹ã‚‰è¦‹ãˆã‚‹ã®ã‹è¦‹ãˆãªã„ã®ã‹ã‚’happens-before relationshipã¨ã„ã†æ¦‚å¿µã§å®šç¾©ã—ã¾ã™ã€‚<br> ã¯ã£ãã‚Šæ›¸ã‹ã‚Œã¦ã„ã¾ã›ã‚“ãŒã€"happen"ã¨ã„ã†ã®ã¯threadã‹ã‚‰è¦‹ãˆã‚‹ã¨ã„ã†æ„å‘³ã§ç†è§£ã—ã¦ã„ã¾ã™ã€‚<p>ã¾ãšå½“ãŸã‚Šå‰ã«æ€ãˆã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€åŒä¸€threadå†…ã§ã¯ã™ã¹ã¦in orderã«happenã—ã¾ã™ã€‚<br> ã“ã®ãƒ«ãƒ¼ãƒ«ãŒã‚ã‚‹ã®ã§single threadã®programmingã®æ–‡è„ˆã§ã¯reorderã‚’æ„è­˜ã—ãªãã¦ã‚ˆãã€ã—ãŸãŒã£ã¦atomicã®orderã‚‚è€ƒãˆãªãã¦ã‚ˆã„ã‚ã‘ã§ã—ãŸã€‚<p>threadã®<code>spawn()</code>,<code>join()</code>ã§ã‚‚ãã‚Œãã‚Œã®threadé–“ã§happens-beforeã®é–¢ä¿‚ãŒçµã°ã‚Œã¾ã™ã€‚<br> å…·ä½“çš„ã«ã¯<code>thread::spawn()</code>ã§ã§ããŸthreadã‹ã‚‰ã¯ãã®å‰ã®å¤‰æ•°ã®å¤‰æ›´ãŒè¦‹ãˆã€ãã®threadã‚’joinã™ã‚‹ã¨threadå†…ã§è¡Œã‚ã‚ŒãŸå¤‰æ•°ã®å¤‰æ›´ãŒè¦‹ãˆã‚‹ã“ã¨ãŒä¿è¨¼ã•ã‚Œã¾ã™ã€‚<p><a href=https://github.com/m-ou-se/rust-atomics-and-locks/blob/main/examples/ch3-02-spawn-join.rs rel=external>https://github.com/m-ou-se/rust-atomics-and-locks/blob/main/examples/ch3-02-spawn-join.rs</a><h3 id=release-and-acquire-ordering><a aria-label="Anchor link for: release-and-acquire-ordering" class=zola-anchor href=#release-and-acquire-ordering>Release and Acquire Ordering</a></h3><p>Releaseã¨acquire orderingã¯happens-before relationshipã‚’ç”Ÿã˜ã•ã›ã‚‹ãŸã‚ã«pairã§ä½¿ã„ã€releaseã¯store operationã«ã€acquireã¯load operationã«æŒ‡å®šã™ã‚‹ã¨ã„ã†ã®ãŒã¾ãšã€å‰æã€‚<blockquote><p>A happens-before relationship is formed when an acquire-load operation observes the result of a release-store operation. In this case, the store and everything before it, happened before the load and everything after it.</blockquote><p>Bos, Mara. Rust Atomics and Locks (p. 101). O'Reilly Media. Kindle Edition.<p>ã“ã®èª¬æ˜ãŒæœ¬å½“ã«ã‚ã‹ã‚Šã‚„ã™ã‹ã£ãŸã§ã™ã€‚thread-1ãŒã‚ã‚‹atomicå¤‰æ•°ã«releaseã§storeã—ã¦ã€ãã®çµæœã‚’åˆ¥ã®thread-2ãŒacquireã§loadã™ã‚‹ã¨ã€happens-beforeã®é–¢ä¿‚ãŒãªã‚ŠãŸã¡ã€thread-1ã®å½“è©²atomicå¤‰æ•°ä»¥å¤–ã®å¤‰æ›´ã‚‚thread-2ã‹ã‚‰è¦‹ãˆã‚‹ã‚ˆã†ã«ãªã‚‹ã¨ã€ç†è§£ã—ã¦ã„ã¾ã™ã€‚<p>å…·ä½“ä¾‹ã§ã¿ãŸã»ã†ãŒã‚ã‹ã‚Šã‚„ã™ã„ã§ã™ã­ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>static</span><span> DATA</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> AtomicU64</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> AtomicU64</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span style=color:#b48ead>0</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>static</span><span> READY</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> AtomicBool</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> AtomicBool</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>false</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span>    thread</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>spawn</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>||</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>        DATA</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>store</span><span style=color:#eceff4>(</span><span style=color:#b48ead>123</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Relaxed</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span>        READY</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>store</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>true</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Release</span><span style=color:#eceff4>);</span><span style=color:#616e88> // Everything from before this store ..</span></span>
<span class=giallo-l><span style=color:#eceff4>    });</span></span>
<span class=giallo-l><span style=color:#81a1c1>    while !</span><span>READY</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>load</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Acquire</span><span style=color:#eceff4>) {</span><span style=color:#616e88> // .. is visible after this loads `true`.</span></span>
<span class=giallo-l><span>        thread</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>sleep</span><span style=color:#eceff4>(</span><span>Duration</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_millis</span><span style=color:#eceff4>(</span><span style=color:#b48ead>100</span><span style=color:#eceff4>));</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>        println!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>waiting...</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    println!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{}</span><span style=color:#eceff4>",</span><span> DATA</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>load</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Relaxed</span><span style=color:#eceff4>));</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>https://github.com/m-ou-se/rust-atomics-and-locks/blob/main/examples/ch3-06-release-acquire.rs<p><code>READY.store(true,Release)</code>ã§release storeã—ãŸçµæœã‚’ã€<code>!READY.load(Acquire)</code>ã§èª­ã‚“ã§ã„ã‚‹ã®ã§ã€happens-beforeã®é–¢ä¿‚ãŒæˆç«‹ã—ã€<code>DATA.store(123,Relaxed)</code>ã®çµæœãŒmain threadã‹ã‚‰è¦‹ãˆã‚‹ã“ã¨ãŒä¿è¨¼ã•ã‚Œã‚‹ã®ã§ã€ä¸Šè¨˜ã®å‡ºåŠ›çµæœãŒ123ã«ãªã‚‹ã“ã¨ãŒä¿è¨¼ã•ã‚Œã¾ã™ã€‚<br> ã¾ãŸã€ã“ã®ç‚¹ãŒé‡è¦ãªã®ã§ã™ãŒã€ä¸Šè¨˜ã§ã¯åŒæœŸã—ãŸã„å¤‰æ•°ãŒ<code>DATA: AtomicU64</code>ã®ã‚ˆã†ã«atoimcå¤‰æ•°ã§ã—ãŸãŒã€happens-before relationshipã®å¯¾è±¡ã«ãªã‚‹ã®ã«atomicå¤‰æ•°ã§ã‚ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€ãŸã threadé–“ã§å…±æœ‰ã™ã‚‹ãŸã‚ã«<code>Sync</code>ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§ã€<code>AtomicU64</code>ã ã£ãŸã ã‘ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>static mut</span><span> DATA</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> u64</span><span style=color:#81a1c1> =</span><span style=color:#b48ead> 0</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>static</span><span> READY</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> AtomicBool</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> AtomicBool</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>false</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span>    thread</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>spawn</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>||</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>        // Safety: Nothing else is accessing DATA,</span></span>
<span class=giallo-l><span style=color:#616e88>        // because we haven't set the READY flag yet.</span></span>
<span class=giallo-l><span style=color:#81a1c1>        unsafe</span><span style=color:#eceff4> {</span><span> DATA</span><span style=color:#81a1c1> =</span><span style=color:#b48ead> 123</span><span style=color:#eceff4> };</span></span>
<span class=giallo-l><span>        READY</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>store</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>true</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Release</span><span style=color:#eceff4>);</span><span style=color:#616e88> // Everything from before this store ..</span></span>
<span class=giallo-l><span style=color:#eceff4>    });</span></span>
<span class=giallo-l><span style=color:#81a1c1>    while !</span><span>READY</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>load</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Acquire</span><span style=color:#eceff4>) {</span><span style=color:#616e88> // .. is visible after this loads `true`.</span></span>
<span class=giallo-l><span>        thread</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>sleep</span><span style=color:#eceff4>(</span><span>Duration</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_millis</span><span style=color:#eceff4>(</span><span style=color:#b48ead>100</span><span style=color:#eceff4>));</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>        println!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>waiting...</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#616e88>    // Safety: Nothing is mutating DATA, because READY is set.</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    println!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{}</span><span style=color:#eceff4>",</span><span style=color:#81a1c1> unsafe</span><span style=color:#eceff4> {</span><span> DATA</span><span style=color:#eceff4> });</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/m-ou-se/rust-atomics-and-locks/blob/main/examples/ch3-07-release-acquire-unsafe.rs rel=external>https://github.com/m-ou-se/rust-atomics-and-locks/blob/main/examples/ch3-07-release-acquire-unsafe.rs</a><p>ã¤ã¾ã‚Šã€ä¸Šè¨˜ã®ä¾‹ã®ã‚ˆã†ã«åŒæœŸã®å¯¾è±¡ã‚’<code>u64</code>ã«ã—ã¦ã‚‚unsafeã‚’ä¼´ã†ã‚‚ã®ã®ã€<code>AtomicU64</code>åŒæ§˜ã«123ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã“ã¨ãŒä¿è¨¼ã•ã‚Œã¾ã™ã€‚<p>ã„ã‚„ãƒ¼ã€æœ¬å½“ã«ã‚ã‹ã‚Šã‚„ã™ã„ã§ã™ã­ã€‚è¦ã¯ä»–ã®threadã«è¦‹ã›ãŸã„å¤‰æ›´ã‚’å®Ÿæ–½ã—ãŸã®ã¡åˆ¶å¾¡ç”¨ã®atomicå¤‰æ•°ã«releaseã§storeã™ã‚‹ã¨ã€å½“è©²å¤‰æ•°ã‚’acquireã§loadã—ãŸthreadã«å¤‰æ›´ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«ãªã‚‹ã¨ã„ã†ç†è§£ã§ã™ã€‚<br> ã‚ˆã‚Šè¤‡é›‘ãªã‚±ãƒ¼ã‚¹ã§ã‚‚ç†è§£ã§ãã‚‹ã‹ã‚ã‚„ã—ã„ã§ã™ãŒã€ã“ã‚Œãã‚‰ã„ãªã‚‰è‡ªåˆ†ã§ã‚‚ç†è§£ã§ãã¾ã—ãŸã€ã‚‚ã—ã‹ã—ã¦happens-before relationshipã‚ã‹ã‚Šã‚„ã™ã„ã®ã‹ã€‚<p>ã¨ã„ã†ã“ã¨ã§æ¬¡ã®ä¾‹ã¯ã¡ã‚‡ã£ã¨ã ã‘å¿œç”¨ç·¨ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> get_data</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -> &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>static Data</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    static</span><span> PTR</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> AtomicPtr</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Data</span><span style=color:#eceff4>></span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> AtomicPtr</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>std</span><span style=color:#81a1c1>::</span><span>ptr</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>null_mut</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> p</span><span style=color:#81a1c1> =</span><span> PTR</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>load</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Acquire</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    if</span><span> p</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>is_null</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span>        p</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Box</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>into_raw</span><span style=color:#eceff4>(</span><span>Box</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>generate_data</span><span style=color:#eceff4>()));</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if let</span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span>e</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> PTR</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>compare_exchange</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>            std</span><span style=color:#81a1c1>::</span><span>ptr</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>null_mut</span><span style=color:#eceff4>(),</span><span> p</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Release</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Acquire</span></span>
<span class=giallo-l><span style=color:#eceff4>        ) {</span></span>
<span class=giallo-l><span style=color:#616e88>            // Safety: p comes from Box::into_raw right above,</span></span>
<span class=giallo-l><span style=color:#616e88>            // and wasn't shared with any other thread.</span></span>
<span class=giallo-l><span style=color:#88c0d0>            drop</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>unsafe</span><span style=color:#eceff4> {</span><span> Box</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_raw</span><span style=color:#eceff4>(</span><span>p</span><span style=color:#eceff4>) });</span></span>
<span class=giallo-l><span>            p</span><span style=color:#81a1c1> =</span><span> e</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    // Safety: p is not null and points to a properly initialized value.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    unsafe</span><span style=color:#eceff4> {</span><span style=color:#81a1c1> &*</span><span>p</span><span style=color:#eceff4> }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> Data</span><span style=color:#eceff4>([</span><span style=color:#8fbcbb>u8</span><span style=color:#eceff4>;</span><span style=color:#b48ead> 100</span><span style=color:#eceff4>]);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> generate_data</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Data</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0>    Data</span><span style=color:#eceff4>([</span><span style=color:#b48ead>123</span><span style=color:#eceff4>;</span><span style=color:#b48ead> 100</span><span style=color:#eceff4>])</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    println!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>:p</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>",</span><span style=color:#88c0d0> get_data</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    println!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>:p</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>",</span><span style=color:#88c0d0> get_data</span><span style=color:#eceff4>());</span><span style=color:#616e88> // Same address as before.</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/m-ou-se/rust-atomics-and-locks/blob/main/examples/ch3-09-lazy-init-box.rs rel=external>https://github.com/m-ou-se/rust-atomics-and-locks/blob/main/examples/ch3-09-lazy-init-box.rs</a><p>å‰å›ã¯æ‰±ã£ã¦ã„ãŸdataã¯1å¤‰æ•°ã§ã—ãŸãŒã€ä»Šå›ã¯<code>Data([u8; 100])</code>ã§atomicã«æ›¸ãæ›ãˆãŒã§ãã¾ã›ã‚“ã€‚<br> ãã“ã§ã€ãã®dataã‚’æ‰±ã†pointerã‚’atomicã«ã™ã‚‹ã“ã¨ã§ã€ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–å‡¦ç†ã‚’atomicã«åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚<br> ä»Šå›ã®<code>compare_exchange</code>ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span>p</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Box</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>into_raw</span><span style=color:#eceff4>(</span><span>Box</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>generate_data</span><span style=color:#eceff4>()));</span></span>
<span class=giallo-l><span style=color:#81a1c1>if let</span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span>e</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> PTR</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>compare_exchange</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>    std</span><span style=color:#81a1c1>::</span><span>ptr</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>null_mut</span><span style=color:#eceff4>(),</span><span> p</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Release</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Acquire</span></span>
<span class=giallo-l><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#616e88>    // Safety: p comes from Box::into_raw right above,</span></span>
<span class=giallo-l><span style=color:#616e88>    // and wasn't shared with any other thread.</span></span>
<span class=giallo-l><span style=color:#88c0d0>    drop</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>unsafe</span><span style=color:#eceff4> {</span><span> Box</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_raw</span><span style=color:#eceff4>(</span><span>p</span><span style=color:#eceff4>) });</span></span>
<span class=giallo-l><span>    p</span><span style=color:#81a1c1> =</span><span> e</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>compare_exchange</code>ã®ç¬¬ä¸€å¼•æ•°ã«ã¯<code>Release</code>ã‚’æŒ‡å®šã—ã¾ã™ã€‚ã“ã‚Œã¯å‡¦ç†ãŒæˆåŠŸã—ãŸå ´åˆã«å¾Œç¶šã®loadå‡¦ç†ã«å¯¾ã—ã¦<br> <code>p = Box::into_raw(Box::new(generate_data()));</code>ã‚’è¦‹ãˆã‚‹ã‚ˆã†ã«ã—ã¦ãŠããŸã‚ã§ã™ã€‚<br> ãƒã‚¤ãƒ³ãƒˆã¯ç¬¬äºŒå¼•æ•°ã®<code>Acquire</code>ã§ã™ã€‚ã“ã®<code>compare_exchage</code>ãŒå¤±æ•—ã™ã‚‹ã¨ã„ã†ã“ã¨ã¯<code>get_data()</code>ãŒåŒæ™‚ã«è¤‡æ•°ã®threadã‹ã‚‰å‘¼ã°ã‚Œã€æ—¢ã«ã€<code>Data</code>ãŒåˆæœŸåŒ–ã•ã‚ŒãŸå ´åˆã§ã™ã€‚ãã®éš›ã«ã¯<code>Err(e)</code>ã«ãã®åˆæœŸåŒ–ã•ã‚ŒãŸ<code>Data</code>ã®pointerãŒå…¥ã‚‹ã®ã§ã™ãŒãã®pointerã®å…ˆã®åˆæœŸåŒ–å‡¦ç†ã‚‚ç¢ºå®Ÿã«ã¿ãˆã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§ã€<code>Acquire</code>ã‚’æŒ‡å®šã—ã¦ã„ã‚‹ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚<br> æœ¬æ›¸ã§ã¯ä¸Šè¨˜ã®ã‚ˆã†ãªhappens-beforeã®ä¾‹ãŒå›³ã§ç¤ºã•ã‚Œã¦ãŠã‚Šéå¸¸ã«ç›´æ„Ÿçš„ãªã®ã§æ˜¯éèª­ã‚“ã§ã¿ã¦æ¬²ã—ã„ã§ã™ã€‚<h3 id=fences><a aria-label="Anchor link for: fences" class=zola-anchor href=#fences>Fences</a></h3><p><code>std::sync::atomic::fence</code>ã¨ã„ã†é–¢æ•°ãŒã‚ã‚Šã€release storeã‚„acquire loadã¯<code>fence</code>ã‚’ä½¿ã£ã¦ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãç›´ã™ã“ã¨ãŒã§ãã‚‹ã“ã¨ãŒèª¬æ˜ã•ã‚Œã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span>a</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>store</span><span style=color:#eceff4>(</span><span style=color:#b48ead>1</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Release</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>// ğŸ‘‡</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>fence</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Release</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span>a</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>store</span><span style=color:#eceff4>(</span><span style=color:#b48ead>1</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Relaxed</span><span style=color:#eceff4>);</span></span></code></pre><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span>a</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>load</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Acquire</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>// ğŸ‘‡</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>a</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>load</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Relaxed</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#88c0d0>fence</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Acquire</span><span style=color:#eceff4>);</span></span></code></pre><p>releaseã‚„acquireã‚’fenceã«åˆ†å‰²ã—ãŸéš›ã®åˆ©ç‚¹ã¨ã—ã¦ifç­‰ã®conditionã¨ä½µç”¨ã§ãã‚‹ç‚¹ãŒã‚ã‚Šã¾ã™ã€‚<br> å…·ä½“çš„ãªä½¿ã„æ–¹ã¯ã“ã®ã‚ã¨ã®å®Ÿè£…ã§ã§ã¦ãã¾ã™ã€‚<h3 id=common-misconceptions><a aria-label="Anchor link for: common-misconceptions" class=zola-anchor href=#common-misconceptions>Common Misconceptions</a></h3><p>memory orderingã«é–¢ã—ã¦ã‚ˆãã¿ã‚‰ã‚Œã‚‹èª¤è§£ã«ã¤ã„ã¦èª¬æ˜ã•ã‚Œã¾ã™ã€‚<br> ä¼¼ãŸã‚ˆã†ãªèª¤è§£ã‚’ã‚‚ã£ã¦ã„ã¦ãŠã‚‚ã—ã‚ã‹ã£ãŸã§ã™ã€‚<br> ä¾‹ãˆã°<blockquote><p>Myth: I need strong memory ordering to make sure changes are â€œimmediatelyâ€ visible.</blockquote><p>Bos, Mara. Rust Atomics and Locks (p. 124). O'Reilly Media. Kindle Edition.<p>ãªã‚“ã‹<code>Relaxed</code>ä½¿ã†ã¨å€¤ã®åæ˜ ãŒé…ããªã‚‹æ„Ÿã‚’è‡ªåˆ†ã‚’ã‚‚ã£ã¦ã„ã¾ã—ãŸãŒã€ãã‚“ãªã“ã¨ã¯ãªã„ãã†ã§ã™ã€‚<br> ãã®ä»–ã«ã‚‚<code>Relaxed</code> operation are freeã§ã‚ã£ãŸã‚Šã€<code>SeqCst</code>ã‚’ä½¿ã£ã¦ãŠã‘ã°ã„ã¤ã§ã‚‚æ­£ã—ã„ã¨ã„ã£ãŸã‚‚ã®ã‚‚ã‚ã‚Šã¾ã™ã€‚<h2 id=chapter-4-building-our-own-spin-lock><a aria-label="Anchor link for: chapter-4-building-our-own-spin-lock" class=zola-anchor href=#chapter-4-building-our-own-spin-lock>Chapter 4 Building Our Own Spin Lock</a></h2><p>ã“ã‚Œã¾ã§ã®çŸ¥è­˜ã‚’ä½¿ã£ã¦ã€SpinLockã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚<br> SpinLockã¨ã¯ã€lockã®å–å¾—ã‚’è©¦ã¿ã€æ—¢ã«lockã•ã‚Œã¦ã„ãŸå ´åˆã¯sleepç­‰ã§å¾…æ©Ÿã—ã¦ãªã‚“ã‚‰ã‹ã®æ©Ÿæ§‹ã§lockã®å†å–å¾—ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’é€šçŸ¥ã—ã¦ã‚‚ã‚‰ã†ã®ã§ã¯ãªãã€loopã§lockã‚’å–å¾—ã§ãã‚‹ã¾ã§tryã—ç¶šã‘ã‚‹Lockã§ã™ã€‚<p>æœ¬æ›¸ã®ç´ æ™´ã‚‰ã—ã„ç‚¹ã¯ã€ã„ããªã‚Šå®Œæˆå“ã‚’æç¤ºã—ã¦æ•°è¡Œè§£èª¬ã¨ã„ã†æµã‚Œã§ã¯ãªãã€step by stepã§å®Ÿè£…ã‚’æ”¹å–„ã—ãªãŒã‚‰è§£èª¬ã‚’ã™ã™ã‚ã¦ãã‚Œã‚‹ç‚¹ã§ã™ã€‚<br> å…·ä½“çš„ã«ã¯<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> SpinLock</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    locked</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> AtomicBool</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> SpinLock</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub const fn</span><span style=color:#88c0d0> new</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -> Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        Self</span><span style=color:#eceff4> {</span><span> locked</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> AtomicBool</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>false</span><span style=color:#eceff4>) }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> lock</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        while self.</span><span>locked</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>swap</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>true</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Acquire</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span>            std</span><span style=color:#81a1c1>::</span><span>hint</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>spin_loop</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> unlock</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>locked</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>store</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>false</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Release</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã“ã®ã‚ˆã†ãªæœ€å°é™ã®å®Ÿè£…ã‹ã‚‰ã€<code>UnsafeCell</code>ã®å°å…¥ -> <code>unlock()</code>ã‚’lockã‚’å–å¾—ã—ãŸthreadã‹ã‚‰ç¢ºå®Ÿã«å‘¼ã°ã‚Œã‚‹apiã«ã™ã‚‹ãŸã‚ã«<code>Guard</code>ã®å°å…¥ã®ã‚ˆã†ã«é€²ã‚“ã§ã„ãã¾ã™ã€‚<br> chapter 3ã§è¦‹ã¦ããŸhappens-beforeã®å…·ä½“ä¾‹ã®ã¿ãªã‚‰ãšrustã®å‹‰å¼·ã«ã‚‚ãªã£ã¦ã¨ã¦ã‚‚å‚è€ƒã«ãªã‚Šã¾ã—ãŸã€‚<h2 id=chapter-5-build-our-own-channels><a aria-label="Anchor link for: chapter-5-build-our-own-channels" class=zola-anchor href=#chapter-5-build-our-own-channels>Chapter 5 Build Our Own Channels</a></h2><p>ç¶šã„ã¦threadé–“ã§dataã‚’é€ã‚‹channelã‚’ä½œã£ã¦ã„ãã¾ã™ã€‚channelã‚‚usecaseã«å¿œã˜ã¦ã„ã‚ã„ã‚ãªå½¢ãŒã‚ã‚‹ã®ã§ã™ãŒã€ã“ã®ç« ã§ã¯<a href=https://docs.rs/tokio/latest/tokio/sync/oneshot/index.html rel=external><code>tokio::sync::oneshot</code></a>ã®ã‚ˆã†ãªä¸€åº¦ã ã‘å€¤ã‚’sendã§ãã‚‹channelã‚’ä½œã£ã¦ã„ãã¾ã™ã€‚<br> <code>UnsafeCell</code>ã«åŠ ãˆã¦unsafeç‰ˆã®<code>Option</code>ã¨ã—ã¦<code>MaybeUninit</code>ãŒã§ã¦ãã¾ã™ã€‚<br> æœ€åˆã¯é–“é•ã£ãŸä½¿ã„æ–¹ã‚’ã•ã‚ŒãŸéš›ã¯panicã—ã¦ã„ãå®Ÿè£…ã‹ã‚‰åˆã‚ã¦ãã“ã‹ã‚‰å‹ã‚’é€šã˜ã¦apiã‚’å®‰å…¨ã—ã¦ã„ãéç¨‹ãŒå‚è€ƒã«ãªã‚Šã¾ã—ãŸã€‚ã¾ãŸatomicã®è©±ã¨ã¯é€¸ã‚Œã¾ã™ãŒã€Arcã‚’ä½¿ã£ã¦allocationã‚’å—ã‘å…¥ã‚Œã‚‹å®Ÿè£…ã‹ã‚‰borrowã—ã¦allocationã‚’é¿ã‘ã‚‹å®Ÿè£…ã¸ã®å¤‰æ›´ã®ä»•æ–¹ã‚‚Rustã®å‹‰å¼·ã«ãªã‚Šã¾ã—ãŸã€‚<h2 id=chapter-6-building-our-own-arc><a aria-label="Anchor link for: chapter-6-building-our-own-arc" class=zola-anchor href=#chapter-6-building-our-own-arc>Chapter 6 Building Our Own "Arc"</a></h2><p>æœ¬ç« ã§ã¯è‡ªå‰ã®<code>std::sync::Arc</code>ã‚’ä½œã£ã¦ã„ãã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>ptr</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>NonNull</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> ArcData</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span>    ref_count</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> AtomicUsize</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    data</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> T</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> Arc</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span>    ptr</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> NonNull</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>ArcData</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>Arc</code>ã«ã¯<a href=https://doc.rust-lang.org/std/sync/struct.Arc.html#method.get_mut rel=external><code>Arc::get_mut()</code></a>ã¨ã„ã†ã€ç¾åœ¨ã®å‚ç…§æ•°ãŒ1ã®ã¨ãã«<code>&mut T</code>ã‚’è¿”ã™å‡¦ç†ãŒã‚ã‚‹ã®ã§ã™ãŒã€ã“ã®å‡¦ç†ã®å®Ÿè£…ã§ã•ãã»ã©ã®fenceãŒã§ã¦ãã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Arc</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> get_mut</span><span style=color:#eceff4>(</span><span>arc</span><span style=color:#81a1c1>: &mut Self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>&mut</span><span style=color:#8fbcbb> T</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if</span><span> arc</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>data</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span>ref_count</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>load</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Relaxed</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> ==</span><span style=color:#b48ead> 1</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0>            fence</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Acquire</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#616e88>            // Safety: Nothing else can access the data, since</span></span>
<span class=giallo-l><span style=color:#616e88>            // there's only one Arc, to which we have exclusive access.</span></span>
<span class=giallo-l><span style=color:#81a1c1>            unsafe</span><span style=color:#eceff4> {</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut</span><span> arc</span><span style=color:#81a1c1>.</span><span>ptr</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_mut</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span>data</span><span style=color:#eceff4>) }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            None</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/m-ou-se/rust-atomics-and-locks/blob/c5f3bbaac5b01acc05870a7e0ab6aef1ab441f3b/src/ch6_arc/s1_basic.rs#L33 rel=external>https://github.com/m-ou-se/rust-atomics-and-locks/blob/c5f3bbaac5b01acc05870a7e0ab6aef1ab441f3b/src/ch6_arc/s1_basic.rs#L33</a><p>ã¾ãŸã€dropã•ã‚ŒãŸ<code>Arc</code>ãŒæœ€å¾Œã®ä¸€ã¤ã ã£ãŸå ´åˆã«ã€ç¢ºä¿ã—ãŸallocationã‚’dropã™ã‚‹å‡¦ç†ã‚’èµ°ã‚‰ã›ãŸã„ã®ã§ã™ãŒãã®éš›ã«ã‚‚fenceã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Drop</span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> Arc</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> drop</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if self.</span><span style=color:#88c0d0>data</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span>ref_count</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>fetch_sub</span><span style=color:#eceff4>(</span><span style=color:#b48ead>1</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Release</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> ==</span><span style=color:#b48ead> 1</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0>            fence</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Acquire</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>            unsafe</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0>                drop</span><span style=color:#eceff4>(</span><span>Box</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_raw</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span>ptr</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_ptr</span><span style=color:#eceff4>()));</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/m-ou-se/rust-atomics-and-locks/blob/c5f3bbaac5b01acc05870a7e0ab6aef1ab441f3b/src/ch6_arc/s1_basic.rs#L64 rel=external>https://github.com/m-ou-se/rust-atomics-and-locks/blob/c5f3bbaac5b01acc05870a7e0ab6aef1ab441f3b/src/ch6_arc/s1_basic.rs#L64</a><p>ã“ã‚Œã¯dropã•ã‚Œã‚‹å‰ã®å¤‰æ›´å‡¦ç†ãŒallocationã®dropæ™‚(ref_countãŒ1->0)ã®ã¨ãã«ã ã‘è¦‹ãˆã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã¨ç†è§£ã—ã¦ã„ã¾ã™ã€‚<br> ã•ã‚‰ã«ã“ã®å¾Œã€å¾ªç’°å‚ç…§ã‚’è¡Œãˆã‚‹ã‚ˆã†ã«<code>Weak</code>ã®å®Ÿè£…ã‚‚è¿½åŠ ã—ã¦ã„ãã€ãã®å¾Œ<code>Weak</code>ã®costã‚’å¿…è¦ãªã¨ãã ã‘æ‰•ã†ã‚ˆã†ã«optimizeã—ã¦ã„ãã¾ã™ã€‚<code>Arc</code>ã®<code>Weak</code>ã¯æœ€åˆã‚ã‹ã‚Šã¥ã‚‰ã‹ã£ãŸã®ã§ã™ãŒã€å®Ÿè£…ã—ã¦ã„ãä¸­ã§å†…éƒ¨æ§‹é€ ã®ç†è§£ãŒé€²ã¿ã¾ã—ãŸã€‚<h2 id=chapter-7-understanding-the-processor><a aria-label="Anchor link for: chapter-7-understanding-the-processor" class=zola-anchor href=#chapter-7-understanding-the-processor>Chapter 7 Understanding the Processor</a></h2><p>æœ¬ç« ã§ã¯atomic operationãŒå®Ÿéš›ã«ã¯ã©ã‚“ãªå‘½ä»¤ã«compileã•ã‚Œã‚‹ã®ã‹ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚<br> å¯¾è±¡ã¨ãªã‚‹CPU architectureã¯x86-64ã¨ARM64ã§ã™ã€‚target tripleã§ã„ã†ã¨<code>x86_64-unknown-linux-musl</code>ã¨<code>aarch64-unknown-linux-musl</code>ã§ã™ã€‚<br> Programã‹ã‚‰compileã•ã‚ŒãŸcodeã®assemblyã‚’å¾—ã‚‹æ–¹æ³•ã¨ã—ã¦ã€<a href=https://github.com/pacak/cargo-show-asm rel=external>cargo-show-asm</a>ã¨<a href=https://godbolt.org/ rel=external>Compiler Explorer</a>ãŒç´¹ä»‹ã•ã‚Œã¦ã„ã¾ã™ã€‚<p>cargo-show-asmã«é–¢ã—ã¦ã¯<code>cargo install cargo-show-asm</code>ã§installã—ãŸã®ã¡<p><code>lib.rs</code>ã«<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>sync</span><span style=color:#81a1c1>::</span><span>atomic</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>AtomicI64</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>sync</span><span style=color:#81a1c1>::</span><span>atomic</span><span style=color:#81a1c1>::</span><span>Ordering</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Relaxed</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>pub fn</span><span style=color:#88c0d0> a</span><span style=color:#eceff4>(</span><span>x</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>AtomicI64</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span>    x</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>fetch_add</span><span style=color:#eceff4>(</span><span style=color:#b48ead>10</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Relaxed</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ä¸Šè¨˜ã®ã‚ˆã†ãªé–¢æ•°ã‚’å®šç¾©ã—ãŸçŠ¶æ…‹ã§<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>â¯</span><span style=color:#a3be8c> cargo asm --lib a</span></span>
<span class=giallo-l><span style=color:#88c0d0>    Finished</span><span style=color:#a3be8c> release</span><span> [optimized] target(</span><span style=color:#88c0d0>s</span><span>) in 0.02s</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>.section</span><span style=color:#a3be8c> __TEXT,__text,regular,pure_instructions</span></span>
<span class=giallo-l><span style=color:#88c0d0>        .build_version</span><span style=color:#a3be8c> macos, 11,</span><span style=color:#b48ead> 0</span></span>
<span class=giallo-l><span style=color:#88c0d0>        .globl</span><span style=color:#a3be8c>  rust_atomics_and_locks_handson::a</span></span>
<span class=giallo-l><span style=color:#88c0d0>        .p2align</span><span style=color:#b48ead>        2</span></span>
<span class=giallo-l><span style=color:#88c0d0>rust_atomics_and_locks_handson::a:</span></span>
<span class=giallo-l><span style=color:#88c0d0>Lfunc_begin0:</span></span>
<span class=giallo-l><span style=color:#88c0d0>        .cfi_startproc</span></span>
<span class=giallo-l><span style=color:#88c0d0>        mov</span><span style=color:#a3be8c> w8,</span><span style=color:#616e88> #10</span></span>
<span class=giallo-l><span style=color:#88c0d0>        ldadd</span><span style=color:#a3be8c> x8, x8,</span><span> [x0]</span></span>
<span class=giallo-l><span style=color:#88c0d0>        ret</span></span></code></pre><p>ã®ã‚ˆã†ã«é–¢æ•°åã‚’å¼•æ•°ã§æ¸¡ã—ã¦å®Ÿè¡Œã™ã‚‹ã¨assemblyã‚’è¡¨ç¤ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚<br> M1 Mac(aarch64)ã§ã¯ã€Relaxedã®fetch_addã¯<code>ldadd</code>å‘½ä»¤ã«ãªã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚<p>Compiler Explorerã§ã¯compilerã¸ã®optionã«<code>--target=aarch64-unknown-linux-musl -O</code>ã‚’æ¸¡ã™ã“ã¨ã§aarch64ã‚’targetã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚ https://godbolt.org/z/64vo1cvTj<p><code>load()</code>,<code>store()</code>, <code>fetch_add()</code>ã‚„<code>compare_exchange()</code>ç­‰ã®å‘½ä»¤ãŒå„ç¨®Orderã‚’æŒ‡å®šã—ãŸå ´åˆã«x86ã¨arm64ã§ãã‚Œãã‚Œã©ã†ã„ã£ãŸå‘½ä»¤ã«ãªã‚‹ã‹ãŒè§£èª¬ã•ã‚Œã¾ã™ã€‚ãã‚Œãã‚Œã®CPU architectureã®å‘½ä»¤ç­‰ã‚’çŸ¥ã£ã¦ã„ã‚‹ã¨ã‚ˆã‚Šæ·±ãç†è§£ã§ãã‚‹ã¨æ€ã„ã¾ã™ã€‚<br> arm64ã®Load-Linked and Store-Conditional Instructionsã«ã¤ã„ã¦ã¯<a href=https://www.oreilly.co.jp/books/9784873119595/ rel=external>ä¸¦è¡Œãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°å…¥é–€</a>ã«è§£èª¬ãŒè¼‰ã£ã¦ã„ã¾ã—ãŸã€‚<h3 id=caching><a aria-label="Anchor link for: caching" class=zola-anchor href=#caching>Caching</a></h3><p>æœ¬æ›¸ã®ç™ºå£²è‡ªä½“ã¯<a href=https://twitter.com/YAmaguchixt/status/1515098396981608449 rel=external>2022å¹´ã®4æœˆãã‚‰ã„ã«ã¯äºˆå‘Š</a>ã•ã‚Œã¦ãŠã‚Šã€ãã“ã§ã®ç›®æ¬¡ã§CPUã®å†…éƒ¨æ§‹é€ ã«ã‚‚è§¦ã‚Œãã†ã¨ã‚ã‹ã£ã¦ã„ãŸã®ã§ã€ã™ã“ã—ã§ã‚‚CPUã«ã¤ã„ã¦è©³ã—ããªã‚ŠãŸã„ã¨æ€ã£ã¦ã„ã¾ã—ãŸã€‚<br> ãã“ã§è‡ªåˆ†ãŒæœ¬æ›¸ã‚’èª­ã‚€å‰ã«äºˆç¿’ã¨ã—ã¦ä»¥ä¸‹ã®CPUé–¢é€£ã®æœ¬ã‚’èª­ã¿ã¾ã—ãŸã€‚<ul><li><a href=https://peaks.cc/cpu_no_kimochi rel=external>ã‚‚ã£ã¨CPUã®æ°—æŒã¡ãŒçŸ¥ã‚ŠãŸã„ã§ã™ã‹?</a> (<a href=https://blog.ymgyt.io/entry/cpu_no_kimochi rel=external>æ„Ÿæƒ³</a>ã‚‚æ›¸ãã¾ã—ãŸ)<li><a href=https://www.amazon.co.jp/dp/4774145211/ rel=external>ãƒ—ãƒ­ã‚»ãƒƒã‚µã‚’æ”¯ãˆã‚‹æŠ€è¡“</a><li><del>ãƒ‘ã‚¿ãƒ˜ãƒ6ç‰ˆã‚‚æŒ‘æˆ¦ã—ã¾ã—ãŸãŒé›£ã—ã‹ã£ãŸã§ã™</del></ul><p>ãã“ã§ã‚ã‹ã£ãŸ(è‡ªåˆ†ã«ã¨ã£ã¦ã®)é©šæ„•ã®äº‹å®Ÿã¨ã—ã¦ã¯ã€CPUã¯ã‚³ã‚¢ã”ã¨ã«cacheã‚’ä¿æŒã—ã¦ãŠã‚Šã€cacheé–“ã®æ•´åˆæ€§ã‚’ä¿ã¤ãŸã‚ã®ãƒ—ãƒ­ãƒˆã‚³ãƒ«ãŒã‚ã‚‹ã€‚ä¾‹ãˆã°ã€ã‚³ã‚¢-1ãŒä»Šã‹ã‚‰å¤‰æ•°aã«å€¤ã‚’æ›¸ãè¾¼ã‚€ã‹ã‚‰ä»–ã®ã‚³ã‚¢é”ã«å¤‰æ•°aã®cacheã‚‚ã£ã¦ã„ãŸã‚‰ç„¡åŠ¹åŒ–ã—ã¦ã­ã¨ã„ã†ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã€ä»–ã®ã‚³ã‚¢ã¯ãã‚Œã‚’ã†ã‘ã¨ã£ã¦è‡ªèº«ãŒä¿æŒã—ã¦ã„ã‚‹å¤‰æ•°aã®cacheã‚’ç„¡åŠ¹ã«ã—ãŸã‚Šã—ã¦ã„ã‚‹ã¨ã„ã†ã‚‚ã®ã§ã™ã€‚<br> ã•ã‚‰ã«(æã‚ã—ã„ã®ã¯),cacheã¸ã®æ›¸ãè¾¼ã¿ã‚’system callã®å›æ•°ã‚’æŠ‘ãˆã‚‹ãŸã‚ã«Bufferã«writeã™ã‚‹ã®ã¨åŒã˜ã‚ˆã†ã«bufferã™ã‚‹æ©Ÿæ§‹(Store Buffer)ãŒã‚ã£ãŸã‚Šã€ç„¡åŠ¹åŒ–ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å°‚ç”¨ã®queue(invalidate queue)ã§å—ã‘ä»˜ã‘ã¦ã„ãŸã‚Šã™ã‚‹ã¨ã„ã†ã‚‚ã®ã§ã—ãŸã€‚ã‚‚ã†CPUãŒä¸€ã¤ã®åˆ†æ•£ã‚·ã‚¹ãƒ†ãƒ ã®ã‚ˆã†ã§ã™ã€‚<p>ã¨ã„ã†ãã‚‰ã„ã®å‰æã§æœ¬ç« ã‚’èª­ã¿ã¾ã—ãŸã€‚æœ¬æ›¸ã§ã‚‚MESI protocolã¨ã„ã†cacheã®æ•´åˆæ€§(coherence)ã‚’ä¿ã¤ãŸã‚ã®protocolã«ã¤ã„ã¦ã®è§£èª¬ãŒã§ã¦ãã¾ã™ã€‚ æœ¬ç« ãŒãŠã‚‚ã—ã‚ã„ã®ã¯ãã‚Œã‚‰ã®æ¦‚å¿µã‚’Rustã®codeã§å®Ÿéš›ã«æ¤œè¨¼ã—ã¦ã„ãã¨ã“ã‚ã§ã™ã€‚<p>ã¾ãšã¯ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>static</span><span style=color:#8fbcbb> A</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> AtomicU64</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> AtomicU64</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span style=color:#b48ead>0</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> start</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Instant</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>now</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>    for</span><span> _</span><span style=color:#81a1c1> in</span><span style=color:#b48ead> 0</span><span style=color:#81a1c1>..</span><span style=color:#b48ead>1_000_000_000</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        A</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>load</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Relaxed</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    println!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>:?</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>",</span><span> start</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>elapsed</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>atomicå¤‰æ•°ã‚’10å„„å›loadã™ã‚‹programã§ã™ã€‚ã“ã®å‡¦ç†ãŒã©ã‚Œãã‚‰ã„ã‹ã‹ã‚‹ã¨æ€ã„ã¾ã™ã‹ï¼Ÿ ç­”ãˆã¯0msã§ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>â¯</span><span style=color:#a3be8c>  cargo run --example ch7_bench --release --quiet</span></span>
<span class=giallo-l><span style=color:#88c0d0>0ns</span></span></code></pre><p>ç†ç”±ã¯compilerãŒã“ã®loopã¯ãªã«ã‚‚ã—ã¦ã„ãªã„ã¨ã—ã¦æœ€é©åŒ–ã—ã¦ã—ã¾ã†ã‹ã‚‰ã¨ã‚ã‚Šã¾ã™ã€‚ãªã®ã§æ„å›³é€šã‚Šã«ã™ã‚‹ã«ã¯<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>hint</span><span style=color:#81a1c1>::</span><span>black_box</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>static</span><span style=color:#8fbcbb> A</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> AtomicU64</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> AtomicU64</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span style=color:#b48ead>0</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#88c0d0>    black_box</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span style=color:#8fbcbb>A</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> start</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Instant</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>now</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>    for</span><span> _</span><span style=color:#81a1c1> in</span><span style=color:#b48ead> 0</span><span style=color:#81a1c1>..</span><span style=color:#b48ead>1_000_000_000</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0>        black_box</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>A</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>load</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Relaxed</span><span style=color:#eceff4>));</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    println!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>:?</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>",</span><span> start</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>elapsed</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>std::hint::black_box()</code>ã‚’åˆ©ç”¨ã—ã¦compilerã®æœ€é©åŒ–ã‚’èª¿æ•´ã—ã¾ã™ã€‚<br> è‡ªåˆ†ã®ç’°å¢ƒã§ã¯æ¦‚ã­320mså‰å¾Œã®å®Ÿè¡Œæ™‚é–“ãŒã‹ã‹ã‚Šã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>â¯</span><span style=color:#a3be8c>  cargo run --example ch7_bench --release --quiet</span></span>
<span class=giallo-l><span style=color:#88c0d0>317.6865ms</span></span></code></pre><p>ã“ã“ã‹ã‚‰ä»–threadã‚’å‹•ã‹ã—ãŸã‚‰ã©ã†ãªã‚‹ã‹ã‚„ã€ã‚ã–ã¨cache line(cacheã®å˜ä½)ã«ä¹—ã‚‰ãªã„ã‚ˆã†ã«ã—ã¦ã¿ãŸã‚‰ã©ã®ç¨‹åº¦æ€§èƒ½ãŒåŠ£åŒ–ã™ã‚‹ã‹ç­‰ã‚’æ¤œè¨¼ã—ã¦ã„ãã¾ã™ã€‚cache lineã®å®Ÿåœ¨ã‚’ä½“æ„Ÿã§ãã¾ã™ã€‚<h2 id=chapter-8-operating-system-primitives><a aria-label="Anchor link for: chapter-8-operating-system-primitives" class=zola-anchor href=#chapter-8-operating-system-primitives>Chapter 8 Operating System Primitives</a></h2><p>åŠ¹ç‡çš„ã«threadã‚’blockã™ã‚‹ã«ã¯ã€OSã®åŠ©ã‘ã‚’å€Ÿã‚Šã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚<br> ãã“ã§æœ¬ç« ã§ã¯Linux, macOS, Windowsã§ã©ã†ã„ã£ãŸä»•çµ„ã¿ãŒæä¾›ã•ã‚Œã¦ã„ã‚‹ã®ã‹ã«ã¤ã„ã¦è§£èª¬ã—ã¦ãã‚Œã¾ã™ã€‚ã¾ãŸã“ã“ã§è§£èª¬ã•ã‚Œã‚‹futexã«ã¤ã„ã¦ã¯<a href=https://github.com/m-ou-se/atomic-wait rel=external>atomic-wait</a> crateã‚’ä½¿ã£ã¦chapter 9ã§å®Ÿéš›ã«åˆ©ç”¨ã—ã¾ã™ã€‚<h2 id=chapter-9-building-our-own-locks><a aria-label="Anchor link for: chapter-9-building-our-own-locks" class=zola-anchor href=#chapter-9-building-our-own-locks>Chapter 9 Building Our Own Locks</a></h2><p>æœ¬ç« ã§ã¯chapter 8ã§ç´¹ä»‹ã•ã‚ŒãŸfutexã®æ©Ÿèƒ½ã‚’æŠ½è±¡åŒ–ã—ã¦æä¾›ã—ã¦ãã‚Œã¦ã„ã‚‹<a href=https://github.com/m-ou-se/atomic-wait rel=external>atomic-wait</a>ã‚’ãƒ™ãƒ¼ã‚¹ã«ã—ã¦<code>Mutex</code>, <code>Condvar</code>, <code>RwLock</code>ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚ã“ã‚Œã¾ã§ã®ã‚ˆã†ã«ã¾ãšã¯ã‚·ãƒ³ãƒ—ãƒ«ãªå½¢ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¦å¾ã€…ã«æ”¹è‰¯ã—ã¦ã„ãã‚¢ãƒ—ãƒ­ãƒ¼ãƒãŒæ¡ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚<br> system callã‚’æ¸›ã‚‰ã™ãŸã‚ã«ã¾ãšã¯spin lockã‚’è©¦ã—ã¦ã‹ã‚‰waitã—ãŸã‚Šã¨ã¨ã¦ã‚‚å‹‰å¼·ã«ãªã‚Šã¾ã™ã€‚<br> <code>Condvar</code>ã‚‚ä½œã£ã¦ã¿ã‚‹ã¨ã©ã†ã—ã¦<code>wait()</code>ãŒ<code>MutexGuard</code>ã‚’ã¤ã‘ã¨ã£ã¦ã€<code>MutexGuard</code>ã‚’è¿”ã™ã‚ˆã†ãªapiã«ãªã‚‹ã®ã‹ç´å¾—ã§ãã¾ã—ãŸã€‚ã¾ãŸã“ã“ã§ã‚‚happens-beforeã®å›³ã‚’ç¤ºã—ã¦ãã‚Œã‚‹ã®ã§ã¨ã¦ã‚‚ã‚ã‹ã‚Šã‚„ã™ã„ã§ã™ã€‚<h2 id=chapter-10-ideas-and-inspiration><a aria-label="Anchor link for: chapter-10-ideas-and-inspiration" class=zola-anchor href=#chapter-10-ideas-and-inspiration>Chapter 10 Ideas and Inspiration</a></h2><p>æœ€çµ‚ç« ã§ã¯ã“ã‚Œã¾ã§ã«æ‰±ãˆãªã‹ã£ãŸã€concurrency related topicsãŒç´¹ä»‹ã•ã‚Œã¾ã™ã€‚ Semaphoreã‚„Lock-Free Linked Listç­‰ã€…ç´¹ä»‹ã•ã‚Œã¾ã™ã€‚<br> Lockã«ã‚‚ã„ã‚ã„ã‚ãªå®Ÿè£…ãŒã‚ã‚‹ã®ã ã¨çŸ¥ã‚Šã¾ã—ãŸã€‚<p>æœ€å¾Œã®å¾Œæ›¸ããŒã¨ã¦ã‚‚ç´ æ•µãªã®ã§æ˜¯éèª­ã‚“ã§ã¿ã¦ãã ã•ã„!<h2 id=zui-hou-ni><a aria-label="Anchor link for: zui-hou-ni" class=zola-anchor href=#zui-hou-ni>æœ€å¾Œã«</a></h2><p>ç°¡å˜ã«ã§ã¯ã‚ã‚Šã¾ã™ãŒã¨ã¦ã‚‚ã‚ˆã„æœ¬ã ã£ãŸã®ã§å‹¢ã„ã§æ„Ÿæƒ³ã‚’æ›¸ã„ã¦ã—ã¾ã„ã¾ã—ãŸã€‚ ãŸã¾ãŸã¾å»å¹´ã®12/31æ—¥ã¯ã€<a href=https://blog.ymgyt.io/entry/books/rust_for_rustaceans rel=external>Rust for Rustaceans</a>ã®æ„Ÿæƒ³ã‚’æ›¸ã„ã¦ã„ã¾ã—ãŸã€‚<br> ã“ã®æœ¬ã‚‚ãŠã™ã™ã‚ã§ã™ğŸ¦€<p>ãã‚Œã§ã¯çš†æ§˜è‰¯ã„ãŠå¹´ã‚’ğŸ<h2 id=can-kao><a aria-label="Anchor link for: can-kao" class=zola-anchor href=#can-kao>å‚è€ƒ</a></h2><ul><li><a href=https://marabos.nl/atomics/ rel=external>æœ¬æ›¸ã®ãƒšãƒ¼ã‚¸</a> <ul><li><a href="https://www.oreilly.com/catalog/errata.csp?isbn=0636920635048" rel=external>Errata</a></ul><li><a href=https://github.com/m-ou-se/rust-atomics-and-locks rel=external>Github code example</a><li><a href=https://qiita.com/qnighy/items/b3b728adf5e4a3f1a841# rel=external>ã‚¢ãƒˆãƒŸãƒƒã‚¯å¤‰æ•°ã¨ãƒ¡ãƒ¢ãƒªé †åº</a><li>ãªãœé•ã†å€¤ã‚’ã¿ãŸã®ã‹ <ul><li><a href=https://tech.unifa-e.com/entry/2019/03/04/130455 rel=external>https://tech.unifa-e.com/entry/2019/03/04/130455</a><li><a href=https://tech.unifa-e.com/entry/2018/07/24/120258 rel=external>https://tech.unifa-e.com/entry/2018/07/24/120258</a><li><a href=http://www.rdrop.com/users/paulmck/scalability/paper/whymb.2010.07.23a.pdf rel=external>http://www.rdrop.com/users/paulmck/scalability/paper/whymb.2010.07.23a.pdf</a></ul></ul></div></article></main><footer class=blog-footer><p>Â© 2026 <a href=https://blog.ymgyt.io> ymgyt </a> | Made with <a href=https://www.getzola.org rel=noopener target=_blank>Zola</a> | <a href=https://github.com/ymgyt/blog>Repository</a> | <a href=https://blog.ymgyt.io/atom.xml target=_blank title=rss> <svg viewbox="0 0 24 24" class=icon fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx=5 cy=19 r=1></circle></svg> </a></footer></div></div>