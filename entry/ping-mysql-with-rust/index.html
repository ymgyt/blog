<!doctype html><html lang=ja><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1" name=viewport><link href=https://blog.ymgyt.io/favicon.ico rel=icon sizes=any><link href=https://blog.ymgyt.io/icon.svg rel=icon type=image/svg+xml><link href=https://blog.ymgyt.io/apple-touch-icon.png rel=apple-touch-icon><link href=https://blog.ymgyt.io/manifest.webmanifest rel=manifest><link href=https://blog.ymgyt.io/style.css rel=stylesheet><link href=https://blog.ymgyt.io/atom.xml rel=alternate title=Atom type=application/atom+xml><script src="https://www.googletagmanager.com/gtag/js?id=G-GTB0KMLN90" async></script><script>window.dataLayer = window.dataLayer || [];
	function gtag() {dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-GTB0KMLN90');</script><title>ğŸ“ Rustã§MySQLã«pingã‚’ã†ã¤ | Happy developing</title><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><body><div class=world><div class=content-container><header class=blog-header-container><div class=blog-logo><a href=https://blog.ymgyt.io>Happy developing</a></div><div class=blog-nav><nav><ul><li><a href=https://blog.ymgyt.io/entry/>Entries</a><li><a href=https://blog.ymgyt.io/tags/>Tags</a><li><a href=https://blog.ymgyt.io/about/>About</a><li><a href=https://github.com/ymgyt> <img alt=Github class=icon src=https://blog.ymgyt.io/images/icon/github.svg> </a><li><a href="https://twitter.com/YAmaguchixt "> <img alt=Twitter class=icon src=https://blog.ymgyt.io/images/icon/twitter.svg> </a></ul></nav></div></header><main class=blog-main><article><header class=entry-header><h1 class=entry-title>ğŸ“ Rustã§MySQLã«pingã‚’ã†ã¤</h1><div class=entry-meta><p class=entry-meta-item>ğŸ—“ 2020-02-02<p class=entry-meta-item>ğŸ· <span class=tag><a href=https://blog.ymgyt.io/tags/rust/>rust</a></span></div></header><aside class=entry-toc><nav><ul class=entry-toc-toplevel-list><li><a href=https://blog.ymgyt.io/entry/ping-mysql-with-rust/#connectionchu-li>Connectionå‡¦ç†</a><li><a href=https://blog.ymgyt.io/entry/ping-mysql-with-rust/#dockerfile>Dockerfile</a><li><a href=https://blog.ymgyt.io/entry/ping-mysql-with-rust/#go>Go</a></ul></nav></aside><div class=entry-content><p>localç’°å¢ƒã§docker-composeç­‰ã‚’åˆ©ç”¨ã—ã¦DBã‚’ç«‹ã¡ä¸Šã’ãŸéš›ã«ã€DBã®"ready"ã‚’å¾…ã¡ãŸã„ã“ã¨ãŒã‚ã‚Šã¾ã—ãŸã€‚<br> æœ€åˆã¯ã€tcpæ¥ç¶šã§ã‚ˆã—ã¨ã—ã¦ã„ãŸã®ã§ã™ãŒã€ã‚„ã¯ã‚Šprotocolçš„ãª"ready"ãŒå¿…è¦ã ã£ãŸã®ã§ã€pingã‚’ã†ã¤å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚ ã¨ã„ã†ã“ã¨ã§ã€Rustã§MySQLã«pingã‚’æ‰“ã¡ç¶šã‘ã‚‹CLIã‚’ä½œã£ã¦ã¿ã¾ã—ãŸã€‚<br> <a href=https://github.com/ymgyt/mysqlpinger rel=external>source code</a><p>flagã¯ä»¥ä¸‹ã®ã‚ˆã†ãªæ„Ÿã˜ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>$</span><span style=color:#a3be8c> mysqlpinger --help</span></span>
<span class=giallo-l><span style=color:#88c0d0>mysqlpinger</span><span style=color:#b48ead> 0.2.1</span></span>
<span class=giallo-l><span style=color:#88c0d0>Ping</span><span style=color:#a3be8c> to mysql server</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>USAGE:</span></span>
<span class=giallo-l><span style=color:#88c0d0>    mysqlpinger</span><span> [FLAGS] </span><span style=color:#eceff4>[</span><span>OPTIONS</span><span style=color:#eceff4>] [</span><span>DBNAME</span><span style=color:#eceff4>]</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>ARGS:</span></span>
<span class=giallo-l><span style=color:#81a1c1>    &lt;</span><span style=color:#88c0d0>DBNAME</span><span>></span><span style=color:#a3be8c>    Database name</span><span> [env:</span><span style=color:#a3be8c> MYSQL_DB_NAME=]</span><span>  [default:</span><span style=color:#a3be8c> sys]</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>FLAGS:</span></span>
<span class=giallo-l><span style=color:#88c0d0>    -s,</span><span style=color:#a3be8c> --silent     Running with no logging</span></span>
<span class=giallo-l><span style=color:#88c0d0>    -v,</span><span style=color:#a3be8c> --verbose    Verbose</span></span>
<span class=giallo-l><span style=color:#88c0d0>        --forever</span><span style=color:#a3be8c>    Retry without limit</span></span>
<span class=giallo-l><span style=color:#88c0d0>        --help</span><span style=color:#a3be8c>       Prints help information</span></span>
<span class=giallo-l><span style=color:#88c0d0>    -V,</span><span style=color:#a3be8c> --version    Prints version information</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>OPTIONS:</span></span>
<span class=giallo-l><span style=color:#88c0d0>    -h,</span><span style=color:#a3be8c> --host</span><span style=color:#81a1c1> &lt;</span><span style=color:#a3be8c>HOS</span><span>T</span><span style=color:#81a1c1>></span><span style=color:#a3be8c>            MySQL server hostname</span><span> [env:</span><span style=color:#a3be8c> MYSQL_HOST=]</span><span>  [default:</span><span style=color:#a3be8c> 127.0.0.1]</span></span>
<span class=giallo-l><span style=color:#88c0d0>    -p,</span><span style=color:#a3be8c> --port</span><span style=color:#81a1c1> &lt;</span><span style=color:#a3be8c>POR</span><span>T</span><span style=color:#81a1c1>></span><span style=color:#a3be8c>            MySQL server port</span><span> [env:</span><span style=color:#a3be8c> MYSQL_PORT=]</span><span>  [default:</span><span style=color:#a3be8c> 3306]</span></span>
<span class=giallo-l><span style=color:#88c0d0>    -u,</span><span style=color:#a3be8c> --user</span><span style=color:#81a1c1> &lt;</span><span style=color:#a3be8c>USE</span><span>R</span><span style=color:#81a1c1>></span><span style=color:#a3be8c>            User for authentication</span><span> [env:</span><span style=color:#a3be8c> MYSQL_USER=]</span><span>  [default:</span><span style=color:#a3be8c> root]</span></span>
<span class=giallo-l><span style=color:#88c0d0>    -P,</span><span style=color:#a3be8c> --pass</span><span style=color:#81a1c1> &lt;</span><span style=color:#a3be8c>PAS</span><span>S</span><span style=color:#81a1c1>></span><span style=color:#a3be8c>            Password for authentication</span><span> [env:</span><span style=color:#a3be8c> MYSQL_PASSWORD=]</span></span>
<span class=giallo-l><span style=color:#88c0d0>    -m,</span><span style=color:#a3be8c> --max-retry</span><span style=color:#81a1c1> &lt;</span><span style=color:#a3be8c>COUN</span><span>T</span><span style=color:#81a1c1>></span><span style=color:#a3be8c>      Max retry count</span><span> [default:</span><span style=color:#a3be8c> 9]</span></span>
<span class=giallo-l><span style=color:#88c0d0>    -i,</span><span style=color:#a3be8c> --interval</span><span style=color:#81a1c1> &lt;</span><span style=color:#a3be8c>DURATIO</span><span>N</span><span style=color:#81a1c1>></span><span style=color:#a3be8c>    Retry ping interval</span><span> [default:</span><span style=color:#a3be8c> 1s]</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>Example:</span></span>
<span class=giallo-l><span style=color:#616e88>    # Basic</span></span>
<span class=giallo-l><span style=color:#88c0d0>    mysqlpinger</span><span style=color:#a3be8c> --pass=root --port=30303</span><span style=color:#81a1c1> &lt;</span><span style=color:#a3be8c>db_nam</span><span>e</span><span style=color:#81a1c1>></span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    # Docker</span></span>
<span class=giallo-l><span style=color:#88c0d0>    docker</span><span style=color:#a3be8c> run --rm -t --network=</span><span style=color:#81a1c1>&lt;</span><span style=color:#a3be8c>network</span><span style=color:#81a1c1>></span><span style=color:#a3be8c> ymgyt/mysqlpinger:latest</span><span style=color:#ebcb8b> \</span></span>
<span class=giallo-l><span style=color:#a3be8c>       --user=user --pass=secret --host=</span><span style=color:#81a1c1>&lt;</span><span style=color:#a3be8c>container_name</span><span style=color:#81a1c1>></span><span> [--forever</span><span style=color:#81a1c1>|</span><span>--max-retry</span><span style=color:#81a1c1>=</span><span style=color:#a3be8c>20</span><span>]</span></span>
<span class=giallo-l></span></code></pre><p>æ¥ç¶šã®ãŸã‚ã®æƒ…å ±ã¨ã©ã‚Œãã‚‰ã„retryã™ã‚‹ã‹ã‚’æŒ‡å®šã—ã¦ã€pingãŒé€šã‚‹ã¾ã§blockã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>$</span><span style=color:#a3be8c> docker run --rm -t --network=network  ymgyt/mysqlpinger:latest --pass=secret --host=db --forever</span></span>
<span class=giallo-l><span style=color:#88c0d0>INFO</span><span style=color:#a3be8c> ping</span><span> -</span><span style=color:#81a1c1>></span><span style=color:#a3be8c> addr:db:3306 user:root db:sys</span></span>
<span class=giallo-l><span style=color:#88c0d0>INFO</span><span style=color:#a3be8c> 1/â™¾  Connection refused</span><span> (os</span><span style=color:#a3be8c> error</span><span style=color:#b48ead> 111</span><span>)</span></span>
<span class=giallo-l><span style=color:#88c0d0>INFO</span><span style=color:#a3be8c> 2/â™¾  Connection refused</span><span> (os</span><span style=color:#a3be8c> error</span><span style=color:#b48ead> 111</span><span>)</span></span>
<span class=giallo-l><span style=color:#88c0d0>//</span><span style=color:#a3be8c> ...</span></span>
<span class=giallo-l><span style=color:#88c0d0>INFO</span><span style=color:#a3be8c> 30/â™¾  Connection refused</span><span> (os</span><span style=color:#a3be8c> error</span><span style=color:#b48ead> 111</span><span>)</span></span>
<span class=giallo-l><span style=color:#88c0d0>INFO</span><span style=color:#a3be8c> 31/â™¾  Connection refused</span><span> (os</span><span style=color:#a3be8c> error</span><span style=color:#b48ead> 111</span><span>)</span></span>
<span class=giallo-l><span style=color:#88c0d0>INFO</span><span style=color:#a3be8c> OK</span><span> (elapsed</span><span style=color:#a3be8c> 31.152sec</span><span>)</span></span></code></pre><h2 id=connectionchu-li><a aria-label="Anchor link for: connectionchu-li" class=zola-anchor href=#connectionchu-li>Connectionå‡¦ç†</a></h2><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=toml><span class=giallo-l><span style=color:#eceff4>[</span><span>dependencies</span><span style=color:#eceff4>]</span></span>
<span class=giallo-l><span>lazy_static</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>1.4.0</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span>mysql</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>17.0.0</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span>parse_duration</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>2.0</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span>colored</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>1.9</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span>log</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>0.4</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span>env_logger</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>0.6</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span>console</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>0.9.2</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span>ctrlc</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>3.1.3</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#eceff4>[</span><span>dependencies.clap</span><span style=color:#eceff4>]</span></span>
<span class=giallo-l><span>git</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>https://github.com/clap-rs/clap</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span>branch</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>master</span><span style=color:#eceff4>"</span></span></code></pre><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> clap</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>ArgMatches</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> log</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span>debug</span><span style=color:#eceff4>,</span><span> info</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> mysql</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>Conn</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Opts</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> OptsBuilder</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> parse_duration</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span>    borrow</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Cow</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    sync</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span>        atomic</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>AtomicBool</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Ordering</span><span style=color:#eceff4>},</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Arc</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    },</span></span>
<span class=giallo-l><span>    thread</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    time</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Duration</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>};</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>type</span><span style=color:#8fbcbb> BoxError</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Box</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>dyn</span><span> std</span><span style=color:#81a1c1>::</span><span>error</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> MySQLPinger</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    opts</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Arc</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Opts</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>    interval</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Duration</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    forever</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> bool</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    max_retry</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> u64</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    canceled</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> AtomicBool</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> MySQLPinger</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> from_arg</span><span style=color:#eceff4>(</span><span>m</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>ArgMatches</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>Self</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> BoxError</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> interval</span><span style=color:#81a1c1> =</span><span> parse_duration</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>parse</span><span style=color:#eceff4>(</span><span>m</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>value_of</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>interval</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#616e88>        // we need OptsBuilder type first, then calling building methods</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> builder</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> OptsBuilder</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span>        builder</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>ip_or_hostname</span><span style=color:#eceff4>(</span><span>m</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>value_of</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>host</span><span style=color:#eceff4>"))</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>tcp_port</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>                m</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>value_of</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>port</span><span style=color:#eceff4>")</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    .</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    .</span><span style=color:#88c0d0>parse</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>u16</span><span style=color:#eceff4>>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    .</span><span style=color:#88c0d0>map_err</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>e</span><span style=color:#81a1c1>|</span><span style=color:#88c0d0;font-weight:700> format!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>invalid port </span><span style=color:#ebcb8b>{}</span><span style=color:#eceff4>",</span><span> e</span><span style=color:#eceff4>))</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>            )</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>user</span><span style=color:#eceff4>(</span><span>m</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>value_of</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>user</span><span style=color:#eceff4>"))</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>pass</span><span style=color:#eceff4>(</span><span>m</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>value_of</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>pass</span><span style=color:#eceff4>"))</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>prefer_socket</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>false</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>db_name</span><span style=color:#eceff4>(</span><span>m</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>value_of</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>dbname</span><span style=color:#eceff4>"))</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>tcp_connect_timeout</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Some</span><span style=color:#eceff4>(</span><span>interval</span><span style=color:#eceff4>));</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        Ok</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            opts</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Arc</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>builder</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>()),</span></span>
<span class=giallo-l><span>            interval</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            forever</span><span style=color:#81a1c1>:</span><span> m</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>is_present</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>forever</span><span style=color:#eceff4>"),</span></span>
<span class=giallo-l><span>            max_retry</span><span style=color:#81a1c1>:</span><span> m</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>value_of</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>max_retry</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>parse</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            canceled</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> AtomicBool</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>false</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>        })</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> stop</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>        debug!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>stop called</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>canceled</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>store</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>true</span><span style=color:#eceff4>,</span><span> Ordering</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Relaxed</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> ping</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;(),</span><span style=color:#8fbcbb> BoxError</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>        info!</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>            "</span><span style=color:#a3be8c>ping -> addr:</span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>host</span><span style=color:#ebcb8b>}</span><span style=color:#a3be8c>:</span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>port</span><span style=color:#ebcb8b>}</span><span style=color:#a3be8c> user:</span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>user</span><span style=color:#ebcb8b>}</span><span style=color:#a3be8c> db:</span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>db</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span>            host</span><span style=color:#81a1c1> = self.</span><span>opts</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>get_ip_or_hostname</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap_or</span><span style=color:#eceff4>(""),</span></span>
<span class=giallo-l><span>            port</span><span style=color:#81a1c1> = self.</span><span>opts</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>get_tcp_port</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>            user</span><span style=color:#81a1c1> = self.</span><span>opts</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>get_user</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap_or</span><span style=color:#eceff4>(""),</span></span>
<span class=giallo-l><span>            db</span><span style=color:#81a1c1> = self.</span><span>opts</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>get_db_name</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap_or</span><span style=color:#eceff4>(""),</span></span>
<span class=giallo-l><span style=color:#eceff4>        );</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>        debug!</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>            "</span><span style=color:#a3be8c>interval:</span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>interval:.1</span><span style=color:#ebcb8b>}</span><span style=color:#a3be8c>sec attempt:</span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>attempt</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span>            interval</span><span style=color:#81a1c1> = self.</span><span>interval</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_secs_f64</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>            attempt</span><span style=color:#81a1c1> = self.</span><span style=color:#88c0d0>max_attempt_symbol</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>        );</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> attempt</span><span style=color:#81a1c1> =</span><span style=color:#b48ead> 1</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> max_attempt</span><span style=color:#81a1c1> = self.</span><span>max_retry </span><span style=color:#81a1c1>+</span><span style=color:#b48ead> 1</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        loop</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            if !self.</span><span>forever </span><span style=color:#81a1c1>&&</span><span> attempt</span><span style=color:#81a1c1> ></span><span> max_attempt</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                return</span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Max retry count exceeded</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#81a1c1>            if self.</span><span>canceled</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>load</span><span style=color:#eceff4>(</span><span>Ordering</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Relaxed</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                return</span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Canceled</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>            use</span><span> mysql</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>DriverError</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>            use</span><span> mysql</span><span style=color:#81a1c1>::</span><span>Error</span><span style=color:#81a1c1>::*</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let</span><span> opts</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Arc</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self.</span><span>opts</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>            match</span><span style=color:#8fbcbb> Conn</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>Opts</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>opts</span><span style=color:#eceff4>)) {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Ok</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>mut</span><span> conn</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    if</span><span> conn</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>ping</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                        return</span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>(());</span></span>
<span class=giallo-l><span style=color:#eceff4>                    }</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Err</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>DriverError</span><span style=color:#eceff4>(</span><span>DriverError</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>CouldNotConnect</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#eceff4>)))</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    if let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> err</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                        let</span><span style=color:#eceff4> (</span><span>_</span><span style=color:#eceff4>,</span><span> description</span><span style=color:#eceff4>,</span><span> _</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> err</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>                        info!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{}</span><span style=color:#a3be8c>/</span><span style=color:#ebcb8b>{} {}</span><span style=color:#eceff4>",</span><span> attempt</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> self.</span><span style=color:#88c0d0>max_attempt_symbol</span><span style=color:#eceff4>(),</span><span> description</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>                    }</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Err</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>DriverError</span><span style=color:#eceff4>(</span><span>DriverError</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>ConnectTimeout</span><span style=color:#eceff4>))</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>                    info!</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>                        "</span><span style=color:#ebcb8b>{}</span><span style=color:#a3be8c>/</span><span style=color:#ebcb8b>{} {}</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span>                        attempt</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>                        self.</span><span style=color:#88c0d0>max_attempt_symbol</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>                        "</span><span style=color:#a3be8c>Connection timeout</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#eceff4>                    );</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Err</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> => return</span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Box</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#eceff4>)),</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>            thread</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>sleep</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span>interval</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span>            attempt</span><span style=color:#81a1c1> =</span><span> attempt</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>wrapping_add</span><span style=color:#eceff4>(</span><span style=color:#b48ead>1</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> max_attempt_symbol</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Cow</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> str</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if self.</span><span>forever </span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#eceff4>            "</span><span style=color:#a3be8c>â™¾ </span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#eceff4>            (</span><span style=color:#81a1c1>self.</span><span>max_retry </span><span style=color:#81a1c1>+</span><span style=color:#b48ead> 1</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_string</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>Connectionã‚’ã¯ã‚‹ãŸã‚ã«ã€<a href=https://github.com/blackbeam/rust-mysql-simple rel=external>mysql crate</a>ã‚’åˆ©ç”¨ã—ã¾ã—ãŸã€‚ <a href=https://github.com/blackbeam/rust-mysql-simple/issues/173 rel=external>issue</a>ã§ã‚‚ã‚ãŒã£ã¦ã„ãŸã®ã§ã™ãŒ<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>OptsBuilder</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>tcp_port</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>user</span><span style=color:#eceff4>()</span></span></code></pre><p>ã®ã‚ˆã†ã«ã€<code>OptsBuilder</code>ã‚’ç”Ÿæˆã—ã¦ãã®ã¾ã¾ã€methodã‚’å‘¼ã¶ã¨ã€<code>Opts</code>ã«å¤‰æ›ã§ããšã«ãƒãƒã£ã¦ã—ã¾ã„ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> builder</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> OptsBuilder</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span>        builder</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>ip_or_hostname</span><span style=color:#eceff4>(</span><span>m</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>value_of</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>host</span><span style=color:#eceff4>"))</span><span>    </span></span>
<span class=giallo-l><span style=color:#616e88>            // ...</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Ok</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            opts</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Arc</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>builder</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>()),</span></span>
<span class=giallo-l><span style=color:#616e88>           // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span></code></pre><h2 id=dockerfile><a aria-label="Anchor link for: dockerfile" class=zola-anchor href=#dockerfile>Dockerfile</a></h2><p>task runnerç³»ã®ãƒ„ãƒ¼ãƒ«ã«æ›¸ã„ã¦ã€é–‹ç™ºè€…ã®localç’°å¢ƒã«ä¾å­˜ã—ãªã„ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã«docker imageã«ã—ã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=docker><span class=giallo-l><span style=color:#81a1c1>FROM</span><span> rust:1.41.0 </span><span style=color:#81a1c1>as</span><span> builder</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>WORKDIR</span><span> /usr/src/project</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>COPY</span><span> . .</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>RUN</span><span> cargo install --path .</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>ENTRYPOINT</span><span> [</span><span style=color:#a3be8c>"mysqlpinger"</span><span>]</span></span></code></pre><p>ã“ã®æ›¸ãæ–¹ã ã¨ã€image sizeãŒã‹ãªã‚Šå¤§ãããªã£ã¦ã—ã¾ã†(1.65GB)ã®ã§ã€multi stageã§ã€buildã¨runtimeã‚’ã‚ã‘ã‚‰ã‚Œã‚‹ã«ã—ãŸã„ã§ã™ã€‚<h2 id=go><a aria-label="Anchor link for: go" class=zola-anchor href=#go>Go</a></h2><p>æœ€åˆã¯Goã§æ›¸ã„ã¦ã„ã¾ã—ãŸã€‚<code>context.Context</code>ã®ãŠã‹ã’ã§ã€timeoutç³»ã®å‡¦ç†ãŒéå¸¸ã«æ›¸ãã‚„ã™ã„ã¨æ€ã„ã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=go><span class=giallo-l><span style=color:#81a1c1>package</span><span> main</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>import</span><span style=color:#eceff4> (</span></span>
<span class=giallo-l><span style=color:#eceff4>	"</span><span style=color:#a3be8c>context</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#eceff4>	"</span><span style=color:#a3be8c>database/sql</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#eceff4>	"</span><span style=color:#a3be8c>flag</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#eceff4>	"</span><span style=color:#a3be8c>fmt</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#eceff4>	"</span><span style=color:#a3be8c>os</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#eceff4>	"</span><span style=color:#a3be8c>strings</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#eceff4>	"</span><span style=color:#a3be8c>time</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#eceff4>	"</span><span style=color:#a3be8c>github.com/go-sql-driver/mysql</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#eceff4>)</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>func</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span>	host</span><span style=color:#81a1c1> :=</span><span> flag</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>String</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>host</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>localhost</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>host</span><span style=color:#eceff4>")</span></span>
<span class=giallo-l><span>	port</span><span style=color:#81a1c1> :=</span><span> flag</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>String</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>port</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>3306</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>port</span><span style=color:#eceff4>")</span></span>
<span class=giallo-l><span>	user</span><span style=color:#81a1c1> :=</span><span> flag</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>String</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>user</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>root</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>user</span><span style=color:#eceff4>")</span></span>
<span class=giallo-l><span>	pass</span><span style=color:#81a1c1> :=</span><span> flag</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>String</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>pass</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>root</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>pass</span><span style=color:#eceff4>")</span></span>
<span class=giallo-l><span>	name</span><span style=color:#81a1c1> :=</span><span> flag</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>String</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>name</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>knight_db</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>database name</span><span style=color:#eceff4>")</span></span>
<span class=giallo-l><span>	rawTimeout</span><span style=color:#81a1c1> :=</span><span> flag</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>String</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>timeout</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>60s</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>connection wait timeout</span><span style=color:#eceff4>")</span></span>
<span class=giallo-l><span>	checkSlave</span><span style=color:#81a1c1> :=</span><span> flag</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>Bool</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>check-slave</span><span style=color:#eceff4>",</span><span style=color:#81a1c1> false</span><span style=color:#eceff4>, "</span><span style=color:#a3be8c>check slave status</span><span style=color:#eceff4>")</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>	flag</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>Parse</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span>	start</span><span style=color:#81a1c1> :=</span><span> time</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>Now</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>	cfg</span><span style=color:#81a1c1> :=</span><span> mysql</span><span style=color:#eceff4>.</span><span>Config</span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span>		User</span><span style=color:#eceff4>:</span><span style=color:#81a1c1>                 *</span><span>user</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>		Passwd</span><span style=color:#eceff4>:</span><span style=color:#81a1c1>               *</span><span>pass</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>		Net</span><span style=color:#eceff4>:                  "</span><span style=color:#a3be8c>tcp</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span>		Addr</span><span style=color:#eceff4>:</span><span style=color:#81a1c1>                 *</span><span>host</span><span style=color:#81a1c1> +</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>:</span><span style=color:#eceff4>"</span><span style=color:#81a1c1> +</span><span> strings</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>TrimLeft</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>*</span><span>port</span><span style=color:#eceff4>, "</span><span style=color:#a3be8c>:</span><span style=color:#eceff4>"),</span></span>
<span class=giallo-l><span>		DBName</span><span style=color:#eceff4>:</span><span style=color:#81a1c1>               *</span><span>name</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>		AllowNativePasswords</span><span style=color:#eceff4>:</span><span style=color:#81a1c1> true</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>	}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>	db</span><span style=color:#eceff4>,</span><span> err</span><span style=color:#81a1c1> :=</span><span> sql</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>Open</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>mysql</span><span style=color:#eceff4>",</span><span> cfg</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>FormatDSN</span><span style=color:#eceff4>())</span></span>
<span class=giallo-l><span style=color:#88c0d0>	exitIfErr</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#eceff4>,</span><span style=color:#b48ead> 1</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>	timeout</span><span style=color:#eceff4>,</span><span> err</span><span style=color:#81a1c1> :=</span><span> time</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>ParseDuration</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>*</span><span>rawTimeout</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#88c0d0>	exitIfErr</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#eceff4>,</span><span style=color:#b48ead> 1</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span>	ctx</span><span style=color:#eceff4>,</span><span> cancel</span><span style=color:#81a1c1> :=</span><span> context</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>WithTimeout</span><span style=color:#eceff4>(</span><span>context</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>Background</span><span style=color:#eceff4>(),</span><span> timeout</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>	defer</span><span style=color:#88c0d0> cancel</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>	// connectionãŒã¯ã‚Œãªã„å ´åˆã€ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒå‡ºç¶šã‘ã¦ã—ã¾ã†ã®ã§é™ã‹ã«ã—ã¦ã‚‚ã‚‰ã†</span></span>
<span class=giallo-l><span style=color:#616e88>	// [mysql] 2020/01/31 12:55:47 packets.go:36: unexpected EOF</span></span>
<span class=giallo-l><span>	mysql</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>SetLogger</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>NopLogger</span><span style=color:#eceff4>{})</span></span>
<span class=giallo-l><span>	fmt</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>Printf</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>connecting to mysql(dsn: </span><span style=color:#ebcb8b>%s</span><span style=color:#a3be8c>)</span><span style=color:#ebcb8b>\n</span><span style=color:#eceff4>",</span><span> cfg</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>FormatDSN</span><span style=color:#eceff4>())</span></span>
<span class=giallo-l><span>	err</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> waitReady</span><span style=color:#eceff4>(</span><span>ctx</span><span style=color:#eceff4>,</span><span> db</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>	if</span><span> err</span><span style=color:#81a1c1> == nil</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>		fmt</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>Printf</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>successfully connected to mysql(elapsed: </span><span style=color:#ebcb8b>%s</span><span style=color:#a3be8c>)</span><span style=color:#ebcb8b>\n</span><span style=color:#eceff4>",</span><span> time</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>Since</span><span style=color:#eceff4>(</span><span>start</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#eceff4>	}</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>		fmt</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>Fprintf</span><span style=color:#eceff4>(</span><span>os</span><span style=color:#eceff4>.</span><span>Stderr</span><span style=color:#eceff4>, "</span><span style=color:#ebcb8b>\n%s\n</span><span style=color:#eceff4>",</span><span> err</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>Error</span><span style=color:#eceff4>())</span></span>
<span class=giallo-l><span>		os</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>Exit</span><span style=color:#eceff4>(</span><span style=color:#b48ead>2</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>	}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>	if *</span><span>checkSlave</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>		err</span><span style=color:#81a1c1> :=</span><span style=color:#88c0d0> checkSlaveStatus</span><span style=color:#eceff4>(</span><span>db</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#88c0d0>		exitIfErr</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#eceff4>,</span><span style=color:#b48ead> 3</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>	}</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>func</span><span style=color:#88c0d0> waitReady</span><span style=color:#eceff4>(</span><span>ctx context</span><span style=color:#eceff4>.</span><span>Context</span><span style=color:#eceff4>,</span><span> db</span><span style=color:#81a1c1> *</span><span>sql</span><span style=color:#eceff4>.</span><span>DB</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> error</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>	for</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>		select</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>		case &lt;-</span><span>ctx</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>Done</span><span style=color:#eceff4>():</span></span>
<span class=giallo-l><span style=color:#81a1c1>			return</span><span> ctx</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>Err</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>		default</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#eceff4>		}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>		err</span><span style=color:#81a1c1> :=</span><span> db</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>Ping</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>		if</span><span> err</span><span style=color:#81a1c1> == nil</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>			return nil</span></span>
<span class=giallo-l><span style=color:#eceff4>		}</span></span>
<span class=giallo-l><span>		fmt</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>Printf</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>.</span><span style=color:#eceff4>")</span></span>
<span class=giallo-l><span>		time</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>Sleep</span><span style=color:#eceff4>(</span><span>time</span><span style=color:#eceff4>.</span><span>Second</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>	}</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>func</span><span style=color:#88c0d0> checkSlaveStatus</span><span style=color:#eceff4>(</span><span>db</span><span style=color:#81a1c1> *</span><span>sql</span><span style=color:#eceff4>.</span><span>DB</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> error</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>	fmt</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>Println</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>checking slave status...</span><span style=color:#eceff4>")</span></span>
<span class=giallo-l><span>	rows</span><span style=color:#eceff4>,</span><span> err</span><span style=color:#81a1c1> :=</span><span> db</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>Query</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>SHOW SLAVE STATUS</span><span style=color:#eceff4>")</span></span>
<span class=giallo-l><span style=color:#81a1c1>	if</span><span> err</span><span style=color:#81a1c1> != nil</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>		return</span><span> err</span></span>
<span class=giallo-l><span style=color:#eceff4>	}</span></span>
<span class=giallo-l><span>	columns</span><span style=color:#eceff4>,</span><span> err</span><span style=color:#81a1c1> :=</span><span> rows</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>Columns</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>	if</span><span> err</span><span style=color:#81a1c1> != nil</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>		return</span><span> err</span></span>
<span class=giallo-l><span style=color:#eceff4>	}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>	values</span><span style=color:#81a1c1> :=</span><span style=color:#88c0d0> make</span><span style=color:#eceff4>([]</span><span style=color:#81a1c1>interface</span><span style=color:#eceff4>{},</span><span style=color:#88c0d0> len</span><span style=color:#eceff4>(</span><span>columns</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#81a1c1>	for</span><span> rows</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>Next</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>		for</span><span> i</span><span style=color:#81a1c1> :=</span><span style=color:#b48ead> 0</span><span style=color:#81a1c1>;</span><span> i</span><span style=color:#81a1c1> &lt;</span><span style=color:#88c0d0> len</span><span style=color:#eceff4>(</span><span>columns</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>;</span><span> i</span><span style=color:#81a1c1>++</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>			var</span><span> s sql</span><span style=color:#eceff4>.</span><span>NullString</span></span>
<span class=giallo-l><span>			values</span><span style=color:#eceff4>[</span><span>i</span><span style=color:#eceff4>]</span><span style=color:#81a1c1> = &</span><span>s</span></span>
<span class=giallo-l><span style=color:#eceff4>		}</span></span>
<span class=giallo-l><span>		err</span><span style=color:#81a1c1> :=</span><span> rows</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>Scan</span><span style=color:#eceff4>(</span><span>values</span><span style=color:#81a1c1>...</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>		if</span><span> err</span><span style=color:#81a1c1> != nil</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>			return</span><span> err</span></span>
<span class=giallo-l><span style=color:#eceff4>		}</span></span>
<span class=giallo-l><span style=color:#eceff4>	}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>	ioRunning</span><span style=color:#eceff4>,</span><span> sqlRunning</span><span style=color:#81a1c1> := false</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> false</span></span>
<span class=giallo-l><span style=color:#81a1c1>	for</span><span> i</span><span style=color:#eceff4>,</span><span> column</span><span style=color:#81a1c1> := range</span><span> columns</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>		if</span><span> column</span><span style=color:#81a1c1> ==</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>Slave_IO_Running</span><span style=color:#eceff4>" {</span></span>
<span class=giallo-l><span>			ioRunning</span><span style=color:#81a1c1> =</span><span> values</span><span style=color:#eceff4>[</span><span>i</span><span style=color:#eceff4>].(</span><span style=color:#81a1c1>*</span><span>sql</span><span style=color:#eceff4>.</span><span>NullString</span><span style=color:#eceff4>).</span><span>String</span><span style=color:#81a1c1> ==</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>Yes</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#eceff4>		}</span></span>
<span class=giallo-l><span style=color:#81a1c1>		if</span><span> column</span><span style=color:#81a1c1> ==</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>Slave_SQL_Running</span><span style=color:#eceff4>" {</span></span>
<span class=giallo-l><span>			sqlRunning</span><span style=color:#81a1c1> =</span><span> values</span><span style=color:#eceff4>[</span><span>i</span><span style=color:#eceff4>].(</span><span style=color:#81a1c1>*</span><span>sql</span><span style=color:#eceff4>.</span><span>NullString</span><span style=color:#eceff4>).</span><span>String</span><span style=color:#81a1c1> ==</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>Yes</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#eceff4>		}</span></span>
<span class=giallo-l><span style=color:#eceff4>	}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>	fmt</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>Printf</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Slave_IO_Running: </span><span style=color:#ebcb8b>%v</span><span style=color:#a3be8c> SLave_SQL_Running: </span><span style=color:#ebcb8b>%v\n</span><span style=color:#eceff4>",</span><span> ioRunning</span><span style=color:#eceff4>,</span><span> sqlRunning</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>	if !</span><span>ioRunning</span><span style=color:#81a1c1> || !</span><span>sqlRunning</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>		return</span><span> fmt</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>Errorf</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>slave thread does not work :(</span><span style=color:#eceff4>")</span></span>
<span class=giallo-l><span style=color:#eceff4>	}</span></span>
<span class=giallo-l><span style=color:#81a1c1>	return nil</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>func</span><span style=color:#88c0d0> exitIfErr</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#81a1c1> error</span><span style=color:#eceff4>,</span><span> code</span><span style=color:#81a1c1> int</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>	if</span><span> err</span><span style=color:#81a1c1> != nil</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>		fmt</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>Fprintln</span><span style=color:#eceff4>(</span><span>os</span><span style=color:#eceff4>.</span><span>Stderr</span><span style=color:#eceff4>,</span><span> err</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>Error</span><span style=color:#eceff4>())</span></span>
<span class=giallo-l><span>		os</span><span style=color:#eceff4>.</span><span style=color:#88c0d0>Exit</span><span style=color:#eceff4>(</span><span>code</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>	}</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>type</span><span> NopLogger</span><span style=color:#81a1c1> struct</span><span style=color:#eceff4>{}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>func</span><span style=color:#eceff4> (</span><span>l </span><span style=color:#81a1c1>*</span><span>NopLogger</span><span style=color:#eceff4>)</span><span style=color:#88c0d0> Print</span><span style=color:#eceff4>(</span><span>_</span><span style=color:#81a1c1> ...interface</span><span style=color:#eceff4>{}) {}</span></span></code></pre></div></article></main><footer class=blog-footer><p>Â© 2026 <a href=https://blog.ymgyt.io> ymgyt </a> | Made with <a href=https://www.getzola.org rel=noopener target=_blank>Zola</a> | <a href=https://github.com/ymgyt/blog>Repository</a> | <a href=https://blog.ymgyt.io/atom.xml target=_blank title=rss> <svg viewbox="0 0 24 24" class=icon fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx=5 cy=19 r=1></circle></svg> </a></footer></div></div>