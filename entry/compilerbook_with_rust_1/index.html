<!doctype html><html lang=ja><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1" name=viewport><link href=https://blog.ymgyt.io/favicon.ico rel=icon sizes=any><link href=https://blog.ymgyt.io/icon.svg rel=icon type=image/svg+xml><link href=https://blog.ymgyt.io/apple-touch-icon.png rel=apple-touch-icon><link href=https://blog.ymgyt.io/manifest.webmanifest rel=manifest><link href=https://blog.ymgyt.io/style.css rel=stylesheet><link href=https://blog.ymgyt.io/atom.xml rel=alternate title=Atom type=application/atom+xml><script src="https://www.googletagmanager.com/gtag/js?id=G-GTB0KMLN90" async></script><script>window.dataLayer = window.dataLayer || [];
	function gtag() {dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-GTB0KMLN90');</script><title>ğŸ“• Rustã§Rui Ueyamaå…ˆç”Ÿã®ä½ãƒ¬ã‚¤ãƒ¤ã‚’çŸ¥ã‚ŠãŸã„äººã®ãŸã‚ã®Cã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ä½œæˆå…¥é–€ã‚’ã‚„ã£ã¦ã¿ã‚‹1(ç’°å¢ƒæ§‹ç¯‰ã‹ã‚‰å››å‰‡æ¼”ç®—ã¾ã§) | Happy developing</title><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><body><div class=world><div class=content-container><header class=blog-header-container><div class=blog-logo><a href=https://blog.ymgyt.io>Happy developing</a></div><div class=blog-nav><nav><ul><li><a href=https://blog.ymgyt.io/entry/>Entries</a><li><a href=https://blog.ymgyt.io/tags/>Tags</a><li><a href=https://blog.ymgyt.io/about/>About</a><li><a href=https://github.com/ymgyt> <img alt=Github class=icon src=https://blog.ymgyt.io/images/icon/github.svg> </a><li><a href="https://twitter.com/YAmaguchixt "> <img alt=Twitter class=icon src=https://blog.ymgyt.io/images/icon/twitter.svg> </a></ul></nav></div></header><main class=blog-main><article><header class=entry-header><h1 class=entry-title>ğŸ“• Rustã§Rui Ueyamaå…ˆç”Ÿã®ä½ãƒ¬ã‚¤ãƒ¤ã‚’çŸ¥ã‚ŠãŸã„äººã®ãŸã‚ã®Cã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ä½œæˆå…¥é–€ã‚’ã‚„ã£ã¦ã¿ã‚‹1(ç’°å¢ƒæ§‹ç¯‰ã‹ã‚‰å››å‰‡æ¼”ç®—ã¾ã§)</h1><div class=entry-meta><p class=entry-meta-item>ğŸ—“ 2020-01-02<p class=entry-meta-item>ğŸ· <span class=tag><a href=https://blog.ymgyt.io/tags/book/>book</a></span> <span class=tag><a href=https://blog.ymgyt.io/tags/rust/>rust</a></span></div></header><aside class=entry-toc><nav><ul class=entry-toc-toplevel-list><li><a href=https://blog.ymgyt.io/entry/compilerbook_with_rust_1/#gai-yao>æ¦‚è¦</a><li><a href=https://blog.ymgyt.io/entry/compilerbook_with_rust_1/#huan-jing-gou-zhu>ç’°å¢ƒæ§‹ç¯‰</a><li><a href=https://blog.ymgyt.io/entry/compilerbook_with_rust_1/#tokenize>tokenize</a><li><a href=https://blog.ymgyt.io/entry/compilerbook_with_rust_1/#asthenobian-huan>ASTã¸ã®å¤‰æ›</a><li><a href=https://blog.ymgyt.io/entry/compilerbook_with_rust_1/#asenburinosheng-cheng>ã‚¢ã‚»ãƒ³ãƒ–ãƒªã®ç”Ÿæˆ</a><li><a href=https://blog.ymgyt.io/entry/compilerbook_with_rust_1/#test>test</a><li><a href=https://blog.ymgyt.io/entry/compilerbook_with_rust_1/#matome>ã¾ã¨ã‚</a><li><a href=https://blog.ymgyt.io/entry/compilerbook_with_rust_1/#can-kao>å‚è€ƒ</a></ul></nav></aside><div class=entry-content><p>compilerbookã“ã¨<a href=https://www.sigbus.info/compilerbook rel=external>ä½ãƒ¬ã‚¤ãƒ¤ã‚’çŸ¥ã‚ŠãŸã„äººã®ãŸã‚ã®Cã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ä½œæˆå…¥é–€</a>ã‚’Rustã§ã‚„ã£ã¦ã„ãã¾ã™ã€‚ æœ¬è¨˜äº‹ã§ã¯ã€ç’°å¢ƒæ§‹ç¯‰ã‹ã‚‰å››å‰‡æ¼”ç®—ã®testã‚’é€šã™ã¨ã“ã‚ã¾ã§ãŠã“ãªã„ã¾ã™ã€‚compilerbookã®ã‚¹ãƒ†ãƒƒãƒ—5: å››å‰‡æ¼”ç®—ã®ã§ãã‚‹è¨€èªã®ä½œæˆã¾ã§ã§ã™ã€‚<h2 id=gai-yao><a aria-label="Anchor link for: gai-yao" class=zola-anchor href=#gai-yao>æ¦‚è¦</a></h2><p>æ¦‚è¦ã¨ã—ã¦ã¯ã€è¨ˆç®—ã®å¯¾è±¡ã¨ãªã‚‹æ–‡å­—åˆ—(<code>2*(3+4)</code>)ã‚’å¼•æ•°ã«ã¨ã‚‹CLIã‚’Rustã§ä½œæˆã—ã€ã‚¢ã‚»ãƒ³ãƒ–ãƒªã‚’å‡ºåŠ›ã—ã¾ã™ã€‚ãã®ã‚¢ã‚»ãƒ³ãƒ–ãƒªã‚’compilerbookãŒæä¾›ã—ã¦ãã ã•ã£ã¦ã„ã‚‹dockerä¸Šã®gccã§compileã—ã¦æ©Ÿæ¢°èªã‚’ç”Ÿæˆã™ã‚‹æµã‚Œã¨ãªã‚Šã¾ã™ã€‚ ç”Ÿæˆã•ã‚ŒãŸãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯è¨ˆç®—çµæœã‚’çµ‚äº†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¨ã—ã¦è¿”ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88># å…¥åŠ›ã‹ã‚‰ã‚¢ã‚»ãƒ³ãƒ–ãƒªã‚’ç”Ÿæˆã™ã‚‹CLI</span></span>
<span class=giallo-l><span style=color:#88c0d0>cargo</span><span style=color:#a3be8c> run --</span><span style=color:#eceff4> '</span><span style=color:#a3be8c>2*(3+4)</span><span style=color:#eceff4>'</span></span>
<span class=giallo-l><span style=color:#88c0d0>    Finished</span><span style=color:#a3be8c> dev</span><span> [unoptimized</span><span style=color:#a3be8c> + debuginfo] target</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>s</span><span style=color:#eceff4>)</span><span style=color:#a3be8c> in 0.01s</span></span>
<span class=giallo-l><span style=color:#88c0d0>     Running</span><span style=color:#eceff4> `</span><span style=color:#88c0d0>target/debug/r9cc</span><span style=color:#eceff4> '</span><span style=color:#a3be8c>2*(3+4)</span><span style=color:#eceff4>'`</span></span>
<span class=giallo-l><span style=color:#88c0d0>.intel_syntax</span><span style=color:#a3be8c> noprefix</span></span>
<span class=giallo-l><span style=color:#88c0d0>.global</span><span style=color:#a3be8c> main</span></span>
<span class=giallo-l><span style=color:#88c0d0>main:</span></span>
<span class=giallo-l><span style=color:#88c0d0>  push</span><span style=color:#b48ead> 2</span></span>
<span class=giallo-l><span style=color:#88c0d0>  push</span><span style=color:#b48ead> 3</span></span>
<span class=giallo-l><span style=color:#88c0d0>  push</span><span style=color:#b48ead> 4</span></span>
<span class=giallo-l><span style=color:#88c0d0>  pop</span><span style=color:#a3be8c> rdi</span></span>
<span class=giallo-l><span style=color:#88c0d0>  pop</span><span style=color:#a3be8c> rax</span></span>
<span class=giallo-l><span style=color:#88c0d0>  add</span><span style=color:#a3be8c> rax, rdi</span></span>
<span class=giallo-l><span style=color:#88c0d0>  push</span><span style=color:#a3be8c> rax</span></span>
<span class=giallo-l><span style=color:#88c0d0>  pop</span><span style=color:#a3be8c> rdi</span></span>
<span class=giallo-l><span style=color:#88c0d0>  pop</span><span style=color:#a3be8c> rax</span></span>
<span class=giallo-l><span style=color:#88c0d0>  imul</span><span style=color:#a3be8c> rax, rdi</span></span>
<span class=giallo-l><span style=color:#88c0d0>  push</span><span style=color:#a3be8c> rax</span></span>
<span class=giallo-l><span style=color:#88c0d0>  pop</span><span style=color:#a3be8c> rax</span></span>
<span class=giallo-l><span style=color:#88c0d0>  ret</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88># dockerä¸Šã§åˆ©ç”¨ã™ã‚‹ãŸã‚ã«cross compile</span></span>
<span class=giallo-l><span style=color:#88c0d0>cross</span><span style=color:#a3be8c> build --target x86_64-unknown-linux-musl</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88># buildæ¸ˆã®dockerä¸Šã§testã‚’å®Ÿè¡Œ</span></span>
<span class=giallo-l><span style=color:#88c0d0>docker</span><span style=color:#a3be8c> run -it -v</span><span style=color:#eceff4> $(</span><span style=color:#88c0d0>pwd</span><span style=color:#eceff4>)</span><span style=color:#a3be8c>:/ws -w /ws compilerbook ./test.sh</span></span></code></pre><p>compilerbookã«ãã£ã¦ã€(æ–‡å­—åˆ—->Tokenåˆ—)ã€(Tokenåˆ— -> AST)ã€(AST -> ã‚¢ã‚»ãƒ³ãƒ–ãƒª)ã®ï¼“ã¤ã®å¤‰æ›å‡¦ç†ã‚’è¡Œã„ã¾ã™ã€‚ <code>main.rs</code><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> r9cc</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#81a1c1>gen</span><span style=color:#eceff4>,</span><span> parse</span><span style=color:#eceff4>,</span><span> tokenize</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Error</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span>env</span><span style=color:#eceff4>,</span><span> io</span><span style=color:#eceff4>,</span><span> process</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> result</span><span style=color:#81a1c1> =</span><span> env</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>args</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>skip</span><span style=color:#eceff4>(</span><span style=color:#b48ead>1</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>next</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>ok_or</span><span style=color:#eceff4>(</span><span>Error</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>InputRequired</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>and_then</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>input</span><span style=color:#81a1c1>|</span><span style=color:#88c0d0> tokenize</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>input</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>and_then</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>tokens</span><span style=color:#81a1c1>|</span><span style=color:#88c0d0> parse</span><span style=color:#eceff4>(</span><span>tokens</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>and_then</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>ast</span><span style=color:#81a1c1>| gen</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut</span><span> io</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>stdout</span><span style=color:#eceff4>(),</span><span style=color:#81a1c1> &</span><span>ast</span><span style=color:#eceff4>));</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    if let</span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span>e</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> result</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        match</span><span> e</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Error</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Lexer</span><span style=color:#eceff4>(</span><span>e</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>                eprintln!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{}\n{}</span><span style=color:#eceff4>",</span><span> env</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>args</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>skip</span><span style=color:#eceff4>(</span><span style=color:#b48ead>1</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>next</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>(),</span><span> e</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span>            _</span><span style=color:#81a1c1> =></span><span style=color:#88c0d0;font-weight:700> eprintln!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{}</span><span style=color:#eceff4>",</span><span> e</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>        process</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>exit</span><span style=color:#eceff4>(</span><span style=color:#b48ead>1</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><h2 id=huan-jing-gou-zhu><a aria-label="Anchor link for: huan-jing-gou-zhu" class=zola-anchor href=#huan-jing-gou-zhu>ç’°å¢ƒæ§‹ç¯‰</a></h2><p>ç’°å¢ƒæ§‹ç¯‰ã¨ã„ã£ã¦ã‚‚ã€å¿…è¦ãªãƒ„ãƒ¼ãƒ«ãŒæƒã£ã¦ã„ã‚‹<a href=https://www.sigbus.info/compilerbook/Dockerfile rel=external>Dockerfile</a>ã‚’æº–å‚™ã—ã¦ã„ãŸã ã„ã¦ã„ã‚‹ã®ã§ã€Rustå´ã ã‘ã§ã™ã€‚ compilerbookã§ã¯<code>9cc</code>ã¨ã„ã†åå‰ã§å®Ÿè£…ã—ã¦ã„ãã®ã§ã€<code>r9cc</code>ã¨ã—ã¾ã—ãŸã€‚<a href=https://github.com/ymgyt/r9cc rel=external>repositoryã¯ã“ã¡ã‚‰ã§ã™</a><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#616e88># clone</span></span>
<span class=giallo-l><span style=color:#88c0d0>git</span><span style=color:#a3be8c> clone https://github.com/ymgyt/r9cc</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88># å¿…è¦ãªãƒ„ãƒ¼ãƒ«ã‚’install</span></span>
<span class=giallo-l><span style=color:#88c0d0>cargo</span><span style=color:#a3be8c> install cargo-make</span></span>
<span class=giallo-l><span style=color:#88c0d0>cargo</span><span style=color:#a3be8c> install cross</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88># version</span></span>
<span class=giallo-l><span style=color:#88c0d0>rustc</span><span style=color:#a3be8c> -V</span></span>
<span class=giallo-l><span style=color:#88c0d0>rustc</span><span style=color:#b48ead> 1.40.0</span><span> (73528e339</span><span style=color:#a3be8c> 2019-12-16</span><span>)</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>cross</span><span style=color:#a3be8c> -V</span><span> </span></span>
<span class=giallo-l><span style=color:#88c0d0>cross</span><span style=color:#b48ead> 0.1.16</span></span>
<span class=giallo-l><span style=color:#88c0d0>cargo</span><span style=color:#b48ead> 1.40.0</span><span> (bc8e4c8be</span><span style=color:#a3be8c> 2019-11-22</span><span>)</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88># docker imageã‚’build</span></span>
<span class=giallo-l><span style=color:#88c0d0>cargo</span><span style=color:#a3be8c> make image</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88># docker containerã¨interactiveã«ã‚„ã‚Šã¨ã‚Šã—ãŸã„å ´åˆ</span></span>
<span class=giallo-l><span style=color:#616e88># cargo make login</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88># r9ccã‚’build</span></span>
<span class=giallo-l><span style=color:#88c0d0>cargo</span><span style=color:#a3be8c> make build</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88># testã‚’å®Ÿè¡Œ</span></span>
<span class=giallo-l><span style=color:#88c0d0>cargo</span><span style=color:#a3be8c> make my_test</span></span></code></pre><h2 id=tokenize><a aria-label="Anchor link for: tokenize" class=zola-anchor href=#tokenize>tokenize</a></h2><p>ç’°å¢ƒã‚‚ã¨ã¨ã®ã£ãŸã®ã§ã€å‡¦ç†ã®æµã‚Œã‚’ãŠã£ã¦ã„ãã¾ã™ã€‚ã¾ãšã¯ã€å…¥åŠ›æ–‡å­—åˆ—ã‚’tokenã®Vecã«å¤‰æ›ã™ã‚‹lexéƒ¨åˆ†ã‹ã‚‰ã§ã™ã€‚ ã“ã®éƒ¨åˆ†ã¯ã€<a href=https://www.amazon.co.jp/dp/B07QVQ7RDG rel=external>å®Ÿè·µRustå…¥é–€</a>ã®ç¬¬9ç« ãƒ‘ãƒ¼ã‚µã‚’ä½œã‚‹ã‚’å‚è€ƒã«ã•ã›ã¦ã„ãŸã ãã¾ã—ãŸã€‚ https://github.com/ymgyt/r9cc/blob/7cad51b06d1ba4c1c73d5a01213128853bd115ff/src/lex/token.rs#L177<p>tokenã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã—ã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Debug</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Clone</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> PartialEq</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Eq</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> Loc</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>pub</span><span style=color:#8fbcbb> usize</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> pub</span><span style=color:#8fbcbb> usize</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Debug</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Clone</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> PartialEq</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Eq</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> Annot</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> value</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> T</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> loc</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Loc</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Annot</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> new</span><span style=color:#eceff4>(</span><span>value</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> T</span><span style=color:#eceff4>,</span><span> loc</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Loc</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        Self</span><span style=color:#eceff4> {</span><span> value</span><span style=color:#eceff4>,</span><span> loc</span><span style=color:#eceff4> }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Debug</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Copy</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Clone</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> PartialEq</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Eq</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub enum</span><span style=color:#8fbcbb> TokenKind</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0>    Number</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>u64</span><span style=color:#eceff4>),</span><span style=color:#616e88> // [0-9][0-9]*</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Plus</span><span style=color:#eceff4>,</span><span style=color:#616e88>        // '+'</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Minus</span><span style=color:#eceff4>,</span><span style=color:#616e88>       // '-'</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Asterisk</span><span style=color:#eceff4>,</span><span style=color:#616e88>    // '*'</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Slash</span><span style=color:#eceff4>,</span><span style=color:#616e88>       // '/'</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    LParen</span><span style=color:#eceff4>,</span><span style=color:#616e88>      // '('</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    RParen</span><span style=color:#eceff4>,</span><span style=color:#616e88>      // ')'</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Eof</span><span style=color:#eceff4>,</span><span style=color:#616e88>         // sentinel</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> TokenKind</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>crate</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> fn</span><span style=color:#88c0d0> is_number</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> bool</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        match *self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            TokenKind</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Number</span><span style=color:#eceff4>(</span><span>_</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> => true</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            _</span><span style=color:#81a1c1> => false</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>pub type</span><span style=color:#8fbcbb> Token</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Annot</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>TokenKind</span><span style=color:#eceff4>>;</span></span></code></pre><p>tokenã«ä½ç½®ã«é–¢ã™ã‚‹æƒ…å ±ã‚’ã‚‚ãŸã›ã‚‹ãŸã‚ã«ã€<code>Annot</code>ã§wrapã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯å®Ÿè·µRustå…¥é–€ã§ãŠã“ãªã‚ã‚Œã¦ã„ãŸå®Ÿè£…æ–¹æ³•ã§ã€Genericsã®ä½¿ã„æ–¹ã¨ã—ã¦éå¸¸ã«å‚è€ƒã«ãªã‚Šã¾ã—ãŸã€‚ <code>Loc</code>ã®æƒ…å ±ã¯ã‚¨ãƒ©ãƒ¼æ™‚ã«ä»¥ä¸‹ã®ã‚ˆã†ãªè¡¨ç¤ºã‚’ã ã™ãŸã‚ã«åˆ©ç”¨ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>./target/debug/r9cc</span><span style=color:#eceff4> '</span><span style=color:#a3be8c>1 + 2 - aaa</span><span style=color:#eceff4>'</span><span>  </span></span>
<span class=giallo-l><span style=color:#88c0d0>1</span><span style=color:#a3be8c> +</span><span style=color:#b48ead> 2</span><span style=color:#a3be8c> - aaa</span></span>
<span class=giallo-l><span style=color:#88c0d0>        ^</span><span style=color:#a3be8c> invalid char</span><span style=color:#eceff4> '</span><span style=color:#a3be8c>a</span><span style=color:#eceff4>'</span></span></code></pre><p>tokenã®ç”Ÿæˆã¯<code>tokenize</code>é–¢æ•°ã§è¡Œã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Debug</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> Input</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span>    input</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4> [</span><span style=color:#8fbcbb>u8</span><span style=color:#eceff4>],</span></span>
<span class=giallo-l><span>    pos</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Cell</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>usize</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Input</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> new</span><span style=color:#eceff4>(</span><span>s</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>a str</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            input</span><span style=color:#81a1c1>:</span><span> s</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_bytes</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>            pos</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Cell</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span style=color:#b48ead>0</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> consume_byte</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> want</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> u8</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>usize</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span style=color:#88c0d0>peek</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>and_then</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>got</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> u8</span><span style=color:#81a1c1>|</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            if</span><span> got</span><span style=color:#81a1c1> !=</span><span> want</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                let</span><span> pos</span><span style=color:#81a1c1> = self.</span><span style=color:#88c0d0>pos</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Err</span><span style=color:#eceff4>(</span><span>Error</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>invalid_char</span><span style=color:#eceff4>(</span><span>got</span><span style=color:#81a1c1> as</span><span style=color:#8fbcbb> char</span><span style=color:#eceff4>,</span><span style=color:#88c0d0> Loc</span><span style=color:#eceff4>(</span><span>pos</span><span style=color:#eceff4>,</span><span> pos</span><span style=color:#81a1c1> +</span><span style=color:#b48ead> 1</span><span style=color:#eceff4>)))</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Ok</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span style=color:#88c0d0>pos_then_inc</span><span style=color:#eceff4>())</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        })</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> consume_numbers</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;(</span><span style=color:#8fbcbb>usize</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> u64</span><span style=color:#eceff4>)> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> start</span><span style=color:#81a1c1> = self.</span><span style=color:#88c0d0>pos</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span style=color:#88c0d0>consume</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>b</span><span style=color:#81a1c1>|</span><span style=color:#a3be8c> b</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>0123456789</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>contains</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>b</span><span style=color:#eceff4>));</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> n</span><span style=color:#81a1c1> =</span><span> std</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>str</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_utf8</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self.</span><span>input</span><span style=color:#eceff4>[</span><span>start</span><span style=color:#81a1c1>..self.</span><span style=color:#88c0d0>pos</span><span style=color:#eceff4>()])</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>parse</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Ok</span><span style=color:#eceff4>((</span><span>start</span><span style=color:#eceff4>,</span><span> n</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> consume_spaces</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span style=color:#88c0d0>consume</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>b</span><span style=color:#81a1c1>|</span><span style=color:#a3be8c> b</span><span style=color:#eceff4>"</span><span style=color:#ebcb8b> \n\t</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>contains</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>b</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> consume</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> mut</span><span> f</span><span style=color:#81a1c1>: impl</span><span style=color:#88c0d0> FnMut</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>u8</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> bool</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        while let</span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>(</span><span>b</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> = self.</span><span style=color:#88c0d0>peek</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            if</span><span style=color:#88c0d0> f</span><span style=color:#eceff4>(</span><span>b</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span style=color:#88c0d0>inc</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>                continue</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#81a1c1>            break</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> peek</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>u8</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>input</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>get</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span style=color:#88c0d0>pos</span><span style=color:#eceff4>())</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>map</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|&</span><span>b</span><span style=color:#81a1c1>|</span><span> b</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>ok_or_else</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|| self.</span><span style=color:#88c0d0>eof</span><span style=color:#eceff4>())</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> pos</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> usize</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>pos</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>get</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> inc</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>pos</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>set</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span style=color:#88c0d0>pos</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> +</span><span style=color:#b48ead> 1</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> pos_then_inc</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> usize</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> pos</span><span style=color:#81a1c1> = self.</span><span style=color:#88c0d0>pos</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span style=color:#88c0d0>inc</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span>        pos</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> eof</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Error</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> pos</span><span style=color:#81a1c1> = self.</span><span style=color:#88c0d0>pos</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Error</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>eof</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>Loc</span><span style=color:#eceff4>(</span><span>pos</span><span style=color:#eceff4>,</span><span> pos</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>pub fn</span><span style=color:#88c0d0> tokenize</span><span style=color:#eceff4>(</span><span>input</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>str</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> StdResult</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Stream</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> crate::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> tokens</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Vec</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> input</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Input</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>input</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    macro_rules! push</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#eceff4>        (</span><span style=color:#81a1c1>$</span><span>lexer</span><span style=color:#81a1c1>:</span><span>expr</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {{</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let</span><span> tk</span><span style=color:#81a1c1> = $</span><span>lexer</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span>            tokens</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>push</span><span style=color:#eceff4>(</span><span>tk</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>        }};</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#81a1c1>    loop</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        match</span><span> input</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>peek</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Err</span><span style=color:#eceff4>(</span><span>e</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> => match</span><span> e</span><span style=color:#81a1c1>.</span><span>value </span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                ErrorKind</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Eof</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                    tokens</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>push</span><span style=color:#eceff4>(</span><span>Token</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>eof</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>Loc</span><span style=color:#eceff4>(</span><span>input</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>pos</span><span style=color:#eceff4>(),</span><span> input</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>pos</span><span style=color:#eceff4>())));</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    return</span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>(</span><span>tokens</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span>                _</span><span style=color:#81a1c1> => return</span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span>e</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>()),</span></span>
<span class=giallo-l><span style=color:#eceff4>            },</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Ok</span><span style=color:#eceff4>(</span><span>b</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> => match</span><span> b</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#a3be8c>                b</span><span style=color:#eceff4>'</span><span style=color:#a3be8c>0</span><span style=color:#eceff4>'</span><span style=color:#81a1c1>..=</span><span style=color:#a3be8c>b</span><span style=color:#eceff4>'</span><span style=color:#a3be8c>9</span><span style=color:#eceff4>'</span><span style=color:#81a1c1> =></span><span style=color:#88c0d0;font-weight:700> push!</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>lex_number</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>input</span><span style=color:#eceff4>)),</span></span>
<span class=giallo-l><span style=color:#a3be8c>                b</span><span style=color:#eceff4>'</span><span style=color:#a3be8c>+</span><span style=color:#eceff4>'</span><span style=color:#81a1c1> =></span><span style=color:#88c0d0;font-weight:700> push!</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>lex_plus</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>input</span><span style=color:#eceff4>)),</span></span>
<span class=giallo-l><span style=color:#a3be8c>                b</span><span style=color:#eceff4>'</span><span style=color:#a3be8c>-</span><span style=color:#eceff4>'</span><span style=color:#81a1c1> =></span><span style=color:#88c0d0;font-weight:700> push!</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>lex_minus</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>input</span><span style=color:#eceff4>)),</span></span>
<span class=giallo-l><span style=color:#a3be8c>                b</span><span style=color:#eceff4>'</span><span style=color:#a3be8c>*</span><span style=color:#eceff4>'</span><span style=color:#81a1c1> =></span><span style=color:#88c0d0;font-weight:700> push!</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>lex_asterisk</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>input</span><span style=color:#eceff4>)),</span></span>
<span class=giallo-l><span style=color:#a3be8c>                b</span><span style=color:#eceff4>'</span><span style=color:#a3be8c>/</span><span style=color:#eceff4>'</span><span style=color:#81a1c1> =></span><span style=color:#88c0d0;font-weight:700> push!</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>lex_slash</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>input</span><span style=color:#eceff4>)),</span></span>
<span class=giallo-l><span style=color:#a3be8c>                b</span><span style=color:#eceff4>'</span><span style=color:#a3be8c>(</span><span style=color:#eceff4>'</span><span style=color:#81a1c1> =></span><span style=color:#88c0d0;font-weight:700> push!</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>lex_lparen</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>input</span><span style=color:#eceff4>)),</span></span>
<span class=giallo-l><span style=color:#a3be8c>                b</span><span style=color:#eceff4>'</span><span style=color:#a3be8c>)</span><span style=color:#eceff4>'</span><span style=color:#81a1c1> =></span><span style=color:#88c0d0;font-weight:700> push!</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>lex_rparen</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>input</span><span style=color:#eceff4>)),</span></span>
<span class=giallo-l><span>                _</span><span style=color:#81a1c1> if</span><span style=color:#eceff4> (</span><span>b</span><span style=color:#81a1c1> as</span><span style=color:#8fbcbb> char</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>is_ascii_whitespace</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> =></span><span> input</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>consume_spaces</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>                _</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    return</span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                        Error</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>invalid_char</span><span style=color:#eceff4>(</span><span>b</span><span style=color:#81a1c1> as</span><span style=color:#8fbcbb> char</span><span style=color:#eceff4>,</span><span style=color:#88c0d0> Loc</span><span style=color:#eceff4>(</span><span>input</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>pos</span><span style=color:#eceff4>(),</span><span> input</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>pos</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> +</span><span style=color:#b48ead> 1</span><span style=color:#eceff4>))</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>                    )</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#eceff4>            },</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> lex_number</span><span style=color:#eceff4>(</span><span>input</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Input</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Token</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span>    input</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>consume_numbers</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>map</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span style=color:#eceff4>(</span><span>pos</span><span style=color:#eceff4>,</span><span> n</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>|</span><span style=color:#8fbcbb> Token</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>number</span><span style=color:#eceff4>(</span><span>n</span><span style=color:#eceff4>,</span><span style=color:#88c0d0> Loc</span><span style=color:#eceff4>(</span><span>pos</span><span style=color:#eceff4>,</span><span> input</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>pos</span><span style=color:#eceff4>())))</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> lex_plus</span><span style=color:#eceff4>(</span><span>input</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Input</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Token</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span>    input</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>consume_byte</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>b</span><span style=color:#eceff4>'</span><span style=color:#a3be8c>+</span><span style=color:#eceff4>')</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>map</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>pos</span><span style=color:#81a1c1>|</span><span> Token</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>plus</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>Loc</span><span style=color:#eceff4>(</span><span>pos</span><span style=color:#eceff4>,</span><span> pos</span><span style=color:#81a1c1> +</span><span style=color:#b48ead> 1</span><span style=color:#eceff4>)))</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> lex_minus</span><span style=color:#eceff4>(</span><span>input</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Input</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Token</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span>    input</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>consume_byte</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>b</span><span style=color:#eceff4>'</span><span style=color:#a3be8c>-</span><span style=color:#eceff4>')</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>map</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>pos</span><span style=color:#81a1c1>|</span><span> Token</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>minus</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>Loc</span><span style=color:#eceff4>(</span><span>pos</span><span style=color:#eceff4>,</span><span> pos</span><span style=color:#81a1c1> +</span><span style=color:#b48ead> 1</span><span style=color:#eceff4>)))</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> lex_asterisk</span><span style=color:#eceff4>(</span><span>input</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Input</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Token</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span>    input</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>consume_byte</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>b</span><span style=color:#eceff4>'</span><span style=color:#a3be8c>*</span><span style=color:#eceff4>')</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>map</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>pos</span><span style=color:#81a1c1>|</span><span> Token</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>asterisk</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>Loc</span><span style=color:#eceff4>(</span><span>pos</span><span style=color:#eceff4>,</span><span> pos</span><span style=color:#81a1c1> +</span><span style=color:#b48ead> 1</span><span style=color:#eceff4>)))</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> lex_slash</span><span style=color:#eceff4>(</span><span>input</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Input</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Token</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span>    input</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>consume_byte</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>b</span><span style=color:#eceff4>'</span><span style=color:#a3be8c>/</span><span style=color:#eceff4>')</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>map</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>pos</span><span style=color:#81a1c1>|</span><span> Token</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>slash</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>Loc</span><span style=color:#eceff4>(</span><span>pos</span><span style=color:#eceff4>,</span><span> pos</span><span style=color:#81a1c1> +</span><span style=color:#b48ead> 1</span><span style=color:#eceff4>)))</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> lex_lparen</span><span style=color:#eceff4>(</span><span>input</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Input</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Token</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span>    input</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>consume_byte</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>b</span><span style=color:#eceff4>'</span><span style=color:#a3be8c>(</span><span style=color:#eceff4>')</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>map</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>pos</span><span style=color:#81a1c1>|</span><span> Token</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>lparen</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>Loc</span><span style=color:#eceff4>(</span><span>pos</span><span style=color:#eceff4>,</span><span> pos</span><span style=color:#81a1c1> +</span><span style=color:#b48ead> 1</span><span style=color:#eceff4>)))</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> lex_rparen</span><span style=color:#eceff4>(</span><span>input</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Input</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Token</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span>    input</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>consume_byte</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>b</span><span style=color:#eceff4>'</span><span style=color:#a3be8c>)</span><span style=color:#eceff4>')</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>map</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>pos</span><span style=color:#81a1c1>|</span><span> Token</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>rparen</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>Loc</span><span style=color:#eceff4>(</span><span>pos</span><span style=color:#eceff4>,</span><span> pos</span><span style=color:#81a1c1> +</span><span style=color:#b48ead> 1</span><span style=color:#eceff4>)))</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>æ¼”ç®—å­ãªã‚‰ãã®ã¾ã¾tokenã«ã€ç©ºç™½ã¯ç„¡è¦–ã—ã¦ã€æ•°å­—ãªã‚‰é€”åˆ‡ã‚Œã‚‹ã¾ã§èª­ã‚“ã§ã‹ã‚‰å¤‰æ›ã‚’è©¦ã¿ã¾ã™ã€‚ å…¥åŠ›æ–‡å­—åˆ—ã¨ä½•byteã¾ã§èª­ã‚“ã ã‹ã‚’ä¸€ç·’ã«å¼•ãå›ã—ãŸã‹ã£ãŸã®ã§<code>Input</code>å‹ã§wrapã—ã¦ã„ã¾ã™ã€‚å…¥åŠ›æ–‡å­—åˆ—ã¯<code>&str</code>ã§å¯å¤‰å‚ç…§ãŒã¨ã‚Œãªã„ã®ã§ã€posã‚’<code>Cell</code>ã§wrapã—ã¦ã„ã¾ã™ã€‚ (ã“ã‚ŒãŒCellã®æ­£ã—ã„ä½¿ã„æ–¹ãªã®ã‹ã¯ã‚ã¾ã‚Šè‡ªä¿¡ãŒãªã„ã§ã™ã€‚)<h2 id=asthenobian-huan><a aria-label="Anchor link for: asthenobian-huan" class=zola-anchor href=#asthenobian-huan>ASTã¸ã®å¤‰æ›</a></h2><p>ç¶šã„ã¦ã€tokenåˆ—ã‚’Treeå‹ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã«å¤‰æ›ã—ã¾ã™ã€‚ASTã‚’è¡¨ã™Nodeã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã—ã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Debug</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> PartialEq</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub enum</span><span style=color:#8fbcbb> Kind</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Add</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Sub</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Mul</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Div</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#88c0d0>    Number</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>u64</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>pub type</span><span style=color:#8fbcbb> Link</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Box</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Node</span><span style=color:#eceff4>>>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Debug</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> PartialEq</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> Node</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> kind</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Kind</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> lhs</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Link</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> rhs</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Link</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Node</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> new</span><span style=color:#eceff4>(</span><span>kind</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Kind</span><span style=color:#eceff4>,</span><span> lhs</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Link</span><span style=color:#eceff4>,</span><span> rhs</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Link</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Node</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        Self</span><span style=color:#eceff4> {</span><span> kind</span><span style=color:#eceff4>,</span><span> lhs</span><span style=color:#eceff4>,</span><span> rhs</span><span style=color:#eceff4> }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> link</span><span style=color:#eceff4>(</span><span>node</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Node</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Link</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Some</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Box</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>node</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> number</span><span style=color:#eceff4>(</span><span>n</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> u64</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Node</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Node</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>Kind</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Number</span><span style=color:#eceff4>(</span><span>n</span><span style=color:#eceff4>),</span><span style=color:#8fbcbb> None</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> None</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>Cã®pointerã¯<code>Option&lt;Box&lt;T>></code>ã§ä»£ç”¨ã—ã¾ã—ãŸã€‚(ã‚‚ã£ã¨ã„ã„æ–¹æ³•ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚) ä»Šå›ã¯åˆ©ç”¨ã—ã¾ã›ã‚“ã§ã—ãŸãŒã€Rustã®pointerã®ã²ã¨ã¤ã§ã‚ã‚‹<code>Rc</code>ã«ã¤ã„ã¦ã¯@qnighyã•ã‚“ã®<a href=https://qiita.com/qnighy/items/4bbbb20e71cf4ae527b9 rel=external>ã“ã¡ã‚‰ã®è¨˜äº‹</a>ãŒå¤§å¤‰å‚è€ƒã«ãªã‚Šã¾ã—ãŸã€‚<p>å››å‰‡æ¼”ç®—ã‚’parseã™ã‚‹ãŸã‚ã®æ–‡æ³•è¦å‰‡ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>expr    = mul ("+" mul | "-" mul)*</span></span>
<span class=giallo-l><span>mul     = primary ("*" primary | "/" primary)*</span></span>
<span class=giallo-l><span>primary = num | "(" expr ")"</span></span></code></pre><p>ã“ã®<code>expr</code>, <code>mul</code>, <code>primary</code>ãã‚Œãã‚Œã«å¯¾å¿œã™ã‚‹é–¢æ•°ã‚’å®šç¾©ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>type</span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>></span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> StdResult</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Error</span><span style=color:#eceff4>>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>pub fn</span><span style=color:#88c0d0> parse</span><span style=color:#eceff4>(</span><span>stream</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Stream</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> StdResult</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Node</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> crate::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> tokens</span><span style=color:#81a1c1> =</span><span> stream</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into_iter</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>peekable</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#88c0d0>    expr</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut</span><span> tokens</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>map_err</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>e</span><span style=color:#81a1c1>| crate::</span><span>Error</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from</span><span style=color:#eceff4>(</span><span>e</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> expr</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Tokens</span><span style=color:#eceff4>>(</span><span>tokens</span><span style=color:#81a1c1>: &mut</span><span style=color:#8fbcbb> Peekable</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Tokens</span><span style=color:#eceff4>>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Node</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Tokens</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Iterator</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Item</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Token</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> node</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> mul</span><span style=color:#eceff4>(</span><span>tokens</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    loop</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if</span><span style=color:#88c0d0> consume</span><span style=color:#eceff4>(</span><span>tokens</span><span style=color:#eceff4>,</span><span> TokenKind</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Plus</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            node</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Node</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>Kind</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Add</span><span style=color:#eceff4>,</span><span> Node</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>link</span><span style=color:#eceff4>(</span><span>node</span><span style=color:#eceff4>),</span><span> Node</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>link</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>mul</span><span style=color:#eceff4>(</span><span>tokens</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>));</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span><span style=color:#81a1c1> else if</span><span style=color:#88c0d0> consume</span><span style=color:#eceff4>(</span><span>tokens</span><span style=color:#eceff4>,</span><span> TokenKind</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Minus</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            node</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Node</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>Kind</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Sub</span><span style=color:#eceff4>,</span><span> Node</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>link</span><span style=color:#eceff4>(</span><span>node</span><span style=color:#eceff4>),</span><span> Node</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>link</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>mul</span><span style=color:#eceff4>(</span><span>tokens</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>));</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            return</span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>(</span><span>node</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> mul</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Tokens</span><span style=color:#eceff4>>(</span><span>tokens</span><span style=color:#81a1c1>: &mut</span><span style=color:#8fbcbb> Peekable</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Tokens</span><span style=color:#eceff4>>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Node</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Tokens</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Iterator</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Item</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Token</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> node</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> primary</span><span style=color:#eceff4>(</span><span>tokens</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    loop</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if</span><span style=color:#88c0d0> consume</span><span style=color:#eceff4>(</span><span>tokens</span><span style=color:#eceff4>,</span><span> TokenKind</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Asterisk</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            node</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Node</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>Kind</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Mul</span><span style=color:#eceff4>,</span><span> Node</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>link</span><span style=color:#eceff4>(</span><span>node</span><span style=color:#eceff4>),</span><span> Node</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>link</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>primary</span><span style=color:#eceff4>(</span><span>tokens</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>));</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span><span style=color:#81a1c1> else if</span><span style=color:#88c0d0> consume</span><span style=color:#eceff4>(</span><span>tokens</span><span style=color:#eceff4>,</span><span> TokenKind</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Slash</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            node</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Node</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>Kind</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Div</span><span style=color:#eceff4>,</span><span> Node</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>link</span><span style=color:#eceff4>(</span><span>node</span><span style=color:#eceff4>),</span><span> Node</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>link</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>primary</span><span style=color:#eceff4>(</span><span>tokens</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>));</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            return</span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>(</span><span>node</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> primary</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Tokens</span><span style=color:#eceff4>>(</span><span>tokens</span><span style=color:#81a1c1>: &mut</span><span style=color:#8fbcbb> Peekable</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Tokens</span><span style=color:#eceff4>>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Node</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Tokens</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Iterator</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Item</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Token</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> node</span><span style=color:#81a1c1> = if</span><span style=color:#88c0d0> consume</span><span style=color:#eceff4>(</span><span>tokens</span><span style=color:#eceff4>,</span><span> TokenKind</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>LParen</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> node</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> expr</span><span style=color:#eceff4>(</span><span>tokens</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#88c0d0>        expect</span><span style=color:#eceff4>(</span><span>tokens</span><span style=color:#eceff4>,</span><span> TokenKind</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>RParen</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span>        node</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Node</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>number</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>expect_number</span><span style=color:#eceff4>(</span><span>tokens</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    };</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Ok</span><span style=color:#eceff4>(</span><span>node</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> consume</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Tokens</span><span style=color:#eceff4>>(</span><span>tokens</span><span style=color:#81a1c1>: &mut</span><span style=color:#8fbcbb> Peekable</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Tokens</span><span style=color:#eceff4>>,</span><span> kind</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> TokenKind</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>bool</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Tokens</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Iterator</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Item</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Token</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> peek</span><span style=color:#81a1c1> =</span><span> tokens</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>peek</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>    if</span><span> peek</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>is_none</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        return</span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>false</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> peek</span><span style=color:#81a1c1> =</span><span> peek</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>    if</span><span> peek</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>is_kind</span><span style=color:#eceff4>(</span><span>kind</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span>        tokens</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>next</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Ok</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>true</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Ok</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>false</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> expect</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Tokens</span><span style=color:#eceff4>>(</span><span>tokens</span><span style=color:#81a1c1>: &mut</span><span style=color:#8fbcbb> Peekable</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Tokens</span><span style=color:#eceff4>>,</span><span> kind</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> TokenKind</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;()></span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Tokens</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Iterator</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Item</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Token</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> peek</span><span style=color:#81a1c1> =</span><span> tokens</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>peek</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>    if</span><span> peek</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>is_none</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        return</span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Error</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Eof</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> peek</span><span style=color:#81a1c1> =</span><span> peek</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>    if</span><span> peek</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>is_kind</span><span style=color:#eceff4>(</span><span>kind</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span>        tokens</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>next</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Ok</span><span style=color:#eceff4>(())</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Err</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Error</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>UnexpectedToken</span><span style=color:#eceff4>(</span><span>peek</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>()))</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> expect_number</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Tokens</span><span style=color:#eceff4>>(</span><span>tokens</span><span style=color:#81a1c1>: &mut</span><span style=color:#8fbcbb> Peekable</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Tokens</span><span style=color:#eceff4>>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>u64</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Tokens</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Iterator</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Item</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Token</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> peek</span><span style=color:#81a1c1> =</span><span> tokens</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>peek</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>    if</span><span> peek</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>is_none</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        return</span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Error</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Eof</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> peek</span><span style=color:#81a1c1> =</span><span> peek</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>    match</span><span> peek</span><span style=color:#81a1c1>.</span><span>value </span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        TokenKind</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Number</span><span style=color:#eceff4>(</span><span>n</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            tokens</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>next</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Ok</span><span style=color:#eceff4>(</span><span>n</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span>        _</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Error</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>UnexpectedToken</span><span style=color:#eceff4>(</span><span>peek</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>())),</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>å„ªå…ˆåº¦ã®é«˜ã„æ¼”ç®—å­ã»ã©å…ˆã«å‡¦ç†ã•ã‚Œã¦ã€æœ¨ã®æ·±ã„ä½ç½®ã«ãŠã‹ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚(æ–‡æ³•è¦å‰‡ã‚’ãã®ã¾ã¾ã‚³ãƒ¼ãƒ‰ã«ã—ã¦å‹•ãã®ã¯æ„Ÿå‹•ã—ã¾ã™ã€‚)<h2 id=asenburinosheng-cheng><a aria-label="Anchor link for: asenburinosheng-cheng" class=zola-anchor href=#asenburinosheng-cheng>ã‚¢ã‚»ãƒ³ãƒ–ãƒªã®ç”Ÿæˆ</a></h2><p>ASTã®parseå‡¦ç†ã«ã‚ˆã£ã¦ã€è¨ˆç®—ã®å„ªå…ˆåº¦ã¯æœ¨ã®æ·±ã•ã§è¡¨ç¾ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ä¸€ç•ªæ·±ã„ã¨ã“ã‚ã‹ã‚‰ã€æ¼”ç®—å­ã«å¯¾å¿œã™ã‚‹å‘½ä»¤ã‚’å®Ÿè¡Œã—ã¦è¨ˆç®—çµæœã‚’ã‚¹ã‚¿ãƒƒã‚¯ã«ä¿æŒã™ã‚‹ã‚ˆã†ãªã‚¢ã‚»ãƒ³ãƒ–ãƒªã‚’å‡ºåŠ›ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>pub fn</span><span style=color:#88c0d0> gen</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>W</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Write</span><span style=color:#eceff4>>(</span><span>w</span><span style=color:#81a1c1>: &mut</span><span style=color:#8fbcbb> W</span><span style=color:#eceff4>,</span><span> node</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Node</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;(),</span><span style=color:#81a1c1> crate::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#88c0d0>    pre_gen</span><span style=color:#eceff4>(</span><span>w</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>and_then</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>_</span><span style=color:#81a1c1>|</span><span style=color:#88c0d0> main_gen</span><span style=color:#eceff4>(</span><span>w</span><span style=color:#eceff4>,</span><span> node</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>and_then</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>_</span><span style=color:#81a1c1>|</span><span style=color:#88c0d0> post_gen</span><span style=color:#eceff4>(</span><span>w</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>map_err</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>e</span><span style=color:#81a1c1>| crate::</span><span>Error</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from</span><span style=color:#eceff4>(</span><span>e</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> pre_gen</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>W</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Write</span><span style=color:#eceff4>>(</span><span>w</span><span style=color:#81a1c1>: &mut</span><span style=color:#8fbcbb> W</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span> io</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    write!</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>        w</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>        "</span><span style=color:#a3be8c>.intel_syntax noprefix</span><span style=color:#ebcb8b>\n</span><span style=color:#a3be8c>\</span></span>
<span class=giallo-l><span style=color:#a3be8c>         .global main</span><span style=color:#ebcb8b>\n</span><span style=color:#a3be8c>\</span></span>
<span class=giallo-l><span style=color:#a3be8c>         main:</span><span style=color:#ebcb8b>\n</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>    )</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> main_gen</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>W</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Write</span><span style=color:#eceff4>>(</span><span>w</span><span style=color:#81a1c1>: &mut</span><span style=color:#8fbcbb> W</span><span style=color:#eceff4>,</span><span> node</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Node</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span> io</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    if let</span><span style=color:#8fbcbb> NodeKind</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Number</span><span style=color:#eceff4>(</span><span>n</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> node</span><span style=color:#81a1c1>.</span><span>kind </span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>        write!</span><span style=color:#eceff4>(</span><span>w</span><span style=color:#eceff4>, "</span><span style=color:#a3be8c>  push </span><span style=color:#ebcb8b>{}\n</span><span style=color:#eceff4>",</span><span> n</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        return</span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>(());</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>    main_gen</span><span style=color:#eceff4>(</span><span>w</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> &</span><span>node</span><span style=color:#81a1c1>.</span><span>lhs</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_ref</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#88c0d0>    main_gen</span><span style=color:#eceff4>(</span><span>w</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> &</span><span>node</span><span style=color:#81a1c1>.</span><span>rhs</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_ref</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    write!</span><span style=color:#eceff4>(</span><span>w</span><span style=color:#eceff4>, "</span><span style=color:#a3be8c>  pop rdi</span><span style=color:#ebcb8b>\n</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    write!</span><span style=color:#eceff4>(</span><span>w</span><span style=color:#eceff4>, "</span><span style=color:#a3be8c>  pop rax</span><span style=color:#ebcb8b>\n</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    match</span><span> node</span><span style=color:#81a1c1>.</span><span>kind </span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        NodeKind</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Add</span><span style=color:#81a1c1> =></span><span style=color:#88c0d0;font-weight:700> write!</span><span style=color:#eceff4>(</span><span>w</span><span style=color:#eceff4>, "</span><span style=color:#a3be8c>  add rax, rdi</span><span style=color:#ebcb8b>\n</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        NodeKind</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Sub</span><span style=color:#81a1c1> =></span><span style=color:#88c0d0;font-weight:700> write!</span><span style=color:#eceff4>(</span><span>w</span><span style=color:#eceff4>, "</span><span style=color:#a3be8c>  sub rax, rdi</span><span style=color:#ebcb8b>\n</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        NodeKind</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Mul</span><span style=color:#81a1c1> =></span><span style=color:#88c0d0;font-weight:700> write!</span><span style=color:#eceff4>(</span><span>w</span><span style=color:#eceff4>, "</span><span style=color:#a3be8c>  imul rax, rdi</span><span style=color:#ebcb8b>\n</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        NodeKind</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Div</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>            write!</span><span style=color:#eceff4>(</span><span>w</span><span style=color:#eceff4>, "</span><span style=color:#a3be8c>  cqo</span><span style=color:#ebcb8b>\n</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>            write!</span><span style=color:#eceff4>(</span><span>w</span><span style=color:#eceff4>, "</span><span style=color:#a3be8c>  idiv rdi</span><span style=color:#ebcb8b>\n</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span>        _</span><span style=color:#81a1c1> =></span><span style=color:#88c0d0;font-weight:700> unreachable!</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    write!</span><span style=color:#eceff4>(</span><span>w</span><span style=color:#eceff4>, "</span><span style=color:#a3be8c>  push rax</span><span style=color:#ebcb8b>\n</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>    Ok</span><span style=color:#eceff4>(())</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> post_gen</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>W</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Write</span><span style=color:#eceff4>>(</span><span>w</span><span style=color:#81a1c1>: &mut</span><span style=color:#8fbcbb> W</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span> io</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    write!</span><span style=color:#eceff4>(</span><span>w</span><span style=color:#eceff4>, "</span><span style=color:#ebcb8b>{}{}</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>  pop rax</span><span style=color:#ebcb8b>\n</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>  ret</span><span style=color:#ebcb8b>\n</span><span style=color:#eceff4>")</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>(divã ã‘x86-64ã®ä»•æ§˜ãŒç‰¹æ®Šã§è¿½åŠ ã®å‡¦ç†ãŒå¿…è¦ã‚‰ã—ã„ã§ã™) æ•°å€¤ãªã‚‰stackã«pushã—ã¦ã€æ¼”ç®—å­ãªã‚‰popã‚’2å›ãŠã“ãªã£ã¦ã‹ã‚‰è¨ˆç®—ã—ã¦çµæœã‚’stackã«æ›¸ãæˆ»ã™ã‚·ãƒ³ãƒ—ãƒ«ãªå‡¦ç†ã§ã™ã€‚<h2 id=test><a aria-label="Anchor link for: test" class=zola-anchor href=#test>test</a></h2><p>ã“ã“ã¾ã§ã§ã€å…¥åŠ›æ–‡å­—åˆ—ã‹ã‚‰ã‚¢ã‚»ãƒ³ãƒ–ãƒªã‚’å‡ºåŠ›ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>./target/debug/r9cc</span><span style=color:#eceff4> '</span><span style=color:#a3be8c>6/2*(3+4)</span><span style=color:#eceff4>'</span><span>   </span></span>
<span class=giallo-l><span style=color:#88c0d0>.intel_syntax</span><span style=color:#a3be8c> noprefix</span></span>
<span class=giallo-l><span style=color:#88c0d0>.global</span><span style=color:#a3be8c> main</span></span>
<span class=giallo-l><span style=color:#88c0d0>main:</span></span>
<span class=giallo-l><span style=color:#88c0d0>  push</span><span style=color:#b48ead> 6</span></span>
<span class=giallo-l><span style=color:#88c0d0>  push</span><span style=color:#b48ead> 2</span></span>
<span class=giallo-l><span style=color:#88c0d0>  pop</span><span style=color:#a3be8c> rdi</span></span>
<span class=giallo-l><span style=color:#88c0d0>  pop</span><span style=color:#a3be8c> rax</span></span>
<span class=giallo-l><span style=color:#88c0d0>  cqo</span></span>
<span class=giallo-l><span style=color:#88c0d0>  idiv</span><span style=color:#a3be8c> rdi</span></span>
<span class=giallo-l><span style=color:#88c0d0>  push</span><span style=color:#a3be8c> rax</span></span>
<span class=giallo-l><span style=color:#88c0d0>  push</span><span style=color:#b48ead> 3</span></span>
<span class=giallo-l><span style=color:#88c0d0>  push</span><span style=color:#b48ead> 4</span></span>
<span class=giallo-l><span style=color:#88c0d0>  pop</span><span style=color:#a3be8c> rdi</span></span>
<span class=giallo-l><span style=color:#88c0d0>  pop</span><span style=color:#a3be8c> rax</span></span>
<span class=giallo-l><span style=color:#88c0d0>  add</span><span style=color:#a3be8c> rax, rdi</span></span>
<span class=giallo-l><span style=color:#88c0d0>  push</span><span style=color:#a3be8c> rax</span></span>
<span class=giallo-l><span style=color:#88c0d0>  pop</span><span style=color:#a3be8c> rdi</span></span>
<span class=giallo-l><span style=color:#88c0d0>  pop</span><span style=color:#a3be8c> rax</span></span>
<span class=giallo-l><span style=color:#88c0d0>  imul</span><span style=color:#a3be8c> rax, rdi</span></span>
<span class=giallo-l><span style=color:#88c0d0>  push</span><span style=color:#a3be8c> rax</span></span>
<span class=giallo-l><span style=color:#88c0d0>  pop</span><span style=color:#a3be8c> rax</span></span>
<span class=giallo-l><span style=color:#88c0d0>  ret</span></span></code></pre><p>ã‚¢ã‚»ãƒ³ãƒ–ãƒªã‹ã‚‰æ©Ÿæ¢°èªã¸ã®å¤‰æ›ã¯dockerä¸Šã§ãŠã“ãªã„ã€testã‚’èµ°ã‚‰ã›ã¾ã™ã€‚ testç”¨ã®scriptã¯compilerbookã®ã‚‚ã®ã‚’å®Ÿè¡Œpathã‚’ä¿®æ­£ã—ã¦åˆ©ç”¨ã—ã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#616e88>#!/bin/bash</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>CMD</span><span style=color:#81a1c1>=</span><span style=color:#a3be8c>./target/x86_64-unknown-linux-musl/debug/r9cc</span></span>
<span class=giallo-l><span>TARGET</span><span style=color:#81a1c1>=</span><span style=color:#a3be8c>./target/tmp</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>mkdir</span><span style=color:#a3be8c> -p</span><span style=color:#eceff4> "</span><span style=color:#81a1c1>${</span><span>TARGET</span><span style=color:#81a1c1>}</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>try</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span>  expected</span><span style=color:#81a1c1>=</span><span style=color:#eceff4>"</span><span>$1</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span>  input</span><span style=color:#81a1c1>=</span><span style=color:#eceff4>"</span><span>$2</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>  ${</span><span>CMD</span><span style=color:#81a1c1>}</span><span style=color:#eceff4> "</span><span>$input</span><span style=color:#eceff4>"</span><span style=color:#81a1c1> ></span><span style=color:#eceff4> "</span><span style=color:#81a1c1>${</span><span>TARGET</span><span style=color:#81a1c1>}</span><span style=color:#a3be8c>/tmp.s</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#88c0d0>  gcc</span><span style=color:#a3be8c> -o</span><span style=color:#eceff4> "</span><span style=color:#81a1c1>${</span><span>TARGET</span><span style=color:#81a1c1>}</span><span style=color:#a3be8c>/tmp</span><span style=color:#eceff4>" "</span><span style=color:#81a1c1>${</span><span>TARGET</span><span style=color:#81a1c1>}</span><span style=color:#a3be8c>/tmp.s</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#88c0d0>  "</span><span style=color:#81a1c1>${</span><span>TARGET</span><span style=color:#81a1c1>}</span><span style=color:#88c0d0>/tmp"</span></span>
<span class=giallo-l><span>  actual</span><span style=color:#81a1c1>=</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>$?</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>  if</span><span style=color:#eceff4> [ "</span><span>$actual</span><span style=color:#eceff4>"</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span>$expected</span><span style=color:#eceff4>" ]</span><span style=color:#81a1c1>; then</span></span>
<span class=giallo-l><span style=color:#88c0d0>    echo</span><span style=color:#eceff4> "</span><span>$input</span><span style=color:#a3be8c> => </span><span>$actual</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#81a1c1>  else</span></span>
<span class=giallo-l><span style=color:#88c0d0>    echo</span><span style=color:#eceff4> "</span><span>$input</span><span style=color:#a3be8c> => </span><span>$expected</span><span style=color:#a3be8c> expected, but got </span><span>$actual</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#88c0d0>    exit</span><span style=color:#b48ead> 1</span></span>
<span class=giallo-l><span style=color:#81a1c1>  fi</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>try</span><span style=color:#b48ead> 0 0</span></span>
<span class=giallo-l><span style=color:#88c0d0>try</span><span style=color:#b48ead> 100 100</span></span>
<span class=giallo-l><span style=color:#88c0d0>try</span><span style=color:#b48ead> 2</span><span style=color:#eceff4> '</span><span style=color:#a3be8c>1+1</span><span style=color:#eceff4>'</span></span>
<span class=giallo-l><span style=color:#88c0d0>try</span><span style=color:#b48ead> 21</span><span style=color:#eceff4> '</span><span style=color:#a3be8c>3*(9-2)</span><span style=color:#eceff4>'</span></span>
<span class=giallo-l><span style=color:#88c0d0>try</span><span style=color:#b48ead> 14</span><span style=color:#eceff4> '</span><span style=color:#a3be8c>(3+3)+2*(5-1)</span><span style=color:#eceff4>'</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>echo</span><span style=color:#a3be8c> OK</span></span></code></pre><p>dockerã®base imageã¯ubuntuãªã®ã§ã€crossã‚’åˆ©ç”¨ã—ã¦cross compileã‚’å®Ÿè¡Œã—ã¦ã‹ã‚‰ã€dockerä¸Šã§ä¸Šè¨˜ã®test.shã‚’å®Ÿè¡Œã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#eceff4>[</span><span>loc rs/r9cc</span><span style=color:#eceff4>]</span><span> cargo make build </span></span>
<span class=giallo-l><span style=color:#eceff4>[</span><span>cargo-make</span><span style=color:#eceff4>]</span><span> INFO - cargo make 0.25.0</span></span>
<span class=giallo-l><span style=color:#eceff4>[</span><span>cargo-make</span><span style=color:#eceff4>]</span><span> INFO - Project: r9cc</span></span>
<span class=giallo-l><span style=color:#eceff4>[</span><span>cargo-make</span><span style=color:#eceff4>]</span><span> INFO - Build File: Makefile.toml</span></span>
<span class=giallo-l><span style=color:#eceff4>[</span><span>cargo-make</span><span style=color:#eceff4>]</span><span> INFO - Task: build</span></span>
<span class=giallo-l><span style=color:#eceff4>[</span><span>cargo-make</span><span style=color:#eceff4>]</span><span> INFO - Profile: development</span></span>
<span class=giallo-l><span style=color:#eceff4>[</span><span>cargo-make</span><span style=color:#eceff4>]</span><span> INFO - Running Task: init</span></span>
<span class=giallo-l><span style=color:#eceff4>[</span><span>cargo-make</span><span style=color:#eceff4>]</span><span> INFO - Running Task: build</span></span>
<span class=giallo-l><span style=color:#eceff4>[</span><span>cargo-make</span><span style=color:#eceff4>]</span><span> INFO - Execute Command: </span><span style=color:#eceff4>"</span><span style=color:#a3be8c>cross</span><span style=color:#eceff4>" "</span><span style=color:#a3be8c>build</span><span style=color:#eceff4>" "</span><span style=color:#a3be8c>--target</span><span style=color:#eceff4>" "</span><span style=color:#a3be8c>x86_64-unknown-linux-musl</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#88c0d0>   Compiling</span><span style=color:#a3be8c> r9cc v0.1.0</span><span> (/project)</span></span>
<span class=giallo-l><span style=color:#88c0d0>    Finished</span><span style=color:#a3be8c> dev</span><span> [unoptimized</span><span style=color:#a3be8c> + debuginfo] target</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>s</span><span style=color:#eceff4>)</span><span style=color:#a3be8c> in 11.71s</span></span>
<span class=giallo-l><span style=color:#eceff4>[</span><span>cargo-make</span><span style=color:#eceff4>]</span><span> INFO - Running Task: </span><span style=color:#81a1c1>end</span></span>
<span class=giallo-l><span style=color:#eceff4>[</span><span>cargo-make</span><span style=color:#eceff4>]</span><span> INFO - Build Done in 13 seconds.</span></span>
<span class=giallo-l><span style=color:#eceff4>[</span><span>loc rs/r9cc</span><span style=color:#eceff4>]</span><span> cargo make my_test   </span></span>
<span class=giallo-l><span style=color:#eceff4>[</span><span>cargo-make</span><span style=color:#eceff4>]</span><span> INFO - cargo make 0.25.0</span></span>
<span class=giallo-l><span style=color:#eceff4>[</span><span>cargo-make</span><span style=color:#eceff4>]</span><span> INFO - Project: r9cc</span></span>
<span class=giallo-l><span style=color:#eceff4>[</span><span>cargo-make</span><span style=color:#eceff4>]</span><span> INFO - Build File: Makefile.toml</span></span>
<span class=giallo-l><span style=color:#eceff4>[</span><span>cargo-make</span><span style=color:#eceff4>]</span><span> INFO - Task: my_test</span></span>
<span class=giallo-l><span style=color:#eceff4>[</span><span>cargo-make</span><span style=color:#eceff4>]</span><span> INFO - Profile: development</span></span>
<span class=giallo-l><span style=color:#eceff4>[</span><span>cargo-make</span><span style=color:#eceff4>]</span><span> INFO - Running Task: init</span></span>
<span class=giallo-l><span style=color:#eceff4>[</span><span>cargo-make</span><span style=color:#eceff4>]</span><span> INFO - Running Task: my_test</span></span>
<span class=giallo-l><span style=color:#88c0d0>0</span><span> =</span><span style=color:#81a1c1>></span><span style=color:#b48ead> 0</span></span>
<span class=giallo-l><span style=color:#88c0d0>100</span><span> =</span><span style=color:#81a1c1>></span><span style=color:#b48ead> 100</span></span>
<span class=giallo-l><span style=color:#88c0d0>1+1</span><span> =</span><span style=color:#81a1c1>></span><span style=color:#b48ead> 2</span></span>
<span class=giallo-l><span style=color:#88c0d0>3*(9-2</span><span>) =</span><span style=color:#81a1c1>></span><span> 21</span></span>
<span class=giallo-l><span style=color:#eceff4>(</span><span style=color:#88c0d0>3+3</span><span style=color:#eceff4>)</span><span style=color:#88c0d0>+2*(5-1</span><span>) =</span><span style=color:#81a1c1>></span><span> 14</span></span>
<span class=giallo-l><span style=color:#88c0d0>OK</span></span>
<span class=giallo-l><span style=color:#eceff4>[</span><span>cargo-make</span><span style=color:#eceff4>]</span><span> INFO - Running Task: </span><span style=color:#81a1c1>end</span></span>
<span class=giallo-l><span style=color:#eceff4>[</span><span>cargo-make</span><span style=color:#eceff4>]</span><span> INFO - Build Done in 2 seconds.</span></span></code></pre><h2 id=matome><a aria-label="Anchor link for: matome" class=zola-anchor href=#matome>ã¾ã¨ã‚</a></h2><p>ç’°å¢ƒæ§‹ç¯‰ã‹ã‚‰å››å‰‡æ¼”ç®—ã¾ã§ã‚’è¡Œã„ã¾ã—ãŸã€‚æ¬¡å›ã¯ã‚¹ãƒ†ãƒƒãƒ—6 å˜é …ãƒ—ãƒ©ã‚¹ã¨å˜é …ãƒã‚¤ãƒŠã‚¹ã‹ã‚‰ã‚’äºˆå®šã—ã¦ã„ã¾ã™ã€‚ ã“ã®ã‚ˆã†ãªã™ã°ã‚‰ã—ã„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç„¡æ–™ã§å…¬é–‹ã—ã¦ãã ã•ã£ã¦ã„ã‚‹Rui Ueyamaå…ˆç”Ÿã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚(ãªã‚“ã‚‰ã‹ã®å½¢ã§è²©å£²ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã—ãŸã‚‰å¿…ãšè³¼å…¥ã—ã¾ã™)<h2 id=can-kao><a aria-label="Anchor link for: can-kao" class=zola-anchor href=#can-kao>å‚è€ƒ</a></h2><ul><li>compilerbook ä½ãƒ¬ã‚¤ãƒ¤ã‚’çŸ¥ã‚ŠãŸã„äººã®ãŸã‚ã®Cã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ä½œæˆå…¥é–€ <ul><li>Rui Ueyama<li>https://www.sigbus.info/compilerbook</ul><li>å®Ÿè·µRustå…¥é–€ <ul><li>Îºeen , æ²³é‡ é”ä¹Ÿ , å°æ¾ ç¤¼äºº<li>https://www.amazon.co.jp/dp/B07QVQ7RDG</ul></ul></div></article></main><footer class=blog-footer><p>Â© 2026 <a href=https://blog.ymgyt.io> ymgyt </a> | Made with <a href=https://www.getzola.org rel=noopener target=_blank>Zola</a> | <a href=https://github.com/ymgyt/blog>Repository</a> | <a href=https://blog.ymgyt.io/atom.xml target=_blank title=rss> <svg viewbox="0 0 24 24" class=icon fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx=5 cy=19 r=1></circle></svg> </a></footer></div></div>