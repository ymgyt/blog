<!doctype html><html lang=ja><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1" name=viewport><link href=https://blog.ymgyt.io/favicon.ico rel=icon sizes=any><link href=https://blog.ymgyt.io/icon.svg rel=icon type=image/svg+xml><link href=https://blog.ymgyt.io/apple-touch-icon.png rel=apple-touch-icon><link href=https://blog.ymgyt.io/manifest.webmanifest rel=manifest><link href=https://blog.ymgyt.io/style.css rel=stylesheet><link href=https://blog.ymgyt.io/atom.xml rel=alternate title=Atom type=application/atom+xml><script src="https://www.googletagmanager.com/gtag/js?id=G-GTB0KMLN90" async></script><script>window.dataLayer = window.dataLayer || [];
	function gtag() {dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-GTB0KMLN90');</script><title>ğŸ—¼ tower::Service traitã‚’ç†è§£ã™ã‚‹ | Happy developing</title><meta content=summary name=twitter:card><meta content="@YAmaguchixt " name=twitter:site><meta content="ğŸ—¼ tower::Service traitã‚’ç†è§£ã™ã‚‹" name=twitter:title><meta content=https://blog.ymgyt.io/images/emoji/tokyo_tower.png name=twitter:image><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><body><div class=world><div class=content-container><header class=blog-header-container><div class=blog-logo><a href=https://blog.ymgyt.io>Happy developing</a></div><div class=blog-nav><nav><ul><li><a href=https://blog.ymgyt.io/entry/>Entries</a><li><a href=https://blog.ymgyt.io/tags/>Tags</a><li><a href=https://blog.ymgyt.io/about/>About</a><li><a href=https://github.com/ymgyt> <img alt=Github class=icon src=https://blog.ymgyt.io/images/icon/github.svg> </a><li><a href="https://twitter.com/YAmaguchixt "> <img alt=Twitter class=icon src=https://blog.ymgyt.io/images/icon/twitter.svg> </a></ul></nav></div></header><main class=blog-main><article><header class=entry-header><h1 class=entry-title>ğŸ—¼ tower::Service traitã‚’ç†è§£ã™ã‚‹</h1><div class=entry-meta><p class=entry-meta-item>ğŸ—“ 2022-07-08<p class=entry-meta-item>ğŸ· <span class=tag><a href=https://blog.ymgyt.io/tags/rust/>rust</a></span></div></header><aside class=entry-toc><nav><ul class=entry-toc-toplevel-list><li><a href=https://blog.ymgyt.io/entry/tower_guides/#hanlder-trait>Hanlder trait</a><li><a href=https://blog.ymgyt.io/entry/tower_guides/#handlerwosaranichou-xiang-hua-suru>Handlerã‚’ã•ã‚‰ã«æŠ½è±¡åŒ–ã™ã‚‹</a><li><a href=https://blog.ymgyt.io/entry/tower_guides/#clientce-demotimeoutshi-itai>Clientå´ã§ã‚‚timeoutä½¿ã„ãŸã„</a><li><a href=https://blog.ymgyt.io/entry/tower_guides/#poll-ready>poll_ready</a><li><a href=https://blog.ymgyt.io/entry/tower_guides/#pin-box-dyn-future>Pin&lt;Box&lt;dyn Future&lt;...>>></a><li><a href=https://blog.ymgyt.io/entry/tower_guides/#tower-layermoli-jie-dekiru>tower::Layerã‚‚ç†è§£ã§ãã‚‹</a><li><a href=https://blog.ymgyt.io/entry/tower_guides/#matome>ã¾ã¨ã‚</a></ul></nav></aside><div class=entry-content><p><a href=https://docs.rs/tower/latest/tower/trait.Service.html rel=external><code>tower::Service</code></a> traitã«ã¤ã„ã¦ã®<a href=https://github.com/tower-rs/tower/tree/master/guides rel=external>å…¬å¼ã®Guide</a>ãŒã¨ã¦ã‚‚ãŒã¨ã¦ã‚‚ã‚ã‹ã‚Šã‚„ã™ã‹ã£ãŸã§ã™ã€‚<br> ãã“ã§æœ¬è¨˜äº‹ã§ã¯ã“ã‚Œã‚’è¾¿ã‚ŠãªãŒã‚‰<a href=https://docs.rs/tower/latest/tower/trait.Service.html rel=external><code>tower::Service</code></a>ãŒãªã«ã‚’æŠ½è±¡åŒ–ã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ã‹ã®ç†è§£ã‚’è©¦ã¿ã¾ã™ã€‚(libraryã®APIãŒã©ã†ã—ã¦ä»Šã®signatureã«è‡³ã£ãŸã®ã‹ã‚’ã“ã“ã¾ã§ä¸å¯§ã«ä¸€æ­©ãšã¤è§£èª¬ã—ã¦ãã‚Œã¦ã„ã‚‹ã®ã¯ãªã‹ãªã‹è¦‹ã‚‰ã‚Œãªã„ã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹)<br> versionã¯ç¾æ™‚ç‚¹ã®æœ€æ–°ç‰ˆ(<code>0.4.13</code>)ã‚’å¯¾è±¡ã«ã—ã¦ã„ã¾ã™ã€‚<p><code>axum</code>ã‚„<code>tonic</code>ã‚’å‹•ã‹ã™éš›ã«middlewareã‚’è¿½åŠ ã—ã‚ˆã†ã¨ã™ã‚‹ã¨<a href=https://docs.rs/tower/latest/tower/trait.Layer.html rel=external><code>tower::Layer</code></a>ã‚„<a href=https://docs.rs/tower/latest/tower/trait.Service.html rel=external><code>tower::Service</code></a> traitãŒã§ã¦ãã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚<br> ä¾‹ãˆã°ã€gRPC serverã‚’å®Ÿè¡Œã™ã‚‹ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> trace_layer</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span> tower_http</span><span style=color:#81a1c1>::</span><span>trace</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>TraceLayer</span><span style=color:#eceff4> {</span><span style=color:#88c0d0;font-weight:700> todo!</span><span style=color:#eceff4>() }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>tonic</span><span style=color:#81a1c1>::</span><span>transport</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Server</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>builder</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>    .</span><span style=color:#88c0d0>layer</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>trace_layer</span><span style=color:#eceff4>())</span></span>
<span class=giallo-l><span style=color:#81a1c1>    .</span><span style=color:#88c0d0>add_service</span><span style=color:#eceff4>(</span><span>svc</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>    .</span><span style=color:#88c0d0>serve_with_shutdown</span><span style=color:#eceff4>(</span><span>addr</span><span style=color:#eceff4>,</span><span> shutdown</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>    .await?</span><span style=color:#eceff4>;</span></span></code></pre><p><a href=https://docs.rs/tower/latest/tower/trait.Service.html rel=external><code>tower::Service</code></a>ã‚’ã¿ã¦ã¿ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>pub trait</span><span style=color:#8fbcbb;font-weight:700> Service</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Request</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Response</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Error</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Future</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Future</span></span>
<span class=giallo-l><span style=color:#81a1c1>    where</span></span>
<span class=giallo-l><span style=color:#eceff4>        &lt;</span><span style=color:#81a1c1>Self::</span><span style=color:#8fbcbb>Future</span><span style=color:#81a1c1> as</span><span style=color:#8fbcbb> Future</span><span style=color:#eceff4>></span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Output</span><span style=color:#81a1c1> ==</span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>Self::</span><span style=color:#8fbcbb>Response</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> Self::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> poll_ready</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#81a1c1>        &mut self</span><span style=color:#eceff4>,</span><span> </span></span>
<span class=giallo-l><span>        cx</span><span style=color:#81a1c1>: &mut</span><span style=color:#8fbcbb> Context</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#eceff4>    )</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Poll</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;(),</span><span style=color:#81a1c1> Self::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>>>;</span></span>
<span class=giallo-l><span>    </span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> call</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> req</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Request</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> Self::</span><span style=color:#8fbcbb>Future</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã“ã®traitå®šç¾©ã‚’ç†è§£ã™ã‚‹ã®ãŒç›®æ¨™ã§ã™ğŸ’ª<br> ã¾ãšã€ã„ããªã‚Š<code>Service</code> traitã®è§£èª¬ã«ã¯ã„ã‚‰ãšã€è‡ªåˆ†ã§HTTP frameworkã‚’ä½œã‚‹ã¨ã—ãŸã‚‰ã©ã†ãªã‚‹ã‹ã‚’è€ƒãˆã¦ã„ãã¾ã™ã€‚<br> frameworkã®èµ·å‹•ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#616e88>// Create a server that listens on port 3000</span></span>
<span class=giallo-l><span style=color:#81a1c1>let</span><span> server</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Server</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>127.0.0.1:3000</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>// Somehow run the user's application</span></span>
<span class=giallo-l><span>server</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>run</span><span style=color:#eceff4>(</span><span>the_users_application</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span></code></pre><p>ã“ã“ã§ã€<code>the_users_application</code>ã¯<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> handle_request</span><span style=color:#eceff4>(</span><span>request</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> HttpRequest</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> HttpResponse</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã®ã‚ˆã†ã«ã€ãªã‚‹ã®ãŒã‚‚ã£ã¨ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ãªå½¢ã§ã™ã€‚<br> <code>Server::run</code>ã‚’å®Ÿè£…ã™ã‚‹ã¨<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Server</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    async fn</span><span style=color:#88c0d0> run</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>F</span><span style=color:#eceff4>>(</span><span style=color:#81a1c1>self</span><span style=color:#eceff4>,</span><span> handler</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> F</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;(),</span><span style=color:#8fbcbb> Error</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>    where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        F</span><span style=color:#81a1c1>:</span><span style=color:#88c0d0> Fn</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>HttpRequest</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> HttpResponse</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> listener</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> TcpListener</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>bind</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span>addr</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        loop</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let mut</span><span> connection</span><span style=color:#81a1c1> =</span><span> listener</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>accept</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let</span><span> request</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> read_http_request</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut</span><span> connection</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>            task</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>spawn</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>async move</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>                // Call the handler provided by the user</span></span>
<span class=giallo-l><span style=color:#81a1c1>                let</span><span> response</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> handler</span><span style=color:#eceff4>(</span><span>request</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>                write_http_response</span><span style=color:#eceff4>(</span><span>connection</span><span style=color:#eceff4>,</span><span> response</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>            });</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã®ã‚ˆã†ã«æ›¸ã‘ã¾ã™ã€‚<br> ãƒ¦ãƒ¼ã‚¶ãŒåˆ©ç”¨ã™ã‚‹å ´åˆã¯<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> handle_request</span><span style=color:#eceff4>(</span><span>request</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> HttpRequest</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> HttpResponse</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    if</span><span> request</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>path</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> ==</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>/</span><span style=color:#eceff4>" {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        HttpResponse</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>ok</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Hello, World!</span><span style=color:#eceff4>")</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        HttpResponse</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>not_found</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>// Run the server and handle requests using our `handle_request` function</span></span>
<span class=giallo-l><span>server</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>run</span><span style=color:#eceff4>(</span><span>handle_request</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span></code></pre><p>ã®ã‚ˆã†ã«ã€<code>HttpRequest</code>ã®å‡¦ç†ã«é›†ä¸­ã§ãã¾ã™ã€‚<br> ã—ã‹ã—ã€ç¾åœ¨ã®å®Ÿè£…ã«ã¯ã²ã¨ã¤å•é¡ŒãŒã‚ã‚Šã¾ã™ã€<code>F: Fn(HttpRequest) -> HttpResponse</code>ã ã¨ã€<code>await</code>ãŒclosureã®ä¸­ã«æ›¸ã‘ãªã„ã®ã§ã€å‡¦ç†ã®ä¸­ã§apiã‚„network callã®éš›ã«blockingã—ã¦ã—ã¾ã„ã¾ã™ã€‚(ã—ã‹ã‚‚<code>tokio::spawn</code>ã®ä¸­ã§)<br> ãã“ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ã«<code>Future</code>ã‚’è¿”ã™ã‚ˆã†ã«ä¿®æ­£ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Server</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    async fn</span><span style=color:#88c0d0> run</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>F</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Fut</span><span style=color:#eceff4>>(</span><span style=color:#81a1c1>self</span><span style=color:#eceff4>,</span><span> handler</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> F</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;(),</span><span style=color:#8fbcbb> Error</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>    where</span></span>
<span class=giallo-l><span style=color:#616e88>        // `handler` now returns a generic type `Fut`...</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        F</span><span style=color:#81a1c1>:</span><span style=color:#88c0d0> Fn</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>HttpRequest</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Fut</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#616e88>        // ...which is a `Future` whose `Output` is an `HttpResponse`</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Fut</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Future</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Output</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> HttpResponse</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> listener</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> TcpListener</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>bind</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span>addr</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        loop</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let mut</span><span> connection</span><span style=color:#81a1c1> =</span><span> listener</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>accept</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let</span><span> request</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> read_http_request</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut</span><span> connection</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>            task</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>spawn</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>async move</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>                // Await the future returned by `handler`</span></span>
<span class=giallo-l><span style=color:#81a1c1>                let</span><span> response</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> handler</span><span style=color:#eceff4>(</span><span>request</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>                write_http_response</span><span style=color:#eceff4>(</span><span>connection</span><span style=color:#eceff4>,</span><span> response</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>            });</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã“ã‚Œã§ã€å‡¦ç†ã®ä¸­ã§<code>await</code>ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#616e88>// Now an async function</span></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> handle_request</span><span style=color:#eceff4>(</span><span>request</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> HttpRequest</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> HttpResponse</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    if</span><span> request</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>path</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> ==</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>/</span><span style=color:#eceff4>" {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        HttpResponse</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>ok</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Hello, World!</span><span style=color:#eceff4>")</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span><span style=color:#81a1c1> else if</span><span> request</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>path</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> ==</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>/important-data</span><span style=color:#eceff4>" {</span></span>
<span class=giallo-l><span style=color:#616e88>        // We can now do async stuff in here</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> some_data</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> fetch_data_from_database</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#88c0d0>        make_response</span><span style=color:#eceff4>(</span><span>some_data</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        HttpResponse</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>not_found</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>// Running the server is the same</span></span>
<span class=giallo-l><span>server</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>run</span><span style=color:#eceff4>(</span><span>handle_request</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span></code></pre><p>ãŸã ã€ã“ã®ã¾ã¾ã ã¨ã©ã‚“ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ãƒ¦ãƒ¼ã‚¶ã¯ãªã‚“ã‚‰ã‹ã®HttpResponseã‚’ä½œã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§ã€ã‚¨ãƒ©ãƒ¼ã‚‚è¿”ã›ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚(<code>tower::Service</code>ã«ã‚ˆã›ã‚‹å¸ƒçŸ³)<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Server</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    async fn</span><span style=color:#88c0d0> run</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>F</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Fut</span><span style=color:#eceff4>>(</span><span style=color:#81a1c1>self</span><span style=color:#eceff4>,</span><span> handler</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> F</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;(),</span><span style=color:#8fbcbb> Error</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>    where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        F</span><span style=color:#81a1c1>:</span><span style=color:#88c0d0> Fn</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>HttpRequest</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Fut</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#616e88>        // The response future is now allowed to fail</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Fut</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Future</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Output</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>HttpResponse</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Error</span><span style=color:#eceff4>>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> listener</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> TcpListener</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>bind</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span>addr</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        loop</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let mut</span><span> connection</span><span style=color:#81a1c1> =</span><span> listener</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>accept</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let</span><span> request</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> read_http_request</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut</span><span> connection</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>            task</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>spawn</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>async move</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>                // Pattern match on the result of the response future</span></span>
<span class=giallo-l><span style=color:#81a1c1>                match</span><span style=color:#88c0d0> handler</span><span style=color:#eceff4>(</span><span>request</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                    Ok</span><span style=color:#eceff4>(</span><span>response</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#88c0d0> write_http_response</span><span style=color:#eceff4>(</span><span>connection</span><span style=color:#eceff4>,</span><span> response</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                    Err</span><span style=color:#eceff4>(</span><span>error</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#88c0d0> handle_error_somehow</span><span style=color:#eceff4>(</span><span>error</span><span style=color:#eceff4>,</span><span> connection</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#eceff4>            });</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>Release It!ã«å…¨ã¦ã®network callã«ã¯timeoutãŒè¨­å®šã•ã‚Œã¦ã„ãªã‘ã‚Œã°ãªã‚‰ãªã„ã¨ã‚ã‚Šã¾ã™é€šã‚Šã€å½“ç„¶timeoutãŒè¨­å®šã—ãŸããªã‚Šã¾ã™ã€‚timeoutã¨ã„ãˆã°ã€<code>tokio::time::timeout()</code>ãŒã‚ã‚‹ã®ã§ã€ã“ã‚Œã‚’åˆ©ç”¨ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> handler_with_timeout</span><span style=color:#eceff4>(</span><span>request</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> HttpRequest</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>HttpResponse</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Error</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> result</span><span style=color:#81a1c1> =</span><span> tokio</span><span style=color:#81a1c1>::</span><span>time</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>timeout</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>        Duration</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_secs</span><span style=color:#eceff4>(</span><span style=color:#b48ead>30</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#88c0d0>        handle_request</span><span style=color:#eceff4>(</span><span>request</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    )</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    match</span><span> result</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Ok</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Ok</span><span style=color:#eceff4>(</span><span>response</span><span style=color:#eceff4>))</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>(</span><span>response</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Ok</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Err</span><span style=color:#eceff4>(</span><span>error</span><span style=color:#eceff4>))</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span>error</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Err</span><span style=color:#eceff4>(</span><span>_timeout_elapsed</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Error</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>timeout</span><span style=color:#eceff4>()),</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã•ã‚‰ã«ä»Šå®Ÿè£…ã—ã¦ã„ã‚‹ã®ã¯JSONã‚’è¿”ã™APIãªã®ã§ã€response headerã«<code>Content-Type: application/json</code>ã‚’è¨­å®šã—ãŸããªã‚Šã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> handler_with_timeout_and_content_type</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>    request</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> HttpRequest</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>HttpResponse</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Error</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> response</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> handler_with_timeout</span><span style=color:#eceff4>(</span><span>request</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span>    response</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>set_header</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Content-Type</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>application/json</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Ok</span><span style=color:#eceff4>(</span><span>response</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã“ã‚Œã¾ã§ã§ã€handlerã®å‘¼ã³å‡ºã—ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚<br> <code>handler_with_timeout_and_content_type</code><br> -> <code>handler_with_timeout</code><br> -> <code>handle_request</code><br> ä»Šå¾Œã‚‚æ©Ÿèƒ½ã¯è¿½åŠ ã•ã‚Œã¦ã„ãã“ã¨ãŒäºˆæƒ³ã•ã‚Œã‚‹ã®ã§(auth,body limit, rate limit, trace,CORS,...)ã€å¿…è¦ãªæ©Ÿèƒ½ã‚’<a href=https://en.wikipedia.org/wiki/Function_composition rel=external>compose</a>ã§ãã‚‹ã‚ˆã†ã«ã—ãŸã„ã§ã™ã€‚<br> å…·ä½“çš„ã«ã¯<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>let</span><span> final_handler</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> with_content_type</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>with_timeout</span><span style=color:#eceff4>(</span><span>handle_request</span><span style=color:#eceff4>));</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>server</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>run</span><span style=color:#eceff4>(</span><span>final_handler</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span></code></pre><p>ã¨æ›¸ããŸã„ã‚ã‘ã§ã™ã€‚<br> ãã“ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ãªcodeã‚’æ›¸ã„ã¦ã¿ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> with_timeout</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>F</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb>Fut</span><span style=color:#eceff4>>(</span><span>duration</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Duration</span><span style=color:#eceff4>,</span><span>f</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> F</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> impl</span><span style=color:#88c0d0> Fn</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>HttpRequest</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> impl</span><span style=color:#8fbcbb> Future</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Output</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>HttpResponse</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>>></span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    F</span><span style=color:#81a1c1>:</span><span style=color:#88c0d0> Fn</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>HttpRequest</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Fut</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Fut</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Future</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Output</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>HttpResponse</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Error</span><span style=color:#eceff4>>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span><span style=color:#88c0d0;font-weight:700> todo!</span><span style=color:#eceff4>() }</span></span></code></pre><p>ã“ã®ã‚³ãƒ¼ãƒ‰ã¯ç¾çŠ¶ã®existential typeã®åˆ¶ç´„ã§compileã§ãã¾ã›ã‚“ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>error[E0562]:</span><span style=color:#eceff4> `</span><span style=color:#88c0d0>impl</span><span style=color:#a3be8c> Trait</span><span style=color:#eceff4>`</span><span style=color:#88c0d0> only</span><span style=color:#a3be8c> allowed in function and inherent method return types, not in</span><span style=color:#eceff4> `</span><span style=color:#88c0d0>Fn</span><span style=color:#eceff4>`</span><span style=color:#88c0d0> trait</span><span style=color:#a3be8c> return</span></span>
<span class=giallo-l><span style=color:#88c0d0>  --</span><span>></span><span style=color:#a3be8c> src/main.rs:54:76</span></span>
<span class=giallo-l><span style=color:#81a1c1>   |</span></span>
<span class=giallo-l><span style=color:#88c0d0>54</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> fn</span><span style=color:#a3be8c> with_timeout</span><span style=color:#81a1c1>&lt;</span><span style=color:#a3be8c>F,Fu</span><span>t</span><span style=color:#eceff4>>(</span><span style=color:#88c0d0>duration:</span><span style=color:#a3be8c> Duration,f: F</span><span style=color:#eceff4>)</span><span> -</span><span style=color:#81a1c1>></span><span style=color:#a3be8c> impl Fn</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>HttpRequest</span><span style=color:#eceff4>)</span><span> -</span><span style=color:#81a1c1>></span><span style=color:#a3be8c> impl Future</span><span style=color:#81a1c1>&lt;</span><span style=color:#a3be8c>Output = Result</span><span style=color:#81a1c1>&lt;</span><span style=color:#a3be8c>HttpResponse,Erro</span><span>r</span><span style=color:#81a1c1>>></span></span>
<span class=giallo-l><span style=color:#81a1c1>   |</span><span style=color:#88c0d0>                                                                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span></span></code></pre><p>ã¾ãŸã€ã®ã¡ã«ãµã‚Œã‚‹handlerã‚’å‘¼ã³å‡ºã—ä»¥å¤–ã®æ©Ÿèƒ½ã‚‚è¿½åŠ ã—ã¥ã‚‰ã„ã§ã™ã€‚<br> ãã“ã§ã€<code>Server::run</code>ã‚’closureã§ã†ã‘ã‚‹ã®ã§ã¯ãªãã€traitã§ã†ã‘ã‚‹ã‚ˆã†ã«ã—ã¦ã¿ã¾ã™ã€‚ ã“ã‚Œã¯ä»¥å‰ã«æ›¸ã„ãŸ<a href=https://blog.ymgyt.io/entry/again rel=external>again</a>ã§ã‚‚æ¡ã‚‰ã‚Œã¦ã„ãŸã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§ã™ã­ã€‚(closureã«implã‚’æ›¸ã„ã¦ãŠã‘ã°ãƒ¦ãƒ¼ã‚¶ã¯ä»¥å‰ã¨ã—ã¦closureã‚’æ¸¡ã›ã‚‹ã‚ã‘ã§ã™)<h2 id=hanlder-trait><a aria-label="Anchor link for: hanlder-trait" class=zola-anchor href=#hanlder-trait><code>Hanlder</code> trait</a></h2><p>ã“ã®traitã‚’<code>Handler</code> traitã¨ã—ã¦ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã—ã¦ã¿ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>trait</span><span style=color:#8fbcbb;font-weight:700> Handler</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    async fn</span><span style=color:#88c0d0> call</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> request</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> HttpRequest</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>HttpResponse</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Error</span><span style=color:#eceff4>>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã—ã‹ã—ãªãŒã‚‰ã€Rustã§ã¯ç¾çŠ¶(<code>1.62</code>) async traitã¯ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<br> é¸æŠè‚¢ã¨ã—ã¦ã¯äºŒã¤ã‚ã‚Šã¾ã™ã€‚<ol><li><p><a href=https://crates.io/crates/async-trait rel=external><code>async-trait</code></a>ã‚’åˆ©ç”¨ã—ã¦ã€<code>Pin&lt;Box&lt;dyn Future&lt;Output = Result&lt;HttpResponse, Error>>></code>ã‚’è¿”ã™ã‚ˆã†ã«ã™ã‚‹ã€‚</p><li><p><code>Handler</code> traitã«<code>type Future</code>ã‚’associated typeã¨ã—ã¦è¿½åŠ ã™ã‚‹ã€‚</p></ol><p>ã“ã“ã§ã¯é¸æŠè‚¢2ã‚’æ¡ã‚Šã¾ã™ã€‚concrete future typeã‚’è¿”ã›ã‚‹ãƒ¦ãƒ¼ã‚¶ã¯<code>Box</code>ã®costã‚’ã•ã‘ã‚‹ã“ã¨ãŒã§ãã‚‹ã—ã€<code>Pin&lt;Box&lt;...>></code>ã‚’ä½¿ã„ãŸã‘ã‚Œã°ä½¿ãˆã‚‹ã‹ã‚‰ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>trait</span><span style=color:#8fbcbb;font-weight:700> Handler</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Future</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Future</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Output</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>HttpResponse</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Error</span><span style=color:#eceff4>>>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> call</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> request</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> HttpRequest</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> Self::</span><span style=color:#8fbcbb>Future</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>call</code>ãŒ<code>&mut self</code>ã§ã¯ãªãã€<code>Pin&lt;&mut self></code>ã«ã™ã‚‹ã¹ãã‹ã©ã†ã‹ã«ã¤ã„ã¦ã¯<a href=https://github.com/tower-rs/tower/issues/319 rel=external>è­°è«–</a>ãŒã‚ã‚‹ã‚ˆã†ã§ã™ã€‚<p>handler functionã‚’structã«ã—ã¦ã€<code>Handler</code>ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè£…ã§ãã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> RequestHandler</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Handler</span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> RequestHandler</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>    // We use `Pin&lt;Box&lt;...>>` here for simplicity, but could also define our</span></span>
<span class=giallo-l><span style=color:#616e88>    // own `Future` type to avoid the overhead</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Future</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Pin</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Box</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>dyn</span><span style=color:#8fbcbb> Future</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Output</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>HttpResponse</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Error</span><span style=color:#eceff4>>>>>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> call</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> request</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> HttpRequest</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> Self::</span><span style=color:#8fbcbb>Future</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Box</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>pin</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>async move</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>            // same implementation as we had before</span></span>
<span class=giallo-l><span style=color:#81a1c1>            if</span><span> request</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>path</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> ==</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>/</span><span style=color:#eceff4>" {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Ok</span><span style=color:#eceff4>(</span><span>HttpResponse</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>ok</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Hello, World!</span><span style=color:#eceff4>"))</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span><span style=color:#81a1c1> else if</span><span> request</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>path</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> ==</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>/important-data</span><span style=color:#eceff4>" {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                let</span><span> some_data</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> fetch_data_from_database</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Ok</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>make_response</span><span style=color:#eceff4>(</span><span>some_data</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Ok</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>HttpResponse</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>not_found</span><span style=color:#eceff4>())</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        })</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ä»Šã¾ã§hard codeã—ã¦ã„ãŸtimeoutã¯ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ã‘ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> Timeout</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#616e88>    // T will be some type that implements `Handler`</span></span>
<span class=giallo-l><span>    inner_handler</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> T</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    duration</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Duration</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Handler</span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> Timeout</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>    where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        T</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Handler</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Future</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Pin</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Box</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>dyn</span><span style=color:#8fbcbb> Future</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Output</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>HttpResponse</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Error</span><span style=color:#eceff4>>>>>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> call</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> request</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> HttpRequest</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> Self::</span><span style=color:#8fbcbb>Future</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Box</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>pin</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>async move</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let</span><span> result</span><span style=color:#81a1c1> =</span><span> tokio</span><span style=color:#81a1c1>::</span><span>time</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>timeout</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span>duration</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span>inner_handler</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>call</span><span style=color:#eceff4>(</span><span>request</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>            )</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>            match</span><span> result</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Ok</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Ok</span><span style=color:#eceff4>(</span><span>response</span><span style=color:#eceff4>))</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>(</span><span>response</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Ok</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Err</span><span style=color:#eceff4>(</span><span>error</span><span style=color:#eceff4>))</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span>error</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Err</span><span style=color:#eceff4>(</span><span>_timeout</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Error</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>timeout</span><span style=color:#eceff4>()),</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        })</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ãŸã ã—ã€ã“ã®ã¾ã¾ã ã¨compileãŒé€šã‚Šã¾ã›ã‚“ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>error[E0759]:</span><span style=color:#eceff4> `</span><span style=color:#88c0d0>self</span><span style=color:#eceff4>`</span><span style=color:#88c0d0> has</span><span style=color:#a3be8c> an anonymous lifetime</span><span style=color:#eceff4> `</span><span style=color:#88c0d0>'_` but it needs to satisfy a `'static</span><span style=color:#eceff4>`</span><span style=color:#88c0d0> lifetime</span><span style=color:#a3be8c> requirement</span></span>
<span class=giallo-l><span style=color:#88c0d0>  --</span><span>></span><span style=color:#a3be8c> src/main.rs:84:29</span></span>
<span class=giallo-l><span style=color:#81a1c1>   |</span></span>
<span class=giallo-l><span style=color:#88c0d0>83</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0>       fn</span><span style=color:#a3be8c> call</span><span style=color:#eceff4>(&</span><span style=color:#88c0d0>mut</span><span style=color:#a3be8c> self, request: HttpRequest</span><span style=color:#eceff4>)</span><span> -</span><span style=color:#81a1c1>></span><span style=color:#a3be8c> Self::Future {</span></span>
<span class=giallo-l><span style=color:#81a1c1>   |</span><span style=color:#88c0d0>               ---------</span><span style=color:#a3be8c> this data with an anonymous lifetime</span><span style=color:#eceff4> `</span><span style=color:#88c0d0>'_`...</span></span>
<span class=giallo-l><span style=color:#88c0d0>84 |           Box::pin(async move {</span></span>
<span class=giallo-l><span style=color:#88c0d0>   |  _____________________________^</span></span>
<span class=giallo-l><span style=color:#88c0d0>85 | |             let result = tokio::time::timeout(</span></span>
<span class=giallo-l><span style=color:#88c0d0>86 | |                 self.duration,</span></span>
<span class=giallo-l><span style=color:#88c0d0>87 | |                 self.inner_handler.call(request),</span></span>
<span class=giallo-l><span style=color:#88c0d0>...  |</span></span>
<span class=giallo-l><span style=color:#88c0d0>94 | |             }</span></span>
<span class=giallo-l><span style=color:#88c0d0>95 | |         })</span></span>
<span class=giallo-l><span style=color:#88c0d0>   | |_________^ ...is used and required to live as long as `'static</span><span style=color:#eceff4>`</span><span style=color:#88c0d0> here</span></span></code></pre><p>ãã“ã§ã€<code>&mut self</code>ã‚’<code>self</code>ã«ã™ã‚‹ãŸã‚ã«<code>Clone</code>ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#616e88>// this must be `Clone` for `Timeout&lt;T>` to be `Clone`</span></span>
<span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Clone</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> RequestHandler</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Handler</span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> RequestHandler</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Clone</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> Timeout</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span>    inner_handler</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> T</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    duration</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Duration</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Handler</span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> Timeout</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    T</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Handler</span><span style=color:#81a1c1> +</span><span style=color:#8fbcbb> Clone</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Future</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Pin</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Box</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>dyn</span><span style=color:#8fbcbb> Future</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Output</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>HttpResponse</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Error</span><span style=color:#eceff4>>>>>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> call</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> request</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> HttpRequest</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> Self::</span><span style=color:#8fbcbb>Future</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>        // Get an owned clone of `&mut self`</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> this</span><span style=color:#81a1c1> = self.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        Box</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>pin</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>async move</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let</span><span> result</span><span style=color:#81a1c1> =</span><span> tokio</span><span style=color:#81a1c1>::</span><span>time</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>timeout</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>                this</span><span style=color:#81a1c1>.</span><span>duration</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>                this</span><span style=color:#81a1c1>.</span><span>inner_handler</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>call</span><span style=color:#eceff4>(</span><span>request</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>            )</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>            match</span><span> result</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Ok</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Ok</span><span style=color:#eceff4>(</span><span>response</span><span style=color:#eceff4>))</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>(</span><span>response</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Ok</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Err</span><span style=color:#eceff4>(</span><span>error</span><span style=color:#eceff4>))</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span>error</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Err</span><span style=color:#eceff4>(</span><span>_timeout</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Error</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>timeout</span><span style=color:#eceff4>()),</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        })</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã“ã“ã§ã®cloneã®ã‚³ã‚¹ãƒˆã¯å•é¡Œã«ãªã‚Šã¾ã›ã‚“ã€‚<code>RequestHandler</code>ã¯fieldã‚’ã‚‚ã£ã¦ã„ãªã„ã§ã™ã—ã€<code>Timeout</code>ã®<code>Duration</code>ã¯<code>Copy</code>ã§ã‹ã‚‰ã§ã™ã€‚<br> ã“ã‚Œã§ã‚¨ãƒ©ãƒ¼ã¯æ¬¡ã®ã‚ˆã†ã«ã‹ã‚ã‚Šã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>error[E0310]:</span><span style=color:#a3be8c> the parameter type</span><span style=color:#eceff4> `</span><span style=color:#88c0d0>T</span><span style=color:#eceff4>`</span><span style=color:#88c0d0> may</span><span style=color:#a3be8c> not live long enough</span></span>
<span class=giallo-l><span style=color:#88c0d0>  --</span><span>></span><span style=color:#a3be8c> src/main.rs:86:9</span></span>
<span class=giallo-l><span style=color:#81a1c1>   |</span></span>
<span class=giallo-l><span style=color:#88c0d0>86</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> /</span><span style=color:#a3be8c>         Box::pin</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>async</span><span style=color:#a3be8c> move {</span></span>
<span class=giallo-l><span style=color:#88c0d0>87</span><span style=color:#81a1c1> | |</span><span style=color:#88c0d0>             let</span><span style=color:#a3be8c> result = tokio::time::timeout</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#88c0d0>88</span><span style=color:#81a1c1> | |</span><span style=color:#88c0d0>                 this.duration,</span></span>
<span class=giallo-l><span style=color:#88c0d0>89</span><span style=color:#81a1c1> | |</span><span style=color:#88c0d0>                 this.inner_handler.call(request</span><span style=color:#eceff4>)</span><span style=color:#a3be8c>,</span></span>
<span class=giallo-l><span style=color:#88c0d0>...</span><span style=color:#81a1c1>  |</span></span>
<span class=giallo-l><span style=color:#88c0d0>96</span><span style=color:#81a1c1> | |</span><span>             }</span></span>
<span class=giallo-l><span style=color:#88c0d0>97</span><span style=color:#81a1c1> | |</span><span>         }</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>   | |</span><span style=color:#88c0d0>__________^</span><span style=color:#a3be8c> ...so that the type</span><span style=color:#eceff4> `</span><span style=color:#88c0d0>impl</span><span style=color:#a3be8c> Future</span><span style=color:#81a1c1>&lt;</span><span style=color:#a3be8c>Output = Result</span><span style=color:#81a1c1>&lt;</span><span style=color:#a3be8c>HttpResponse, Error</span><span style=color:#81a1c1>>></span><span style=color:#eceff4>`</span><span style=color:#88c0d0> will</span><span style=color:#a3be8c> meet its required lifetime bounds</span></span>
<span class=giallo-l><span style=color:#81a1c1>   |</span></span>
<span class=giallo-l><span style=color:#88c0d0>help:</span><span style=color:#a3be8c> consider adding an explicit lifetime bound...</span></span>
<span class=giallo-l><span style=color:#81a1c1>   |</span></span>
<span class=giallo-l><span style=color:#88c0d0>80</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0>         T:</span><span style=color:#a3be8c> Handler + Clone +</span><span style=color:#eceff4> '</span><span style=color:#a3be8c>static,</span></span>
<span class=giallo-l><span style=color:#a3be8c>   |                            +++++++++</span></span></code></pre><p><code>T</code>ã¯<code>Vec&lt;&'a str></code>ã®ã‚ˆã†ãªå‚ç…§å‹ã®å ´åˆã‚‚ã‚ã‚‹ã®ã§ã€<code>T</code>ã«ã¯<code>'static'</code>ãŒå¿…è¦ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Handler</span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> Timeout</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>    where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        T</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Handler</span><span style=color:#81a1c1> +</span><span style=color:#8fbcbb> Clone</span><span style=color:#81a1c1> +</span><span style=color:#eceff4> '</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{  }</span></span></code></pre><p>ã¨ã™ã‚‹ã“ã¨ã§compileãŒé€šã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚<br> <code>Content-Type</code>ã‚’è¨­å®šã™ã‚‹handlerã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Clone</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> JsonContentType</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span>    inner_handler</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> T</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Handler</span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> JsonContentType</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    T</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Handler</span><span style=color:#81a1c1> +</span><span style=color:#8fbcbb> Clone</span><span style=color:#81a1c1> +</span><span style=color:#eceff4> '</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Future</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Pin</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Box</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>dyn</span><span style=color:#8fbcbb> Future</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Output</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>HttpResponse</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Error</span><span style=color:#eceff4>>>>>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> call</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> request</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> HttpRequest</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> Self::</span><span style=color:#8fbcbb>Future</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> this</span><span style=color:#81a1c1> = self.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        Box</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>pin</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>async move</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let mut</span><span> response</span><span style=color:#81a1c1> =</span><span> this</span><span style=color:#81a1c1>.</span><span>inner_handler</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>call</span><span style=color:#eceff4>(</span><span>request</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span>            response</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>set_header</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Content-Type</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>application/json</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Ok</span><span style=color:#eceff4>(</span><span>response</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>        })</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>handlerã«<code>new()</code>ã‚’å®Ÿè£…ã—ã¦ãŠãã¨ã€<code>Server::run</code>ã¯ã“ã®ã‚ˆã†ã«ã‹ã‘ã¾ã™<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Server</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    async fn</span><span style=color:#88c0d0> run</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>>(</span><span style=color:#81a1c1>self</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> mut</span><span> handler</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> T</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;(),</span><span style=color:#8fbcbb> Error</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>        where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            T</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Handler</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    {}</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>let</span><span> handler</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> RequestHandler</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>let</span><span> handler</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Timeout</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>handler</span><span style=color:#eceff4>,</span><span> Duration</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_secs</span><span style=color:#eceff4>(</span><span style=color:#b48ead>30</span><span style=color:#eceff4>));</span></span>
<span class=giallo-l><span style=color:#81a1c1>let</span><span> handler</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> JsonContentType</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>handler</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>// `handler` has type `JsonContentType&lt;Timeout&lt;RequestHandler>>`</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>server</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>run</span><span style=color:#eceff4>(</span><span>handler</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await</span></span></code></pre><h2 id=handlerwosaranichou-xiang-hua-suru><a aria-label="Anchor link for: handlerwosaranichou-xiang-hua-suru" class=zola-anchor href=#handlerwosaranichou-xiang-hua-suru><code>Handler</code>ã‚’ã•ã‚‰ã«æŠ½è±¡åŒ–ã™ã‚‹</a></h2><p>ä»Šã®ã¨ã“ã‚ã€<code>Hanlder</code>ã¯<code>HttpRequest</code>ã¨<code>HttpResponse</code>ã‚’ã‚ã¤ã‹ã£ã¦ã„ã¾ã—ãŸãŒã€<code>HttpRequest</code>ã«ä¾å­˜ã™ã‚‹ã¨ã“ã‚ã¯ã€response headerã®è¨­å®šã®ã¿ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒ<code>GrpcRequest</code>ã§ã‚‚æ©Ÿèƒ½ã—ãã†ã§ã™ã€‚ãã“ã§ã€<code>Handler</code> traitã‹ã‚‰ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’æŠ½è±¡åŒ–ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>trait</span><span style=color:#8fbcbb;font-weight:700> Handler</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Request</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Response</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    // Error should also be an associated type. No reason for that to be a</span></span>
<span class=giallo-l><span style=color:#616e88>    // hardcoded type</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Error</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    // Our future type from before, but now it's output must use</span></span>
<span class=giallo-l><span style=color:#616e88>    // the associated `Response` and `Error` types</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Future</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Future</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Output</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>Self::</span><span style=color:#8fbcbb>Response</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> Self::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>>>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    // `call` is unchanged, but note that `Request` here is our generic</span></span>
<span class=giallo-l><span style=color:#616e88>    // `Request` type parameter and not the `HttpRequest` type we've used</span></span>
<span class=giallo-l><span style=color:#616e88>    // until now</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> call</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> request</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Request</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> Self::</span><span style=color:#8fbcbb>Future</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>Request</code>ã«å¯¾ã—ã¦ã¯genericã§ã™ãŒã€<code>Response</code>ã¯associated typeã«ãªã£ã¦ã„ã¾ã™ã€‚<br> ã“ã‚Œã¯<code>Handler&lt;HttpRequest,GrpcResponse></code>ã¨ã„ã†å‹ãŒæ„å‘³ã‚’ãªã•ãšã€requestã«å¯¾ã—ã¦ã¯responseã®å‹ãŒ1:1ã§æ±ºã¾ã‚‹ã“ã¨ã‚’å‹ãŒã‚ã‚‰ã‚ã—ã¦ã„ã‚‹ã¨èª­ã‚ã¾ã™ã€‚<br> ã•ãã»ã©ã®<code>RequestHandler</code>ã®å®Ÿè£…ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰ã‚ã‚Šã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Handler</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>HttpRequest</span><span style=color:#eceff4>></span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> RequestHandler</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Response</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> HttpResponse</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Error</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Error</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Future</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Pin</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Box</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>dyn</span><span style=color:#8fbcbb> Future</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Output</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>HttpResponse</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Error</span><span style=color:#eceff4>>>>>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> call</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> request</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Request</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> Self::</span><span style=color:#8fbcbb>Future</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>        // same as before</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>Timeout&lt;T></code>ã¯ã©ã†ã§ã—ã‚‡ã†ã‹ã€‚timeoutå‡¦ç†ã¯http protocolã«ä¾å­˜ã—ã¦ã„ãªã„ã®ã§ã€<code>Request</code>ã«å¯¾ã—ã¦genericãªå®Ÿè£…ãŒã§ãã¾ã™ã€‚ãŸã ã—ã€Errorã«ã¤ã„ã¦ã¯ã€<code>tokio::time::error::Elapsed</code>ãŒç™ºç”Ÿã™ã‚‹ã®ã§ã€ãƒ¦ãƒ¼ã‚¶ã®ã‚¨ãƒ©ãƒ¼å‹ã«ã“ã‚Œã®å¤‰æ›ã‚’è¦æ±‚ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#616e88>// `Timeout` accepts any request of type `R` as long as `T`</span></span>
<span class=giallo-l><span style=color:#616e88>// accepts the same type of request</span></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>R</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> T</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Handler</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>R</span><span style=color:#eceff4>></span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> Timeout</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#616e88>    // The actual type of request must not contain</span></span>
<span class=giallo-l><span style=color:#616e88>    // references. The compiler would tell us to add</span></span>
<span class=giallo-l><span style=color:#616e88>    // this if we didn't</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    R</span><span style=color:#81a1c1>:</span><span style=color:#eceff4> '</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#616e88>    // `T` must accept requests of type `R`</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    T</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Handler</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>R</span><span style=color:#eceff4>></span><span style=color:#81a1c1> +</span><span style=color:#8fbcbb> Clone</span><span style=color:#81a1c1> +</span><span style=color:#eceff4> '</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#616e88>    // We must be able to convert an `Elapsed` into</span></span>
<span class=giallo-l><span style=color:#616e88>    // `T`'s error type</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    T</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Error</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> From</span><span style=color:#eceff4>&lt;</span><span>tokio</span><span style=color:#81a1c1>::</span><span>time</span><span style=color:#81a1c1>::</span><span>error</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Elapsed</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#616e88>    // Our response type is the same as `T`'s, since we</span></span>
<span class=giallo-l><span style=color:#616e88>    // don't have to modify it</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Response</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> T</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Response</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    // Error type is also the same</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Error</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> T</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    // Future must output a `Result` with the correct types</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Future</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Pin</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Box</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>dyn</span><span style=color:#8fbcbb> Future</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Output</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Response</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> T</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>>>>>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> call</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> request</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> R</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> Self::</span><span style=color:#8fbcbb>Future</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> this</span><span style=color:#81a1c1> = self.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        Box</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>pin</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>async move</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let</span><span> result</span><span style=color:#81a1c1> =</span><span> tokio</span><span style=color:#81a1c1>::</span><span>time</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>timeout</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>                this</span><span style=color:#81a1c1>.</span><span>duration</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>                this</span><span style=color:#81a1c1>.</span><span>inner_handler</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>call</span><span style=color:#eceff4>(</span><span>request</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>            )</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>            match</span><span> result</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Ok</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Ok</span><span style=color:#eceff4>(</span><span>response</span><span style=color:#eceff4>))</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>(</span><span>response</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Ok</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Err</span><span style=color:#eceff4>(</span><span>error</span><span style=color:#eceff4>))</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span>error</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Err</span><span style=color:#eceff4>(</span><span>elapsed</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>                    // Convert the error</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                    Err</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>T</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Error</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from</span><span style=color:#eceff4>(</span><span>elapsed</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        })</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>JsonContentType</code>ã¯<code>Response</code>ã«åˆ¶ç´„ã‚’èª²ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#616e88>// Again a generic request type</span></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>R</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> T</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Handler</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>R</span><span style=color:#eceff4>></span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> JsonContentType</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    R</span><span style=color:#81a1c1>:</span><span style=color:#eceff4> '</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#616e88>    // `T` must accept requests of any type `R` and return</span></span>
<span class=giallo-l><span style=color:#616e88>    // responses of type `HttpResponse`</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    T</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Handler</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>R</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Response</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> HttpResponse</span><span style=color:#eceff4>></span><span style=color:#81a1c1> +</span><span style=color:#8fbcbb> Clone</span><span style=color:#81a1c1> +</span><span style=color:#eceff4> '</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Response</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> HttpResponse</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    // Our error type is whatever `T`'s error type is</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Error</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> T</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Future</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Pin</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Box</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>dyn</span><span style=color:#8fbcbb> Future</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Output</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Response</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> T</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>>>>>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> call</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> request</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> R</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> Self::</span><span style=color:#8fbcbb>Future</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> this</span><span style=color:#81a1c1> = self.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        Box</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>pin</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>async move</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let mut</span><span> response</span><span style=color:#81a1c1> =</span><span> this</span><span style=color:#81a1c1>.</span><span>inner_handler</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>call</span><span style=color:#eceff4>(</span><span>request</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span>            response</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>set_header</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Content-Type</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>application/json</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Ok</span><span style=color:#eceff4>(</span><span>response</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>        })</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>æ–°ã—ã„<code>Handler</code> traitã§ã‚‚<code>Server::run</code>ã¯åŒæ§˜ã«æ©Ÿèƒ½ã—ã¾ã™!<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Server</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    async fn</span><span style=color:#88c0d0> run</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>>(</span><span style=color:#81a1c1>self</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> mut</span><span> handler</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> T</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;(),</span><span style=color:#8fbcbb> Error</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>    where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        T</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Handler</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>HttpRequest</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Response</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> HttpResponse</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    {</span></span>
<span class=giallo-l><span style=color:#616e88>        // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>let</span><span> handler</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> RequestHandler</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>let</span><span> handler</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Timeout</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>handler</span><span style=color:#eceff4>,</span><span> Duration</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_secs</span><span style=color:#eceff4>(</span><span style=color:#b48ead>30</span><span style=color:#eceff4>));</span></span>
<span class=giallo-l><span style=color:#81a1c1>let</span><span> handler</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> JsonContentType</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>handler</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>server</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>run</span><span style=color:#eceff4>(</span><span>handler</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await</span></span></code></pre><h2 id=clientce-demotimeoutshi-itai><a aria-label="Anchor link for: clientce-demotimeoutshi-itai" class=zola-anchor href=#clientce-demotimeoutshi-itai>Clientå´ã§ã‚‚timeoutä½¿ã„ãŸã„</a></h2><p>ã“ã‚Œã¾ã§ã®ã¨ã“ã‚ã€<code>Handler</code>ã¯ãªã‚“ã‚‰ã‹ã®protocolã®requestã‚’å‡¦ç†ã—ã¦responseã‚’è¿”ã™æ©Ÿèƒ½ã‚’æŠ½è±¡åŒ–ã—ãŸã‚‚ã®ã¨ã„ãˆã¾ã™ã€‚ ã€€ ã¾ãŸã€<code>JsonContentType</code>ã¯å°‚ã‚‰serverå´ã§å¿…è¦ãªæ©Ÿèƒ½ã§ã™ãŒã€<code>Timeout</code>ã¯protocolã®clientå´ã§ã‚‚åˆ©ç”¨ã—ãŸã„æ©Ÿèƒ½ã§ã™ã€‚ãã“ã§<code>Handler</code>ã‚’client/serverã®å´é¢ã‹ã‚‰ã‚‚ã•ã‚‰ã«æŠ½è±¡åŒ–ã•ã›ã¦ã¿ã¾ã™ã€‚<br> requestã‚’é€ã‚‹å´ã®clientã‹ã‚‰ã¿ã‚‹ã¨ã€<code>Handler</code>ã¯å°‘ã€…ãƒŸã‚¹ãƒªãƒ¼ãƒ‰ãªåå‰ã§ã™ã€‚(handleã™ã‚‹ã®ã¯server)<br> ãã“ã§ã€<code>Hanlder</code>ã‚’<code>Service</code>ã«æ”¹åã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>trait</span><span style=color:#8fbcbb;font-weight:700> Service</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Request</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Response</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Error</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Future</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Future</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Output</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>Self::</span><span style=color:#8fbcbb>Response</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> Self::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>>>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> call</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> request</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Request</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> Self::</span><span style=color:#8fbcbb>Future</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã“ã‚Œã¯<a href=https://docs.rs/tower/latest/tower/trait.Service.html rel=external><code>tower::Service</code></a>ã®å®šç¾©ã¨ã»ã¨ã‚“ã©åŒã˜ã§ã™ã€‚(<code>poll_ready</code>ä»¥å¤–)ã€‚<br> ã•ãã»ã©ã¿ãŸ<code>Timeout</code>ä»¥å¤–ã«ã‚‚ã€towerã§ã¯<a href=https://docs.rs/tower/latest/tower/retry/index.html rel=external><code>Retry</code></a>ã‚„<a href=https://docs.rs/tower/latest/tower/limit/rate/index.html rel=external><code>RateLimit</code></a>ãŒæä¾›ã•ã‚Œã¦ã„ã¾ã™ã€‚<p>ã¨ã„ã†ã‚ã‘ã§ã€<a href=https://docs.rs/tower/latest/tower/trait.Service.html rel=external><code>tower::Service</code></a> traitãŒã©ã†ã—ã¦ã“ã®ã‚ˆã†ãªAPIã«ãªã£ã¦ã„ã‚‹ã®ã‹ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚<br> <code>Fn(HttpRequest) -> HttpResponse</code>ã®closureã‹ã‚‰å§‹ã¾ã£ã¦ã€asyncå¯¾å¿œã€protocol,client/serverã‚’æŠ½è±¡åŒ–ã—ãŸçµæœã“ã®ã‚ˆã†ãªå‹ã«ãªã£ãŸã‚“ã§ã™ã­ã€‚<h2 id=poll-ready><a aria-label="Anchor link for: poll-ready" class=zola-anchor href=#poll-ready><code>poll_ready</code></a></h2><p><a href=https://docs.rs/tower/latest/tower/trait.Service.html rel=external><code>tower::Service</code></a> traitã‚’ç†è§£ã—ãŸã¨ã„ã„ãŸã„ã¨ã“ã‚ã§ã™ãŒã€ã¾ã <code>poll_ready</code>ã«ã¤ã„ã¦ã¯è§¦ã‚Œã¦ã„ã¾ã›ã‚“ã§ã—ãŸã€‚<br> ã“ã‚ŒãŒã©ã†ã—ã¦å¿…è¦ãªã®ã‹ã‚‚æ°—ã«ãªã‚‹æ‰€ã§ã™ãŒã€guideã¯å½“ç„¶èª¬æ˜ã—ã¦ãã‚Œã¦ã„ã¾ã™!<br> ã•ã£ããè¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚<p>ã¾ãšã€<code>poll_ready</code>ãŒå¿…è¦ã«ãªã‚‹motivationã‚’ç†è§£ã™ã‚‹ãŸã‚ã«ã€<code>ConcurrencyLimit</code>ã‚’å®Ÿè£…ã—ãŸããªã£ãŸã¨ã—ã¾ã™ã€‚<br> ã„ãã‚‰<code>tokio::spawn</code>ãŒè»½é‡ã ã‹ã‚‰ã¨ã„ã£ã¦ã€ç„¡åˆ¶é™ã«åˆ©ç”¨ã—ã¦ã„ã‚Œã°ã€Podã®ãƒªã‚½ãƒ¼ã‚¹åˆ¶é™ã‚„ã€backend(AWS ratelimit, db connection)ç­‰ã‚’ä½¿ã„æœãŸã—ã¦ã—ã¾ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>R</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> T</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Service</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>R</span><span style=color:#eceff4>></span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> ConcurrencyLimit</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> call</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> request</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> R</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> Self::</span><span style=color:#8fbcbb>Future</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>        // 1. Check a counter for the number of requests currently being</span></span>
<span class=giallo-l><span style=color:#616e88>        //    processed.</span></span>
<span class=giallo-l><span style=color:#616e88>        // 2. If there is capacity left send the request to `T`</span></span>
<span class=giallo-l><span style=color:#616e88>        //    and increment the counter.</span></span>
<span class=giallo-l><span style=color:#616e88>        // 3. If not somehow wait until capacity becomes available.</span></span>
<span class=giallo-l><span style=color:#616e88>        // 4. When the response has been produced, decrement the counter.</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>ConcurrencyLimit</code>ã®ä¸Šé™ã«é”ã—ãŸå ´åˆã§ã‚‚ã€<code>call</code>ã•ã‚Œç¶šã‘ã‚‹ã¨requestã‚’ãƒ¡ãƒ¢ãƒªã«ä¿æŒã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚<br> ãã“ã§ã€serviceã®å‘¼ã³å‡ºã—ã¨ã€å‡¦ç†ã®ãŸã‚ã®resourceç¢ºä¿ã‚’åˆ¥ã®ã‚‚ã®ã¨ã¨ã‚‰ãˆã¦ã€<code>Service</code> traitã«ä»¥ä¸‹ã®methodã‚’è¿½åŠ ã—ã¦ã¿ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>trait</span><span style=color:#8fbcbb;font-weight:700> Service</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>R</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    async fn</span><span style=color:#88c0d0> ready</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>Service</code>ã®å‘¼ã³å‡ºã—å´ã¯ã€<code>call</code>ã™ã‚‹å‰ã«<code>ready</code>ã‚’å‘¼ã¶ã‚ˆã†ã«ã—ã¾ã™ã€‚<br> ãŸã ã—ã€<code>call</code>åŒæ§˜ã«async traitã¯æ›¸ã‘ãªã„ã®ã§ã€associated typeãŒå¿…è¦ã§ã™ãŒã€ãã†ã™ã‚‹ã¨lifetimeé–¢é€£ã«å¯¾å‡¦ã—ãªã„ã¨ã„ã‘ãªããªã‚Šã¾ã™ã€‚ãã“ã§ã€<code>Future</code> traitã‚’å‚è€ƒã«ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>task</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>Context</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Poll</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>trait</span><span style=color:#8fbcbb;font-weight:700> Service</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>R</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> poll_ready</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> cx</span><span style=color:#81a1c1>: &mut</span><span style=color:#8fbcbb> Context</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Poll</span><span style=color:#eceff4>&lt;()>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>Poll::Ready(())</code>ãŒcapacityã®ç¢ºä¿ã‚’ã‚ã‚‰ã‚ã—ã€<code>Poll::Pending</code>ãŒcapacityãŒç¢ºä¿ã§ãã¦ã„ãªã„ã“ã¨ã‚’è¡¨ç¾ã—ã¾ã™ã€‚<br> å‹ã¨ã—ã¦ã¯ã€<code>call</code>ã‚’å‘¼ã¶å‰ã«<code>poll_ready</code>ãŒã‚ˆã°ã‚Œã‚‹ä¿è¨¼ã¯ãªã„ã§ã™ãŒã€ã“ã‚Œã¯API contractã¨ã—ã¾ã™ã€‚(ã—ãŸãŒã£ã¦ã€Serviceã¯readyã§ãªã„å ´åˆã«callã•ã‚ŒãŸã¨ãpanicã™ã‚‹ã“ã¨ãŒè¨±ã•ã‚Œã¾ã™)<br> ã¾ãŸã€<a href=https://docs.rs/tower/0.4.7/tower/trait.ServiceExt.html#method.ready rel=external><code>tower::ServiceExt</code></a>ã‚’åˆ©ç”¨ã™ã‚Œã°<code>ready</code>ã‚’asyncã«ã‚‚ã§ãã¾ã™ã€‚<p>ã“ã®ã‚ˆã†ãªå‘¼ã³å‡ºã—å´ã¨å‘¼ã³å‡ºã•ã‚Œå´ãŒcapacityã«ã¤ã„ã¦é€£æºã™ã‚‹ã“ã¨ã‚’"backpressure propagation"ã¨ã„ã†ãã†ã§ã™ã€‚<br> backpressureã«ã¤ã„ã¦ã®å‚è€ƒã¨ã—ã¦ä»¥ä¸‹ãŒã‚ã’ã‚‰ã‚Œã¦ã„ã¾ã—ãŸã€‚<ul><li><a href=https://medium.com/@jayphelps/backpressure-explained-the-flow-of-data-through-software-2350b3e77ce7 rel=external>Backpressure explained â€” the resisted flow of data through software</a><li><a href=https://aws.amazon.com/builders-library/using-load-shedding-to-avoid-overload/ rel=external>Using load shedding to avoid overload</a></ul><p>ã“ã†ã—ã¦ã¤ã„ã«<a href=https://docs.rs/tower/latest/tower/trait.Service.html rel=external><code>tower::Service</code></a> traitã®å®šç¾©ã«ãŸã©ã‚Šç€ãã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>pub trait</span><span style=color:#8fbcbb;font-weight:700> Service</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Request</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Response</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Error</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Future</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Future</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Output</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>Self::</span><span style=color:#8fbcbb>Response</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> Self::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>>>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> poll_ready</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#81a1c1>        &mut self</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        cx</span><span style=color:#81a1c1>: &mut</span><span style=color:#8fbcbb> Context</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    )</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Poll</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;(),</span><span style=color:#81a1c1> Self::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>>>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> call</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> req</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Request</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> Self::</span><span style=color:#8fbcbb>Future</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>å¤šãã®Serviceã¯è‡ªå‰ã§ã¯capacityç®¡ç†ã‚’ã›ãšã«ã€ãŸã‚“ã«innerã®<code>poll_ready</code>ã«delegateã—ã¾ã™ã€‚<br> <code>poll_ready</code>ã®asyncç‰ˆã§ã‚ã‚‹<code>ready</code>ã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã«ã€<code>ServiceExt</code>ã‚’useã™ã‚‹ã¨serviceã®callã¯ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ã‘ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> tower</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Service</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#616e88>    // for the `ready` method</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    ServiceExt</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>};</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>let</span><span> response</span><span style=color:#81a1c1> =</span><span> service</span></span>
<span class=giallo-l><span style=color:#616e88>    // wait for the service to have capacity</span></span>
<span class=giallo-l><span style=color:#81a1c1>    .</span><span style=color:#88c0d0>ready</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await?</span></span>
<span class=giallo-l><span style=color:#616e88>    // send the request</span></span>
<span class=giallo-l><span style=color:#81a1c1>    .</span><span style=color:#88c0d0>call</span><span style=color:#eceff4>(</span><span>request</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span></code></pre><h2 id=pin-box-dyn-future><a aria-label="Anchor link for: pin-box-dyn-future" class=zola-anchor href=#pin-box-dyn-future><code>Pin&lt;Box&lt;dyn Future&lt;...>>></code></a></h2><p>ã“ã“ã§çµ‚ã‚ã‚‰ãªã„ã®ãŒæœ¬guideã®ç´ æ™´ã‚‰ã—ã„ã¨ã“ã‚ã§ã™ã€‚<br> ã•ãã»ã©ã¾ã§ã®<code>Service</code>ã®å®Ÿè£…ã§ã¯ã€associated typeã®Futureã«<code>Pin&lt;Box&lt;dyn Future&lt;...>>></code>ãŒåˆ©ç”¨ã•ã‚Œã¦ã„ã¾ã™ãŒã€<code>tower</code>ã®å®Ÿè£…ãŒã“ã®costã‚’è¨±å®¹ã™ã‚‹ã¯ãšã‚ã‚Šã¾ã›ã‚“ã€‚ã¨ã„ã†ã‚ã‘ã§ä»¥é™ã§ã¯ã€å®Ÿéš›ã®<a href=https://docs.rs/tower/latest/tower/timeout/struct.Timeout.html rel=external><code>tower::time::Timeout</code></a> middlewareã®å®Ÿè£…ã‚’ã¿ã¦ã„ãã¾ã™ã€‚<p>ã¾ãšã¯<code>Timeout</code> structã‚’å®šç¾©ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>time</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Duration</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Clone</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Debug</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> Timeout</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span>    inner</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> T</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    timeout</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Duration</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4> &lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Timeout</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> new</span><span style=color:#eceff4>(</span><span>inner</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>,</span><span> timeout</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Duration</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Timeout</span><span style=color:#eceff4> {</span><span> inner</span><span style=color:#eceff4>,</span><span> timeout</span><span style=color:#eceff4> }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>Service::call</code>ã«<code>&mut self</code>ã‚’<code>async move</code>ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã«ã€<code>self</code>ã«å¤‰æ›ã—ãŸã„ã®ã§ã€<code>Clone</code>ã‚’è¦æ±‚ã—ã¾ã™ã€‚<p>æ¬¡ã«<code>Service</code>ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚ã¾ãšã¯ãªã«ã‚‚ã›ãšã€å˜ã«innerã«delegateã™ã‚‹ã ã‘ã®å®Ÿè£…ã‚’ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> tower</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Service</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>task</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>Context</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Poll</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Request</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Service</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Request</span><span style=color:#eceff4>></span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> Timeout</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    S</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Service</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Request</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Response</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> S</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Response</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Error</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> S</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Future</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> S</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Future</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> poll_ready</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> cx</span><span style=color:#81a1c1>: &mut</span><span style=color:#8fbcbb> Context</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Poll</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;(),</span><span style=color:#81a1c1> Self::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>inner</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>poll_ready</span><span style=color:#eceff4>(</span><span>cx</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> call</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> request</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Request</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> Self::</span><span style=color:#8fbcbb>Future</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>inner</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>call</span><span style=color:#eceff4>(</span><span>request</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>æ¬¡ã«ã€<code>self.duration</code>ä»¥å†…ã«innerãŒReadyã‚’è¿”ã•ãªã„å ´åˆã«ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™Futureã‚’ã‹ãˆã—ãŸã„ã®ã§ã™ãŒã©ã†ã™ã‚Œã°ã„ã„ã§ã—ã‚‡ã†ã‹ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> call</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> request</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Request</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> Self::</span><span style=color:#8fbcbb>Future</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> response_future</span><span style=color:#81a1c1> = self.</span><span>inner</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>call</span><span style=color:#eceff4>(</span><span>request</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> sleep</span><span style=color:#81a1c1> =</span><span> tokio</span><span style=color:#81a1c1>::</span><span>time</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>sleep</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span>timeout</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span>        </span></span>
<span class=giallo-l><span style=color:#616e88>        // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span></code></pre><p>ã“ã“ã§ã€<code>Pin&lt;Box&lt;dyn Future&lt;...>>></code>ã¯é¿ã‘ãŸã„ã§ã™ã€‚å¤šãã®nestã—ãŸmiddlewareãã‚Œãã‚ŒãŒallocationã‚’ç™ºç”Ÿã•ã›ã‚‹ã“ã¨ã«ã‚ˆã‚‹performanceã¸ã®å½±éŸ¿ã‚’é¿ã‘ãŸã„ã‹ã‚‰ã§ã™ã€‚<br> ã¨ã„ã†ã‚ã‘ã§è‡ªå‰ã®<code>Future</code>ã‚’å®Ÿè£…ã—ãŸ<code>ResponseFuture</code>ã‚’å®šç¾©ã—ã¦ã¿ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> tokio</span><span style=color:#81a1c1>::</span><span>time</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Sleep</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> ResponseFuture</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>F</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span>    response_future</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> F</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    sleep</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Sleep</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Request</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Service</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Request</span><span style=color:#eceff4>></span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> Timeout</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    S</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Service</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Request</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Response</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> S</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Response</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Error</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> S</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#616e88>    // Use our new `ResponseFuture` type.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Future</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> ResponseFuture</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Future</span><span style=color:#eceff4>>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> poll_ready</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> cx</span><span style=color:#81a1c1>: &mut</span><span style=color:#8fbcbb> Context</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Poll</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;(),</span><span style=color:#81a1c1> Self::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>inner</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>poll_ready</span><span style=color:#eceff4>(</span><span>cx</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> call</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> request</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Request</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> Self::</span><span style=color:#8fbcbb>Future</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> response_future</span><span style=color:#81a1c1> = self.</span><span>inner</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>call</span><span style=color:#eceff4>(</span><span>request</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> sleep</span><span style=color:#81a1c1> =</span><span> tokio</span><span style=color:#81a1c1>::</span><span>time</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>sleep</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span>timeout</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span>        </span></span>
<span class=giallo-l><span style=color:#8fbcbb>        ResponseFuture</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            response_future</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            sleep</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>associated typeã®<code>Future</code>ã«è‡ªå‰ã®<code>ResponseFuture</code>ã‚’è¿”ã™ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚<br> æ¬¡ã«<code>ResponseFuture</code>ã«<code>Future</code>ã‚’å®Ÿè£…ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> tokio</span><span style=color:#81a1c1>::</span><span>time</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Sleep</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> pin_project</span><span style=color:#81a1c1>::</span><span>pin_project</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[pin_project]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> ResponseFuture</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>F</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#5e81ac>    #[pin]</span></span>
<span class=giallo-l><span>    response_future</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> F</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#5e81ac>    #[pin]</span></span>
<span class=giallo-l><span>    sleep</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Sleep</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span>pin</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Pin</span><span style=color:#eceff4>,</span><span> future</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Future</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>F</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Response</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Error</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Future</span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> ResponseFuture</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>F</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    F</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Future</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Output</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Response</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Error</span><span style=color:#eceff4>>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Output</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Response</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Error</span><span style=color:#eceff4>>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> poll</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self:</span><span style=color:#8fbcbb> Pin</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>&mut Self</span><span style=color:#eceff4>>,</span><span> cx</span><span style=color:#81a1c1>: &mut</span><span style=color:#8fbcbb> Context</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Poll</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>Self::</span><span style=color:#8fbcbb>Output</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#616e88>        // Call the magical `project` method generated by `#[pin_project]`.</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> this</span><span style=color:#81a1c1> = self.</span><span style=color:#88c0d0>project</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>        // `project` returns a `__ResponseFutureProjection` but we can ignore</span></span>
<span class=giallo-l><span style=color:#616e88>        // the exact type. It has fields that matches `ResponseFuture` but</span></span>
<span class=giallo-l><span style=color:#616e88>        // maintain pins for fields annotated with `#[pin]`.</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>        // `this.response_future` is now a `Pin&lt;&mut F>`.</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> response_future</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Pin</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>&mut</span><span style=color:#8fbcbb> F</span><span style=color:#eceff4>></span><span style=color:#81a1c1> =</span><span> this</span><span style=color:#81a1c1>.</span><span>response_future</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>        // And `this.sleep` is a `Pin&lt;&mut Sleep>`.</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> sleep</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Pin</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>&mut</span><span style=color:#8fbcbb> Sleep</span><span style=color:#eceff4>></span><span style=color:#81a1c1> =</span><span> this</span><span style=color:#81a1c1>.</span><span>sleep</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        match</span><span> response_future</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>poll</span><span style=color:#eceff4>(</span><span>cx</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Poll</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Ready</span><span style=color:#eceff4>(</span><span>result</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> => return</span><span style=color:#8fbcbb> Poll</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Ready</span><span style=color:#eceff4>(</span><span>result</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Poll</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Pending</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {}</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        match</span><span> sleep</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>poll</span><span style=color:#eceff4>(</span><span>cx</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Poll</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Ready</span><span style=color:#eceff4>(())</span><span style=color:#81a1c1> =></span><span style=color:#88c0d0;font-weight:700> todo!</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Poll</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Pending</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {}</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        Poll</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Pending</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>self.response_future</code>ã‚’pollã™ã‚‹ãŸã‚ã«ã€pin_projectã‚’åˆ©ç”¨ã—ã¦ã€<code>Pin&lt;&mut Self></code>ã‹ã‚‰<code>Pin&lt;&mut F></code>ã®å¤‰æ›ã‚’è¡Œã„ã¾ã™ã€‚<p>æ¬¡ã«å•é¡Œã«ãªã‚‹ã®ãŒã€timeout durationãŒçµŒéã—ãŸéš›ã«è¿”ã™errorã®å‹ã§ã™ã€‚é¸æŠè‚¢ã¨ã—ã¦ã¯ä»¥ä¸‹ã®3ã¤ãŒè€ƒãˆã‚‰ã‚Œã¾ã™ã€‚<ol><li><code>Box&lt;dyn std::error::Error + Send + Sync></code>ã®ã‚ˆã†ãªboxed error trait objectã‚’è¿”ã™<li>service errorã¨timeout errorã‚’variantsã«ã‚‚ã¤enumã‚’è¿”ã™<li><code>TimeoutError</code>ã‚’å®šç¾©ã—ã¦ã€<code>TimeoutError: Into&lt;Error></code>ã®ã‚ˆã†ãªåˆ¶ç´„ã‚’èª²ã—ã¦ãƒ¦ãƒ¼ã‚¶ã«å¤‰æ›ã®å®šç¾©ã‚’è¦æ±‚ã™ã‚‹</ol><p>é¸æŠè‚¢3ãŒã‚‚ã£ã¨ã‚‚flexibleã§ã™ãŒã€middlewareãŒå¢—ãˆã¦ãã‚‹ã¨ãƒ¦ãƒ¼ã‚¶ã¯ã™ã¹ã¦ã®ã‚¨ãƒ©ãƒ¼ã«ãŸã„ã—ã¦å¤‰æ›ã‚’æ›¸ãå¿…è¦ãŒã§ã¦ãã¦ã—ã¾ã„ã¾ã™ã€‚<br> é¸æŠè‚¢2ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªenumã‚’å®šç¾©ã™ã‚‹ã‚‚ã®ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>enum</span><span style=color:#8fbcbb> TimeoutError</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#88c0d0>    Timeout</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>InnerTimeoutError</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#88c0d0>    Service</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>å‹ã®æƒ…å ±ã‚’å¤±ã‚ãªã„ç‚¹ã§é­…åŠ›çš„ã§ã™ãŒã€ä»¥ä¸‹ã®æ¬ ç‚¹ãŒã‚ã‚Šã¾ã™ã€‚<ol><li>å®Ÿç”¨çš„ã«ã¯ã€middlewareã¯nestã™ã‚‹ã®ã§ã€<code>BufferError&lt;RateLimitError&lt;TimeoutError&lt;MyError>>></code>ã®ã‚ˆã†ãªå‹ã«å¯¾ã—ã¦pattern matchingã‚’æ›¸ãå¿…è¦ãŒã§ã¦ãã‚‹ã€‚(ä¾‹ãˆã°retry-ableã‹ã©ã†ã‹ã®åˆ¤å®šã®éš›)<li>middlewareã®é©ç”¨ã®é †ç•ªã‚’å¤‰ãˆã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã®å‹ã‚‚å¤‰ã‚ã‚‹ã®ã§pattern matchã®ç®‡æ‰€ã‚‚è¿½å¾“ã•ã›ã‚‹å¿…è¦ãŒã‚ã‚‹<li>æœ€çµ‚çš„ãªã‚¨ãƒ©ãƒ¼ã®å‹ãŒéå¸¸ã«å¤§ãããªã‚Šã€stackã‚’å¤§ããå æœ‰ã—ã¦ã—ã¾ã†ã‹ã‚‚ã—ã‚Œãªã„</ol><p>é¸æŠè‚¢1ã¯inner serviceã®ã‚¨ãƒ©ãƒ¼ã‚’<code>Box&lt;dyn std::error::Error + Send + Sync></code>ã«å¤‰æ›ã™ã‚‹ã‚‚ã®ã§ã€è¤‡æ•°ã®ã‚¨ãƒ©ãƒ¼å‹ãŒä¸€ã¤ã®ã‚¨ãƒ©ãƒ¼å‹ã«å¤‰æ›ã•ã‚Œã‚‹ã“ã¨ã«ãªã‚‹ã€‚<br> ã“ã‚Œã«ã¯ä»¥ä¸‹ã®ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã¾ã™ã€‚<ol><li>middlewareã®é©ç”¨é †åºãŒã‹ã‚ã£ã¦ã‚‚å½±éŸ¿ã‚’ã†ã‘ãªã„(less fragile)<li>middlewareã®é©ç”¨æ•°ã«é–¢ã‚ã‚‰ãšã‚¨ãƒ©ãƒ¼å‹ã¯ä¸€å®šã®sizeã«ãªã‚‹<li>å·¨å¤§ãªmatchã§ã¯ãªãã€<code>error.downcast_ref::&lt;Timeout>()</code>ã‚’åˆ©ç”¨ã—ã¦errorã®æƒ…å ±ã‚’å–å¾—ã™ã‚‹ã“ã¨ã«ãªã‚‹</ol><p>ãƒ‡ãƒ¡ãƒªãƒƒãƒˆã¯<ol><li>dynamic downcastingã‚’åˆ©ç”¨ã™ã‚‹ã®ã§ã€compilerãŒã™ã¹ã¦ã®èµ·ãã†ã‚‹errorãŒæ•æ‰ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ç¢ºã‹ã‚ã‚‰ã‚Œãªã„<li>erroræ™‚ã«allocationãŒç™ºç”Ÿã™ã‚‹ã€‚ãŸã ã—ã€errorã¯infrequentã¨è€ƒãˆã‚‰ã‚Œã‚‹ã®ã§è¨±å®¹ã§ãã‚‹ã€‚</ol><p>towerã§ã¯é¸æŠè‚¢1ãŒæ¡ç”¨ã•ã‚Œã¾ã—ãŸã€‚å…ƒã®è­°è«–ã¯<a href=https://github.com/tower-rs/tower/issues/131 rel=external>ã“ã¡ã‚‰</a><p>æœ€çµ‚çš„ãª<code>Timeout</code> middlewareã®å®Ÿè£…ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚<br> å®Ÿéš›ã®towerã®codeã¯<a href=https://github.com/tower-rs/tower/blob/master/tower/src/timeout/mod.rs rel=external>ã“ã¡ã‚‰</a><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>fmt</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>fmt</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Formatter</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>task</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>Context</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Poll</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>time</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Duration</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span>future</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Future</span><span style=color:#eceff4>,</span><span> pin</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Pin</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> pin_project</span><span style=color:#81a1c1>::</span><span>pin_project</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> tokio</span><span style=color:#81a1c1>::</span><span>time</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Sleep</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> tower</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Service</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Clone</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Debug</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> Timeout</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span>    inner</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> T</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    timeout</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Duration</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Timeout</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> new</span><span style=color:#eceff4>(</span><span>inner</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>,</span><span> timeout</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Duration</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Timeout</span><span style=color:#eceff4> {</span><span> inner</span><span style=color:#eceff4>,</span><span> timeout</span><span style=color:#eceff4> }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Request</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Service</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Request</span><span style=color:#eceff4>></span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> Timeout</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>    where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        S</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Service</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Request</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        S</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Error</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Into</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>BoxError</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Response</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> S</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Response</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Error</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> BoxError</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Future</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> ResponseFuture</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Future</span><span style=color:#eceff4>>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> poll_ready</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> cx</span><span style=color:#81a1c1>: &mut</span><span style=color:#8fbcbb> Context</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Poll</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;(),</span><span style=color:#81a1c1> Self::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>inner</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>poll_ready</span><span style=color:#eceff4>(</span><span>cx</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>map_err</span><span style=color:#eceff4>(</span><span>Into</span><span style=color:#81a1c1>::</span><span>into</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> call</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> request</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Request</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> Self::</span><span style=color:#8fbcbb>Future</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> response_future</span><span style=color:#81a1c1> = self.</span><span>inner</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>call</span><span style=color:#eceff4>(</span><span>request</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> sleep</span><span style=color:#81a1c1> =</span><span> tokio</span><span style=color:#81a1c1>::</span><span>time</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>sleep</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span>timeout</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        ResponseFuture</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            response_future</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            sleep</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[pin_project]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> ResponseFuture</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>F</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#5e81ac>    #[pin]</span></span>
<span class=giallo-l><span>    response_future</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> F</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#5e81ac>    #[pin]</span></span>
<span class=giallo-l><span>    sleep</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Sleep</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>F</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Response</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Error</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Future</span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> ResponseFuture</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>F</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>    where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        F</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Future</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Output</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Response</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Error</span><span style=color:#eceff4>>>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Error</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Into</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>BoxError</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Output</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Response</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> BoxError</span><span style=color:#eceff4>>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> poll</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self:</span><span style=color:#8fbcbb> Pin</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>&mut Self</span><span style=color:#eceff4>>,</span><span> cx</span><span style=color:#81a1c1>: &mut</span><span style=color:#8fbcbb> Context</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Poll</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>Self::</span><span style=color:#8fbcbb>Output</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> this</span><span style=color:#81a1c1> = self.</span><span style=color:#88c0d0>project</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>        match</span><span> this</span><span style=color:#81a1c1>.</span><span>response_future</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>poll</span><span style=color:#eceff4>(</span><span>cx</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Poll</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Ready</span><span style=color:#eceff4>(</span><span>result</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                let</span><span> result</span><span style=color:#81a1c1> =</span><span> result</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>map_err</span><span style=color:#eceff4>(</span><span>Into</span><span style=color:#81a1c1>::</span><span>into</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>                return</span><span style=color:#8fbcbb> Poll</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Ready</span><span style=color:#eceff4>(</span><span>result</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Poll</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Pending</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {}</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        match</span><span> this</span><span style=color:#81a1c1>.</span><span>sleep</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>poll</span><span style=color:#eceff4>(</span><span>cx</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Poll</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Ready</span><span style=color:#eceff4>(())</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                let</span><span> error</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Box</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>TimeoutError</span><span style=color:#eceff4>(()));</span></span>
<span class=giallo-l><span style=color:#81a1c1>                return</span><span style=color:#8fbcbb> Poll</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Ready</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Err</span><span style=color:#eceff4>(</span><span>error</span><span style=color:#eceff4>));</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Poll</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Pending</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {}</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        Poll</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Pending</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Debug</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Default</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> TimeoutError</span><span style=color:#eceff4>(());</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span> fmt</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Display</span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> TimeoutError</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> fmt</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> f</span><span style=color:#81a1c1>: &mut</span><span style=color:#8fbcbb> Formatter</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>)</span><span style=color:#81a1c1> -></span><span> fmt</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>        f</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>pad</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>request time out</span><span style=color:#eceff4>")</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span> std</span><span style=color:#81a1c1>::</span><span>error</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Error</span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> TimeoutError</span><span style=color:#eceff4> {}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>pub type</span><span style=color:#8fbcbb> BoxError</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Box</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>dyn</span><span> std</span><span style=color:#81a1c1>::</span><span>error</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Error</span><span style=color:#81a1c1> +</span><span style=color:#8fbcbb> Send</span><span style=color:#81a1c1> +</span><span style=color:#8fbcbb> Sync</span><span style=color:#eceff4>>;</span></span></code></pre><p>ã¨ã„ã†ã‚ã‘ã§ã¤ã„ã«å®Ÿéš›ã®<code>Timeout</code>ã®å®Ÿè£…ã«ãŸã©ã‚Šç€ãã¾ã—ãŸã€‚<h2 id=tower-layermoli-jie-dekiru><a aria-label="Anchor link for: tower-layermoli-jie-dekiru" class=zola-anchor href=#tower-layermoli-jie-dekiru><code>tower::Layer</code>ã‚‚ç†è§£ã§ãã‚‹</a></h2><p><a href=https://docs.rs/tower/latest/tower/trait.Service.html rel=external><code>tower::Service</code></a>ãŒç†è§£ã§ããŸã®ã§ã€<a href=https://docs.rs/tower/latest/tower/trait.Layer.html rel=external><code>tower::Layer</code></a>ãŒã©ã†ã„ã†å½¹å‰²ãªã®ã‹ã‚‚ã™ãã«ã‚ã‹ã‚Šã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>pub trait</span><span style=color:#8fbcbb;font-weight:700> Layer</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Service</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> layer</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> inner</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> Self::</span><span style=color:#8fbcbb>Service</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>Layer</code>ã¯ã“ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚ã¾ãš<code>Layer</code>ã¨<code>Service</code>ã¯1:1ã®é–¢ä¿‚ã§ã€ä¸Šè¨˜ã®<code>Timeout</code> serviceã«ãŸã„ã—ã¦<code>TimeoutLayer</code>ãŒã‚ã‚Šã¾ã™ã€‚<br> ãã®ã“ã¨ãŒassociated typeã®<code>Service</code>ã«ç¾ã‚Œã¦ã„ã¾ã™ã€‚genericsã®<code>S</code>ã¯<code>Layer</code>ãŒå¯¾å¿œã™ã‚‹<code>Service</code>ã®innerã®serviceã§ã™ã€‚<br> <code>TimeoutLayer</code>ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#616e88>/// Applies a timeout to requests via the supplied inner service.</span></span>
<span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Debug</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Clone</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> TimeoutLayer</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    timeout</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Duration</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> TimeoutLayer</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>    /// Create a timeout from a duration</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> new</span><span style=color:#eceff4>(</span><span>timeout</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Duration</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        TimeoutLayer</span><span style=color:#eceff4> {</span><span> timeout</span><span style=color:#eceff4> }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Layer</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>></span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> TimeoutLayer</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Service</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Timeout</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> layer</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> service</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> Self::</span><span style=color:#8fbcbb>Service</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Timeout</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>service</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> self.</span><span>timeout</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>Layer</code>ã¯<code>Service</code>ã®delegateå…ˆã®Serviceã‚’ã‚‚ã‚‰ã£ã¦ã€å¯¾å¿œã™ã‚‹<code>Service</code>ã‚’ä½œæˆã™ã‚‹è²¬å‹™ã‚’ã‚‚ã¤ã®ã§ã€ãã®fieldã«ã¯<code>Service</code>ã‚’ä½œã‚‹ãŸã‚ã®æƒ…å ±ãŒå¿…è¦ã§ã™ã€‚<br> <code>TimeoutLayer</code>ã®å ´åˆã¯ã€timeoutã®<code>Duration</code>ã‚’ä¿æŒã—ã¦ã„ã¾ã™ã€‚<h2 id=matome><a aria-label="Anchor link for: matome" class=zola-anchor href=#matome>ã¾ã¨ã‚</a></h2><p>åˆè¦‹ã§ã¯ã€Genericsã‚„associated typeã«åœ§å€’ã•ã‚Œã¦ã—ã¾ã£ã¦ã„ã¾ã—ãŸãŒã€GuideãŒä¸€æ­©ãšã¤ä¸å¯§ã«è§£èª¬ã—ã¦ãã‚Œã¦ã„ã‚‹ãŠã‹ã’ã§ã€tower ecosystemã®ç†è§£ãŒä¸€æ­©æ·±ã¾ã‚Šã¾ã—ãŸã€‚<br> axumã‚„tonicã¨ã„ã£ãŸhttp/gRPC protocolã®é•ã„ã«é–¢ã‚ã‚‰ãšåŒã˜middlewareãŒä½¿ãˆã‚‹ã®ã¯éå¸¸ã«ã‚ã‚ŠãŒãŸã„ã®ã§ã€towerã®ecosystemã‚’ä½¿ã„ã“ãªã›ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ããŸã„ã§ã™ã€‚</div></article></main><footer class=blog-footer><p>Â© 2026 <a href=https://blog.ymgyt.io> ymgyt </a> | Made with <a href=https://www.getzola.org rel=noopener target=_blank>Zola</a> | <a href=https://github.com/ymgyt/blog>Repository</a> | <a href=https://blog.ymgyt.io/atom.xml target=_blank title=rss> <svg viewbox="0 0 24 24" class=icon fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx=5 cy=19 r=1></circle></svg> </a></footer></div></div>