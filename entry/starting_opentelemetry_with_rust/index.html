<!doctype html><html lang=ja><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1" name=viewport><link href=https://blog.ymgyt.io/favicon.ico rel=icon sizes=any><link href=https://blog.ymgyt.io/icon.svg rel=icon type=image/svg+xml><link href=https://blog.ymgyt.io/apple-touch-icon.png rel=apple-touch-icon><link href=https://blog.ymgyt.io/manifest.webmanifest rel=manifest><link href=https://blog.ymgyt.io/style.css rel=stylesheet><link href=https://blog.ymgyt.io/atom.xml rel=alternate title=Atom type=application/atom+xml><script src="https://www.googletagmanager.com/gtag/js?id=G-GTB0KMLN90" async></script><script>window.dataLayer = window.dataLayer || [];
	function gtag() {dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-GTB0KMLN90');</script><title>ğŸ”­ Rustã§OpenTelemetryã‚’ã¯ã˜ã‚ã‚ˆã† | Happy developing</title><meta content=Rustã§ã¯ã˜ã‚ã‚‹OpenTelemetry name=description><meta content=summary name=twitter:card><meta content="@YAmaguchixt " name=twitter:site><meta content="ğŸ”­ Rustã§OpenTelemetryã‚’ã¯ã˜ã‚ã‚ˆã†" name=twitter:title><meta content=Rustã§ã¯ã˜ã‚ã‚‹OpenTelemetry name=twitter:description><meta content=https://blog.ymgyt.io/images/emoji/telescope.png name=twitter:image><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><body><div class=world><div class=content-container><header class=blog-header-container><div class=blog-logo><a href=https://blog.ymgyt.io>Happy developing</a></div><div class=blog-nav><nav><ul><li><a href=https://blog.ymgyt.io/entry/>Entries</a><li><a href=https://blog.ymgyt.io/tags/>Tags</a><li><a href=https://blog.ymgyt.io/about/>About</a><li><a href=https://github.com/ymgyt> <img alt=Github class=icon src=https://blog.ymgyt.io/images/icon/github.svg> </a><li><a href="https://twitter.com/YAmaguchixt "> <img alt=Twitter class=icon src=https://blog.ymgyt.io/images/icon/twitter.svg> </a></ul></nav></div></header><main class=blog-main><article><header class=entry-header><h1 class=entry-title>ğŸ”­ Rustã§OpenTelemetryã‚’ã¯ã˜ã‚ã‚ˆã†</h1><div class=entry-meta><p class=entry-meta-item>ğŸ—“ 2022-12-18<p class=entry-meta-item>ğŸ· <span class=tag><a href=https://blog.ymgyt.io/tags/rust/>rust</a></span> <span class=tag><a href=https://blog.ymgyt.io/tags/opentelemetry/>opentelemetry</a></span></div></header><aside class=entry-toc><nav><ul class=entry-toc-toplevel-list><li><a href=https://blog.ymgyt.io/entry/starting_opentelemetry_with_rust/#opentelemetrytoha>OpenTelemetryã¨ã¯</a><li><a href=https://blog.ymgyt.io/entry/starting_opentelemetry_with_rust/#opentelemetrynoqian-ti>OpenTelemetryã®å‰æ</a> <ul><li><a href=https://blog.ymgyt.io/entry/starting_opentelemetry_with_rust/#somosomoobservabilitytoha>ãã‚‚ãã‚‚Observabilityã¨ã¯</a><li><a href=https://blog.ymgyt.io/entry/starting_opentelemetry_with_rust/#telemetry>Telemetry</a><li><a href=https://blog.ymgyt.io/entry/starting_opentelemetry_with_rust/#metrics>Metrics</a><li><a href=https://blog.ymgyt.io/entry/starting_opentelemetry_with_rust/#distributed-tracing>Distributed Tracing</a></ul><li><a href=https://blog.ymgyt.io/entry/starting_opentelemetry_with_rust/#opentelemetrynogou-cheng-yao-su>OpenTelemetryã®æ§‹æˆè¦ç´ </a> <ul><li><a href=https://blog.ymgyt.io/entry/starting_opentelemetry_with_rust/#specification>Specification</a><li><a href=https://blog.ymgyt.io/entry/starting_opentelemetry_with_rust/#collector>Collector</a></ul><li><a href=https://blog.ymgyt.io/entry/starting_opentelemetry_with_rust/#signals-categories-of-telemetry>Signals (Categories of telemetry)</a> <ul><li><a href=https://blog.ymgyt.io/entry/starting_opentelemetry_with_rust/#traces>Traces</a><li><a href=https://blog.ymgyt.io/entry/starting_opentelemetry_with_rust/#logs>Logs</a><li><a href=https://blog.ymgyt.io/entry/starting_opentelemetry_with_rust/#baggage>Baggage</a></ul><li><a href=https://blog.ymgyt.io/entry/starting_opentelemetry_with_rust/#rustdeopentelemetrywodong-kasu>Rustã§opentelemetryã‚’å‹•ã‹ã™</a> <ul><li><a href=https://blog.ymgyt.io/entry/starting_opentelemetry_with_rust/#tracing-opentelemetry>tracing-opentelemetry</a><li><a href=https://blog.ymgyt.io/entry/starting_opentelemetry_with_rust/#opentelemetry-collector>opentelemetry-collector</a><li><a href=https://blog.ymgyt.io/entry/starting_opentelemetry_with_rust/#backend>backend</a></ul><li><a href=https://blog.ymgyt.io/entry/starting_opentelemetry_with_rust/#matome>ã¾ã¨ã‚</a></ul></nav></aside><div class=entry-content><p>æœ¬è¨˜äº‹ã§ã¯Rustã§Opentelemetryã‚’ã¯ã˜ã‚ã‚‹ã“ã¨ã‚’ç›®æ¨™ã«ä»¥ä¸‹ã®ç‚¹ã«ã¤ã„ã¦æ›¸ãã¾ã™ã€‚<ul><li>OpenTelemetryã®æ¦‚è¦<li>Rustã®applicationã«OpenTelemetryã‚’å°å…¥ã™ã‚‹æ–¹æ³•</ul><p>å‰åŠã¯<a href=https://opentelemetry.io/docs/ rel=external>å…¬å¼doc</a>ã‚’èª­ã¿ãªãŒã‚‰ç™»å ´äººç‰©ã‚’æ•´ç†ã—ã€å¾ŒåŠã¯å®Ÿéš›ã«docker-composeä¸Šã§ãã‚Œã‚‰ã‚’å‹•ã‹ã—ã¾ã™ã€‚<br> ã¾ãŸRustã§ã¯<a href=https://github.com/tokio-rs/tracing/tree/master/tracing-opentelemetry rel=external>tracing-opentelemetry</a> crateã‚’åˆ©ç”¨ã—ã¾ã™ã€‚<br> tracingã«ã¤ã„ã¦ã¯<a href=https://blog.ymgyt.io/entry/how-tracing-and-tracing-subscriber-write-events/ rel=external>åˆ¥ã®è¨˜äº‹</a>ã§åŸºæœ¬çš„ãªä»•çµ„ã¿ã«ã¤ã„ã¦æ›¸ã„ãŸã®ã§opentelemetryå›ºæœ‰ã®å‡¦ç†ã«ã¤ã„ã¦è¿°ã¹ã¾ã™ã€‚<br> <a href=https://github.com/ymgyt/opentelemetry-handson rel=external>sample code</a><p>traceã®è¨­å®šã«ã¤ã„ã¦ã¯ã€<a href=https://blog.ymgyt.io/entry/understanding-opentelemetry-tracer-configuration-from-specifications/ rel=external>åˆ¥ã®è¨˜äº‹</a>ã«è©³ã—ã„èª¬æ˜ã‚’æ›¸ãã¾ã—ãŸã€‚<h2 id=opentelemetrytoha><a aria-label="Anchor link for: opentelemetrytoha" class=zola-anchor href=#opentelemetrytoha>OpenTelemetryã¨ã¯</a></h2><p>æœ€åˆã«OpenTelemetryã«ã¤ã„ã¦ã®ç¾æ™‚ç‚¹ã§ã®è‡ªåˆ†ã®ç†è§£ã¯ä»¥ä¸‹ã§ã™ã€‚<ul><li>OpenTelemetryã¨ã¯æ–‡è„ˆã«ã‚ˆã‚Šä»¥ä¸‹ã®ã„ãšã‚Œã‹ã‚’æŒ‡ã™ <ul><li>CNFNã®project <ul><li>2019å¹´ã«èª•ç”Ÿã—ãŸOpenTracingã¨OpenCensusãŒmergeã•ã‚Œã¦2019å¹´ã«èª•ç”Ÿã—ãŸCNCF incubating project.</ul><li>APIã‚„data formatã«é–¢ã™ã‚‹ä»•æ§˜ã®ã“ã¨</ul><li>OpenTelemetry projectã®ç›®æ¨™ã¯ã‚·ã‚¹ãƒ†ãƒ ã‚’observableã«ã™ã‚‹ã“ã¨ã€‚observableã¨ã¯å•é¡Œèª¿æŸ»ã®éš›ã«å¿…è¦ãªæƒ…å ±ãŒå…¨ã¦å–å¾—ã§ãã¦ã„ã‚‹çŠ¶æ…‹<li>OpenTelemetry projectã¯applicationãŒsignal(traces, metrics, logs)ã‚’å‡ºåŠ›ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ä»•çµ„ã¿ã‚’æ¨™æº–åŒ–ã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ <ul><li>Vendor-agnosticãªSDK,API, toolsã‚’æä¾›ã—ã¦ã„ã‚‹ã®ã§vendorã«ä¾å­˜ã™ã‚‹ã“ã¨ãªãobservabilityã‚’å‘ä¸Šã•ã›ã‚‹å®Ÿè£…ãŒã§ãã‚‹<li>Jaegerã€Prometheus, Datadog, Elasticsearchã¨ã„ã£ãŸobservability backendã§ã¯ãªã„</ul></ul><p>ã„ããªã‚Šã“ã‚Œã ã‘è¨€ã‚ã‚Œã¦ã‚‚ãƒ”ãƒ³ã¨ã“ãªã„ã¨æ€ã†ã®ã§ä»¥ä¸‹ã§ã¯å…·ä½“çš„ã«æ˜ã‚Šä¸‹ã’ã¦ã„ãã¾ã™ã€‚<h2 id=opentelemetrynoqian-ti><a aria-label="Anchor link for: opentelemetrynoqian-ti" class=zola-anchor href=#opentelemetrynoqian-ti>OpenTelemetryã®å‰æ</a></h2><p>OpenTelemetryã‚’å­¦ã‚“ã§ã„ãå‰ã«å‰æçŸ¥è­˜ã‚’ç¢ºèªã—ã¾ã™ã€‚<h3 id=somosomoobservabilitytoha><a aria-label="Anchor link for: somosomoobservabilitytoha" class=zola-anchor href=#somosomoobservabilitytoha>ãã‚‚ãã‚‚Observabilityã¨ã¯</a></h3><p>https://opentelemetry.io/docs/concepts/observability-primer/#what-is-observability<p>Observabilityã¨ã¯ã€ã‚·ã‚¹ãƒ†ãƒ ã®å†…éƒ¨ã‚’çŸ¥ã‚‹ã“ã¨ãªãã‚·ã‚¹ãƒ†ãƒ ã«ã¤ã„ã¦ç†è§£ã§ãã‚‹ã“ã¨ã€‚ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒˆã‚„æ–°ã—ã„å•é¡Œ("unknown unknowns")ãŒèµ·ããŸéš›ã«ãªã«ãŒèµ·ãã¦ã„ã‚‹ã‹ãŒã‚ã‹ã‚‹ã“ã¨ã€‚<p>ã‚·ã‚¹ãƒ†ãƒ ã‚’èª¿æŸ»ã™ã‚‹ã«ã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒé©åˆ‡ã«instrumentedã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚instrumentedã•ã‚Œã¦ã„ã‚‹ã¨ã¯ã€ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒsignals(traces, metrics, logsç­‰)ã‚’ç™ºã—ã¦ã„ã‚‹ã“ã¨ã€‚é©åˆ‡ã«instrumentedã•ã‚Œã¦ã„ã‚‹ã¨ãã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«è¿½åŠ ã®å¤‰æ›´ã‚’åŠ ãˆã‚‹ã“ã¨ãªãå•é¡Œã®èª¿æŸ»ãŒå¯èƒ½ã«ãªã‚‹ã€‚ãªãœãªã‚‰ã€å¿…è¦ãªæƒ…å ±ã¯å…¨ã¦åé›†ã•ã‚Œã¦ã„ã‚‹ã‹ã‚‰ã€‚<br> OpenTelemetryã¨ã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’instrumentedã«ã™ã‚‹ãŸã‚ã®ä»•çµ„ã¿ã€‚<p>Instrumentedã¯Rustã«å¼•ãã¤ã‘ã¦ã„ã†ã¨ã€application/libraryã®å„å‡¦ç†ã«<code>info!()</code>ã‚„<code>info_span!()</code>,<code>#[instrument]</code>ç­‰ãŒæ›¸ã‹ã‚Œã¦ã„ã‚‹ã¨ã„ã†ã“ã¨ã§ã™ã€‚<h3 id=telemetry><a aria-label="Anchor link for: telemetry" class=zola-anchor href=#telemetry>Telemetry</a></h3><p>ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰å‡ºåŠ›ã•ã‚Œã‚‹ãã®æŒ™å‹•ã«é–¢ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã€‚trace, metrics, logsç­‰ã€‚<h3 id=metrics><a aria-label="Anchor link for: metrics" class=zola-anchor href=#metrics>Metrics</a></h3><p>applicationã‚„infrastructureã«é–¢ã™ã‚‹numeric dataã‚’ä¸€å®šæœŸé–“ã«æ¸¡ã£ã¦é›†ç´„ã—ãŸã‚‚ã®ã€‚error rate, CPUä½¿ç”¨ç‡ç­‰ã€‚<h3 id=distributed-tracing><a aria-label="Anchor link for: distributed-tracing" class=zola-anchor href=#distributed-tracing>Distributed Tracing</a></h3><p>Distributed tracingã‚’ç†è§£ã™ã‚‹ã«ã¯ã¾ãšã€logsã¨spansã‹ã‚‰è¦‹ã¦ã„ãã¾ã™ã€‚<br> Logã¯timestampãŒä»˜ä¸ã•ã‚ŒãŸã‚·ã‚¹ãƒ†ãƒ ã®componentã‹ã‚‰å‡ºåŠ›ã•ã‚Œã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€‚Logã¯contextualãªæƒ…å ±ãŒä»˜ä¸ã•ã‚Œã‚‹ã“ã¨ã§çœŸä¾¡ã‚’ç™ºæ®ã—ã¾ã™ã€‚<p>Spanã¯unit of work(operation)ã‚’è¡¨ã—ãŸã‚‚ã®ã§å…¸å‹çš„ãªã®ã¯1 http requestã®å‡¦ç†ã€‚<br> Spanã¯name, time-related data, structured log message, attributesç­‰ã®metadataã‚’å«ã¿ã€operationã«é–¢ã™ã‚‹æƒ…å ±ã‚’æä¾›ã—ã¾ã™ã€‚<br> Attributesã®å…·ä½“ä¾‹ã¨ã—ã¦ã¯ã€<code>net.peer.ip=10.244.0.1</code>,<code>http.route=/cart</code>ç­‰ã€…ã€‚<p>Distributed Traceã¯applicationã‚„end-userã‹ã‚‰ã®requestãŒé€šéã™ã‚‹microserviceã‚„serverless applicationå®Ÿè¡ŒçµŒè·¯ã‚’è¨˜éŒ²ã—ã¾ã™ã€‚ Distributed systemã«ãŠã„ã¦ã€tracingãªã—ã§ã¯ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä¸Šã®å•é¡Œã®åŸå› ã‚’ç‰¹å®šã™ã‚‹ã®ã¯å®¹æ˜“ã§ã¯ãªã ã¾ãŸã€localã§å†ç¾ã•ã›ã‚‹ã“ã¨ãŒé›£ã—ã„å•é¡ŒãŒç™ºç”Ÿã™ã‚‹ã®ã§tracingã¯ä¸å¯æ¬ ã¨ã•ã‚Œã¦ã„ã¾ã™ã€‚<p>Traceã¯ä¸€ã¤ä»¥ä¸Šã®spanã‹ã‚‰æ§‹æˆã•ã‚Œã¦ãŠã‚Šã€æœ€åˆã®spanã‚’root spanã¨è¨€ã„ã¾ã™ã€‚<br> Root spanã¯requestå…¨ä½“ã‚’è¡¨ã—ã¦ãŠã‚Šã€å­spanã¯ãã‚Œãã‚Œã®å‡¦ç†ã®è©³ç´°ã‚’è¡¨ã—ã¦ã„ã¾ã™ã€‚<figure><div class=fig-images-row><img , alt src=images/otel_span.png></div><figcaption>spanã®å…·ä½“ä¾‹</figcaption></figure><h2 id=opentelemetrynogou-cheng-yao-su><a aria-label="Anchor link for: opentelemetrynogou-cheng-yao-su" class=zola-anchor href=#opentelemetrynogou-cheng-yao-su><a href=https://opentelemetry.io/docs/concepts/components/ rel=external>OpenTelemetryã®æ§‹æˆè¦ç´ </a></a></h2><p>OpenTelemetryã¯ä»¥ä¸‹ã®ä¸»è¦ãªcomponentã‹ã‚‰æ§‹æˆã•ã‚Œã¾ã™ã€‚<ul><li>ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã«ä¾å­˜ã—ãªã„(Cross-language) specification<li>telemetry dataã‚’åé›†ã€åŠ å·¥ã€å…¬é–‹ã™ã‚‹ãŸã‚ã®toolç¾¤(collector,kubernetes operator)<li>è¨€èªã”ã¨ã®SDK</ul><p>å…¬å¼docã«ã¯ä¸Šè¨˜ã®æ§˜ãªã“ã¨ãŒè¿°ã¹ã‚‰ã‚Œã¦ã„ã‚‹ã®ã§ã™ãŒã€å…·ä½“ä¾‹ã‚’è¦‹ãªã„ã¨ã„ã¾ã„ã¡ã‚ã‹ã‚Šã¥ã‚‰ã„ã¨æ€ã†ã®ã§è£œè¶³ã—ã¦ã„ãã¾ã™ã€‚<h3 id=specification><a aria-label="Anchor link for: specification" class=zola-anchor href=#specification><a href=https://opentelemetry.io/docs/concepts/components/#specification rel=external>Specification</a></a></h3><p>ã“ã“ãŒOpenTelemetryã®æ ¸ã®ã¨ã“ã‚ã§ã€å®Ÿè£…ã«å¯¾ã™ã‚‹ä»•æ§˜(requirements and expectations)ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚<br> ç”¨èªã®å®šç¾©ã«ã¨æ­¢ã¾ã‚‰ãšä»¥ä¸‹ã®ç‚¹ã«ã¤ã„ã¦ã‚‚ä»•æ§˜ã‚’å®šã‚ã¦ã„ã¾ã™ã€‚<ul><li>API<li>SDK<li>Data</ul><p>APIã¯ãªã‚“ã¨ãªãæƒ³åƒãŒã§ãã¾ã—ãŸã€‚ä¾‹ãˆã°ã€<code>Span</code>ã¨ã„ã†ãƒ‡ãƒ¼ã‚¿æ§‹é€ (å‹)ã«ã¯ã“ã‚“ãªmethodãŒã‚ã£ã¦å¼•æ•°ã®å‹ã¯ã“ã‚Œã§ã€ä»¥ä¸‹ã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ç­‰ã‚’ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã«ä¾å­˜ã—ãªã„å½¢ã§å®šç¾©ã—ã¦ã„ã‚‹ã‚“ã ã‚ã†ãªã¨è€ƒãˆã¾ã—ãŸã€‚<br> å®Ÿéš›ã®Spanã®å®šç¾©ã¯<a href=https://opentelemetry.io/docs/reference/specification/trace/api/#span rel=external>ã“ã¡ã‚‰</a>ã§ã™ã€‚<br> æœ€åˆã«ç–‘å•ã ã£ãŸã®ãŒã€SDKã®ä»•æ§˜ã¨ã„ã†ã¨ã“ã‚ã§ã—ãŸã€‚APIãŒä»•æ§˜ã§æ±ºã¾ã£ã¦ã„ã¦ãã‚Œã‚’å„è¨€èªã®å®Ÿè£…ã«è½ã¨ã—è¾¼ã‚“ã§å®Ÿè£…ã™ã‚‹ã®ãŒSDKã¨ã„ã†ç†è§£ã ã£ãŸã®ã§ã€SDKã®ä»•æ§˜ã‚’è¨€èªã«ä¾å­˜ã—ãªã„å½¢ã§å®šç¾©ã£ã¦ã©ã†ã„ã†æ„å‘³ã ã‚ã†ã¨æ€ã„ã¾ã—ãŸã€‚<br> ã“ã®ç–‘å•ã«å¯¾ã™ã‚‹ç­”ãˆã¯<a href=https://opentelemetry.io/docs/reference/specification/overview/#sdk rel=external>specification overview</a>ã«æ›¸ã„ã¦ã‚ã‚Šã¾ã—ãŸã€‚<blockquote><p>Note that the SDK includes additional public interfaces which are not considered part of the API package, as they are not cross-cutting concerns. These public interfaces are defined as constructors and plugin interfaces. Application owners use the SDK constructors; plugin authors use the SDK plugin interfaces. Instrumentation authors MUST NOT directly reference any SDK package of any kind, only the API.</blockquote><p>è‡ªåˆ†ã®ç†è§£ã§ã¯ã€SDKã®ä»•æ§˜ã¨ã„ã£ã¦ã‚‚APIã¨åŒæ§˜ã«å‹ã‚„ãƒ¡ã‚½ãƒƒãƒ‰ã«ã¤ã„ã¦ã§ã‚ã‚‹ç‚¹ã¯åŒã˜ã§ã€ç´„æŸã®ç›¸æ‰‹æ–¹ãŒlibraryå®Ÿè£…è€…ãªã®ãŒAPIã§applicationé–‹ç™ºè€…ãªã®ãŒSDKã¨ã„ã†æ„Ÿã˜ã§ã™ã€‚è¦ã¯libraryã«opentelemetryã‚’å°å…¥ã™ã‚‹å ´åˆã¯APIã®ã¿ã«ä¾å­˜ã—ã¦ã€applicationã¯APIã¨SDKã«ä¾å­˜ã—ã¦ã‚ˆã„ã¨ã„ã†ã“ã¨ã ã¨æ€ã„ã¾ã™ã€‚ã¾ãŸå¾Œè¿°ã—ã¾ã™ãŒã€Rust(tracing)ã®å ´åˆã¯tracing-opentelemetryã§opentelemetry-sdkã‚’ã•ã‚‰ã«æŠ½è±¡åŒ–ã™ã‚‹ã®ã§ã‚ã¾ã‚Šæ„è­˜ã™ã‚‹ã“ã¨ã¯ãªã„ã®ã‹ãªã¨æ€ã£ã¦ã„ã¾ã™ã€‚<p>(ä½™è«‡ã§ã™ãŒã€<a href=https://opentelemetry.io/docs/reference/specification/sdk-environment-variables/#parsing-empty-value rel=external>ä»•æ§˜</a>ã§å‚ç…§ã™ã‚‹ç’°å¢ƒå¤‰æ•°ãŒç©ºã®å ´åˆ(<code>ENV_XXX=""</code>)ã«ã©ã†ã™ã‚‹ã‹ã‚‚æ±ºã¾ã£ã¦ã„ã¾ã™ã€‚ã“ã“ã¾ã§æ±ºã¾ã£ã¦ã„ã¦é‹ç”¨ã™ã‚‹äººã«ã‚ˆã‚Šãã£ã¦ã‚‹ãªã¨æ„Ÿã˜ã¾ã—ãŸã€‚)<h3 id=collector><a aria-label="Anchor link for: collector" class=zola-anchor href=#collector><a href=https://opentelemetry.io/docs/concepts/components/#collector rel=external>Collector</a></a></h3><p>https://raw.githubusercontent.com/open-telemetry/opentelemetry.io/main/iconography/Otel_Collector.svg<p>å…¬å¼docã§ã¯<blockquote><p>The OpenTelemetry Collector offers a vendor-agnostic implementation of how to receive, process and export telemetry data.</blockquote><p>ã¨èª¬æ˜ã•ã‚Œã¦ã„ã¾ã™ã€‚å®Ÿæ…‹ã¨ã—ã¦ã¯<a href=https://github.com/open-telemetry/opentelemetry-collector rel=external>goã®binary</a>ã§ã™ã€‚<br> ä¸€ä¾‹ã¨ã—ã¦ã¯rustã®applicationã‹ã‚‰collectorã«gRPCã§æ¥ç¶šã—ã¦traceæƒ…å ±ã‚’é€ã‚Šã€collectorãŒãã®traceæƒ…å ±ã‚’elasticsearchã«é€ã‚‹ã¨ã„ã£ãŸä½¿ã„æ–¹ãŒæŒ™ã’ã‚‰ã‚Œã¾ã™ã€‚td-agent(fluentd)çš„ãªcomponentã§ã€podã®sidecarã‚„daemonsetã¨ã—ã¦deployã—ã¾ã™ã€‚<br> ä»•æ§˜ç­–å®šã¾ã§ãŒscopeã§å®Ÿè£…ã¯scopeå¤–ã¨ã„ã†projectã‚‚ã‚ã‚Šã¾ã™ãŒã€collectorã®å®Ÿè£…ã¾ã§æä¾›ã—ã¦ã„ã‚‹ã®ãŒopentelemetry projectã®ç‰¹å¾´ã®ä¸€ã¤ã ãªã¨æ„Ÿã˜ã¾ã—ãŸã€‚collectorã®å­˜åœ¨ã«ã‚ˆã£ã¦å„è¨€èªã§ã¯telemetry dataã‚’exportã™ã‚‹gRPC clientã‚’å®Ÿè£…ã—ã¦ãŠã‘ã°ã‚ˆããã®å¾Œã®å…±é€šå‡¦ç†ã¯è¨€èªå…±é€šã§collectorã«å§”è­²ã§ãã¾ã™ã€‚ Collectorã¯retry, batchå‡¦ç†ã€æš—å·åŒ–ã€sensitive data filteringç­‰ã‚’å®Ÿæ–½ã—ã¦ãã‚Œã‚‹ã‚ˆã†ã§ã™ã€‚<br> å®Ÿéš›ã®ä½¿ã„æ–¹ã¯å¾Œè¿°ã—ã¾ã™ã€‚<h2 id=signals-categories-of-telemetry><a aria-label="Anchor link for: signals-categories-of-telemetry" class=zola-anchor href=#signals-categories-of-telemetry>Signals (Categories of telemetry)</a></h2><p>OpenTelemetryã«ãŠã‘ã‚‹Signalsã¨ã¯ã€ä»•æ§˜ã§å®šã‚ã‚‰ã‚Œã¦ã„ã‚‹telemetryã®categoriesã®ã“ã¨ã§ã™ã€‚<br> ç¾åœ¨ã®ã¨ã“ã‚signalsã¯ä»¥ä¸‹ã®4ã¤ã‹ã‚‰æˆã‚Šã¾ã™ã€‚<ul><li>Traces<li>Metrics<li>Logs<li>Baggage</ul><p>ã“ã“ã§ã¯ãã‚Œãã‚Œã®signalã«ã¤ã„ã¦ã®æ¦‚è¦ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚<h3 id=traces><a aria-label="Anchor link for: traces" class=zola-anchor href=#traces><a href=https://opentelemetry.io/docs/concepts/signals/traces/ rel=external>Traces</a></a></h3><blockquote><p>Traces give us the big picture of what happens when a request is made by user or an application.</blockquote><p>https://opentelemetry.io/docs/concepts/signals/traces/<p>Traceã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†ã«éš›ã—ã¦ä½•ãŒèµ·ããŸã‹ã‚’æ•™ãˆã¦ãã‚Œã‚‹ã‚‚ã®ã€‚<br> Docã«è¼‰ã£ã¦ã„ã‚‹Sample Traceã‚’å†æ²ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=json><span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#eceff4>    "</span><span style=color:#8fbcbb>name</span><span style=color:#eceff4>": "</span><span style=color:#a3be8c>Hello-Greetings</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>    "</span><span style=color:#8fbcbb>context</span><span style=color:#eceff4>": {</span></span>
<span class=giallo-l><span style=color:#eceff4>        "</span><span style=color:#8fbcbb>trace_id</span><span style=color:#eceff4>": "</span><span style=color:#a3be8c>0x5b8aa5a2d2c872e8321cf37308d69df2</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>        "</span><span style=color:#8fbcbb>span_id</span><span style=color:#eceff4>": "</span><span style=color:#a3be8c>0x5fb397be34d26b51</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>    },</span></span>
<span class=giallo-l><span style=color:#eceff4>    "</span><span style=color:#8fbcbb>parent_id</span><span style=color:#eceff4>": "</span><span style=color:#a3be8c>0x051581bf3cb55c13</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>    "</span><span style=color:#8fbcbb>start_time</span><span style=color:#eceff4>": "</span><span style=color:#a3be8c>2022-04-29T18:52:58.114304Z</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>    "</span><span style=color:#8fbcbb>end_time</span><span style=color:#eceff4>": "</span><span style=color:#a3be8c>2022-04-29T18:52:58.114435Z</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>    "</span><span style=color:#8fbcbb>attributes</span><span style=color:#eceff4>": {</span></span>
<span class=giallo-l><span style=color:#eceff4>        "</span><span style=color:#8fbcbb>http.route</span><span style=color:#eceff4>": "</span><span style=color:#a3be8c>some_route1</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#eceff4>    },</span></span>
<span class=giallo-l><span style=color:#eceff4>    "</span><span style=color:#8fbcbb>events</span><span style=color:#eceff4>": [</span></span>
<span class=giallo-l><span style=color:#eceff4>        {</span></span>
<span class=giallo-l><span style=color:#eceff4>            "</span><span style=color:#8fbcbb>name</span><span style=color:#eceff4>": "</span><span style=color:#a3be8c>hey there!</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>            "</span><span style=color:#8fbcbb>timestamp</span><span style=color:#eceff4>": "</span><span style=color:#a3be8c>2022-04-29T18:52:58.114561Z</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>            "</span><span style=color:#8fbcbb>attributes</span><span style=color:#eceff4>": {</span></span>
<span class=giallo-l><span style=color:#eceff4>                "</span><span style=color:#8fbcbb>event_attributes</span><span style=color:#eceff4>":</span><span style=color:#b48ead> 1</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        },</span></span>
<span class=giallo-l><span style=color:#eceff4>        {</span></span>
<span class=giallo-l><span style=color:#eceff4>            "</span><span style=color:#8fbcbb>name</span><span style=color:#eceff4>": "</span><span style=color:#a3be8c>bye now!</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>            "</span><span style=color:#8fbcbb>timestamp</span><span style=color:#eceff4>": "</span><span style=color:#a3be8c>2022-04-29T22:52:58.114561Z</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>            "</span><span style=color:#8fbcbb>attributes</span><span style=color:#eceff4>": {</span></span>
<span class=giallo-l><span style=color:#eceff4>                "</span><span style=color:#8fbcbb>event_attributes</span><span style=color:#eceff4>":</span><span style=color:#b48ead> 1</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    ],</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#eceff4>    "</span><span style=color:#8fbcbb>name</span><span style=color:#eceff4>": "</span><span style=color:#a3be8c>Hello-Salutations</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>    "</span><span style=color:#8fbcbb>context</span><span style=color:#eceff4>": {</span></span>
<span class=giallo-l><span style=color:#eceff4>        "</span><span style=color:#8fbcbb>trace_id</span><span style=color:#eceff4>": "</span><span style=color:#a3be8c>0x5b8aa5a2d2c872e8321cf37308d69df2</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>        "</span><span style=color:#8fbcbb>span_id</span><span style=color:#eceff4>": "</span><span style=color:#a3be8c>0x93564f51e1abe1c2</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>    },</span></span>
<span class=giallo-l><span style=color:#eceff4>    "</span><span style=color:#8fbcbb>parent_id</span><span style=color:#eceff4>": "</span><span style=color:#a3be8c>0x051581bf3cb55c13</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>    "</span><span style=color:#8fbcbb>start_time</span><span style=color:#eceff4>": "</span><span style=color:#a3be8c>2022-04-29T18:52:58.114492Z</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>    "</span><span style=color:#8fbcbb>end_time</span><span style=color:#eceff4>": "</span><span style=color:#a3be8c>2022-04-29T18:52:58.114631Z</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>    "</span><span style=color:#8fbcbb>attributes</span><span style=color:#eceff4>": {</span></span>
<span class=giallo-l><span style=color:#eceff4>        "</span><span style=color:#8fbcbb>http.route</span><span style=color:#eceff4>": "</span><span style=color:#a3be8c>some_route2</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#eceff4>    },</span></span>
<span class=giallo-l><span style=color:#eceff4>    "</span><span style=color:#8fbcbb>events</span><span style=color:#eceff4>": [</span></span>
<span class=giallo-l><span style=color:#eceff4>        {</span></span>
<span class=giallo-l><span style=color:#eceff4>            "</span><span style=color:#8fbcbb>name</span><span style=color:#eceff4>": "</span><span style=color:#a3be8c>hey there!</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>            "</span><span style=color:#8fbcbb>timestamp</span><span style=color:#eceff4>": "</span><span style=color:#a3be8c>2022-04-29T18:52:58.114561Z</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>            "</span><span style=color:#8fbcbb>attributes</span><span style=color:#eceff4>": {</span></span>
<span class=giallo-l><span style=color:#eceff4>                "</span><span style=color:#8fbcbb>event_attributes</span><span style=color:#eceff4>":</span><span style=color:#b48ead> 1</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    ],</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#eceff4>    "</span><span style=color:#8fbcbb>name</span><span style=color:#eceff4>": "</span><span style=color:#a3be8c>Hello</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>    "</span><span style=color:#8fbcbb>context</span><span style=color:#eceff4>": {</span></span>
<span class=giallo-l><span style=color:#eceff4>        "</span><span style=color:#8fbcbb>trace_id</span><span style=color:#eceff4>": "</span><span style=color:#a3be8c>0x5b8aa5a2d2c872e8321cf37308d69df2</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>        "</span><span style=color:#8fbcbb>span_id</span><span style=color:#eceff4>": "</span><span style=color:#a3be8c>0x051581bf3cb55c13</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>    },</span></span>
<span class=giallo-l><span style=color:#eceff4>    "</span><span style=color:#8fbcbb>parent_id</span><span style=color:#eceff4>":</span><span style=color:#81a1c1> null</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    "</span><span style=color:#8fbcbb>start_time</span><span style=color:#eceff4>": "</span><span style=color:#a3be8c>2022-04-29T18:52:58.114201Z</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>    "</span><span style=color:#8fbcbb>end_time</span><span style=color:#eceff4>": "</span><span style=color:#a3be8c>2022-04-29T18:52:58.114687Z</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>    "</span><span style=color:#8fbcbb>attributes</span><span style=color:#eceff4>": {</span></span>
<span class=giallo-l><span style=color:#eceff4>        "</span><span style=color:#8fbcbb>http.route</span><span style=color:#eceff4>": "</span><span style=color:#a3be8c>some_route3</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#eceff4>    },</span></span>
<span class=giallo-l><span style=color:#eceff4>    "</span><span style=color:#8fbcbb>events</span><span style=color:#eceff4>": [</span></span>
<span class=giallo-l><span style=color:#eceff4>        {</span></span>
<span class=giallo-l><span style=color:#eceff4>            "</span><span style=color:#8fbcbb>name</span><span style=color:#eceff4>": "</span><span style=color:#a3be8c>Guten Tag!</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>            "</span><span style=color:#8fbcbb>timestamp</span><span style=color:#eceff4>": "</span><span style=color:#a3be8c>2022-04-29T18:52:58.114561Z</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>            "</span><span style=color:#8fbcbb>attributes</span><span style=color:#eceff4>": {</span></span>
<span class=giallo-l><span style=color:#eceff4>                "</span><span style=color:#8fbcbb>event_attributes</span><span style=color:#eceff4>":</span><span style=color:#b48ead> 1</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    ],</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>Hello-Greetings</code>,<code>Hello-Salutations</code>,<code>Hello</code>ã®3ã¤ã®spanã‹ã‚‰ãªã‚‹traceã‚’è¡¨ã—ã¦ã„ã¾ã™ã€‚<br> <code>context.span_id</code>ãŒè‡ªèº«ã®idã§ã€<code>context.trace_id</code>ãŒç´ã¥ãtraceã§ã™ã€‚<br> 3ã¤ã¨ã‚‚ã€<code>context.trace_id: "0x5b8aa5a2d2c872e8321cf37308d69df2"</code>ã¨ãªã£ã¦ã„ã¾ã™ã€‚<br> <code>parent_id</code>ãŒè¦ªspanã‚’è¡¨ã—ã¦ã„ã¦ã€<code>null</code>ã®å ´åˆãŒroot spanã§ã™ã€‚<code>Hello</code>ä»¥å¤–ã¯<code>parent_id: "0x051581bf3cb55c13"</code>ã¨ãªã£ã¦ãŠã‚Šã€<code>Hello</code>ãŒè¦ªã§ã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚<p>OpenTelemetryã«ãŠã‘ã‚‹tracingã®å‹•ä½œã‚’ç†è§£ã™ã‚‹ãŸã‚ã«ã€instrumentingã«é–¢ã‚ã‚‹componentã«ã¯ä»¥ä¸‹ãŒã‚ã‚Šã¾ã™ã€‚<ul><li>Tracer<li>Tracer Provider<li>Trace Exporter<li>Trace Context</ul><p>ãªã‚“ã‹æ€¥ã«å®Ÿè£…ã‚ˆã‚Šã®è©±ã«ãªã‚Šã¾ã—ãŸã€‚tracer providerã¯tracerã®factoryã§ã‚ã‚‹ã¨èª¬æ˜ã•ã‚Œã¦ã„ã‚‹ã®ã§ã™ãŒã€ã‚ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ä½œã‚‹ã†ãˆã§ã€<code>Tracer::new()</code>ã™ã‚‹ã®ã‹ã€<code>TraProvider::provide()</code>ã™ã‚‹ã®ã‹ã£ã¦tracingã®conceptã®èª¬æ˜docã«ã¯ã„ã‚‰ãªã„ã‚“ã˜ã‚ƒãªã„ã‹ãªã¨æ€ã„ã¾ã—ãŸã€‚ãŸã å®Ÿè£…(<code>opentelemetry_{api,sdk}</code>)ã‚’èª­ã‚€ã¨ã“ã‚Œã‚‰ã®å‹ãŒå‡ºã¦ãã¾ã™ã€‚<h4 id=span><a aria-label="Anchor link for: span" class=zola-anchor href=#span><a href=https://opentelemetry.io/docs/concepts/signals/traces/#spans-in-opentelemetry rel=external>Span</a></a></h4><p>Traceã®æ§‹æˆè¦ç´ ã§ã€unit of workã‚’è¡¨ç¾ã™ã‚‹spanã¯OpenTelemetryã«ãŠã„ã¦ä»¥ä¸‹ã®æƒ…å ±ã‚’æŒã¡ã¾ã™ã€‚<ul><li>Name<li>Parent span ID (rootã®å ´åˆã¯ã‚‚ãŸãªã„)<li>Start and End Timestamps<li>Span Context<li>Attributes<li>Span Events<li>Span Links<li>Span Status</ul><p>Spanã®å…·ä½“ä¾‹ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=json><span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#eceff4>  "</span><span style=color:#8fbcbb>trace_id</span><span style=color:#eceff4>": "</span><span style=color:#a3be8c>7bba9f33312b3dbb8b2c2c62bb7abe2d</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>  "</span><span style=color:#8fbcbb>parent_id</span><span style=color:#eceff4>": "",</span></span>
<span class=giallo-l><span style=color:#eceff4>  "</span><span style=color:#8fbcbb>span_id</span><span style=color:#eceff4>": "</span><span style=color:#a3be8c>086e83747d0e381e</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>  "</span><span style=color:#8fbcbb>name</span><span style=color:#eceff4>": "</span><span style=color:#a3be8c>/v1/sys/health</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>  "</span><span style=color:#8fbcbb>start_time</span><span style=color:#eceff4>": "</span><span style=color:#a3be8c>2021-10-22 16:04:01.209458162 +0000 UTC</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>  "</span><span style=color:#8fbcbb>end_time</span><span style=color:#eceff4>": "</span><span style=color:#a3be8c>2021-10-22 16:04:01.209514132 +0000 UTC</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>  "</span><span style=color:#8fbcbb>status_code</span><span style=color:#eceff4>": "</span><span style=color:#a3be8c>STATUS_CODE_OK</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>  "</span><span style=color:#8fbcbb>status_message</span><span style=color:#eceff4>": "",</span></span>
<span class=giallo-l><span style=color:#eceff4>  "</span><span style=color:#8fbcbb>attributes</span><span style=color:#eceff4>": {</span></span>
<span class=giallo-l><span style=color:#eceff4>    "</span><span style=color:#8fbcbb>net.transport</span><span style=color:#eceff4>": "</span><span style=color:#a3be8c>IP.TCP</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>    "</span><span style=color:#8fbcbb>net.peer.ip</span><span style=color:#eceff4>": "</span><span style=color:#a3be8c>172.17.0.1</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>    "</span><span style=color:#8fbcbb>net.peer.port</span><span style=color:#eceff4>": "</span><span style=color:#a3be8c>51820</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>    "</span><span style=color:#8fbcbb>net.host.ip</span><span style=color:#eceff4>": "</span><span style=color:#a3be8c>10.177.2.152</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>    "</span><span style=color:#8fbcbb>net.host.port</span><span style=color:#eceff4>": "</span><span style=color:#a3be8c>26040</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>    "</span><span style=color:#8fbcbb>http.method</span><span style=color:#eceff4>": "</span><span style=color:#a3be8c>GET</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>    "</span><span style=color:#8fbcbb>http.target</span><span style=color:#eceff4>": "</span><span style=color:#a3be8c>/v1/sys/health</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>    "</span><span style=color:#8fbcbb>http.server_name</span><span style=color:#eceff4>": "</span><span style=color:#a3be8c>mortar-gateway</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>    "</span><span style=color:#8fbcbb>http.route</span><span style=color:#eceff4>": "</span><span style=color:#a3be8c>/v1/sys/health</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>    "</span><span style=color:#8fbcbb>http.user_agent</span><span style=color:#eceff4>": "</span><span style=color:#a3be8c>Consul Health Check</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>    "</span><span style=color:#8fbcbb>http.scheme</span><span style=color:#eceff4>": "</span><span style=color:#a3be8c>http</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>    "</span><span style=color:#8fbcbb>http.host</span><span style=color:#eceff4>": "</span><span style=color:#a3be8c>10.177.2.152:26040</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>    "</span><span style=color:#8fbcbb>http.flavor</span><span style=color:#eceff4>": "</span><span style=color:#a3be8c>1.1</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#eceff4>  },</span></span>
<span class=giallo-l><span style=color:#eceff4>  "</span><span style=color:#8fbcbb>events</span><span style=color:#eceff4>": [</span></span>
<span class=giallo-l><span style=color:#eceff4>    {</span></span>
<span class=giallo-l><span style=color:#eceff4>      "</span><span style=color:#8fbcbb>name</span><span style=color:#eceff4>": "",</span></span>
<span class=giallo-l><span style=color:#eceff4>      "</span><span style=color:#8fbcbb>message</span><span style=color:#eceff4>": "</span><span style=color:#a3be8c>OK</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>      "</span><span style=color:#8fbcbb>timestamp</span><span style=color:#eceff4>": "</span><span style=color:#a3be8c>2021-10-22 16:04:01.209512872 +0000 UTC</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>  ]</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>Tracesã«ã®ã£ã¦ã„ãŸtraceã®å…·ä½“ä¾‹ã¨ã€<code>trace_id</code>ã‚„<code>span_id</code>ãŒ<code>context</code>ã®fieldã‹ã©ã†ã‹ã§é•ã†ã¯ã©ã†ã—ã¦ã‹ç–‘å•ã§ã™ã€‚<h3 id=logs><a aria-label="Anchor link for: logs" class=zola-anchor href=#logs><a href=https://opentelemetry.io/docs/concepts/signals/logs/ rel=external>Logs</a></a></h3><p>OpenTelemetryã«ãŠã‘ã‚‹Logã¨ã¯ã€traceã‚„metricã«å«ã¾ã‚Œãªã„ãƒ‡ãƒ¼ã‚¿ã¯logã§ã‚ã‚‹ã¨æ¶ˆæ¥µçš„ã«å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚<br> é‡è¦ãªç‚¹ã¨ã—ã¦ã€Logã®APIã¨SDKã«é–¢ã™ã‚‹ä»•æ§˜ã¯2022å¹´12æœˆç¾åœ¨ã§ã¯draftçŠ¶æ…‹ã§ã™ã€‚ã—ãŸãŒã£ã¦ã€Rustã§ã¯logsã«ã¤ã„ã¦Not yet implementedã¨ã—ã¦ä½¿ãˆã¾ã›ã‚“ã€‚ã˜ã‚ƒã‚applicationã®logã¯ã©ã†ã™ã‚‹ã®ã‹ã¨ã„ã†ã¨traceã«span eventã¨ã—ã¦å«ã‚ã‚‹ã—ã‹ãªã„ã¨ã„ã†ã®ãŒç¾çŠ¶ã®è‡ªåˆ†ã®ç†è§£ã§ã™ã€‚å…·ä½“çš„ã«rustã®log(<code>info!()</code>ã®å‡ºåŠ›)ãŒã©ã®ã‚ˆã†ã«è¦‹ãˆã‚‹ã‹ã¯å¾Œè¿°ã—ã¾ã™ã€‚<p>ã¾ãŸã€opentelemetryã§ã¯logã«ã¤ã„ã¦ã¯traceã‚„metricsã¨ã¯é•ã„logã«ã¤ã„ã¦ã¯æ—¢å­˜ã®log ecosystemã¨ã®çµ±åˆã‚’é‡è¦–ã™ã‚‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’ã¨ã£ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚<blockquote><p>Our approach with logs is somewhat different. For OpenTelemetry to be successful in logging space we need to support existing legacy of logs and logging libraries, while offering improvements and better integration with the rest of observability world where possible.</blockquote><p><a href=https://opentelemetry.io/docs/reference/specification/logs/ rel=external>https://opentelemetry.io/docs/reference/specification/logs/</a><figure><div class=fig-images-row><img , alt src=images/otel_log_overview.png></div><figcaption>telemetry ecosystemã®åˆ†æ–­</figcaption></figure><p>Logã«é–¢ã™ã‚‹opentelemetryã®å•é¡Œæ„è­˜ã¨ã—ã¦ä»¥ä¸‹ã®ç‚¹ãŒæŒ™ã’ã‚‰ã‚Œã¦ã„ã¾ã—ãŸã€‚<ul><li>æ—¢å­˜ã®logã¯observability signalsã¨weakly integratedãªçŠ¶æ…‹<li>log,trace,metricsã§agent,protocol, data modelãŒé•ã†</ul><p>è‡ªåˆ†ã®çµŒé¨“ã¨ã—ã¦ã‚‚ã€logå‡ºåŠ›ã—ãªã„applicationã¯ãªã„ã®ã§ã€loggingã¯å‰æã€‚æ¬¡ã«applicationã®metricsã‚’åé›†ã—ãŸã„ã®ã§ã€CloudWatchã®Custom metricsã‚„Prometheusã®metricsã‚’ç™ºè¡Œã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚1 requestã‚’å®Œäº†ã™ã‚‹ãŸã‚ã«backendã‹ã‚‰ã•ã‚‰ã«è¤‡æ•°ã®backendã®apiã‚’å©ãã®ã§ãã‚Œã‚‰ã®logã‚’é›†ç´„ã§ãã‚‹ã‚ˆã†ã«traceã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚ã®æµã‚Œã§ãã‚Œãã‚ŒãŒç‹¬ç«‹ã—ã¦å‡¦ç†ã•ã‚Œã‚‹ã¨ã„ã†ã®ãŒã‚ã‚Šã¾ã—ãŸã€‚ã¾ãŸãã®å•é¡Œã«å¯¾ã—ã¦datadogã‚’å°å…¥ã—ã¦vendorä¾å­˜ã‚’å—ã‘å…¥ã‚ŒãŸã‚Šã€‚<p>ã“ã‚Œã‚‰ã«å¯¾ã—ã¦ä»¥ä¸‹ã®å›³ãŒopentelemetryã®ç›®æŒ‡ã™è§£æ±ºã§ã™ã€‚<figure><div class=fig-images-row><img , alt src=images/otel_to_be.png></div><figcaption>collectorã«ã‚ˆã‚‹çµ±ä¸€çš„ãªtelemetry dataã®å‡¦ç†</figcaption></figure><p>Logã¨trace,metricsã®é–¢ä¿‚æ€§ã‚’æ¨™æº–åŒ–ã—Infra/ApplicationãŒçµ±ä¸€ã•ã‚ŒãŸformatã§log,trace,metricsã‚’å‡ºåŠ›ã—ã¦ã€ã™ã¹ã¦Collectorã§å‡¦ç†ã§ãã‚‹ä¸–ç•Œã¯promisingã«æ€ãˆã¾ã™ã€‚è‡ªåˆ†ãŒé‹ç”¨ã™ã‚‹ç’°å¢ƒã‚’ã“ã†ã—ãŸã„ã¨æ€ãˆãŸã®ãŒè‡ªåˆ†ãŒopentelemetryã‚’å°å…¥ã—ãŸã„ã¨æ€ã£ãŸãã£ã‹ã‘ã§ã—ãŸã€‚<h3 id=baggage><a aria-label="Anchor link for: baggage" class=zola-anchor href=#baggage><a href=https://opentelemetry.io/docs/concepts/signals/baggage/ rel=external>Baggage</a></a></h3><p>metrics,traces,logsã«ä»˜ä¸ã™ã‚‹name/valueã®pairã€‚<br> ã„ã¾ã„ã¡ä½¿ã„æ‰€ãŒç†è§£ã§ãã¦ãŠã‚‰ãšæœ¬è¨˜äº‹ã®å…·ä½“ä¾‹ã§ã‚‚ç™»å ´ã—ãªã„ã§ã™ã€‚ä»Šå¾Œã®èª²é¡Œã€‚<h2 id=rustdeopentelemetrywodong-kasu><a aria-label="Anchor link for: rustdeopentelemetrywodong-kasu" class=zola-anchor href=#rustdeopentelemetrywodong-kasu>Rustã§opentelemetryã‚’å‹•ã‹ã™</a></h2><p>ã“ã“ã¾ã§æŠ½è±¡çš„ãªè©±ã°ã‹ã‚Šã ã£ãŸã®ã§å…·ä½“çš„ã«è¦‹ã¦ã„ãã¾ã™ã€‚<br> ã‚´ãƒ¼ãƒ«ã¯rustã®applicationã‹ã‚‰telemetry dataã‚’å‡ºåŠ›ã—ã¦ã€elasticsearch,jaeger,prometheusã§ç¢ºèªã™ã‚‹ã¾ã§ã§ã™ã€‚<h3 id=tracing-opentelemetry><a aria-label="Anchor link for: tracing-opentelemetry" class=zola-anchor href=#tracing-opentelemetry>tracing-opentelemetry</a></h3><p>telemetry dataã‚’å‡ºåŠ›ã™ã‚‹rustã‚’å‹•ã‹ã—ã¾ã™ã€‚<p><code>Cargo.toml</code><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=toml><span class=giallo-l><span style=color:#eceff4>[</span><span>dependencies</span><span style=color:#eceff4>]</span></span>
<span class=giallo-l><span>opentelemetry</span><span style=color:#eceff4> = {</span><span> version</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>0.18.0</span><span style=color:#eceff4>",</span><span> default-features</span><span style=color:#eceff4> =</span><span style=color:#81a1c1> false</span><span style=color:#eceff4>,</span><span> features</span><span style=color:#eceff4> = ["</span><span style=color:#a3be8c>trace</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>rt-tokio</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>metrics</span><span style=color:#eceff4>"] }</span></span>
<span class=giallo-l><span>opentelemetry-otlp</span><span style=color:#eceff4> = {</span><span> version</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>0.11.0</span><span style=color:#eceff4>",</span><span> default-features</span><span style=color:#eceff4> =</span><span style=color:#81a1c1> false</span><span style=color:#eceff4>,</span><span> features</span><span style=color:#eceff4> = ["</span><span style=color:#a3be8c>grpc-tonic</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>trace</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>metrics</span><span style=color:#eceff4>"] }</span></span>
<span class=giallo-l><span>tokio</span><span style=color:#eceff4> = {</span><span> version</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>1.23.0</span><span style=color:#eceff4>",</span><span> features</span><span style=color:#eceff4> = ["</span><span style=color:#a3be8c>full</span><span style=color:#eceff4>"] }</span></span>
<span class=giallo-l><span>tracing</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>0.1.37</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span>tracing-futures</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>0.2.5</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span>tracing-opentelemetry</span><span style=color:#eceff4> = {</span><span> version</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>0.18.0</span><span style=color:#eceff4>",</span><span> default-features</span><span style=color:#eceff4> =</span><span style=color:#81a1c1> false</span><span style=color:#eceff4>,</span><span> features</span><span style=color:#eceff4> = ["</span><span style=color:#a3be8c>tracing-log</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>metrics</span><span style=color:#eceff4>"] }</span></span>
<span class=giallo-l><span>tracing-subscriber</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>0.3.16</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span>opentelemetry_sdk</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>0.18.0</span><span style=color:#eceff4>"</span></span></code></pre><p><code>main.rs</code><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> opentelemetry</span><span style=color:#81a1c1>::</span><span>sdk</span><span style=color:#81a1c1>::</span><span>metrics</span><span style=color:#81a1c1>::</span><span>controllers</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>BasicController</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> opentelemetry_otlp</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>WithExportConfig</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> tracing</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span>info</span><span style=color:#eceff4>,</span><span> info_span</span><span style=color:#eceff4>,</span><span> error</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> tracing_futures</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Instrument</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>// https://github.com/open-telemetry/opentelemetry-rust/blob/d4b9befea04bcc7fc19319a6ebf5b5070131c486/examples/basic-otlp/src/main.rs#L35-L52</span></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> build_metrics_controller</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> BasicController</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    opentelemetry_otlp</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new_pipeline</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>metrics</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>            opentelemetry</span><span style=color:#81a1c1>::</span><span>sdk</span><span style=color:#81a1c1>::</span><span>metrics</span><span style=color:#81a1c1>::</span><span>selectors</span><span style=color:#81a1c1>::</span><span>simple</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>histogram</span><span style=color:#eceff4>(</span><span>Vec</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>()),</span></span>
<span class=giallo-l><span>            opentelemetry</span><span style=color:#81a1c1>::</span><span>sdk</span><span style=color:#81a1c1>::</span><span>export</span><span style=color:#81a1c1>::</span><span>metrics</span><span style=color:#81a1c1>::</span><span>aggregation</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>cumulative_temporality_selector</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>            opentelemetry</span><span style=color:#81a1c1>::</span><span>runtime</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Tokio</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>        )</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>with_exporter</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>            opentelemetry_otlp</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new_exporter</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>                .</span><span style=color:#88c0d0>tonic</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>                .</span><span style=color:#88c0d0>with_endpoint</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>http://localhost:4317</span><span style=color:#eceff4>"),</span></span>
<span class=giallo-l><span style=color:#eceff4>        )</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>build</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>expect</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Failed to build metrics controller</span><span style=color:#eceff4>")</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> init_tracing</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#616e88>    // Configure otel exporter.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> tracer</span><span style=color:#81a1c1> =</span><span> opentelemetry_otlp</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new_pipeline</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>tracing</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>with_exporter</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>            opentelemetry_otlp</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new_exporter</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>                .</span><span style=color:#88c0d0>tonic</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>                .</span><span style=color:#88c0d0>with_endpoint</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>http://localhost:4317</span><span style=color:#eceff4>"),</span></span>
<span class=giallo-l><span style=color:#eceff4>        )</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>with_trace_config</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>            opentelemetry</span><span style=color:#81a1c1>::</span><span>sdk</span><span style=color:#81a1c1>::</span><span>trace</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>config</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>                .</span><span style=color:#88c0d0>with_sampler</span><span style=color:#eceff4>(</span><span>opentelemetry</span><span style=color:#81a1c1>::</span><span>sdk</span><span style=color:#81a1c1>::</span><span>trace</span><span style=color:#81a1c1>::</span><span>Sampler</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>AlwaysOn</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>                .</span><span style=color:#88c0d0>with_id_generator</span><span style=color:#eceff4>(</span><span>opentelemetry</span><span style=color:#81a1c1>::</span><span>sdk</span><span style=color:#81a1c1>::</span><span>trace</span><span style=color:#81a1c1>::</span><span>RandomIdGenerator</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>())</span></span>
<span class=giallo-l><span style=color:#81a1c1>                .</span><span style=color:#88c0d0>with_resource</span><span style=color:#eceff4>(</span><span>opentelemetry</span><span style=color:#81a1c1>::</span><span>sdk</span><span style=color:#81a1c1>::</span><span>Resource</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span style=color:#88c0d0;font-weight:700>vec!</span><span style=color:#eceff4>[</span><span>opentelemetry</span><span style=color:#81a1c1>::</span><span>KeyValue</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>                    "</span><span style=color:#a3be8c>service.name</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>                    "</span><span style=color:#a3be8c>sample-app</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>                )]))</span></span>
<span class=giallo-l><span style=color:#eceff4>            ,</span></span>
<span class=giallo-l><span style=color:#eceff4>        )</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>install_batch</span><span style=color:#eceff4>(</span><span>opentelemetry</span><span style=color:#81a1c1>::</span><span>runtime</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Tokio</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>expect</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Not running in tokio runtime</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    // Compatible layer with tracing.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> otel_trace_layer</span><span style=color:#81a1c1> =</span><span> tracing_opentelemetry</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>layer</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>with_tracer</span><span style=color:#eceff4>(</span><span>tracer</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> otel_metrics_layer</span><span style=color:#81a1c1> =</span><span> tracing_opentelemetry</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>MetricsLayer</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>build_metrics_controller</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    use</span><span> tracing_subscriber</span><span style=color:#81a1c1>::</span><span>layer</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>SubscriberExt</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    use</span><span> tracing_subscriber</span><span style=color:#81a1c1>::</span><span>util</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>SubscriberInitExt</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>    tracing_subscriber</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Registry</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>with</span><span style=color:#eceff4>(</span><span>tracing_subscriber</span><span style=color:#81a1c1>::</span><span>fmt</span><span style=color:#81a1c1>::</span><span>Layer</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>with_ansi</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>true</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>with</span><span style=color:#eceff4>(</span><span>otel_trace_layer</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>with</span><span style=color:#eceff4>(</span><span>otel_metrics_layer</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>with</span><span style=color:#eceff4>(</span><span>tracing_subscriber</span><span style=color:#81a1c1>::</span><span>filter</span><span style=color:#81a1c1>::</span><span>LevelFilter</span><span style=color:#81a1c1>::</span><span>INFO</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>init</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> start</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> user</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>ymgyt</span><span style=color:#eceff4>";</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>    operation</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>instrument</span><span style=color:#eceff4>(</span><span style=color:#88c0d0;font-weight:700>info_span!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>auth</span><span style=color:#eceff4>",</span><span style=color:#81a1c1> %</span><span>user</span><span style=color:#eceff4>))</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#88c0d0>    operation_2</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>instrument</span><span style=color:#eceff4>(</span><span style=color:#88c0d0;font-weight:700>info_span!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>db</span><span style=color:#eceff4>"))</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> operation</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#616e88>    // trace</span></span>
<span class=giallo-l><span style=color:#616e88>    // https://docs.rs/tracing-opentelemetry/latest/tracing_opentelemetry/struct.MetricsLayer.html#usage</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    info!</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>        ops</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>xxx</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span>        counter</span><span style=color:#81a1c1>.</span><span>ops_count </span><span style=color:#81a1c1>=</span><span style=color:#b48ead> 10</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>        "</span><span style=color:#a3be8c>successfully completed</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#eceff4>    );</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> operation_2</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    info!</span><span style=color:#eceff4>(</span><span>arg</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>xyz</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>fetch resources...</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    error!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>something went wrong</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[tokio::main]</span></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#88c0d0>    init_tracing</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> version</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0;font-weight:700> env!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>CARGO_PKG_VERSION</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>    start</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>instrument</span><span style=color:#eceff4>(</span><span style=color:#88c0d0;font-weight:700>info_span!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>request</span><span style=color:#eceff4>",</span><span style=color:#81a1c1> %</span><span>version</span><span style=color:#eceff4>))</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>    tokio</span><span style=color:#81a1c1>::</span><span>time</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>sleep</span><span style=color:#eceff4>(</span><span>std</span><span style=color:#81a1c1>::</span><span>time</span><span style=color:#81a1c1>::</span><span>Duration</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_secs</span><span style=color:#eceff4>(</span><span style=color:#b48ead>60</span><span style=color:#eceff4>))</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>    opentelemetry</span><span style=color:#81a1c1>::</span><span>global</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>shutdown_tracer_provider</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>çµæ§‹é•·ã„ã§ã™ã€‚<code>tracing_opentelemetry</code>ã ã‘ã§å®Œçµã™ã‚‹ã¨æ€ã„ãã‚„ã€<code>opentelemetry_sdk</code>ã‚„<code>opentelemetry_otlp</code>ç­‰ã‚‚ã§ã¦ãã¾ã™ã€‚ å®Ÿè¡Œã™ã‚‹ã¨ä»¥ä¸‹ã®logãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>â¯</span><span style=color:#a3be8c> cargo run --quiet</span></span>
<span class=giallo-l><span style=color:#88c0d0>2022-12-18T07:01:01.837895Z</span><span style=color:#a3be8c>  INFO request{version=</span><span style=color:#b48ead>0.1.0</span><span style=color:#a3be8c>}:auth{user=ymgyt}: opentelemetry_handson: successfully completed ops=</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>xxx</span><span style=color:#eceff4>"</span><span style=color:#a3be8c> counter.ops_count=</span><span style=color:#b48ead>10</span></span>
<span class=giallo-l><span style=color:#88c0d0>BatchSpanProcessor:</span><span style=color:#a3be8c> flush messages</span></span>
<span class=giallo-l><span style=color:#88c0d0>2022-12-18T07:01:01.838090Z</span><span style=color:#a3be8c>  INFO request{version=</span><span style=color:#b48ead>0.1.0</span><span style=color:#a3be8c>}:db: opentelemetry_handson: fetch resources... arg=</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>xyz</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#88c0d0>2022-12-18T07:01:01.838115Z</span><span style=color:#a3be8c> ERROR request{version=</span><span style=color:#b48ead>0.1.0</span><span style=color:#a3be8c>}:db: opentelemetry_handson: something went wrong</span></span></code></pre><p>æ„å¤–ã¨é•·ã„ã®ã§ãã‚Œãã‚Œè§£èª¬ã—ã¦ã„ãã¾ã™ã€‚<br> ã¾ãš<code>init_tracing()</code>ã§tracing_subscriberã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> init_tracing</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#616e88>    // Configure otel exporter.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> tracer</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span><span> </span></span>
<span class=giallo-l><span>        opentelemetry_otlp</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new_pipeline</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#616e88>        // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>    };</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    // Compatible layer with tracing.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> otel_trace_layer</span><span style=color:#81a1c1> =</span><span> tracing_opentelemetry</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>layer</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>with_tracer</span><span style=color:#eceff4>(</span><span>tracer</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> otel_metrics_layer</span><span style=color:#81a1c1> =</span><span> tracing_opentelemetry</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>MetricsLayer</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>build_metrics_controller</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    use</span><span> tracing_subscriber</span><span style=color:#81a1c1>::</span><span>layer</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>SubscriberExt</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    use</span><span> tracing_subscriber</span><span style=color:#81a1c1>::</span><span>util</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>SubscriberInitExt</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>    tracing_subscriber</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Registry</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>with</span><span style=color:#eceff4>(</span><span>tracing_subscriber</span><span style=color:#81a1c1>::</span><span>fmt</span><span style=color:#81a1c1>::</span><span>Layer</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>with_ansi</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>true</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>with</span><span style=color:#eceff4>(</span><span>otel_trace_layer</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>with</span><span style=color:#eceff4>(</span><span>otel_metrics_layer</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>with</span><span style=color:#eceff4>(</span><span>tracing_subscriber</span><span style=color:#81a1c1>::</span><span>filter</span><span style=color:#81a1c1>::</span><span>LevelFilter</span><span style=color:#81a1c1>::</span><span>INFO</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>init</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>tracer = { /.../ }</code>ã®ç®‡æ‰€ã¯å¾Œè¿°ã—ã¾ã™ã€‚è¡Œã£ã¦ã„ã‚‹ã“ã¨ã¯ä»¥ä¸‹ã§ã™ã€‚<ol><li><code>opentelemetry_otlp::new_pipeline()</code>ã§traceã‚’collectorã«å‡ºåŠ›ã™ã‚‹gRPCè¨­å®šã‚’è¡Œã†<li><code>tracing_opentelemetry::layer()</code>ã§tracing-subscriberã«composeã™ã‚‹<li><code>tracing_opentelemetry::MetricsLayer::new()</code>ã§metricsã«é–¢ã—ã¦ã‚‚åŒæ§˜ã«è¨­å®šã™ã‚‹<li><code>tracing_subscriber</code>ã§Registryã‚’åˆæœŸåŒ–ã™ã‚‹<li>Registryã«å¿…è¦ãªæ©Ÿèƒ½(layer)ã‚’composeã—ã¦ã„ã</ol><p><code>tracing_opentelemetry</code>ãŒtracingã¨opentelemetryã‚’ã¤ãªãlayerã‚’æä¾›ã—ã¦ãã‚Œã¦ã„ã¾ã™ã€‚<br> tracingã‚’ã©ã†collectorã«æ¸¡ã™ã‹ã¯ä»¥ä¸‹ã®ç®‡æ‰€ã§è¨­å®šã—ã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>let</span><span> tracer</span><span style=color:#81a1c1> =</span><span> opentelemetry_otlp</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new_pipeline</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>    .</span><span style=color:#88c0d0>tracing</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>    .</span><span style=color:#88c0d0>with_exporter</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>        opentelemetry_otlp</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new_exporter</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>tonic</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>with_endpoint</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>http://localhost:4317</span><span style=color:#eceff4>"),</span></span>
<span class=giallo-l><span style=color:#eceff4>    )</span></span>
<span class=giallo-l><span style=color:#81a1c1>    .</span><span style=color:#88c0d0>with_trace_config</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>        opentelemetry</span><span style=color:#81a1c1>::</span><span>sdk</span><span style=color:#81a1c1>::</span><span>trace</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>config</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>with_sampler</span><span style=color:#eceff4>(</span><span>opentelemetry</span><span style=color:#81a1c1>::</span><span>sdk</span><span style=color:#81a1c1>::</span><span>trace</span><span style=color:#81a1c1>::</span><span>Sampler</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>AlwaysOn</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>with_id_generator</span><span style=color:#eceff4>(</span><span>opentelemetry</span><span style=color:#81a1c1>::</span><span>sdk</span><span style=color:#81a1c1>::</span><span>trace</span><span style=color:#81a1c1>::</span><span>RandomIdGenerator</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>())</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>with_resource</span><span style=color:#eceff4>(</span><span>opentelemetry</span><span style=color:#81a1c1>::</span><span>sdk</span><span style=color:#81a1c1>::</span><span>Resource</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span style=color:#88c0d0;font-weight:700>vec!</span><span style=color:#eceff4>[</span><span>opentelemetry</span><span style=color:#81a1c1>::</span><span>KeyValue</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>                "</span><span style=color:#a3be8c>service.name</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>                "</span><span style=color:#a3be8c>sample-app</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>            )]))</span></span>
<span class=giallo-l><span style=color:#eceff4>        ,</span></span>
<span class=giallo-l><span style=color:#eceff4>    )</span></span>
<span class=giallo-l><span style=color:#81a1c1>    .</span><span style=color:#88c0d0>install_batch</span><span style=color:#eceff4>(</span><span>opentelemetry</span><span style=color:#81a1c1>::</span><span>runtime</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Tokio</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>    .</span><span style=color:#88c0d0>expect</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Not running in tokio runtime</span><span style=color:#eceff4>");</span></span></code></pre><p>ä»Šå›ã¯httpã§ã¯ãªãgRPCæ¥ç¶š(tonic)ã‚’é¸æŠã—ã¾ã—ãŸã€‚<br> <code>install_batch()</code>ã‚’è¡Œã†ã¨<code>opentelemetry_sdk::BatchSpanProcessorInternal::run()</code>ãŒ<code>tokio::spawn</code>ã§å®Ÿè¡Œã•ã‚Œã€5ç§’ã«ä¸€å›(ã‚‚ã—ãã¯æœ€å¤§traceæ•°ã«é”ã—ãŸã„å ´åˆ)ã«gRPC requestã§collectorã«é€ä¿¡ã•ã‚Œã¾ã™ã€‚<br> https://github.com/open-telemetry/opentelemetry-rust/blob/d4b9befea04bcc7fc19319a6ebf5b5070131c486/opentelemetry-sdk/src/trace/span_processor.rs#L461<br> ã¡ãªã¿ã«5ç§’ã«ä¸€å›ã®è¨­å®šå€¤ã¯defaultå€¤ã¨ã—ã¦<a href=https://opentelemetry.io/docs/reference/specification/sdk-environment-variables/#batch-span-processor rel=external>ä»•æ§˜</a>ã§å®šã‚ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚<br> ã“ã®ã‚ãŸã‚Šã®SDKã®æŒ™å‹•ã¾ã§ä»•æ§˜ã§æ±ºã‚ã¦ã„ã‚‹ã®ã§ã€Rustã ã¨5ç§’ã«ä¸€å›ã ã‘ã©ä»–ã®è¨€èªã ã¨é–“éš”ãŒé•ã†ã¿ãŸã„ãªè©±ãŒãªã•ãã†ã§å®‰å¿ƒæ„Ÿã‚ã‚Šã¾ã™ã€‚<p>metricsã«é–¢ã™ã‚‹è¨­å®šé …ç›®ã¯ä»¥ä¸‹ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> opentelemetry</span><span style=color:#81a1c1>::</span><span>sdk</span><span style=color:#81a1c1>::</span><span>metrics</span><span style=color:#81a1c1>::</span><span>controllers</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>BasicController</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>// https://github.com/open-telemetry/opentelemetry-rust/blob/d4b9befea04bcc7fc19319a6ebf5b5070131c486/examples/basic-otlp/src/main.rs#L35-L52</span></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> build_metrics_controller</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> BasicController</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    opentelemetry_otlp</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new_pipeline</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>metrics</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>            opentelemetry</span><span style=color:#81a1c1>::</span><span>sdk</span><span style=color:#81a1c1>::</span><span>metrics</span><span style=color:#81a1c1>::</span><span>selectors</span><span style=color:#81a1c1>::</span><span>simple</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>histogram</span><span style=color:#eceff4>(</span><span>Vec</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>()),</span></span>
<span class=giallo-l><span>            opentelemetry</span><span style=color:#81a1c1>::</span><span>sdk</span><span style=color:#81a1c1>::</span><span>export</span><span style=color:#81a1c1>::</span><span>metrics</span><span style=color:#81a1c1>::</span><span>aggregation</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>cumulative_temporality_selector</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>            opentelemetry</span><span style=color:#81a1c1>::</span><span>runtime</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Tokio</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>        )</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>with_exporter</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>            opentelemetry_otlp</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new_exporter</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>                .</span><span style=color:#88c0d0>tonic</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>                .</span><span style=color:#88c0d0>with_endpoint</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>http://localhost:4317</span><span style=color:#eceff4>"),</span></span>
<span class=giallo-l><span style=color:#eceff4>        )</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>build</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>expect</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Failed to build metrics controller</span><span style=color:#eceff4>")</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>Controllerã ã£ãŸã‚Šã€selector,aggregationã¨ã„ã£ãŸmetricsã®æ¦‚å¿µã‚’æŠŠæ¡ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€ã¾ã å®Ÿè£…ã‚’èª­ã‚ã¦ãŠã‚‰ãšä»Šå¾Œã®èª²é¡Œã§ã™ã€‚<h3 id=opentelemetry-collector><a aria-label="Anchor link for: opentelemetry-collector" class=zola-anchor href=#opentelemetry-collector>opentelemetry-collector</a></h3><p>æ¬¡ã¯rustã‹ã‚‰å‡ºåŠ›ã—ãŸtraceã‚’å—ã‘å–ã£ã¦backendã«exportã™ã‚‹collectorã‚’å‹•ã‹ã—ã¾ã™ã€‚<br> ä»¥ä¸‹ãŒdocker-composeã®è¨­å®šã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=yaml><span class=giallo-l><span style=color:#8fbcbb>version</span><span style=color:#eceff4>: '</span><span style=color:#a3be8c>3.9</span><span style=color:#eceff4>'</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>services</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  otel-collector</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    image</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> otel/opentelemetry-collector-contrib:0.66.0</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    command</span><span style=color:#eceff4>: [ "</span><span style=color:#a3be8c>--config=/etc/otel-collector-config.yaml</span><span style=color:#eceff4>" ]</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    volumes</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#eceff4>      -</span><span style=color:#a3be8c> ./otel-collector-config.yaml:/etc/otel-collector-config.yaml</span></span>
<span class=giallo-l><span style=color:#eceff4>      -</span><span style=color:#a3be8c> certs:/usr/share/otel/config/certs</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    ports</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#eceff4>      - "</span><span style=color:#a3be8c>4317:4317</span><span style=color:#eceff4>"</span><span style=color:#616e88>   # OTLP gRPC receiver</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    depends_on</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      elasticsearch</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        condition</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> service_healthy</span></span></code></pre><p>è¨­å®šfileã®<code>otel-collector-config.yaml</code>ã¯ä»¥ä¸‹ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=yaml><span class=giallo-l><span style=color:#616e88># https://github.com/open-telemetry/opentelemetry-collector/blob/main/receiver/otlpreceiver/README.md</span></span>
<span class=giallo-l><span style=color:#8fbcbb>receivers</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  otlp</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#616e88>    # Disable http</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    protocols</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      grpc</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        endpoint</span><span style=color:#eceff4>: "</span><span style=color:#a3be8c>0.0.0.0:4317</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>processors</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  batch</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88># https://github.com/open-telemetry/opentelemetry-collector/blob/main/exporter/README.md</span></span>
<span class=giallo-l><span style=color:#8fbcbb>exporters</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#616e88>  # https://github.com/open-telemetry/opentelemetry-collector/blob/main/exporter/loggingexporter/README.md</span></span>
<span class=giallo-l><span style=color:#616e88>  # Exports data to the console via zap.Logger</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  logging</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#616e88>    # loglevel is deprecated in favor of verbosity</span></span>
<span class=giallo-l><span style=color:#616e88>    # detailed | normal | basic</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    verbosity</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> detailed</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    sampling_initial</span><span style=color:#eceff4>:</span><span style=color:#b48ead> 5</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  otlp/elastic</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    endpoint</span><span style=color:#eceff4>: "</span><span style=color:#a3be8c>apm-server:8200</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    tls</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      ca_file</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> /usr/share/otel/config/certs/ca/ca.crt</span></span>
<span class=giallo-l><span style=color:#616e88>  # https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/exporter/prometheusexporter</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  prometheus</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    endpoint</span><span style=color:#eceff4>: "</span><span style=color:#a3be8c>0.0.0.0:8889</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  jaeger</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    endpoint</span><span style=color:#eceff4>: "</span><span style=color:#a3be8c>jaeger:14250</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    tls</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      insecure</span><span style=color:#eceff4>:</span><span style=color:#81a1c1> true</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>service</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  pipelines</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    traces</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      receivers</span><span style=color:#eceff4>: [</span><span style=color:#a3be8c>otlp</span><span style=color:#eceff4>]</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      processors</span><span style=color:#eceff4>: [</span><span style=color:#a3be8c>batch</span><span style=color:#eceff4>]</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      exporters</span><span style=color:#eceff4>: [</span><span style=color:#a3be8c>logging</span><span style=color:#eceff4>,</span><span style=color:#a3be8c> otlp/elastic</span><span style=color:#eceff4>,</span><span style=color:#a3be8c> jaeger</span><span style=color:#eceff4>]</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    metrics</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      receivers</span><span style=color:#eceff4>: [</span><span style=color:#a3be8c>otlp</span><span style=color:#eceff4>]</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      processors</span><span style=color:#eceff4>: [</span><span style=color:#a3be8c>batch</span><span style=color:#eceff4>]</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      exporters</span><span style=color:#eceff4>: [</span><span style=color:#a3be8c>logging</span><span style=color:#eceff4>,</span><span style=color:#a3be8c> otlp/elastic</span><span style=color:#eceff4>,</span><span style=color:#a3be8c> prometheus</span><span style=color:#eceff4>]</span></span></code></pre><p>è¨­å®šfileã®èª­ã¿æ–¹ã§ã™ãŒtop levelã§ã¯<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=yaml><span class=giallo-l><span style=color:#8fbcbb>receivers</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>processors</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>exporters</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>service</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  pipelines</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    traces</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      receivers</span><span style=color:#eceff4>: [</span><span style=color:#a3be8c>otlp</span><span style=color:#eceff4>]</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      processors</span><span style=color:#eceff4>: [</span><span style=color:#a3be8c>batch</span><span style=color:#eceff4>]</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      exporters</span><span style=color:#eceff4>: [</span><span style=color:#a3be8c>logging</span><span style=color:#eceff4>,</span><span style=color:#a3be8c> otlp/elastic</span><span style=color:#eceff4>,</span><span style=color:#a3be8c> jaeger</span><span style=color:#eceff4>]</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    metrics</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      receivers</span><span style=color:#eceff4>: [</span><span style=color:#a3be8c>otlp</span><span style=color:#eceff4>]</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      processors</span><span style=color:#eceff4>: [</span><span style=color:#a3be8c>batch</span><span style=color:#eceff4>]</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      exporters</span><span style=color:#eceff4>: [</span><span style=color:#a3be8c>logging</span><span style=color:#eceff4>,</span><span style=color:#a3be8c> otlp/elastic</span><span style=color:#eceff4>,</span><span style=color:#a3be8c> prometheus</span><span style=color:#eceff4>]</span></span></code></pre><p>ã®ã‚ˆã†ã«<code>receivers</code>, <code>processors</code>, <code>exportes</code>, <code>service</code>ã‚’å®šç¾©ã—ã¾ã™ã€‚<br> signalã®ç®‡æ‰€ã§ã‚‚è¨€åŠã—ãŸã‚ˆã†ã«opentelemetryã§ã¯trace,metrics,logsã‚’åˆ†ã‘ã¦è€ƒãˆã¾ã™ã€‚collectorã§ã¯ãã‚Œãã‚Œã®signalã‚’ã©ã†å‡¦ç†ã™ã‚‹ã‹ã‚’ãã‚Œãã‚Œè¨­å®šã—ã¾ã™ã€‚ã“ã‚Œã‚’è¨­å®šã™ã‚‹ã®ãŒã€<code>service.pipelines.{traces,metrics}</code>ã§ã™ã€‚<br> ä¸Šè¨˜ã®è¨­å®šã¯ã€traceã¯otlp(gRPC)ã§å…¥åŠ›ã‚’å—ã‘ä»˜ã‘ã€batchå‡¦ç†ã—ãŸã®ã¡ã€logging, elasticsearch, jaegerã«å‡ºåŠ›ã™ã‚‹ã€‚<br> metricsã‚‚otlpã§å—ã‘ä»˜ã‘ã‚‹ãŒå‡ºåŠ›å…ˆã¯ã€logging,elasticsearch, prometheusã¨èª­ã¿ã¾ã™ã€‚<br> ãã—ã¦ã€pipelinesã§å‚ç…§ã•ã‚ŒãŸreceivers, processors, exporterã®ãã‚Œãã‚Œã‚’è¨­å®šã‚’<code>exporter.otlp/elastic</code>ã®ã‚ˆã†ã«è¡Œã„ã¾ã™ã€‚ã¾ãŸã“ã“ã§ã€<code>otlp/elastic</code>ã¨ãªã£ã¦ã„ã¾ã™ãŒã“ã‚Œã¯<code>otlp</code> exporterã®è¨­å®šã§<code>elastic</code>ã®éƒ¨åˆ†ã¯è­˜åˆ¥å­ã§ã™ã€‚traceã¨metricsã§exportå…ˆãŒé•ã£ãŸã‚Šã™ã‚‹å ´åˆã«ã¯<code>otlp/aaa</code>ã¨<code>otlp/bbb</code>ã®ã‚ˆã†ã«ã§ãã¾ã™ãŒè­˜åˆ¥å­ã¯å¿…è¦ãªã„ãªã‚‰ä»˜ä¸ã—ãªãã¦ã‚‚å•é¡Œãªã„ã§ã™ã€‚<p>ä¸Šè¨˜ã®è¨­å®šã§ã¯<code>exporters.prometheus</code>ã®ã‚ˆã†ã«è¨­å®šã—ã¦ã„ã‚‹ã®ã§ã€collectorã®binaryã«ã¯prometheusç”¨ã®å‡¦ç†ãŒçµ„ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‚“ã ãªã¨æ€ã„ã¾ã™ãŒã€ä»–ã«ã¯ã©ã‚“ãªexporterãŒã„ã‚‹ã®ã‹ã‚„ã€é‹ç”¨ã™ã‚‹ã†ãˆã§ä¸è¦ãªä¾å­˜ã¯å–ã‚Šé™¤ããŸã„ã¨æ€ã„ã¾ã—ãŸã€‚<p>collectorã¯<a href=https://github.com/open-telemetry/opentelemetry-collector-releases rel=external>opentelemetry-collector-releases</a> repositoryã§ç®¡ç†ã•ã‚Œã¦ã„ã¾ã™ã€‚<br> ã“ã“ã«<code>distributions</code>ã¨ã„ã†å½¢ã§<code>otelcol</code>ã¨<code>otelcol-contrib</code>ã®äºŒã¤ã®å½¢æ…‹ãŒã‚ã‚Šã¾ã™ã€‚ãã‚Œãã‚Œ<code>manifest.yaml</code>ã‚’ã‚‚ã£ã¦ãŠã‚Šãã“ã«receiverã‚„exporterã§ä½•ãŒä½¿ãˆã‚‹ã‹ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚<br> ä¾‹ãˆã°ã€<code>otelcol</code>ã®<code>manifest.yaml</code>ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=yaml><span class=giallo-l><span style=color:#8fbcbb>dist</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  module</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> github.com/open-telemetry/opentelemetry-collector-releases/core</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  name</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> otelcol</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  description</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> OpenTelemetry Collector</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  version</span><span style=color:#eceff4>:</span><span style=color:#b48ead> 0.67.0</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  output_path</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> ./_build</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  otelcol_version</span><span style=color:#eceff4>:</span><span style=color:#b48ead> 0.67.0</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>receivers</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#eceff4>  -</span><span style=color:#8fbcbb> gomod</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> go.opentelemetry.io/collector/receiver/otlpreceiver v0.67.0</span></span>
<span class=giallo-l><span style=color:#eceff4>  -</span><span style=color:#8fbcbb> gomod</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> github.com/open-telemetry/opentelemetry-collector-contrib/receiver/hostmetricsreceiver v0.67.0</span></span>
<span class=giallo-l><span style=color:#eceff4>  -</span><span style=color:#8fbcbb> gomod</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> github.com/open-telemetry/opentelemetry-collector-contrib/receiver/jaegerreceiver v0.67.0</span></span>
<span class=giallo-l><span style=color:#eceff4>  -</span><span style=color:#8fbcbb> gomod</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> github.com/open-telemetry/opentelemetry-collector-contrib/receiver/kafkareceiver v0.67.0</span></span>
<span class=giallo-l><span style=color:#eceff4>  -</span><span style=color:#8fbcbb> gomod</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> github.com/open-telemetry/opentelemetry-collector-contrib/receiver/opencensusreceiver v0.67.0</span></span>
<span class=giallo-l><span style=color:#eceff4>  -</span><span style=color:#8fbcbb> gomod</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> github.com/open-telemetry/opentelemetry-collector-contrib/receiver/prometheusreceiver v0.67.0</span></span>
<span class=giallo-l><span style=color:#eceff4>  -</span><span style=color:#8fbcbb> gomod</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> github.com/open-telemetry/opentelemetry-collector-contrib/receiver/zipkinreceiver v0.67.0</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>exporters</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#eceff4>  -</span><span style=color:#8fbcbb> gomod</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> go.opentelemetry.io/collector/exporter/loggingexporter v0.67.0</span></span>
<span class=giallo-l><span style=color:#eceff4>  -</span><span style=color:#8fbcbb> gomod</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> go.opentelemetry.io/collector/exporter/otlpexporter v0.67.0</span></span>
<span class=giallo-l><span style=color:#eceff4>  -</span><span style=color:#8fbcbb> gomod</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> go.opentelemetry.io/collector/exporter/otlphttpexporter v0.67.0</span></span>
<span class=giallo-l><span style=color:#eceff4>  -</span><span style=color:#8fbcbb> gomod</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> github.com/open-telemetry/opentelemetry-collector-contrib/exporter/fileexporter v0.67.0</span></span>
<span class=giallo-l><span style=color:#eceff4>  -</span><span style=color:#8fbcbb> gomod</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> github.com/open-telemetry/opentelemetry-collector-contrib/exporter/jaegerexporter v0.67.0</span></span>
<span class=giallo-l><span style=color:#eceff4>  -</span><span style=color:#8fbcbb> gomod</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> github.com/open-telemetry/opentelemetry-collector-contrib/exporter/kafkaexporter v0.67.0</span></span>
<span class=giallo-l><span style=color:#eceff4>  -</span><span style=color:#8fbcbb> gomod</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> github.com/open-telemetry/opentelemetry-collector-contrib/exporter/opencensusexporter v0.67.0</span></span>
<span class=giallo-l><span style=color:#eceff4>  -</span><span style=color:#8fbcbb> gomod</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> github.com/open-telemetry/opentelemetry-collector-contrib/exporter/prometheusexporter v0.67.0</span></span>
<span class=giallo-l><span style=color:#eceff4>  -</span><span style=color:#8fbcbb> gomod</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> github.com/open-telemetry/opentelemetry-collector-contrib/exporter/prometheusremotewriteexporter v0.67.0</span></span>
<span class=giallo-l><span style=color:#eceff4>  -</span><span style=color:#8fbcbb> gomod</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> github.com/open-telemetry/opentelemetry-collector-contrib/exporter/zipkinexporter v0.67.0</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>extensions</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#eceff4>  -</span><span style=color:#8fbcbb> gomod</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> go.opentelemetry.io/collector/extension/zpagesextension v0.67.0</span></span>
<span class=giallo-l><span style=color:#eceff4>  -</span><span style=color:#8fbcbb> gomod</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> go.opentelemetry.io/collector/extension/ballastextension v0.67.0</span></span>
<span class=giallo-l><span style=color:#eceff4>  -</span><span style=color:#8fbcbb> gomod</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> github.com/open-telemetry/opentelemetry-collector-contrib/extension/healthcheckextension v0.67.0</span></span>
<span class=giallo-l><span style=color:#eceff4>  -</span><span style=color:#8fbcbb> gomod</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> github.com/open-telemetry/opentelemetry-collector-contrib/extension/pprofextension v0.67.0</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>processors</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#eceff4>  -</span><span style=color:#8fbcbb> gomod</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> go.opentelemetry.io/collector/processor/batchprocessor v0.67.0</span></span>
<span class=giallo-l><span style=color:#eceff4>  -</span><span style=color:#8fbcbb> gomod</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> go.opentelemetry.io/collector/processor/memorylimiterprocessor v0.67.0</span></span>
<span class=giallo-l><span style=color:#eceff4>  -</span><span style=color:#8fbcbb> gomod</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> github.com/open-telemetry/opentelemetry-collector-contrib/processor/attributesprocessor v0.67.0</span></span>
<span class=giallo-l><span style=color:#eceff4>  -</span><span style=color:#8fbcbb> gomod</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> github.com/open-telemetry/opentelemetry-collector-contrib/processor/resourceprocessor v0.67.0</span></span>
<span class=giallo-l><span style=color:#eceff4>  -</span><span style=color:#8fbcbb> gomod</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> github.com/open-telemetry/opentelemetry-collector-contrib/processor/spanprocessor v0.67.0</span></span>
<span class=giallo-l><span style=color:#eceff4>  -</span><span style=color:#8fbcbb> gomod</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> github.com/open-telemetry/opentelemetry-collector-contrib/processor/probabilisticsamplerprocessor v0.67.0</span></span>
<span class=giallo-l><span style=color:#eceff4>  -</span><span style=color:#8fbcbb> gomod</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> github.com/open-telemetry/opentelemetry-collector-contrib/processor/filterprocessor v0.67.0</span></span></code></pre><p><a href=https://github.com/open-telemetry/opentelemetry-collector-releases/blob/v0.67.0/distributions/otelcol/manifest.yaml rel=external>https://github.com/open-telemetry/opentelemetry-collector-releases/blob/v0.67.0/distributions/otelcol/manifest.yaml</a><p>ã“ã“ã‹ã‚‰ã€exporterã¨ã—ã¦ã€loggingã‚„prometheusãŒä½¿ãˆã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚<h4 id=logging-exporter><a aria-label="Anchor link for: logging-exporter" class=zola-anchor href=#logging-exporter>logging exporter</a></h4><p>collectorã®è¨­å®šã§<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=yaml><span class=giallo-l><span style=color:#8fbcbb>exporters</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#616e88>  # https://github.com/open-telemetry/opentelemetry-collector/blob/main/exporter/loggingexporter/README.md</span></span>
<span class=giallo-l><span style=color:#616e88>  # Exports data to the console via zap.Logger</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  logging</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#616e88>    # loglevel is deprecated in favor of verbosity</span></span>
<span class=giallo-l><span style=color:#616e88>    # detailed | normal | basic</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    verbosity</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> detailed</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    sampling_initial</span><span style=color:#eceff4>:</span><span style=color:#b48ead> 5</span></span></code></pre><p>ã¨è¨­å®šã—ãŸã®ã§ã€collectorã®logãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚ã•ãã»ã©rustã‹ã‚‰å‡ºåŠ›ã—ãŸdataã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªlogãŒç¢ºèªã§ãã¾ã—ãŸã€‚<br> å†—é•·ãªã®ã¯<code>verbosity: detailed</code>ã‚’è¨­å®šã—ã¦ã„ã‚‹ãŸã‚ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>opentelemetry-handson-otel-collector-1       | 2022-12-18T07:01:06.906Z info    TracesExporter  {"kind": "exporter", "data_type": "traces", "name": "logging", "#spans": 3}</span></span>
<span class=giallo-l><span>opentelemetry-handson-otel-collector-1       | 2022-12-18T07:01:06.908Z info    ResourceSpans #0</span></span>
<span class=giallo-l><span>opentelemetry-handson-otel-collector-1       | Resource SchemaURL: </span></span>
<span class=giallo-l><span>opentelemetry-handson-otel-collector-1       | Resource attributes:</span></span>
<span class=giallo-l><span>opentelemetry-handson-otel-collector-1       |      -> service.name: Str(sample-app)</span></span>
<span class=giallo-l><span>opentelemetry-handson-otel-collector-1       | ScopeSpans #0</span></span>
<span class=giallo-l><span>opentelemetry-handson-otel-collector-1       | ScopeSpans SchemaURL: </span></span>
<span class=giallo-l><span>opentelemetry-handson-otel-collector-1       | InstrumentationScope opentelemetry-otlp 0.11.0</span></span>
<span class=giallo-l><span>opentelemetry-handson-otel-collector-1       | Span #0</span></span>
<span class=giallo-l><span>opentelemetry-handson-otel-collector-1       |     Trace ID       : cb313713eb127ffe1be402e90114e6a3</span></span>
<span class=giallo-l><span>opentelemetry-handson-otel-collector-1       |     Parent ID      : fb0a1f530e69c856</span></span>
<span class=giallo-l><span>opentelemetry-handson-otel-collector-1       |     ID             : c4e1ff17ebe3b90b</span></span>
<span class=giallo-l><span>opentelemetry-handson-otel-collector-1       |     Name           : auth</span></span>
<span class=giallo-l><span>opentelemetry-handson-otel-collector-1       |     Kind           : Internal</span></span>
<span class=giallo-l><span>opentelemetry-handson-otel-collector-1       |     Start time     : 2022-12-18 07:01:01.837864 +0000 UTC</span></span>
<span class=giallo-l><span>opentelemetry-handson-otel-collector-1       |     End time       : 2022-12-18 07:01:01.838038 +0000 UTC</span></span>
<span class=giallo-l><span>opentelemetry-handson-otel-collector-1       |     Status code    : Unset</span></span>
<span class=giallo-l><span>opentelemetry-handson-otel-collector-1       |     Status message : </span></span>
<span class=giallo-l><span>opentelemetry-handson-otel-collector-1       | Attributes:</span></span>
<span class=giallo-l><span>opentelemetry-handson-otel-collector-1       |      -> user: Str(ymgyt)</span></span>
<span class=giallo-l><span>opentelemetry-handson-otel-collector-1       |      -> thread.id: Int(1)</span></span>
<span class=giallo-l><span>opentelemetry-handson-otel-collector-1       |      -> code.namespace: Str(opentelemetry_handson)</span></span>
<span class=giallo-l><span>opentelemetry-handson-otel-collector-1       |      -> thread.name: Str(main)</span></span>
<span class=giallo-l><span>opentelemetry-handson-otel-collector-1       |      -> idle_ns: Int(43166)</span></span>
<span class=giallo-l><span>opentelemetry-handson-otel-collector-1       |      -> busy_ns: Int(117000)</span></span>
<span class=giallo-l><span>opentelemetry-handson-otel-collector-1       |      -> code.lineno: Int(64)</span></span>
<span class=giallo-l><span>opentelemetry-handson-otel-collector-1       |      -> code.filepath: Str(src/main.rs)</span></span>
<span class=giallo-l><span>opentelemetry-handson-otel-collector-1       | Events:</span></span>
<span class=giallo-l><span>opentelemetry-handson-otel-collector-1       | SpanEvent #0</span></span>
<span class=giallo-l><span>opentelemetry-handson-otel-collector-1       |      -> Name: successfully completed</span></span>
<span class=giallo-l><span>opentelemetry-handson-otel-collector-1       |      -> Timestamp: 2022-12-18 07:01:01.837949 +0000 UTC</span></span>
<span class=giallo-l><span>opentelemetry-handson-otel-collector-1       |      -> DroppedAttributesCount: 0</span></span>
<span class=giallo-l><span>opentelemetry-handson-otel-collector-1       |      -> Attributes::</span></span>
<span class=giallo-l><span>opentelemetry-handson-otel-collector-1       |           -> level: Str(INFO)</span></span>
<span class=giallo-l><span>opentelemetry-handson-otel-collector-1       |           -> target: Str(opentelemetry_handson)</span></span>
<span class=giallo-l><span>opentelemetry-handson-otel-collector-1       |           -> ops: Str(xxx)</span></span>
<span class=giallo-l><span>opentelemetry-handson-otel-collector-1       |           -> counter.ops_count: Int(10)</span></span>
<span class=giallo-l><span>opentelemetry-handson-otel-collector-1       |           -> code.filepath: Str(src/main.rs)</span></span>
<span class=giallo-l><span>opentelemetry-handson-otel-collector-1       |           -> code.namespace: Str(opentelemetry_handson)</span></span>
<span class=giallo-l><span>opentelemetry-handson-otel-collector-1       |           -> code.lineno: Int(71)</span></span></code></pre><h3 id=backend><a aria-label="Anchor link for: backend" class=zola-anchor href=#backend>backend</a></h3><p>æœ€å¾Œã«collectorãŒtraceæƒ…å ±ã‚’exportã™ã‚‹backendã‚’ç«‹ã¡ä¸Šã’ã¾ã™ã€‚<br> ä»¥ä¸‹ãŒ<code>docker-compose.yaml</code>ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=yaml><span class=giallo-l><span style=color:#8fbcbb>version</span><span style=color:#eceff4>: '</span><span style=color:#a3be8c>3.9</span><span style=color:#eceff4>'</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>services</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  otel-collector</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    image</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> otel/opentelemetry-collector-contrib:0.66.0</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    command</span><span style=color:#eceff4>: [ "</span><span style=color:#a3be8c>--config=/etc/otel-collector-config.yaml</span><span style=color:#eceff4>" ]</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    volumes</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#eceff4>      -</span><span style=color:#a3be8c> ./otel-collector-config.yaml:/etc/otel-collector-config.yaml</span></span>
<span class=giallo-l><span style=color:#eceff4>      -</span><span style=color:#a3be8c> certs:/usr/share/otel/config/certs</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    ports</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#eceff4>      - "</span><span style=color:#a3be8c>4317:4317</span><span style=color:#eceff4>"</span><span style=color:#616e88>   # OTLP gRPC receiver</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    depends_on</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      elasticsearch</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        condition</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> service_healthy</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>  setup_elasticsearch</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    image</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> docker.elastic.co/elasticsearch/elasticsearch:8.5.2</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    volumes</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#eceff4>      -</span><span style=color:#a3be8c> certs:/usr/share/elasticsearch/config/certs</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    user</span><span style=color:#eceff4>: "</span><span style=color:#a3be8c>0</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    command</span><span style=color:#eceff4>:</span><span style=color:#81a1c1> ></span></span>
<span class=giallo-l><span style=color:#a3be8c>      bash -c '</span></span>
<span class=giallo-l><span style=color:#a3be8c>        if [ ! -f config/certs/ca.zip ]; then</span></span>
<span class=giallo-l><span style=color:#a3be8c>          echo "Creating CA";</span></span>
<span class=giallo-l><span style=color:#a3be8c>          bin/elasticsearch-certutil ca --silent --pem -out config/certs/ca.zip;</span></span>
<span class=giallo-l><span style=color:#a3be8c>          unzip config/certs/ca.zip -d config/certs;</span></span>
<span class=giallo-l><span style=color:#a3be8c>        fi;</span></span>
<span class=giallo-l><span style=color:#a3be8c>        if [ ! -f config/certs/certs.zip ]; then</span></span>
<span class=giallo-l><span style=color:#a3be8c>          echo "Creating certs";</span></span>
<span class=giallo-l><span style=color:#a3be8c>          echo -ne \</span></span>
<span class=giallo-l><span style=color:#a3be8c>          "instances:\n"\</span></span>
<span class=giallo-l><span style=color:#a3be8c>          "  - name: elasticsearch\n"\</span></span>
<span class=giallo-l><span style=color:#a3be8c>          "    dns:\n"\</span></span>
<span class=giallo-l><span style=color:#a3be8c>          "      - elasticsearch\n"\</span></span>
<span class=giallo-l><span style=color:#a3be8c>          "      - localhost\n"\</span></span>
<span class=giallo-l><span style=color:#a3be8c>          "    ip:\n"\</span></span>
<span class=giallo-l><span style=color:#a3be8c>          "      - 127.0.0.1\n"\</span></span>
<span class=giallo-l><span style=color:#a3be8c>          > config/certs/instances.yml;</span></span>
<span class=giallo-l><span style=color:#a3be8c>          bin/elasticsearch-certutil cert --silent --pem -out config/certs/certs.zip --in config/certs/instances.yml --ca-cert config/certs/ca/ca.crt --ca-key config/certs/ca/ca.key;</span></span>
<span class=giallo-l><span style=color:#a3be8c>          unzip config/certs/certs.zip -d config/certs;</span></span>
<span class=giallo-l><span style=color:#a3be8c>        fi;</span></span>
<span class=giallo-l><span style=color:#a3be8c>        if [ ! -f config/certs/certs-apm.zip ]; then</span></span>
<span class=giallo-l><span style=color:#a3be8c>          echo "Creating certs for apm";</span></span>
<span class=giallo-l><span style=color:#a3be8c>          echo -ne \</span></span>
<span class=giallo-l><span style=color:#a3be8c>          "instances:\n"\</span></span>
<span class=giallo-l><span style=color:#a3be8c>          "  - name: apm-server\n"\</span></span>
<span class=giallo-l><span style=color:#a3be8c>          "    dns:\n"\</span></span>
<span class=giallo-l><span style=color:#a3be8c>          "      - apm-server\n"\</span></span>
<span class=giallo-l><span style=color:#a3be8c>          "      - localhost\n"\</span></span>
<span class=giallo-l><span style=color:#a3be8c>          "    ip:\n"\</span></span>
<span class=giallo-l><span style=color:#a3be8c>          "      - 127.0.0.1\n"\</span></span>
<span class=giallo-l><span style=color:#a3be8c>          > config/certs/instances-apm.yml;</span></span>
<span class=giallo-l><span style=color:#a3be8c>          bin/elasticsearch-certutil cert --silent --pem -out config/certs/certs-apm.zip --in config/certs/instances-apm.yml --ca-cert config/certs/ca/ca.crt --ca-key config/certs/ca/ca.key;</span></span>
<span class=giallo-l><span style=color:#a3be8c>          unzip config/certs/certs-apm.zip -d config/certs;</span></span>
<span class=giallo-l><span style=color:#a3be8c>        fi;</span></span>
<span class=giallo-l><span style=color:#a3be8c>        echo "Setting file permissions"</span></span>
<span class=giallo-l><span style=color:#a3be8c>        chown -R root:root config/certs;</span></span>
<span class=giallo-l><span style=color:#a3be8c>        find . -type d -exec chmod 750 \{\} \;;</span></span>
<span class=giallo-l><span style=color:#a3be8c>        find . -type f -exec chmod 640 \{\} \;;</span></span>
<span class=giallo-l><span style=color:#a3be8c>        echo "Waiting for Elasticsearch availability";</span></span>
<span class=giallo-l><span style=color:#a3be8c>        until curl -s --cacert config/certs/ca/ca.crt https://elasticsearch:9200 | grep -q "missing authentication credentials"; do sleep 30; done;</span></span>
<span class=giallo-l><span style=color:#a3be8c>        echo "Setting kibana_system password";</span></span>
<span class=giallo-l><span style=color:#a3be8c>        until curl -s -X POST --cacert config/certs/ca/ca.crt -u elastic:password -H "Content-Type: application/json" https://elasticsearch:9200/_security/user/kibana_system/_password -d "{\"password\":\"password\"}" | grep -q "^{}"; do sleep 10; done;</span></span>
<span class=giallo-l><span style=color:#a3be8c>        echo "All done!";</span></span>
<span class=giallo-l><span style=color:#a3be8c>      '</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    healthcheck</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      test</span><span style=color:#eceff4>: ["</span><span style=color:#a3be8c>CMD-SHELL</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>[ -f config/certs/elasticsearch/elasticsearch.crt ]</span><span style=color:#eceff4>"]</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      interval</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> 10s</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      timeout</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> 10s</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      retries</span><span style=color:#eceff4>:</span><span style=color:#b48ead> 120</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>  elasticsearch</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    depends_on</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      setup_elasticsearch</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        condition</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> service_healthy</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    image</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> docker.elastic.co/elasticsearch/elasticsearch:8.5.2</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    volumes</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#eceff4>      -</span><span style=color:#a3be8c> certs:/usr/share/elasticsearch/config/certs</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    ports</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#eceff4>      - "</span><span style=color:#a3be8c>9200:9200</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    environment</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#eceff4>      -</span><span style=color:#a3be8c> ELASTIC_PASSWORD=password</span></span>
<span class=giallo-l><span style=color:#eceff4>      -</span><span style=color:#a3be8c> bootstrap.memory_lock=true</span></span>
<span class=giallo-l><span style=color:#eceff4>      -</span><span style=color:#a3be8c> xpack.security.enabled=true</span></span>
<span class=giallo-l><span style=color:#eceff4>      -</span><span style=color:#a3be8c> xpack.security.authc.api_key.enabled</span></span>
<span class=giallo-l><span style=color:#eceff4>      -</span><span style=color:#a3be8c> xpack.security.http.ssl.enabled=true</span></span>
<span class=giallo-l><span style=color:#eceff4>      -</span><span style=color:#a3be8c> xpack.security.http.ssl.key=certs/elasticsearch/elasticsearch.key</span></span>
<span class=giallo-l><span style=color:#eceff4>      -</span><span style=color:#a3be8c> xpack.security.http.ssl.certificate=certs/elasticsearch/elasticsearch.crt</span></span>
<span class=giallo-l><span style=color:#eceff4>      -</span><span style=color:#a3be8c> xpack.security.http.ssl.certificate_authorities=certs/ca/ca.crt</span></span>
<span class=giallo-l><span style=color:#eceff4>      -</span><span style=color:#a3be8c> xpack.security.http.ssl.verification_mode=certificate</span></span>
<span class=giallo-l><span style=color:#eceff4>      -</span><span style=color:#a3be8c> discovery.type=single-node</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    ulimits</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      memlock</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        soft</span><span style=color:#eceff4>:</span><span style=color:#b48ead> -1</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        hard</span><span style=color:#eceff4>:</span><span style=color:#b48ead> -1</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    healthcheck</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      test</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#eceff4>        [</span></span>
<span class=giallo-l><span style=color:#eceff4>          "</span><span style=color:#a3be8c>CMD-SHELL</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>          "</span><span style=color:#a3be8c>curl -s --cacert config/certs/ca/ca.crt https://localhost:9200 | grep -q 'missing authentication credentials'</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>        ]</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      interval</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> 10s</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      timeout</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> 10s</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      retries</span><span style=color:#eceff4>:</span><span style=color:#b48ead> 120</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>  kibana</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    depends_on</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      elasticsearch</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        condition</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> service_healthy</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    image</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> docker.elastic.co/kibana/kibana:8.5.2</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    volumes</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#eceff4>      -</span><span style=color:#a3be8c> certs:/usr/share/kibana/config/certs</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    ports</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#eceff4>      - "</span><span style=color:#a3be8c>5601:5601</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    environment</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#eceff4>      -</span><span style=color:#a3be8c> ELASTICSEARCH_HOSTS=https://elasticsearch:9200</span></span>
<span class=giallo-l><span style=color:#eceff4>      -</span><span style=color:#a3be8c> ELASTICSEARCH_USERNAME=kibana_system</span></span>
<span class=giallo-l><span style=color:#eceff4>      -</span><span style=color:#a3be8c> ELASTICSEARCH_PASSWORD=password</span></span>
<span class=giallo-l><span style=color:#eceff4>      -</span><span style=color:#a3be8c> ELASTICSEARCH_SSL_CERTIFICATEAUTHORITIES=config/certs/ca/ca.crt</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>  apm-server</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    image</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> docker.elastic.co/apm/apm-server:8.5.2</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    cap_add</span><span style=color:#eceff4>: ["</span><span style=color:#a3be8c>CHOWN</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>DAC_OVERRIDE</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>SETGID</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>SETUID</span><span style=color:#eceff4>"]</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    cap_drop</span><span style=color:#eceff4>: ["</span><span style=color:#a3be8c>ALL</span><span style=color:#eceff4>"]</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    volumes</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#eceff4>      -</span><span style=color:#a3be8c> certs:/usr/share/apm-server/config/certs</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    ports</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#eceff4>      - "</span><span style=color:#a3be8c>8200:8200</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    command</span><span style=color:#eceff4>:</span><span style=color:#81a1c1> ></span></span>
<span class=giallo-l><span style=color:#a3be8c>      apm-server -e</span></span>
<span class=giallo-l><span style=color:#a3be8c>        -E apm-server.rum.enabled=true</span></span>
<span class=giallo-l><span style=color:#a3be8c>        -E setup.kibana.host=kibana:5601</span></span>
<span class=giallo-l><span style=color:#a3be8c>        -E setup.template.settings.index.number_of_replicas=0</span></span>
<span class=giallo-l><span style=color:#a3be8c>        -E apm-server.kibana.enabled=true</span></span>
<span class=giallo-l><span style=color:#a3be8c>        -E apm-server.kibana.host=kibana:5601</span></span>
<span class=giallo-l><span style=color:#a3be8c>        -E apm-server.kibana.username=kibana_system</span></span>
<span class=giallo-l><span style=color:#a3be8c>        -E apm-server.kibana.password=password</span></span>
<span class=giallo-l><span style=color:#a3be8c>        -E output.elasticsearch.hosts=["https://elasticsearch:9200"]</span></span>
<span class=giallo-l><span style=color:#a3be8c>        -E output.elasticsearch.username=elastic</span></span>
<span class=giallo-l><span style=color:#a3be8c>        -E output.elasticsearch.password=password</span></span>
<span class=giallo-l><span style=color:#a3be8c>        -E output.elasticsearch.ssl.certificate_authorities=["config/certs/ca/ca.crt"]</span></span>
<span class=giallo-l><span style=color:#a3be8c>        -E apm-server.ssl.enabled=true</span></span>
<span class=giallo-l><span style=color:#a3be8c>        -E apm-server.ssl.certificate="config/certs/apm-server/apm-server.crt"</span></span>
<span class=giallo-l><span style=color:#a3be8c>        -E apm-server.ssl.key="config/certs/apm-server/apm-server.key"</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    healthcheck</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      interval</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> 10s</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      retries</span><span style=color:#eceff4>:</span><span style=color:#b48ead> 12</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      test</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> curl --write-out 'HTTP %{http_code}' --fail --silent --output /dev/null http://localhost:8200/</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>  prometheus</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    image</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> prom/prometheus:v2.40.5</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    command</span><span style=color:#eceff4>: ["</span><span style=color:#a3be8c>--config.file=/etc/prometheus/prometheus.yaml</span><span style=color:#eceff4>"]</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    volumes</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#eceff4>      -</span><span style=color:#a3be8c> ./prometheus.yaml:/etc/prometheus/prometheus.yaml</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    ports</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#eceff4>      - "</span><span style=color:#a3be8c>9090:9090</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>  jaeger</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    image</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> jaegertracing/all-in-one:1.40.0</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    ports</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#eceff4>      - "</span><span style=color:#a3be8c>16686:16686</span><span style=color:#eceff4>"</span><span style=color:#616e88> # UI</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>volumes</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  certs</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    driver</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> local</span></span></code></pre><p>exportå…ˆã¨ã—ã¦<ul><li>elasticsearch <ul><li>apm-server, elasticsearch, kibana</ul><li>prometheus<li>jaeger ã‚’è¨­å®šã—ã¦ã„ã¾ã™ã€‚</ul><p>ãã‚Œãã‚Œã®UIã‚‚ç«‹ã¡ä¸Šã’ã¦ã„ã‚‹ã®ã§ã€ä»¥ä¸‹ã©ã‚“ãªæ„Ÿã˜ã§è¦‹ã‚ŒãŸã‹ã®SSã‚’è²¼ã‚Šã¾ã™ã€‚<h4 id=elasticsearch><a aria-label="Anchor link for: elasticsearch" class=zola-anchor href=#elasticsearch>elasticsearch</a></h4><p><code>localhost:5601</code>ã«kibanaãŒç«‹ã¡ä¸ŠãŒã£ã¦ã„ã¾ã™ã€‚loginã®credentialã¯<code>elastic/password</code>ã§ã™ã€‚<br> APM Agentã‚’UIã‹ã‚‰installã—ãŸã®ã¡(ã“ã®è¨­å®šãŒKibanaã®GUIã‹ã‚‰ã—ã‹è¡Œãˆãªã„ã®ãŒå¤§å¤‰ãªãƒã‚¤ãƒŠã‚¹ãƒã‚¤ãƒ³ãƒˆã§ãªã‚“ã¨ã‹ãªã‚‰ãªã„ã‹ã¨æ€ã£ã¦ã„ã¾ã™)<p>Observability > APM > Tracesã‚’é¸æŠã™ã‚‹ã¨<figure><div class=fig-images-row><img , alt src=images/otel_kibana_ss_1.png></div></figure><p>request traceãŒã§ã¦ã„ã‚‹ã®ã§é¸æŠã—ã¾ã™ã€‚<figure><div class=fig-images-row><img , alt src=images/otel_kibana_ss_2.png></div></figure><figure><div class=fig-images-row><img , alt src=images/otel_kibana_ss_3.png></div></figure><p>ç„¡äº‹traceãŒexportã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚<h4 id=jaeger><a aria-label="Anchor link for: jaeger" class=zola-anchor href=#jaeger>jaeger</a></h4><p>jaegerã¯<code>localhost:16686</code>ã‹ã‚‰ç¢ºèªã§ãã¾ã™<figure><div class=fig-images-row><img , alt src=images/otel_jaeger.png></div></figure><h4 id=prometheus><a aria-label="Anchor link for: prometheus" class=zola-anchor href=#prometheus>prometheus</a></h4><p>prometheusã®UIã¯<code>localhost:9090</code>ã‹ã‚‰ç¢ºèªã§ãã¾ã™ã€‚<figure><div class=fig-images-row><img , alt src=images/otel_prometheus.png></div></figure><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#88c0d0;font-weight:700>info!</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>    ops</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>xxx</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span>    counter</span><span style=color:#81a1c1>.</span><span>ops_count </span><span style=color:#81a1c1>=</span><span style=color:#b48ead> 10</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    "</span><span style=color:#a3be8c>successfully completed</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#eceff4>);</span></span></code></pre><p>ã®ã‚ˆã†ã«å‡ºåŠ›ã™ã‚‹ã¨ã€<code>counter</code> prefixãŒmetricsã¨ã—ã¦å¤‰æ›ã•ã‚Œã‚‹ã®ãŒ<code>tracing_opentelemetry</code>ã®ä»•æ§˜ã®ã‚ˆã†ã§ã™ã€‚<br> ã“ã®ã‚ãŸã‚Šã®å¤‰æ›ã®ä»•çµ„ã¿ã®ç†è§£ã¯ä»Šå¾Œã®èª²é¡Œã§ã™ã€‚<br> prometheusã‹ã‚‰<code>ops_count</code> metricsãŒç¢ºèªã§ãã¾ã—ãŸã€‚<h2 id=matome><a aria-label="Anchor link for: matome" class=zola-anchor href=#matome>ã¾ã¨ã‚</a></h2><p>Opentelemetryã®æ¦‚è¦ã‚’ç†è§£ã§ãã¾ã—ãŸã€‚<br> log,trace,metricsãŒinfra/applicationå…±é€šã§å‡¦ç†ã§ãã€application codeã‹ã‚‰vendorä¾å­˜ã®å‡¦ç†ãŒ(otelä»¥å¤–)å–ã‚Šé™¤ã‘ã‚‹ã®ã¯ã¨ã¦ã‚‚é­…åŠ›çš„ã§ã™ã€‚<br> ä¾‹ãˆã°observabilityåŸºç›¤ã‚’elasticsearch &lt;-> datadogã«å¤‰æ›´ã®ã‚ˆã†ãªã“ã¨ãŒcollectorã®è¨­å®šfileã ã‘ã§å¯¾å¿œã§ãã¾ã™ã—ã€ä¸¦è¡Œç¨¼åƒã‚‚å®¹æ˜“ãã†ã§ã™ã€‚<br> Rustã«ãŠã‘ã‚‹å°å…¥ã¯tracing ecosystemã‚’å‰æã«tracing-opentelemetryã§è¡Œã†ã®ãŒãƒ™ã‚¹ãƒˆã¨ã„ã†ã®ãŒè‡ªåˆ†ã®è€ƒãˆã§ã™ãŒã€metricsã®è¡¨ç¾åŠ›ç­‰ãŒå®Ÿé‹ç”¨ã«è€ãˆã‚‹ã‹ã¾ã è¦‹ãˆã¦ã„ã¾ã›ã‚“ã€‚<br> çµå±€ã¯otel + Î±ã«ãªã£ã¦ã—ã¾ã£ã¦ã¯ç®¡ç†ã™ã‚‹ã‚³ã‚¹ãƒˆã‚’ä¸‹ã’ã‚‹ç‹™ã„ãŒæœãŸã›ãªã„ã®ã§ecosystemã®å……å®ŸãŒãƒã‚¤ãƒ³ãƒˆã ã¨æ€ã„ã¾ã™ã€‚<br> ã“ã®ç‚¹ã«ã¤ã„ã¦ã¯ãŸã æœŸå¾…ã™ã‚‹ã®ã§ã¯ãªãtracing projectã«contributeã§ããªã„ã‹ã¨æ€ã£ã¦ã„ãŸã‚Šã—ã¾ã™ã€‚<br> tracingã®exportå‡¦ç†ã«ã¤ã„ã¦ã¯å®Ÿè£…ã‚’èª­ã‚“ã§æ¦‚è¦ã¯ç†è§£ã§ããŸã®ã§ã™ãŒã“ã“ã«æ›¸ãã¨è¨˜äº‹ã®é•·ã•ãŒ2å€ã«ãªã‚Šãã†ã ã£ãŸã®ã§ã€metricsã¨ã‚ã‚ã›ã¦åˆ¥ã®æ©Ÿä¼šã«ã—ã‚ˆã†ã¨æ€ã£ã¦ã„ã¾ã™ã€‚<p>ã¡ãªã¿ã«opentelemetryã®ç•¥ç§°ã¯<code>OTel</code>ã¨<a href=https://opentelemetry.io/docs/reference/specification/#project-naming rel=external>ä»•æ§˜</a>ã§æ±ºã¾ã£ã¦ã„ã¾ã—ãŸã€‚(ã“ã“ã¾ã§ä»•æ§˜ã§æ±ºã‚ã‚‹ã®å¥½ãã§ã™)</div></article></main><footer class=blog-footer><p>Â© 2026 <a href=https://blog.ymgyt.io> ymgyt </a> | Made with <a href=https://www.getzola.org rel=noopener target=_blank>Zola</a> | <a href=https://github.com/ymgyt/blog>Repository</a> | <a href=https://blog.ymgyt.io/atom.xml target=_blank title=rss> <svg viewbox="0 0 24 24" class=icon fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx=5 cy=19 r=1></circle></svg> </a></footer></div></div>