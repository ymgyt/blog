<!doctype html><html lang=ja><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1" name=viewport><link href=https://blog.ymgyt.io/favicon.ico rel=icon sizes=any><link href=https://blog.ymgyt.io/icon.svg rel=icon type=image/svg+xml><link href=https://blog.ymgyt.io/apple-touch-icon.png rel=apple-touch-icon><link href=https://blog.ymgyt.io/manifest.webmanifest rel=manifest><link href=https://blog.ymgyt.io/style.css rel=stylesheet><link href=https://blog.ymgyt.io/atom.xml rel=alternate title=Atom type=application/atom+xml><script src="https://www.googletagmanager.com/gtag/js?id=G-GTB0KMLN90" async></script><script>window.dataLayer = window.dataLayer || [];
	function gtag() {dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-GTB0KMLN90');</script><title>â„ï¸ NixOSã¨Raspberry Piã§è‡ªå®…server | Part 3 ragenixã§secretç®¡ç† | Happy developing</title><meta content=ragenixã«ã‚ˆã‚‹secretã®ç®¡ç†ã«ã¤ã„ã¦ name=description><meta content=summary name=twitter:card><meta content="@YAmaguchixt " name=twitter:site><meta content="â„ï¸ NixOSã¨Raspberry Piã§è‡ªå®…server | Part 3 ragenixã§secretç®¡ç†" name=twitter:title><meta content=ragenixã«ã‚ˆã‚‹secretã®ç®¡ç†ã«ã¤ã„ã¦ name=twitter:description><meta content=https://blog.ymgyt.io/images/emoji/snowflake.png name=twitter:image><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><body><div class=world><div class=content-container><header class=blog-header-container><div class=blog-logo><a href=https://blog.ymgyt.io>Happy developing</a></div><div class=blog-nav><nav><ul><li><a href=https://blog.ymgyt.io/entry/>Entries</a><li><a href=https://blog.ymgyt.io/tags/>Tags</a><li><a href=https://blog.ymgyt.io/about/>About</a><li><a href=https://github.com/ymgyt> <img alt=Github class=icon src=https://blog.ymgyt.io/images/icon/github.svg> </a><li><a href="https://twitter.com/YAmaguchixt "> <img alt=Twitter class=icon src=https://blog.ymgyt.io/images/icon/twitter.svg> </a></ul></nav></div></header><main class=blog-main><article><header class=entry-header><h1 class=entry-title>â„ï¸ NixOSã¨Raspberry Piã§è‡ªå®…server | Part 3 ragenixã§secretç®¡ç†</h1><div class=entry-meta><p class=entry-meta-item>ğŸ—“ 2023-10-09<p class=entry-meta-item>ğŸ· <span class=tag><a href=https://blog.ymgyt.io/tags/nix/>nix</a></span></div></header><aside class=entry-toc><nav><ul class=entry-toc-toplevel-list><li><a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-secret-management-with-ragenix/#secretguan-li-nogai-yao>Secretç®¡ç†ã®æ¦‚è¦</a><li><a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-secret-management-with-ragenix/#secret-filenozuo-cheng>Secret fileã®ä½œæˆ</a> <ul><li><a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-secret-management-with-ragenix/#ssh-keypairnozhun-bei>SSH Keypairã®æº–å‚™</a><li><a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-secret-management-with-ragenix/#openobservenosecretnoqu-de>Openobserveã®secretã®å–å¾—</a><li><a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-secret-management-with-ragenix/#ragenixdean-hao-hua>ragenixã§æš—å·åŒ–</a></ul><li><a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-secret-management-with-ragenix/#flake-nixdenosecretnocan-zhao>flake.nixã§ã®secretã®å‚ç…§</a><li><a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-secret-management-with-ragenix/#can-kao>å‚è€ƒ</a></ul></nav></aside><div class=entry-content><p><a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-install-nixos/ rel=external>Part 1 NixOSã‚’install</a><br> <a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-deploy-with-deploy-rs/ rel=external>Part 2 deply-rsã§NixOS Configurationã‚’é©ç”¨</a><br> Part 3 ragenixã§secretç®¡ç†](ğŸ‘ˆ ã“ã®è¨˜äº‹)<br> <a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-export-metrics-with-opentelemetry-collector/ rel=external>Part 4 opentelemetry-collectorã¨openobserveã§metricsã‚’å–å¾—</a><br> <a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-get-cpu-temperature/ rel=external>Part 5 CPUã®æ¸©åº¦ã‚’metricsã¨ã—ã¦å–å¾—</a><p>Part 3ã§ã¯secretç®¡ç†ã«ã¤ã„ã¦è¦‹ã¦ã„ãã¾ã™ã€‚<br> secretã‚’æ‰±ã„ãŸã„ã®ã¯ã€æ¬¡ã®Part 4ã§è¨­å®šã™ã‚‹opentelemetry-collectorã«exportå…ˆã®openobsreveã®tokenã‚’æ¸¡ã—ãŸã„ã‹ã‚‰ã§ã™ ã€‚<p>secretç®¡ç†ã§ã¯<a href=https://github.com/yaxitech/ragenix rel=external>ragenix</a>ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚<a href=https://github.com/yaxitech/ragenix rel=external>ragenix</a>ã¯<a href=https://github.com/ryantm/agenix rel=external>agenix</a>ã®rustå®Ÿè£…ãªã®ã§åŸºæœ¬çš„ãªä½¿ã„æ–¹ã¯<a href=https://github.com/ryantm/agenix rel=external>agenix</a>ã‚’å‚ç…§ã—ã¾ã™ã€‚<br> ä»Šå›ç™»å ´ã™ã‚‹<code>ragenix</code>ã‚’<code>agenix</code>ã«æ›¸ãæ›ãˆã¦ã‚‚å‹•ä½œã—ã¾ã™ã€‚<h2 id=secretguan-li-nogai-yao><a aria-label="Anchor link for: secretguan-li-nogai-yao" class=zola-anchor href=#secretguan-li-nogai-yao>Secretç®¡ç†ã®æ¦‚è¦</a></h2><p>æ¦‚ã­ä»¥ä¸‹ã®æ‰‹é †ã‚’è¸ã¿ã¾ã™ã€‚<ol><li>Secretã‚’<code>ragenix</code> cliã¨ssh keyã§æš—å·åŒ–ã™ã‚‹<li>æš—å·åŒ–ã•ã‚ŒãŸsecretã‚’raspiã‚’è¨­å®šã™ã‚‹flake(nixosConfiguration)ã§å‚ç…§ã™ã‚‹<li>Deployå…ˆã§ragenixãŒæš—å·åŒ–ã•ã‚ŒãŸsecretã‚’å¾©å·ã™ã‚‹<li>Secretã‚’serviceãŒå¹³æ–‡ã¨ã—ã¦å‚ç…§ã™ã‚‹</ol><p>å›³ã«ã™ã‚‹ã¨ã“ã‚“ãªæ„Ÿã˜ã§ã™ã€‚<figure><div class=fig-images-row><img , alt src=images/ragenix-overview.svg></div><figcaption>ragenixã®æ¦‚è¦</figcaption></figure><p>ã“ã‚Œã ã‘ã ã¨ã‚ˆãã‚ã‹ã‚‰ãªã„ã¨æ€ã†ã®ã§å…·ä½“çš„ã«ã¿ã¦ã„ãã¾ã™ã€‚<h2 id=secret-filenozuo-cheng><a aria-label="Anchor link for: secret-filenozuo-cheng" class=zola-anchor href=#secret-filenozuo-cheng>Secret fileã®ä½œæˆ</a></h2><p>secretã¯gitã«commitã—ã¾ã™ã€‚<br> <code>FOO=BAR</code>ã‚’æš—å·åŒ–ã—ãŸfileã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>-----BEGIN AGE ENCRYPTED FILE-----</span></span>
<span class=giallo-l><span>YWdlLWVuY3J5cHRpb24ub3JnL3YxCi0+IHNzaC1lZDI1NTE5IEQ1NXVqZyB6MlU4</span></span>
<span class=giallo-l><span>Rk9tTWR5MUY2bVdwNXpmRERzTEZMMTAJaXJ1M3VqWWdDKzBhMjFRClZ6aERoRGh4</span></span>
<span class=giallo-l><span>cW5PUEJvR1lNbXBBRVpwbUNyOFFvK3BJTUFXS0FjWGdQUEUKLT4gfkhiLWdyZWFz</span></span>
<span class=giallo-l><span>ZSBnaVd2Cit6YjZwVXMrRDYySkh5Nk4wQXQwVTlRRGNRWVpGMFlzUDlzUzVWMnc5</span></span>
<span class=giallo-l><span>b2laOUpVcGpSdDdFYUtrRkxNS0czRkMKK2dETjdRCi0tLSBtdzJ6RnE0VjRkVjZl</span></span>
<span class=giallo-l><span>aHpxQUE4ZFdJOT8BTml8OFdMTHcweURQMXJ1MmJFChz79iSwsWlQ20XLW6ET4GY4</span></span>
<span class=giallo-l><span>rb49pvi3FUy+GKUx3w5trvIjXWALqA==</span></span>
<span class=giallo-l><span>-----END AGE ENCRYPTED FILE-----</span></span></code></pre><p>ã“ã‚Œã‚’raspiã‚’ç®¡ç†ã—ã¦ã„ã‚‹<code>flake.nix</code>ã¨åŒã˜git repositoryã«ç½®ã„ã¦ã‚‚ã‚ˆã„ã®ã§ã™ãŒã€<a href=https://github.com/ryan4yin/nix-config/tree/v0.1.1/secrets rel=external>ryan4yinå…ˆç”Ÿã®secrets README</a>ã§ã¯åˆ¥ã®private repositoryã«åˆ†ã‘ã¦ã„ãŸã®ã§è¦‹ç¿’ã£ã¦åŒã˜ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚<h3 id=ssh-keypairnozhun-bei><a aria-label="Anchor link for: ssh-keypairnozhun-bei" class=zola-anchor href=#ssh-keypairnozhun-bei>SSH Keypairã®æº–å‚™</a></h3><p><a href=https://github.com/yaxitech/ragenix rel=external>ragenix</a>ã§ã®æš—å·åŒ–ã«ã¯ssh keypairãŒå¿…è¦ã§ã™ã€‚secretã‚’å¾©å·ã§ãã‚‹å…¬é–‹éµã‚’è¤‡æ•°æŒ‡å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚<br> å¾©å·ã«ã¯æŒ‡å®šã•ã‚ŒãŸå…¬é–‹éµã«å¯¾å¿œã™ã‚‹ã„ãšã‚Œã‹ã®ç§˜å¯†éµãŒå¿…è¦ã§ã™ã€‚<br> è‡ªåˆ†ã®å¾©å·ç”¨ã«ã¯raspiã¸ã®sshã«åˆ©ç”¨ã™ã‚‹keyãŒåˆ©ç”¨ã§ãã¾ã™ã€‚<br> ä»Šã‹ã‚‰ä½œæˆã™ã‚‹secretã¯deployå…ˆã®raspiã§å¾©å·ã—ãŸã„ã®ã§ã€deployå¯¾è±¡ã®raspi nodeãã‚Œãã‚Œã®keypairãŒå¿…è¦ã§ã™ã€‚(æš—å·åŒ–ã™ã‚‹ã ã‘ãªã‚‰å…¬é–‹éµ)<br> æ–°ãŸã«ssh keypairã‚’ä½œæˆã—ã¦ã€raspiã«é…å¸ƒã—ã¦ã‚‚ã‚ˆã„ã®ã§ã™ãŒã€ã™ã§ã«raspiä¸Šã«ç”Ÿæˆã•ã‚Œã¦ã„ã‚‹keypairã‚’ä½¿ã†ã“ã¨ã‚‚ã§ãã¾ã™ã€‚ä»Šå›ã¯raspiä¸Šã«æ—¢ã«ç”Ÿæˆã•ã‚Œã¦ã„ã‚‹keypairã‚’åˆ©ç”¨ã—ã¦ã¿ã¾ã™ã€‚<p>ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§raspiä¸Šã®å…¬é–‹éµã‚’å–å¾—ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>ssh-keyscan</span><span style=color:#a3be8c> -t ed25519</span><span style=color:#b48ead> 192.168.10.150</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88># 192.168.10.150:22 SSH-2.0-OpenSSH_9.4</span></span>
<span class=giallo-l><span style=color:#88c0d0>192.168.10.150</span><span style=color:#a3be8c> ssh-ed25519 AAAA...XXXX</span></span></code></pre><p>ã“ã‚Œã‚’å¯¾è±¡nodeã«å¯¾ã—ã¦è¡Œã„ã¾ã™ã€‚<h3 id=openobservenosecretnoqu-de><a aria-label="Anchor link for: openobservenosecretnoqu-de" class=zola-anchor href=#openobservenosecretnoqu-de>Openobserveã®secretã®å–å¾—</a></h3><p>æ¬¡ã«å®Ÿéš›ã«æš—å·åŒ–ã™ã‚‹secretã‚’å–å¾—ã—ã¾ã™ã€‚<br> ä»Šå›ã¯metricsã‚’openobserveã«æ›¸ãè¾¼ã‚€ã®ã§ãã®ãŸã‚ã®credentialãŒå¿…è¦ã§ã™ã€‚openobserveã«ã¤ã„ã¦ã¯<a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-export-metrics-with-opentelemetry-collector/ rel=external>Part 4</a>ã§èª¬æ˜ã™ã‚‹äºˆå®šã§ã™ã€‚<br> Openobserveã®ç”»é¢ã‹ã‚‰Ingestion > Metrics > OTEL Collectorã«é·ç§»ã™ã‚‹ã¨exporterã®è¨­å®šãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚<p><code>v0.6.4</code>ã§ã¯URLã¨ã—ã¦ã¯<code>https://cloud.openobserve.ai/ingestion/metrics/otelcollector</code>ã§ã—ãŸã€‚<p>Localã§ç«‹ã¡ä¸Šã’ãŸSSã¨ã—ã¦ã¯ä»¥ä¸‹ã§ã™ã€‚<figure><div class=fig-images-row><img , alt src=images/ss-openobserve-metrics.png></div><figcaption>localã®å€¤</figcaption></figure><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=yaml><span class=giallo-l><span style=color:#8fbcbb>exporters</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  prometheusremotewrite</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    endpoint</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> https://api.openobserve.ai/api/MY_ORGANIZATION/prometheus/api/v1/write</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    headers</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      Authorization</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> Basic OPEN_OBSERVE_TOKEN</span></span></code></pre><p>credentialã¨ã—ã¦ã¯endpointã«å«ã¾ã‚Œã¦ã„ã‚‹<code>MY_ORGANIZATION</code>ã¨Authorization headerã®<code>OPEN_OBSERVE_TOKEN</code>ã‚’å–å¾—ã—ã¾ã™ã€‚<h3 id=ragenixdean-hao-hua><a aria-label="Anchor link for: ragenixdean-hao-hua" class=zola-anchor href=#ragenixdean-hao-hua>ragenixã§æš—å·åŒ–</a></h3><p>sshå…¬é–‹éµã¨credentialãŒç”¨æ„ã§ããŸã®ã§ã€<a href=https://github.com/yaxitech/ragenix rel=external>ragenix</a>ã§æš—å·åŒ–ã—ã¦ã„ãã¾ã™ã€‚<p>secretç®¡ç†ç”¨ã®repo(<code>mynix.secrets</code>)ã«<code>secrets.nix</code>ã‚’ä»¥ä¸‹ã®ã‚ˆã†ä½œæˆã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=nix><span class=giallo-l><span style=color:#81a1c1>let</span><span> </span></span>
<span class=giallo-l><span style=color:#8fbcbb>  my_key</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>ssh-ed25519 AAAA...XXXX</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>  rpi4_01</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>ssh-ed25519 AAAA...YYYY</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  rpi4_02</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>ssh-ed25519 AAAA...ZZZZ</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  rpi4_03</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>ssh-ed25519 AAAA...WWWW</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  rpi4_04</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>ssh-ed25519 AAAA...IIII</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>in</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#eceff4>  "</span><span style=color:#a3be8c>openobserve.age</span><span style=color:#eceff4>"</span><span>.</span><span style=color:#8fbcbb>publicKeys</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> [</span><span> nixos_age rpi4_01 rpi4_02 rpi4_03 rpi4_04</span><span style=color:#eceff4> ]</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>openobserve.age</code>ãŒæš—å·åŒ–å¯¾è±¡ã®fileã«ãªã‚Šã¾ã™ã€‚<br> <code>openobserve.age.publicKeys</code>ã«å¾©å·ã§ãã‚‹ç§˜å¯†éµã«å¯¾å¿œã™ã‚‹å…¬é–‹éµã‚’æŒ‡å®šã—ã¾ã™ã€‚ã“ã®å€¤ã¯ã•ãã»ã©<code>ssh-keyscan</code>ã§å–å¾—ã—ãŸã‚‚ã®ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>nix</span><span style=color:#a3be8c> run github:yaxitech/ragenix -- -e openobserve.age</span><span>  </span></span></code></pre><p>ã“ã®commandã‚’å®Ÿè¡Œã™ã‚‹ã¨<code>$EDITOR</code>ãŒé–‹ãã®ã§ã•ãã»ã©å–å¾—ã—ãŸopenobserveã®credentialã‚’å…¥åŠ›ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>OPEN_OBSERVE_ORG=MY_ORGANIZATION</span></span>
<span class=giallo-l><span>OPEN_OBSERVE_TOKEN=OPEN_OBSERVE_TOKEN</span></span></code></pre><p>ã‚’å…¥åŠ›ã—ã¦<code>$EDITOR</code>ã‚’çµ‚äº†ã—ã¾ã™ã€‚<br> æš—å·åŒ–ã•ã‚ŒãŸ<code>openobserve.age</code> fileãŒä½œæˆã•ã‚Œã¦ã„ã‚Œã°å®Œäº†ã§ã™ã€‚<p>å†…å®¹ã‚’æ›´æ–°ã—ãŸã‚Šã€æ–°ã—ã„å…¬é–‹éµã‚’è¿½åŠ ã—ãŸéš›ã¯ä»¥ä¸‹ã®commandã§æ›´æ–°ã§ãã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>nix</span><span style=color:#a3be8c> run github:yaxitech/ragenix -- --rekey -i path/to/key</span></span></code></pre><h2 id=flake-nixdenosecretnocan-zhao><a aria-label="Anchor link for: flake-nixdenosecretnocan-zhao" class=zola-anchor href=#flake-nixdenosecretnocan-zhao>flake.nixã§ã®secretã®å‚ç…§</a></h2><p>ä½œæˆã—ãŸsecretã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å‚ç…§ã§ãã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=nix><span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  inputs</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>    # ...</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    # secrets management</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    ragenix</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      url</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>github:yaxitech/ragenix</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      inputs</span><span>.</span><span style=color:#8fbcbb>nixpkgs</span><span>.</span><span style=color:#8fbcbb>follows</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>nixpkgs</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      inputs</span><span>.</span><span style=color:#8fbcbb>flake-utils</span><span>.</span><span style=color:#8fbcbb>follows</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>flake-utils</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    mysecrets</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      url</span><span style=color:#81a1c1> =</span></span>
<span class=giallo-l><span style=color:#eceff4>        "</span><span style=color:#a3be8c>github:ymgyt/mynix.secrets/a09e3d81f8e24657ea2cbd53f37f9e95b4576abb</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      flake</span><span style=color:#81a1c1> = false;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>  }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>  outputs</span><span style=color:#81a1c1> =</span></span>
<span class=giallo-l><span style=color:#eceff4>    {</span><span> self</span><span style=color:#81a1c1>,</span><span> nixpkgs</span><span style=color:#81a1c1>,</span><span>  ragenix</span><span style=color:#81a1c1>,</span><span> mysecrets</span><span style=color:#eceff4> }:</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      spec</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>        # ...</span></span>
<span class=giallo-l><span style=color:#81a1c1>        inherit</span><span style=color:#8fbcbb> ragenix mysecrets</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>      }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    in</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      nixosConfigurations</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        rpi4-01</span><span style=color:#81a1c1> =</span><span> nixpkgs</span><span style=color:#81a1c1>.</span><span>lib</span><span style=color:#81a1c1>.</span><span>nixosSystem</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>          system</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>aarch64-linux</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>          specialArgs</span><span style=color:#81a1c1> =</span><span> spec</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>          modules</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> [</span><span style=color:#a3be8c> ./hosts/rpi4-01.nix</span><span style=color:#eceff4> ]</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#616e88>        # ...</span></span>
<span class=giallo-l><span style=color:#eceff4>      }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#616e88>      # ...</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>inputs.mysecrets</code>ã§<code>secrets.nix</code>ã‚’å®šç¾©ã—ãŸrepositoryã‚’æŒ‡å®šã—ã¾ã™ã€‚<br> flakeã§private git repositoryã‚’å‚ç…§ã™ã‚‹æ–¹æ³•ã§ã™ãŒ<br> <code>~/.config/nix/nix.conf</code>ã«<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>access-tokens = github.com=ghp_xxx  </span></span></code></pre><p>ã®ã‚ˆã†ã«æ›¸ã„ã¦ãŠãã“ã¨ã§githubã®èªè¨¼ã‚’è¡Œã£ã¦ãã‚Œã¾ã™ã€‚<br> æ¬¡ã«<code>nixosConfigurations</code>ã‹ã‚‰å‚ç…§ã™ã‚‹moduleã§ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=nix><span class=giallo-l><span style=color:#eceff4>{</span><span> pkgs</span><span style=color:#81a1c1>,</span><span> config</span><span style=color:#81a1c1>,</span><span> ragenix</span><span style=color:#81a1c1>,</span><span> mysecrets</span><span style=color:#81a1c1>, ...</span><span style=color:#eceff4> }:</span><span> </span></span>
<span class=giallo-l><span style=color:#81a1c1>  let</span><span> </span></span>
<span class=giallo-l><span style=color:#8fbcbb>    otelColUser</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>opentelemetry-collector</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    otelColGroup</span><span style=color:#81a1c1> =</span><span> otelColUser</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>  in</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>  imports</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> [</span><span> ragenix</span><span style=color:#81a1c1>.</span><span>nixosModules</span><span style=color:#81a1c1>.</span><span>default</span><span style=color:#eceff4> ]</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>  # Create user statically for age to execute chown</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  users</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span><span> </span></span>
<span class=giallo-l><span style=color:#8fbcbb>    groups</span><span>.</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>opentelemetry-collector</span><span style=color:#eceff4>"</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      name</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#81a1c1>${</span><span>otelColGroup</span><span style=color:#81a1c1>}</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    users</span><span>.</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>opentelemetry-collector</span><span style=color:#eceff4>"</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      name</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#81a1c1>${</span><span>otelColUser</span><span style=color:#81a1c1>}</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      isSystemUser</span><span style=color:#81a1c1> = true;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      group</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#81a1c1>${</span><span>otelColGroup</span><span style=color:#81a1c1>}</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>  }</span><span style=color:#81a1c1>;</span><span>  </span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>  # Credential for opentelemetry-collector to export telemetry to openobserve cloud</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  age</span><span>.</span><span style=color:#8fbcbb>secrets</span><span>.</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>openobserve</span><span style=color:#eceff4>"</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    file</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#81a1c1>${</span><span>mysecrets</span><span style=color:#81a1c1>}</span><span style=color:#a3be8c>/openobserve.age</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    mode</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>0440</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    owner</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#81a1c1>${</span><span>otelColUser</span><span style=color:#81a1c1>}</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    group</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#81a1c1>${</span><span>otelColGroup</span><span style=color:#81a1c1>}</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>  }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>  # ...</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>  # Enable opentelemetry-collecotr service</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  systemd</span><span>.</span><span style=color:#8fbcbb>services</span><span>.</span><span style=color:#8fbcbb>opentelemetry-collector</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>    # ...</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    EnvironmentFile</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> [</span><span> </span></span>
<span class=giallo-l><span style=color:#616e88>      # referenced by environment variable substitution in config file like '${env:FOO}'</span></span>
<span class=giallo-l><span>      config</span><span style=color:#81a1c1>.</span><span>age</span><span style=color:#81a1c1>.</span><span>secrets</span><span style=color:#81a1c1>.</span><span>openobserve</span><span style=color:#81a1c1>.</span><span>path</span></span>
<span class=giallo-l><span style=color:#eceff4>     ]</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>  }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>age.secrets."openobserve" = {</span></span>
<span class=giallo-l><span>  file = "${mysecrets}/openobserve.age";</span></span>
<span class=giallo-l><span>  # ...</span></span>
<span class=giallo-l><span>};</span></span></code></pre><p>ã“ã®æŒ‡å®šã§ragenixã¯æš—å·åŒ–ã•ã‚ŒãŸopenobserve.ageã‚’å¾©å·ã—ã¾ã™ã€‚<br> å¾©å·å¾Œã®å¹³æ–‡ã®fileã‚’å‚ç…§ã™ã‚‹ã«ã¯<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>systemd.services.opentelemetry-collector = {</span></span>
<span class=giallo-l><span>  # ...</span></span>
<span class=giallo-l><span>  EnvironmentFile = [ </span></span>
<span class=giallo-l><span>    config.age.secrets.openobserve.path</span></span>
<span class=giallo-l><span>   ];</span></span>
<span class=giallo-l><span>};</span></span></code></pre><p>ã®ã‚ˆã†ã«<code>config.age.secrets.${secret}.path</code>ã‚’å‚ç…§ã—ã¾ã™ã€‚<br> å®Ÿæ…‹ã¨ã—ã¦ã¯<code>/run/agenix/openobserve</code>ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚<br> åˆ¥é€”åˆ¥ã®pathã«æ›¸ãå‡ºã—ãŸã‚Šã¨ã„ã£ãŸã“ã¨ã‚‚ã§ãã¾ã™ã€‚<br> raspiä¸Šã§ã¯secretã¯å¹³æ–‡ã§ç½®ã‹ã‚Œã¦ã„ã‚‹ã®ã§userã¨groupã‚’æŒ‡å®šã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚<br> systemdã¾ã‚ã‚Šã®è¨­å®šã®è©±ã¯Part 4ã§è¡Œã„ã¾ã™ã€‚<p>ã“ã‚Œã§deploy-rsã§deployã™ã‚‹ã ã‘ã§secretã‚’é…å¸ƒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚ç®¡ç†ã™ã‚‹ã‚‚ã®ãŒæ—¢å­˜ã®ssh keyã ã‘ãªã®ã§æ‰±ã„ã‚„ã™ã„ã¨æ€ã£ã¦ã„ã¾ã™ã€‚<p><a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-export-metrics-with-opentelemetry-collector/ rel=external>Part 4</a>ã§ã¯raspiä¸Šã§opentelemetry-collectorã‚’å‹•ã‹ã—ã¦metricsã‚’å–å¾—ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚ ã€€<h2 id=can-kao><a aria-label="Anchor link for: can-kao" class=zola-anchor href=#can-kao>å‚è€ƒ</a></h2><ul><li><a href=https://github.com/ryan4yin/nix-config/tree/v0.1.1/secrets rel=external>ryan4yinå…ˆç”Ÿã®secrets README</a></ul></div></article></main><footer class=blog-footer><p>Â© 2026 <a href=https://blog.ymgyt.io> ymgyt </a> | Made with <a href=https://www.getzola.org rel=noopener target=_blank>Zola</a> | <a href=https://github.com/ymgyt/blog>Repository</a> | <a href=https://blog.ymgyt.io/atom.xml target=_blank title=rss> <svg viewbox="0 0 24 24" class=icon fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx=5 cy=19 r=1></circle></svg> </a></footer></div></div>