<!doctype html><html lang=ja><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1" name=viewport><link href=https://blog.ymgyt.io/favicon.ico rel=icon sizes=any><link href=https://blog.ymgyt.io/icon.svg rel=icon type=image/svg+xml><link href=https://blog.ymgyt.io/apple-touch-icon.png rel=apple-touch-icon><link href=https://blog.ymgyt.io/manifest.webmanifest rel=manifest><link href=https://blog.ymgyt.io/style.css rel=stylesheet><link href=https://blog.ymgyt.io/atom.xml rel=alternate title=Atom type=application/atom+xml><script src="https://www.googletagmanager.com/gtag/js?id=G-GTB0KMLN90" async></script><script>window.dataLayer = window.dataLayer || [];
	function gtag() {dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-GTB0KMLN90');</script><title>ğŸ“• Asynchronous Programming in Rustã‚’èª­ã‚“ã æ„Ÿæƒ³ | Happy developing</title><meta content="CF Samsonå…ˆç”Ÿã®Futureè§£èª¬ãŒã¤ã„ã«æœ¬ã«ãªã£ãŸ" name=description><meta content=summary name=twitter:card><meta content="@YAmaguchixt " name=twitter:site><meta content="ğŸ“• Asynchronous Programming in Rustã‚’èª­ã‚“ã æ„Ÿæƒ³" name=twitter:title><meta content="CF Samsonå…ˆç”Ÿã®Futureè§£èª¬ãŒã¤ã„ã«æœ¬ã«ãªã£ãŸ" name=twitter:description><meta content=https://blog.ymgyt.io/images/emoji/closed_book.png name=twitter:image><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><body><div class=world><div class=content-container><header class=blog-header-container><div class=blog-logo><a href=https://blog.ymgyt.io>Happy developing</a></div><div class=blog-nav><nav><ul><li><a href=https://blog.ymgyt.io/entry/>Entries</a><li><a href=https://blog.ymgyt.io/tags/>Tags</a><li><a href=https://blog.ymgyt.io/about/>About</a><li><a href=https://github.com/ymgyt> <img alt=Github class=icon src=https://blog.ymgyt.io/images/icon/github.svg> </a><li><a href="https://twitter.com/YAmaguchixt "> <img alt=Twitter class=icon src=https://blog.ymgyt.io/images/icon/twitter.svg> </a></ul></nav></div></header><main class=blog-main><article><header class=entry-header><h1 class=entry-title>ğŸ“• Asynchronous Programming in Rustã‚’èª­ã‚“ã æ„Ÿæƒ³</h1><div class=entry-meta><p class=entry-meta-item>ğŸ—“ 2024-03-14<p class=entry-meta-item>ğŸ· <span class=tag><a href=https://blog.ymgyt.io/tags/rust/>rust</a></span> <span class=tag><a href=https://blog.ymgyt.io/tags/book/>book</a></span></div></header><aside class=entry-toc><nav><ul class=entry-toc-toplevel-list><li><a href=https://blog.ymgyt.io/entry/asynchronous-programming-in-rust/#du-ndaben>èª­ã‚“ã æœ¬</a><li><a href=https://blog.ymgyt.io/entry/asynchronous-programming-in-rust/#matome>ã¾ã¨ã‚</a><li><a href=https://blog.ymgyt.io/entry/asynchronous-programming-in-rust/#chapter-1-concurrency-and-asynchronous-programming-a-detailed-overview>Chapter 1: Concurrency and Asynchronous Programming: a Detailed Overview</a><li><a href=https://blog.ymgyt.io/entry/asynchronous-programming-in-rust/#chapter-2-how-programming-languages-model-asynchronous-program-flow>Chapter 2: How Programming Languages Model Asynchronous Program Flow</a><li><a href=https://blog.ymgyt.io/entry/asynchronous-programming-in-rust/#chapter-3-understanding-os-backed-event-queues-system-calls-and-cross-platform-abstractions>Chapter 3: Understanding OS-Backed Event Queues, System Calls, and Cross-Platform Abstractions</a><li><a href=https://blog.ymgyt.io/entry/asynchronous-programming-in-rust/#chapter-4-create-your-own-event-queue>Chapter 4: Create Your Own Event Queue</a><li><a href=https://blog.ymgyt.io/entry/asynchronous-programming-in-rust/#chapter-5-creating-our-own-fibers>Chapter 5: Creating Our Own Fibers</a><li><a href=https://blog.ymgyt.io/entry/asynchronous-programming-in-rust/#chapter-6-futures-in-rust>Chapter 6: Futures in Rust</a><li><a href=https://blog.ymgyt.io/entry/asynchronous-programming-in-rust/#chapter-7-coroutines-and-async-await>Chapter 7: Coroutines and async/await</a><li><a href=https://blog.ymgyt.io/entry/asynchronous-programming-in-rust/#chapter-8-runtimes-wakers-and-the-reactor-executor-pattern>Chapter 8: Runtimes, Wakers, And The Reactor-Executor Pattern</a><li><a href=https://blog.ymgyt.io/entry/asynchronous-programming-in-rust/#chapter-9-coroutines-self-referential-struct-and-pinning>Chapter 9: Coroutines, Self-Referential Struct, And Pinning</a><li><a href=https://blog.ymgyt.io/entry/asynchronous-programming-in-rust/#chapter-10-creating-your-own-runtime>Chapter 10: Creating Your Own Runtime</a></ul></nav></aside><div class=entry-content><h2 id=du-ndaben><a aria-label="Anchor link for: du-ndaben" class=zola-anchor href=#du-ndaben>èª­ã‚“ã æœ¬</a></h2><a href=https://www.packtpub.com/product/asynchronous-programming-in-rust/9781805128137> <figure><div class=fig-images-row><img , alt src=images/apir-book.jpg></div><figcaption>Asynchronous Programming in Rust</figcaption></figure> </a><p>è‘—è€…: <a href="https://github.com/PacktPublishing/Asynchronous-Programming-in-Rust/tree/main?tab=readme-ov-file#get-to-know-the-author" rel=external>Carl Fredrik Samson</a><br> <a href="https://github.com/PacktPublishing/Asynchronous-Programming-in-Rust/tree/main?tab=readme-ov-file#get-to-know-the-author" rel=external>Sample code Repository</a><p>ä»Šã¯ã‚‚ã†èª­ã‚ãªããªã£ã¦ã—ã¾ã£ãŸ<a href=http://web.archive.org/web/20230324130904/https://cfsamson.github.io/books-futures-explained/ rel=external>Futures Explained in 200 Lines of Rust</a>ã‚„<a href=http://web.archive.org/web/20220814154139/https://cfsamson.github.io/book-exploring-async-basics/introduction.html rel=external>Exploring Async Basics with Rust</a>ã‚’æ›¸ã‹ã‚ŒãŸCF Samsonå…ˆç”ŸAsyncè§£èª¬æœ¬ãŒã¤ã„ã«å‡ºç‰ˆã•ã‚Œã¾ã—ãŸã€‚<p>æœ¬è¨˜äº‹ã§ã¯æœ¬æ›¸ã‚’èª­ã‚“ã æ„Ÿæƒ³ã«ã¤ã„ã¦æ›¸ãã¾ã™ã€‚<h2 id=matome><a aria-label="Anchor link for: matome" class=zola-anchor href=#matome>ã¾ã¨ã‚</a></h2><p>Rustã®Future,async/awaitã®è§£èª¬ã¨ã—ã¦éå¸¸ã«å‚è€ƒã«ãªã‚Šã¾ã—ãŸã€‚ æœ€çµ‚çš„ã«<a href=https://github.com/tokio-rs/mio rel=external>mio</a>ã®ã¿ã®ä¾å­˜ã§ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ãŒå‹•ãruntimeã‚’ä½œã‚Œã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> executor</span><span style=color:#81a1c1> =</span><span> runtime</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>init</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span>    executor</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>block_on</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>async_main</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> async_main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> txt</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Http</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>get</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>/600/HelloAsyncAwait</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    println!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>txt</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> txt</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Http</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>get</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>/400/HelloAsyncAwait</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    println!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>txt</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>æœ¬æ›¸ãŒç´ æ™´ã‚‰ã—ã„ã®ã¯ã€Futureã‚’èª¬æ˜ã™ã‚‹ãŸã‚ã«assembly,ISA,thread,systemcall,epoll,calling convention, green thread, coroutineã¨ã„ã£ãŸæ¦‚å¿µã‹ã‚‰èª¬æ˜ã—ã¦ãã‚Œã‚‹ç‚¹ã§ã™ã€‚1ç« ã‹ã‚‰5ç« ã¾ã§ã¯Rustã‚’ã‚„ã£ã¦ã„ãªãã¦ã‚‚å‚è€ƒã«ãªã‚‹ã¨æ€ã„ã¾ã™ã€‚<h2 id=chapter-1-concurrency-and-asynchronous-programming-a-detailed-overview><a aria-label="Anchor link for: chapter-1-concurrency-and-asynchronous-programming-a-detailed-overview" class=zola-anchor href=#chapter-1-concurrency-and-asynchronous-programming-a-detailed-overview>Chapter 1: Concurrency and Asynchronous Programming: a Detailed Overview</a></h2><p>æœ¬æ›¸ã®å‰æã¨ãªã‚‹Multitaskingã®æ­´å²ã‚„è¨€è‘‰ã®å®šç¾©ã€OSã¨CPUã®é–¢ä¿‚ç­‰ãŒèª¬æ˜ã•ã‚Œã¾ã™ã€‚<br> Preemptiveã®æ¦‚å¿µã‚„æœ¬æ›¸ã«ãŠã‘ã‚‹concurrencyã¨parallelismã®é•ã„ãŒå–ã‚Šä¸Šã’ã‚‰ã‚Œã¾ã™ã€‚ã€€ã€€ Efficiency(ç„¡é§„ã‚’é¿ã‘ã‚‹èƒ½åŠ›)ã¨ã„ã†è¦³ç‚¹ã‹ã‚‰ã¿ã‚‹ã¨ã€parallelism(ä¸¦åˆ—)ã¯efficiencyã«ã¯ä¸€åˆ‡å¯„ä¸ã›ãšã€concurrency(ä¸¦è¡Œ)ã“ããŒã€ãã‚Œã‚’é«˜ã‚ã‚‹ã¨ã„ã†èª¬æ˜ãŒãŠã‚‚ã—ã‚ã‹ã£ãŸã§ã™ã€‚<br> Concurrency,parallelism,resource,task,asynchronous programmingã¨ã„ã£ãŸã¨ã‚‚ã™ã‚Œã°å¤šç¾©çš„ã§æ–‡è„ˆä¾å­˜ãªç”¨èªã‚’æœ¬æ›¸ã®ç¯„å›²ã§ã€ãã¡ã‚“ã¨å®šç¾©ã—ã¦ãã‚Œã‚‹ã¨ã“ã‚ã‚‚ã‚ˆã‹ã£ãŸã§ã™ã€‚<br> ä¸€æ–¹ã§ã€<blockquote><p>On the other hand, if you fancy heated internet debates, this is a good place to start. Just claim someone elseâ€™s definition of concurrent is 100 % wrong or that yours is 100 % correct, and off you go.</blockquote><p>(ãƒãƒƒãƒˆä¸Šã§ã®è­°è«–ãŒå¥½ããªã‚‰ã€èª°ã‹ã®concurrentã®å®šç¾©ã¯ã¾ã£ãŸãã®èª¤ã‚Šã§ã€æ­£ã—ãã¯ã“ã†ã¨ä¸»å¼µã—ã¦ã¿ã‚‹ã¨ã„ã„ã ã‚ã†)<p>ã¨ã„ã†å†—è«‡ã‚‚ã‚ã‚Šã€ã‚‚ã‚ã‚‚ã‚ã®å®šç¾©ã¯ã‚ãã¾ã§æœ¬æ›¸ã®ç†è§£ã‚’åŠ©ã‘ã‚‹ãŸã‚ã«ã—ã¦ã„ã‚‹ã¨ã„ã†ã‚¹ã‚¿ãƒ³ã‚¹ã§ã™ã€‚ (æ—¥æœ¬ä»¥å¤–ã§ã‚‚ä¸¦åˆ—/ä¸¦è¡Œè­¦å¯Ÿã£ã¦ã„ã‚‹ã‚“ã§ã™ã­)<p>Readã®I/Oã‚’è¡Œã†å ´åˆã«3ã¤ã®é¸æŠè‚¢ãŒã‚ã‚Šã€ãã‚Œãã‚Œthreadã‚’suspendã™ã‚‹ã‹ã ã£ãŸã‚Šã®é•ã„ãŒå›³ã§è§£èª¬ã•ã‚Œã¦ã„ã‚‹ã¨ã“ã‚ã‚‚ã‚ã‹ã‚Šã‚„ã™ã‹ã£ãŸã§ã™ã€‚epollç­‰ã«ã¤ã„ã¦ã¯3ç« ã§è©³ã—ãèª¬æ˜ã—ã¦ãã‚Œã¾ã™ã€‚<p>Rustã®æœ¬ãªã®ã«Futureã®è©±ãŒã§ã¦ãã‚‹ã®ãŒ6ç« ãªã®ãŒç´ æ™´ã‚‰ã—ã„ã§ã™ã€‚ã¾ãŸã€firmwareã«ã¯microcontroller(small CPU)ãŒå‚™ã‚ã£ã¦ãŠã‚Šã€concurrencyã¨ã¯åŠ¹ç‡æ€§ã‚’ä¸Šã’ã‚‹ã“ã¨ãªã®ã ã‹ã‚‰ã€åŒã˜ä»•äº‹ã‚’ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã«ã•ã›ãªã„ã¨ã„ã†è©±ã¯ã¨ã¦ã‚‚å‚è€ƒã«ãªã‚Šã¾ã—ãŸã€‚<br> çŸ¥ã£ã¦ã„ã‚‹äººã«ã¨ã£ã¦ã¯å½“ãŸã‚Šå‰ãªã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€ã“ã®ã‚ãŸã‚Šã‚’èª¬æ˜ã—ã¦ãã‚Œã‚‹ã®ã¯çã—ã„ã¨æ€ã„ã¾ã—ãŸã€‚<h2 id=chapter-2-how-programming-languages-model-asynchronous-program-flow><a aria-label="Anchor link for: chapter-2-how-programming-languages-model-asynchronous-program-flow" class=zola-anchor href=#chapter-2-how-programming-languages-model-asynchronous-program-flow>Chapter 2: How Programming Languages Model Asynchronous Program Flow</a></h2><p>OSã®threadã¨ã„ã†æ©Ÿæ§‹ãŒã‚ã‚‹ã®ã«ãªãœã€ã•ã‚‰ã«ã‚‚ã†1ã¤æŠ½è±¡åŒ–ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¨­ã‘ã‚‹ã®ã‹ã€ Thread,future,goroutine, promiseç­‰ãŒãªã«ã‚’æŠ½è±¡åŒ–ã—ã¦ã„ã‚‹ã‹ã«ã¤ã„ã¦èª¬æ˜ã•ã‚Œã¾ã™ã€‚<br> Cooperativeã‚„stackfulã¨ã„ã£ãŸåˆ†é¡ã®è¦³ç‚¹ã®èª¬æ˜ã‚‚ã‚ã‚Šã¾ã™ã€‚<br> OS threadã¨user-lebel thread(green thread)ã®å…±é€šç‚¹ã‚„é•ã„ã®èª¬æ˜ã‚‚ã‚ã‹ã‚Šã‚„ã™ã‹ã£ãŸã§ã™ã€‚<br> Green threadã§ã¯program(runtime)ã§green threadã”ã¨ã®stackã‚’ç®¡ç†ã—ã¾ã™ãŒã€æœ€åˆã®å‰²ã‚Šå½“ã¦ãŒè¶³ã‚Šãªããªã£ãŸå ´åˆã«æ–°ã—ã„é ˜åŸŸã‚’å‰²ã‚Šå½“ã¦ã¦ç§»å‹•ã•ã›ã‚‹ã“ã¨ã®é›£ã—ã•ã«ã¤ã„ã¦ã®è¨€åŠã¯ãªã‚‹ã»ã©ã§ã—ãŸã€‚(stackã‚’å˜ç´”ã«ç§»å‹•ã•ã›ã‚‹ã¨pointerãŒå£Šã‚Œã¦ã—ã¾ã„ã¾ã™ãŒã€garbage collectorã§ã©ã®ã¿ã¡pointerã‚’ç®¡ç†ã™ã‚‹ã‚³ã‚¹ãƒˆã‚’æ‰•ã£ã¦ã„ã‚‹ç­‰)<p>Green thread, fiber, future, promiseãŒã©ã†ã„ã£ãŸé–¢ä¿‚ã«ã‚ã‚‹ã®ã‹æ•´ç†ã•ã‚Œã¦ãŠã‚Šã€æœ¬ç« ã‚‚Rusté–¢ä¿‚ãªãå‚è€ƒã«ãªã‚‹ã¨æ€ã„ã¾ã™ã€‚green threadã„ã¾ã„ã¡ãƒ”ãƒ³ã¨ãã¦ã„ãªã„æ–¹ã‚‚5ç« ã§å®Ÿéš›ã«ä½œã‚ŠãªãŒã‚‰è©³ã—ãè§£èª¬ã—ã¦ãã‚Œã‚‹ã®ã§å¤§ä¸ˆå¤«ã§ã™ã€‚<h2 id=chapter-3-understanding-os-backed-event-queues-system-calls-and-cross-platform-abstractions><a aria-label="Anchor link for: chapter-3-understanding-os-backed-event-queues-system-calls-and-cross-platform-abstractions" class=zola-anchor href=#chapter-3-understanding-os-backed-event-queues-system-calls-and-cross-platform-abstractions>Chapter 3: Understanding OS-Backed Event Queues, System Calls, and Cross-Platform Abstractions</a></h2><p><a href=https://github.com/tokio-rs/mio rel=external>mio</a>ã‚„<a href=https://github.com/smol-rs/polling rel=external>polling</a>,<a href=https://libuv.org/ rel=external>libuv</a>ç­‰ã§åˆ©ç”¨ã•ã‚Œã¦ã„ã‚‹OS-backed event queueã«ã¤ã„ã¦ã€‚<p>Blocking I/Oã‚’è¡Œã†ã¨ã€ãã®OS threadã¯suspendã•ã‚Œã€dataãŒåˆ°ç€ã™ã‚‹ã¨å†ã³èµ·ã“ã•ã‚Œã€CPUã®stateã‚’å¾©å…ƒã—ãŸã®ã¡ã€å®Ÿè¡ŒãŒå†é–‹ã•ã‚Œã‚‹ã€‚I/Oã®å®Œäº†ã‚’å¾…ã£ã¦ã„ã‚‹é–“ã«ä»–ã«ã™ã‚‹ã“ã¨ãŒãªã‘ã‚Œã°ã“ã®ä»•çµ„ã¿ã¯åŠ¹ç‡çš„ã ãŒã€ãã†ã§ãªã„å ´åˆã¯æ–°ãŸã«threadã‚’èµ·å‹•ã•ã›ã‚‹ã—ã‹ãªã„ã€‚<br> ãã“ã§ã€threadã‚’suspendã•ã›ãªã„syscallã‚’è¡Œã„ã€blockã™ã‚‹ä»£ã‚ã‚Šã«eventã®çŠ¶æ…‹ã‚’å•ã„åˆã‚ã›ã‚‹ãŸã‚ã®handleã‚’å–å¾—ã™ã‚‹ã€‚(polling)ã€‚ãŸã ã—ã€ã“ã®æ‰‹æ³•ã ã¨ã€pollã®é–“éš”ãŒçŸ­ã™ãã‚‹ã¨CPUã‚’æµªè²»ã—ã¦ã—ã¾ã†ã—ã€é•·ã™ãã‚‹ã¨throughputãŒè½ã¡ã¦ã—ã¾ã†ã€‚ãã“ã§ã€epoll,kqueue,IOCPç­‰ã®event queueã‚’åˆ©ç”¨ã™ã‚‹ã€‚<p>event queueã«ã¯ã€I/Oã®æº–å‚™ãŒã§ããŸã“ã¨ã‚’é€šçŸ¥ã™ã‚‹Readiness basedã¨bufferç­‰ã‚’æ¸¡ã—ã¦I/Oã®å®Œäº†ã‚’é€šçŸ¥ã™ã‚‹Completion basedãªã‚‚ã®ãŒã‚ã‚‹ã€‚epollã¨input/output completion port(IOCP)ã‚’å…·ä½“ä¾‹ã«ä¸¡è€…ã®èª¬æ˜ã‚‚ã‚ã‚‹ã€‚cross platformãªevent queue apiã‚’ä½œã‚‹éš›ã¯ã©ã¡ã‚‰ã‚’ãƒ™ãƒ¼ã‚¹ã«ã™ã‚‹ã‹æ±ºã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã€ä¸ä¸€è‡´ã‚’åŸ‹ã‚ã‚‹ã®ã¯ãªã‹ãªã‹å¤§å¤‰ã¨ã„ã†èª¬æ˜ã‚‚ã‚ã‚Šã¾ã™ã€‚<p>å¾ŒåŠã§ã¯syscallã®è§£èª¬ãŒã‚ã‚Šã¾ã™ã€‚ABIã‚„calling conventionã‚‚èª¬æ˜ã—ã¦ãã‚Œã¾ã™ã€‚<br> Rustã‹ã‚‰system callã‚’è¡Œã†æ–¹æ³•ã¨ã—ã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ãª<code>asm!</code> macroã‚„FFIãŒç´¹ä»‹ã•ã‚Œã¾ã™ã€‚<br> <code>asm!</code> macroã«ã¤ã„ã¦ã¯è©³ã—ã„è§£èª¬ã‚‚ã‚ã‚Šã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[inline(never)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> syscall</span><span style=color:#eceff4>(</span><span>message</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>Â Â Â Â let</span><span> msg_ptr</span><span style=color:#81a1c1> =</span><span> message</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_ptr</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>Â Â Â Â let</span><span> len</span><span style=color:#81a1c1> =</span><span> message</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>len</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>Â Â Â Â unsafe</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>Â Â Â Â Â Â Â Â asm!</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>Â Â Â Â Â Â Â Â Â Â Â Â "</span><span style=color:#a3be8c>mov rax, 1</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>Â Â Â Â Â Â Â Â Â Â Â Â "</span><span style=color:#a3be8c>mov rdi, 1</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>Â Â Â Â Â Â Â Â Â Â Â Â "</span><span style=color:#a3be8c>syscall</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#88c0d0>Â Â Â Â Â Â Â Â Â Â Â Â in</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>rsi</span><span style=color:#eceff4>")</span><span> msg_ptr</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#88c0d0>Â Â Â Â Â Â Â Â Â Â Â Â in</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>rdx</span><span style=color:#eceff4>")</span><span> len</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#88c0d0>Â Â Â Â Â Â Â Â Â Â Â Â out</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>rax</span><span style=color:#eceff4>")</span><span> _</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#88c0d0>Â Â Â Â Â Â Â Â Â Â Â Â out</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>rdi</span><span style=color:#eceff4>")</span><span> _</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#88c0d0>Â Â Â Â Â Â Â Â Â Â Â Â lateout</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>rsi</span><span style=color:#eceff4>")</span><span> _</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#88c0d0>Â Â Â Â Â Â Â Â Â Â Â Â lateout</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>rdx</span><span style=color:#eceff4>")</span><span> _</span></span>
<span class=giallo-l><span style=color:#eceff4>Â Â Â Â Â Â Â Â );</span></span>
<span class=giallo-l><span style=color:#eceff4>Â Â Â Â }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><h2 id=chapter-4-create-your-own-event-queue><a aria-label="Anchor link for: chapter-4-create-your-own-event-queue" class=zola-anchor href=#chapter-4-create-your-own-event-queue>Chapter 4: Create Your Own Event Queue</a></h2><p>æœ¬ç« ã§ã¯ã€epollã‚’ç”¨ã„ã¦ã€ç°¡å˜ãªevent queueã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚<br> ã“ã®ä¾‹ã¯<a href=https://github.com/tokio-rs/mio rel=external>mio</a>ã«åŸºã¥ã„ã¦ã„ã¦ã€mioã®ç†è§£ã«ã‚‚ç¹«ã‚‹è¦ªåˆ‡è¨­è¨ˆã§ã™ã€‚<p>å…·ä½“çš„ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿéš›ã«epollã‚’åˆ©ç”¨ã—ãŸ<code>Poll</code>ã‚’å®Ÿè£…ã—ãªãŒã‚‰ã€epollã®ä»•çµ„ã¿ãŒè§£èª¬ã•ã‚Œã¾ã™ã€‚<br> ã¾ãŸã€<code>#[repr(packed)]</code>ã‚„bitflags, level-triggerã¨edge-trigger, <code>TcpStream::set_nodelay</code>ã¨ã„ã£ãŸé–¢é€£ã™ã‚‹å‰æã«ã¤ã„ã¦ã®èª¬æ˜ã‚‚ã‚ã‚Šã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[link(name = "</span><span style=color:#a3be8c>c</span><span style=color:#5e81ac>")]</span></span>
<span class=giallo-l><span style=color:#81a1c1>extern</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>C</span><span style=color:#eceff4>" {</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> epoll_wait</span><span style=color:#eceff4>(</span><span>epfd</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> i32</span><span style=color:#eceff4>,</span><span> events</span><span style=color:#81a1c1>: *mut</span><span style=color:#8fbcbb> Event</span><span style=color:#eceff4>,</span><span> maxevents</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> i32</span><span style=color:#eceff4>,</span><span> timeout</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> i32</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> i32</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Poll</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> poll</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> events</span><span style=color:#81a1c1>: &mut</span><span style=color:#8fbcbb> Events</span><span style=color:#eceff4>,</span><span> timeout</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>i32</span><span style=color:#eceff4>>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span style=color:#616e88>        // ...</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> res</span><span style=color:#81a1c1> = unsafe</span><span style=color:#eceff4> {</span><span style=color:#88c0d0> epoll_wait</span><span style=color:#eceff4>(</span><span>fd</span><span style=color:#eceff4>,</span><span> events</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_mut_ptr</span><span style=color:#eceff4>(),</span><span> max_events</span><span style=color:#eceff4>,</span><span> timeout</span><span style=color:#eceff4>) };</span></span>
<span class=giallo-l><span style=color:#616e88>        // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ä¸Šè¨˜ã®epollã‚’åˆ©ç”¨ã—ãŸå…·ä½“ä¾‹ã®ä»–ã«ã‚‚åŒã˜å‡¦ç†ã‚’<a href=https://github.com/tokio-rs/mio rel=external>mio</a>ã‚’åˆ©ç”¨ã—ãŸversionã®å…·ä½“ä¾‹ã‚‚è¼‰ã£ã¦ãŠã‚Šã€<a href=https://github.com/tokio-rs/mio rel=external>mio</a>ã‚ˆãã‚ã‹ã‚‰ãªã„ã¨æ€ã£ã¦ã„ãŸè‡ªåˆ†ã«ã¨ã£ã¦ã¯éå¸¸ã«ã‚ã‚ŠãŒãŸã„ç« ã¨ãªã£ã¦ãŠã‚Šã¾ã—ãŸã€‚<h2 id=chapter-5-creating-our-own-fibers><a aria-label="Anchor link for: chapter-5-creating-our-own-fibers" class=zola-anchor href=#chapter-5-creating-our-own-fibers>Chapter 5: Creating Our Own Fibers</a></h2><p>æœ¬ç« ã§ã¯ã€fiber, green threadã¨ã„ã‚ã‚Œã‚‹stackful coroutineã‚’ä½œã‚Šã¾ã™ã€‚<br> green threadã¨ã¯è¦ã™ã‚‹ã«ã€programã§assemblyã‚’æ›¸ã„ã¦ã€CPUã®registerç‰¹ã«stack pointerã‚„instruction pointerã‚’æ›¸ãæ›ãˆã¦å®Ÿè¡Œã™ã‚‹å‘½ä»¤æµã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã¨ã„ã†ã®ãŒè‡ªåˆ†ã®ç†è§£ã§ã™ã€‚<p>å…·ä½“çš„ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«threadã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’å®šç¾©ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>PartialEq</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Eq</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Debug</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>enum</span><span style=color:#8fbcbb> State</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  Available</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  Running</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  Ready</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> Thread</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>  stack</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Vec</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>u8</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>  ctx</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> ThreadContext</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>  state</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> State</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Debug</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Default</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#5e81ac>#[repr(</span><span style=color:#8fbcbb>C</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> ThreadContext</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>  rsp</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> u64</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>  r15</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> u64</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#616e88>  // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ç¾åœ¨ã®<code>ThreadContext</code>ã¨å®Ÿè¡Œã‚’åˆ‡ã‚Šæ›¿ãˆãŸã„<code>ThreadContext</code>ã‚’å¼•æ•°(<code>rdi</code>,<code>rsi</code>)ã§ã‚‚ã‚‰ã£ã¦ã€åˆ‡ã‚Šæ›¿ãˆã‚‹assemblyã‚’<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>unsafe extern</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>C</span><span style=color:#eceff4>"</span><span style=color:#81a1c1> fn</span><span style=color:#88c0d0> switch</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    asm!</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>        "</span><span style=color:#a3be8c>mov [rdi + 0x00], rsp</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#616e88>        // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>        "</span><span style=color:#a3be8c>mov [rdi + 0x30], rbp</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>        "</span><span style=color:#a3be8c>mov rsp, [rsi + 0x00]</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#616e88>        // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>        "</span><span style=color:#a3be8c>mov rbp, [rsi + 0x30]</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>        "</span><span style=color:#a3be8c>ret</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#88c0d0>        options</span><span style=color:#eceff4>(</span><span>noreturn</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    );</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>RuntimeãŒå‘¼ã³å‡ºã™ã¨ã„ã†æ„Ÿã˜ã§ã™ã€‚</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> yield</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#616e88>  // ...</span></span>
<span class=giallo-l><span style=color:#81a1c1>  unsafe</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>      let</span><span> old</span><span style=color:#81a1c1>: *mut</span><span style=color:#8fbcbb> ThreadContext</span><span style=color:#81a1c1> = &mut self.</span><span>threads</span><span style=color:#eceff4>[</span><span>old_pos</span><span style=color:#eceff4>]</span><span style=color:#81a1c1>.</span><span>ctx</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>      let</span><span> new</span><span style=color:#81a1c1>: *const</span><span> ThreadContext</span><span style=color:#81a1c1> = &self.</span><span>threads</span><span style=color:#eceff4>[</span><span>pos</span><span style=color:#eceff4>]</span><span style=color:#81a1c1>.</span><span>ctx</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>      asm!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>call switch</span><span style=color:#eceff4>",</span><span style=color:#88c0d0> in</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>rdi</span><span style=color:#eceff4>")</span><span> old</span><span style=color:#eceff4>,</span><span style=color:#88c0d0> in</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>rsi</span><span style=color:#eceff4>")</span><span> new</span><span style=color:#eceff4>,</span><span style=color:#88c0d0> clobber_abi</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>C</span><span style=color:#eceff4>"));</span></span>
<span class=giallo-l><span style=color:#eceff4>  }</span></span>
<span class=giallo-l><span style=color:#616e88>  // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã“ã®èª¬æ˜ã‚’ã—ãªãŒã‚‰ã€ISAã§ã‚ã£ãŸã‚Šã€calling conventionã€<code>asm!</code> macroã‚’è§£èª¬ã—ã¦ãã‚Œã¾ã™ã€‚<h2 id=chapter-6-futures-in-rust><a aria-label="Anchor link for: chapter-6-futures-in-rust" class=zola-anchor href=#chapter-6-futures-in-rust>Chapter 6: Futures in Rust</a></h2><p>6ç« ã¯Rustã®Futureã®æ¦‚è¦ã«ã¤ã„ã¦ã®çŸ­ã„ç« ã§ã™ã€‚<br> Rustã§ã¯builtinã®runtimeã¯æä¾›ã•ã‚Œã¦ã„ãªã„ã§ã‚ã£ãŸã‚Šã€stdãŒæä¾›ã—ã¦ã„ã‚‹ã‚‚ã®(Future trait, Waker type)ã®èª¬æ˜ãŒã‚ã‚Šã¾ã™ã€‚<br> ã¾ãŸã€async runtimeã®mental modelã¨ã—ã¦ã€Reactor, Executor,Futureã®é–¢ä¿‚ãŒè§£èª¬ã•ã‚Œã¾ã™ã€‚<h2 id=chapter-7-coroutines-and-async-await><a aria-label="Anchor link for: chapter-7-coroutines-and-async-await" class=zola-anchor href=#chapter-7-coroutines-and-async-await>Chapter 7: Coroutines and async/await</a></h2><p>Green threadã¯taskã‚’åœæ­¢/å†é–‹ã•ã›ã‚‹ãŸã‚ã®æƒ…å ±ã‚’stackã«ä¿æŒã§ãã‚‹ãŒã€stackless coroutine(Future)ã¯åœæ­¢/å†é–‹ã®ãŸã‚ã®æƒ…å ±ã‚’stateã”ã¨ã«ä¿æŒã™ã‚‹state machineã¨ã—ã¦å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã€‚<br> ãŸã ã€ã“ã®stateã‚’ç›´æ¥æ›¸ãã‚ˆã†ãªã“ã¨ã¯ã›ãšã«ã€<code>.await</code>ã‚’æ›¸ããŸã³ã«ãã“ãŒã€åœæ­¢/å†é–‹ã®ãƒã‚¤ãƒ³ãƒˆã¨ãªã‚Šã€stateãŒå®šç¾©ã•ã‚Œã‚‹ã€‚<br> ã¨ã„ã†ã‚ˆã†ãªã€async/awaitã¯å†…éƒ¨çš„ã«ã¯Stateã«ãªã£ã¦ã„ã‚‹ã¨ã„ã†ã‚ˆã†ãªèª¬æ˜ã¯rustã®futureã®èª¬æ˜ã§ã‚ˆãã¿ã‹ã‘ã‚‹ã¨æ€ã„ã¾ã™ã€‚æœ¬æ›¸ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªã¨ã“ã‚ã¯ã€async/awaitã‚’æ›¸ã„ã¦ã—ã¾ã†ã¨ã“ã®å¤‰æ›å‡¦ç†ãŒrustã®compilerå´ã§è¡Œã‚ã‚Œã¦ã—ã¾ã†ã®ã§ã€ç‹¬è‡ªã«coroutine/waitã‚’å®šç¾©ã—ã¦ã€stateã¸ã®å¤‰æ›å‡¦ç†ã‚’è‡ªä½œã®<code>corofy</code>ã§è¡Œã†ç‚¹ã§ã™ã€‚<p>å…·ä½“çš„ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªcodeã‚’<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span>coroutine</span><span style=color:#81a1c1> fn</span><span style=color:#88c0d0> async_main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> txt</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Http</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>get</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span style=color:#88c0d0>get_path</span><span style=color:#eceff4>(</span><span style=color:#b48ead>0</span><span style=color:#eceff4>))</span><span style=color:#81a1c1>.</span><span>wait</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    println!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>txt</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> txt</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Http</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>get</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span style=color:#88c0d0>get_path</span><span style=color:#eceff4>(</span><span style=color:#b48ead>1</span><span style=color:#eceff4>))</span><span style=color:#81a1c1>.</span><span>wait</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>corofy</code>ã§å¤‰æ›ã—ã¦ä»¥ä¸‹ã®ã‚ˆã†ãªcodeã‚’å‡ºåŠ›ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> async_main</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -> impl</span><span style=color:#8fbcbb> Future</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Output</span><span style=color:#81a1c1>=</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Coroutine0</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l><span>        </span></span>
<span class=giallo-l><span style=color:#81a1c1>enum</span><span style=color:#8fbcbb> State0</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Start</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#88c0d0>    Wait1</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Box</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>dyn</span><span style=color:#8fbcbb> Future</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Output</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>>>),</span></span>
<span class=giallo-l><span style=color:#88c0d0>    Wait2</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Box</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>dyn</span><span style=color:#8fbcbb> Future</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Output</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>>>),</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Resolved</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> Coroutine0</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    state</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> State0</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Coroutine0</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> new</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -> Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        Self</span><span style=color:#eceff4> {</span><span> state</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> State0</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Start</span><span style=color:#eceff4> }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Future</span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> Coroutine0</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Output</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> poll</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> PollState</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>Self::</span><span style=color:#8fbcbb>Output</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        loop</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        match self.</span><span>state </span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            State0</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Start</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>              // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>            State0</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Wait1</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>ref mut</span><span> f1</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>              / ...</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>å‹•ãå…·ä½“ä¾‹ãŒã‚ã‚‹ã®ã§ã€<code>.await</code>ã‚’æ›¸ããŸã³ã«stateãŒå®šç¾©ã•ã‚Œã‚‹ã¨ã„ã†ã®ãŒã¨ã¦ã‚‚ã‚ã‹ã‚Šã‚„ã™ã„ã¨æ€ã„ã¾ã—ãŸã€‚ã¾ãŸã€å¤‰æ›å‡¦ç†ã‚’è‡ªä½œã™ã‚‹ã“ã¨ã§å¾Œè¿°ã®self referenceã®å•é¡Œã®ã‚ã‹ã‚Šã‚„ã™ã•ã«ã‚‚ç¹‹ãŒã£ã¦ã„ã‚‹ã¨æ€ã„ã¾ã—ãŸã€‚<h2 id=chapter-8-runtimes-wakers-and-the-reactor-executor-pattern><a aria-label="Anchor link for: chapter-8-runtimes-wakers-and-the-reactor-executor-pattern" class=zola-anchor href=#chapter-8-runtimes-wakers-and-the-reactor-executor-pattern>Chapter 8: Runtimes, Wakers, And The Reactor-Executor Pattern</a></h2><p>7ç« ã§ã¯ã€ä½œã£ã¦ã„ãªã‹ã£ãŸRuntimeã‚’ä½œã‚Šã¾ã™ã€‚reactorã«ã¯mioã‚’ä½¿ã„ã¾ã™ã€‚ è‡ªåˆ†ã¯runtimeã¯futureã‚’pollã—ã¦ãã‚Œã¦ã„ã‚‹ãã‚‰ã„ã®ç†è§£ã§ã€reactor(mio)ã‚’ã©ã®ã‚ˆã†ã«åˆ©ç”¨ã™ã‚‹ã®ã‹ãŒãƒ”ãƒ³ã¨ãã¦ã„ãªã‹ã£ãŸã®ã§æœ¬ç« ã¯ã¨ã¦ã‚‚ã‚ã‚ŠãŒãŸã‹ã£ãŸã§ã™ã€‚æœ€åˆã¯executorãŒç›´æ¥reactorã«ä¾å­˜ã™ã‚‹å½¢ã§å®Ÿè£…ã—ãŸã®ã¡ã€executorã¨reactorã‚’ç–çµã«ã™ã‚‹ãŸã‚ã«ã€<code>Waker</code>ã‚’åˆ©ç”¨ã—ãŸå½¢ã«ã—ã¦ã„ãã¨ã„ã†æµã‚Œãªã®ã‚‚ã‚ã‹ã‚Šã‚„ã™ã‹ã£ãŸã§ã™ã€‚<br> <code>Waker</code>ã®wakeå‡¦ç†ã¯<code>Thread::unpark()</code>ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚threadã®parké–¢é€£ã¯<a href=https://blog.ymgyt.io/entry/rust-atomics-and-locks-ja/ rel=external>Rustã‚¢ãƒˆãƒŸãƒƒã‚¯æ“ä½œã¨ãƒ­ãƒƒã‚¯</a>ã§è©³ã—ãèª¬æ˜ã—ã¦ãã‚Œã¦ã„ãŸã®ã§ã€ã™ã‚“ãªã‚Šç†è§£ã§ããŸã®ãŒã†ã‚Œã—ã‹ã£ãŸã§ã™ã€‚<br> (ãªãŠã€æœ¬ç« ã®ä¾‹ã§ã¯work stealã¾ã§ã¯å®Ÿè£…ã•ã‚Œã¾ã›ã‚“ã€‚)<h2 id=chapter-9-coroutines-self-referential-struct-and-pinning><a aria-label="Anchor link for: chapter-9-coroutines-self-referential-struct-and-pinning" class=zola-anchor href=#chapter-9-coroutines-self-referential-struct-and-pinning>Chapter 9: Coroutines, Self-Referential Struct, And Pinning</a></h2><p>Rustã®Futureã¨ã„ãˆã°ã€Pinã¿ãŸã„ãªã¨ã“ã‚ãŒã‚ã‚Šã¾ã™ãŒã€å®Ÿã¯ã“ã‚Œã¾ã§ã®ä¾‹ã§ã¯å·§å¦™ã«Pinã®å•é¡Œã‚’é¿ã‘ã¦ã„ã¾ã—ãŸã€‚<br> æœ¬ç« ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«waitã‚’ã¾ãŸã„ã§é–¢æ•°å†…ã®å¤‰æ•°(<code>counter</code>)ã®å‚ç…§ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§ã€ç”Ÿæˆã•ã‚Œã‚‹stateã«localå¤‰æ•°ã‚’ä¿æŒã§ãã‚‹ã‚ˆã†ãªå¯¾å¿œã‚’è¿½åŠ ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span>coroutine</span><span style=color:#81a1c1> fn</span><span style=color:#88c0d0> async_main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>Â Â Â Â let mut</span><span> counter</span><span style=color:#81a1c1> =</span><span style=color:#b48ead> 0</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>Â Â Â Â let</span><span> txt</span><span style=color:#81a1c1> =</span><span> http</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Http</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>get</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>/600/HelloAsyncAwait</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>.</span><span>wait</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span>Â Â Â Â counter</span><span style=color:#81a1c1> +=</span><span style=color:#b48ead> 1</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>Â Â Â Â let</span><span> txt</span><span style=color:#81a1c1> =</span><span> http</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Http</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>get</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>/400/HelloAsyncAwait</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>.</span><span>wait</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span>Â Â Â Â counter</span><span style=color:#81a1c1> +=</span><span style=color:#b48ead> 1</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã“ã‚Œã«ã‚ˆã£ã¦ã€async(coroutine)å†…ã§æ›¸ã„ãŸlocalå¤‰æ•°ãŒã©ã®ã‚ˆã†ã«å¤‰æ›ã•ã‚Œã‚‹ã‹ã‚’ç†è§£ã—ãŸã‚ã¨ã«æœ¬å‘½ã®self referenceã®å•é¡ŒãŒç´¹ä»‹ã•ã‚Œã¾ã™<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span>coroutine</span><span style=color:#81a1c1> fn</span><span style=color:#88c0d0> async_main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>Â Â Â Â let mut</span><span> buffer</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> String</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>\n</span><span style=color:#a3be8c>BUFFER:</span><span style=color:#ebcb8b>\n</span><span style=color:#a3be8c>----</span><span style=color:#ebcb8b>\n</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#81a1c1>Â Â Â Â let</span><span> writer</span><span style=color:#81a1c1> = &mut</span><span> buffer</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>Â Â Â Â let</span><span> txt</span><span style=color:#81a1c1> =</span><span> http</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Http</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>get</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>/600/HelloAsyncAwait</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>.</span><span>wait</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>Â Â Â Â let</span><span> txt</span><span style=color:#81a1c1> =</span><span> http</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Http</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>get</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>/400/HelloAsyncAwait</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>.</span><span>wait</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>Â Â Â Â writeln!</span><span style=color:#eceff4>(</span><span>writer</span><span style=color:#eceff4>, "</span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>txt</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ä¸Šè¨˜ã®ã‚ˆã†ã«ã€<code>&mut buffer</code>ã®ã‚ˆã†ãªå‚ç…§ã‚’localå¤‰æ•°ã¨ã™ã‚‹ã¨<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Default</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> Stack0</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    buffer</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>    writer</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>*mut</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> Coroutine0</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    stack</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Stack0</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    state</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> State0</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    _pin</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> PhantomPinned</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ç”Ÿæˆã•ã‚Œã‚‹state(<code>Coroutine0</code>)ã§è‡ªèº«ã®fieldã¸ã®å‚ç…§(ä¿æŒã§ããªã„ã®ã§pointer)ã‚’ä¿æŒã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€ã“ã®structã‚’moveã™ã‚‹ã¨pointerã®å‚ç…§ãŒå£Šã‚Œã¦ã—ã¾ã†ã¨ã¤ãªãŒã‚Šã¾ã™ã€‚<br> ã“ã“ã‹ã‚‰ã€<code>Pin</code>ã‚„<code>Unpin</code>ã®è§£èª¬ãŒã‚ã‚Šã¾ã™ã€‚<code>Pin</code>ã®èª¬æ˜ã¯å›³ãŒè±Šå¯Œã§ã€localå¤‰æ•°ã®å‚ç…§ã‚’struct fieldã«å¤‰æ›ã™ã‚‹å‡¦ç†ã‚’å®Ÿéš›ã«å‹•ãã‚³ãƒ¼ãƒ‰ã«ã—ã¦ãã‚Œã¦ã„ã‚‹ã®ã§ã€å…·ä½“çš„ã§ã‚ã‹ã‚Šã‚„ã™ã„ã§ã™ã€‚<h2 id=chapter-10-creating-your-own-runtime><a aria-label="Anchor link for: chapter-10-creating-your-own-runtime" class=zola-anchor href=#chapter-10-creating-your-own-runtime>Chapter 10: Creating Your Own Runtime</a></h2><p>ã“ã‚Œã¾ã§åˆ©ç”¨ã—ã¦ããŸè‡ªä½œã®Wakerã§ã‚ã£ãŸã‚ŠFuture traitã§ã‚ã£ãŸã‚Šã‚’rustã®stdã®ã‚‚ã®ã«ã—ã¦your own runtimeã‚’å®Œæˆã•ã›ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=toml><span class=giallo-l><span style=color:#eceff4>[</span><span>dependencies</span><span style=color:#eceff4>]</span></span>
<span class=giallo-l><span>mio</span><span style=color:#eceff4> = {</span><span> version</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>0.8</span><span style=color:#eceff4>",</span><span> features</span><span style=color:#eceff4> = ["</span><span style=color:#a3be8c>net</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>os-poll</span><span style=color:#eceff4>"] }</span></span></code></pre><p>mioã ã‘ã®ä¾å­˜ã§ã€ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ãŒå‹•ãã‚ˆã†ã«ãªã‚Šã¾ã™!<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> executor</span><span style=color:#81a1c1> =</span><span> runtime</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>init</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span>    executor</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>block_on</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>async_main</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> async_main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    println!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Program starting</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> txt</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Http</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>get</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>/600/HelloAsyncAwait</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    println!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>txt</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> txt</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Http</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>get</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>/400/HelloAsyncAwait</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    println!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>txt</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ç¾çŠ¶ã®Rustã®éåŒæœŸã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ã®èª²é¡Œã®èª¬æ˜ã‚‚ã‚ã‚Šã¾ã™ã€‚ tokioã§async_stdã®é•ã„ã¨ã—ã¦reactorã®æ˜ç¤ºçš„ãªèµ·å‹•ã‚’è¦æ±‚ã™ã‚‹ã‹ã©ã†ã‹ã§ã‚ã£ãŸã‚Šã€Ascyn dropã«ã¤ã„ã¦ãŒè§£èª¬ã•ã‚Œã¾ã™ã€‚</div></article></main><footer class=blog-footer><p>Â© 2026 <a href=https://blog.ymgyt.io> ymgyt </a> | Made with <a href=https://www.getzola.org rel=noopener target=_blank>Zola</a> | <a href=https://github.com/ymgyt/blog>Repository</a> | <a href=https://blog.ymgyt.io/atom.xml target=_blank title=rss> <svg viewbox="0 0 24 24" class=icon fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx=5 cy=19 r=1></circle></svg> </a></footer></div></div>