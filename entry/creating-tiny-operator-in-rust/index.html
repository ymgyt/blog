<!doctype html><html lang=ja><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1" name=viewport><link href=https://blog.ymgyt.io/favicon.ico rel=icon sizes=any><link href=https://blog.ymgyt.io/icon.svg rel=icon type=image/svg+xml><link href=https://blog.ymgyt.io/apple-touch-icon.png rel=apple-touch-icon><link href=https://blog.ymgyt.io/manifest.webmanifest rel=manifest><link href=https://blog.ymgyt.io/style.css rel=stylesheet><link href=https://blog.ymgyt.io/atom.xml rel=alternate title=Atom type=application/atom+xml><script src="https://www.googletagmanager.com/gtag/js?id=G-GTB0KMLN90" async></script><script>window.dataLayer = window.dataLayer || [];
	function gtag() {dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-GTB0KMLN90');</script><title>âš™ï¸ kube-rsã‚’ä½¿ã£ã¦Rustã§ç°¡å˜ãªKubernetes Operatorã‚’ä½œã£ã¦ã¿ã‚‹ | Happy developing</title><meta content=kube-rsã®ä½¿ã„æ–¹ã‚„ä»•çµ„ã¿ã«ã¤ã„ã¦ name=description><meta content=summary name=twitter:card><meta content="@YAmaguchixt " name=twitter:site><meta content="âš™ï¸ kube-rsã‚’ä½¿ã£ã¦Rustã§ç°¡å˜ãªKubernetes Operatorã‚’ä½œã£ã¦ã¿ã‚‹" name=twitter:title><meta content=kube-rsã®ä½¿ã„æ–¹ã‚„ä»•çµ„ã¿ã«ã¤ã„ã¦ name=twitter:description><meta content=https://blog.ymgyt.io/images/emoji/gear.png name=twitter:image><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><body><div class=world><div class=content-container><header class=blog-header-container><div class=blog-logo><a href=https://blog.ymgyt.io>Happy developing</a></div><div class=blog-nav><nav><ul><li><a href=https://blog.ymgyt.io/entry/>Entries</a><li><a href=https://blog.ymgyt.io/tags/>Tags</a><li><a href=https://blog.ymgyt.io/about/>About</a><li><a href=https://github.com/ymgyt> <img alt=Github class=icon src=https://blog.ymgyt.io/images/icon/github.svg> </a><li><a href="https://twitter.com/YAmaguchixt "> <img alt=Twitter class=icon src=https://blog.ymgyt.io/images/icon/twitter.svg> </a></ul></nav></div></header><main class=blog-main><article><header class=entry-header><h1 class=entry-title>âš™ï¸ kube-rsã‚’ä½¿ã£ã¦Rustã§ç°¡å˜ãªKubernetes Operatorã‚’ä½œã£ã¦ã¿ã‚‹</h1><div class=entry-meta><p class=entry-meta-item>ğŸ—“ 2023-09-28<p class=entry-meta-item>ğŸ· <span class=tag><a href=https://blog.ymgyt.io/tags/rust/>rust</a></span></div></header><aside class=entry-toc><nav><ul class=entry-toc-toplevel-list><li><a href=https://blog.ymgyt.io/entry/creating-tiny-operator-in-rust/#tl-dr>TL;DR</a><li><a href=https://blog.ymgyt.io/entry/creating-tiny-operator-in-rust/#qian-ti>å‰æ</a><li><a href=https://blog.ymgyt.io/entry/creating-tiny-operator-in-rust/#custom-resource>Custom Resource</a> <ul><li><a href=https://blog.ymgyt.io/entry/creating-tiny-operator-in-rust/#crdnovalidation>CRDã®Validation</a></ul><li><a href=https://blog.ymgyt.io/entry/creating-tiny-operator-in-rust/#operator>Operator</a> <ul><li><a href=https://blog.ymgyt.io/entry/creating-tiny-operator-in-rust/#reconcile>Reconcile</a></ul><li><a href=https://blog.ymgyt.io/entry/creating-tiny-operator-in-rust/#jian-zheng>æ¤œè¨¼</a><li><a href=https://blog.ymgyt.io/entry/creating-tiny-operator-in-rust/#matome>ã¾ã¨ã‚</a><li><a href=https://blog.ymgyt.io/entry/creating-tiny-operator-in-rust/#can-kao>å‚è€ƒ</a><li><a href=https://blog.ymgyt.io/entry/creating-tiny-operator-in-rust/#bonasutoratuku>ãƒœãƒ¼ãƒŠã‚¹ãƒˆãƒ©ãƒƒã‚¯</a></ul></nav></aside><div class=entry-content><p>ç¤¾å†…ã§è¡Œã£ã¦ã„ã‚‹Rustã®å‹‰å¼·ä¼šã§<a href=https://github.com/kube-rs/kube rel=external>kube-rs</a>ã‚’åˆ©ç”¨ã—ãŸKubernetes operatorã‚’æ‰±ã„ã¾ã—ãŸã€‚ æœ¬è¨˜äº‹ã§ã¯ãã“ã§å­¦ã‚“ã <a href=https://github.com/kube-rs/kube rel=external>kube-rs</a>ã®ä½¿ã„æ–¹ã‚„ä»•çµ„ã¿ã«ã¤ã„ã¦æ›¸ãã¾ã™ã€‚ æ¦‚è¦ã¨ã—ã¦ã¯ã€<code>Hello</code> <a href=https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/ rel=external>Custom Resource</a>ã‚’å®šç¾©ã—ã¦manifestã‚’applyã™ã‚‹ã¨ã€å¯¾å¿œã™ã‚‹Deploymentã‚’operatorãŒä½œæˆã—ã€manifestã‚’å‰Šé™¤ã™ã‚‹ã¨Deploymentã‚’å‰Šé™¤ã™ã‚‹ã¾ã§ã‚’å®Ÿè£…ã—ã¾ã™ã€‚<h2 id=tl-dr><a aria-label="Anchor link for: tl-dr" class=zola-anchor href=#tl-dr>TL;DR</a></h2><ul><li><a href=https://github.com/kube-rs/kube rel=external>kube-rs</a>ã‚’åˆ©ç”¨ã™ã‚‹ã¨Rustã‹ã‚‰ç°¡å˜ã«kubernetes apiã‚’åˆ©ç”¨ã§ãã‚‹<li><a href=https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/ rel=external>CRD</a>ã‚’rustã§å®šç¾©ã™ã‚‹ã“ã¨ãŒã§ãã€yamlã‚‚å‡ºåŠ›ã§ãã‚‹<li>Operatorã®ãŸã‚ã®æ©Ÿèƒ½ã‚‚æä¾›ã•ã‚Œã¦ã„ã‚‹ã®ã§reconcileã®å‡¦ç†ã«é›†ä¸­ã§ãã‚‹</ul><h2 id=qian-ti><a aria-label="Anchor link for: qian-ti" class=zola-anchor href=#qian-ti>å‰æ</a></h2><p>Kubernetes clusterã¨<code>kubectl</code>ãŒåˆ©ç”¨ã§ãã‚‹ã“ã¨ã€‚<br> dependenciesã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=toml><span class=giallo-l><span style=color:#eceff4>[</span><span>dependencies</span><span style=color:#eceff4>]</span></span>
<span class=giallo-l><span>anyhow</span><span style=color:#eceff4> = {</span><span> version</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>1.0</span><span style=color:#eceff4>",</span><span> default_features</span><span style=color:#eceff4> =</span><span style=color:#81a1c1> false</span><span style=color:#eceff4>,</span><span> features</span><span style=color:#eceff4> = ["</span><span style=color:#a3be8c>std</span><span style=color:#eceff4>"] }</span></span>
<span class=giallo-l><span>futures</span><span style=color:#eceff4> = {</span><span> version</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>0.3.28</span><span style=color:#eceff4>",</span><span> default_features</span><span style=color:#eceff4> =</span><span style=color:#81a1c1> false</span><span style=color:#eceff4> }</span></span>
<span class=giallo-l><span>garde</span><span style=color:#eceff4> = {</span><span> version</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>0.15.0</span><span style=color:#eceff4>" ,</span><span> features</span><span style=color:#eceff4> = ["</span><span style=color:#a3be8c>derive</span><span style=color:#eceff4>"] }</span></span>
<span class=giallo-l><span>kube</span><span style=color:#eceff4> = {</span><span> version</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>0.85.0</span><span style=color:#eceff4>",</span><span> default_features</span><span style=color:#eceff4> =</span><span style=color:#81a1c1> false</span><span style=color:#eceff4>,</span><span> features</span><span style=color:#eceff4> = ["</span><span style=color:#a3be8c>client</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>rustls-tls</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>derive</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>runtime</span><span style=color:#eceff4>"] }</span></span>
<span class=giallo-l><span>k8s-openapi</span><span style=color:#eceff4> = {</span><span> version</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>0.19.0</span><span style=color:#eceff4>",</span><span> default_features</span><span style=color:#eceff4> =</span><span style=color:#81a1c1> false</span><span style=color:#eceff4>,</span><span> features</span><span style=color:#eceff4> = ["</span><span style=color:#a3be8c>v1_27</span><span style=color:#eceff4>"] }</span></span>
<span class=giallo-l><span>schemars</span><span style=color:#eceff4> = {</span><span> version</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>0.8.12</span><span style=color:#eceff4>",</span><span> default_features</span><span style=color:#eceff4> =</span><span style=color:#81a1c1> false</span><span style=color:#eceff4>,</span><span> features</span><span style=color:#eceff4> = ["</span><span style=color:#a3be8c>derive</span><span style=color:#eceff4>"] }</span></span>
<span class=giallo-l><span>serde</span><span style=color:#eceff4> = {</span><span> version</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>1.0</span><span style=color:#eceff4>",</span><span> default_features</span><span style=color:#eceff4> =</span><span style=color:#81a1c1> false</span><span style=color:#eceff4>,</span><span> features</span><span style=color:#eceff4> = ["</span><span style=color:#a3be8c>derive</span><span style=color:#eceff4>"]}</span></span>
<span class=giallo-l><span>serde_json</span><span style=color:#eceff4> = {</span><span> version</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>1.0.105</span><span style=color:#eceff4>",</span><span> default_features</span><span style=color:#eceff4> =</span><span style=color:#81a1c1> false</span><span style=color:#eceff4> }</span></span>
<span class=giallo-l><span>serde_yaml</span><span style=color:#eceff4> = {</span><span> version</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>0.9.25</span><span style=color:#eceff4>",</span><span> default_features</span><span style=color:#eceff4> =</span><span style=color:#81a1c1> false</span><span style=color:#eceff4> }</span></span>
<span class=giallo-l><span>thiserror</span><span style=color:#eceff4> = {</span><span> version</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>1.0.47</span><span style=color:#eceff4>",</span><span> default_features</span><span style=color:#eceff4> =</span><span style=color:#81a1c1> false</span><span style=color:#eceff4> }</span></span>
<span class=giallo-l><span>tokio</span><span style=color:#eceff4> = {</span><span> version</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>1.32.0</span><span style=color:#eceff4>",</span><span> default_features</span><span style=color:#eceff4> =</span><span style=color:#81a1c1> false</span><span style=color:#eceff4>,</span><span> features</span><span style=color:#eceff4> = ["</span><span style=color:#a3be8c>rt-multi-thread</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>macros</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>signal</span><span style=color:#eceff4>"] }</span></span>
<span class=giallo-l><span>tracing</span><span style=color:#eceff4> = {</span><span> version</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>0.1.37</span><span style=color:#eceff4>",</span><span> default_features</span><span style=color:#eceff4> =</span><span style=color:#81a1c1> false</span><span style=color:#eceff4> }</span></span>
<span class=giallo-l><span>tracing-subscriber</span><span style=color:#eceff4> = {</span><span> version</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>0.3.17</span><span style=color:#eceff4>",</span><span> default_features</span><span style=color:#eceff4> =</span><span style=color:#81a1c1> false</span><span style=color:#eceff4>,</span><span> features</span><span style=color:#eceff4> = ["</span><span style=color:#a3be8c>registry</span><span style=color:#eceff4>","</span><span style=color:#a3be8c>fmt</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>ansi</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>env-filter</span><span style=color:#eceff4>"</span><span style=background-color:#bf616a> }</span></span></code></pre><p>ä½œæˆã™ã‚‹operatorã¯<code>cargo run</code>ã§localã§èµ·å‹•ã—ã¾ã™ã€‚ãã®éš›ã€kubernetes apiã¨ã®é€šä¿¡ã®ãŸã‚ã«<code>KUBECONFIG</code>ç’°å¢ƒå¤‰æ•°ã‚’å‚ç…§ã—ã¦kubectlã®è¨­å®šfileã‚’æ¢ã—ã¾ã™ã€‚<br> ãã®ãŸã‚ã€<code>KUBECONFIG</code>ã«æ¤œè¨¼ã™ã‚‹clusterã¸ã®è¨­å®šãŒãªã•ã‚Œã¦ã„ã‚‹çŠ¶æ…‹ãŒå¿…è¦ã§ã™ã€‚ è‡ªåˆ†ã¯<a href=https://k3s.io/ rel=external>k3s</a>ã‚’åˆ©ç”¨ã—ãŸã®ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šã—ã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span>$env.KUBECONFIG = /etc/rancher/k3s/k3s.yaml</span></span></code></pre><h2 id=custom-resource><a aria-label="Anchor link for: custom-resource" class=zola-anchor href=#custom-resource><a href=https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/ rel=external>Custom Resource</a></a></h2><p>ã¾ãšã¯æœ¬è¨˜äº‹ã§æ‰±ã£ã¦ã„ã<a href=https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/ rel=external>Custom Resource</a>ã€<code>Hello</code>ã‚’å®šç¾©ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> garde</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Validate</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> kube</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>Api</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Client</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> CustomResource</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> ResourceExt</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> schemars</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>JsonSchema</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> serde</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>Deserialize</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Serialize</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>/// See docs for possible properties</span></span>
<span class=giallo-l><span style=color:#616e88>/// https://docs.rs/kube/latest/kube/derive.CustomResource.html#optional-kube-attributes</span></span>
<span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>CustomResource</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Debug</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> PartialEq</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Clone</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Serialize</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Deserialize</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> JsonSchema</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Validate</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#5e81ac>#[kube(</span></span>
<span class=giallo-l><span style=color:#616e88>    // Required properties</span></span>
<span class=giallo-l><span style=color:#5e81ac>    group = "</span><span style=color:#a3be8c>fraim.co.jp</span><span style=color:#5e81ac>",</span></span>
<span class=giallo-l><span style=color:#5e81ac>    version = "</span><span style=color:#a3be8c>v1</span><span style=color:#5e81ac>",</span></span>
<span class=giallo-l><span style=color:#5e81ac>    kind = "</span><span style=color:#a3be8c>Hello</span><span style=color:#5e81ac>",</span></span>
<span class=giallo-l><span style=color:#616e88>    // Optional properties</span></span>
<span class=giallo-l><span style=color:#5e81ac>    singular = "</span><span style=color:#a3be8c>hello</span><span style=color:#5e81ac>",</span></span>
<span class=giallo-l><span style=color:#5e81ac>    plural = "</span><span style=color:#a3be8c>helloes</span><span style=color:#5e81ac>",</span></span>
<span class=giallo-l><span style=color:#5e81ac>    shortname = "</span><span style=color:#a3be8c>hlo</span><span style=color:#5e81ac>",</span></span>
<span class=giallo-l><span style=color:#5e81ac>    namespaced,</span></span>
<span class=giallo-l><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> HelloSpec</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#5e81ac>    #[garde(range(max = 20))]</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> replicas</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> u32</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span></code></pre><p>UserãŒå®šç¾©ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã¯ã€<code>spec</code>ã«å¯¾å¿œã™ã‚‹structã§ã™ã€‚<br> ã“ã“ã§ã¯ã€<code>HelloSpec</code>ã¨ã—ã¦ã„ã¾ã™ã€‚ã“ã®structã«<code>#[derive(kube::CustomResource)]</code>ã‚’æŒ‡å®šã—ã¾ã™ã€‚<br> <a href=https://docs.rs/kube/0.85.0/kube/derive.CustomResource.html rel=external><code>CustomResource</code></a>ã«ã‚ˆã£ã¦æ¦‚ã­ä»¥ä¸‹ã®ã‚ˆã†ãªcodeãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[serde(rename_all = "</span><span style=color:#a3be8c>camelCase</span><span style=color:#5e81ac>")]</span></span>
<span class=giallo-l><span style=color:#5e81ac>#[serde(</span><span style=color:#81a1c1>crate</span><span style=color:#5e81ac> = "</span><span style=color:#a3be8c>:: serde</span><span style=color:#5e81ac>")]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> Hello</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#5e81ac>    #[schemars(skip)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> metadata</span><span style=color:#81a1c1>: ::</span><span>k8s_openapi</span><span style=color:#81a1c1>::</span><span>apimachinery</span><span style=color:#81a1c1>::</span><span>pkg</span><span style=color:#81a1c1>::</span><span>apis</span><span style=color:#81a1c1>::</span><span>meta</span><span style=color:#81a1c1>::</span><span>v1</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>ObjectMeta</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> spec</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> HelloSpec</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Hello</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>    /// Spec based constructor for derived custom resource</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> new</span><span style=color:#eceff4>(</span><span>name</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>str</span><span style=color:#eceff4>,</span><span> spec</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> HelloSpec</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            metadata</span><span style=color:#81a1c1>: ::</span><span>k8s_openapi</span><span style=color:#81a1c1>::</span><span>apimachinery</span><span style=color:#81a1c1>::</span><span>pkg</span><span style=color:#81a1c1>::</span><span>apis</span><span style=color:#81a1c1>::</span><span>meta</span><span style=color:#81a1c1>::</span><span>v1</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>ObjectMeta</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                name</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>name</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_string</span><span style=color:#eceff4>()),</span></span>
<span class=giallo-l><span style=color:#81a1c1>                ..</span><span style=color:#8fbcbb>Default</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>            },</span></span>
<span class=giallo-l><span>            spec</span><span style=color:#81a1c1>:</span><span> spec</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl ::</span><span>kube</span><span style=color:#81a1c1>::</span><span>core</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Resource</span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> Hello</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> DynamicType</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> ();</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Scope</span><span style=color:#81a1c1> = ::</span><span>kube</span><span style=color:#81a1c1>::</span><span>core</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>NamespaceResourceScope</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l><span style=color:#81a1c1>impl ::</span><span>kube</span><span style=color:#81a1c1>::</span><span>core</span><span style=color:#81a1c1>::</span><span>crd</span><span style=color:#81a1c1>::</span><span>v1</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>CustomResourceExt</span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> Hello</span><span style=color:#eceff4> {</span><span style=color:#616e88> /* ... */</span><span style=color:#eceff4>}</span></span></code></pre><p>ç”Ÿæˆã•ã‚ŒãŸå„ç¨®å‡¦ç†ãŒã©ã®ã‚ˆã†ã«åˆ©ç”¨ã§ãã‚‹ã‹ã¯å®Ÿè£…ã‚’é€²ã‚ã‚‹ã¨ã‚ã‹ã£ã¦ãã¾ã™ã€‚ æ¦‚è¦ã¨ã—ã¦ã¯<ul><li><code>spec</code>ã«å¯¾å¿œã™ã‚‹rootã®resource(<code>Hello</code>)ã¯deriveã§ç”Ÿæˆã•ã‚Œã‚‹<li>ç”Ÿæˆã•ã‚ŒãŸstructã«ã¯<code>kube::Resource</code> traitãŒå®Ÿè£…ã•ã‚Œã¦ãŠã‚Šã€Podã‚„Deploymentç­‰ã€apiã®resourceã¨ã—ã¦æ‰±ãˆã‚‹<li>CRDé–¢é€£ã®æ©Ÿèƒ½ã¯<code>kube::CustomResourceExt</code> traitã®å®Ÿè£…ã‚’é€šã˜ã¦æä¾›ã•ã‚Œã‚‹</ul><p>CRDã®api groupç­‰ã®æŒ‡å®šã¯<code>#[kube()]</code> annotationã«ã‚ˆã£ã¦è¡Œãˆã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[kube(</span></span>
<span class=giallo-l><span style=color:#616e88>    // Required properties</span></span>
<span class=giallo-l><span style=color:#5e81ac>    group = "</span><span style=color:#a3be8c>fraim.co.jp</span><span style=color:#5e81ac>",</span></span>
<span class=giallo-l><span style=color:#5e81ac>    version = "</span><span style=color:#a3be8c>v1</span><span style=color:#5e81ac>",</span></span>
<span class=giallo-l><span style=color:#5e81ac>    kind = "</span><span style=color:#a3be8c>Hello</span><span style=color:#5e81ac>",</span></span>
<span class=giallo-l><span style=color:#616e88>    // Optional properties</span></span>
<span class=giallo-l><span style=color:#5e81ac>    singular = "</span><span style=color:#a3be8c>hello</span><span style=color:#5e81ac>",</span></span>
<span class=giallo-l><span style=color:#5e81ac>    plural = "</span><span style=color:#a3be8c>helloes</span><span style=color:#5e81ac>",</span></span>
<span class=giallo-l><span style=color:#5e81ac>    shortname = "</span><span style=color:#a3be8c>hlo</span><span style=color:#5e81ac>",</span></span>
<span class=giallo-l><span style=color:#5e81ac>    namespaced,</span></span>
<span class=giallo-l><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> HelloSpec</span><span style=color:#eceff4> {</span><span style=color:#616e88> /* ... */</span><span style=color:#eceff4> }</span></span></code></pre><p><a href=https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/ rel=external>CRD</a>ã®2é‡ç®¡ç†ã‚’é¿ã‘ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã€ä»¥ä¸‹ã®ã‚ˆã†ã«<code>CustomResourceExt::crd()</code>ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€<a href=https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/ rel=external>CRD</a> yamlã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> example</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Hello</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> kube</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>CustomResourceExt</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span> serde_yaml</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span>    serde_yaml</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>to_writer</span><span style=color:#eceff4>(</span><span>std</span><span style=color:#81a1c1>::</span><span>io</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>stdout</span><span style=color:#eceff4>(),</span><span style=color:#81a1c1> &</span><span>Hello</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>crd</span><span style=color:#eceff4>())</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>cargo run --quiet out> manifests/helloes-crd.yaml</code><p>ç”Ÿæˆã•ã‚ŒãŸyaml<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=yaml><span class=giallo-l><span style=color:#8fbcbb>apiVersion</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> apiextensions.k8s.io/v1</span></span>
<span class=giallo-l><span style=color:#8fbcbb>kind</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> CustomResourceDefinition</span></span>
<span class=giallo-l><span style=color:#8fbcbb>metadata</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  name</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> helloes.fraim.co.jp</span></span>
<span class=giallo-l><span style=color:#8fbcbb>spec</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  group</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> fraim.co.jp</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  names</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    categories</span><span style=color:#eceff4>: []</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    kind</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> Hello</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    plural</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> helloes</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    shortNames</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#eceff4>    -</span><span style=color:#a3be8c> hlo</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    singular</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> hello</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  scope</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> Namespaced</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  versions</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#eceff4>  -</span><span style=color:#8fbcbb> additionalPrinterColumns</span><span style=color:#eceff4>: []</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    name</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> v1</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    schema</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      openAPIV3Schema</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        description</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> Auto-generated derived type for HelloSpec via `CustomResource`</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        properties</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>          spec</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            description</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> See docs for possible properties https://docs.rs/kube/latest/kube/derive.CustomResource.html#optional-kube-attributes</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            properties</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>              replicas</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                format</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> uint32</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                minimum</span><span style=color:#eceff4>:</span><span style=color:#b48ead> 0.0</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                type</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> integer</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            required</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#eceff4>            -</span><span style=color:#a3be8c> replicas</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            type</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> object</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        required</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#eceff4>        -</span><span style=color:#a3be8c> spec</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        title</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> Hello</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        type</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> object</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    served</span><span style=color:#eceff4>:</span><span style=color:#81a1c1> true</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    storage</span><span style=color:#eceff4>:</span><span style=color:#81a1c1> true</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    subresources</span><span style=color:#eceff4>: {}</span></span></code></pre><p>ç”Ÿæˆã•ã‚ŒãŸyamlã‚’applyã™ã‚‹ã“ã¨ã§ã€<code>Hello</code> CRDã‚’å®šç¾©ã§ãã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>kubectl</span><span style=color:#a3be8c> apply -f manifests/helloes-crd.yaml</span></span>
<span class=giallo-l><span style=color:#88c0d0>customresourcedefinition.apiextensions.k8s.io/helloes.fraim.co.jp</span><span style=color:#a3be8c> created</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>kubectl</span><span style=color:#a3be8c> get crds</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> rg</span><span style=color:#a3be8c> helloes</span></span>
<span class=giallo-l><span style=color:#88c0d0>helloes.fraim.co.jp</span></span></code></pre><p><a href=https://github.com/kube-rs/kube rel=external>kube-rs</a>ã‚’åˆ©ç”¨ã—ã¦CRDã‚’<a href=https://github.com/kube-rs/kube/blob/main/examples/crd_apply.rs rel=external>applyã™ã‚‹ä¾‹</a>ã‚‚ç”¨æ„ã•ã‚Œã¦ã„ã¾ã—ãŸãŒä»Šå›ã¯kubectlã‚’åˆ©ç”¨ã—ã¾ã—ãŸã€‚<br> æœ€åˆã¯ã€operatorèµ·å‹•æ™‚ã«CRDã‚’applyã™ã‚‹å‡¦ç†ãŒã‚ã‚Œã°ã€operatorã®userãŒè‡ªèº«ã§CRDã‚’é©ç”¨ã™ã‚‹å¿…è¦ãŒãªãä¾¿åˆ©ã ã¨è€ƒãˆã¦ã„ã¾ã—ãŸã€‚<br> ã—ã‹ã—ãªãŒã‚‰ã€ãã®ãŸã‚ã«ã¯operatorã«cluster scopeã®CRDä½œæˆæ¨©é™ã®ä»˜ä¸ãŒå¿…è¦ã§ã€é€šå¸¸ãã‚Œã¯å¤§ãã™ãã‚‹æ¨©é™ã®ãŸã‚ã€operatorã«ã¯å‡¦ç†ã«å¿…è¦ãªæ¨©é™ã®ã¿ä»˜ä¸ã—ã¦ã€CRDã®é©ç”¨ã¯åˆ¥ã§è¡Œã†ã»ã†ãŒã‚ˆã„ã¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚<br> è‡ªåˆ†ãŒã“ã‚Œã¾ã§ã«æ‰±ã£ã¦ããŸoperatorã§ã‚‚operatorã®deployã¨CRDã®é©ç”¨ã¯åˆ¥ã§è¡Œã†å¿…è¦ãŒã‚ã£ãŸã®ã§ã€ãã†ã„ã†ç†ç”±ã ã£ãŸã®ã‹ã¨ç´å¾—ã§ãã¾ã—ãŸã€‚<h3 id=crdnovalidation><a aria-label="Anchor link for: crdnovalidation" class=zola-anchor href=#crdnovalidation>CRDã®Validation</a></h3><p><a href=https://github.com/kube-rs/kube rel=external>kube-rs</a>ã®<a href=https://docs.rs/kube/0.85.0/kube/derive.CustomResource.html#schema-validation rel=external>Schema Validation</a>ã§ã¯CRDã®validationã¨ã—ã¦ã€server-sideã¨client-sideã®2ç¨®é¡ã®æ–¹æ³•ãŒã‚ã‚‹ã¨ç´¹ä»‹ã•ã‚Œã¦ã„ã¾ã™ã€‚<h4 id=server-side-validation><a aria-label="Anchor link for: server-side-validation" class=zola-anchor href=#server-side-validation>Server side validation</a></h4><p>Server sideã®validationã¯validationã®æƒ…å ±ã‚’ç”Ÿæˆã•ã‚Œã‚‹schemaã«åŸ‹ã‚è¾¼ã‚€ã‚‚ã®ã§ã™ã€‚<br> å°‘ã€…è¤‡é›‘ãªã®ãŒã€kube-rsã¯validationã®æ©Ÿæ§‹ã‚’<a href=https://github.com/Keats/validator/issues/201 rel=external>validator</a>ã‹ã‚‰<a href=https://docs.rs/garde/latest/garde/ rel=external>garde</a>ã«å¤‰æ›´ã—ã¦ã„ã‚‹ã®ã§ã™ãŒã€schemaç”Ÿæˆã‚’æ‹…ã†<a href=https://docs.rs/schemars/latest/schemars/ rel=external>schemars</a>ã§ã¯validatorã‚’æ¡ç”¨ã—ã¦ã„ã‚‹ã“ã¨ã§ã™ã€‚<br> ãã®çµæœã€structã®fieldã«validatorã®annotationã‚’æ›¸ãã¨<a href=https://docs.rs/schemars/latest/schemars/ rel=external>schemars</a>å´ã§respectã•ã‚Œã¦ç”Ÿæˆã•ã‚ŒãŸschemaã«åæ˜ ã•ã‚ŒãŸã‚Šã—ã¾ã™ã€‚<br> ã¾ãŸã€<a href=https://github.com/kube-rs/kube/blob/main/examples/crd_derive.rs rel=external>è‡ªå‰ã§schemaã‚’ç”Ÿæˆã™ã‚‹</a>ã“ã¨ã‚‚ã§ãã¾ã™ã€‚<h4 id=client-side-validation><a aria-label="Anchor link for: client-side-validation" class=zola-anchor href=#client-side-validation>Client side validation</a></h4><p><a href=https://github.com/kube-rs/kube rel=external>kube-rs</a>ã®docã§ã¯server-sideã¨client-sideãŒä¸¦åˆ—ã«æ‰±ã‚ã‚Œã¦ã„ã¾ã™ãŒã€client sideã¯è‡ªå‰ã§operatorã®codeã«validationã®å‘¼ã³å‡ºã—ã‚’æ›¸ãã ã‘ã§ã€ãªã«ã‹kubenetes apiã‚„kube-rså´ã§ç‰¹åˆ¥æ‰±ã„ã•ã‚Œã¦ã„ã‚‹ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚<a href=https://github.com/kube-rs/kube rel=external>kube-rs</a>ã‚‚dev-dependenciesä»¥å¤–ã§ã¯<a href=https://docs.rs/garde/latest/garde/ rel=external>garde</a>ã«ä¾å­˜ã—ã¦ã„ã¾ã›ã‚“ã§ã—ãŸã€‚<br> ãã®ãŸã‚ã€CRDã®structã«<a href=https://docs.rs/garde/latest/garde/ rel=external>garde</a>ã®annotationã‚’ä»˜ä¸ã—ã¦ç”Ÿæˆã•ã‚Œã‚‹<code>validation()</code> methodã‚‚operatorã®å‡¦ç†ã§å‘¼ã³å‡ºã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚<br> Server side validationã¨ã®é•ã„ã¯ã€<code>kubectl apply</code>æ™‚ã«validationãŒerrorã«ãªã‚‹ã‹ã©ã†ã‹ã¨ç†è§£ã—ã¦ã„ã¾ã™ã€‚<h2 id=operator><a aria-label="Anchor link for: operator" class=zola-anchor href=#operator>Operator</a></h2><p>CRDãŒé©ç”¨ã§ããŸã®ã§ã€æ¬¡ã«ã“ã®CRã‚’watchã™ã‚‹operatorã‚’å‹•ã‹ã—ã¦ã„ãã¾ã™ã€‚ ã¾ãšmainã‚’å«ã‚ãŸOperatorã®èµ·å‹•å‡¦ç†ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«è¡Œã„ã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> anyhow</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Context</span><span style=color:#81a1c1> as</span><span> _</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> example</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Operator</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> kube</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Client</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> tracing</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span>error</span><span style=color:#eceff4>,</span><span> info</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> signal</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span>    tokio</span><span style=color:#81a1c1>::</span><span>signal</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>ctrl_c</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .await</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>expect</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Failed to listen signal</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    info!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Receive signal</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> run</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span> anyhow</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> kube_client</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Client</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>try_default</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .await</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>context</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Expecte a valid KUBECONFIG environment variable</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>    Operator</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>run</span><span style=color:#eceff4>(</span><span>kube_client</span><span style=color:#eceff4>,</span><span style=color:#88c0d0> signal</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    info!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Operator shutdown completed</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Ok</span><span style=color:#eceff4>(())</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[tokio::main]</span></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#88c0d0>    init_tracing</span><span style=color:#eceff4>();</span><span style=color:#616e88> // çœç•¥</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    info!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Running...</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    if let</span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> run</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>        error!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>err:?</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>kube::Client::try_default()</code>ãŒkubernetes clientã®ç”Ÿæˆå‡¦ç†ã§ã™ã€‚ç’°å¢ƒå¤‰æ•°<code>KUBECONFIG</code>ã‚„<code>~/.kube/config</code>ã®è¨­å®šfileã‚’å‚ç…§ã—ã¦ãã‚Œã¾ã™ã€‚operatorãŒclusterã®ä¸­ã«ã„ã‚‹ã‹ä»Šå›ã®ã‚ˆã†ã«å¤–ã«ã„ã‚‹å ´åˆä¸¡å¯¾å¿œã—ã¦ãã‚Œã¾ã™ã€‚<br> <code>Operator::new()</code>ãŒä»Šå›å®Ÿè£…ã™ã‚‹operatorã§ã™ã€ç¬¬2å¼•æ•°ã®<code>signal()</code>ã¯çµ‚äº†ã‚’é€šçŸ¥ã™ã‚‹futureã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span>fmt</span><span style=color:#eceff4>,</span><span> future</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Future</span><span style=color:#eceff4>,</span><span> sync</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Arc</span><span style=color:#eceff4>,</span><span> time</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Duration</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> futures</span><span style=color:#81a1c1>::</span><span>stream</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>StreamExt</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> k8s_openapi</span><span style=color:#81a1c1>::</span><span>api</span><span style=color:#81a1c1>::</span><span>apps</span><span style=color:#81a1c1>::</span><span>v1</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Deployment</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> kube</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span>    api</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>ListParams</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    runtime</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        controller</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Action</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        events</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>EventType</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Recorder</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Reporter</span><span style=color:#eceff4>},</span></span>
<span class=giallo-l><span>        finalizer</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span>finalizer</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Event</span><span style=color:#eceff4>},</span></span>
<span class=giallo-l><span>        watcher</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Controller</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    },</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Api</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Client</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Resource</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> ResourceExt</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>};</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> Operator</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Operator</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> new</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -> Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        Self</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    /// Initialize operator and start reconcile loop.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub async fn</span><span style=color:#88c0d0> run</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>F</span><span style=color:#eceff4>>(</span><span style=color:#81a1c1>self</span><span style=color:#eceff4>,</span><span> client</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Client</span><span style=color:#eceff4>,</span><span> shutdown</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> F</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>    where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        F</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Future</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Output</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> ()></span><span style=color:#81a1c1> +</span><span style=color:#8fbcbb> Send</span><span style=color:#81a1c1> +</span><span style=color:#8fbcbb> Sync</span><span style=color:#81a1c1> +</span><span style=color:#eceff4> '</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> crd_api</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Api</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Hello</span><span style=color:#eceff4>></span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Api</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>all</span><span style=color:#eceff4>(</span><span>client</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> context</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Arc</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Context</span><span style=color:#eceff4>></span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Arc</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>Context</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>client</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>()));</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> wc</span><span style=color:#81a1c1> =</span><span> watcher</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Config</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>any_semantic</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>        // Check whether CRD is installed</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if let</span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> crd_api</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>list</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>ListParams</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>limit</span><span style=color:#eceff4>(</span><span style=color:#b48ead>1</span><span style=color:#eceff4>))</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>            error!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Failed to list CRD: </span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>err:?</span><span style=color:#ebcb8b>}</span><span style=color:#a3be8c>. make sure CRD installed</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span>            std</span><span style=color:#81a1c1>::</span><span>process</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>exit</span><span style=color:#eceff4>(</span><span style=color:#b48ead>1</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> deployment</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Api</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Deployment</span><span style=color:#eceff4>></span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>all</span><span style=color:#eceff4>(</span><span>client</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> deployment_wc</span><span style=color:#81a1c1> =</span><span> watcher</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Config</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>any_semantic</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>labels</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>operator.fraim.co.jp/managed-by=example-operator</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        Controller</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>crd_api</span><span style=color:#eceff4>,</span><span> wc</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>graceful_shutdown_on</span><span style=color:#eceff4>(</span><span>shutdown</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>owns</span><span style=color:#eceff4>(</span><span>deployment</span><span style=color:#eceff4>,</span><span> deployment_wc</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>run</span><span style=color:#eceff4>(</span><span>Operator</span><span style=color:#81a1c1>::</span><span>reconcile</span><span style=color:#eceff4>,</span><span> Operator</span><span style=color:#81a1c1>::</span><span>handle_error</span><span style=color:#eceff4>,</span><span> context</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>for_each</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>reconciliation_result</span><span style=color:#81a1c1>| async move</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                match</span><span> reconciliation_result</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                    Ok</span><span style=color:#eceff4>(</span><span>echo</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#88c0d0;font-weight:700> info!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Reconciliation successful. Resource: </span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>echo:?</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>"),</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                    Err</span><span style=color:#eceff4>(</span><span>reconciliation_err</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>                        error!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Reconciliation error: </span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>reconciliation_err:?</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>")</span></span>
<span class=giallo-l><span style=color:#eceff4>                    }</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#eceff4>            })</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .await</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>é †ç•ªã«ã¿ã¦ã„ãã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>let</span><span> crd_api</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Api</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Hello</span><span style=color:#eceff4>></span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Api</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>all</span><span style=color:#eceff4>(</span><span>client</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>());</span></span></code></pre><p><code>kube::Api</code>ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Clone</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> Api</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>K</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#616e88>    /// The request builder object with its resource dependent url</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>crate</span><span style=color:#eceff4>)</span><span> request</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Request</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#616e88>    /// The client to use (from this library)</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>crate</span><span style=color:#eceff4>)</span><span> client</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Client</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    namespace</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#616e88>    /// Note: Using `iter::Empty` over `PhantomData`, because we never actually keep any</span></span>
<span class=giallo-l><span style=color:#616e88>    /// `K` objects, so `Empty` better models our constraints (in particular, `Empty&lt;K>`</span></span>
<span class=giallo-l><span style=color:#616e88>    /// is `Send`, even if `K` may not be).</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>crate</span><span style=color:#eceff4>)</span><span> _phantom</span><span style=color:#81a1c1>:</span><span> std</span><span style=color:#81a1c1>::</span><span>iter</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Empty</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>K</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>åŸºæœ¬çš„ã«ã¯ã€<code>impl&lt;K: Resource> Api&lt;K> {}</code>ã§<code>K</code>ãŒ<code>Resource</code> traitã‚’å®Ÿè£…ã—ã¦ã„ã‚‹å‰æã¨ãªã£ã¦ã„ã¾ã™ã€‚<br> <code>Resoure</code> traitã¯Kubernetesã®resourceã®æƒ…å ±å–å¾—ç”¨ã®methodã‚’å®šç¾©ã—ã¦ã„ã‚‹traitã§ã™ã€‚<code>DynamicType</code>ã¯compileæ™‚ã«æƒ…å ±ã®ãªã„Resourceã‚’æ‰±ã†ä»•çµ„ã¿ã®ã‚ˆã†ã§ã™ãŒã€æœ¬è¨˜äº‹ã§ã¯å‰²æ„›ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>pub trait</span><span style=color:#8fbcbb;font-weight:700> Resource</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> DynamicType</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Send</span><span style=color:#81a1c1> +</span><span style=color:#8fbcbb> Sync</span><span style=color:#81a1c1> +</span><span style=color:#eceff4> '</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Scope</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> kind</span><span style=color:#eceff4>(</span><span>dt</span><span style=color:#81a1c1>: &Self::</span><span style=color:#8fbcbb>DynamicType</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Cow</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> str</span><span style=color:#eceff4>>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> group</span><span style=color:#eceff4>(</span><span>dt</span><span style=color:#81a1c1>: &Self::</span><span style=color:#8fbcbb>DynamicType</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Cow</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> str</span><span style=color:#eceff4>>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> version</span><span style=color:#eceff4>(</span><span>dt</span><span style=color:#81a1c1>: &Self::</span><span style=color:#8fbcbb>DynamicType</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Cow</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> str</span><span style=color:#eceff4>>;</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span></code></pre><p><code>Api&lt;Hello></code>ã¨ã§ãã‚‹ã®ã¯ã€<code>#[derive(CustomResource)]</code>ã§<code>Hello</code>ã«<code>Resource</code> traitãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‹ã‚‰ã§ã™ã€‚(<code>DynamicType = ()</code>)<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>let</span><span> context</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Arc</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Context</span><span style=color:#eceff4>></span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Arc</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>Context</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>client</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>()));</span></span></code></pre><p><code>Context</code>ã¯reconcileæ™‚ã«å¼•ãå›ã™å‹ã§ã€è‡ªå‰ã§å®šç¾©ã—ãŸã‚‚ã®ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>let</span><span> wc</span><span style=color:#81a1c1> =</span><span> watcher</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Config</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>any_semantic</span><span style=color:#eceff4>();</span></span></code></pre><p><code>kube::runtime::watcher::Config</code>ã¯kubernetes apiã«Resourceã‚’å•ã„åˆã‚ã›ã‚‹éš›ã®parameterã§ã™ã€‚<br> <code>any_semantics()</code>ã«ã¤ã„ã¦ã¯<a href=https://kubernetes.io/docs/reference/using-api/api-concepts/#semantics-for-get-and-list rel=external>ã“ã¡ã‚‰</a>ã‚’å‚ç…§ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#616e88>// Check whether CRD is installed</span></span>
<span class=giallo-l><span style=color:#81a1c1>if let</span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> crd_api</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>list</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>ListParams</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>limit</span><span style=color:#eceff4>(</span><span style=color:#b48ead>1</span><span style=color:#eceff4>))</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    error!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Failed to list CRD: </span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>err:?</span><span style=color:#ebcb8b>}</span><span style=color:#a3be8c>. make sure CRD installed</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span>    std</span><span style=color:#81a1c1>::</span><span>process</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>exit</span><span style=color:#eceff4>(</span><span style=color:#b48ead>1</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>Operatorèµ·å‹•æ™‚ã«å¯¾è±¡ã®clusterã«CRDãŒinstallã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã—ã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>let</span><span> deployment</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Api</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Deployment</span><span style=color:#eceff4>></span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>all</span><span style=color:#eceff4>(</span><span>client</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#81a1c1>let</span><span> deployment_wc</span><span style=color:#81a1c1> =</span><span> watcher</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Config</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>    .</span><span style=color:#88c0d0>any_semantic</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>    .</span><span style=color:#88c0d0>labels</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>operator.fraim.co.jp/managed-by=example-operator</span><span style=color:#eceff4>");</span></span></code></pre><p>ä»Šå›ã¯ã€<code>Hello</code>resourceã«åŸºã¥ã„ã¦<code>Deployment</code>ã‚’ä½œæˆã™ã‚‹ãŸã‚ã«ã€<code>Deployment</code>ç”¨ã®<code>Api</code>ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™ã€‚<br> <code>watcher::Config</code>ã«ã¯ç›£è¦–å¯¾è±¡ã®ãƒªã‚½ãƒ¼ã‚¹ã®selectorã‚’æŒ‡å®šã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ãŠã‚Šã€é–¢å¿ƒãŒã‚ã‚‹<code>Deployment</code>ã¯ã“ã®operatorã«ã‚ˆã£ã¦ä½œæˆã•ã‚ŒãŸã‚‚ã®ã ã‘ãªã®ã§ã€labelã‚’ä»˜ä¸ã—ã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#8fbcbb>Controller</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>crd_api</span><span style=color:#eceff4>,</span><span> wc</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>    .</span><span style=color:#88c0d0>graceful_shutdown_on</span><span style=color:#eceff4>(</span><span>shutdown</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>    .</span><span style=color:#88c0d0>owns</span><span style=color:#eceff4>(</span><span>deployment</span><span style=color:#eceff4>,</span><span> deployment_wc</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>    .</span><span style=color:#88c0d0>run</span><span style=color:#eceff4>(</span><span>Operator</span><span style=color:#81a1c1>::</span><span>reconcile</span><span style=color:#eceff4>,</span><span> Operator</span><span style=color:#81a1c1>::</span><span>handle_error</span><span style=color:#eceff4>,</span><span> context</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>    .</span><span style=color:#88c0d0>for_each</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>reconciliation_result</span><span style=color:#81a1c1>| async move</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        match</span><span> reconciliation_result</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Ok</span><span style=color:#eceff4>(</span><span>echo</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#88c0d0;font-weight:700> info!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Reconciliation successful. Resource: </span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>echo:?</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>"),</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Err</span><span style=color:#eceff4>(</span><span>reconciliation_err</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>                error!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Reconciliation error: </span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>reconciliation_err:?</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>")</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    })</span></span>
<span class=giallo-l><span style=color:#81a1c1>    .await</span><span style=color:#eceff4>;</span></span></code></pre><p><code>kube::runtime::Controller</code>ãŒ<a href=https://github.com/kube-rs/kube rel=external>kube-rs</a>ãŒæä¾›ã—ã¦ãã‚Œã¦ã„ã‚‹Operatorã®å®Ÿè£…ã§ã™ã€‚å®Ÿæ…‹ã¨ã—ã¦ã¯kube-runtime crateã‚’re-exportã—ãŸã‚‚ã®ã§ã™ã€‚<ul><li><code>graceful_shutdown_on()</code>: æ¸¡ã—ãŸfutureãŒreadyã«ãªã£ãŸéš›ã«shutdownã—ã¦ãã‚Œã¾ã™ã€‚ <ul><li><code>shutdown_on_signal()</code>ã‚‚ç”¨æ„ã•ã‚Œã¦ãŠã‚Šã€ã“ã®å ´åˆ<code>Controller</code>å´ã§signalã‚’ç›£è¦–ã—ã¦ãã‚Œã¾ã™ã€‚unit testæ™‚ã«ã¯signalã«é ¼ã‚‹ã“ã¨ãªãçµ‚äº†ã‚’åˆ¶å¾¡ã§ãã‚‹ã®ã§ã€futureã‚’æ¸¡ã™ã»ã†ãŒè‡ªåˆ†ã¯å¥½ãã§ã™ã€‚</ul><li><code>owns()</code>: ç›£è¦–ã™ã‚‹sub resourceã‚’æŒ‡å®šã—ã¾ã™ã€‚ä»Šå›ã¯<code>Deployment</code> resourceã‚’ä½œæˆã™ã‚‹ã®ã§ã€<code>owns()</code>ã«deploymentç”¨ã®apiã¨<code>watch::Config</code>ã‚’æ¸¡ã—ã¦ã„ã¾ã™ã€‚ <ul><li>ã“ã‚Œã«ã‚ˆã£ã¦ç®¡ç†ã—ã¦ã„ã‚‹<code>Deployment</code>ã®å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã«ã‚‚reconcileå‡¦ç†ãŒcallã•ã‚Œã¾ã™<li><a href=https://kubernetes.io/docs/concepts/overview/working-with-objects/owners-dependents/ rel=external><code>metadata.ownerReferences</code></a>ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™</ul><li><code>run()</code>: Operatorã®reconcileå‡¦ç†ã¨erroræ™‚ã®retryè¨­å®šã€å¼•ãå›ã™contextã‚’æŒ‡å®šã—ã¾ã™<li><code>for_each()</code>: reconcileã®çµæœã‚’å‡¦ç†ã—ã¾ã™ã€‚ <ul><li>ã“ã‚Œã¯<code>Controller</code>ã®methodã§ã¯ãªãã€<code>run()</code>ã®æˆ»ã‚Šå€¤ã€<code>futures::Stream</code>(<code>StreamExt</code>)ã®methodã§ã™ã€‚</ul></ul><p>ã¨ã„ã†ã‚ˆã†ã«åŸºæœ¬çš„ã«userå´ã§ã€clientã®åˆæœŸåŒ–ã€ç›£è¦–å¯¾è±¡ãƒªã‚½ãƒ¼ã‚¹ã®æŒ‡å®šã‚’è¡Œã£ãŸå¾Œã«reconcileå‡¦ç†ã‚’æ¸¡ã™ã ã‘ã§ã€operatorã‚’å‹•ã‹ã›ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚<h3 id=reconcile><a aria-label="Anchor link for: reconcile" class=zola-anchor href=#reconcile>Reconcile</a></h3><p>æ¬¡ã«ãƒ¡ã‚¤ãƒ³ã¨ãªã‚‹reconcileå‡¦ç†ã‚’ã¿ã¦ã„ãã¾ã™ã€‚ã¾ãšã€<code>kube::runtime::Controller::run()</code>ã®signatureã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>pub fn</span><span style=color:#88c0d0> run</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>ReconcilerFut</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Ctx</span><span style=color:#eceff4>>(</span></span>
<span class=giallo-l><span style=color:#81a1c1>    self</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>    mut</span><span> reconciler</span><span style=color:#81a1c1>: impl</span><span style=color:#88c0d0> FnMut</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Arc</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>K</span><span style=color:#eceff4>>,</span><span style=color:#8fbcbb> Arc</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Ctx</span><span style=color:#eceff4>>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> ReconcilerFut</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    error_policy</span><span style=color:#81a1c1>: impl</span><span style=color:#88c0d0> Fn</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Arc</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>K</span><span style=color:#eceff4>>,</span><span style=color:#81a1c1> &</span><span>ReconcilerFut</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Arc</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Ctx</span><span style=color:#eceff4>>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Action</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    context</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Arc</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Ctx</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> impl</span><span style=color:#8fbcbb> Stream</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Item</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;(</span><span style=color:#8fbcbb>ObjectRef</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>K</span><span style=color:#eceff4>>,</span><span style=color:#8fbcbb> Action</span><span style=color:#eceff4>),</span><span style=color:#8fbcbb> Error</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>ReconcilerFut</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>,</span><span> watcher</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>>>></span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span>    K</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>DynamicType</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Debug</span><span style=color:#81a1c1> +</span><span style=color:#8fbcbb> Unpin</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    ReconcilerFut</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> TryFuture</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Ok</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Action</span><span style=color:#eceff4>></span><span style=color:#81a1c1> +</span><span style=color:#8fbcbb> Send</span><span style=color:#81a1c1> +</span><span style=color:#eceff4> '</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    ReconcilerFut</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Error</span><span style=color:#81a1c1>:</span><span> std</span><span style=color:#81a1c1>::</span><span>error</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Error</span><span style=color:#81a1c1> +</span><span style=color:#8fbcbb> Send</span><span style=color:#81a1c1> +</span><span style=color:#eceff4> '</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span><span style=color:#616e88> /* ... */</span><span style=color:#eceff4>}</span></span></code></pre><p>ç¬¬1å¼•æ•°ã®<code>reconciler</code>ã«ã¯reconcileé–¢æ•°ã‚’æ¸¡ã—ã¾ã™ã€‚<code>Arc&lt;K></code>ã¯ã“ã“ã§ã¯ã€<code>Arc&lt;Hello></code>ã¨ãªã‚Šã¾ã™ã€‚<br> çµæœã¯<code>TryFuture</code>ãªã®ã§ã€asyncã§ã€<code>Result&lt;kube::runtime::controller::Action,MyError></code>ã‚’è¿”ã—ã¾ã™ã€‚<br> <code>Action</code>ã¯reconcileå‡¦ç†ã®çµæœã§ã€kube-runtimeã®<code>Controller</code>ã®ä¸­ã«schedulerã«æ¸¡ã•ã‚Œæ¬¡å›ã®reconcileã®schedulingã«åæ˜ ã•ã‚Œã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Action</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>    /// Action to the reconciliation at this time even if no external watch triggers hit</span></span>
<span class=giallo-l><span style=color:#616e88>    ///</span></span>
<span class=giallo-l><span style=color:#616e88>    /// This is the best-practice action that ensures eventual consistency of your controller</span></span>
<span class=giallo-l><span style=color:#616e88>    /// even in the case of missed changes (which can happen).</span></span>
<span class=giallo-l><span style=color:#616e88>    ///</span></span>
<span class=giallo-l><span style=color:#616e88>    /// Watch events are not normally missed, so running this once per hour (`Default`) as a fallback is reasonable.</span></span>
<span class=giallo-l><span style=color:#5e81ac>    #[must_use]</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> requeue</span><span style=color:#eceff4>(</span><span>duration</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Duration</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            requeue_after</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>duration</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    /// Do nothing until a change is detected</span></span>
<span class=giallo-l><span style=color:#616e88>    ///</span></span>
<span class=giallo-l><span style=color:#616e88>    /// This stops the controller periodically reconciling this object until a relevant watch event</span></span>
<span class=giallo-l><span style=color:#616e88>    /// was **detected**.</span></span>
<span class=giallo-l><span style=color:#616e88>    ///</span></span>
<span class=giallo-l><span style=color:#616e88>    /// **Warning**: If you have watch desyncs, it is possible to miss changes entirely.</span></span>
<span class=giallo-l><span style=color:#616e88>    /// It is therefore not recommended to disable requeuing this way, unless you have</span></span>
<span class=giallo-l><span style=color:#616e88>    /// frequent changes to the underlying object, or some other hook to retain eventual consistency.</span></span>
<span class=giallo-l><span style=color:#5e81ac>    #[must_use]</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> await_change</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -> Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        Self</span><span style=color:#eceff4> {</span><span> requeue_after</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> None</span><span style=color:#eceff4> }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã¨ãªã£ã¦ãŠã‚Šã€æ˜ç¤ºçš„ã«<code>Action::requeue()</code>ã§æ¬¡å›ã®schedulingæœŸé–“ã‚’å®šã‚ã‚‹ã‹ã€<code>Action::await_change()</code>ã§Resource(<code>Hello</code>)ã«å¤‰æ›´ãŒã‚ã‚‹ã¾ã§ã€reconcileã‚’æŒ‡å®šã—ãªã“ã¨ãŒé¸ã¹ã¾ã™ã€‚ã“ã“ã§ã©ã¡ã‚‰ã®æ–¹æ³•ã‚’é¸æŠã—ã¦ã‚‚ã€ç›£è¦–ResourceãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã«ã¯reconcileå‡¦ç†ã¯èµ·å‹•ã•ã‚Œã‚‹ã®ã§ã€<code>await_change()</code>ã§ã„ã„ã®ã§ã¯ã¨æ€ã„ã¾ã—ãŸãŒã€ã‚³ãƒ¡ãƒ³ãƒˆã§æŒ‡æ‘˜ã•ã‚Œã¦ã„ã‚‹ã¨ãŠã‚Šã€kubernetesã®å„ç¨®eventã¯æ§˜ã€…ãªè¦å› ã§ã€operatorã«ä¼ã‚ã‚‰ãªã„ã“ã¨ãŒã‚ã‚Šå¾—ã‚‹ã®ã§ã€çŸ­ã„é »åº¦ã§å¤‰æ›´ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‹ã£ã¦ã„ã‚‹çŠ¶æ³ä»¥å¤–ã§ã¯ã€<code>requeue()</code>ãŒè‰¯ã•ãã†ã§ã™ã€‚<p>ç¬¬2å¼•æ•°ã®<code>error_policy: impl Fn(Arc&lt;K>, &ReconcilerFut::Error, Arc&lt;Ctx>) -> Action</code>ã¯erroræ™‚ã®æŒ™å‹•ã‚’åˆ¶å¾¡ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚<br> <code>ReconcilerFut::Error</code>ã¯userãŒå®šç¾©ã™ã‚‹ã®ã§ã€errorã®è¦å› ãŒå¤–éƒ¨ã«ã‚ã‚‹å ´åˆã«ã¯ã€çŸ­ãrequeueã®æ™‚é–“ã‚’æŒ‡å®šã—ã¦ã€å›å¾©ã§ãã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹ã¨ã„ã£ãŸã“ã¨ãŒã§ããã†ã§ã™ã€‚<p>ç¬¬3å¼•æ•°ã®<code>context: Arc&lt;Ctx></code>ã¯reconcileã§å¼•ãå›ã™æƒ…å ±ã§ã€ä»Šå›ã¯å®šç¾©ã—ãŸ<code>Context</code>ãŒä½¿ã‚ã‚Œã¾ã™ã€‚å®šç¾©ã¯ä»¥ä¸‹ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> kube</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Client</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> kube</span><span style=color:#81a1c1>::</span><span>runtime</span><span style=color:#81a1c1>::</span><span>events</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Reporter</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> Context</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    client</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Client</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    reporter</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Reporter</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>Reporter</code>ã¯kubernetesã®eventã‚’å‡ºåŠ›ã™ã‚‹ãŸã‚ã®ä»•çµ„ã¿ã§ã€ã®ã¡ã»ã©ä½¿ã„æ–¹ã‚’ã¿ã¦ã„ãã¾ã™ã€‚<br> ã¨ã„ã†ã“ã¨ã§reconcileå‡¦ç†ã®å®Ÿè£…ã‚’è¡Œã£ã¦ã„ãã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Operator</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#5e81ac>    #[tracing::instrument(skip_all)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>    async fn</span><span style=color:#88c0d0> reconcile</span><span style=color:#eceff4>(</span><span>hello</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Arc</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Hello</span><span style=color:#eceff4>>,</span><span> context</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Arc</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Context</span><span style=color:#eceff4>>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Action</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Error</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#616e88>        // Validate spec</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if let</span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> hello</span><span style=color:#81a1c1>.</span><span>spec</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>validate</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span style=color:#eceff4>()) {</span></span>
<span class=giallo-l><span>            context</span></span>
<span class=giallo-l><span style=color:#81a1c1>                .</span><span style=color:#88c0d0>recorder</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>hello</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>                .</span><span style=color:#88c0d0>publish</span><span style=color:#eceff4>(</span><span>runtime</span><span style=color:#81a1c1>::</span><span>events</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Event</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                    type_</span><span style=color:#81a1c1>:</span><span> EventType</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Warning</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>                    action</span><span style=color:#81a1c1>:</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>Reconcile</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>                    reason</span><span style=color:#81a1c1>:</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>Invalid spec</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>                    note</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span style=color:#88c0d0;font-weight:700>format!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Invalid Hello spec: </span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>err</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>")),</span></span>
<span class=giallo-l><span>                    secondary</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> None</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>                })</span></span>
<span class=giallo-l><span style=color:#81a1c1>                .await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>            return</span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Error</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>invalid_spec</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#eceff4>));</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> client</span><span style=color:#81a1c1> =</span><span> context</span><span style=color:#81a1c1>.</span><span>client</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> api</span><span style=color:#81a1c1> =</span><span> hello</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>api</span><span style=color:#eceff4>(</span><span>client</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> action</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> finalizer</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>api</span><span style=color:#eceff4>,</span><span> RESCOUCE_DOMAIN</span><span style=color:#eceff4>,</span><span> hello</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> |</span><span>event</span><span style=color:#81a1c1>| async</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            match</span><span> event</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                Event</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Apply</span><span style=color:#eceff4>(</span><span>hello</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> => Self::</span><span style=color:#88c0d0>reconcile_hello</span><span style=color:#eceff4>(</span><span>hello</span><span style=color:#eceff4>,</span><span> context</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>                Event</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Cleanup</span><span style=color:#eceff4>(</span><span>hello</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> => Self::</span><span style=color:#88c0d0>cleanup_hello</span><span style=color:#eceff4>(</span><span>hello</span><span style=color:#eceff4>,</span><span> context</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        })</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .await</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>map_err</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>e</span><span style=color:#81a1c1>|</span><span> Error</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>FinalizerError</span><span style=color:#eceff4>(</span><span>Box</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>e</span><span style=color:#eceff4>)))</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>é †ç•ªã«è¦‹ã¦ã„ãã¾ã™ã€‚ã¾ãšé–¢æ•°ã®signatureã§ã™ãŒ<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> reconcile</span><span style=color:#eceff4>(</span><span>hello</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Arc</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Hello</span><span style=color:#eceff4>>,</span><span> context</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Arc</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Context</span><span style=color:#eceff4>>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Action</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Error</span><span style=color:#eceff4>> { }</span></span></code></pre><p>ReconcileãŒå¿…è¦ãª<code>Hello</code> resourceãŒæ¸¡ã•ã‚Œã¾ã™ã€‚<code>Hello</code>ã®specã‚’ç¢ºèªã—ã¦ã‚ã‚‹ã¹ãçŠ¶æ…‹ã‚’å®Ÿç¾ã—ãŸã®ã¡ã«æ¬¡ã«ã„ã¤reconcileã‚’schedulingã™ã‚‹ã‹ã‚’è¿”ã™ã®ãŒ<code>reconcile()</code>ã®å½¹å‰²ã§ã™ã€‚<br> ã“ã®signatureã§ã¾ãšæ€ã£ãŸã“ã¨ãŒã€ã©ã†ã—ã¦reconcileãŒtriggerã•ã‚ŒãŸã‹ã®ç†ç”±ãŒä¸ãˆã‚‰ã‚Œã¦ã„ãªã„ã“ã¨ã§ã™ã€‚<br> ãã®ãŸã‚ã€<code>Hello</code>ãŒå‰Šé™¤ã•ã‚ŒãŸã®ã‹ã€ä½œæˆã•ã‚ŒãŸã®ã‹ã€æ›´æ–°ã•ã‚ŒãŸã®ã‹ãŒä¸ãˆã‚‰ã‚Œã¦ã„ãªã„ã®ã§ã€<code>Hello</code>ã®å®šç¾©ã‚„metadataã‚’ç¢ºèªã—ã¦ã‚ã‚‹ã¹ãçŠ¶æ…‹ã‚’åˆ¤å®šã™ã‚‹ã®ã‚‚operatorã®è²¬å‹™ã¨ãªã‚Šã¾ã™ã€‚<a href=https://github.com/kube-rs/kube rel=external>kube-rs</a>ã®docã§ã¯ã€ã“ã‚Œã¯æ„å›³çš„ãªè¨­è¨ˆã¨ã•ã‚Œã¦ã„ã¾ã™ã€‚<br> ã©ã†ã„ã†ã“ã¨ã‹ã¨ã„ã†ã¨ã€ä»®ã«reconcileã®signatureãŒä»¥ä¸‹ã®ã‚ˆã†ã«reconcileã®ç†ç”±ã‚‚ä¸ãˆã‚‰ã‚Œã‚‹ã‚‚ã®ã ã£ãŸã¨ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> reconcile</span><span style=color:#eceff4>(</span><span>hello</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Arc</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Hello</span><span style=color:#eceff4>>,</span><span> context</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Arc</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Context</span><span style=color:#eceff4>>,</span><span> reason</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> ReconcileReason</span><span style=color:#616e88> /* ğŸ‘ˆ */</span><span style=color:#eceff4>  )</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Action</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>> { }</span></span></code></pre><p>Reconcileã®ç†ç”±ãŒã‚ã‹ã£ã¦ã„ã‚‹ã¨userã¨ã—ã¦ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªå‡¦ç†ã‚’æ›¸ããŸããªã‚Šã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> reconcile</span><span style=color:#eceff4>(</span><span>hello</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Arc</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Hello</span><span style=color:#eceff4>>,</span><span> context</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Arc</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Context</span><span style=color:#eceff4>>,</span><span> reason</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> ReconcileReason</span><span style=color:#616e88> /* ğŸ‘ˆ */</span><span style=color:#eceff4>  )</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Action</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>> {</span><span> </span></span>
<span class=giallo-l><span style=color:#81a1c1>    match</span><span> reason</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        ReconcileReason</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Created</span><span style=color:#eceff4>(</span><span>obj</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#88c0d0> crete_hello</span><span style=color:#eceff4>(</span><span>obj</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        ReconcileReason</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Modified</span><span style=color:#eceff4>(</span><span>obj</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#88c0d0> update_hello</span><span style=color:#eceff4>(</span><span>obj</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        ReconcileReason</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Deleted</span><span style=color:#eceff4>(</span><span>obj</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#88c0d0> delete_hello</span><span style=color:#eceff4>(</span><span>obj</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#616e88>        // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã—ã‹ã—ãªãŒã‚‰ã€ã“ã®ã‚ˆã†ãªå®Ÿè£…ã—ã¦ã—ã¾ã†ã¨ãªã‚“ã‚‰ã‹ã®ç†ç”±ã§Deleted eventã‚’è¦‹é€ƒã—ã¦ã—ã¾ã†ã¨(operatorã®å†èµ·å‹•ç­‰)ã€<code>Hello</code> resourceã‚’å‰Šé™¤ã™ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’é€¸ã—ã¦ã—ã¾ã„ã¾ã™ã€‚<br> ãã“ã§ã€æ„å›³çš„ã«reconcileã®ç†ç”±ã«ä¾å­˜ã•ã›ãªã„ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã«ç¾åœ¨ã®signatureã«ãªã£ã¦ã„ã‚‹ã¨ç†è§£ã—ã¦ã„ã¾ã™ã€‚<h4 id=validation><a aria-label="Anchor link for: validation" class=zola-anchor href=#validation>Validation</a></h4><p>Reconcileæ™‚ã«ã¾ãšvalidationã‚’è¡Œã†ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#616e88>// Validate spec</span></span>
<span class=giallo-l><span style=color:#81a1c1>if let</span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> hello</span><span style=color:#81a1c1>.</span><span>spec</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>validate</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span style=color:#eceff4>()) {</span></span>
<span class=giallo-l><span>    context</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>recorder</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>hello</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>publish</span><span style=color:#eceff4>(</span><span>runtime</span><span style=color:#81a1c1>::</span><span>events</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Event</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            type_</span><span style=color:#81a1c1>:</span><span> EventType</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Warning</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            action</span><span style=color:#81a1c1>:</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>Reconcile</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>            reason</span><span style=color:#81a1c1>:</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>Invalid spec</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>            note</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span style=color:#88c0d0;font-weight:700>format!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Invalid Hello spec: </span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>err</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>")),</span></span>
<span class=giallo-l><span>            secondary</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> None</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>        })</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    return</span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Error</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>invalid_spec</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#eceff4>));</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>hello.spec.validate(&())</code>ã¯æœ€åˆã«<code>HelloSpec</code>ã«å®šç¾©ã—ãŸ<code>garde::Validate</code>ã«ã‚ˆã‚‹ã‚‚ã®ã§ã™ã€‚ (å¼•æ•°ã¯gardeã®æ©Ÿæ§‹ã§validationæ™‚ã«å¼•æ•°æ¸¡ã›ã‚‹ä»•çµ„ã¿ãªã®ã§ã“ã“ã§ã¯<code>()</code>)<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>CustomResource</span><span style=color:#5e81ac>,</span><span style=color:#616e88> /* ... */</span><span style=color:#5e81ac> garde::</span><span style=color:#8fbcbb>Validate</span><span style=color:#616e88> /* ğŸ‘ˆ ã“ã‚Œ */</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#5e81ac>#[kube(</span></span>
<span class=giallo-l><span style=color:#616e88>    // Required properties</span></span>
<span class=giallo-l><span style=color:#5e81ac>    group = "</span><span style=color:#a3be8c>fraim.co.jp</span><span style=color:#5e81ac>",</span></span>
<span class=giallo-l><span style=color:#5e81ac>    version = "</span><span style=color:#a3be8c>v1</span><span style=color:#5e81ac>",</span></span>
<span class=giallo-l><span style=color:#5e81ac>    kind = "</span><span style=color:#a3be8c>Hello</span><span style=color:#5e81ac>",</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> HelloSpec</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#5e81ac>    #[garde(range(max = 20))]</span><span style=color:#616e88> // ğŸ‘ˆ ã“ã‚ŒãŒvalidation</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> replicas</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> u32</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>Hello</code>ã®specãŒvalidationã«é•åã—ã¦ã„ã‚‹å ´åˆã€rencocileã‚’ç¶™ç¶šã§ãã¾ã›ã‚“ã€‚<br> Operatorã¨ã—ã¦ã¯logã«å‡ºåŠ›ã™ã‚‹ä»¥å¤–ã§userã«ã“ã®ã“ã¨ä¼ãˆã‚‹ã“ã¨ã¯ã§ãã‚‹ã§ã—ã‚‡ã†ã‹ã€‚<br> ã“ã“ã§ã¯ã€<a href=https://github.com/kube-rs/kube rel=external>kube-rs</a>ãŒç”¨æ„ã—ã¦ãã‚ŒãŸeventå‡ºåŠ›ã®ä»•çµ„ã¿ã‚’åˆ©ç”¨ã—ã¦ã€Kubernetesã®eventã¨ã—ã¦validationé•åã‚’è¡¨ç¾ã—ã¦ã¿ã¾ã™ã€‚ <a href=https://docs.rs/kube/0.85.0/kube/runtime/events/struct.Recorder.html rel=external><code>kube::runtime::events::Recorder</code></a>ã¯eventå‡ºåŠ›ã®è©³ç´°ã‚’éš è”½ã—ã¦ãã‚Œã¦ã„ã‚‹å‹ã§ã€äº‹å‰ã«operatorã®åå‰ã‚„Resourceã®è­˜åˆ¥å­ã‹ã‚‰ç”Ÿæˆã§ãã¾ã™ã€‚<p>Eventã‚’å‡ºåŠ›ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«kubectlã‹ã‚‰ç¢ºèªã§ãã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#81a1c1>></span><span> kubectl get events --field-selector </span><span style=color:#eceff4>'</span><span style=color:#a3be8c>involvedObject.kind==Hello,type=Warning</span><span style=color:#eceff4>'</span></span>
<span class=giallo-l><span style=color:#88c0d0>LAST</span><span style=color:#a3be8c> SEEN   TYPE      REASON         OBJECT        MESSAGE</span></span>
<span class=giallo-l><span style=color:#88c0d0>5m44s</span><span style=color:#a3be8c>       Warning   InvalidSpec   hello/hello   Invalid Hello spec: replicas: greater than</span><span style=color:#b48ead> 20</span></span>
<span class=giallo-l><span style=color:#88c0d0>5m34s</span><span style=color:#a3be8c>       Warning   InvalidSpec   hello/hello   Invalid Hello spec: replicas: greater than</span><span style=color:#b48ead> 20</span></span></code></pre><p>ä¸Šè¨˜ã¯<code>HelloSpec.replicas</code>ã®å€¤ã‚’maxã‚’è¶…ãˆã¦æŒ‡å®šã—ãŸã‚‚ã®ã§ã™ã€‚gardeã¨ã‚ã‚ã›ã¦ã‚ã‹ã‚Šã‚„ã™ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå‡ºåŠ›ã§ãã¦ã„ã¾ã™ã€‚<p>ValidationãŒæ¸ˆã‚“ã ã®ã§æ¬¡ã¯<code>Hello</code>ã®reconcileå‡¦ç†ã§ã™ã€‚ ã¾ãšè¡Œã†å¿…è¦ãŒã‚ã‚‹ã®ãŒã€<code>Hello</code>ã‚’å‰Šé™¤ã™ã¹ããªã®ã‹ã€ä½œæˆ/æ›´æ–°ã™ã¹ãã‹ã®åˆ¤æ–­ã§ã™ã€‚<br> ã“ã‚Œã‚’åˆ¤æ–­ã™ã‚‹ã«ã¯ã€<code>metadata.deletionTimestamp</code>ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã—ã¾ã™ã€‚<br> ã¾ãŸã€ä»®ã«<code>metadata.deletionTimestamp</code>ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€<code>Hello</code>ã®é–¢é€£Resourceã‚’å‰Šé™¤ã—ãŸã®ã¡ã€<a href=https://kubernetes.io/docs/concepts/overview/working-with-objects/finalizers/ rel=external><code>metadata.finalizers</code>ã®æ›´æ–°ãŒå¿…è¦</a>ã§ã™ã€‚<p>ã“ã®ã‚ãŸã‚Šã®åˆ¤å®šã‚„å‡¦ç†ã¯operatorå…±é€šã®ç´„æŸã”ã¨ã«åŸºã¥ãã‚‚ã®ãªã®ã§ã€<a href=https://github.com/kube-rs/kube rel=external>kube-rs</a>å´ã§ä¾¿åˆ©ãªå‡¦ç†ã‚’æä¾›ã—ã¦ãã‚Œã¦ã„ã¾ã™ã€‚<br> ãã‚ŒãŒ<a href=https://docs.rs/kube/0.85.0/kube/runtime/finalizer/fn.finalizer.html rel=external><code>kube::runtime::finalizer::finalizer</code></a>ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> kube</span><span style=color:#81a1c1>::</span><span>runtime</span><span style=color:#81a1c1>::</span><span>finalizer</span><span style=color:#81a1c1>::</span><span>finalizer</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> reconcile</span><span style=color:#eceff4>(</span><span>hello</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Arc</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Hello</span><span style=color:#eceff4>>,</span><span> context</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Arc</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Context</span><span style=color:#eceff4>>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Action</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Error</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> client</span><span style=color:#81a1c1> =</span><span> context</span><span style=color:#81a1c1>.</span><span>client</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> api</span><span style=color:#81a1c1> =</span><span> hello</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>api</span><span style=color:#eceff4>(</span><span>client</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>    finalizer</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#81a1c1>        &</span><span>api</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>        &</span><span style=color:#88c0d0;font-weight:700>format!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>fraim.co.jp/</span><span style=color:#ebcb8b>{}</span><span style=color:#eceff4>",</span><span> Operator</span><span style=color:#81a1c1>::</span><span>NAME</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span>        hello</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>        |</span><span>event</span><span style=color:#81a1c1>| async</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            match</span><span> event</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Event</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Apply</span><span style=color:#eceff4>(</span><span>hello</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> => Self::</span><span style=color:#88c0d0>reconcile_hello</span><span style=color:#eceff4>(</span><span>hello</span><span style=color:#eceff4>,</span><span> context</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Event</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Cleanup</span><span style=color:#eceff4>(</span><span>hello</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> => Self::</span><span style=color:#88c0d0>cleanup_hello</span><span style=color:#eceff4>(</span><span>hello</span><span style=color:#eceff4>,</span><span> context</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        },</span></span>
<span class=giallo-l><span style=color:#eceff4>    )</span></span>
<span class=giallo-l><span style=color:#81a1c1>    .await</span></span>
<span class=giallo-l><span style=color:#81a1c1>    .</span><span style=color:#88c0d0>map_err</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>e</span><span style=color:#81a1c1>|</span><span> Error</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>FinalizerError</span><span style=color:#eceff4>(</span><span>Box</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>e</span><span style=color:#eceff4>)))</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã“ã“ã§ã®å¿…è¦ãªå‡¦ç†ã¯ä»¥ä¸‹ã§ã™ã€‚<ol><li><code>Hello</code>åˆå›ä½œæˆæ™‚ã¯<code>metada.finalizers</code>ã«è­˜åˆ¥å­ã‚’è¿½åŠ ã—ãŸã®ã¡ã€reconcileå‡¦ç†ã‚’å®Ÿè¡Œ<li>æ›´æ–°æ™‚ã¯reconcileå‡¦ç†ã®ã¿å®Ÿè¡Œ<li>åˆå›å‰Šé™¤æ™‚ã¯ã€å‰Šé™¤ç”¨ã®reconcileå‡¦ç†ã‚’å®Ÿè¡Œã—ãŸã®ã¡ã€<code>metadata.finalizers</code>ã‹ã‚‰è¿½åŠ ã—ãŸè­˜åˆ¥å­ã‚’å‰Šé™¤<li><code>metadata.finalizers</code>ã«è‡ªèº«ã®è­˜åˆ¥å­ãŒãªã„å ´åˆã®å‰Šé™¤æ™‚ã¯ãªã«ã‚‚ã—ãªã„</ol><p><code>kube::runtime:finalizer::finalizer</code>ã¯å‰Šé™¤ã®åˆ¤å®šã‚„finalizerã®å‡¦ç†ã‚’é©åˆ‡ã«å®Ÿæ–½ã—ãŸã®ã¡ã«ã€userã‹ã‚‰closureã§æ¸¡ã•ã‚ŒãŸreconcileå‡¦ç†ã‚’å®Ÿè¡Œã—ã¦ãã‚Œã¾ã™ã€‚<br> ãã®éš›ã€applyã‹cleanupã‹ã‚’æ•™ãˆã¦ãã‚Œã‚‹ã®ã§ã€ãã“ã§å‡¦ç†ã‚’åˆ†å²ã•ã›ã¾ã™ã€‚<br> å®Ÿè£…ã‚’ã¿ã¦ã¿ã‚‹ã¨ã€<code>metadata.finalizers: ["aaa", "bbb"]</code>ã®ã‚ˆã†ãªarrayå‹ã®æ›´æ–°ã‚’atomic(ç«¶åˆã—ãªã„ã‚ˆã†ã«)ã«å‡¦ç†ã—ã¦ãã‚Œã¦ãŠã‚Šã€å‚è€ƒã«ãªã‚Šã¾ã™ã€‚<p>å®Ÿéš›ã«æ“ä½œã™ã‚‹ã“ã¨ã§<a href=https://kubernetes.io/docs/concepts/overview/working-with-objects/finalizers/ rel=external>Finalizers</a>ã®ä»•çµ„ã¿ã®ç†è§£ãŒé€²ã¿ã¾ã—ãŸã€‚operatorä½œã£ã¦ã¿ã‚‹ã“ã¨ã§kubernetesã®ã“ã¨ã‚’ã„ã‚ã„ã‚èª¿ã¹ã‚‰ã‚Œã‚‹ã®ã§æ¥½ã—ã„ã§ã™ã€‚<h4 id=hello-apply><a aria-label="Anchor link for: hello-apply" class=zola-anchor href=#hello-apply><code>Hello</code> Apply</a></h4><p>Validation, finalizerå‡¦ç†ãŒæ¸ˆã‚“ã ã®ã§ã„ã‚ˆã„ã‚ˆã€<code>Hello</code>ã®å®Ÿæ…‹ã®<code>Deployment</code>ã‚’ä½œæˆã—ã¦ã„ãã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[tracing::instrument(skip_all)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> reconcile_hello</span><span style=color:#eceff4>(</span><span>hello</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Arc</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Hello</span><span style=color:#eceff4>>,</span><span> context</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Arc</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Context</span><span style=color:#eceff4>>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Action</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Error</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> name</span><span style=color:#81a1c1> =</span><span> hello</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>name_any</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> namespace</span><span style=color:#81a1c1> =</span><span> hello</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>namespace</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>ok_or_else</span><span style=color:#eceff4>(</span><span>Error</span><span style=color:#81a1c1>::</span><span>no_namespace</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> owner_ref</span><span style=color:#81a1c1> =</span><span> hello</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>controller_owner_ref</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span style=color:#eceff4>())</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>expect</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Hello has owner_reference</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>    deploy</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>        context</span><span style=color:#81a1c1>.</span><span>client</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#81a1c1>        &</span><span>name</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        hello</span><span style=color:#81a1c1>.</span><span>spec</span><span style=color:#81a1c1>.</span><span>replicas</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        owner_ref</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>        &</span><span>namespace</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    )</span></span>
<span class=giallo-l><span style=color:#81a1c1>    .await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    info!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Reconcile hello</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>    Ok</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Action</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>requeue</span><span style=color:#eceff4>(</span><span>Duration</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_secs</span><span style=color:#eceff4>(</span><span style=color:#b48ead>60</span><span style=color:#81a1c1> *</span><span style=color:#b48ead> 10</span><span style=color:#eceff4>)))</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> k8s_openapi</span><span style=color:#81a1c1>::</span><span>api</span><span style=color:#81a1c1>::</span><span>apps</span><span style=color:#81a1c1>::</span><span>v1</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Deployment</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> DeploymentSpec</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>pub async fn</span><span style=color:#88c0d0> deploy</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>    client</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Client</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    deployment_name</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>str</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    replicas</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> u32</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    owner_ref</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> OwnerReference</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    namespace</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>str</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Deployment</span><span style=color:#eceff4>,</span><span> kube</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>> {</span><span style=color:#616e88> /* ... */</span><span style=color:#eceff4> }</span></span></code></pre><p><code>Hello</code>ã‹ã‚‰å¿…è¦ãªæƒ…å ±ã‚’æŠ½å‡ºã—ã¦ã€Kubernetesã®<code>Deployment</code>ã‚’ä½œæˆã™ã‚‹å‡¦ç†ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚<br> <code>hello.name_any()</code>ã¯<code>metadata.name</code>ãŒã‚ã‚Œã°åˆ©ç”¨ã—ã€è¨­å®šã•ã‚Œã¦ã„ãªã‘ã‚Œã°generateã•ã‚ŒãŸã‚‚ã®ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚<br> <code>hello.namespace()</code>ã¯<code>metadata.namespace</code>ã‚’å‚ç…§ã—ã¾ã™ã€‚manifestã«è¨­å®šã•ã‚Œã¦ã„ãªã‘ã‚Œã°errorã¨ã—ã¾ã™ã€‚<br> <code>hello.controller_owner_ref(&())</code>ã¯<a href=https://kubernetes.io/docs/concepts/overview/working-with-objects/owners-dependents/ rel=external><code>metadata.ownerReferences</code></a>ã‚’å–å¾—ã™ã‚‹ã‚‚ã®ã§ã™ã€‚ä½œæˆã™ã‚‹<code>Deployment</code>ã®metadataã«ä»˜ä¸ã™ã‚‹ã“ã¨ã§ã€ä¾å­˜é–¢ä¿‚ã‚’è¡¨ç¾ã—ã¾ã™ã€‚ã“ã‚Œã‚’ä»˜ä¸ã—ã¦ãŠã‹ãªã„ã¨ä½œæˆã—ãŸ<code>Deployment</code>ã®å¤‰æ›´ã§operatorã®reconcileãŒtriggerã•ã‚Œãªã„ã®ã§æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚<p>ç¶šã„ã¦<code>Deployment</code>ã‚’applyã™ã‚‹å‡¦ç†ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>collections</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>BTreeMap</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> k8s_openapi</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span>    api</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span>        apps</span><span style=color:#81a1c1>::</span><span>v1</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>Deployment</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> DeploymentSpec</span><span style=color:#eceff4>},</span></span>
<span class=giallo-l><span>        core</span><span style=color:#81a1c1>::</span><span>v1</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>Container</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> ContainerPort</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> PodSpec</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> PodTemplateSpec</span><span style=color:#eceff4>},</span></span>
<span class=giallo-l><span style=color:#eceff4>    },</span></span>
<span class=giallo-l><span>    apimachinery</span><span style=color:#81a1c1>::</span><span>pkg</span><span style=color:#81a1c1>::</span><span>apis</span><span style=color:#81a1c1>::</span><span>meta</span><span style=color:#81a1c1>::</span><span>v1</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>LabelSelector</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> OwnerReference</span><span style=color:#eceff4>},</span></span>
<span class=giallo-l><span style=color:#eceff4>};</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> kube</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span>    api</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>DeleteParams</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> ObjectMeta</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Patch</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> PatchParams</span><span style=color:#eceff4>},</span></span>
<span class=giallo-l><span>    error</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>ErrorResponse</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Api</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Client</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>};</span></span>
<span class=giallo-l></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>pub async fn</span><span style=color:#88c0d0> deploy</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>    client</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Client</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    deployment_name</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>str</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    replicas</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> u32</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    owner_ref</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> OwnerReference</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    namespace</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>str</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Deployment</span><span style=color:#eceff4>,</span><span> kube</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> labels</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> BTreeMap</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>></span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span>    labels</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>insert</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>        "</span><span style=color:#a3be8c>app.kubernetes.io/name</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_owned</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>        deployment_name</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_owned</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>    );</span></span>
<span class=giallo-l><span>    labels</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>insert</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>        "</span><span style=color:#a3be8c>operator.fraim.co.jp/managed-by</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_owned</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>        "</span><span style=color:#a3be8c>example-operator</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_owned</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>    );</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> deployment</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Deployment</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Deployment</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>        metadata</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> ObjectMeta</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            name</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>deployment_name</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_owned</span><span style=color:#eceff4>()),</span></span>
<span class=giallo-l><span>            namespace</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>namespace</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_owned</span><span style=color:#eceff4>()),</span></span>
<span class=giallo-l><span>            owner_references</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span style=color:#88c0d0;font-weight:700>vec!</span><span style=color:#eceff4>[</span><span>owner_ref</span><span style=color:#eceff4>]),</span></span>
<span class=giallo-l><span>            labels</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>labels</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>()),</span></span>
<span class=giallo-l><span style=color:#81a1c1>            ..</span><span style=color:#8fbcbb>Default</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>        },</span></span>
<span class=giallo-l><span>        spec</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>DeploymentSpec</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            replicas</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>replicas</span><span style=color:#81a1c1> as</span><span style=color:#8fbcbb> i32</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span>            selector</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> LabelSelector</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                match_expressions</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> None</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>                match_labels</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>labels</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>()),</span></span>
<span class=giallo-l><span style=color:#eceff4>            },</span></span>
<span class=giallo-l><span>            template</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> PodTemplateSpec</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                metadata</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>ObjectMeta</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                    labels</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>labels</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    ..</span><span style=color:#8fbcbb>Default</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>                }),</span></span>
<span class=giallo-l><span>                spec</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>PodSpec</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                    containers</span><span style=color:#81a1c1>:</span><span style=color:#88c0d0;font-weight:700> vec!</span><span style=color:#eceff4>[</span><span style=color:#8fbcbb>Container</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                        name</span><span style=color:#81a1c1>:</span><span> deployment_name</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_owned</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>                        image</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>nginxdemos/hello:0.3-plain-text</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_owned</span><span style=color:#eceff4>()),</span></span>
<span class=giallo-l><span>                        ports</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span style=color:#88c0d0;font-weight:700>vec!</span><span style=color:#eceff4>[</span><span style=color:#8fbcbb>ContainerPort</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                            container_port</span><span style=color:#81a1c1>:</span><span style=color:#b48ead> 8080</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>                            ..</span><span style=color:#8fbcbb>ContainerPort</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>                        }]),</span></span>
<span class=giallo-l><span style=color:#81a1c1>                        ..</span><span style=color:#8fbcbb>Container</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>                    }],</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    ..</span><span style=color:#8fbcbb>PodSpec</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>                }),</span></span>
<span class=giallo-l><span style=color:#eceff4>            },</span></span>
<span class=giallo-l><span style=color:#81a1c1>            ..</span><span style=color:#8fbcbb>DeploymentSpec</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>        }),</span></span>
<span class=giallo-l><span style=color:#81a1c1>        ..</span><span style=color:#8fbcbb>Deployment</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>    };</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> api</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Api</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Deployment</span><span style=color:#eceff4>></span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Api</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>namespaced</span><span style=color:#eceff4>(</span><span>client</span><span style=color:#eceff4>,</span><span> namespace</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span>    api</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>patch</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>        deployment</span><span style=color:#81a1c1>.</span><span>metadata</span><span style=color:#81a1c1>.</span><span>name</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_deref</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#81a1c1>        &</span><span>PatchParams</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>apply</span><span style=color:#eceff4>(</span><span>Operator</span><span style=color:#81a1c1>::</span><span>NAME</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#81a1c1>        &</span><span>Patch</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Apply</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>deployment</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>    )</span></span>
<span class=giallo-l><span style=color:#81a1c1>    .await</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>labelã‚’è¨­å®šã—ãŸã®ã¡ã€åŸºæœ¬çš„ã«ã¯<code>Deployment</code>ã®manifestã¨åŒã˜æƒ…å ±ã‚’è¨­å®šã—ã¦ã„ãã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>let</span><span> api</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Api</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Deployment</span><span style=color:#eceff4>></span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Api</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>namespaced</span><span style=color:#eceff4>(</span><span>client</span><span style=color:#eceff4>,</span><span> namespace</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span>api</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>patch</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>    deployment</span><span style=color:#81a1c1>.</span><span>metadata</span><span style=color:#81a1c1>.</span><span>name</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_deref</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#81a1c1>    &</span><span>PatchParams</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>apply</span><span style=color:#eceff4>(</span><span>Operator</span><span style=color:#81a1c1>::</span><span>NAME</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#81a1c1>    &</span><span>Patch</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Apply</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>deployment</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>.await</span></span></code></pre><p><code>Api::patch()</code>ã§<code>Patch::Apply</code>ã‚’åˆ©ç”¨ã™ã‚‹ã¨Server side applyãŒåˆ©ç”¨ã§ãã¾ã™ã€‚<code>&PatchParams::aplly()</code>ã«ã¯Server side applyã§åˆ©ç”¨ã™ã‚‹field managerã‚’æŒ‡å®šã—ã¾ã™ã€‚<h4 id=hello-delete><a aria-label="Anchor link for: hello-delete" class=zola-anchor href=#hello-delete><code>Hello</code> delete</a></h4><p>æœ€å¾Œã¯deleteå‡¦ç†ã‚’ç¢ºèªã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[tracing::instrument(skip_all)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> cleanup_hello</span><span style=color:#eceff4>(</span><span>hello</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Arc</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Hello</span><span style=color:#eceff4>>,</span><span> context</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Arc</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Context</span><span style=color:#eceff4>>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Action</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Error</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> name</span><span style=color:#81a1c1> =</span><span> hello</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>name_any</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> namespace</span><span style=color:#81a1c1> =</span><span> hello</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>namespace</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>ok_or_else</span><span style=color:#eceff4>(</span><span>Error</span><span style=color:#81a1c1>::</span><span>no_namespace</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>    delete</span><span style=color:#eceff4>(</span><span>context</span><span style=color:#81a1c1>.</span><span>client</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>(),</span><span style=color:#81a1c1> &</span><span>name</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> &</span><span>namespace</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>    context</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>recorder</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>hello</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>publish</span><span style=color:#eceff4>(</span><span>runtime</span><span style=color:#81a1c1>::</span><span>events</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Event</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            type_</span><span style=color:#81a1c1>:</span><span> EventType</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Normal</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            action</span><span style=color:#81a1c1>:</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>Deleting</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>            reason</span><span style=color:#81a1c1>:</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>DeleteRequested</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>            note</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span style=color:#88c0d0;font-weight:700>format!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Delete </span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>name</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>")),</span></span>
<span class=giallo-l><span>            secondary</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> None</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>        })</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    info!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Cleanup hello</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Ok</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Action</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>await_change</span><span style=color:#eceff4>())</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>pub async fn</span><span style=color:#88c0d0> delete</span><span style=color:#eceff4>(</span><span>client</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Client</span><span style=color:#eceff4>,</span><span> name</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>str</span><span style=color:#eceff4>,</span><span> namespace</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>str</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;(),</span><span> kube</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> api</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Api</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Deployment</span><span style=color:#eceff4>></span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Api</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>namespaced</span><span style=color:#eceff4>(</span><span>client</span><span style=color:#eceff4>,</span><span> namespace</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>    match</span><span> api</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>delete</span><span style=color:#eceff4>(</span><span>name</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> &</span><span>DeleteParams</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Ok</span><span style=color:#eceff4>(</span><span>_</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>(()),</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Err</span><span style=color:#eceff4>(</span><span>kube</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Error</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Api</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>ErrorResponse</span><span style=color:#eceff4> {</span><span> code</span><span style=color:#81a1c1>:</span><span style=color:#b48ead> 404</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> ..</span><span style=color:#eceff4> }))</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>(()),</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Err</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>åŸºæœ¬çš„ãªæµã‚Œã¯åŒæ§˜ã§ã™ã€‚å‰Šé™¤å¾Œã«eventã‚’å‡ºåŠ›ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã¿ã¾ã—ãŸã€‚<br> ã„ã¾ã„ã¡ã€eventã®å‡ºåŠ›åŸºæº–ãŒã‚ã‹ã£ã¦ã„ãªã„ã®ã§æ—¢å­˜ã®resourceã‚„ä»–ã®operatorã®å‡¦ç†ã‚’å‚è€ƒã«ã©ã‚“ãªeventã‚’å‡ºåŠ›ã—ã¦ã„ãã¨è‰¯ã„ã‹èª¿ã¹ã¦ã„ããŸã„ã§ã™ã€‚<h4 id=tracing><a aria-label="Anchor link for: tracing" class=zola-anchor href=#tracing>tracing</a></h4><p>Reconcileæ™‚ã®tracingã«ã¤ã„ã¦ã€‚ã¾ãšreconcileæ™‚ã«spanã‚’ä½œæˆã—ãŸããªã‚Šã¾ã™ãŒã€<a href=https://github.com/kube-rs/kube rel=external>kube-rs</a>å´ã§ä½œæˆã—ã¦ãã‚Œã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>let</span><span> reconciler_span</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0;font-weight:700> info_span!</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>    "</span><span style=color:#a3be8c>reconciling object</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>    "</span><span style=color:#a3be8c>object.ref</span><span style=color:#eceff4>"</span><span style=color:#81a1c1> = %</span><span>request</span><span style=color:#81a1c1>.</span><span>obj_ref</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    object</span><span style=color:#81a1c1>.</span><span>reason </span><span style=color:#81a1c1>= %</span><span>request</span><span style=color:#81a1c1>.</span><span>reason</span></span>
<span class=giallo-l><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span>reconciler_span</span></span>
<span class=giallo-l><span style=color:#81a1c1>    .</span><span style=color:#88c0d0>in_scope</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>||</span><span style=color:#88c0d0> reconciler</span><span style=color:#eceff4>(</span><span>Arc</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>obj</span><span style=color:#eceff4>),</span><span> context</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>()))</span></span>
<span class=giallo-l><span style=color:#616e88>// ...</span></span></code></pre><p><a href=https://github.com/kube-rs/kube/blob/044cac4fd6cae7df87eed9d2e6f7ad8c37e99ff1/kube-runtime/src/controller/mod.rs#L312 rel=external>source</a><p>ä¸Šè¨˜ã®ã‚ˆã†ãªspanã®ä¸­ã§userå´ã®reconcileå‡¦ç†ã‚’å‘¼ã‚“ã§ãã‚Œã¦ã„ã‚‹ã®ã§ã€userå´ã§resourceã®è­˜åˆ¥å­ã‚’logã«ã ã™å¿…è¦ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>INFO reconciling object{object.ref=Hello.v1.fraim.co.jp/hello.default object.reason=object updated}:reconcile: "User Message!"</span></span></code></pre><p>æ¦‚ã­ä¸Šè¨˜ã®ã‚ˆã†ãªspanã«ãªã£ã¦ã„ã¾ã—ãŸã€‚<br> ã¾ãŸã€<code>LOG_LOG=kube=debug</code>ã®ã‚ˆã†ã«kube moduleã«debugã‚’æŒ‡å®šã™ã‚‹ã¨<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>DEBUG HTTP{http.method=GET http.url=https://127.0.0.1:6443/apis/fraim.co.jp/v1/helloes?&limit=500&resourceVersion=0&resourceVersionMatch=NotOlderThan otel.name="list" otel.kind="client"}: /foo/.cargo/registry/src/index.crates.io-6f17d22bba15001f/kube-client-0.85.0/src/client/builder.rs:127: requesting</span></span></code></pre><p><code>otel.name</code>,<code>otel.kind</code>ã®ã‚ˆã†ã«tracing-opentelemetryã‚’åˆ©ç”¨ã—ã¦ã€opentelemetryç”¨ã®traceã‚‚ä½œã£ã¦ãã‚Œã¦ç´ æ™´ã‚‰ã—ã„ã§ã™ã€‚<h2 id=jian-zheng><a aria-label="Anchor link for: jian-zheng" class=zola-anchor href=#jian-zheng>æ¤œè¨¼</a></h2><p>æœ€å¾Œã«ä½œæˆã—ãŸoperatorã‚’å‹•ã‹ã—ã¦ã€manifestã‚’apply,deleteã—ã¦ã¿ã¾ã™ã€‚ é©ç”¨ã™ã‚‹manifestã¯ä»¥ä¸‹ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=yaml><span class=giallo-l><span style=color:#8fbcbb>apiVersion</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> fraim.co.jp/v1</span></span>
<span class=giallo-l><span style=color:#8fbcbb>kind</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> Hello</span></span>
<span class=giallo-l><span style=color:#8fbcbb>metadata</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  name</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> hello</span></span>
<span class=giallo-l><span style=color:#8fbcbb>spec</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  replicas</span><span style=color:#eceff4>:</span><span style=color:#b48ead> 2</span></span></code></pre><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>> kubectl apply -f manifests/hello.yaml</span></span>
<span class=giallo-l><span>hello.fraim.co.jp/hello created</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>> kubectl get deployments</span></span>
<span class=giallo-l><span>NAME    READY   UP-TO-DATE   AVAILABLE   AGE</span></span>
<span class=giallo-l><span>hello   2/2     2            2           9s</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>> kubectl port-forward deployments/hello 8000:80</span></span>
<span class=giallo-l><span>Forwarding from 127.0.0.1:8000 -> 80</span></span>
<span class=giallo-l><span>Forwarding from [::1]:8000 -> 80</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span># another terminal</span></span>
<span class=giallo-l><span>> curl http://localhost:8000</span></span>
<span class=giallo-l><span>Server address: 127.0.0.1:80</span></span>
<span class=giallo-l><span>Server name: hello-b7f675f9-pcd7p</span></span>
<span class=giallo-l><span>Date: 10/Sep/2023:12:19:19 +0000</span></span>
<span class=giallo-l><span>URI: /</span></span>
<span class=giallo-l><span>Request ID: 7152be71c211a7c507ec5d61ca47ae83</span></span></code></pre><p>ç„¡äº‹ã€deployã§ãã¦ã„ã¾ã™ã€‚ æ¬¡ã«validationã«é•åã—ãŸmanifestã‚’applyã—ã¦ã¿ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=yaml><span class=giallo-l><span>---</span></span>
<span class=giallo-l><span style=color:#8fbcbb>apiVersion</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> fraim.co.jp/v1</span></span>
<span class=giallo-l><span style=color:#8fbcbb>kind</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> Hello</span></span>
<span class=giallo-l><span style=color:#8fbcbb>metadata</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  name</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> hello</span></span>
<span class=giallo-l><span style=color:#8fbcbb>spec</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  replicas</span><span style=color:#eceff4>:</span><span style=color:#b48ead> 100</span><span style=color:#616e88> # Invalid (max: 20)</span></span></code></pre><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>> kubectl apply -f manifests/hello.yaml</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>> kubectl get events --field-selector 'involvedObject.kind==Hello,type=Warning'</span></span>
<span class=giallo-l><span>LAST SEEN   TYPE      REASON        OBJECT        MESSAGE</span></span>
<span class=giallo-l><span>5m4s        Warning   InvalidSpec   hello/hello   Invalid Hello spec: replicas: greater than 20</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>> kubectl get deployments</span></span>
<span class=giallo-l><span>NAME    READY   UP-TO-DATE   AVAILABLE   AGE</span></span>
<span class=giallo-l><span>hello   2/2     2            2           9m24s</span></span></code></pre><p>Validationã«é•åã—ã¦ãŠã‚Šã€eventã®å‡ºåŠ›ã‚‚ç¢ºèªã§ãã¾ã—ãŸã€‚<br> ãŸã ã€applyè‡ªä½“ã¯ã§ãã¦ã—ã¾ã†ã®ã§ã€è¡¨ç¾ã§ãã‚‹ãªã‚‰server side validationã®ã»ã†ãŒè‰¯ã„ã®ã‹ãªã¨æ€ã„ã¾ã—ãŸã€‚<br> æœ€å¾Œã«manifestã‚’ã‚‚ã¨ã«ã‚‚ã©ã—ã¦å‰Šé™¤ã—ã¦ã¿ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#81a1c1>></span><span> kubectl delete -f manifests/hello.yaml</span></span>
<span class=giallo-l><span style=color:#88c0d0>hello.fraim.co.jp</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>hello</span><span style=color:#eceff4>"</span><span style=color:#a3be8c> deleted</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>></span><span> kubectl get deployments</span></span>
<span class=giallo-l><span style=color:#88c0d0>No</span><span style=color:#a3be8c> resources found in default namespace.</span></span></code></pre><p>ç„¡äº‹å‰Šé™¤ã§ãã¾ã—ãŸã€‚<h2 id=matome><a aria-label="Anchor link for: matome" class=zola-anchor href=#matome>ã¾ã¨ã‚</a></h2><p><a href=https://github.com/kube-rs/kube rel=external>kube-rs</a>ã‚’åˆ©ç”¨ã—ã¦ç°¡å˜ãªoperatorã‚’ä½œã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚<br> Resourceã®CRUD apiã ã‘ã§ãªãã€reconcileé–¢é€£(kube_runtime)ã‚„ã€finalizer, eventç­‰ã®ä»•çµ„ã¿ã‚‚ç”¨æ„ã•ã‚Œã¦ãŠã‚Šã€userãŒreconcileã«é›†ä¸­ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚<h2 id=can-kao><a aria-label="Anchor link for: can-kao" class=zola-anchor href=#can-kao>å‚è€ƒ</a></h2><ul><li><a href=https://kube.rs/getting-started/ rel=external>kube-rsã®doc</a> <ul><li>ç‰¹ã«<a href=https://kube.rs/controllers/intro/ rel=external>å†…éƒ¨ã®å®Ÿè£…ã®è§£èª¬</a>ãŒéå¸¸ã«ã‚ã‚ŠãŒãŸã‹ã£ãŸã§ã™</ul><li><a href=https://www.pavel.cool/rust/rust-kubernetes-operators/ rel=external>å‹‰å¼·ä¼šã§é¡Œæã«ã—ãŸoperatorã®tutorial blog</a><li><a href=https://github.com/kube-rs/kube rel=external>kube-rs</a> <a href=https://github.com/kube-rs/controller-rs/tree/main rel=external>projectã§ç®¡ç†ã•ã‚Œã¦ã„ã‚‹å‚ç…§å®Ÿè£…</a><li><a href=https://learning.oreilly.com/library/view/kubernetes-operators/9781492048039/ rel=external>Kubertes Operators</a> ã‚ªãƒ©ã‚¤ãƒªãƒ¼æœ¬ã€‚</ul><h2 id=bonasutoratuku><a aria-label="Anchor link for: bonasutoratuku" class=zola-anchor href=#bonasutoratuku>ãƒœãƒ¼ãƒŠã‚¹ãƒˆãƒ©ãƒƒã‚¯</a></h2><p>æœ¬è¨˜äº‹ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«api(client)ã¨watchã®è¨­å®šã‚’æ¸¡ã™ã¨reconcileå‡¦ç†ãŒå‘¼ã°ã‚Œã‚‹ã¨ã—ã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#8fbcbb>Controller</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>crd_api</span><span style=color:#eceff4>,</span><span> wc</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span style=color:#81a1c1>    .</span><span style=color:#88c0d0>run</span><span style=color:#eceff4>(</span><span>Operator</span><span style=color:#81a1c1>::</span><span>reconcile</span><span style=color:#eceff4>,</span><span> Operator</span><span style=color:#81a1c1>::</span><span>handle_error</span><span style=color:#eceff4>,</span><span> context</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span></code></pre><p>ãŸã ã€å†…éƒ¨ã®å®Ÿè£…ãŒã©ã®ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã‹ã¯æ°—ã«ãªã‚‹ã¨ã“ã‚ã§ã™ã€‚<br> ã¾ãŸã€<a href=https://github.com/kube-rs/kube rel=external>kube-rs</a>ã®docã‚’èª­ã‚“ã§ã„ã‚‹ã¨watcherã‚„ã€reflectorã¨ã„ã£ãŸã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¸ã®è¨€åŠãŒã—ã°ã—ã°ãªã•ã‚Œã¾ã™ã€‚<br> å®Ÿè£…ã®è©³ç´°ãªç†è§£ã¯é•·ããªã£ã¦ã—ã¾ã†ã®ã§åˆ¥ã®è¨˜äº‹ã«ã—ãŸã„ã¨æ€ã„ã¾ã™ãŒã€ã“ã“ã§ã¯<a href=https://github.com/kube-rs/kube rel=external>kube-rs</a>ãŒå†…éƒ¨çš„ã«ã‚„ã£ã¦ãã‚Œã¦ã„ã‚‹ã“ã¨ã®ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ¢ãƒ‡ãƒ«ã ã‘ã§ã‚‚æŒã¦ã‚Œã°ã¨æ€ã„ã¾ã™ã€‚<p>å®Ÿéš›ã«ã¯ã‚‚ã£ã¨è¤‡é›‘ãªã®ã§ã™ãŒã€æ¦‚è¦ã¨ã—ã¦ã¯ã€<code>Controller::new()</code>ã‹ã‚‰<code>Controller::run()</code>ã«ã„ãŸã‚‹ã¾ã§ã®kube_runtimeã®å‡¦ç†ã¯ã™ã¹ã¦<code>futures::stream::Stream</code>æŒ‡å‘ã¨ãªã£ã¦ãŠã‚Šã€éå¸¸ã«æ„ŸéŠ˜ã‚’ã†ã‘ã¾ã—ãŸã€‚<p><img alt="kube-runtime overview" src=https://blog.ymgyt.io/entry/creating-tiny-operator-in-rust/./images/kube-runtime-overview.png><p>Streamã¯å¤§ããã€watcher, reflector, controllerã§å‡¦ç†ã•ã‚Œã¦ã„ã¾ã™ã€‚<br> watcherã¯å®Ÿéš›ã«kubenetes apiã‚’callã—ã¦resourceã®ç›£è¦–çµæœã‚’å–å¾—ã—ã¾ã™ã€‚<br> reflectorã¯å†…éƒ¨çš„ã«<code>Arc&lt;RwLock&lt;AHashMap&lt;ObjectRef&lt;Resource>,Arc&lt;Resource>>>></code>å‹ã®storeã‚’ä¿æŒã—ã¦ãŠã‚Šã€ãã“ã«resourceã®æƒ…å ±ã‚’cacheã—ã¦ã„ã¾ã™ã€‚<br> controllerå´ã§ã¯ã€ãã‚Œã‚‰ã®æƒ…å ±ã‚„çµ‚äº†å‡¦ç†ã®signal, schedulingç­‰ã‚’è¡Œã„ã€æœ€çµ‚çš„ã«userã®reconcileå‡¦ç†ã‚’triggerã—ã¦ã„ã¾ã™ã€‚<br> watcherã‚„reflectorã‚‚pubã¨ã—ã¦å…¬é–‹ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€operatorã®å®Ÿè£…ä»¥å¤–ã§ã‚‚kubernetesé–¢é€£ã®toolã‚’ä½œæˆã™ã‚‹éš›ã«ã¯åˆ©ç”¨ã§ããã†ã ã¨æ€ã„ã¾ã—ãŸã€‚</div></article></main><footer class=blog-footer><p>Â© 2026 <a href=https://blog.ymgyt.io> ymgyt </a> | Made with <a href=https://www.getzola.org rel=noopener target=_blank>Zola</a> | <a href=https://github.com/ymgyt/blog>Repository</a> | <a href=https://blog.ymgyt.io/atom.xml target=_blank title=rss> <svg viewbox="0 0 24 24" class=icon fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx=5 cy=19 r=1></circle></svg> </a></footer></div></div>