<!doctype html><html lang=ja><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1" name=viewport><link href=https://blog.ymgyt.io/favicon.ico rel=icon sizes=any><link href=https://blog.ymgyt.io/icon.svg rel=icon type=image/svg+xml><link href=https://blog.ymgyt.io/apple-touch-icon.png rel=apple-touch-icon><link href=https://blog.ymgyt.io/manifest.webmanifest rel=manifest><link href=https://blog.ymgyt.io/style.css rel=stylesheet><link href=https://blog.ymgyt.io/atom.xml rel=alternate title=Atom type=application/atom+xml><script src="https://www.googletagmanager.com/gtag/js?id=G-GTB0KMLN90" async></script><script>window.dataLayer = window.dataLayer || [];
	function gtag() {dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-GTB0KMLN90');</script><title>â„ï¸ NixOSã¨Raspberry Piã§è‡ªå®…server | Part 5 CPUã®æ¸©åº¦ã‚’metricsã¨ã—ã¦å–å¾— | Happy developing</title><meta content=CPUã®æ¸©åº¦ã‚’å–å¾—ã—ã¦opentelemetryã®metricsã¨ã—ã¦æ‰±ãˆã‚‹ã‚ˆã†ã«ã—ã¾ã™ name=description><meta content=summary name=twitter:card><meta content="@YAmaguchixt " name=twitter:site><meta content="â„ï¸ NixOSã¨Raspberry Piã§è‡ªå®…server | Part 5 CPUã®æ¸©åº¦ã‚’metricsã¨ã—ã¦å–å¾—" name=twitter:title><meta content=CPUã®æ¸©åº¦ã‚’å–å¾—ã—ã¦opentelemetryã®metricsã¨ã—ã¦æ‰±ãˆã‚‹ã‚ˆã†ã«ã—ã¾ã™ name=twitter:description><meta content=https://blog.ymgyt.io/images/emoji/snowflake.png name=twitter:image><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><body><div class=world><div class=content-container><header class=blog-header-container><div class=blog-logo><a href=https://blog.ymgyt.io>Happy developing</a></div><div class=blog-nav><nav><ul><li><a href=https://blog.ymgyt.io/entry/>Entries</a><li><a href=https://blog.ymgyt.io/tags/>Tags</a><li><a href=https://blog.ymgyt.io/about/>About</a><li><a href=https://github.com/ymgyt> <img alt=Github class=icon src=https://blog.ymgyt.io/images/icon/github.svg> </a><li><a href="https://twitter.com/YAmaguchixt "> <img alt=Twitter class=icon src=https://blog.ymgyt.io/images/icon/twitter.svg> </a></ul></nav></div></header><main class=blog-main><article><header class=entry-header><h1 class=entry-title>â„ï¸ NixOSã¨Raspberry Piã§è‡ªå®…server | Part 5 CPUã®æ¸©åº¦ã‚’metricsã¨ã—ã¦å–å¾—</h1><div class=entry-meta><p class=entry-meta-item>ğŸ—“ 2023-10-22<p class=entry-meta-item>ğŸ· <span class=tag><a href=https://blog.ymgyt.io/tags/nix/>nix</a></span> <span class=tag><a href=https://blog.ymgyt.io/tags/opentelemetry/>opentelemetry</a></span> <span class=tag><a href=https://blog.ymgyt.io/tags/rust/>rust</a></span></div></header><aside class=entry-toc><nav><ul class=entry-toc-toplevel-list><li><a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-get-cpu-temperature/#kitukake>ãã£ã‹ã‘</a><li><a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-get-cpu-temperature/#gai-yao>æ¦‚è¦</a><li><a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-get-cpu-temperature/#systemd-timer>systemd timer</a><li><a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-get-cpu-temperature/#scriptnozuo-cheng>Scriptã®ä½œæˆ</a><li><a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-get-cpu-temperature/#cpuwen-du-noqu-de>CPUæ¸©åº¦ã®å–å¾—</a><li><a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-get-cpu-temperature/#metricsnoexport>Metricsã®export</a> <ul><li><a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-get-cpu-temperature/#collectornireceiverwozhui-jia>Collectorã«receiverã‚’è¿½åŠ </a></ul><li><a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-get-cpu-temperature/#matome>ã¾ã¨ã‚</a></ul></nav></aside><div class=entry-content><p><a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-install-nixos/ rel=external>Part 1 NixOSã‚’install</a><br> <a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-deploy-with-deploy-rs/ rel=external>Part 2 deply-rsã§NixOS Configurationã‚’é©ç”¨</a><br> <a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-secret-management-with-ragenix/ rel=external>Part 3 ragenixã§secretç®¡ç†</a><br> <a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-export-metrics-with-opentelemetry-collector/ rel=external>Part 4 opentelemetry-collectorã¨openobserveã§metricsã‚’å–å¾—</a><br> Part 5 CPUã®æ¸©åº¦ã‚’metricsã¨ã—ã¦å–å¾—(ğŸ‘ˆ ã“ã®è¨˜äº‹)<p><a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-export-metrics-with-opentelemetry-collector/ rel=external>Part 4</a>ã§opentelemetry-collectorã‚’å°å…¥ã—ã¦metricsã‚’å–å¾—ã—ã¦backend(openobserve)ã«é€ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚<br> Part 5ã§ã¯opentelemetry-collectorã®æ©Ÿèƒ½ã ã‘ã§ã¯å–å¾—ã§ããªã„CPUã®æ¸©åº¦ã‚’å–å¾—ã—ã¦ã€metricsã¨ã—ã¦æ‰±ãˆã‚‹ã‚ˆã†ã«ã—ã¦ã„ãã¾ã™ã€‚<br> ã‚´ãƒ¼ãƒ«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«CPUæ¸©åº¦ã‚’dashboardã«è¡¨ç¤ºã™ã‚‹ã¨ã“ã‚ã¾ã§ã§ã™ã€‚<br><figure><div class=fig-images-row><img , alt src=images/ss-cpu-temp.png></div></figure><p><a href=https://github.com/ymgyt/mynix/tree/main/homeserver rel=external>source</a><h2 id=kitukake><a aria-label="Anchor link for: kitukake" class=zola-anchor href=#kitukake>ãã£ã‹ã‘</a></h2><figure><div class=fig-images-row><img , alt src=images/ss-bottom.png></div><figcaption>btmå‡ºåŠ›</figcaption></figure><p><a href=https://github.com/ClementTsang/bottom rel=external><code>btm</code></a>ã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹ã¨CPUã®æ¸©åº¦ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã—ãŸã€‚(ä¸­æ®µã®Temperatures)<br> å®¶ã«ç½®ã„ã¦ã„ã‚‹ã®ã§raspiãŒç†±ããªã£ã¦ç«äº‹ã«ãªã£ãŸã‚‰æ€–ã„ãªã¨æ€ã„ã€CPUæ¸©åº¦ã‚’metricsã«ã—ã¦alertã‚’è¨­å®šã—ãŸããªã‚Šã¾ã—ãŸã€‚<h2 id=gai-yao><a aria-label="Anchor link for: gai-yao" class=zola-anchor href=#gai-yao>æ¦‚è¦</a></h2><figure><div class=fig-images-row><img , alt src=images/cpu-metrics-overview.png></div></figure><p>ä½œæˆã™ã‚‹å‡¦ç†ã®æ¦‚è¦ã¨ã—ã¦ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚<ol><li>systemd timerã‚’åˆ©ç”¨ã—ã¦cpuæ¸©åº¦ã‚’å–å¾—ã™ã‚‹scriptã‚’å®šæœŸå®Ÿè¡Œã™ã‚‹<li>scriptã®ä¸­ã§cpuæ¸©åº¦ã‚’å–å¾—ã—ã¦localã§èµ·å‹•ã—ã¦ã„ã‚‹opentelemetry-collectorã«metricsã‚’exportã™ã‚‹<li>opentelemetry-collectorã‹ã‚‰openobserveã«exportã™ã‚‹</ol><p>systemd timerã¯cronã®ã‚ˆã†ãªã‚‚ã®ã§ã™ã€‚<a href=https://blog.ymgyt.io/entry/linux-service-management-made-easy-with-systemd/ rel=external>systemdæœ¬</a>ã‚’èª­ã‚“ã§çŸ¥ã£ãŸã®ã§åˆ©ç”¨ã—ã¦ã¿ã¾ã™ã€‚<p>scriptã®ä¸­ã§å–å¾—ã—ãŸcpuæ¸©åº¦ã‚’opentelemetry-collectorã«é€ã‚‹ãŸã‚ã«<a href=https://github.com/ymgyt/opentelemetry-cli rel=external><code>opentelemetry-cli(otel)</code></a>ã‚’ä½œã‚Šã¾ã—ãŸã€‚<p>scriptã‹ã‚‰ç›´æ¥openobserveã«exportã—ãªã„ã®ã¯ä»¥ä¸‹ã®ç‚¹ã‹ã‚‰ã§ã™ã€‚<ul><li>Resource(ãã®metricsãŒã©ã“ã‹ã‚‰æ¥ãŸã‹ã®æƒ…å ±)ã®å–å¾—ã‚„ä»˜ä¸ã‚’collectorå´ã§è¡Œã„ãŸã„<li>Retryã‚„batchã‚‚collectorã«ã¾ã‹ã›ãŸã„<li>openobserveã®èªè¨¼æƒ…å ±ã‚’1ç®‡æ‰€ã«ç½®ã„ã¦ãŠããŸã„</ul><h2 id=systemd-timer><a aria-label="Anchor link for: systemd-timer" class=zola-anchor href=#systemd-timer>systemd timer</a></h2><p>ã¾ãšã¯scriptã‚’å®šæœŸå®Ÿè¡Œã™ã‚‹ãŸã‚ã«systemd timerã‚’è¨­å®šã—ã¾ã™ã€‚<br> è¨­å®šã¨ã—ã¦ã¯ã„ã¤ã©ã®serviceã‚’å‘¼ã³å‡ºã™ã‹ã‚’å®šç¾©ã—ã¦ãŠãã¨systemdå´ã§serviceã‚’èµ·å‹•ã—ã¦ãã‚Œã¾ã™ã€‚<br> è‡ªåˆ†ãŒã™ã”ã„ãªã¨æ€ã£ãŸã®ã¯<code>AccuracySec=1m</code>ã®ã‚ˆã†ã«è¨­å®šã—ã¦ãŠãã¨ã€æŒ‡å®šã®æ™‚åˆ»ã‹ã‚‰1åˆ†ã®ç¯„å›²å†…ã§èµ·å‹•æ™‚é–“ã‚’randomã«ã‚ºãƒ©ã—ã¦ãã‚Œã€ãã®éš›ã®æ¶ˆè²»é›»åŠ›ã‚’æœ€å°åŒ–ã™ã‚‹ã‚ˆã†ãªã“ã¨ã‚‚è€ƒæ…®ã—ã¦ãã‚Œã‚‹ç‚¹ã§ã™ã€‚<p><code>man systemd.timer</code>ã®èª¬æ˜<blockquote><p>Within this time window, the expiry time will be placed at a host-specific, randomized, but stable position that is synchronized between all local timer units. This is done in order to optimize power consumption to suppress unnecessary CPU wake-ups.</blockquote><p>nixã®è¨­å®šã¯ä»¥ä¸‹ã®ã‚ˆã†ã«è¡Œã„ã¾ã—ãŸã€‚<br> <code>modules/metrics/cpu-temperature/default.nix</code><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=nix><span class=giallo-l><span style=color:#eceff4>{</span><span> pkgs</span><span style=color:#81a1c1>,</span><span> opentelemetry-cli</span><span style=color:#81a1c1>, ...</span><span style=color:#eceff4>}:</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  systemd</span><span>.</span><span style=color:#8fbcbb>timers</span><span>.</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>cpu-temp-metrics</span><span style=color:#eceff4>"</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    wantedBy</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> [ "</span><span style=color:#a3be8c>timers.target</span><span style=color:#eceff4>" ]</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    timerConfig</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      Unit</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>cpu-temp-metrics.service</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      OnCalendar</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>minutely</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      Persistent</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>false</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      AccuracySec</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>1m</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>     }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>  }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>  systemd</span><span>.</span><span style=color:#8fbcbb>services</span><span>.</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>cpu-temp-metrics</span><span style=color:#eceff4>"</span><span style=color:#81a1c1> =</span><span> </span></span>
<span class=giallo-l><span style=color:#81a1c1>  let</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    otel</span><span style=color:#81a1c1> =</span><span> opentelemetry-cli</span><span style=color:#81a1c1>.</span><span>packages</span><span style=color:#81a1c1>.</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>${</span><span>pkgs</span><span style=color:#81a1c1>.</span><span>system</span><span style=color:#81a1c1>}</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span>opentelemetry-cli</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>  in</span></span>
<span class=giallo-l><span style=color:#eceff4>  {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    path</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> [</span><span> </span></span>
<span class=giallo-l><span>      pkgs</span><span style=color:#81a1c1>.</span><span>gawk </span></span>
<span class=giallo-l><span>      otel</span></span>
<span class=giallo-l><span style=color:#eceff4>    ]</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    script</span><span style=color:#81a1c1> = builtins.</span><span>readFile</span><span style=color:#a3be8c> ./script.sh</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    serviceConfig</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      Type</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>oneshot</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      DynamicUser</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>true</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      Nice</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>19</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>  }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>systemd.timers."cpu-temp-metrics"</code>ãŒtimerã®è¨­å®šã§ã™ã€‚<br> <code>man systemd.special</code>ã«ã‚ˆã‚‹ã¨<blockquote><p>timers.target<br> A special target unit that sets up all timer units (see systemd.timer(5) for details) that shall be active after boot.<br> It is recommended that timer units installed by applications get pulled in via Wants= dependencies from this unit.<br> This is best configured via WantedBy=timers.target in the timer unit's [Install] section. ã¨ã‚ã‚‹ã®ã§ã€<code>wantedBy</code>ã«ã¯<code>timers.target</code>ã‚’æŒ‡å®šã—ã¾ã—ãŸã€‚</blockquote><p><code>timerConfig.Unit</code>ã«ã¯èµ·å‹•ã™ã‚‹serviceã‚’æŒ‡å®šã—ã¾ã™ã€‚<br> çœç•¥ã™ã‚‹ã¨åŒã˜unitåã®serviceãŒèµ·å‹•ã•ã‚Œã‚‹ã‚ˆã†ã§ã™ãŒæ˜ç¤ºçš„ã«æŒ‡å®šã—ã¾ã—ãŸã€‚<br> <code>timerConfig.OnCalendar</code>ãŒèµ·å‹•ã™ã‚‹æ™‚é–“ã§ã™ã€‚<code>minutely</code>ãŒå…·ä½“çš„ã«ã¯ã„ã¤ãªã®ã‹ã¯<code>man systemd.time</code>ã«å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚<br> <code>timerConfig.Persistent</code>ã¯scheduleæ™‚ã«é›»æºãŒoffã ã£ãŸå ´åˆã«èµ·å‹•æ™‚ã«å®Ÿè¡Œã™ã‚‹ã‹ã®æŒ‡å®šã§ã™ã€‚ä¸è¦ãªã®ã§falseã€‚<br> <code>timerConfig.AccuracySec</code>ã¯ã•ãã»ã©è¿°ã¹ãŸèµ·å‹•æ™‚é–“ã®windowã§ã™ã€‚ã„ã¤ã§ã‚‚ã‚ˆã„ã®ã§ã€<code>1m</code>ã«ã—ã¾ã—ãŸã€‚<p>ä¸Šè¨˜ã®ã‚ˆã†ãªè¨­å®šã‚’ãŠã“ãªã†ã¨systemdä¸Šã¯ä»¥ä¸‹ã®ã‚ˆã†ãªè¨­å®šãŒå‡ºåŠ›ã•ã‚Œã¾ã—ãŸã€‚<br> <code>systemctl cat cpu-temp-metrics.timer</code><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=ini><span class=giallo-l><span style=color:#616e88># /etc/systemd/system/cpu-temp-metrics.timer</span></span>
<span class=giallo-l><span style=color:#eceff4>[</span><span>Unit</span><span style=color:#eceff4>]</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#eceff4>[</span><span>Timer</span><span style=color:#eceff4>]</span></span>
<span class=giallo-l><span style=color:#81a1c1>AccuracySec</span><span style=color:#eceff4>=</span><span>1m</span></span>
<span class=giallo-l><span style=color:#81a1c1>OnCalendar</span><span style=color:#eceff4>=</span><span>minutely</span></span>
<span class=giallo-l><span style=color:#81a1c1>Persistent</span><span style=color:#eceff4>=</span><span>false</span></span>
<span class=giallo-l><span style=color:#81a1c1>Unit</span><span style=color:#eceff4>=</span><span>cpu-temp-metrics.service</span></span></code></pre><h2 id=scriptnozuo-cheng><a aria-label="Anchor link for: scriptnozuo-cheng" class=zola-anchor href=#scriptnozuo-cheng>Scriptã®ä½œæˆ</a></h2><p>æ¬¡ã«å®šæœŸå®Ÿè¡Œã•ã‚Œã‚‹scriptã‚’ä½œæˆã—ã¾ã™ã€‚<br> scriptã‚’raspiã«è¨­å®šã—ã¦systemd timerã‹ã‚‰èµ·å‹•ã™ã‚‹ãŸã‚ã«ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šã—ã¾ã—ãŸã€‚<p><code>modules/metrics/cpu-temperature/default.nix</code><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=nix><span class=giallo-l><span style=color:#eceff4>{</span><span> pkgs</span><span style=color:#81a1c1>,</span><span> opentelemetry-cli</span><span style=color:#81a1c1>, ...</span><span style=color:#eceff4>}:</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  systemd</span><span>.</span><span style=color:#8fbcbb>timers</span><span>.</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>cpu-temp-metrics</span><span style=color:#eceff4>"</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>    # ...</span></span>
<span class=giallo-l><span style=color:#eceff4>  }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>  systemd</span><span>.</span><span style=color:#8fbcbb>services</span><span>.</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>cpu-temp-metrics</span><span style=color:#eceff4>"</span><span style=color:#81a1c1> =</span><span> </span></span>
<span class=giallo-l><span style=color:#81a1c1>  let</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    otel</span><span style=color:#81a1c1> =</span><span> opentelemetry-cli</span><span style=color:#81a1c1>.</span><span>packages</span><span style=color:#81a1c1>.</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>${</span><span>pkgs</span><span style=color:#81a1c1>.</span><span>system</span><span style=color:#81a1c1>}</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span>opentelemetry-cli</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>  in</span></span>
<span class=giallo-l><span style=color:#eceff4>  {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    path</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> [</span><span> </span></span>
<span class=giallo-l><span>      pkgs</span><span style=color:#81a1c1>.</span><span>gawk </span></span>
<span class=giallo-l><span>      otel</span></span>
<span class=giallo-l><span style=color:#eceff4>    ]</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    script</span><span style=color:#81a1c1> = builtins.</span><span>readFile</span><span style=color:#a3be8c> ./script.sh</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    serviceConfig</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      Type</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>oneshot</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      DynamicUser</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>true</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      Nice</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>19</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>  }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>systemd.services.&lt;name>.script</code>ã«å®Ÿè¡Œã—ãŸã„scriptã‚’æŒ‡å®šã™ã‚‹ã¨scriptã‚’å®Ÿè¡Œã™ã‚‹systemd serviceã‚’ä½œã‚Œã¾ã™ã€‚<br> ã“ã®serviceã¯timerã‹ã‚‰åˆ©ç”¨ã•ã‚Œã‚‹ã“ã¨ã‚’æ„å›³ã—ã¦ã„ã‚‹ã®ã§ã€<code>serviceConfig.Type = "oneshot"</code>ã‚’æŒ‡å®šã—ã¾ã—ãŸã€‚<br> <code>path</code>ã‚’æŒ‡å®šã™ã‚‹ã¨ã€scriptã®ä¸­ã‹ã‚‰æŒ‡å®šã•ã‚ŒãŸpackageã«<code>PATH</code>ãŒé€šã£ã¦ã„ã‚‹çŠ¶æ…‹ã«ã§ãã¾ã™ã€‚<a href=https://github.com/ymgyt/opentelemetry-cli rel=external>opentelemetry-cli</a>ã¯metricsã‚’exportã™ã‚‹ãŸã‚ã«åˆ©ç”¨ã—ã¾ã™ã€‚<p>ã“ã‚Œã§å¿…è¦ãªä¾å­˜ã¯nixãŒç®¡ç†ã—ã¦ãã‚Œã‚‹scriptãŒæ›¸ã‘ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚<h2 id=cpuwen-du-noqu-de><a aria-label="Anchor link for: cpuwen-du-noqu-de" class=zola-anchor href=#cpuwen-du-noqu-de>CPUæ¸©åº¦ã®å–å¾—</a></h2><p>CPUæ¸©åº¦ã‚’å–å¾—ã—ã¦opentelemetry-collectorã«exportã™ã‚‹scriptã«ã¤ã„ã¦ã¿ã¦ã„ãã¾ã™ã€‚<br> <code>modules/metrics/cpu-temperature/script.sh</code><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#81a1c1>function</span><span style=color:#88c0d0> get_cpu_temperature</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#88c0d0>  cat</span><span style=color:#a3be8c> /sys/class/thermal/thermal_zone0/temp</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>function</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>  local</span><span> raw_temp</span><span style=color:#81a1c1>=</span><span style=color:#eceff4>$(</span><span style=color:#88c0d0>get_cpu_temperature</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>  local</span><span> temp</span><span style=color:#81a1c1>=</span><span style=color:#eceff4>$(</span><span style=color:#88c0d0>awk</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>BEGIN { print </span><span>$raw_temp</span><span style=color:#a3be8c> / 1000 }</span><span style=color:#eceff4>")</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>  # export to local collector</span></span>
<span class=giallo-l><span style=color:#88c0d0>  otel</span><span style=color:#a3be8c> export metrics gauge</span><span style=color:#ebcb8b> \</span></span>
<span class=giallo-l><span style=color:#a3be8c>    --endpoint http://localhost:4317</span><span style=color:#ebcb8b> \</span></span>
<span class=giallo-l><span style=color:#a3be8c>    --name system.cpu.temperature</span><span style=color:#ebcb8b> \</span></span>
<span class=giallo-l><span style=color:#a3be8c>    --description</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>cpu temperature</span><span style=color:#eceff4>"</span><span style=color:#ebcb8b> \</span></span>
<span class=giallo-l><span style=color:#a3be8c>    --unit Cel</span><span style=color:#ebcb8b> \</span></span>
<span class=giallo-l><span style=color:#a3be8c>    --value-as-double</span><span style=color:#81a1c1> ${</span><span>temp</span><span style=color:#81a1c1>}</span><span style=color:#ebcb8b> \</span></span>
<span class=giallo-l><span style=color:#a3be8c>    --attributes</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>thermalzone:0</span><span style=color:#eceff4>"</span><span style=color:#ebcb8b> \</span></span>
<span class=giallo-l><span style=color:#a3be8c>    --schema-url https://opentelemetry.io/schemas/1.21.0</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>main</span></span></code></pre><p>CPUæ¸©åº¦ã®å–å¾—è‡ªä½“ã¯<code>/sys/class/thermal/thermal_zone0/temp</code>ã‚’catã™ã‚‹ã ã‘ã§ã™ã€‚<br> ã“ã®å‡¦ç†ã¯<a href=https://github.com/ClementTsang/bottom/blob/4174012b8f14cbf92536c103c924b280e7a53b58/src/app/data_harvester/temperature/linux.rs#L316 rel=external>bottomã®å‡¦ç†</a>ã‹ã‚‰ç›—ã¿ã¾ã—ãŸã€‚<br> commentã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹<a href=https://www.kernel.org/doc/Documentation/ABI/testing/sysfs-class-thermal rel=external>https://www.kernel.org/doc/Documentation/ABI/testing/sysfs-class-thermal</a>ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªèª¬æ˜ãŒã‚ã‚Šã¾ã—ãŸã€‚<blockquote><p>What: /sys/class/thermal/thermal_zoneX/temp<br> Description: Current temperature as reported by thermal zone (sensor).<br> Unit: millidegree Celsius</blockquote><h2 id=metricsnoexport><a aria-label="Anchor link for: metricsnoexport" class=zola-anchor href=#metricsnoexport>Metricsã®export</a></h2><p>CPUæ¸©åº¦ã‚’å–å¾—ã§ããŸã®ã§ã€localã§èµ·å‹•ã—ã¦ã„ã‚‹opentelemetry-collecotrã«metricsã‚’exportã—ã¦ã„ãã¾ã™ã€‚<p><a href=https://github.com/ymgyt/opentelemetry-cli rel=external>opentelemetry-cli</a>ã§ã¯åŸºæœ¬çš„ã«exportã—ãŸã„metricsã‚’<a href=https://github.com/ymgyt/opentelemetry-cli/blob/2c240ff81d55bf9801dca274d4705ea1d13510cc/src/cli/export.rs#L137 rel=external>grpc/protobufã«è©°ã‚æ›¿ãˆã¦ã„ã‚‹ã ã‘</a>ã§ã™ã€‚<br> ã†ã‚Œã—ã„ã®ã¯ã€otlpé–¢é€£ã®å‡¦ç†ã¯<a href=https://github.com/open-telemetry/opentelemetry-rust/tree/main/opentelemetry-proto rel=external><code>opentelemetry-proto</code></a>ã®ãŠã‹ã’ã§ã€ç”Ÿæˆã•ã‚ŒãŸrustã®codeã‚’åˆ©ç”¨ã§ãã‚‹ã®ã§ã€protobufç”Ÿæˆé–¢é€£ã®å‡¦ç†ã‚’ã¾ã‹ã›ã‚‹ã“ã¨ãŒã§ãã‚‹ç‚¹ã§ã™ã€‚ãªã®ã§1 metricsã‚’é€ã‚‹ã ã‘ãªã‚‰æœ¬å½“ã«è©°æ›¿ãˆã ã‘ã—ã‹å¿…è¦ãªã‹ã£ãŸã§ã™ã€‚<p>Exportã™ã‚‹metricsã®data modelã«é–¢ã—ã¦ã¯protobufã®commentã®èª¬æ˜ãŒã‚ã‹ã‚Šã‚„ã™ã‹ã£ãŸã®ã§å¼•ç”¨ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>  Metric</span></span>
<span class=giallo-l><span>//  +------------+</span></span>
<span class=giallo-l><span>//  |name        |</span></span>
<span class=giallo-l><span>//  |description |</span></span>
<span class=giallo-l><span>//  |unit        |     +------------------------------------+</span></span>
<span class=giallo-l><span>//  |data        |---> |Gauge, Sum, Histogram, Summary, ... |</span></span>
<span class=giallo-l><span>//  +------------+     +------------------------------------+</span></span>
<span class=giallo-l><span>//</span></span>
<span class=giallo-l><span>//    Data [One of Gauge, Sum, Histogram, Summary, ...]</span></span>
<span class=giallo-l><span>//  +-----------+</span></span>
<span class=giallo-l><span>//  |...        |  // Metadata about the Data.</span></span>
<span class=giallo-l><span>//  |points     |--+</span></span>
<span class=giallo-l><span>//  +-----------+  |</span></span>
<span class=giallo-l><span>//                 |      +---------------------------+</span></span>
<span class=giallo-l><span>//                 |      |DataPoint 1                |</span></span>
<span class=giallo-l><span>//                 v      |+------+------+   +------+ |</span></span>
<span class=giallo-l><span>//              +-----+   ||label |label |...|label | |</span></span>
<span class=giallo-l><span>//              |  1  |-->||value1|value2|...|valueN| |</span></span>
<span class=giallo-l><span>//              +-----+   |+------+------+   +------+ |</span></span>
<span class=giallo-l><span>//              |  .  |   |+-----+                    |</span></span>
<span class=giallo-l><span>//              |  .  |   ||value|                    |</span></span>
<span class=giallo-l><span>//              |  .  |   |+-----+                    |</span></span>
<span class=giallo-l><span>//              |  .  |   +---------------------------+</span></span>
<span class=giallo-l><span>//              |  .  |                   .</span></span>
<span class=giallo-l><span>//              |  .  |                   .</span></span>
<span class=giallo-l><span>//              |  .  |                   .</span></span>
<span class=giallo-l><span>//              |  .  |   +---------------------------+</span></span>
<span class=giallo-l><span>//              |  .  |   |DataPoint M                |</span></span>
<span class=giallo-l><span>//              +-----+   |+------+------+   +------+ |</span></span>
<span class=giallo-l><span>//              |  M  |-->||label |label |...|label | |</span></span>
<span class=giallo-l><span>//              +-----+   ||value1|value2|...|valueN| |</span></span>
<span class=giallo-l><span>//                        |+------+------+   +------+ |</span></span>
<span class=giallo-l><span>//                        |+-----+                    |</span></span>
<span class=giallo-l><span>//                        ||value|                    |</span></span>
<span class=giallo-l><span>//                        |+-----+                    |</span></span>
<span class=giallo-l><span>//                        +---------------------------+</span></span>
<span class=giallo-l><span>//</span></span></code></pre><p><code>Gauge</code>ã‚„<code>Sum(Counter)</code>ã§ã‚ã£ã¦ã‚‚nameã‚„descriptionã¯å…±é€šã§ã™ã€‚<br> ãã‚Œãã‚Œã®metricã¯è¤‡æ•°ã®<code>DataPoint</code>ã‚’ã‚‚ã¡ã€datapointã«å€¤ã‚„timestamp, attribute(ä¾‹ <code>state=idle</code>)ã‚’ä¿æŒã—ã¾ã™ã€‚<p><a href=https://github.com/open-telemetry/opentelemetry-proto/blob/ac3242b03157295e4ee9e616af53b81517b06559/opentelemetry/proto/metrics/v1/metrics.proto#L89 rel=external>Metrics data model</a><p>ã“ã‚Œã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¦exportã—ã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>  otel</span><span style=color:#a3be8c> export metrics gauge</span><span style=color:#ebcb8b> \</span></span>
<span class=giallo-l><span style=color:#a3be8c>    --endpoint http://localhost:4317</span><span style=color:#ebcb8b> \</span></span>
<span class=giallo-l><span style=color:#a3be8c>    --name system.cpu.temperature</span><span style=color:#ebcb8b> \</span></span>
<span class=giallo-l><span style=color:#a3be8c>    --description</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>cpu temperature</span><span style=color:#eceff4>"</span><span style=color:#ebcb8b> \</span></span>
<span class=giallo-l><span style=color:#a3be8c>    --unit Cel</span><span style=color:#ebcb8b> \</span></span>
<span class=giallo-l><span style=color:#a3be8c>    --value-as-double</span><span style=color:#81a1c1> ${</span><span>temp</span><span style=color:#81a1c1>}</span><span style=color:#ebcb8b> \</span></span>
<span class=giallo-l><span style=color:#a3be8c>    --attributes</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>thermalzone:0</span><span style=color:#eceff4>"</span><span style=color:#ebcb8b> \</span></span>
<span class=giallo-l><span style=color:#a3be8c>    --schema-url https://opentelemetry.io/schemas/1.21.0</span></span></code></pre><h3 id=collectornireceiverwozhui-jia><a aria-label="Anchor link for: collectornireceiverwozhui-jia" class=zola-anchor href=#collectornireceiverwozhui-jia>Collectorã«receiverã‚’è¿½åŠ </a></h3><p>opentelemetry-collectorã«grpcã§metricsã‚’é€ã‚Œã‚‹ã‚ˆã†ã«receiverã‚’è¿½åŠ ã—ã¾ã™ã€‚<p><code>modules/opentelemetry-collector/config.yaml</code><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=yaml><span class=giallo-l><span style=color:#8fbcbb>receivers</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  otlp</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    protocols</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      grpc</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        endpoint</span><span style=color:#eceff4>: "</span><span style=color:#a3be8c>127.0.0.1:4317</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#616e88># ...</span></span>
<span class=giallo-l><span style=color:#8fbcbb>service</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  extensions</span><span style=color:#eceff4>: [</span><span style=color:#a3be8c>memory_ballast</span><span style=color:#eceff4>]</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  pipelines</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    metrics</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      receivers</span><span style=color:#eceff4>:</span><span> </span></span>
<span class=giallo-l><span style=color:#eceff4>        -</span><span style=color:#a3be8c> otlp</span></span>
<span class=giallo-l><span style=color:#616e88>#...</span></span></code></pre><h2 id=matome><a aria-label="Anchor link for: matome" class=zola-anchor href=#matome>ã¾ã¨ã‚</a></h2><figure><div class=fig-images-row><img , alt src=images/ss-cpu-temp-dashboard.png></div><figcaption>å–å¾—ã—ãŸmetrics</figcaption></figure><p>ã“ã“ã¾ã§ã®è¨­å®šã‚’deployã™ã‚‹ã“ã¨ã§ã€CPUã®æ¸©åº¦ã‚’metricsã¨ã—ã¦å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚<br> æ¦‚ã­ã€30 ~ 35â„ƒã«ãªã£ã¦ã„ã¾ã—ãŸã€‚<br> 1å°ã ã‘(<code>rpi4-01</code>)ã ã‘è³¼å…¥ã—ãŸæ™‚æœŸãŒé•ã†ãŸã‚ã‹ã€è‹¥å¹²ã€ä»–ã®hostã«æ¯”ã¹ã¦æ¸©åº¦ãŒé«˜ã„ã¨ã„ã†ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚<p>ã“ã“ã¾ã§ãŠèª­ã¿ã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚</div></article></main><footer class=blog-footer><p>Â© 2026 <a href=https://blog.ymgyt.io> ymgyt </a> | Made with <a href=https://www.getzola.org rel=noopener target=_blank>Zola</a> | <a href=https://github.com/ymgyt/blog>Repository</a> | <a href=https://blog.ymgyt.io/atom.xml target=_blank title=rss> <svg viewbox="0 0 24 24" class=icon fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx=5 cy=19 r=1></circle></svg> </a></footer></div></div>