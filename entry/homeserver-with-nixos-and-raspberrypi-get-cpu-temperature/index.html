<!doctype html><html lang=ja><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1" name=viewport><link href=https://blog.ymgyt.io/favicon.ico rel=icon sizes=any><link href=https://blog.ymgyt.io/icon.svg rel=icon type=image/svg+xml><link href=https://blog.ymgyt.io/apple-touch-icon.png rel=apple-touch-icon><link href=https://blog.ymgyt.io/manifest.webmanifest rel=manifest><link href=https://blog.ymgyt.io/style.css rel=stylesheet><link href=https://blog.ymgyt.io/atom.xml rel=alternate title=Atom type=application/atom+xml><script src="https://www.googletagmanager.com/gtag/js?id=G-GTB0KMLN90" async></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[];gtag(`js`,new Date());gtag(`config`,`G-GTB0KMLN90`)</script><title>❄️ NixOSとRaspberry Piで自宅server | Part 5 CPUの温度をmetricsとして取得 | Happy developing</title><meta content=CPUの温度を取得してopentelemetryのmetricsとして扱えるようにします name=description><meta content=summary name=twitter:card><meta content="@YAmaguchixt " name=twitter:site><meta content="❄️ NixOSとRaspberry Piで自宅server | Part 5 CPUの温度をmetricsとして取得" name=twitter:title><meta content=CPUの温度を取得してopentelemetryのmetricsとして扱えるようにします name=twitter:description><meta content=https://blog.ymgyt.io/images/emoji/snowflake.png name=twitter:image><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><body><div class=world><div class=content-container><header class=blog-header-container><div class=blog-logo><a href=https://blog.ymgyt.io>Happy developing</a></div><div class=blog-nav><nav><ul><li><a href=https://blog.ymgyt.io/entry/>Entries</a><li><a href=https://blog.ymgyt.io/tags/>Tags</a><li><a href=https://blog.ymgyt.io/about/>About</a><li><a href=https://github.com/ymgyt> <img alt=Github class=icon src=https://blog.ymgyt.io/images/icon/github.svg> </a><li><a href="https://twitter.com/YAmaguchixt "> <img alt=Twitter class=icon src=https://blog.ymgyt.io/images/icon/twitter.svg> </a></ul></nav></div></header><main class=blog-main><article><header class=entry-header><h1 class=entry-title>❄️ NixOSとRaspberry Piで自宅server | Part 5 CPUの温度をmetricsとして取得</h1><div class=entry-meta><p class=entry-meta-item>🗓 2023-10-22<p class=entry-meta-item>🏷 <span class=tag><a href=https://blog.ymgyt.io/tags/nix/>nix</a></span> <span class=tag><a href=https://blog.ymgyt.io/tags/opentelemetry/>opentelemetry</a></span> <span class=tag><a href=https://blog.ymgyt.io/tags/rust/>rust</a></span></div></header><aside class=entry-toc><nav><ul class=entry-toc-toplevel-list><li><a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-get-cpu-temperature/#kitukake>きっかけ</a><li><a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-get-cpu-temperature/#gai-yao>概要</a><li><a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-get-cpu-temperature/#systemd-timer>systemd timer</a><li><a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-get-cpu-temperature/#scriptnozuo-cheng>Scriptの作成</a><li><a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-get-cpu-temperature/#cpuwen-du-noqu-de>CPU温度の取得</a><li><a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-get-cpu-temperature/#metricsnoexport>Metricsのexport</a> <ul><li><a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-get-cpu-temperature/#collectornireceiverwozhui-jia>Collectorにreceiverを追加</a></ul><li><a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-get-cpu-temperature/#matome>まとめ</a></ul></nav></aside><div class=entry-content><p><a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-install-nixos/>Part 1 NixOSをinstall</a><br> <a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-deploy-with-deploy-rs/>Part 2 deply-rsでNixOS Configurationを適用</a><br> <a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-secret-management-with-ragenix/>Part 3 ragenixでsecret管理</a><br> <a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-export-metrics-with-opentelemetry-collector/>Part 4 opentelemetry-collectorとopenobserveでmetricsを取得</a><br> Part 5 CPUの温度をmetricsとして取得(👈 この記事)<p><a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-export-metrics-with-opentelemetry-collector/>Part 4</a>でopentelemetry-collectorを導入してmetricsを取得してbackend(openobserve)に送れるようになりました。<br> Part 5ではopentelemetry-collectorの機能だけでは取得できないCPUの温度を取得して、metricsとして扱えるようにしていきます。<br> ゴールは以下のようにCPU温度をdashboardに表示するところまでです。<br><figure><div class=fig-images-row><img , alt src=images/ss-cpu-temp.png></div></figure><p><a href=https://github.com/ymgyt/mynix/tree/main/homeserver>source</a><h2 id=kitukake><a aria-label="Anchor link for: kitukake" class=zola-anchor href=#kitukake>きっかけ</a></h2><figure><div class=fig-images-row><img , alt src=images/ss-bottom.png></div><figcaption>btm出力</figcaption></figure><p><a href=https://github.com/ClementTsang/bottom><code>btm</code></a>を実行しているとCPUの温度が表示されていました。(中段のTemperatures)<br> 家に置いているのでraspiが熱くなって火事になったら怖いなと思い、CPU温度をmetricsにしてalertを設定したくなりました。<h2 id=gai-yao><a aria-label="Anchor link for: gai-yao" class=zola-anchor href=#gai-yao>概要</a></h2><figure><div class=fig-images-row><img , alt src=images/cpu-metrics-overview.png></div></figure><p>作成する処理の概要としては以下のようになります。<ol><li>systemd timerを利用してcpu温度を取得するscriptを定期実行する<li>scriptの中でcpu温度を取得してlocalで起動しているopentelemetry-collectorにmetricsをexportする<li>opentelemetry-collectorからopenobserveにexportする</ol><p>systemd timerはcronのようなものです。<a href=https://blog.ymgyt.io/entry/linux-service-management-made-easy-with-systemd/>systemd本</a>を読んで知ったので利用してみます。<p>scriptの中で取得したcpu温度をopentelemetry-collectorに送るために<a href=https://github.com/ymgyt/opentelemetry-cli><code>opentelemetry-cli(otel)</code></a>を作りました。<p>scriptから直接openobserveにexportしないのは以下の点からです。<ul><li>Resource(そのmetricsがどこから来たかの情報)の取得や付与をcollector側で行いたい<li>Retryやbatchもcollectorにまかせたい<li>openobserveの認証情報を1箇所に置いておきたい</ul><h2 id=systemd-timer><a aria-label="Anchor link for: systemd-timer" class=zola-anchor href=#systemd-timer>systemd timer</a></h2><p>まずはscriptを定期実行するためにsystemd timerを設定します。<br> 設定としてはいつどのserviceを呼び出すかを定義しておくとsystemd側でserviceを起動してくれます。<br> 自分がすごいなと思ったのは<code>AccuracySec=1m</code>のように設定しておくと、指定の時刻から1分の範囲内で起動時間をrandomにズラしてくれ、その際の消費電力を最小化するようなことも考慮してくれる点です。<p><code>man systemd.timer</code>の説明<blockquote><p>Within this time window, the expiry time will be placed at a host-specific, randomized, but stable position that is synchronized between all local timer units. This is done in order to optimize power consumption to suppress unnecessary CPU wake-ups.</blockquote><p>nixの設定は以下のように行いました。<br> <code>modules/metrics/cpu-temperature/default.nix</code><pre class="language-nix z-code" data-lang=nix><code class=language-nix data-lang=nix><span class="z-source z-nix"><span class="z-punctuation z-definition z-entity z-function z-2 z-nix">{</span> <span class="z-variable z-parameter z-function z-1 z-nix">pkgs</span><span class="z-keyword z-operator z-nix">,</span> <span class="z-variable z-parameter z-function z-1 z-nix">opentelemetry-cli</span><span class="z-keyword z-operator z-nix">,</span> <span class="z-keyword z-operator z-nix">...</span><span class="z-punctuation z-definition z-entity z-function z-nix">}</span><span class="z-punctuation z-definition z-function z-nix">:</span>
</span><span class="z-source z-nix"><span class="z-punctuation z-definition z-attrset-or-function z-nix">{</span>
</span><span class="z-source z-nix">  <span class="z-entity z-other z-attribute-name z-multipart z-nix">systemd</span>.<span class="z-entity z-other z-attribute-name z-multipart z-nix">timers</span>.<span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>cpu-temp-metrics<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-punctuation z-definition z-attrset-or-function z-nix">{</span>
</span><span class="z-source z-nix">    <span class="z-entity z-other z-attribute-name z-multipart z-nix">wantedBy</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-punctuation z-definition z-list z-nix">[</span> <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>timers.target<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span> <span class="z-punctuation z-definition z-list z-nix">]</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><span class="z-source z-nix">    <span class="z-entity z-other z-attribute-name z-multipart z-nix">timerConfig</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-punctuation z-definition z-attrset-or-function z-nix">{</span>
</span><span class="z-source z-nix">      <span class="z-entity z-other z-attribute-name z-multipart z-nix">Unit</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>cpu-temp-metrics.service<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><span class="z-source z-nix">      <span class="z-entity z-other z-attribute-name z-multipart z-nix">OnCalendar</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>minutely<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><span class="z-source z-nix">      <span class="z-entity z-other z-attribute-name z-multipart z-nix">Persistent</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>false<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><span class="z-source z-nix">      <span class="z-entity z-other z-attribute-name z-multipart z-nix">AccuracySec</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>1m<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><span class="z-source z-nix">     <span class="z-punctuation z-definition z-attrset z-nix">}</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><span class="z-source z-nix">  <span class="z-punctuation z-definition z-attrset z-nix">}</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><span class="z-source z-nix">
</span><span class="z-source z-nix">  <span class="z-entity z-other z-attribute-name z-multipart z-nix">systemd</span>.<span class="z-entity z-other z-attribute-name z-multipart z-nix">services</span>.<span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>cpu-temp-metrics<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span> <span class="z-keyword z-operator z-bind z-nix">=</span> 
</span><span class="z-source z-nix">  <span class="z-keyword z-other z-nix">let</span>
</span><span class="z-source z-nix">    <span class="z-entity z-other z-attribute-name z-multipart z-nix">otel</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-variable z-parameter z-name z-nix">opentelemetry-cli</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">packages</span><span class="z-keyword z-operator z-nix">.</span><span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span><span class="z-markup z-italic"><span class="z-punctuation z-section z-embedded z-begin z-nix">${</span><span class="z-variable z-parameter z-name z-nix">pkgs</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">system</span><span class="z-punctuation z-section z-embedded z-end z-nix">}</span></span><span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">opentelemetry-cli</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><span class="z-source z-nix">  <span class="z-keyword z-other z-nix">in</span>
</span><span class="z-source z-nix">  <span class="z-punctuation z-definition z-attrset-or-function z-nix">{</span>
</span><span class="z-source z-nix">    <span class="z-entity z-other z-attribute-name z-multipart z-nix">path</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-punctuation z-definition z-list z-nix">[</span> 
</span><span class="z-source z-nix">      <span class="z-variable z-parameter z-name z-nix">pkgs</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">gawk</span> 
</span><span class="z-source z-nix">      <span class="z-variable z-parameter z-name z-nix">otel</span>
</span><span class="z-source z-nix">    <span class="z-punctuation z-definition z-list z-nix">]</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><span class="z-source z-nix">    <span class="z-entity z-other z-attribute-name z-multipart z-nix">script</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-constant z-language z-nix">builtins</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">readFile</span> <span class="z-string z-unquoted z-path z-nix">./script.sh</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><span class="z-source z-nix">    <span class="z-entity z-other z-attribute-name z-multipart z-nix">serviceConfig</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-punctuation z-definition z-attrset-or-function z-nix">{</span>
</span><span class="z-source z-nix">      <span class="z-entity z-other z-attribute-name z-multipart z-nix">Type</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>oneshot<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><span class="z-source z-nix">      <span class="z-entity z-other z-attribute-name z-multipart z-nix">DynamicUser</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>true<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><span class="z-source z-nix">      <span class="z-entity z-other z-attribute-name z-multipart z-nix">Nice</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>19<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><span class="z-source z-nix">    <span class="z-punctuation z-definition z-attrset z-nix">}</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><span class="z-source z-nix">  <span class="z-punctuation z-definition z-attrset z-nix">}</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><span class="z-source z-nix"><span class="z-punctuation z-definition z-attrset z-nix">}</span>
</span></code></pre><p><code>systemd.timers."cpu-temp-metrics"</code>がtimerの設定です。<br> <code>man systemd.special</code>によると<blockquote><p>timers.target<br> A special target unit that sets up all timer units (see systemd.timer(5) for details) that shall be active after boot.<br> It is recommended that timer units installed by applications get pulled in via Wants= dependencies from this unit.<br> This is best configured via WantedBy=timers.target in the timer unit's [Install] section. とあるので、<code>wantedBy</code>には<code>timers.target</code>を指定しました。</blockquote><p><code>timerConfig.Unit</code>には起動するserviceを指定します。<br> 省略すると同じunit名のserviceが起動されるようですが明示的に指定しました。<br> <code>timerConfig.OnCalendar</code>が起動する時間です。<code>minutely</code>が具体的にはいつなのかは<code>man systemd.time</code>に定義されています。<br> <code>timerConfig.Persistent</code>はschedule時に電源がoffだった場合に起動時に実行するかの指定です。不要なのでfalse。<br> <code>timerConfig.AccuracySec</code>はさきほど述べた起動時間のwindowです。いつでもよいので、<code>1m</code>にしました。<p>上記のような設定をおこなうとsystemd上は以下のような設定が出力されました。<br> <code>systemctl cat cpu-temp-metrics.timer</code><pre class="language-ini z-code" data-lang=ini><code class=language-ini data-lang=ini><span class="z-source z-genconfig"><span class="z-meta z-comment z-genconfig"><span class="z-comment z-line z-number-sign z-genconfig"># /etc/systemd/system/cpu-temp-metrics.timer
</span></span></span><span class="z-source z-genconfig"><span class="z-storage z-type z-genconfig">[Unit]
</span></span><span class="z-source z-genconfig">
</span><span class="z-source z-genconfig"><span class="z-storage z-type z-genconfig">[Timer]
</span></span><span class="z-source z-genconfig"><span class="z-meta z-param z-genconfig"><span class="z-variable z-parameter z-genconfig">AccuracySec</span><span class="z-keyword z-operator z-genconfig">=</span></span><span class="z-constant z-numeric z-genconfig">1m</span>
</span><span class="z-source z-genconfig"><span class="z-meta z-param z-genconfig"><span class="z-variable z-parameter z-genconfig">OnCalendar</span><span class="z-keyword z-operator z-genconfig">=</span></span>minutely
</span><span class="z-source z-genconfig"><span class="z-meta z-param z-genconfig"><span class="z-variable z-parameter z-genconfig">Persistent</span><span class="z-keyword z-operator z-genconfig">=</span></span><span class="z-constant z-language z-genconfig">false</span>
</span><span class="z-source z-genconfig"><span class="z-meta z-param z-genconfig"><span class="z-variable z-parameter z-genconfig">Unit</span><span class="z-keyword z-operator z-genconfig">=</span></span>cpu<span class="z-keyword z-operator z-genconfig">-</span>temp<span class="z-keyword z-operator z-genconfig">-</span>metrics<span class="z-keyword z-operator z-genconfig">.</span>service
</span></code></pre><h2 id=scriptnozuo-cheng><a aria-label="Anchor link for: scriptnozuo-cheng" class=zola-anchor href=#scriptnozuo-cheng>Scriptの作成</a></h2><p>次に定期実行されるscriptを作成します。<br> scriptをraspiに設定してsystemd timerから起動するために以下のように設定しました。<p><code>modules/metrics/cpu-temperature/default.nix</code><pre class="language-nix z-code" data-lang=nix><code class=language-nix data-lang=nix><span class="z-source z-nix"><span class="z-punctuation z-definition z-entity z-function z-2 z-nix">{</span> <span class="z-variable z-parameter z-function z-1 z-nix">pkgs</span><span class="z-keyword z-operator z-nix">,</span> <span class="z-variable z-parameter z-function z-1 z-nix">opentelemetry-cli</span><span class="z-keyword z-operator z-nix">,</span> <span class="z-keyword z-operator z-nix">...</span><span class="z-punctuation z-definition z-entity z-function z-nix">}</span><span class="z-punctuation z-definition z-function z-nix">:</span>
</span><span class="z-source z-nix"><span class="z-punctuation z-definition z-attrset-or-function z-nix">{</span>
</span><span class="z-source z-nix">  <span class="z-entity z-other z-attribute-name z-multipart z-nix">systemd</span>.<span class="z-entity z-other z-attribute-name z-multipart z-nix">timers</span>.<span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>cpu-temp-metrics<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-punctuation z-definition z-attrset-or-function z-nix">{</span>
</span><span class="z-source z-nix">    <span class="z-comment z-line z-number-sign z-nix"># ...</span>
</span><span class="z-source z-nix">  <span class="z-punctuation z-definition z-attrset z-nix">}</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><span class="z-source z-nix">
</span><span class="z-source z-nix">  <span class="z-entity z-other z-attribute-name z-multipart z-nix">systemd</span>.<span class="z-entity z-other z-attribute-name z-multipart z-nix">services</span>.<span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>cpu-temp-metrics<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span> <span class="z-keyword z-operator z-bind z-nix">=</span> 
</span><span class="z-source z-nix">  <span class="z-keyword z-other z-nix">let</span>
</span><span class="z-source z-nix">    <span class="z-entity z-other z-attribute-name z-multipart z-nix">otel</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-variable z-parameter z-name z-nix">opentelemetry-cli</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">packages</span><span class="z-keyword z-operator z-nix">.</span><span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span><span class="z-markup z-italic"><span class="z-punctuation z-section z-embedded z-begin z-nix">${</span><span class="z-variable z-parameter z-name z-nix">pkgs</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">system</span><span class="z-punctuation z-section z-embedded z-end z-nix">}</span></span><span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">opentelemetry-cli</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><span class="z-source z-nix">  <span class="z-keyword z-other z-nix">in</span>
</span><span class="z-source z-nix">  <span class="z-punctuation z-definition z-attrset-or-function z-nix">{</span>
</span><span class="z-source z-nix">    <span class="z-entity z-other z-attribute-name z-multipart z-nix">path</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-punctuation z-definition z-list z-nix">[</span> 
</span><span class="z-source z-nix">      <span class="z-variable z-parameter z-name z-nix">pkgs</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">gawk</span> 
</span><span class="z-source z-nix">      <span class="z-variable z-parameter z-name z-nix">otel</span>
</span><span class="z-source z-nix">    <span class="z-punctuation z-definition z-list z-nix">]</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><span class="z-source z-nix">    <span class="z-entity z-other z-attribute-name z-multipart z-nix">script</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-constant z-language z-nix">builtins</span><span class="z-keyword z-operator z-nix">.</span><span class="z-variable z-parameter z-name z-nix">readFile</span> <span class="z-string z-unquoted z-path z-nix">./script.sh</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><span class="z-source z-nix">    <span class="z-entity z-other z-attribute-name z-multipart z-nix">serviceConfig</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-punctuation z-definition z-attrset-or-function z-nix">{</span>
</span><span class="z-source z-nix">      <span class="z-entity z-other z-attribute-name z-multipart z-nix">Type</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>oneshot<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><span class="z-source z-nix">      <span class="z-entity z-other z-attribute-name z-multipart z-nix">DynamicUser</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>true<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><span class="z-source z-nix">      <span class="z-entity z-other z-attribute-name z-multipart z-nix">Nice</span> <span class="z-keyword z-operator z-bind z-nix">=</span> <span class="z-string z-quoted z-double z-nix"><span class="z-punctuation z-definition z-string z-double z-start z-nix">"</span>19<span class="z-punctuation z-definition z-string z-double z-end z-nix">"</span></span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><span class="z-source z-nix">    <span class="z-punctuation z-definition z-attrset z-nix">}</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><span class="z-source z-nix">  <span class="z-punctuation z-definition z-attrset z-nix">}</span><span class="z-punctuation z-terminator z-bind z-nix">;</span>
</span><span class="z-source z-nix"><span class="z-punctuation z-definition z-attrset z-nix">}</span>
</span></code></pre><p><code>systemd.services.&LTname>.script</code>に実行したいscriptを指定するとscriptを実行するsystemd serviceを作れます。<br> このserviceはtimerから利用されることを意図しているので、<code>serviceConfig.Type = "oneshot"</code>を指定しました。<br> <code>path</code>を指定すると、scriptの中から指定されたpackageに<code>PATH</code>が通っている状態にできます。<a href=https://github.com/ymgyt/opentelemetry-cli>opentelemetry-cli</a>はmetricsをexportするために利用します。<p>これで必要な依存はnixが管理してくれるscriptが書けるようになりました。<h2 id=cpuwen-du-noqu-de><a aria-label="Anchor link for: cpuwen-du-noqu-de" class=zola-anchor href=#cpuwen-du-noqu-de>CPU温度の取得</a></h2><p>CPU温度を取得してopentelemetry-collectorにexportするscriptについてみていきます。<br> <code>modules/metrics/cpu-temperature/script.sh</code><pre class="language-sh z-code" data-lang=sh><code class=language-sh data-lang=sh><span class="z-source z-shell z-bash"><span class="z-meta z-function z-shell"><span class="z-storage z-type z-function z-shell">function</span> <span class="z-entity z-name z-function z-shell">get_cpu_temperature</span><span class="z-punctuation z-section z-parens z-begin z-shell">(</span><span class="z-punctuation z-section z-parens z-end z-shell">)</span> <span class="z-punctuation z-section z-braces z-begin z-shell">{</span>
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function z-shell">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">cat</span></span><span class="z-meta z-function-call z-arguments z-shell"> /sys/class/thermal/thermal_zone0/temp</span>
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function z-shell"><span class="z-punctuation z-section z-braces z-end z-shell">}</span></span>
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function z-shell"><span class="z-storage z-type z-function z-shell">function</span> <span class="z-entity z-name z-function z-shell">main</span><span class="z-punctuation z-section z-parens z-begin z-shell">(</span><span class="z-punctuation z-section z-parens z-end z-shell">)</span> <span class="z-punctuation z-section z-braces z-begin z-shell">{</span>
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function z-shell"><span class="z-meta z-function-call z-shell">  <span class="z-storage z-modifier z-shell">local</span> <span class="z-variable z-other z-readwrite z-assignment z-shell">raw_temp</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell"><span class="z-meta z-group z-expansion z-command z-parens z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-punctuation z-section z-parens z-begin z-shell">(</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">get_cpu_temperature</span></span><span class="z-punctuation z-section z-parens z-end z-shell">)</span></span></span></span>
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function z-shell"><span class="z-meta z-function-call z-shell">  <span class="z-storage z-modifier z-shell">local</span> <span class="z-variable z-other z-readwrite z-assignment z-shell">temp</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell"><span class="z-meta z-group z-expansion z-command z-parens z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-punctuation z-section z-parens z-begin z-shell">(</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">awk</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>BEGIN { print <span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">raw_temp</span></span> / 1000 }<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span></span><span class="z-punctuation z-section z-parens z-end z-shell">)</span></span></span></span>
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function z-shell">  <span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> export to local collector</span><span class="z-comment z-line z-number-sign z-shell">
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function z-shell">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">otel</span></span><span class="z-meta z-function-call z-arguments z-shell"> export metrics gauge <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function z-shell"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">    --</span>endpoint</span> http://localhost:4317 <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function z-shell"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">    --</span>name</span> system.cpu.temperature <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function z-shell"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">    --</span>description</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>cpu temperature<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span> <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function z-shell"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">    --</span>unit</span> Cel <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function z-shell"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">    --</span>value-as-double</span> <span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-punctuation z-section z-expansion z-parameter z-begin z-shell">{</span></span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-variable z-other z-readwrite z-shell">temp</span></span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-section z-expansion z-parameter z-end z-shell">}</span></span> <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function z-shell"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">    --</span>attributes</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>thermalzone:0<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span> <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function z-shell"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">    --</span>schema-url</span> https://opentelemetry.io/schemas/1.21.0</span>
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function z-shell"><span class="z-punctuation z-section z-braces z-end z-shell">}</span></span>
</span><span class="z-source z-shell z-bash">
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">main</span></span>
</span></code></pre><p>CPU温度の取得自体は<code>/sys/class/thermal/thermal_zone0/temp</code>をcatするだけです。<br> この処理は<a href=https://github.com/ClementTsang/bottom/blob/4174012b8f14cbf92536c103c924b280e7a53b58/src/app/data_harvester/temperature/linux.rs#L316>bottomの処理</a>から盗みました。<br> commentに記載されている<a href=https://www.kernel.org/doc/Documentation/ABI/testing/sysfs-class-thermal>https://www.kernel.org/doc/Documentation/ABI/testing/sysfs-class-thermal</a>では以下のような説明がありました。<blockquote><p>What: /sys/class/thermal/thermal_zoneX/temp<br> Description: Current temperature as reported by thermal zone (sensor).<br> Unit: millidegree Celsius</blockquote><h2 id=metricsnoexport><a aria-label="Anchor link for: metricsnoexport" class=zola-anchor href=#metricsnoexport>Metricsのexport</a></h2><p>CPU温度を取得できたので、localで起動しているopentelemetry-collecotrにmetricsをexportしていきます。<p><a href=https://github.com/ymgyt/opentelemetry-cli>opentelemetry-cli</a>では基本的にexportしたいmetricsを<a href=https://github.com/ymgyt/opentelemetry-cli/blob/2c240ff81d55bf9801dca274d4705ea1d13510cc/src/cli/export.rs#L137>grpc/protobufに詰め替えているだけ</a>です。<br> うれしいのは、otlp関連の処理は<a href=https://github.com/open-telemetry/opentelemetry-rust/tree/main/opentelemetry-proto><code>opentelemetry-proto</code></a>のおかげで、生成されたrustのcodeを利用できるので、protobuf生成関連の処理をまかせることができる点です。なので1 metricsを送るだけなら本当に詰替えだけしか必要なかったです。<p>Exportするmetricsのdata modelに関してはprotobufのcommentの説明がわかりやすかったので引用します。<pre class="language-text z-code" data-lang=text><code class=language-text data-lang=text><span class="z-text z-plain">  Metric
</span><span class="z-text z-plain">//  +------------+
</span><span class="z-text z-plain">//  |name        |
</span><span class="z-text z-plain">//  |description |
</span><span class="z-text z-plain">//  |unit        |     +------------------------------------+
</span><span class="z-text z-plain">//  |data        |---> |Gauge, Sum, Histogram, Summary, ... |
</span><span class="z-text z-plain">//  +------------+     +------------------------------------+
</span><span class="z-text z-plain">//
</span><span class="z-text z-plain">//    Data [One of Gauge, Sum, Histogram, Summary, ...]
</span><span class="z-text z-plain">//  +-----------+
</span><span class="z-text z-plain">//  |...        |  // Metadata about the Data.
</span><span class="z-text z-plain">//  |points     |--+
</span><span class="z-text z-plain">//  +-----------+  |
</span><span class="z-text z-plain">//                 |      +---------------------------+
</span><span class="z-text z-plain">//                 |      |DataPoint 1                |
</span><span class="z-text z-plain">//                 v      |+------+------+   +------+ |
</span><span class="z-text z-plain">//              +-----+   ||label |label |...|label | |
</span><span class="z-text z-plain">//              |  1  |-->||value1|value2|...|valueN| |
</span><span class="z-text z-plain">//              +-----+   |+------+------+   +------+ |
</span><span class="z-text z-plain">//              |  .  |   |+-----+                    |
</span><span class="z-text z-plain">//              |  .  |   ||value|                    |
</span><span class="z-text z-plain">//              |  .  |   |+-----+                    |
</span><span class="z-text z-plain">//              |  .  |   +---------------------------+
</span><span class="z-text z-plain">//              |  .  |                   .
</span><span class="z-text z-plain">//              |  .  |                   .
</span><span class="z-text z-plain">//              |  .  |                   .
</span><span class="z-text z-plain">//              |  .  |   +---------------------------+
</span><span class="z-text z-plain">//              |  .  |   |DataPoint M                |
</span><span class="z-text z-plain">//              +-----+   |+------+------+   +------+ |
</span><span class="z-text z-plain">//              |  M  |-->||label |label |...|label | |
</span><span class="z-text z-plain">//              +-----+   ||value1|value2|...|valueN| |
</span><span class="z-text z-plain">//                        |+------+------+   +------+ |
</span><span class="z-text z-plain">//                        |+-----+                    |
</span><span class="z-text z-plain">//                        ||value|                    |
</span><span class="z-text z-plain">//                        |+-----+                    |
</span><span class="z-text z-plain">//                        +---------------------------+
</span><span class="z-text z-plain">//
</span></code></pre><p><code>Gauge</code>や<code>Sum(Counter)</code>であってもnameやdescriptionは共通です。<br> それぞれのmetricは複数の<code>DataPoint</code>をもち、datapointに値やtimestamp, attribute(例 <code>state=idle</code>)を保持します。<p><a href=https://github.com/open-telemetry/opentelemetry-proto/blob/ac3242b03157295e4ee9e616af53b81517b06559/opentelemetry/proto/metrics/v1/metrics.proto#L89>Metrics data model</a><p>これを以下のようにしてexportしました。<pre class="language-sh z-code" data-lang=sh><code class=language-sh data-lang=sh><span class="z-source z-shell z-bash">  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">otel</span></span><span class="z-meta z-function-call z-arguments z-shell"> export metrics gauge <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">    --</span>endpoint</span> http://localhost:4317 <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">    --</span>name</span> system.cpu.temperature <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">    --</span>description</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>cpu temperature<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span> <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">    --</span>unit</span> Cel <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">    --</span>value-as-double</span> <span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-punctuation z-section z-expansion z-parameter z-begin z-shell">{</span></span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-variable z-other z-readwrite z-shell">temp</span></span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-section z-expansion z-parameter z-end z-shell">}</span></span> <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">    --</span>attributes</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">"</span>thermalzone:0<span class="z-punctuation z-definition z-string z-end z-shell">"</span></span> <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">    --</span>schema-url</span> https://opentelemetry.io/schemas/1.21.0</span>
</span></code></pre><h3 id=collectornireceiverwozhui-jia><a aria-label="Anchor link for: collectornireceiverwozhui-jia" class=zola-anchor href=#collectornireceiverwozhui-jia>Collectorにreceiverを追加</a></h3><p>opentelemetry-collectorにgrpcでmetricsを送れるようにreceiverを追加します。<p><code>modules/opentelemetry-collector/config.yaml</code><pre class="language-yaml z-code" data-lang=yaml><code class=language-yaml data-lang=yaml><span class="z-source z-yaml"><span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">receivers</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
</span><span class="z-source z-yaml">  <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">otlp</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
</span><span class="z-source z-yaml">    <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">protocols</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
</span><span class="z-source z-yaml">      <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">grpc</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
</span><span class="z-source z-yaml">        <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">endpoint</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-string z-quoted z-double z-yaml"><span class="z-punctuation z-definition z-string z-begin z-yaml">"</span>127.0.0.1:4317<span class="z-punctuation z-definition z-string z-end z-yaml">"</span></span>
</span><span class="z-source z-yaml"><span class="z-comment z-line z-number-sign z-yaml"><span class="z-punctuation z-definition z-comment z-line z-number-sign z-yaml">#</span> ...
</span></span><span class="z-source z-yaml"><span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">service</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
</span><span class="z-source z-yaml">  <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">extensions</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> <span class="z-meta z-flow-sequence z-yaml"><span class="z-punctuation z-definition z-sequence z-begin z-yaml">[</span><span class="z-string z-unquoted z-plain z-in z-yaml">memory_ballast</span><span class="z-punctuation z-definition z-sequence z-end z-yaml">]</span></span>
</span><span class="z-source z-yaml">  <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">pipelines</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
</span><span class="z-source z-yaml">    <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">metrics</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
</span><span class="z-source z-yaml">      <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">receivers</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span> 
</span><span class="z-source z-yaml">        <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-unquoted z-plain z-out z-yaml">otlp</span>
</span><span class="z-source z-yaml"><span class="z-comment z-line z-number-sign z-yaml"><span class="z-punctuation z-definition z-comment z-line z-number-sign z-yaml">#</span>...
</span></span></code></pre><h2 id=matome><a aria-label="Anchor link for: matome" class=zola-anchor href=#matome>まとめ</a></h2><figure><div class=fig-images-row><img , alt src=images/ss-cpu-temp-dashboard.png></div><figcaption>取得したmetrics</figcaption></figure><p>ここまでの設定をdeployすることで、CPUの温度をmetricsとして取得することができました。<br> 概ね、30 ~ 35℃になっていました。<br> 1台だけ(<code>rpi4-01</code>)だけ購入した時期が違うためか、若干、他のhostに比べて温度が高いということがわかりました。<p>ここまでお読みいただき、ありがとうございました。</div></article></main><footer class=blog-footer><p>© 2025 <a href=https://blog.ymgyt.io> ymgyt </a> | Made with <a href=https://www.getzola.org rel=noopener target=_blank>Zola</a> | <a href=https://github.com/ymgyt/blog>Repository</a> | <a href=https://blog.ymgyt.io/atom.xml target=_blank title=rss> <svg viewbox="0 0 24 24" class=icon fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx=5 cy=19 r=1></circle></svg> </a></footer></div></div>