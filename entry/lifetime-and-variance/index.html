<!doctype html><html lang=ja><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1" name=viewport><link href=https://blog.ymgyt.io/favicon.ico rel=icon sizes=any><link href=https://blog.ymgyt.io/icon.svg rel=icon type=image/svg+xml><link href=https://blog.ymgyt.io/apple-touch-icon.png rel=apple-touch-icon><link href=https://blog.ymgyt.io/manifest.webmanifest rel=manifest><link href=https://blog.ymgyt.io/style.css rel=stylesheet><link href=https://blog.ymgyt.io/atom.xml rel=alternate title=Atom type=application/atom+xml><script src="https://www.googletagmanager.com/gtag/js?id=G-GTB0KMLN90" async></script><script>window.dataLayer = window.dataLayer || [];
	function gtag() {dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-GTB0KMLN90');</script><title>ğŸ¦€ Rustã®lifetimeã¨variance | Happy developing</title><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><body><div class=world><div class=content-container><header class=blog-header-container><div class=blog-logo><a href=https://blog.ymgyt.io>Happy developing</a></div><div class=blog-nav><nav><ul><li><a href=https://blog.ymgyt.io/entry/>Entries</a><li><a href=https://blog.ymgyt.io/tags/>Tags</a><li><a href=https://blog.ymgyt.io/about/>About</a><li><a href=https://github.com/ymgyt> <img alt=Github class=icon src=https://blog.ymgyt.io/images/icon/github.svg> </a><li><a href="https://twitter.com/YAmaguchixt "> <img alt=Twitter class=icon src=https://blog.ymgyt.io/images/icon/twitter.svg> </a></ul></nav></div></header><main class=blog-main><article><header class=entry-header><h1 class=entry-title>ğŸ¦€ Rustã®lifetimeã¨variance</h1><div class=entry-meta><p class=entry-meta-item>ğŸ—“ 2021-03-21<p class=entry-meta-item>ğŸ· <span class=tag><a href=https://blog.ymgyt.io/tags/rust/>rust</a></span></div></header><aside class=entry-toc><nav><ul class=entry-toc-toplevel-list><li><a href=https://blog.ymgyt.io/entry/lifetime-and-variance/#changelog>CHANGELOG</a><li><a href=https://blog.ymgyt.io/entry/lifetime-and-variance/#subtypenoyi-wei>Subtypeã®æ„å‘³</a><li><a href=https://blog.ymgyt.io/entry/lifetime-and-variance/#lifetimetosubtype>Lifetimeã¨subtype</a><li><a href=https://blog.ymgyt.io/entry/lifetime-and-variance/#variance>Variance</a> <ul><li><a href=https://blog.ymgyt.io/entry/lifetime-and-variance/#covariant>covariant</a><li><a href=https://blog.ymgyt.io/entry/lifetime-and-variance/#contravariant>contravariant</a><li><a href=https://blog.ymgyt.io/entry/lifetime-and-variance/#invariant>invariant</a></ul><li><a href=https://blog.ymgyt.io/entry/lifetime-and-variance/#cell-t>Cell&lt;T></a><li><a href=https://blog.ymgyt.io/entry/lifetime-and-variance/#ju-ti-li>å…·ä½“ä¾‹</a> <ul><li><a href=https://blog.ymgyt.io/entry/lifetime-and-variance/#strtok>strtok</a><li><a href=https://blog.ymgyt.io/entry/lifetime-and-variance/#evil-feeder>evil_feeder</a><li><a href=https://blog.ymgyt.io/entry/lifetime-and-variance/#messagecollector>MessageCollector</a></ul><li><a href=https://blog.ymgyt.io/entry/lifetime-and-variance/#matome>ã¾ã¨ã‚</a></ul></nav></aside><div class=entry-content><p><a href=https://blog.ymgyt.io/entry/lifetime-and-variance/nomicon>nomicon</a> ã‚’èª­ã‚“ã§ã„ã¦<a href=https://doc.rust-lang.org/nomicon/subtyping.html rel=external>Subtyping and Variance</a> ã®è©±ãŒã§ã¦ããŸã¨ãã«ã©ã†ã—ã¦ç¶™æ‰¿ã®æ¦‚å¿µãŒãªã„Rustã«varianceã®è©±ãŒã§ã¦ãã‚‹ã®ã‹ãªã¨æ€ã£ã¦ã„ã¾ã—ãŸã€‚<br> ãã®å¾Œã€Rustã®å‹•ç”»ã‚’youtubeã«æŠ•ç¨¿ã•ã‚Œã¦ã„ã‚‹<a href=https://twitter.com/jonhoo rel=external>Jon Gjengsetã•ã‚“</a> ã®<a href="https://www.youtube.com/watch?v=iVYWDIW71jk&ab_channel=JonGjengset" rel=external>Crust of Rust: Subtyping and Variance</a> ã‚’è¦‹ã¦è‡ªåˆ†ãªã‚Šã«ã™ã“ã—ç†è§£ãŒé€²ã‚“ã ã®ã§ãƒ–ãƒ­ã‚°ã«æ›¸ãã“ã¨ã«ã—ã¾ã—ãŸã€‚<p>å…·ä½“çš„ã«ã¯nomiconã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹varianceã®ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã†ã¡ä»¥ä¸‹ã®ç†è§£ã‚’è©¦ã¿ã¾ã™ã€‚<table><thead><tr><th><th><code>'a</code><th><code>T</code><th><code>U</code><tbody><tr><td><code>&'a T</code><td>covariant<td>covariant<td><tr><td><code>&'a mut T</code><td>covariant<td>invariant<td><tr><td><code>fn(T) -> U</code><td><td>contravariant<td>covariant<tr><td><code>Cell&lt;T></code><td><td>invariant<td></table><h2 id=changelog><a aria-label="Anchor link for: changelog" class=zola-anchor href=#changelog>CHANGELOG</a></h2><ul><li>2023-02-08 fix: update broken link to https://github.com/sunshowers-code/lifetime-variance</ul><h2 id=subtypenoyi-wei><a aria-label="Anchor link for: subtypenoyi-wei" class=zola-anchor href=#subtypenoyi-wei>Subtypeã®æ„å‘³</a></h2><p>å½¢å¼çš„ã«ã¯ï¼’ã¤ã®å‹ãŒã‚ã‚‹ã¨ãã«ã‚ã‚‹ã‹ãªã„ã‹ã®é–¢ä¿‚ã€‚<br> ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ¢ãƒ‡ãƒ«ã¨ã—ã¦ã¯ã€and moreã¨ã‹ã€<a href="https://youtu.be/iVYWDIW71jk?t=1627" rel=external>å°‘ãªãã¨ã‚‚åŒç¨‹åº¦ã«ã¯å½¹ç«‹ã¤(at least as useful as)ã¨èª¬æ˜</a> ã•ã‚Œã¦ã„ã¾ã™ã€‚<br> Cat is an Animal and more ã¿ãŸã„ãªã€‚<h2 id=lifetimetosubtype><a aria-label="Anchor link for: lifetimetosubtype" class=zola-anchor href=#lifetimetosubtype>Lifetimeã¨subtype</a></h2><p><a href=https://doc.rust-lang.org/nomicon/index.html rel=external>nomicon</a> ã§ã¯fairly arbitary constructã¨å‰ç½®ãã‚’ãŠãã¤ã¤ã‚‚lifetimeã‚’å‹ã¨ã—ã¦ã¨ã‚‰ãˆã‚‹ã“ã¨ãŒã§ãã‚‹ã¨æ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚<br> ã©ã†ã„ã†ã“ã¨ã‹ã¨ã„ã†ã¨ã€lifetimeã¯ã‚³ãƒ¼ãƒ‰ã®é ˜åŸŸ(regions of code)ã®ã“ã¨ã§ã€ã‚³ãƒ¼ãƒ‰ã®é ˜åŸŸã¯å«ã‚“ã§ã‚‹ã‹å«ã‚“ã§ãªã„ã‹ã®é–¢ä¿‚ã‚’è€ƒãˆã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚ã‚ã‚‹ã‚³ãƒ¼ãƒ‰é ˜åŸŸ(<code>'big</code>)ãŒåˆ¥ã®ã‚³ãƒ¼ãƒ‰é ˜åŸŸ(<code>'small</code>)ã‚’å«ã‚“ã§ã„ã‚‹ã¨ã<br> <code>'big</code>ã¯<code>'small</code>ã®subtypeã¨ã„ãˆã¾ã™ã€‚ subtypeã®é–¢ä¿‚ã‚’and moreã¨è€ƒãˆã‚‹ã¨ã€<code>'big</code> is <code>'small</code> and moreã¨ã„ãˆã‚‹ã®ã§ç­‹ãŒã¨ãŠã£ã¦ã„ã¾ã™ã­ã€‚<p>ã“ã‚“ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>{ </span></span>
<span class=giallo-l><span>  let x: 'big = ...</span></span>
<span class=giallo-l><span>  {</span></span>
<span class=giallo-l><span>    let y: 'small = ...</span></span>
<span class=giallo-l><span>    // ...</span></span>
<span class=giallo-l><span>  }</span></span>
<span class=giallo-l><span>}</span></span></code></pre><p><code>'static</code>ã¯ä»–ã®lifetimeã‚’outlivesã™ã‚‹ã®ã§ã€å…¨ã¦ã®lifetimeã®subtypeã¨è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚<p>ãŸã ã—ã€lifetimeãã‚Œè‡ªä½“ã§å˜ç‹¬ã®å‹ã«ãªã‚‹ã“ã¨ã¯ãªãã€ã‹ãªã‚‰ãš <code>&'a u32</code>ã‚„<code>iterMut&lt;'a, u32></code>ã®ã‚ˆã†ã«ã‚ã‚‹å‹ã®ä¸€éƒ¨ã¨ã—ã¦ç¾ã‚Œã‚‹ã€‚ãã“ã§ã€subtypeã‚’çµ„ã¿åˆã‚ã›ãŸã¨ãã«ã©ã†ãªã‚‹ã®ã‹ã®è©±ã«ãªã‚ŠvarianceãŒã§ã¦ãã¾ã™ã€‚<h2 id=variance><a aria-label="Anchor link for: variance" class=zola-anchor href=#variance>Variance</a></h2><p>varianceã¨ã¯type constructorãŒã‚‚ã¤æ€§è³ªã€‚Rustã§ã„ã†type constructorã¨ã¯å‹<code>T</code>ã‚’ã†ã‘ã¨ã£ã¦<code>Vec&lt;T></code>ã‚’è¿”ã™<code>Vec</code>ã ã£ãŸã‚Šã€<code>&</code>ã‚„<code>&mut</code>ã®ã“ã¨ã€‚ä»¥å¾Œã¯<a href=https://doc.rust-lang.org/nomicon/index.html rel=external>nomicon</a>ã®ä¾‹ã«ãªã‚‰ã£ã¦<code>F&lt;T></code>ã¨æ›¸ãã¾ã™ã€‚<br> å‹<code>Sub</code>ãŒå‹<code>Super</code>ã®subtypeã¨ã—ã¦ã€varianceã¯covariant, contravariant, invariantã®3ç¨®é¡ã«åˆ†é¡ã§ãã¾ã™ã€‚<br> ä»¥ä¸‹ãã‚Œãã‚Œã«ã¤ã„ã¦è¦‹ã¦ã„ãã¾ã™ã€‚<h3 id=covariant><a aria-label="Anchor link for: covariant" class=zola-anchor href=#covariant>covariant</a></h3><p><code>F&lt;Sub></code>ãŒ<code>F&lt;Super></code>ã®subtypeãªã‚‰covariantã€‚<br> <code>s: &'a str</code>å‹ã«<code>&'static str</code>ã‚’æ¸¡ã›ã‚‹ã®ã¯ã€<code>&</code>ãŒcovariantã ã‹ã‚‰ã¨ã„ãˆã¾ã™ã€‚<br> (<code>'static</code> subtype <code>'a</code>) -> (<code>&'static str</code> subtype <code>&'a str</code>)<br> å¼•æ•°ã®å‹ã®subtypeã®é–¢ä¿‚ãŒæˆ»ã‚Šå€¤ã®å‹ã®é–¢ä¿‚ã«ãã®ã¾ã¾åæ˜ ã•ã‚Œã‚‹ã®ã§ç´ ç›´ã§ç›´æ„Ÿçš„ãªé–¢ä¿‚ã ã¨æ€ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>let</span><span> s</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> String</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>let</span><span> x</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>static str</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>hello world</span><span style=color:#eceff4>";</span></span>
<span class=giallo-l><span style=color:#81a1c1>let mut</span><span> y</span><span style=color:#616e88>/* :&'y str */</span><span style=color:#81a1c1> = &*</span><span>s</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>let</span><span> y</span><span style=color:#81a1c1> =</span><span> x</span><span style=color:#eceff4>;</span></span></code></pre><h3 id=contravariant><a aria-label="Anchor link for: contravariant" class=zola-anchor href=#contravariant>contravariant</a></h3><p><code>F&lt;Super></code>ãŒ<code>F&lt;Sub></code>ã®subtypeãªã‚‰contravariantã€‚<br> ã“ã‚Œã ã‘ã¿ã¦ã‚‚ã‚ˆãã‚ã‹ã‚‰ãªã„ã®ã§å…·ä½“ä¾‹ã‚’ã¿ã¦ã„ãã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>pub fn</span><span style=color:#88c0d0> contravariant</span><span style=color:#eceff4>(</span><span>f</span><span style=color:#81a1c1>: fn</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>static str</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#eceff4> ()) {</span></span>
<span class=giallo-l><span style=color:#88c0d0>    f</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>hello</span><span style=color:#eceff4>")</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã“ã®é–¢æ•°ã«<code>fn(&'a str) -> ()</code>ãªé–¢æ•°ã‚’æ¸¡ã›ã‚‹ã¨ã„ã†ã“ã¨ã‚’ã„ã£ã¦ã„ã¾ã™ã€‚ <code>'a</code>ã¯<code>'static</code>ã®super typeãªã®ã§<code>Fn(&'a str) -> ()</code>ã¯<code>Fn(&'static str)</code>ã®subtypeã«ãªã‚Šã¾ã™ã€‚<br> æ„å‘³ã¨ã—ã¦ã¯ä¸Šè¨˜ã®<code>contravariant</code>é–¢æ•°ã¯æ¸¡ã•ã‚ŒãŸé–¢æ•°ã«<code>'static</code> lifetimeã‚’ã‚‚ã¤å¤‰æ•°ã‚’æ¸¡ã—ã¦ã‚ˆã³ã ã—ã¦ãã‚Œã‚‹ã¨èª­ã‚ã¾ã™ã€‚ãã®é–¢æ•°ã«å¿…ãšã—ã‚‚æ°¸ç¶šã™ã‚‹å¿…è¦ã¯ãªãæ¸¡ã—ãŸé–¢æ•°ã®å®Ÿè¡Œä¸­ã ã‘æœ‰åŠ¹ãªæ–‡å­—åˆ—ã§ååˆ†ãªclosureã‚’æ¸¡ã›ã‚‹ã¨ã„ã†æ„Ÿã˜ã§ã—ã‚‡ã†ã‹ã€‚å¼•æ•°ã«å¯¾ã™ã‚‹åˆ¶ç´„ã‚’å¼±ãã—ãŸé–¢æ•°ã¯ã¤ã‚ˆã„åˆ¶ç´„ã‚’è¦æ±‚ã™ã‚‹é–¢æ•°ã®subtypeã«ãªã‚‹ã¨è€ƒãˆã‚Œã°è‡ªç„¶ã¨ã„ãˆã‚‹ã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚<h3 id=invariant><a aria-label="Anchor link for: invariant" class=zola-anchor href=#invariant>invariant</a></h3><p>ã‚‚ã†ä¸€åº¦varianceè¡¨ã‚’ã¿ã¦ã¿ã‚‹ã¨invariantã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚<table><thead><tr><th><th><code>'a</code><th><code>T</code><tbody><tr><td><code>&'a mut T</code><td>covariant<td>invariant</table><p>ã¾ãš<code>T</code>ã«ã¤ã„ã¦invariantã‹ã‚‰ã¿ã¦ã„ãã¾ã™ã€‚<code>T</code>ã«ã¤ã„ã¦invariantãªãŠã‹ã’ã§ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã®compileãŒã¨ãŠã‚‰ãªã„ã‚ˆã†ã«ãªã£ã¦ãã‚Œã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>pub fn</span><span style=color:#88c0d0> invariant_1</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>>(</span><span>s</span><span style=color:#81a1c1>: &mut &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>a str</span><span style=color:#eceff4>,</span><span> x</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>a str</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    *</span><span>s</span><span style=color:#81a1c1> =</span><span> x</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> invariant_1_no_compile</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> x</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>static str</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>hello</span><span style=color:#eceff4>";</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> z</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> String</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    // signature:  &mut &'a      str, &'a str</span></span>
<span class=giallo-l><span style=color:#616e88>    // providing:  &mut &'static str, &'a str</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>    invariant_1</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut</span><span> x</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> &*</span><span>z</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>    drop</span><span style=color:#eceff4>(</span><span>z</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    println!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{}</span><span style=color:#eceff4>",</span><span> x</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã‚‚ã—compileãŒé€šã£ã¦ã—ã¾ã†ã¨ã€<code>'static</code>ãªå‚ç…§ã®ã¯ãšãŒdropã•ã‚ŒãŸé ˜åŸŸã‚’å‚ç…§ã§ãã¦ã—ã¾ã†ã“ã¨ã«ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚<br> compile errorã«ãªã£ã¦ãã‚Œã‚‹ç†ç”±ã¯ã€<code>&'a mut T</code>ãŒTã«ã¤ã„ã¦invariantãªãŠã‹ã’ã§<br> <code>&'a mut &'static str</code>ãŒ<code>&'a mut &'a str</code>ã®subtypeã«ãªã‚‰ãªã„ã‹ã‚‰ã§ã™ã€‚<code>&'static str</code>ã¯<code>&</code>ãŒcovariantãªã®ã§<code>&'a str</code>ã®subtypeã§ã™ãŒã€ãã®é–¢ä¿‚ã¯<code>& mut</code>ã§å¤‰æ›ã•ã‚Œã‚‹ã¨ç¶­æŒã•ã‚Œã¾ã›ã‚“ã€‚<p>æ¬¡ã«<code>'a</code>ã«ã¤ã„ã¦ã¯covariantã«ã¤ã„ã¦ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> test_mut_ref_covariant</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> y</span><span style=color:#81a1c1> = true</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> z</span><span style=color:#616e88> /*&'y bool */</span><span style=color:#81a1c1> = &mut</span><span> y</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> x</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Box</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>true</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> x</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>static</span><span style=color:#81a1c1> mut</span><span style=color:#8fbcbb> bool</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Box</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>leak</span><span style=color:#eceff4>(</span><span>x</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>    z</span><span style=color:#81a1c1> =</span><span> x</span><span style=color:#eceff4>;</span><span style=color:#616e88> // &'a mut bool &lt;- &'static mut bool</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>Box::leak()</code>ã§heapã«ç¢ºä¿ã—ãŸå€¤ã®<code>&'static mut</code>å‚ç…§ã‚’ä½œã‚Œã¾ã™ã€‚<br> <code>&'a mut T</code>ãŒ<code>'a</code>ã«ã¤ã„ã¦ã¯covariantãªãŠã‹ã’ã§ã€lifetimeãŒã‚ˆã‚Šé•·ã„å ´åˆã«ã¯è‡ªç„¶ãªä»£å…¥ãŒè¨±å¯ã•ã‚Œã¾ã™ã­ã€‚<h2 id=cell-t><a aria-label="Anchor link for: cell-t" class=zola-anchor href=#cell-t><code>Cell&lt;T></code></a></h2><p>Cellã«ã¤ã„ã¦ã¯<a href=https://github.com/sunshowers-code/lifetime-variance rel=external>lifetime-variance-example</a>ã«éå¸¸ã«ã‚ã‹ã‚Šã‚„ã™ã„ä¾‹ãŒã®ã£ã¦ã„ã¾ã™ã€‚ <code>Cell&lt;T></code>ã¯Tã«ã¤ã„ã¦invariantãªã®ã§<code>Cell&lt;&'static str></code>ã¯<code>Cell&lt;&'a str></code>ã®subtypeã«ãªã‚Œã¾ã›ã‚“ã€‚ãªã®ã§ä»¥ä¸‹ã®é–¢æ•°ã¯compileã§ãã¾ã›ã‚“ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> cell_shortener</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>, '</span><span style=color:#8fbcbb>b</span><span style=color:#eceff4>>(</span><span>s</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>a Cell</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>&</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>static str</span><span style=color:#eceff4>>)</span><span style=color:#81a1c1> -> &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>a Cell</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>&</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>b str</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span>    s</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ãªã‚“ã¨ãªãã§ã™ãŒ<code>Cell&lt;&'a str></code>å‹ã«<code>Cell&lt;&'static str></code>ã‚’assignã§ãã¦ã‚‚å•é¡Œãªã„ã‚ˆã†ã«æ€ãˆã¾ã™ã€‚ã—ã‹ã—ä»¥ä¸‹ã®ä¾‹ã‹ã‚‰ãã‚Œã¯èªã‚ã‚‰ã‚Œãªã„ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> cell_counterexample</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> foo</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Cell</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>&</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>static str</span><span style=color:#eceff4>></span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Cell</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>foo</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> owned_string</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>non_static</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_owned</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span>  </span></span>
<span class=giallo-l><span style=color:#616e88>    // If we pretend that cell_shortener works</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> shorter_foo</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> cell_shortener</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>foo</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span>  </span></span>
<span class=giallo-l><span style=color:#616e88>    // then shorter_foo and foo would be aliases of each other, which would mean that you could use</span></span>
<span class=giallo-l><span style=color:#616e88>    // shorter_foo to replace foo's Cell with a non-static string:</span></span>
<span class=giallo-l><span>    shorter_foo</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>replace</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>owned_string</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span>  </span></span>
<span class=giallo-l><span style=color:#616e88>    // now foo, which is an alias of shorter_foo, has a non-static string in it! Whoops.</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>https://github.com/sunshowers/lifetime-variance-example/blob/ac8fc6cbee7bfd9b70a8c58973a891ed8a5482a7/src/lib.rs#L62<p>ãŸã—ã‹ã«<code>Cell&lt;T></code>ã‚’covariantã«ã—ã¦ã—ã¾ã†ã¨å±é™ºãªæ“ä½œãŒå¯èƒ½ã«ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚<br> çµå±€ã¯interior mutabilityã‚’æä¾›ã—ã¦ã„ã‚‹å‹ã¯å®Ÿè³ªçš„ã«ã¯<code>&mut</code>ã¨åŒã˜ã“ã¨ãŒã§ãã‚‹ã“ã¨ã®å¸°çµã¨ã„ãˆã‚‹ã‚“ã§ã—ã‚‡ã†ã‹ã€‚<h2 id=ju-ti-li><a aria-label="Anchor link for: ju-ti-li" class=zola-anchor href=#ju-ti-li>å…·ä½“ä¾‹</a></h2><h3 id=strtok><a aria-label="Anchor link for: strtok" class=zola-anchor href=#strtok><code>strtok</code></a></h3><p>ã“ã“ã§ã¯<a href="https://www.youtube.com/watch?v=iVYWDIW71jk&ab_channel=JonGjengset" rel=external>Crust of Rust: subtyping and Variance</a>ã§ã¨ã‚Šã‚ã’ã‚‰ã‚Œã¦ã„ãŸä¾‹ã‚’ã¿ã¦ã„ãã¾ã™ã€‚ä»¥ä¸‹ã®ã‚ˆã†ãªé–¢æ•°ã‚’è€ƒãˆã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>pub fn</span><span style=color:#88c0d0> strtok</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>>(</span><span>s</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>a</span><span style=color:#81a1c1> mut &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>a str</span><span style=color:#eceff4>,</span><span> delimiter</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> char</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>a str</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    if let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>i</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> s</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>find</span><span style=color:#eceff4>(</span><span>delimiter</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> prefix</span><span style=color:#81a1c1> = &</span><span>s</span><span style=color:#eceff4>[</span><span style=color:#81a1c1>..</span><span>i</span><span style=color:#eceff4>];</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> suffix</span><span style=color:#81a1c1> = &</span><span>s</span><span style=color:#eceff4>[(</span><span>i</span><span style=color:#81a1c1> +</span><span> delimiter</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>len_utf8</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>..</span><span style=color:#eceff4>];</span></span>
<span class=giallo-l><span style=color:#81a1c1>        *</span><span>s</span><span style=color:#81a1c1> =</span><span> suffix</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span>        prefix</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> prefix</span><span style=color:#81a1c1> = *</span><span>s</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        *</span><span>s</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "";</span></span>
<span class=giallo-l><span>        prefix</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>c++ã®<a href=http://www.cplusplus.com/reference/cstring/strtok/ rel=external>strtok</a> ã¨ã„ã†é–¢æ•°ã‚‰ã—ã„ã§ã™ã€‚å‡¦ç†å†…å®¹è‡ªä½“ã¯é‡è¦ã§ã¯ãªã„ã®ã§ã™ãŒã€å¼•æ•°ã®æ–‡å­—åˆ—sã‚’delimiterã§splitã—ã¦æœ€åˆã®elementã‚’è¿”ã—ã€sã‚’æ¬¡ã®elementã®å…ˆé ­ã«ã‚»ãƒƒãƒˆã—ã¾ã™ã€‚é€£ç¶šã—ã¦ã‚ˆã¶ã“ã¨ã§ã€Rustã§ã„ã†ã¨ã“ã‚ã®splitã—ã¦Iteratorã‚’å–å¾—ã™ã‚‹æ„Ÿã˜ã®é–¢æ•°ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[test]</span></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> test_strtok</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> x</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>static str</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>hello world</span><span style=color:#eceff4>";</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>    strtok</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut</span><span> x</span><span style=color:#eceff4>, ' ');</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>strtok</code>ã‚’ä¸Šè¨˜ã®ã‚ˆã†ã«å‘¼ã³å‡ºã™ã¨compile errorã«ãªã‚Šã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>error[E0597]: `x` does not live long enough</span></span>
<span class=giallo-l><span>   --> src/main.rs:115:16</span></span>
<span class=giallo-l><span>    |</span></span>
<span class=giallo-l><span>113 |         let mut x: &'static str = "hello world";</span></span>
<span class=giallo-l><span>    |                    ------------ type annotation requires that `x` is borrowed for `'static`</span></span>
<span class=giallo-l><span>114 |</span></span>
<span class=giallo-l><span>115 |         strtok(&mut x, ' ');</span></span>
<span class=giallo-l><span>    |                ^^^^^^ borrowed value does not live long enough</span></span>
<span class=giallo-l><span>116 |     }</span></span></code></pre><p>ãªã«ãŒãŠãã¦ã„ã‚‹ã‹ã¨ã„ã†ã¨<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>// 'aã¯genericã§ 'xã¯å…·ä½“çš„ãªlifetimeã¨æ€ã£ã¦ãã ã•ã„ã€‚</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>// signature: &lt;'a> &'a mut  &'a      str</span></span>
<span class=giallo-l><span>// providing:      &'x mut  &'static str</span></span>
<span class=giallo-l><span>               </span></span>
<span class=giallo-l><span>// signature:      &'static &'static str</span></span>
<span class=giallo-l><span>// providing:      &'x mut  &'static str</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>// signature:      &'static &'static str</span></span>
<span class=giallo-l><span>// providing:      &'static mut  &'static str</span></span></code></pre><p>å¤‰æ•°<code>x</code>ã®<code>'static</code> lifetiemã¨<code>strtok</code>ã®lifetimeã®å‹ã‹ã‚‰lifetime generic <code>'a</code>ãŒ<code>'static</code>ã¨è§£é‡ˆã•ã‚Œã€æœ€çµ‚çš„ã«<br> <code>strtok(& /* 'static */ mut x)</code>ã«ãªã£ã¦ã—ã¾ã†ãŒã€xã¯stackå¤‰æ•°ãªã®ã§staticã§ã¯ãªã "does not live long enough"ã«ãªã£ã¦ã—ã¾ã†ã€‚(ã¨ã„ã†ç†è§£ã§ã™)<p>ãã“ã§ã©ã†ã™ã‚Œã°ã‚ˆã„ã‹ã¨ã„ã†ã¨ã€å•é¡Œã¯<code>strtok</code>ã®lifetime genericãŒã²ã¨ã¤ã—ã‹ãªã„ãŸã‚ã«<code>&mut x</code>è‡ªä½“ã®lifetimeã‚‚ã²ãã¥ã‚‰ã‚Œã¦<code>'sattic</code>ã«ãªã£ã¦ã—ã¾ã†ã“ã¨ã ã£ãŸã®ã§ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>pub fn</span><span style=color:#88c0d0> strtok_2</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>, '</span><span style=color:#8fbcbb>b</span><span style=color:#eceff4>>(</span><span>s</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>a</span><span style=color:#81a1c1> mut &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>b str</span><span style=color:#eceff4>,</span><span> delimiter</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> char</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>b str</span><span style=color:#eceff4> {</span><span style=color:#616e88>/* */</span><span style=color:#eceff4>}</span></span></code></pre><p>ã“ã†ã™ã‚‹ã¨ã“ã§compileãŒã¨ãŠã‚‹ã‚ˆã†ã«ãªã‚Šã¯ã‚Œã¦ãƒ†ã‚¹ãƒˆã‚‚æ›¸ã‘ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>// signature: &lt;'a, 'b> &'a mut &'b      str</span></span>
<span class=giallo-l><span>// providing:          &'x mut &'static str</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>// signature:          &'x mut &'static str</span></span>
<span class=giallo-l><span>// providing:          &'x mut &'static str</span></span></code></pre><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[test]</span></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> test_strtok</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> x</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>static str</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>hello world</span><span style=color:#eceff4>";</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> hello</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> strtok_2</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut</span><span> x</span><span style=color:#eceff4>, ' ');</span></span>
<span class=giallo-l><span>    </span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    assert_eq!</span><span style=color:#eceff4>(</span><span>hello</span><span style=color:#eceff4>, "</span><span style=color:#a3be8c>hello</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    assert_eq!</span><span style=color:#eceff4>(</span><span>x</span><span style=color:#eceff4>, "</span><span style=color:#a3be8c>world</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã¡ãªã¿ã«ã“ã†ã§ã‚‚OK<br> <code>pub fn strtok&lt;'s>(s: &'_ mut &'s str, delimiter: char) -> &'s str {/* */}</code><h3 id=evil-feeder><a aria-label="Anchor link for: evil-feeder" class=zola-anchor href=#evil-feeder><code>evil_feeder</code></a></h3><p>æ¬¡ã«nomiconã®ä¾‹ã‚’ã¿ã¦ã¿ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> evil_feeder</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>>(</span><span>input</span><span style=color:#81a1c1>: &mut</span><span style=color:#8fbcbb> T</span><span style=color:#eceff4>,</span><span> val</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> T</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    *</span><span>input</span><span style=color:#81a1c1> =</span><span> val</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> mr_snuggles</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>static str</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>meow! :3</span><span style=color:#eceff4>";</span><span style=color:#616e88>  // mr. snuggles forever!!</span></span>
<span class=giallo-l><span style=color:#eceff4>    {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> spike</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> String</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>bark! >:V</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> spike_str</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>str</span><span style=color:#81a1c1> = &</span><span>spike</span><span style=color:#eceff4>;</span><span style=color:#616e88>                // Only lives for the block</span></span>
<span class=giallo-l><span style=color:#88c0d0>        evil_feeder</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut</span><span> mr_snuggles</span><span style=color:#eceff4>,</span><span> spike_str</span><span style=color:#eceff4>);</span><span style=color:#616e88>    // EVIL!</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    println!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{}</span><span style=color:#eceff4>",</span><span> mr_snuggles</span><span style=color:#eceff4>);</span><span style=color:#616e88>                     // Use after free?</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã“ã®ä¾‹ã‚‚ä»¥ä¸‹ã®ã‚ˆã†ã«è§£é‡ˆã•ã‚Œã¦compile errorã«ãªã‚Šã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>// signature: &'a mut T           , T</span></span>
<span class=giallo-l><span>// providing: &'a mut &'static str, &'spike str</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>// signature: &'a mut &'static str, &'static str</span></span>
<span class=giallo-l><span>// providing: &'a mut &'static str, &'spike str</span></span></code></pre><p>ã¨ãªã£ã¦ã€<code>&'static str</code>ã«<code>&'spike str</code>ã¯æ¸¡ã›ãªããªã‚Šã¾ã™ã€‚<h3 id=messagecollector><a aria-label="Anchor link for: messagecollector" class=zola-anchor href=#messagecollector><code>MessageCollector</code></a></h3><p>æœ€å¾Œã«<a href=https://github.com/sunshowers-code/lifetime-variance rel=external>lifetime-variance-example</a>ã«ã®ã£ã¦ã„ãŸå®Ÿéš›ã«é­é‡ã—ãã†ãª<code>&mut</code>ã®varianceãŒå½±éŸ¿ã™ã‚‹ä¾‹ã‚’ã¨ã‚Šã‚ã’ã¾ã™ã€‚ãƒªãƒ³ã‚¯å…ˆã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã‚ˆã‚Šè©³ç´°ã«step by stepã®è§£èª¬ãŒã‚ã‚Šã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>collections</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>HashSet</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>fmt</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> Message</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>msg</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span>    message</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>msg str</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> MessageDisplayer</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span>    list</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>a Vec</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Message</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>></span><span> fmt</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Display</span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> MessageDisplayer</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> fmt</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> f</span><span style=color:#81a1c1>: &mut</span><span> fmt</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Formatter</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span> fmt</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        for</span><span> message</span><span style=color:#81a1c1> in self.</span><span>list </span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>            write!</span><span style=color:#eceff4>(</span><span>f</span><span style=color:#eceff4>, "</span><span style=color:#ebcb8b>{}\n</span><span style=color:#eceff4>",</span><span> message</span><span style=color:#81a1c1>.</span><span>message</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Ok</span><span style=color:#eceff4>(())</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> MessageCollector</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span>    list</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>a</span><span style=color:#81a1c1> mut</span><span style=color:#8fbcbb> Vec</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Message</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>>></span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> MessageCollector</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> add_message</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> message</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Message</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>list</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>push</span><span style=color:#eceff4>(</span><span>message</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> collect_and_display</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>msg</span><span style=color:#eceff4>>(</span><span>message_pool</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>msg HashSet</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> list</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0;font-weight:700> vec!</span><span style=color:#eceff4>[];</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> collector</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> MessageCollector</span><span style=color:#eceff4> {</span><span> list</span><span style=color:#81a1c1>: &mut</span><span> list</span><span style=color:#eceff4> };</span></span>
<span class=giallo-l><span style=color:#81a1c1>    for</span><span> message</span><span style=color:#81a1c1> in</span><span> message_pool</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>        collector</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>add_message</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Message</span><span style=color:#eceff4> {</span><span> message</span><span style=color:#eceff4> });</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> displayer</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> MessageDisplayer</span><span style=color:#eceff4> {</span><span> list</span><span style=color:#81a1c1>: &</span><span>list</span><span style=color:#eceff4> };</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    println!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{}</span><span style=color:#eceff4>",</span><span> displayer</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>error[E0502]: cannot borrow `list` as immutable because it is also borrowed as mutable</span></span>
<span class=giallo-l><span>  --> src/main.rs:39:46</span></span>
<span class=giallo-l><span>   |</span></span>
<span class=giallo-l><span>34 |     let mut collector = MessageCollector { list: &mut list };</span></span>
<span class=giallo-l><span>   |                                                  --------- mutable borrow occurs here</span></span>
<span class=giallo-l><span>...</span></span>
<span class=giallo-l><span>39 |     let displayer = MessageDisplayer { list: &list };</span></span>
<span class=giallo-l><span>   |                                              ^^^^^</span></span>
<span class=giallo-l><span>   |                                              |</span></span>
<span class=giallo-l><span>   |                                              immutable borrow occurs here</span></span>
<span class=giallo-l><span>   |                                              mutable borrow later used here</span></span></code></pre><p>å•é¡Œã¯<code>MessageCollector</code>ã®å®šç¾©ã«ã‚ã‚Šã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>struct MessageCollector&lt;'a> {</span></span>
<span class=giallo-l><span>    list: &'a mut Vec&lt;Message&lt;'a>></span></span>
<span class=giallo-l><span>}</span></span></code></pre><p><code> collector.add_message(Message { message });</code> ã“ã“ã®messageã®lifetimeãŒé–¢æ•°å…¨ä½“ã«åŠã¶ã®ã§ã²ãã¥ã‚‰ã‚Œã¦<code>MessageCollector</code>ã®listã«å¯¾ã™ã‚‹<code>&mut</code>å‚ç…§ã‚‚é–¢æ•°å…¨ä½“ã«ãŠã‚ˆã³ã€compilerãŒ<code>&mut</code>ã®lifetimeã‚’ç¸®ã‚ã‚‹ã“ã¨ãŒã§ããªããªã£ã¦ã—ã¾ã„ã€immutable refãŒã‚¨ãƒ©ãƒ¼ã«ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚<p><code>MessageCollector</code>ã®å®šç¾©ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ã™ã‚‹ã¨compileãŒã¨ãŠã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> MessageCollector2</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>, '</span><span style=color:#8fbcbb>msg</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span>    list</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>a</span><span style=color:#81a1c1> mut</span><span style=color:#8fbcbb> Vec</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Message</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>msg</span><span style=color:#eceff4>>></span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>,'</span><span style=color:#8fbcbb>msg</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> MessageCollector2</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>,'</span><span style=color:#8fbcbb>msg</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> add_message</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> message</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Message</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>msg</span><span style=color:#eceff4>>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>list</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>push</span><span style=color:#eceff4>(</span><span>message</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><h2 id=matome><a aria-label="Anchor link for: matome" class=zola-anchor href=#matome>ã¾ã¨ã‚</a></h2><ul><li><code>&</code>,<code>&mut</code>ã¯type converterã¨è€ƒãˆã‚‹ã¨ã„ã‚ã„ã‚compilerã®æŒ™å‹•ã®èª¬æ˜ãŒã¤ãã€‚<li><code>&mut</code>ã«ãŠã‘ã‚‹å±é™ºãªæ“ä½œãŒinvariantã¨ã—ã¦ç¦æ­¢ã•ã‚Œã¦ã„ãŸã‚Šã¨lifetimeãŒå‹ã¨ã—ã¦è¡¨ç¾ã•ã‚Œã¦ã„ã‚‹ã€‚<li>Drop checkã®æŒ™å‹•ã‚’åˆ¶å¾¡ã—ãŸã‚Šã™ã‚‹é–¢ä¿‚ã§ã€<code>PhantomData</code>ç­‰ã§å‹ã®varianceã‚’ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã™ã‚‹ã¿ãŸã„ãªãƒˆãƒ”ãƒƒã‚¯ã«ã¤ã„ã¦ã¯ã¾ã ã¾ã ã‚ã‹ã£ã¦ã„ãªã„ã€‚</ul></div></article></main><footer class=blog-footer><p>Â© 2026 <a href=https://blog.ymgyt.io> ymgyt </a> | Made with <a href=https://www.getzola.org rel=noopener target=_blank>Zola</a> | <a href=https://github.com/ymgyt/blog>Repository</a> | <a href=https://blog.ymgyt.io/atom.xml target=_blank title=rss> <svg viewbox="0 0 24 24" class=icon fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx=5 cy=19 r=1></circle></svg> </a></footer></div></div>