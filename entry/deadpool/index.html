<!doctype html><html lang=ja><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1" name=viewport><link href=https://blog.ymgyt.io/favicon.ico rel=icon sizes=any><link href=https://blog.ymgyt.io/icon.svg rel=icon type=image/svg+xml><link href=https://blog.ymgyt.io/apple-touch-icon.png rel=apple-touch-icon><link href=https://blog.ymgyt.io/manifest.webmanifest rel=manifest><link href=https://blog.ymgyt.io/style.css rel=stylesheet><link href=https://blog.ymgyt.io/atom.xml rel=alternate title=Atom type=application/atom+xml><script src="https://www.googletagmanager.com/gtag/js?id=G-GTB0KMLN90" async></script><script>window.dataLayer = window.dataLayer || [];
	function gtag() {dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-GTB0KMLN90');</script><title>ğŸŠ deadpoolã§ConnectionPoolã‚’ä½œã‚‹ | Happy developing</title><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><body><div class=world><div class=content-container><header class=blog-header-container><div class=blog-logo><a href=https://blog.ymgyt.io>Happy developing</a></div><div class=blog-nav><nav><ul><li><a href=https://blog.ymgyt.io/entry/>Entries</a><li><a href=https://blog.ymgyt.io/tags/>Tags</a><li><a href=https://blog.ymgyt.io/about/>About</a><li><a href=https://github.com/ymgyt> <img alt=Github class=icon src=https://blog.ymgyt.io/images/icon/github.svg> </a><li><a href="https://twitter.com/YAmaguchixt "> <img alt=Twitter class=icon src=https://blog.ymgyt.io/images/icon/twitter.svg> </a></ul></nav></div></header><main class=blog-main><article><header class=entry-header><h1 class=entry-title>ğŸŠ deadpoolã§ConnectionPoolã‚’ä½œã‚‹</h1><div class=entry-meta><p class=entry-meta-item>ğŸ—“ 2022-07-29<p class=entry-meta-item>ğŸ· <span class=tag><a href=https://blog.ymgyt.io/tags/rust/>rust</a></span></div></header><aside class=entry-toc><nav><ul class=entry-toc-toplevel-list><li><a href=https://blog.ymgyt.io/entry/deadpool/#deadpoolnogai-yao>deadpoolã®æ¦‚è¦</a><li><a href=https://blog.ymgyt.io/entry/deadpool/#shi-ifang>ä½¿ã„æ–¹</a> <ul><li><a href=https://blog.ymgyt.io/entry/deadpool/#pooldeguan-li-suruconnection>Poolã§ç®¡ç†ã™ã‚‹Connection</a><li><a href=https://blog.ymgyt.io/entry/deadpool/#managernoshi-zhuang>Managerã®å®Ÿè£…</a><li><a href=https://blog.ymgyt.io/entry/deadpool/#pool-get>Pool::get</a><li><a href=https://blog.ymgyt.io/entry/deadpool/#hooks>Hooks</a></ul><li><a href=https://blog.ymgyt.io/entry/deadpool/#deadpool-poolnoshi-zu-mi>deadpool::Poolã®ä»•çµ„ã¿</a> <ul><li><a href=https://blog.ymgyt.io/entry/deadpool/#pool-getchu-li>Pool::getå‡¦ç†</a><li><a href=https://blog.ymgyt.io/entry/deadpool/#object>Object</a></ul><li><a href=https://blog.ymgyt.io/entry/deadpool/#matome>ã¾ã¨ã‚</a></ul></nav></aside><div class=entry-content><p>æœ¬è¨˜äº‹ã§ã¯ã€<a href=https://github.com/bikeshedder/deadpool rel=external><code>deadpool</code></a>ã‚’åˆ©ç”¨ã—ãŸConnectionPoolã®ä½œã‚Šæ–¹ã¨ãã®ä»•çµ„ã¿ã«ã¤ã„ã¦ã¿ã¦ã„ãã¾ã™ã€‚ å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹ã‚’æŠ½è±¡åŒ–ã—ãŸå½¢ã§PoolãŒæä¾›ã•ã‚Œã¦ã„ã‚‹ã®ã§åŒæ™‚åˆ©ç”¨æ•°ã«åˆ¶é™ã®ã‚ã‚‹å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹ã‚’è¤‡æ•°ä½œæˆã—ã¦ã€å¿…è¦ã«å¿œã˜ã¦ä½¿ã„ã¾ã‚ã—ãŸã„å ´é¢ã«ãŠã„ã¦<a href=https://github.com/bikeshedder/deadpool rel=external><code>deadpool</code></a>ãŒåˆ©ç”¨ã§ãã¾ã™ã€‚<h2 id=deadpoolnogai-yao><a aria-label="Anchor link for: deadpoolnogai-yao" class=zola-anchor href=#deadpoolnogai-yao><a href=https://github.com/bikeshedder/deadpool rel=external><code>deadpool</code></a>ã®æ¦‚è¦</a></h2><p>ãƒ¦ãƒ¼ã‚¶ãŒ<a href=https://github.com/bikeshedder/deadpool rel=external><code>deadpool</code></a>ã«Connectionã®ä½œæˆå‡¦ç†ã‚’æ¸¡ã™ã¨ãã®ConnectionPoolãŒæä¾›ã•ã‚Œã¾ã™ã€‚<br> ã“ã“ã§ã„ã†ConnectionPoolã¯ä»¥ä¸‹ã®æ©Ÿèƒ½ã‚’æä¾›ã—ã¦ãã‚Œã‚‹ã‚‚ã®ã§ã™<ul><li>Connectionã®æœ€å¤§ä¿æŒæ•°ã‚’å®šç¾©ã§ãã‚‹<li>ãƒ¦ãƒ¼ã‚¶ãŒåˆ©ç”¨ã—ãŸConnectionãŒå†åˆ©ç”¨ã•ã‚Œã‚‹<li>Connectionå–å¾—æ™‚ã«æ‰€æœ‰æ¨©ã‚‚å–å¾—ã§ãã‚‹(referenceã§ãªã„)</ul><p>ã“ã®æ©Ÿèƒ½ã«ã‚ˆã‚Šã€ãƒ¦ãƒ¼ã‚¶ãŒConnectionã‚’å¿…è¦ã¨ã—ãŸã¨ãã«å†åˆ©ç”¨å¯èƒ½ãªConnectionãŒã‚ã‚Œã°ãã‚Œã‚’åˆ©ç”¨ã§ãã€ConnectionãŒãªã‘ã‚Œã°ãã®ã¨ãã¯ã˜ã‚ã¦æ¥ç¶šå‡¦ç†ãŒé–‹å§‹ã•ã‚Œã¾ã™ã€‚ã¾ãŸã€æœ€å¤§ä¿æŒæ•°ã®ConnectionãŒåˆ©ç”¨ä¸­ã®ã¨ãã¯ã€ã„ãšã‚Œã‹ã®ConnectionãŒåˆ©ç”¨å¯èƒ½ã«ãªã‚‹ã¾ã§ã€ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã™ã€‚(ã‚¨ãƒ©ãƒ¼ã«ã‚‚ã§ãã‚‹)<br> Connectionå–å¾—æ™‚ã«referenceã‚„smart pointer(<code>Arc</code>)ã§ãªãç›´æ¥Connectionã‚’å–å¾—ã§ãã‚‹ã«ã‚‚ã‹ã‹ã‚ã‚‰ãšConnectionãŒPoolã§å†åˆ©ç”¨ã•ã‚Œã¦ã„ã‚‹ãŒä¾¿åˆ©ã ã£ãŸã®ãŒ<a href=https://github.com/bikeshedder/deadpool rel=external><code>deadpool</code></a>ã®ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚“ã§ã¿ã‚ˆã†ã¨ãŠã‚‚ã£ãŸãã£ã‹ã‘ã§ã—ãŸã€‚<p><a href=https://github.com/bikeshedder/deadpool rel=external><code>deadpool</code></a>ã®æ¦‚è¦ã‚’ä»¥ä¸‹ã«ç¤ºã—ã¾ã™ã€‚<figure><div class=fig-images-row><img , alt src=images/deadpool_overview.png></div><figcaption>deadpoolã®æ¦‚è¦</figcaption></figure><p>Connectionã®ä½œæˆ(<code>create</code>)ã¨å†åˆ©ç”¨(<code>recycle</code>)ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…ã—ãŸ<code>Manager</code>ã‚’<a href=https://github.com/bikeshedder/deadpool rel=external><code>deadpool</code></a>ã«æ¸¡ã™ã¨ãã‚Œã‚’åˆ©ç”¨ã—ãŸPoolãŒæä¾›ã•ã‚Œã‚‹å½¢ã§ã™ã€‚<p>æœ¬è¨˜äº‹ã§ã¯ã€<a href=https://github.com/bikeshedder/deadpool rel=external><code>deadpool</code></a>ã®<a href=https://docs.rs/deadpool/latest/deadpool/managed/index.html rel=external><code>managed</code></a> moduleã‚’å‰æã«ã—ã¦ã„ã¾ã™ã€‚<br> ã¾ãŸã€Poolã§ç®¡ç†ã™ã‚‹å¯¾è±¡ã‚’Connectionã¨ã—ã¦ã„ã¾ã™ãŒã€å®Ÿéš›ã«ã¯<code>Send</code>ãªå‹ã§ã‚ã‚Œã°Connectionã«é™ã‚‰ãšPoolã§ç®¡ç†ã§ãã¾ã™ã€‚<h2 id=shi-ifang><a aria-label="Anchor link for: shi-ifang" class=zola-anchor href=#shi-ifang>ä½¿ã„æ–¹</a></h2><p>ã¾ãšã¯ä¸€ç•ªã‚·ãƒ³ãƒ—ãƒ«ãªä½¿ã„æ–¹ã‹ã‚‰ã¿ã¦ã„ãã¾ã™ã€‚æœ¬è¨˜äº‹ã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã®dependenciesã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=toml><span class=giallo-l><span style=color:#eceff4>[</span><span>dependencies</span><span style=color:#eceff4>]</span></span>
<span class=giallo-l><span>async-trait</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>0.1.56</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span>deadpool</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>0.9.5</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span>thiserror</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>1.0.31</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span>tracing</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>0.1.35</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#eceff4>[</span><span>dev-dependencies</span><span style=color:#eceff4>]</span></span>
<span class=giallo-l><span>anyhow</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>1.0.58</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span>tokio</span><span style=color:#eceff4> = {</span><span> version</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>1.20.1</span><span style=color:#eceff4>",</span><span> features</span><span style=color:#eceff4> = ["</span><span style=color:#a3be8c>full</span><span style=color:#eceff4>"] }</span></span>
<span class=giallo-l><span>tracing-init</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>0.1.0</span><span style=color:#eceff4>"</span></span></code></pre><h3 id=pooldeguan-li-suruconnection><a aria-label="Anchor link for: pooldeguan-li-suruconnection" class=zola-anchor href=#pooldeguan-li-suruconnection><code>Pool</code>ã§ç®¡ç†ã™ã‚‹Connection</a></h3><p>ã¾ãšåˆã‚ã«Poolã§ç®¡ç†ã—ãŸã„Connectionã‚’å®šç¾©ã—ã¦ã„ãã¾ã™ã€‚<br> å®Ÿéš›ã«ã¯ã“ã®å‹ã¯åˆ©ç”¨ã—ãŸã„backendã®Connectionå‹ã«ãªã‚‹ã¨æ€ã†ã®ã§åŸºæœ¬çš„ã«ã¯è‡ªåˆ†ã§å®šç¾©ã™ã‚‹ã“ã¨ã¯å°‘ãªã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Clone</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Debug</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> PartialEq</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Copy</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub enum</span><span style=color:#8fbcbb> ConnectionState</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Connected</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Closed</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Error</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Debug</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> Connection</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    name</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    state</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> ConnectionState</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Connection</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> new</span><span style=color:#eceff4>(</span><span>name</span><span style=color:#81a1c1>: impl</span><span style=color:#8fbcbb> Into</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>>)</span><span style=color:#81a1c1> -> Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            name</span><span style=color:#81a1c1>:</span><span> name</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>            state</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> ConnectionState</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Connected</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>debugç”¨ã«ã‚‚ãŸã›ãŸnameã¨stateã‚’ã‚‚ã¤ã ã‘ã®å‹ã§ã™ã€‚<h3 id=managernoshi-zhuang><a aria-label="Anchor link for: managernoshi-zhuang" class=zola-anchor href=#managernoshi-zhuang><code>Manager</code>ã®å®Ÿè£…</a></h3><p><a href=https://github.com/bikeshedder/deadpool rel=external><code>deadpool</code></a>ã«ã¯ã“ã®Connectionã‚’ä½œæˆ/å†åˆ©ç”¨ã™ã‚‹å‡¦ç†(<code>Manager</code> trait)ã‚’å®Ÿè£…ã—ãŸå‹ã‚’æ¸¡ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[derive(thiserror::</span><span style=color:#8fbcbb>Error</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Debug</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub enum</span><span style=color:#8fbcbb> MyError</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#5e81ac>    #[error("</span><span style=color:#a3be8c>A</span><span style=color:#5e81ac>")]</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    A</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#5e81ac>    #[error("</span><span style=color:#a3be8c>B</span><span style=color:#5e81ac>")]</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    B</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Debug</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> ManagerImpl</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    connection_counter</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> AtomicUsize</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> ManagerImpl</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> new</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -> Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            connection_counter</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> AtomicUsize</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span style=color:#b48ead>0</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[async_trait]</span></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Manager</span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> ManagerImpl</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Type</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Connection</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Error</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> MyError</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    async fn</span><span style=color:#88c0d0> create</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Connection</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> MyError</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> current</span><span style=color:#81a1c1> = self.</span><span>connection_counter</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>fetch_add</span><span style=color:#eceff4>(</span><span style=color:#b48ead>1</span><span style=color:#eceff4>,</span><span> Ordering</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Relaxed</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        Ok</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Connection</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span style=color:#88c0d0;font-weight:700>format!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>connection </span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>current</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>")))</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    async fn</span><span style=color:#88c0d0> recycle</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> conn</span><span style=color:#81a1c1>: &mut</span><span style=color:#8fbcbb> Connection</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> RecycleResult</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>MyError</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        match</span><span> conn</span><span style=color:#81a1c1>.</span><span>state </span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            ConnectionState</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Connected</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>(()),</span></span>
<span class=giallo-l><span>            other</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>RecycleError</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Message</span><span style=color:#eceff4>(</span><span style=color:#88c0d0;font-weight:700>format!</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>                "</span><span style=color:#a3be8c>connection is in state: </span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>other:?</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#eceff4>            ))),</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> detach</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> obj</span><span style=color:#81a1c1>: &mut Self::</span><span style=color:#8fbcbb>Type</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span>        tracing</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0;font-weight:700>info!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>obj:?</span><span style=color:#ebcb8b>}</span><span style=color:#a3be8c> detached</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>Manager</code>ã¯<code>Sync + Send</code>ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§ã€connectionè­˜åˆ¥ç”¨ã®counterã«ã¯<code>AtomicUsize</code>ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚<p><code>Manager::create</code>ã¯Connectionã®ä½œæˆå‡¦ç†ã§ã™ã€‚Poolã«åˆ©ç”¨å¯èƒ½ãªConnectionãŒãªã„å ´åˆã«ãƒ¦ãƒ¼ã‚¶ãŒConnectionã‚’è¦æ±‚ã™ã‚‹ã¨å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚<br> ã‚¨ãƒ©ãƒ¼å‹ã¯ãƒ¦ãƒ¼ã‚¶å®šç¾©å‹ãŒåˆ©ç”¨ã§ãã€Connectionå–å¾—æ™‚ã«ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã§ãã¾ã™ã€‚<p><code>Manager::recycle</code>ã¯Connectionã®å†åˆ©ç”¨å‡¦ç†ã§ã™ã€‚å¼•æ•°ã§æ¸¡ã•ã‚ŒãŸConnectionã®çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ã€ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã•ãªã‘ã‚Œã°ãã®ConnectionãŒå†åˆ©ç”¨ã•ã‚Œã¾ã™ã€‚ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã—ãŸå ´åˆã€Poolå´ã§å†åˆ©ç”¨å¯èƒ½ãªConnectionã¨ã•ã‚Œãšdropã•ã‚Œã¾ã™ã€‚<p><code>Manager::detach</code>ã¯Connectionã‚’Poolã®ç®¡ç†å¯¾è±¡å¤–ã«ã™ã‚‹éš›ã«å‘¼ã°ã‚Œã¾ã™ã€‚defaultã®å®Ÿè£…ãŒæä¾›ã•ã‚Œã¦ãŠã‚Šã€ç‰¹ã«å‡¦ç†ãŒãªã‘ã‚Œã°å®šç¾©ã™ã‚‹å¿…è¦ã¯ãªã„ã§ã™ã€‚<h3 id=pool-get><a aria-label="Anchor link for: pool-get" class=zola-anchor href=#pool-get><code>Pool::get</code></a></h3><p><code>Manager</code>å‹ãŒå®Ÿè£…ã—ã¦ã‚ã‚Œã°ä½¿ã†æ–¹æ³•ã¯éå¸¸ã«ã‚·ãƒ³ãƒ—ãƒ«ã§ã™ã€‚(<code>deadpool_handson</code>ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹æƒ³å®š)<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> deadpool</span><span style=color:#81a1c1>::</span><span>managed</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>Object</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Pool</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> deadpool_handson</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>ManagerImpl</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[tokio::main]</span></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span> anyhow</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span>    tracing_init</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>init</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> pool</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Pool</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>ManagerImpl</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Object</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>ManagerImpl</span><span style=color:#eceff4>>></span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Pool</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>builder</span><span style=color:#eceff4>(</span><span>ManagerImpl</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>build</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> conn</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Object</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>ManagerImpl</span><span style=color:#eceff4>></span><span style=color:#81a1c1> =</span><span> pool</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>get</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>    tracing</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0;font-weight:700>info!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>connection state: </span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>:?</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>",</span><span> conn</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>state</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>    Ok</span><span style=color:#eceff4>(())</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã‚ã‹ã‚Šã‚„ã™ã•ã®ãŸã‚ã«ã€å¤‰æ•°ã«å‹ã‚’æ›¸ã„ã¦ã„ã¾ã™ãŒå®Ÿéš›ã«ã¯å¿…è¦ãªã„ã§ã™ã€‚<br> <code>Object</code>ã«ã¤ã„ã¦ã¯å¾Œè¿°ã—ã¾ã™ã€‚ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>â¯</span><span style=color:#a3be8c> cargo run --example get --quiet</span></span>
<span class=giallo-l><span style=color:#88c0d0>2022-07-28T12:25:58.078486Z</span><span style=color:#a3be8c>  INFO examples/get.rs:13: connection state: Connected</span></span></code></pre><p><code>Pool</code>ã«<code>Manager</code>ã®å®Ÿè£…ã‚’æ¸¡ã—ã¦ã€<code>Pool::get</code>ã‚’å‘¼ã¶ã ã‘ã§ã™ã€‚<br> <code>let conn: Object&lt;ManagerImpl></code>ã¨ãªã£ã¦ã„ã¦ã“ã®å‹ãŒå®Ÿéš›ã«<code>Pool::get</code>ã§è¿”ã•ã‚Œã‚‹å‹ãªã®ã§ã™ãŒ<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>M</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Manager</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Deref</span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> Object</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>M</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Target</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> M</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Type</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> deref</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> &</span><span>M</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Type</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        &self.</span><span>inner</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_ref</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span>obj</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã®ã‚ˆã†ã«<code>Deref</code>ã‚’å®šç¾©ã—ã¦ã„ã‚‹ã®ã§ã€é€éçš„ã«<code>Manager::Type</code>(=Connection)ã¨ã—ã¦åˆ©ç”¨ã§ãã¾ã™ã€‚<br> ãªãœã€Connectionã‚’<code>Object</code>ã§wrapã—ã¦ã„ã‚‹ã‹ã«ã¤ã„ã¦ã¯å¾Œè¿°ã—ã¾ã™ã€‚<br> ä¸€åº¦<code>Pool</code>ã‚’ä½œæˆã—ãŸã‚‰ã‚ã¨ã¯<code>Pool::get</code>ã‚’å‘¼ã¶ã ã‘ã§ã€ã‚ã¨ã®ã“ã¨ã¯<code>Pool</code>ãŒé¢å€’ã‚’ã¿ã¦ãã‚Œã¾ã™ã€‚<h3 id=hooks><a aria-label="Anchor link for: hooks" class=zola-anchor href=#hooks><code>Hooks</code></a></h3><p><a href=https://github.com/bikeshedder/deadpool rel=external><code>deadpool</code></a>ã«ã¯Connectionã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«æ™‚ã«å®Ÿè¡Œã•ã‚Œã‚‹hookæ©Ÿèƒ½ãŒã‚ã‚Šã¾ã™ã€‚<br> ç¾åœ¨ã®ã¨ã“ã‚åˆ©ç”¨ã§ãã‚‹hookã¯ã€ä»¥ä¸‹ã®3ã¤ã§ã™ã€‚<ul><li>post_create<li>pre_recycle<li>post_recycle</ul><p>å®Ÿéš›ã«åˆ©ç”¨ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> deadpool</span><span style=color:#81a1c1>::</span><span>managed</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>Metrics</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Object</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Pool</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Hook</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> HookFuture</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> deadpool_handson</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>Connection</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> MyError</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> ManagerImpl</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> post_create_hook</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>>(</span><span>conn</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>a</span><span style=color:#81a1c1> mut</span><span style=color:#8fbcbb> Connection</span><span style=color:#eceff4>,</span><span> metrics</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>a Metrics</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> HookFuture</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> MyError</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span>    tracing</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0;font-weight:700>info!</span><span style=color:#eceff4>(</span><span>hook</span><span style=color:#81a1c1>=</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>post_create</span><span style=color:#eceff4>", "</span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>conn:?</span><span style=color:#ebcb8b>} {</span><span style=color:#a3be8c>metrics:?</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>    Box</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>pin</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>async</span><span style=color:#eceff4> {</span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>(()) })</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> pre_recycle_hook</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>>(</span><span>conn</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>a</span><span style=color:#81a1c1> mut</span><span style=color:#8fbcbb> Connection</span><span style=color:#eceff4>,</span><span> metrics</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>a Metrics</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> HookFuture</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> MyError</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span>    tracing</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0;font-weight:700>info!</span><span style=color:#eceff4>(</span><span>hook</span><span style=color:#81a1c1>=</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>pre_recycle</span><span style=color:#eceff4>", "</span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>conn:?</span><span style=color:#ebcb8b>} {</span><span style=color:#a3be8c>metrics:?</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>    Box</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>pin</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>async</span><span style=color:#eceff4> {</span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>(()) })</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> post_recycle_hook</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>>(</span><span>conn</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>a</span><span style=color:#81a1c1> mut</span><span style=color:#8fbcbb> Connection</span><span style=color:#eceff4>,</span><span> metrics</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>a Metrics</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> HookFuture</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> MyError</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span>    tracing</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0;font-weight:700>info!</span><span style=color:#eceff4>(</span><span>hook</span><span style=color:#81a1c1>=</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>post_recycle</span><span style=color:#eceff4>", "</span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>conn:?</span><span style=color:#ebcb8b>} {</span><span style=color:#a3be8c>metrics:?</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>    Box</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>pin</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>async</span><span style=color:#eceff4> {</span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>(()) })</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[tokio::main]</span></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span> anyhow</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span>    tracing_init</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>init</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> pool</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Pool</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>ManagerImpl</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Object</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>ManagerImpl</span><span style=color:#eceff4>>></span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Pool</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>builder</span><span style=color:#eceff4>(</span><span>ManagerImpl</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>())</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>post_create</span><span style=color:#eceff4>(</span><span>Hook</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>async_fn</span><span style=color:#eceff4>(</span><span>post_create_hook</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>pre_recycle</span><span style=color:#eceff4>(</span><span>Hook</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>async_fn</span><span style=color:#eceff4>(</span><span>pre_recycle_hook</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>post_recycle</span><span style=color:#eceff4>(</span><span>Hook</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>async_fn</span><span style=color:#eceff4>(</span><span>post_recycle_hook</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>build</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> conn</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Object</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>ManagerImpl</span><span style=color:#eceff4>></span><span style=color:#81a1c1> =</span><span> pool</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>get</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span>    tracing</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0;font-weight:700>info!</span><span style=color:#eceff4>(</span><span>state</span><span style=color:#81a1c1>=?</span><span>conn</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>state</span><span style=color:#eceff4>(), "</span><span style=color:#a3be8c>Got connection from pool</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span>    tracing</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0;font-weight:700>info!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Drop connection</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#88c0d0>    drop</span><span style=color:#eceff4>(</span><span>conn</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> recycled_conn</span><span style=color:#81a1c1> =</span><span> pool</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>get</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span>    tracing</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0;font-weight:700>info!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Recycled connection: </span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>recycled_conn:?</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>    Ok</span><span style=color:#eceff4>(())</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>Poolç”Ÿæˆæ™‚ã«ãã‚Œãã‚Œã®hookã«closure/funcã‚’æ¸¡ã—ã¾ã™ã€‚ã“ã“ã§ã¯ã€<code>Hook::async_fn</code>ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ãŒã€asyncãŒå¿…è¦ãªã„å ´åˆã¯åŒæœŸverã‚’æ¸¡ã™ã“ã¨ã‚‚ã§ãã¾ã™ã€‚<p>ã“ã®å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ã¨<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>â¯</span><span style=color:#a3be8c> cargo run --example hook --quiet</span></span>
<span class=giallo-l><span style=color:#88c0d0>2022-07-28T20:10:54.872028Z</span><span style=color:#a3be8c>  INFO examples/hook.rs:6: Connection { name:</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>connection 0</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>, state: Connected } Metrics { created: Instant { t:</span><span style=color:#b48ead> 8126598910934</span><span style=color:#a3be8c> }, recycled: None, recycle_count:</span><span style=color:#b48ead> 0</span><span style=color:#a3be8c> } hook=</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>post_create</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#88c0d0>2022-07-28T20:10:54.872113Z</span><span style=color:#a3be8c>  INFO examples/hook.rs:35: Got connection from pool state=Connected</span></span>
<span class=giallo-l><span style=color:#88c0d0>2022-07-28T20:10:54.872132Z</span><span style=color:#a3be8c>  INFO examples/hook.rs:36: Drop connection</span></span>
<span class=giallo-l><span style=color:#88c0d0>2022-07-28T20:10:54.872145Z</span><span style=color:#a3be8c>  INFO /Users/ymgyt/rs/deadpool/src/managed/mod.rs:230: Object dropped</span></span>
<span class=giallo-l><span style=color:#88c0d0>2022-07-28T20:10:54.87216Z</span><span style=color:#a3be8c>  INFO /Users/ymgyt/rs/deadpool/src/managed/mod.rs:643: Current slot size=</span><span style=color:#b48ead>1</span><span style=color:#a3be8c> max_size=</span><span style=color:#b48ead>32</span></span>
<span class=giallo-l><span style=color:#88c0d0>2022-07-28T20:10:54.872204Z</span><span style=color:#a3be8c>  INFO examples/hook.rs:12: Connection { name:</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>connection 0</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>, state: Connected } Metrics { created: Instant { t:</span><span style=color:#b48ead> 8126598910934</span><span style=color:#a3be8c> }, recycled: None, recycle_count:</span><span style=color:#b48ead> 0</span><span style=color:#a3be8c> } hook=</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>pre_recycle</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#88c0d0>2022-07-28T20:10:54.872225Z</span><span style=color:#a3be8c>  INFO examples/hook.rs:18: Connection { name:</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>connection 0</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>, state: Connected } Metrics { created: Instant { t:</span><span style=color:#b48ead> 8126598910934</span><span style=color:#a3be8c> }, recycled: None, recycle_count:</span><span style=color:#b48ead> 0</span><span style=color:#a3be8c> } hook=</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>post_recycle</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#88c0d0>2022-07-28T20:10:54.872244Z</span><span style=color:#a3be8c>  INFO examples/hook.rs:40: Recycled connection: Object { inner: Some</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>ObjectInner</span><span style=color:#a3be8c> { obj: Connection { name:</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>connection 0</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>, state: Connected }, metrics: Metrics { created: Instant { t:</span><span style=color:#b48ead> 8126598910934</span><span style=color:#a3be8c> }, recycled: Some</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>Instant</span><span style=color:#a3be8c> { t:</span><span style=color:#b48ead> 8126598916859</span><span style=color:#a3be8c> }</span><span style=color:#eceff4>)</span><span style=color:#a3be8c>, recycle_count:</span><span style=color:#b48ead> 1</span><span style=color:#a3be8c> } }</span><span style=color:#eceff4>)</span><span style=color:#a3be8c> }</span></span>
<span class=giallo-l><span style=color:#88c0d0>2022-07-28T20:10:54.872906Z</span><span style=color:#a3be8c>  INFO /Users/ymgyt/rs/deadpool/src/managed/mod.rs:230: Object dropped</span></span>
<span class=giallo-l><span style=color:#88c0d0>2022-07-28T20:10:54.872926Z</span><span style=color:#a3be8c>  INFO /Users/ymgyt/rs/deadpool/src/managed/mod.rs:643: Current slot size=</span><span style=color:#b48ead>1</span><span style=color:#a3be8c> max_size=</span><span style=color:#b48ead>32</span></span></code></pre><p><code>deadpool/src/managed/mod.rs</code>ã®ãƒ­ã‚°ã¯ãƒ–ãƒ­ã‚°ç”¨ã«è‡ªåˆ†ãŒè¿½åŠ ã—ãŸã‚‚ã®ã§å®Ÿéš›ã«ã¯å‡ºåŠ›ã•ã‚Œã¾ã›ã‚“ã€‚<br> ä¸€åº¦å–å¾—ã—ãŸConnectionã‚’dropã—ãŸã®ã¡å†åº¦å–å¾—ã™ã‚‹ã¨å†åˆ©ç”¨ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚<h2 id=deadpool-poolnoshi-zu-mi><a aria-label="Anchor link for: deadpool-poolnoshi-zu-mi" class=zola-anchor href=#deadpool-poolnoshi-zu-mi><code>deadpool::Pool</code>ã®ä»•çµ„ã¿</a></h2><p>ä»¥ä¸ŠãŒ<a href=https://github.com/bikeshedder/deadpool rel=external><code>deadpool</code></a>ã®ç°¡å˜ãªåˆ©ç”¨ä¾‹ã«ãªã‚Šã¾ã™ã€‚<br> ã“ã“ã‹ã‚‰ã¯å®Ÿéš›ã«PoolãŒã©ã®ã‚ˆã†ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ã‚½ãƒ¼ã‚¹ã‹ã‚‰è¿½ã£ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚<br> æœ€åˆã«Poolã®å®Ÿè£…ã‚ˆã‚Šã®æ¦‚è¦ã‚’ä»¥ä¸‹ã«ç¤ºã—ã¾ã™ã€‚<figure><div class=fig-images-row><img , alt src=images/pool_overview.png></div><figcaption>Poolã®æ¦‚è¦</figcaption></figure><p>ã–ã£ãã‚Šã¨ã—ãŸç†è§£ã§ã¯ã€<code>Pool</code>ã®å®Ÿæ…‹ã¯<code>PoolInner</code>ã«ä¿æŒã•ã‚Œã¦ã„ã¦<code>Pool</code>ã¯<code>Arc&lt;PoolInner></code>ã‚’æŒã£ã¦ãŠã‚Šã€<code>Clone</code>ãªã®ã§å–ã‚Šå›ã—ã‚„ã™ã„ã§ã™ã€‚<br> ã¾ãŸã€Connectionã‚’å®Ÿéš›ã«ä¿æŒã—ã¦ã„ã‚‹collectionã¯<code>VecDeque</code>ã§Connectionã®å†åˆ©ç”¨ã•ã‚Œã‚‹é †ç•ªã«å½±éŸ¿ã—ã¾ã™ã€‚<br> <code>Pool::get</code>ã®å–å¾—æ™‚ã«ã¯<a href=https://github.com/bikeshedder/deadpool/blob/bbe2f0c46f9b2ca695f352a2be8e4f887b272f73/src/managed/mod.rs#L388 rel=external><code>VecDeque::pop_front</code></a>ã§å…ˆé ­ã‹ã‚‰å–å¾—ã•ã‚Œã€Connectionå†åˆ©ç”¨æ™‚ã«ã¯<a href=https://github.com/bikeshedder/deadpool/blob/bbe2f0c46f9b2ca695f352a2be8e4f887b272f73/src/managed/mod.rs#L639 rel=external><code>VecDeque::push_back</code></a>ã§queueã®æœ€å¾Œã«è¿½åŠ ã•ã‚Œã¾ã™ã€‚<br> çµæœçš„ã«Connectionã®å–å¾—é †åºã¯ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ­ãƒ“ãƒ³ã«ãªã‚Šã¾ã™ã€‚<p>å®Ÿéš›ã®<code>Pool</code>ã®å®šç¾©<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> Pool</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>M</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Manager</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> W</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> From</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Object</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>M</span><span style=color:#eceff4>>></span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Object</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>M</span><span style=color:#eceff4>>> {</span></span>
<span class=giallo-l><span>    inner</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Arc</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>PoolInner</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>M</span><span style=color:#eceff4>>>,</span></span>
<span class=giallo-l><span>    _wrapper</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> PhantomData</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>fn</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> W</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>å˜ã«Genericsã‚’æ¶ˆè²»ã—ãŸã„ã ã‘ã®ã¨ãã¯<code>PhantomData&lt;W></code>ã§ã¯ãªãã€<code>PhantomData&lt;fn() -> W></code>ãŒè‰¯ã„ã¨ã•ã‚Œã¦ã„ã¾ã™ãŒãã®é€šã‚Šã«ãªã£ã¦ã„ã¾ã™ã­ã€‚<p>è‚å¿ƒã®<code>PoolInner</code><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> PoolInner</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>M</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Manager</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span>    manager</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Box</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>M</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>    slots</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Mutex</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Slots</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>ObjectInner</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>M</span><span style=color:#eceff4>>>>,</span></span>
<span class=giallo-l><span>    users</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> AtomicUsize</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    semaphore</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Semaphore</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    config</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> PoolConfig</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    runtime</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Runtime</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>    hooks</span><span style=color:#81a1c1>:</span><span> hooks</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Hooks</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>M</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><ul><li><code>manager</code>: ãƒ¦ãƒ¼ã‚¶ãŒå®šç¾©ã—ãŸ<code>Manaer</code>ã®å®Ÿè£…ã‚’heapã«ä¿æŒã—ã¾ã™<li><code>slots</code>: ãƒ¦ãƒ¼ã‚¶ãŒå®šç¾©ã—ãŸConnectionã‚’wrapã™ã‚‹<code>ObjectInner</code>ã‚’<code>VecDeque</code>ã§ä¿æŒã—ã¦<code>Mutex</code>ã§ä¿è­·ã—ã¦ã„ã¾ã™ã€‚<code>Slots</code>ã¯<code>VecDeque</code>ã®wrapå‹ã§ã™</ul><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> Slots</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span>    vec</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> VecDeque</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>    size</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> usize</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    max_size</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> usize</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><ul><li><code>users</code>: <code>Pool::get</code>ã•ã‚Œã¦ãƒ¦ãƒ¼ã‚¶ãŒåˆ©ç”¨ä¸­ã®Connectionã®æ•°ã§ã™ã€‚<code>Pool::status</code>ã§åˆ©ç”¨ã—ã¾ã™<li><code>semaphore</code>: Poolã®æœ€å¤§ä¿æŒæ•°ã®åˆ¶å¾¡ã«åˆ©ç”¨ã—ã¾ã™ã€‚<code>VecDeque</code>ã ã‘ã§ã¯å¿…è¦ã«å¿œã˜ã¦æ‹¡å¼µã—ã¦ã—ã¾ã†ã®ã§<code>Semaphre</code>ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚ãªãŠã€deadpoolã«runtimeã®é¸æŠã«ã‚ˆã‚‰ãštokioã¸ã®ä¾å­˜ãŒã‚ã‚‹ã®ã¯<code>tokio::sync::Semaphore</code>ã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ãŸã‚ã§ã™<li><code>config</code>: Poolã®è¨­å®šã‚’ä¿æŒã—ã¾ã™ã€‚è¨­å®šã¯ã‚·ãƒ³ãƒ—ãƒ«ã§æœ€å¤§ä¿æŒæ•°ã¨å„ç¨®æ“ä½œã®timeoutã®ã¿ã§ã™ã€‚</ul><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> PoolConfig</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> max_size</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> usize</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> timeouts</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Timeouts</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> Timeouts</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> wait</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Duration</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> create</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Duration</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> recycle</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Duration</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>defaultã®<code>max_size</code>ã¯<code>num_cpus::get_physical() * 4</code>ãŒåˆ©ç”¨ã•ã‚Œã¾ã™ã€‚<br> ã¾ãŸ<code>Timeouts</code>ã®defaultå€¤ã¯ã™ã¹ã¦<code>None</code>ãªã®ã§å¾Œè¿°ã—ã¾ã™ãŒã€<code>Pool::get</code>æ™‚ã«æœ€å¤§ä¿æŒæ•°ã«ãŸã£ã—ã¦ã„ã‚‹ã¨ãƒ–ãƒ­ãƒƒã‚¯ã—ç¶šã‘ã¦ã—ã¾ã†ã®ã§æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚<ul><li><code>runtime</code>: ãƒ¦ãƒ¼ã‚¶ãŒasync runtimeã‚’é¸æŠã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã®æŠ½è±¡åŒ–ã§ã™<li><code>hooks</code>: ä¸Šè¿°ã—ãŸhookã‚’ä¿æŒã—ã¾ã™</ul><h3 id=pool-getchu-li><a aria-label="Anchor link for: pool-getchu-li" class=zola-anchor href=#pool-getchu-li><code>Pool::get</code>å‡¦ç†</a></h3><p>Poolã®æ¦‚è¦ã‚’æŠŠæ¡ã§ããŸã¨ã“ã‚ã§ã€è‚å¿ƒã®<code>Pool::get</code>å‡¦ç†ã«ã¤ã„ã¦ã¿ã¦ã„ãã¾ã™ã€‚<p>ã¾ãšã€<code>Pool::get</code>ã¯<code>Pool::timeout_get</code>ã¸ã®ã‚·ãƒ³ãƒ—ãƒ«ãªå§”è­²ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>pub async fn</span><span style=color:#88c0d0> get</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>W</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> PoolError</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>M</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    self.</span><span style=color:#88c0d0>timeout_get</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self.</span><span style=color:#88c0d0>timeouts</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>.await</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>Pool::timeout_get</code>ã¯é•·ã„ã§ã™ãŒã€ãŠã“ãªã£ã¦ã„ã‚‹ã“ã¨ã¯<code>Semaphore::acquire</code>ã§ãƒªã‚½ãƒ¼ã‚¹ã‚’å–å¾—ã—ãŸã®ã¡Poolã‹ã‚‰Connectionã‚’ä½œæˆorå†åˆ©ç”¨ã™ã‚‹å‡¦ç†ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>pub async fn</span><span style=color:#88c0d0> timeout_get</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> timeouts</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Timeouts</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>W</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> PoolError</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>M</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>>> {</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> permit</span><span style=color:#81a1c1> = if</span><span> non_blocking</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>inner</span><span style=color:#81a1c1>.</span><span>semaphore</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>try_acquire</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>map_err</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>e</span><span style=color:#81a1c1>| match</span><span> e</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            TryAcquireError</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Closed</span><span style=color:#81a1c1> =></span><span> PoolError</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Closed</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            TryAcquireError</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>NoPermits</span><span style=color:#81a1c1> =></span><span> PoolError</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Timeout</span><span style=color:#eceff4>(</span><span>TimeoutType</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Wait</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>        })</span><span style=color:#81a1c1>?</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0>        apply_timeout</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#81a1c1>            self.</span><span>inner</span><span style=color:#81a1c1>.</span><span>runtime</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            TimeoutType</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Wait</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            timeouts</span><span style=color:#81a1c1>.</span><span>wait</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>            async</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span>inner</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    .</span><span>semaphore</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    .</span><span style=color:#88c0d0>acquire</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    .await</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    .</span><span style=color:#88c0d0>map_err</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>_</span><span style=color:#81a1c1>|</span><span> PoolError</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Closed</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>            },</span></span>
<span class=giallo-l><span style=color:#eceff4>        )</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .await?</span></span>
<span class=giallo-l><span style=color:#eceff4>    };</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> inner_obj</span><span style=color:#81a1c1> = loop</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> inner_obj</span><span style=color:#81a1c1> = self.</span><span>inner</span><span style=color:#81a1c1>.</span><span>slots</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>lock</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span>vec</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>pop_front</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>inner_obj</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> inner_obj</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>            // å†åˆ©ç”¨</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>            // æ–°è¦ä½œæˆ</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    };</span></span>
<span class=giallo-l><span>    </span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Ok</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Object</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>        inner</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>inner_obj</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span>        pool</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Arc</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>downgrade</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self.</span><span>inner</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>())</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã‚‚ã‚ã‚‚ã‚çœç•¥ã™ã‚‹ã¨æ¦‚ã­ä¸Šè¨˜ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚<br> <code>apply_timeout</code>ã¯runtimeã¨timeoutã«å¿œã˜ã¦futureã‚’å®Ÿè¡Œã™ã‚‹å‡¦ç†ãªã®ã§ã™ãŒä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> apply_timeout</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>O</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> E</span><span style=color:#eceff4>>(</span></span>
<span class=giallo-l><span>    runtime</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Runtime</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>    timeout_type</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> TimeoutType</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    duration</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Duration</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>    future</span><span style=color:#81a1c1>: impl</span><span style=color:#8fbcbb> Future</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Output</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>O</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> impl</span><span style=color:#8fbcbb> Into</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>PoolError</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>E</span><span style=color:#eceff4>>>>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>O</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> PoolError</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>E</span><span style=color:#eceff4>>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    match</span><span style=color:#eceff4> (</span><span>runtime</span><span style=color:#eceff4>,</span><span> duration</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#eceff4>        (</span><span>_</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> None</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span> future</span><span style=color:#81a1c1>.await.</span><span style=color:#88c0d0>map_err</span><span style=color:#eceff4>(</span><span>Into</span><span style=color:#81a1c1>::</span><span>into</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>        (</span><span style=color:#8fbcbb>Some</span><span style=color:#eceff4>(</span><span>runtime</span><span style=color:#eceff4>),</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>duration</span><span style=color:#eceff4>))</span><span style=color:#81a1c1> =></span><span> runtime</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>timeout</span><span style=color:#eceff4>(</span><span>duration</span><span style=color:#eceff4>,</span><span> future</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .await</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>ok_or</span><span style=color:#eceff4>(</span><span>PoolError</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Timeout</span><span style=color:#eceff4>(</span><span>timeout_type</span><span style=color:#eceff4>))</span><span style=color:#81a1c1>?</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>map_err</span><span style=color:#eceff4>(</span><span>Into</span><span style=color:#81a1c1>::</span><span>into</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>        (</span><span style=color:#8fbcbb>None</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>_</span><span style=color:#eceff4>))</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>PoolError</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>NoRuntimeSpecified</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã“ã“ã§ã€timeoutã®è¨­å®šãŒãªã„å ´åˆã€å˜ç´”ã«<code>future.await</code>ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã®ã§ã™ãŒã€ã“ã®ã¨ãã«semaphoreãŒæœ€å¤§åˆ©ç”¨æ•°ã«é”ã—ã¦ã„ã‚‹ã¨ãƒ–ãƒ­ãƒƒã‚¯ã—ç¶šã‘ã¦ã—ã¾ã†ã®ã§è‹¥å¹²æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚<p><code>Pool::get</code>,<code>Pool::timeout_get</code>ã¯Connectionã§ã¯ãªãã€Connectionã‚’wrapã—ãŸ<code>Object</code>ã‚’è¿”ã—ã¾ã™ã€‚<br> ã¨ã„ã†ã“ã¨ã§æ¬¡ã«<code>Object</code>ã«ã¤ã„ã¦ã¿ã¦ã¿ã¾ã™ã€‚<h3 id=object><a aria-label="Anchor link for: object" class=zola-anchor href=#object><code>Object</code></a></h3><p>Connectionã‚’wrapã—ã¦ã„ã‚‹<code>Object</code>ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>sync</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Weak</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> Object</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>M</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Manager</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span>    inner</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>ObjectInner</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>M</span><span style=color:#eceff4>>>,</span></span>
<span class=giallo-l><span>    pool</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Weak</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>PoolInner</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>M</span><span style=color:#eceff4>>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>pub</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>crate</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> struct</span><span style=color:#8fbcbb> ObjectInner</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>M</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Manager</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span>    obj</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> M</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Type</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    metrics</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Metrics</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>Weak&lt;PoolInner&lt;M>></code>ã‚’ä¿æŒã—ã¦ã„ã‚‹ã®ã¯ã€dropæ™‚ã«Connectionã‚’Poolã«æˆ»ã™ãŸã‚ã§ã™ã€‚<br> <code>ObjectInner.metrics</code>ã¯ConnectionãŒã„ã¤ä½œæˆã•ã‚Œä½•å›å†åˆ©ç”¨ã•ã‚ŒãŸã‹ã«ã¤ã„ã¦ã®æƒ…å ±ã‚’ä¿æŒã—ã¦ã„ã¾ã™ã€‚<br> <code>Object::drop</code>ã‚’ã¿ã¦ã¿ã‚‹ã¨<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>M</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Manager</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Drop</span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> Object</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>M</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> drop</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>inner</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> = self.</span><span>inner</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>take</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            if let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>pool</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> = self.</span><span>pool</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>upgrade</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span>                pool</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>return_object</span><span style=color:#eceff4>(</span><span>inner</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>Weak::upgrade</code>ã‚’åˆ©ç”¨ã—ã¦<code>PoolInner</code>ã¸ã®å‚ç…§(<code>Arc&lt;PoolInner></code>)ã‚’å–å¾—ã—ã¦ã€<code>PoolInner::return_object</code>ã‚’å‘¼ã³ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>M</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Manager</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> PoolInner</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>M</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> return_object</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> mut</span><span> inner</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> ObjectInner</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>M</span><span style=color:#eceff4>>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> _</span><span style=color:#81a1c1> = self.</span><span>users</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>fetch_sub</span><span style=color:#eceff4>(</span><span style=color:#b48ead>1</span><span style=color:#eceff4>,</span><span> Ordering</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Relaxed</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> slots</span><span style=color:#81a1c1> = self.</span><span>slots</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>lock</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if</span><span> slots</span><span style=color:#81a1c1>.</span><span>size </span><span style=color:#81a1c1>&lt;=</span><span> slots</span><span style=color:#81a1c1>.</span><span>max_size </span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span>            slots</span><span style=color:#81a1c1>.</span><span>vec</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>push_back</span><span style=color:#eceff4>(</span><span>inner</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#88c0d0>            drop</span><span style=color:#eceff4>(</span><span>slots</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>            self.</span><span>semaphore</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>add_permits</span><span style=color:#eceff4>(</span><span style=color:#b48ead>1</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            slots</span><span style=color:#81a1c1>.</span><span>size </span><span style=color:#81a1c1>-=</span><span style=color:#b48ead> 1</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#88c0d0>            drop</span><span style=color:#eceff4>(</span><span>slots</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>            self.</span><span>manager</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>detach</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut</span><span> inner</span><span style=color:#81a1c1>.</span><span>obj</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã“ã“ã§Connectionã‚’ä¿æŒã—ã¦ã„ã‚‹<code>VecDeque::push_back</code>ã‚’ã‚ˆã‚“ã§Connectionã‚’å†ã³ä¿æŒã—ã€semaphoreã®åˆ©ç”¨å¯èƒ½æ•°ã‚’èª¿æ•´ã—ã¦ã„ã¾ã™ã€‚<br> æœ€å¤§åˆ©ç”¨æ•°ã‚’è¶…ãˆã¦ã„ã‚‹å ´åˆã¯ã€<code>Pool</code>ã®ç®¡ç†ä¸‹ã§ãªããªã‚‹ã®ã§ã€<code>Manager::detach</code>ã‚’ã‚³ãƒ¼ãƒ«ã—ã¦ãã‚Œã¾ã™ã€‚<br> ã¨ã„ã†ã“ã¨ã§ã€ConnectionãŒ<code>Object</code>ã§wrapã—ã¦ã„ãŸã®ã¯ã€ãƒ¦ãƒ¼ã‚¶ãŒåˆ©ç”¨ã—çµ‚ã‚ã£ãŸ(drop)Connectionã‚’Poolã«æˆ»ã™ãŸã‚ã®å‡¦ç†ã‚’dropæ™‚ã«è¡Œã†ãŸã‚ã¨ã„ã†ã‚ã‘ã§ã—ãŸã€‚<h2 id=matome><a aria-label="Anchor link for: matome" class=zola-anchor href=#matome>ã¾ã¨ã‚</a></h2><p><a href=https://github.com/bikeshedder/deadpool rel=external><code>deadpool</code></a>ã®åŸºæœ¬çš„ãªä½¿ã„æ–¹ã¨Connectionã®å–å¾—ã¨å†åˆ©ç”¨å‡¦ç†ã«ã¤ã„ã¦ç°¡å˜ã«ã¿ã¦ã„ãã¾ã—ãŸã€‚<br> runtime(<code>tokio</code>,<code>async-std</code>)ã‚’ãƒ¦ãƒ¼ã‚¶å´ã§æŒ‡å®šã§ããŸã‚Šã€managedä»¥å¤–ã«ã‚‚unmanaged moduleã‚‚ã‚ã£ãŸã‚Šã¨ã™ã¹ã¦ã«ã¯è¨€åŠã§ãã¦ã„ãªã„ã®ã§ã™ãŒã€<code>Pool::get</code>ã‚’å‘¼ã‚“ã æ™‚ã«ãªã«ãŒèµ·ãã¦ã„ã‚‹ã‹ã®æ¦‚è¦ã¯æŠŠæ¡ã§ããŸã‹ã¨æ€ã„ã¾ã™ã€‚<br> Connectionã‚’<code>sync::Weak</code>ã‚’ä¿æŒã—ãŸ<code>Object</code>ã§wrapã™ã‚‹ã“ã¨ã§ã€ãƒ¦ãƒ¼ã‚¶ã«æ‰€æœ‰æ¨©ã‚’è¿”ã—ã¤ã¤ã€dropå¾Œã«ãµãŸãŸã³Poolã®ç®¡ç†åŒ–ã«ã‚‚ã©ã™æ–¹æ³•ãŒéå¸¸ã«å‚è€ƒã«ãªã‚Šã¾ã—ãŸã€‚<br> ã¾ãŸãã†ã—ãŸwrapperå‹ã«ã€Connectionã®åˆ©ç”¨çŠ¶æ³ã‚’è¨˜éŒ²ã—ãŸ<code>Status</code>ã‚’ä¿æŒã•ã›ã¦ãŠã‚Šé‹ç”¨æ™‚ã«ã‚‚ä¾¿åˆ©ãã†ã ãªã¨æ€ã„ã¾ã—ãŸã€‚<br> <a href=https://github.com/bikeshedder/deadpool rel=external><code>deadpool</code></a>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã“ã®<code>Pool</code>ã‚’åˆ©ç”¨ã—ãŸ<a href=https://docs.rs/deadpool/latest/deadpool/#database-connection-pools rel=external><code>Manager</code>ã®å®Ÿè£…</a>ãŒæä¾›ã•ã‚Œã¦ã„ã¾ã™ã€‚postgres,diesel, redis, rabbitmq(lapin)ç­‰ãŒã‚ã‚‹ã®ã§ã€åˆ©ç”¨ã—ãŸã„backendãŒã‚ã‚‹å ´åˆã€é¸æŠè‚¢ã®ã²ã¨ã¤ã«ãªã‚‹ã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚</div></article></main><footer class=blog-footer><p>Â© 2026 <a href=https://blog.ymgyt.io> ymgyt </a> | Made with <a href=https://www.getzola.org rel=noopener target=_blank>Zola</a> | <a href=https://github.com/ymgyt/blog>Repository</a> | <a href=https://blog.ymgyt.io/atom.xml target=_blank title=rss> <svg viewbox="0 0 24 24" class=icon fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx=5 cy=19 r=1></circle></svg> </a></footer></div></div>