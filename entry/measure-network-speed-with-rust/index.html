<!doctype html><html lang=ja><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1" name=viewport><link href=https://blog.ymgyt.io/favicon.ico rel=icon sizes=any><link href=https://blog.ymgyt.io/icon.svg rel=icon type=image/svg+xml><link href=https://blog.ymgyt.io/apple-touch-icon.png rel=apple-touch-icon><link href=https://blog.ymgyt.io/manifest.webmanifest rel=manifest><link href=https://blog.ymgyt.io/style.css rel=stylesheet><link href=https://blog.ymgyt.io/atom.xml rel=alternate title=Atom type=application/atom+xml><script src="https://www.googletagmanager.com/gtag/js?id=G-GTB0KMLN90" async></script><script>window.dataLayer = window.dataLayer || [];
	function gtag() {dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-GTB0KMLN90');</script><title>â± Rustã§ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®é€Ÿåº¦ã‚’æ¸¬ã£ã¦ã¿ã‚‹ | Happy developing</title><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><body><div class=world><div class=content-container><header class=blog-header-container><div class=blog-logo><a href=https://blog.ymgyt.io>Happy developing</a></div><div class=blog-nav><nav><ul><li><a href=https://blog.ymgyt.io/entry/>Entries</a><li><a href=https://blog.ymgyt.io/tags/>Tags</a><li><a href=https://blog.ymgyt.io/about/>About</a><li><a href=https://github.com/ymgyt> <img alt=Github class=icon src=https://blog.ymgyt.io/images/icon/github.svg> </a><li><a href="https://twitter.com/YAmaguchixt "> <img alt=Twitter class=icon src=https://blog.ymgyt.io/images/icon/twitter.svg> </a></ul></nav></div></header><main class=blog-main><article><header class=entry-header><h1 class=entry-title>â± Rustã§ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®é€Ÿåº¦ã‚’æ¸¬ã£ã¦ã¿ã‚‹</h1><div class=entry-meta><p class=entry-meta-item>ğŸ—“ 2020-02-15<p class=entry-meta-item>ğŸ· <span class=tag><a href=https://blog.ymgyt.io/tags/rust/>rust</a></span></div></header><aside class=entry-toc><nav><ul class=entry-toc-toplevel-list><li><a href=https://blog.ymgyt.io/entry/measure-network-speed-with-rust/#install>Install</a> <ul><li><a href=https://blog.ymgyt.io/entry/measure-network-speed-with-rust/#brew>brew</a><li><a href=https://blog.ymgyt.io/entry/measure-network-speed-with-rust/#cargo>cargo</a></ul><li><a href=https://blog.ymgyt.io/entry/measure-network-speed-with-rust/#ce-tutemiru>æ¸¬ã£ã¦ã¿ã‚‹</a><li><a href=https://blog.ymgyt.io/entry/measure-network-speed-with-rust/#localdeshi-su>localã§è©¦ã™</a></ul></nav></aside><div class=entry-content><p>ä¼šç¤¾ã®å›ç·šãŒé…ã„ãªã¨æ„Ÿã˜ã€å…·ä½“çš„ãªæ•°å­—ã‚’æ¸¬ã£ã¦ã¿ãŸããªã£ãŸã®ã§ã€Rustã§tcpã®throughputã‚’è¨ˆæ¸¬ã™ã‚‹cliã‚’ä½œã£ã¦ã¿ã¾ã—ãŸã€‚ <a href=https://github.com/ymgyt/netspeed rel=external>source codeã¯ã“ã¡ã‚‰</a><h2 id=install><a aria-label="Anchor link for: install" class=zola-anchor href=#install>Install</a></h2><p><code>cargo</code>ã¨<code>brew</code>ã§installã§ãã¾ã™ã€‚<h3 id=brew><a aria-label="Anchor link for: brew" class=zola-anchor href=#brew>brew</a></h3><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>$ brew tap ymgyt/netspeed</span></span>
<span class=giallo-l><span>$ brew install netspeed</span></span></code></pre><h3 id=cargo><a aria-label="Anchor link for: cargo" class=zola-anchor href=#cargo>cargo</a></h3><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>cargo install netspeed</span></span></code></pre><h2 id=ce-tutemiru><a aria-label="Anchor link for: ce-tutemiru" class=zola-anchor href=#ce-tutemiru>æ¸¬ã£ã¦ã¿ã‚‹</a></h2><p>äº‹å‰ã«EC2ä¸Šã§<code>netspeed server run</code>ã‚’å®Ÿè¡Œã—ã¦serverã‚’èµ·å‹•ã—ã¦ã‚ã‚Šã¾ã™ã€‚defaultã§ã¯ã“ã®serverã¸ã®æ¥ç¶šã‚’è©¦ã¿ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>netspeed</span><span>  </span></span>
<span class=giallo-l><span style=color:#88c0d0>INFO</span><span style=color:#a3be8c>  Connecting to</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>netspeed.ymgyt.io:5555</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#88c0d0>INFO</span><span style=color:#a3be8c>  Start downstream duration:</span><span style=color:#b48ead> 3</span><span style=color:#a3be8c> seconds</span></span>
<span class=giallo-l><span style=color:#88c0d0>INFO</span><span style=color:#a3be8c>  Start upstream duration:</span><span style=color:#b48ead> 3</span><span style=color:#a3be8c> seconds</span></span>
<span class=giallo-l><span style=color:#88c0d0>Downstream:</span><span style=color:#b48ead> 24.00</span><span style=color:#a3be8c> Mbps</span></span>
<span class=giallo-l><span style=color:#88c0d0>  Upstream:</span><span style=color:#b48ead> 122.67</span><span style=color:#a3be8c> Mbps</span></span></code></pre><p>åŒæ™‚å®Ÿè¡Œæ•°ã«åˆ¶é™ã‚’ã‹ã‘ã¦ã„ã‚‹ã®ã§ã€ä¸Šé™ã‚’ã“ãˆã¦åŒæ™‚ã«å®Ÿè¡Œã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>while true; do netspeed &; done</span></span></code></pre><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>ERROR Server decline speed test. Cause: max threads exceeded(100)</span></span></code></pre><p>æ¸¬ã‚Šæ–¹ã¨ã—ã¦ã¯ã€tcpæ¥ç¶šãŒã§ããŸã‚‰ã€ä»¥ä¸‹ã®ã‚ˆã†ãªãŠã‚ŒãŠã‚Œãƒ—ãƒ­ãƒˆã‚³ãƒ«ã§serverã«ã‚„ã‚ŠãŸã„ã“ã¨ã‚’é€šçŸ¥ã—ã¦ã€1MBã®read/writeã®loopã‚’æŒ‡å®šã®æ™‚é–“å†…ã¾ã‚ã—ã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[repr(</span><span style=color:#8fbcbb>u8</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Debug</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Eq</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> PartialEq</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub enum</span><span style=color:#8fbcbb> Command</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Ping</span><span style=color:#81a1c1> =</span><span style=color:#b48ead> 1</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    RequestDownstream</span><span style=color:#81a1c1> =</span><span style=color:#b48ead> 2</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    RequestUpstream</span><span style=color:#81a1c1> =</span><span style=color:#b48ead> 3</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    SendBuffer</span><span style=color:#81a1c1> =</span><span style=color:#b48ead> 4</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Complete</span><span style=color:#81a1c1> =</span><span style=color:#b48ead> 5</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Ready</span><span style=color:#81a1c1> =</span><span style=color:#b48ead> 6</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Decline</span><span style=color:#81a1c1> =</span><span style=color:#b48ead> 7</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Close</span><span style=color:#81a1c1> =</span><span style=color:#b48ead> 100</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> From</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Command</span><span style=color:#eceff4>></span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> u8</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> from</span><span style=color:#eceff4>(</span><span>cmd</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Command</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        match</span><span> cmd</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Command</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Ping</span><span style=color:#81a1c1> =></span><span style=color:#b48ead> 1</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Command</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>RequestDownstream</span><span style=color:#81a1c1> =></span><span style=color:#b48ead> 2</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Command</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>RequestUpstream</span><span style=color:#81a1c1> =></span><span style=color:#b48ead> 3</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Command</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>SendBuffer</span><span style=color:#81a1c1> =></span><span style=color:#b48ead> 4</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Command</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Complete</span><span style=color:#81a1c1> =></span><span style=color:#b48ead> 5</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Command</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Ready</span><span style=color:#81a1c1> =></span><span style=color:#b48ead> 6</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Command</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Decline</span><span style=color:#81a1c1> =></span><span style=color:#b48ead> 7</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Command</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Close</span><span style=color:#81a1c1> =></span><span style=color:#b48ead> 100</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> TryFrom</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>u8</span><span style=color:#eceff4>></span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> Command</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Error</span><span style=color:#81a1c1> =</span><span> anyhow</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> try_from</span><span style=color:#eceff4>(</span><span>n</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> u8</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>Self</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        match</span><span> n</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#b48ead>            1</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Command</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Ping</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#b48ead>            2</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Command</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>RequestDownstream</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#b48ead>            3</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Command</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>RequestUpstream</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#b48ead>            4</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Command</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>SendBuffer</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#b48ead>            5</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Command</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Complete</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#b48ead>            6</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Command</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Ready</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#b48ead>            7</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Command</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Decline</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#b48ead>            100</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Command</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Close</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span>            _</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span style=color:#88c0d0;font-weight:700>anyhow!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Invalid number </span><span style=color:#ebcb8b>{}</span><span style=color:#a3be8c> for command</span><span style=color:#eceff4>",</span><span> n</span><span style=color:#eceff4>)),</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span></code></pre><p>https://github.com/ymgyt/netspeed/blob/master/src/command.rs<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use crate::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> anyhow</span><span style=color:#81a1c1>::</span><span>anyhow</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> byteorder</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>BigEndian</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> ReadBytesExt</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> WriteBytesExt</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span>    convert</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>From</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> TryFrom</span><span style=color:#eceff4>},</span></span>
<span class=giallo-l><span>    io</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>Read</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Write</span><span style=color:#eceff4>},</span></span>
<span class=giallo-l><span>    net</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>Shutdown</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> TcpStream</span><span style=color:#eceff4>},</span></span>
<span class=giallo-l><span>    time</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#81a1c1>self</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Duration</span><span style=color:#eceff4>},</span></span>
<span class=giallo-l><span style=color:#eceff4>};</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> Operator</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    conn</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> TcpStream</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Operator</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> new</span><span style=color:#eceff4>(</span><span>conn</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> TcpStream</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        Self</span><span style=color:#eceff4> {</span><span> conn</span><span style=color:#eceff4> }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> ping_write_then_read</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span style=color:#88c0d0>write_ping</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>and</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span style=color:#88c0d0>read_ping</span><span style=color:#eceff4>())</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> ping_read_then_write</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span style=color:#88c0d0>read_ping</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>and</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span style=color:#88c0d0>write_ping</span><span style=color:#eceff4>())</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> write_ping</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span style=color:#88c0d0>write</span><span style=color:#eceff4>(</span><span>Command</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Ping</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> read_ping</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span style=color:#88c0d0>expect</span><span style=color:#eceff4>(</span><span>Command</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Ping</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> request_downstream</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> duration</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Duration</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span style=color:#88c0d0>write</span><span style=color:#eceff4>(</span><span>Command</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>RequestDownstream</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>and_then</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>_</span><span style=color:#81a1c1>| self.</span><span style=color:#88c0d0>write_duration</span><span style=color:#eceff4>(</span><span>duration</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>and_then</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>_</span><span style=color:#81a1c1>| self.</span><span style=color:#88c0d0>flush</span><span style=color:#eceff4>())</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> request_upstream</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> duration</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Duration</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span style=color:#88c0d0>write</span><span style=color:#eceff4>(</span><span>Command</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>RequestUpstream</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>and_then</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>_</span><span style=color:#81a1c1>| self.</span><span style=color:#88c0d0>write_duration</span><span style=color:#eceff4>(</span><span>duration</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>and_then</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>_</span><span style=color:#81a1c1>| self.</span><span style=color:#88c0d0>flush</span><span style=color:#eceff4>())</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> write_loop</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> timeout</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Duration</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>u64</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> start</span><span style=color:#81a1c1> =</span><span> time</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Instant</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>now</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> write_bytes</span><span style=color:#81a1c1> =</span><span style=color:#b48ead> 0</span><span style=color:#8fbcbb>u64</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> buff</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> [</span><span style=color:#b48ead>0</span><span style=color:#8fbcbb>u8</span><span style=color:#eceff4>;</span><span style=color:#81a1c1> crate::</span><span>BUFFER_SIZE</span><span style=color:#eceff4>];</span></span>
<span class=giallo-l><span style=color:#81a1c1>        loop</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            if</span><span> start</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>elapsed</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> >=</span><span> timeout</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                break</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#81a1c1>            self.</span><span style=color:#88c0d0>send_buffer</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>buff</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span>            write_bytes</span><span style=color:#81a1c1> =</span><span> write_bytes</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>saturating_add</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>crate::</span><span>BUFFER_SIZE</span><span style=color:#81a1c1> as</span><span style=color:#8fbcbb> u64</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span style=color:#88c0d0>write</span><span style=color:#eceff4>(</span><span>Command</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Complete</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Ok</span><span style=color:#eceff4>(</span><span>write_bytes</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> read_loop</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>u64</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> buff</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> [</span><span style=color:#b48ead>0</span><span style=color:#8fbcbb>u8</span><span style=color:#eceff4>;</span><span style=color:#81a1c1> crate::</span><span>BUFFER_SIZE</span><span style=color:#eceff4>];</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> read_bytes</span><span style=color:#81a1c1> =</span><span style=color:#b48ead> 0</span><span style=color:#8fbcbb>u64</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        loop</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            match self.</span><span style=color:#88c0d0>read</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>?</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Command</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>SendBuffer</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    self.</span><span style=color:#88c0d0>receive_buffer</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut</span><span> buff</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span>                    read_bytes</span><span style=color:#81a1c1> =</span><span> read_bytes</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>saturating_add</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>crate::</span><span>BUFFER_SIZE</span><span style=color:#81a1c1> as</span><span style=color:#8fbcbb> u64</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Command</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Complete</span><span style=color:#81a1c1> => return</span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>(</span><span>read_bytes</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span>                _</span><span style=color:#81a1c1> => return</span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span style=color:#88c0d0;font-weight:700>anyhow!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Unexpected command</span><span style=color:#eceff4>")),</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> send_buffer</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> buff</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>[</span><span style=color:#8fbcbb>u8</span><span style=color:#eceff4>])</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span style=color:#88c0d0>write</span><span style=color:#eceff4>(</span><span>Command</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>SendBuffer</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Write</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>by_ref</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self.</span><span>conn</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write_all</span><span style=color:#eceff4>(</span><span>buff</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span style=color:#88c0d0>flush</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> receive_buffer</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> buff</span><span style=color:#81a1c1>: &mut</span><span style=color:#eceff4> [</span><span style=color:#8fbcbb>u8</span><span style=color:#eceff4>])</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Read</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>by_ref</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self.</span><span>conn</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>read_exact</span><span style=color:#eceff4>(</span><span>buff</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>map_err</span><span style=color:#eceff4>(</span><span>anyhow</span><span style=color:#81a1c1>::</span><span>Error</span><span style=color:#81a1c1>::</span><span>from</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> write</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> cmd</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Command</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Write</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>by_ref</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self.</span><span>conn</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>write_u8</span><span style=color:#eceff4>(</span><span>cmd</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>())</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>map_err</span><span style=color:#eceff4>(</span><span>anyhow</span><span style=color:#81a1c1>::</span><span>Error</span><span style=color:#81a1c1>::</span><span>from</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> read</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Command</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Command</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>try_from</span><span style=color:#eceff4>(</span><span>Read</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>by_ref</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self.</span><span>conn</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>read_u8</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> write_duration</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> duration</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Duration</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Write</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>by_ref</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self.</span><span>conn</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>write_u64</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>BigEndian</span><span style=color:#eceff4>>(</span><span>duration</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_secs</span><span style=color:#eceff4>())</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>map_err</span><span style=color:#eceff4>(</span><span>anyhow</span><span style=color:#81a1c1>::</span><span>Error</span><span style=color:#81a1c1>::</span><span>from</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> read_duration</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Duration</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Read</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>by_ref</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self.</span><span>conn</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>read_u64</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>BigEndian</span><span style=color:#eceff4>>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>map_err</span><span style=color:#eceff4>(</span><span>anyhow</span><span style=color:#81a1c1>::</span><span>Error</span><span style=color:#81a1c1>::</span><span>from</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>map</span><span style=color:#eceff4>(</span><span>Duration</span><span style=color:#81a1c1>::</span><span>from_secs</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> expect</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> expect</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Command</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> actual</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Command</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>try_from</span><span style=color:#eceff4>(</span><span>Read</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>by_ref</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self.</span><span>conn</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>read_u8</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if</span><span> actual</span><span style=color:#81a1c1> !=</span><span> expect</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Err</span><span style=color:#eceff4>(</span><span style=color:#88c0d0;font-weight:700>anyhow!</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>                "</span><span style=color:#a3be8c>Unexpected command. expect: </span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>:?</span><span style=color:#ebcb8b>}</span><span style=color:#a3be8c>, actual: </span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>:?</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span>                expect</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>                actual</span></span>
<span class=giallo-l><span style=color:#eceff4>            ))</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Ok</span><span style=color:#eceff4>(())</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> write_decline</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> reason</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> DeclineReason</span><span style=color:#eceff4>,</span><span> shutdown</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> bool</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span style=color:#88c0d0>write</span><span style=color:#eceff4>(</span><span>Command</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Decline</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>and</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span style=color:#88c0d0>write_decline_reason</span><span style=color:#eceff4>(</span><span>reason</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>and</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span style=color:#88c0d0>flush</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        if</span><span> shutdown</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            self.</span><span>conn</span></span>
<span class=giallo-l><span style=color:#81a1c1>                .</span><span style=color:#88c0d0>shutdown</span><span style=color:#eceff4>(</span><span>Shutdown</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Both</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>                .</span><span style=color:#88c0d0>map_err</span><span style=color:#eceff4>(</span><span>anyhow</span><span style=color:#81a1c1>::</span><span>Error</span><span style=color:#81a1c1>::</span><span>from</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Ok</span><span style=color:#eceff4>(())</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> write_decline_reason</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> reason</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> DeclineReason</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> v</span><span style=color:#81a1c1> = match</span><span> reason</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            DeclineReason</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>MaxThreadsExceed</span><span style=color:#eceff4>(</span><span>max_threads</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>                // reason:32bit | description: 32bit</span></span>
<span class=giallo-l><span style=color:#81a1c1>                let mut</span><span> v</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> u64</span><span style=color:#81a1c1> =</span><span style=color:#b48ead> 1</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span>                v</span><span style=color:#81a1c1> &lt;&lt;=</span><span style=color:#b48ead> 32</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span>                v</span><span style=color:#81a1c1> +=</span><span> max_threads</span><span style=color:#81a1c1> as</span><span style=color:#8fbcbb> u64</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span>                v</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            DeclineReason</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Unknown</span><span style=color:#81a1c1> =></span><span style=color:#b48ead> 0</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>        };</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Write</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>by_ref</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self.</span><span>conn</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>write_u64</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>BigEndian</span><span style=color:#eceff4>>(</span><span>v</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>map_err</span><span style=color:#eceff4>(</span><span>anyhow</span><span style=color:#81a1c1>::</span><span>Error</span><span style=color:#81a1c1>::</span><span>from</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> read_decline_reason</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>DeclineReason</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> v</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Read</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>by_ref</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self.</span><span>conn</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>read_u64</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>BigEndian</span><span style=color:#eceff4>>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>map_err</span><span style=color:#eceff4>(</span><span>anyhow</span><span style=color:#81a1c1>::</span><span>Error</span><span style=color:#81a1c1>::</span><span>from</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> reason</span><span style=color:#81a1c1> =</span><span> v</span><span style=color:#81a1c1> >></span><span style=color:#b48ead> 32</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> detail</span><span style=color:#81a1c1> =</span><span> v</span><span style=color:#81a1c1> &</span><span style=color:#eceff4> (</span><span>std</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>u32</span><span style=color:#81a1c1>::</span><span>MAX</span><span style=color:#81a1c1> as</span><span style=color:#8fbcbb> u64</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if</span><span> reason</span><span style=color:#81a1c1> ==</span><span style=color:#b48ead> 1</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Ok</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>DeclineReason</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>MaxThreadsExceed</span><span style=color:#eceff4>(</span><span>detail</span><span style=color:#81a1c1> as</span><span style=color:#8fbcbb> u32</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Ok</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>DeclineReason</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Unknown</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> flush</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Write</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>by_ref</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self.</span><span>conn</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>flush</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>map_err</span><span style=color:#eceff4>(</span><span>anyhow</span><span style=color:#81a1c1>::</span><span>Error</span><span style=color:#81a1c1>::</span><span>from</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><h2 id=localdeshi-su><a aria-label="Anchor link for: localdeshi-su" class=zola-anchor href=#localdeshi-su>localã§è©¦ã™</a></h2><p>localã§è©¦ã™ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã™ã€‚<p>terminal1<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>netspeed</span><span style=color:#a3be8c> server run</span><span>  </span></span>
<span class=giallo-l><span style=color:#88c0d0>INFO</span><span style=color:#a3be8c>  2020-02-15T13:01:56.892922+00:00 Listening on</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>0.0.0.0:5555</span><span style=color:#eceff4>"</span><span style=color:#a3be8c> max threads:</span><span style=color:#b48ead> 100</span></span>
<span class=giallo-l><span style=color:#88c0d0>INFO</span><span style=color:#a3be8c>  2020-02-15T13:02:04.785769+00:00 Pass concurrent threads check.</span><span> (0/100)</span></span>
<span class=giallo-l><span style=color:#88c0d0>INFO</span><span style=color:#a3be8c>  2020-02-15T13:02:04.786067+00:00 Handle incoming connection. dispatch worker 127.0.0.1:53013 actives:</span><span style=color:#b48ead> 1</span></span>
<span class=giallo-l><span style=color:#88c0d0>INFO</span><span style=color:#a3be8c>  2020-02-15T13:02:04.786480+00:00</span><span> (Worker:127.0.0.1:53013) =</span><span style=color:#81a1c1>></span><span> Handle downstream</span></span>
<span class=giallo-l><span style=color:#88c0d0>INFO</span><span style=color:#a3be8c>  2020-02-15T13:02:07.787380+00:00</span><span> (Worker:127.0.0.1:53013) =</span><span style=color:#81a1c1>></span><span> Successfully handle downstream</span></span>
<span class=giallo-l><span style=color:#88c0d0>INFO</span><span style=color:#a3be8c>  2020-02-15T13:02:07.787475+00:00</span><span> (Worker:127.0.0.1:53013) =</span><span style=color:#81a1c1>></span><span> Handle upstream</span></span>
<span class=giallo-l><span style=color:#88c0d0>INFO</span><span style=color:#a3be8c>  2020-02-15T13:02:10.840054+00:00</span><span> (Worker:127.0.0.1:53013) =</span><span style=color:#81a1c1>></span><span> Successfully handle upstream</span></span></code></pre><p>terminal2<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>netspeed</span><span style=color:#a3be8c> --addr 127.0.0.1:5555</span></span>
<span class=giallo-l><span style=color:#88c0d0>INFO</span><span style=color:#a3be8c>  Connecting to</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>127.0.0.1:5555</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#88c0d0>INFO</span><span style=color:#a3be8c>  Start downstream duration:</span><span style=color:#b48ead> 3</span><span style=color:#a3be8c> seconds</span></span>
<span class=giallo-l><span style=color:#88c0d0>INFO</span><span style=color:#a3be8c>  Start upstream duration:</span><span style=color:#b48ead> 3</span><span style=color:#a3be8c> seconds</span></span>
<span class=giallo-l><span style=color:#88c0d0>Downstream:</span><span style=color:#b48ead> 19.93</span><span style=color:#a3be8c> Gbps</span></span>
<span class=giallo-l><span style=color:#88c0d0>  Upstream:</span><span style=color:#b48ead> 20.39</span><span style=color:#a3be8c> Gbps</span></span></code></pre></div></article></main><footer class=blog-footer><p>Â© 2026 <a href=https://blog.ymgyt.io> ymgyt </a> | Made with <a href=https://www.getzola.org rel=noopener target=_blank>Zola</a> | <a href=https://github.com/ymgyt/blog>Repository</a> | <a href=https://blog.ymgyt.io/atom.xml target=_blank title=rss> <svg viewbox="0 0 24 24" class=icon fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx=5 cy=19 r=1></circle></svg> </a></footer></div></div>