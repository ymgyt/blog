<!doctype html><html lang=ja><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1" name=viewport><link href=https://blog.ymgyt.io/favicon.ico rel=icon sizes=any><link href=https://blog.ymgyt.io/icon.svg rel=icon type=image/svg+xml><link href=https://blog.ymgyt.io/apple-touch-icon.png rel=apple-touch-icon><link href=https://blog.ymgyt.io/manifest.webmanifest rel=manifest><link href=https://blog.ymgyt.io/style.css rel=stylesheet><link href=https://blog.ymgyt.io/atom.xml rel=alternate title=Atom type=application/atom+xml><script src="https://www.googletagmanager.com/gtag/js?id=G-GTB0KMLN90" async></script><script>window.dataLayer = window.dataLayer || [];
	function gtag() {dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-GTB0KMLN90');</script><title>ğŸ¦€ RFC8628 OAuth 2.0 Device Authorization Grantã§CLIã‹ã‚‰Githubã®access tokenã‚’å–å¾—ã™ã‚‹ | Happy developing</title><meta content="é€šç§°Device flowã‚’Rustã§å®Ÿè£…ã™ã‚‹" name=description><meta content=summary name=twitter:card><meta content="@YAmaguchixt " name=twitter:site><meta content="ğŸ¦€ RFC8628 OAuth 2.0 Device Authorization Grantã§CLIã‹ã‚‰Githubã®access tokenã‚’å–å¾—ã™ã‚‹" name=twitter:title><meta content="é€šç§°Device flowã‚’Rustã§å®Ÿè£…ã™ã‚‹" name=twitter:description><meta content=https://blog.ymgyt.io/images/emoji/crab.png name=twitter:image><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><body><div class=world><div class=content-container><header class=blog-header-container><div class=blog-logo><a href=https://blog.ymgyt.io>Happy developing</a></div><div class=blog-nav><nav><ul><li><a href=https://blog.ymgyt.io/entry/>Entries</a><li><a href=https://blog.ymgyt.io/tags/>Tags</a><li><a href=https://blog.ymgyt.io/about/>About</a><li><a href=https://github.com/ymgyt> <img alt=Github class=icon src=https://blog.ymgyt.io/images/icon/github.svg> </a><li><a href="https://twitter.com/YAmaguchixt "> <img alt=Twitter class=icon src=https://blog.ymgyt.io/images/icon/twitter.svg> </a></ul></nav></div></header><main class=blog-main><article><header class=entry-header><h1 class=entry-title>ğŸ¦€ RFC8628 OAuth 2.0 Device Authorization Grantã§CLIã‹ã‚‰Githubã®access tokenã‚’å–å¾—ã™ã‚‹</h1><div class=entry-meta><p class=entry-meta-item>ğŸ—“ 2023-11-18<p class=entry-meta-item>ğŸ· <span class=tag><a href=https://blog.ymgyt.io/tags/rust/>rust</a></span></div></header><aside class=entry-toc><nav><ul class=entry-toc-toplevel-list><li><a href=https://blog.ymgyt.io/entry/rfc8628-oauth2-device-authorization-grant-handson/#gai-yao>æ¦‚è¦</a><li><a href=https://blog.ymgyt.io/entry/rfc8628-oauth2-device-authorization-grant-handson/#device-authorization-granttoha>Device Authorization Grantã¨ã¯</a><li><a href=https://blog.ymgyt.io/entry/rfc8628-oauth2-device-authorization-grant-handson/#requirements-for-device-authorization-grant>Requirements for device authorization grant</a><li><a href=https://blog.ymgyt.io/entry/rfc8628-oauth2-device-authorization-grant-handson/#device-authorization-grantnoliu-re>Device Authorization Grantã®æµã‚Œ</a><li><a href=https://blog.ymgyt.io/entry/rfc8628-oauth2-device-authorization-grant-handson/#shi-qian-zhun-bei>äº‹å‰æº–å‚™</a><li><a href=https://blog.ymgyt.io/entry/rfc8628-oauth2-device-authorization-grant-handson/#device-authorization-request>Device Authorization Request</a><li><a href=https://blog.ymgyt.io/entry/rfc8628-oauth2-device-authorization-grant-handson/#device-access-token-request>Device Access Token Request</a><li><a href=https://blog.ymgyt.io/entry/rfc8628-oauth2-device-authorization-grant-handson/#matome>ã¾ã¨ã‚</a></ul></nav></aside><div class=entry-content><p>æœ¬è¨˜äº‹ã§ã¯<a href=https://datatracker.ietf.org/doc/html/rfc8628 rel=external>RFC8628 OAuth 2.0 Device Authorization Grant</a>ã‚’èª­ã¿ãªãŒã‚‰Githubã®access tokenã‚’å–å¾—ã™ã‚‹CLIã‚’rustã§å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚<p>ä½œæˆã—ãŸCLIã¯<a href=https://github.com/ymgyt/yaru/blob/078649cb201a7adafcbed4e3633bdb3a7b846553/yaru/src/cli/login/oauth.rs#L33 rel=external>ã“ã¡ã‚‰</a><h2 id=gai-yao><a aria-label="Anchor link for: gai-yao" class=zola-anchor href=#gai-yao>æ¦‚è¦</a></h2><p>CLIã‹ã‚‰<a href=https://datatracker.ietf.org/doc/html/rfc6749 rel=external>OAuth</a>ã®<a href=https://datatracker.ietf.org/doc/html/rfc6749#section-4.1 rel=external>authorization code grant</a>ã‚„<a href=https://datatracker.ietf.org/doc/html/rfc6749#section-4.2 rel=external>implicit grant</a>ã‚’åˆ©ç”¨ã—ã¦ã€Githubç­‰ã®authorization serverã‹ã‚‰access tokenã‚’å–å¾—ã—ãŸã„å ´åˆã€userãŒCLI applicationã¸ã®æ¨©é™å§”è­²ã«åŒæ„ã—ãŸã‚ã¨ã€authorization serverã‹ã‚‰ã®redirectã‚’ã†ã‘ã‚‹http serverãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚<br> CLIã®å ´åˆã€localhostã§listenã—ã¦ã„ã‚‹http serverã‚’èµ·å‹•ã—ã¦ãŠãã€authorization serverã‹ã‚‰<code>http://localhost:8080</code>ç­‰ã¸redirectã•ã›ã‚‹ã¨ã„ã†æ–¹æ³•ã‚‚è€ƒãˆã‚‰ã‚Œã¾ã™ãŒã€ä»¥ä¸‹ã®å•é¡ŒãŒã‚ã‚‹ã¨æ€ã„ã¾ã—ãŸã€‚<ul><li>æŒ‡å®šã®portã§listenã§ãã‚‹ã¨ã¯é™ã‚‰ãªã„<li>åŒä¸€hostã§CLIã‚’è¤‡æ•°å€‹åŒæ™‚ã«èµ·å‹•ã™ã‚‹ã¨portãŒè¡çªã™ã‚‹</ul><p>PortãŒæ—¢ã«åˆ©ç”¨ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€åˆ©ç”¨portã‚’incrementã—ã¦ä½¿ãˆã‚‹portã‚’è¦‹ã¤ã‘ã‚‹å‡¦ç†ã‚’è¡Œã†ã“ã¨ã§ã€å¯¾å¿œã§ãã‚‹ã‹ãªã¨è€ƒãˆã¦ã„ãŸã¨ã“ã‚ã€æœ¬ä»•æ§˜ã‚’è¦‹ã¤ã‘ã¾ã—ãŸã€‚<br> RFC8628ã‚’ä½¿ãˆã°ã€http serverã‚’å»ºã¦ã‚‹ã“ã¨ãªãOAuthã®èªå¯å‡¦ç†ã‚’è¡Œã†ã“ã¨ãŒã§ããŸã®ã§ã€æœ¬è¨˜äº‹ã§ã¯rustã§å®Ÿè£…ã—ãªãŒã‚‰ãã®éç¨‹ã‚’ã¿ã¦ã„ã“ã†ã¨æ€ã„ã¾ã™ã€‚<p>ç›®æ¨™ã¯ä»¥ä¸‹ã®å‡¦ç†ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#616e88># CLIã‹ã‚‰å‡¦ç†ã‚’èµ·å‹•</span></span>
<span class=giallo-l><span style=color:#88c0d0>myapp</span><span style=color:#a3be8c> login</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>Open</span><span style=color:#eceff4> `</span><span style=color:#88c0d0>https://github.com/login/device</span><span style=color:#eceff4>`</span><span style=color:#88c0d0> on</span><span style=color:#a3be8c> your browser</span></span>
<span class=giallo-l><span style=color:#88c0d0>Enter</span><span style=color:#a3be8c> CODE:</span><span style=color:#eceff4> `</span><span style=color:#88c0d0>5XXX-3YYY</span><span style=color:#eceff4>`</span></span></code></pre><p>CLIã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€codeå…¥åŠ›ç”»é¢ãŒbrowserã«è¡¨ç¤ºã•ã‚Œã‚‹ã®ã§<p><img alt="Device Flow Code Input Page" src=https://blog.ymgyt.io/entry/rfc8628-oauth2-device-authorization-grant-handson/images/device-flow-ss-1.png><p>Githubä¸Šã®ç”»é¢ã§codeã‚’å…¥åŠ›ã™ã‚‹ã¨ã€access tokenã‚’å–å¾—ã§ãã¾ã™ã€‚<h2 id=device-authorization-granttoha><a aria-label="Anchor link for: device-authorization-granttoha" class=zola-anchor href=#device-authorization-granttoha>Device Authorization Grantã¨ã¯</a></h2><p>ä¸€è¨€ã§èª¬æ˜ã™ã‚‹ã¨ã€userã®æ¨©é™å§”è­²ã‚’è¡¨ã™grant codeã‚’redirectã«ã‚ˆã‚‹inboundã®http requestã‹ã‚‰å–å¾—ã™ã‚‹ã®ã§ã¯ãªãã€authorization serverã«pollingã—ã¦å–å¾—ã™ã‚‹æ–¹å¼ã§ã™ã€‚<p>ä»•æ§˜ã®<a href=https://datatracker.ietf.org/doc/html/rfc8628#section-1 rel=external>1 Introduction</a>ã§ã¯<blockquote><p>This OAuth 2.0 <a href=https://datatracker.ietf.org/doc/html/rfc6749 rel=external>RFC6749</a> protocol extension enables OAuth clients to request user authorization from applications on devices that have limited input capabilities or lack a suitable browser.</blockquote><p>ã¨ã‚ã‚Šã€ä»Šå›ã®CLIã§ã¯http serverã‚’ç”¨ã„ãªã„ç‚ºã€http requestã‚’å‡¦ç†ã§ããªã„ã®ã§ã€lack a suitable browserã«ã‚ãŸã‚‹ã§ã—ã‚‡ã†ã‹ã€‚<p>ã¾ãŸã€<blockquote><p>The authorization flow defined by this specification, sometimes referred to as the "device flow", instructs the user to review the authorization request on a secondary device, such as a smartphone, which does have the requisite input and browser capabilities to complete the user interaction.</blockquote><p>ã¨ã‚ã‚Šã€Device Authorization Grantã¯device flowã¨ã‚‚å‘¼ã°ã‚Œã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚Githubã§ã‚‚device flowã¨ã—ã¦æ‰±ã‚ã‚Œã¦ã„ã¾ã—ãŸã€‚<p>ãã—ã¦<blockquote><p>The device authorization grant is not intended to replace browser-based OAuth in native apps on capable devices like smartphones. Those apps should follow the practices specified in "OAuth 2.0 for Native Apps" <a href=https://datatracker.ietf.org/doc/html/rfc8252 rel=external>RFC8252</a>.</blockquote><p>ã¨ã‚ã‚Šã€native appç­‰ã§ã¯device flowã‚’ä½¿ã†ã¹ãã§ã¯ãªã„ã‚ˆã†ã§ã™ã€‚<h2 id=requirements-for-device-authorization-grant><a aria-label="Anchor link for: requirements-for-device-authorization-grant" class=zola-anchor href=#requirements-for-device-authorization-grant>Requirements for device authorization grant</a></h2><p>ä»•æ§˜ã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã€device flowã®ãŸã‚ã®è¦æ±‚äº‹é …ã¯<ol><li>Internetã«æ¥ç¶šã•ã‚Œã¦ã„ã‚‹ã“ã¨<li>Outbound http requestãŒã§ãã‚‹ã“ã¨<li>URIã¨code sequenceã‚’userã«è¡¨ç¤ºã§ãã‚‹ã“ã¨<li>Userã¯requestã‚’å‡¦ç†ã™ã‚‹ãŸã‚ã«åˆ¥ã®device(personal computer, smartphoneç­‰)ã‚’ã‚‚ã£ã¦ã„ã‚‹ã“ã¨</ol><p>ã¨å®šç¾©ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚<br> CLIã¨ã—ã¦ã¯browserã‹smartphoneã‚’userãŒä½¿ãˆã‚‹ã“ã¨ã‚’æœŸå¾…ã™ã‚‹ã®ã¯ç‰¹ã«å•é¡Œãªã„ã¨ã„ãˆãã†ã§ã™ã€‚<h2 id=device-authorization-grantnoliu-re><a aria-label="Anchor link for: device-authorization-grantnoliu-re" class=zola-anchor href=#device-authorization-grantnoliu-re>Device Authorization Grantã®æµã‚Œ</a></h2><p>Device authorization grantã«ãŠã„ã¦ã€å„ç¨®æƒ…å ±ãŒã©ã®ã‚ˆã†ã«ã‚„ã‚Šå–ã‚Šã•ã‚Œã‚‹ã‹ã¿ã¦ã„ãã¾ã™ã€‚<a href=https://datatracker.ietf.org/doc/html/rfc8628#section-1 rel=external>Introduction Figure 1</a>ãŒã‚ã‹ã‚Šã‚„ã™ã„ã®ã§å¼•ç”¨ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>      +----------+                                +----------------+</span></span>
<span class=giallo-l><span>      |          |>---(A)-- Client Identifier --->|                |</span></span>
<span class=giallo-l><span>      |          |                                |                |</span></span>
<span class=giallo-l><span>      |          |&lt;---(B)-- Device Code,      ---&lt;|                |</span></span>
<span class=giallo-l><span>      |          |          User Code,            |                |</span></span>
<span class=giallo-l><span>      |  Device  |          & Verification URI    |                |</span></span>
<span class=giallo-l><span>      |  Client  |                                |                |</span></span>
<span class=giallo-l><span>      |          |  [polling]                     |                |</span></span>
<span class=giallo-l><span>      |          |>---(E)-- Device Code       --->|                |</span></span>
<span class=giallo-l><span>      |          |          & Client Identifier   |                |</span></span>
<span class=giallo-l><span>      |          |                                |  Authorization |</span></span>
<span class=giallo-l><span>      |          |&lt;---(F)-- Access Token      ---&lt;|     Server     |</span></span>
<span class=giallo-l><span>      +----------+   (& Optional Refresh Token)   |                |</span></span>
<span class=giallo-l><span>            v                                     |                |</span></span>
<span class=giallo-l><span>            :                                     |                |</span></span>
<span class=giallo-l><span>           (C) User Code & Verification URI       |                |</span></span>
<span class=giallo-l><span>            :                                     |                |</span></span>
<span class=giallo-l><span>            v                                     |                |</span></span>
<span class=giallo-l><span>      +----------+                                |                |</span></span>
<span class=giallo-l><span>      | End User |                                |                |</span></span>
<span class=giallo-l><span>      |    at    |&lt;---(D)-- End user reviews  --->|                |</span></span>
<span class=giallo-l><span>      |  Browser |          authorization request |                |</span></span>
<span class=giallo-l><span>      +----------+                                +----------------+</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>                    Figure 1: Device Authorization Flow</span></span>
<span class=giallo-l><span>  </span></span></code></pre><p>ä»Šå›ã®å ´åˆã€DeviceClientãŒCLIã€Authorization ServerãŒGithubã«ã‚ãŸã‚Šã¾ã™ã€‚<p>(A) ã¾ãšuserã«ã‚ˆã£ã¦cliãŒå®Ÿè¡Œã•ã‚Œã‚‹ã¨ã€cliã¯authorization serverã«device flowã®é–‹å§‹ã‚’è¦æ±‚ã™ã‚‹requestã‚’é€ã‚‹ã€‚<p>(B) ã™ã‚‹ã¨authorization serverã¯userã®browserã§è¡¨ç¤ºã™ã¹ãURI(verification URI)ã¨å…¥åŠ›ã™ã‚‹user codeã‚’responseã§è¿”ã™<p>(C) CLIã¯browserã‚’é–‹ã„ã¦ã€verification URIã‚’è¡¨ç¤ºã—ã¦ã€user codeã®å…¥åŠ›ã‚’ä¿ƒã™<p>(D) Userã¯verification URIä¸Šã§ã€CLIãŒå§”è­²ã‚’è¦æ±‚ã™ã‚‹æ¨©é™ã‚’ç¢ºèªã—ã¦åŒæ„ã‚’åˆ¤æ–­ã™ã‚‹<p>(E) CLIã¯userã«verification URIã¨user codeã‚’è¡¨ç¤ºã—ãŸå¾Œã¯authorization serverã«pollingã‚’è¡Œã„ã€userã®åˆ¤æ–­/å…¥åŠ›ã®çµæœã‚’å¾…ã¤<p>(F) UserãŒuser codeã®å…¥åŠ›ã‚’å®Œäº†ã™ã‚‹ã¨ã€access tokenãŒauthorization serverã‹ã‚‰responseã¨ã—ã¦è¿”ã•ã‚Œã€å‡¦ç†ãŒå®Œäº†ã™ã‚‹<p>CLIãŒå®Ÿè£…ã™ã‚‹request/responseã¯2ç¨®é¡ã ã‘ã¨éå¸¸ã«ã‚·ãƒ³ãƒ—ãƒ«ã«ãªã£ã¦ã„ã¾ã™ã€‚<br> å‡¦ç†ã®æ¦‚è¦ãŒæŠŠæ¡ã§ããŸã®ã§ã€ãã‚Œãã‚Œã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚<h2 id=shi-qian-zhun-bei><a aria-label="Anchor link for: shi-qian-zhun-bei" class=zola-anchor href=#shi-qian-zhun-bei>äº‹å‰æº–å‚™</a></h2><p>æœ¬è¨˜äº‹ã§ã¯authorization serverã¨ã—ã¦Githubã‚’åˆ©ç”¨ã—ã¾ã™ã€‚<br> ã‚ã‚‰ã‹ã˜ã‚ã€CLIã‚’Githubã«OAuth applicationã¨ã—ã¦ç™»éŒ²ã—ã¦ãŠãã¾ã™ã€‚<p><a href=https://github.com/settings/applications/new rel=external>Settings > Developer Settings > New OAuth App</a><p>Enable Device Flowã®checkboxã‚’æœ‰åŠ¹ã«ã—ã¾ã™ã€‚ Authorization callback URLã¯CLIã®ã¿ã®åˆ©ç”¨ã§ã¯ä½¿ç”¨ã—ã¾ã›ã‚“ãŒã€å¿…é ˆãªã®ã§é©å½“ãªå€¤ã‚’è¨­å®šã—ã¾ã—ãŸã€‚<p><img alt="Github Application Registration" src=https://blog.ymgyt.io/entry/rfc8628-oauth2-device-authorization-grant-handson/images/gh-application-registration.png><p>è¨­å®šãŒå®Œäº†ã™ã‚‹ã¨Client IDãŒæŒ¯ã‚Šå‡ºã•ã‚Œã‚‹ã®ã§æ§ãˆã¦ãŠãã¾ã™ã€‚<p>ã¾ãŸã€cargoã®dependenciesã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=toml><span class=giallo-l><span style=color:#eceff4>[</span><span>dependencies</span><span style=color:#eceff4>]</span></span>
<span class=giallo-l><span>anyhow</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>1.0</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span>http</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>0.2.9</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span>http-serde-ext</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>0.1.6</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span>open</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>5.0.0</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span>reqwest</span><span style=color:#eceff4> = {</span><span> version</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>0.11.22</span><span style=color:#eceff4>",</span><span> features</span><span style=color:#eceff4> = ["</span><span style=color:#a3be8c>rustls-tls-webpki-roots</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>json</span><span style=color:#eceff4>"] }</span></span>
<span class=giallo-l><span>serde</span><span style=color:#eceff4> = {</span><span> version</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>1.0.190</span><span style=color:#eceff4>",</span><span>features</span><span style=color:#eceff4> = ["</span><span style=color:#a3be8c>derive</span><span style=color:#eceff4>"] }</span></span>
<span class=giallo-l><span>serde_json</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>1.0.108</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span>tokio</span><span style=color:#eceff4> = {</span><span> version</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>1.32.0</span><span style=color:#eceff4>",</span><span> features</span><span style=color:#eceff4> = ["</span><span style=color:#a3be8c>rt-multi-thread</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>macros</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>time</span><span style=color:#eceff4>"] }</span></span>
<span class=giallo-l><span>tracing</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>0.1.37</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span>tracing-subscriber</span><span style=color:#eceff4> = {</span><span> version</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>0.3.17</span><span style=color:#eceff4>",</span><span> default-features</span><span style=color:#eceff4> =</span><span style=color:#81a1c1> false</span><span style=color:#eceff4>,</span><span> features</span><span style=color:#eceff4> = ["</span><span style=color:#a3be8c>smallvec</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>fmt</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>ansi</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>std</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>env-filter</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>time</span><span style=color:#eceff4>"] }</span></span></code></pre><h2 id=device-authorization-request><a aria-label="Anchor link for: device-authorization-request" class=zola-anchor href=#device-authorization-request>Device Authorization Request</a></h2><p>ã¾ãšæœ¬å‡¦ç†ã¯<code>DeviceFlow</code>ã«å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> reqwest</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Client</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>time</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Duration</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>use crate::</span><span>config</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> DeviceFlow</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    client</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Client</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    client_id</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>static str</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> DeviceFlow</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> new</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -> Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> client</span><span style=color:#81a1c1> =</span><span> reqwest</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>ClientBuilder</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>user_agent</span><span style=color:#eceff4>(</span><span>config</span><span style=color:#81a1c1>::</span><span>USER_AGENT</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>timeout</span><span style=color:#eceff4>(</span><span>Duration</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_secs</span><span style=color:#eceff4>(</span><span style=color:#b48ead>5</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>build</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            client</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            client_id</span><span style=color:#81a1c1>:</span><span> config</span><span style=color:#81a1c1>::</span><span>github</span><span style=color:#81a1c1>::</span><span>CLIENT_ID</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><ul><li><code>config::USER_AGENT</code>ã«ã¯applicationã®user agentã‚’è¨­å®š<li><code>config::github::CLIENT_ID</code>ã«ã¯Githubã‹ã‚‰æŒ¯ã‚Šå‡ºã•ã‚ŒãŸClient IDãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã™</ul><p>ç¶šã„ã¦ã€(A)ã®å‡¦ç†ã«è©²å½“ã™ã‚‹device authorization requestã«ã¤ã„ã¦ã¿ã¦ã„ãã¾ã™ã€‚<p><a href=https://datatracker.ietf.org/doc/html/rfc8628#section-3.1 rel=external>ä»•æ§˜ã®3.1 Device Authorization Request</a>ã«ã¯<blockquote><p>This specification defines a new OAuth endpoint: the device authorization endpoint. This is separate from the OAuth authorization endpoint defined in <a href=https://datatracker.ietf.org/doc/html/rfc6749 rel=external>RFC6749</a> with which the user interacts via a user agent (i.e., a browser).</blockquote><p>ã¨ã‚ã‚Šã€device flowã§ã¯å°‚ç”¨ã®endpointãŒå®šç¾©ã•ã‚Œã¾ã™ã€‚<br> Githubã§ã¯<code>https://github.com/login/device/code</code>ãŒdevice authorization endpointã§ã™ã€‚<p>ä»•æ§˜ã§ã¯ã€device authorization endpointã«ä»¥ä¸‹ã®requestã‚’è¡Œã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#616e88>/// https://datatracker.ietf.org/doc/html/rfc8628#section-3.1</span></span>
<span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Serialize</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> DeviceAuthorizationRequest</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>s</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span>    client_id</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>s str</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    scope</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>s str</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><ul><li><code>client_id</code>: Githubã«ç™»éŒ²ã—ãŸCLIã®Client ID<li><code>scope</code>: OAuthã«ãŠã‘ã‚‹userãŒå§”è­²ã™ã‚‹æ¨©é™ã®å°„ç¨‹ã§ã™ã€‚</ul><p>Githubã®scopeã¯<a href=https://docs.github.com/en/apps/oauth-apps/building-oauth-apps/scopes-for-oauth-apps rel=external>Scopes for OAuth apps</a>ã«å®šç¾©ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚ä»Šå›ã¯<code>user:email</code>ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚<p>device authorization requestãŒæˆåŠŸã™ã‚‹ã¨ä»¥ä¸‹ã®responseã‚’ãˆã¾ã™ã€‚(B)ã«è©²å½“ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#616e88>/// https://datatracker.ietf.org/doc/html/rfc8628#section-3.2</span></span>
<span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Debug</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Deserialize</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> DeviceAuthorizationResponse</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>    /// device verification code</span></span>
<span class=giallo-l><span>    device_code</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#616e88>    /// end user verification code</span></span>
<span class=giallo-l><span>    user_code</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#616e88>    /// end user verification uri on the authorization server</span></span>
<span class=giallo-l><span style=color:#5e81ac>    #[serde(with = "</span><span style=color:#a3be8c>http_serde_ext::uri</span><span style=color:#5e81ac>")]</span></span>
<span class=giallo-l><span>    verification_uri</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Uri</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#616e88>    /// a verification uri that includes user_code which is designed for non-textual transmission.</span></span>
<span class=giallo-l><span style=color:#616e88>    // error if there is no field on deserializing, maybe bug on http_serde_ext crate ?</span></span>
<span class=giallo-l><span style=color:#5e81ac>    #[allow(unused)]</span></span>
<span class=giallo-l><span style=color:#5e81ac>    #[serde(with = "</span><span style=color:#a3be8c>http_serde_ext::uri::option</span><span style=color:#5e81ac>", skip_deserializing)]</span></span>
<span class=giallo-l><span>    verification_uri_complete</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Uri</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#616e88>    /// the lifetime in seconds of the device_code and user_code</span></span>
<span class=giallo-l><span style=color:#5e81ac>    #[allow(unused)]</span></span>
<span class=giallo-l><span>    expires_in</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> i64</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#616e88>    /// the minimum amount of time in seconds that the client should wait between polling requests to the token endpoint</span></span>
<span class=giallo-l><span style=color:#616e88>    /// if no value is provided, clients must use 5 as the default</span></span>
<span class=giallo-l><span>    interval</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>i64</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><ul><li><code>device_code</code>ã¯æ¬¡ã®requestã§åˆ©ç”¨ã™ã‚‹codeã§ã™ã€‚userã«ã¯è¡¨ç¤ºã—ã¾ã›ã‚“ã€‚<li><code>user_code</code> userã«é·ç§»å…ˆã®browserã§å…¥åŠ›ã—ã¦ã‚‚ã‚‰ã†codeã§ã™<li><code>verification_uri</code> userã®browserã®é·ç§»å…ˆURIã§ã™<li><code>verification_uri_complete</code> QRã‚³ãƒ¼ãƒ‰ç­‰ã®textä»¥å¤–ã®è¡¨ç¤ºæ‰‹æ®µã§ã™ã€‚ä»Šå›ã¯åˆ©ç”¨ã—ã¾ã›ã‚“ã€‚<li><code>expires_in</code> device codeã®TTLã§ã™ã€‚ã“ã®æ™‚é–“ä»¥å†…ã«å‡¦ç†ã‚’å®Œäº†ã§ããªã‘ã‚Œã°å‡¦ç†ã‚’ã‚„ã‚Šç›´ã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚<li><code>interval</code> pollingã™ã‚‹éš›ã®intervalã§ã™ã€‚ä»•æ§˜ã§defaultãŒ5ç§’ã¨å®šã‚ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚</ul><p>device authorization requestã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè£…ã—ã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> DeviceFlow</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    const</span><span> DEVICE_AUTHORIZATION_ENDPOINT</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>str</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>https://github.com/login/device/code</span><span style=color:#eceff4>";</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>    #[tracing::instrument(skip(self))]</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub async fn</span><span style=color:#88c0d0> device_flow</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span> anyhow</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>DeviceAccessTokenResponse</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#616e88>        // https://docs.github.com/en/apps/oauth-apps/building-oauth-apps/scopes-for-oauth-apps</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> scope</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>user:email</span><span style=color:#eceff4>";</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> response</span><span style=color:#81a1c1> = self</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span>client</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>post</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>Self::</span><span>DEVICE_AUTHORIZATION_ENDPOINT</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>header</span><span style=color:#eceff4>(</span><span>http</span><span style=color:#81a1c1>::</span><span>header</span><span style=color:#81a1c1>::</span><span>ACCEPT</span><span style=color:#eceff4>, "</span><span style=color:#a3be8c>application/json</span><span style=color:#eceff4>")</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>form</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span style=color:#8fbcbb>DeviceAuthorizationRequest</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                client_id</span><span style=color:#81a1c1>: self.</span><span>client_id</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>                scope</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>            })</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>send</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .await?</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>error_for_status</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>?</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>json</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>DeviceAuthorizationResponse</span><span style=color:#eceff4>>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>        // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><blockquote><p>The client initiates the authorization flow by requesting a set of verification codes from the authorization server by making an HTTP "POST" request to the device authorization endpoint. The client makes a device authorization request to the device authorization endpoint by including the following parameters using the "application/x-www-form-urlencoded" format, per Appendix B of [RFC6749], with a character encoding of UTF-8 in the HTTP request entity-body:</blockquote><p>ã¨ã‚ã‚‹ã®ã§ã€POSTã‹ã¤ã€form-urlencodedãŒä»•æ§˜ã®ã‚ˆã†ã§ã—ãŸã€‚<br> Githubã§ã¯jsonã§ã‚‚å—ã‘ä»˜ã‘ã¦ãã‚Œãã†ã§ã—ãŸã€‚<p>ã¾ãŸã€responseã«é–¢ã—ã¦ã¯<blockquote><p>In response, the authorization server generates a unique device verification code and an end-user code that are valid for a limited time and includes them in the HTTP response body using the "application/json" format [RFC8259] with a 200 (OK) status code</blockquote><p>ã¨ã‚ã‚‹ã®ã§ã€200ã®jsonã§è¿”ã•ã‚Œã‚‹ã®ãŒä»•æ§˜ã§ã™ã€‚<p>ã“ã‚Œã§ã€browserã®é·ç§»å…ˆã®<code>verification_uri</code>ã¨userãŒå…¥åŠ›ã™ã‚‹<code>user_code</code>ãŒæ‰‹ã«å…¥ã£ãŸã®ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ã«å‡ºåŠ›ã§ãã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>Open</span><span style=color:#eceff4> `</span><span style=color:#88c0d0>https://github.com/login/device</span><span style=color:#eceff4>`</span><span style=color:#88c0d0> on</span><span style=color:#a3be8c> your browser</span></span>
<span class=giallo-l><span style=color:#88c0d0>Enter</span><span style=color:#a3be8c> CODE:</span><span style=color:#eceff4> `</span><span style=color:#88c0d0>5XXX-3YYY</span><span style=color:#eceff4>`</span></span></code></pre><p><code>verification_uri</code>ã¯åŸºæœ¬çš„ã«ã¯userã«é–‹ã„ã¦ã‚‚ã‚‰ãˆã°ã‚ˆã„ã®ã§ã™ãŒã€<code>aws sso login</code>ç­‰ã®ä»–ã®cliã§ã¯browserã‚’é–‹ãå‡¦ç†ã¾ã§è¡Œã£ã¦ã„ãŸã®ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ã«<code>open-rs</code>ã§browserã‚’èµ·å‹•ã•ã›ã¦ã¿ã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> DeviceFlow</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span style=color:#5e81ac>    #[tracing::instrument(skip(self))]</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub async fn</span><span style=color:#88c0d0> device_flow</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span> anyhow</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>DeviceAccessTokenResponse</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#616e88>        // ...</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> response</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span><span style=color:#616e88> /* ... */</span><span style=color:#eceff4> }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span style=color:#8fbcbb> DeviceAuthorizationResponse</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            device_code</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            user_code</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            verification_uri</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            interval</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>            ..</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span><span style=color:#81a1c1> =</span><span> response</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>        println!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Open `</span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>verification_uri</span><span style=color:#ebcb8b>}</span><span style=color:#a3be8c>` on your browser</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>        println!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Enter CODE: `</span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>user_code</span><span style=color:#ebcb8b>}</span><span style=color:#a3be8c>`</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>        // attempt to open input screen in the browser</span></span>
<span class=giallo-l><span>        open</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>that</span><span style=color:#eceff4>(</span><span>verification_uri</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_string</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>ok</span><span style=color:#eceff4>();</span><span style=color:#616e88> // ğŸ‘ˆ</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>        // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>å®Ÿéš›ã«userã®browserã‚’CLIã‹ã‚‰èµ·å‹•ã•ã›ã‚ˆã†ã¨æ€ã†ã¨ãªã‹ãªã‹æ‚©ã¾ã—ãã€macã§ã‚ã‚Œã°ã€<code>open</code>ãŒåˆ©ç”¨ã§ãã¾ã™ãŒã€linuxã®å ´åˆã¯<code>xdg-open</code>, <code>gnome-open</code>, ...ã¨é¸æŠè‚¢ãŒã‚ã‚Šã¾ã™ã€‚<br> <code>open-rs</code>ã®<code>open::that()</code>ã¯conditional compileã§platformå´ã®å·®ç•°ã‚’å¸åã—ã¦ãã‚Œã¾ã™ã€‚<br> <code>lib.rs</code>ã«ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã—ã¦ã‚ã‚Šã€redoxã¾ã§ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[cfg(not(any(</span></span>
<span class=giallo-l><span style=color:#5e81ac>    target_os = "</span><span style=color:#a3be8c>linux</span><span style=color:#5e81ac>",</span></span>
<span class=giallo-l><span style=color:#5e81ac>    target_os = "</span><span style=color:#a3be8c>android</span><span style=color:#5e81ac>",</span></span>
<span class=giallo-l><span style=color:#5e81ac>    target_os = "</span><span style=color:#a3be8c>freebsd</span><span style=color:#5e81ac>",</span></span>
<span class=giallo-l><span style=color:#5e81ac>    target_os = "</span><span style=color:#a3be8c>dragonfly</span><span style=color:#5e81ac>",</span></span>
<span class=giallo-l><span style=color:#5e81ac>    target_os = "</span><span style=color:#a3be8c>netbsd</span><span style=color:#5e81ac>",</span></span>
<span class=giallo-l><span style=color:#5e81ac>    target_os = "</span><span style=color:#a3be8c>openbsd</span><span style=color:#5e81ac>",</span></span>
<span class=giallo-l><span style=color:#5e81ac>    target_os = "</span><span style=color:#a3be8c>illumos</span><span style=color:#5e81ac>",</span></span>
<span class=giallo-l><span style=color:#5e81ac>    target_os = "</span><span style=color:#a3be8c>solaris</span><span style=color:#5e81ac>",</span></span>
<span class=giallo-l><span style=color:#5e81ac>    target_os = "</span><span style=color:#a3be8c>ios</span><span style=color:#5e81ac>",</span></span>
<span class=giallo-l><span style=color:#5e81ac>    target_os = "</span><span style=color:#a3be8c>macos</span><span style=color:#5e81ac>",</span></span>
<span class=giallo-l><span style=color:#5e81ac>    target_os = "</span><span style=color:#a3be8c>windows</span><span style=color:#5e81ac>",</span></span>
<span class=giallo-l><span style=color:#5e81ac>    target_os = "</span><span style=color:#a3be8c>haiku</span><span style=color:#5e81ac>",</span></span>
<span class=giallo-l><span style=color:#5e81ac>    target_os = "</span><span style=color:#a3be8c>redox</span><span style=color:#5e81ac>"</span></span>
<span class=giallo-l><span style=color:#5e81ac>)))]</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>compile_error!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>open is not supported on this platform</span><span style=color:#eceff4>");</span></span></code></pre><h2 id=device-access-token-request><a aria-label="Anchor link for: device-access-token-request" class=zola-anchor href=#device-access-token-request>Device Access Token Request</a></h2><p>Userã‚’verification_uriã«é·ç§»ã•ã›ã€user_codeã®å…¥åŠ›ã‚’ä¿ƒã—ãŸå¾Œã¯ã€pollingã‚’è¡Œã„ã¾ã™ã€‚å‡¦ç†ã®(E)ã«ã‚ãŸã‚‹éƒ¨åˆ†ã§ã™ã€‚<p><a href=https://datatracker.ietf.org/doc/html/rfc8628#section-3.4 rel=external>3.4 Device Access Token Request</a>ã§ã¯<blockquote><p>After displaying instructions to the user, the client creates an access token request and sends it to the token endpoint (as defined by Section 3.2 of <a href=https://datatracker.ietf.org/doc/html/rfc6749#section-3.2 rel=external>RFC6749</a>) with a "grant_type" of "urn:ietf:params:oauth:grant-type:device_code".</blockquote><p>ã¨ã‚ã‚Šã€token endpointã¯ã“ã‚Œã¾ã§ã®OAuthã®ã‚‚ã®ã§ã™ã€‚ Requestã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã—ã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Serialize</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> DeviceAccessTokenRequest</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>s</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#616e88>    /// Value MUST be set to "urn:ietf:params:oauth:grant-type:device_code"</span></span>
<span class=giallo-l><span>    grant_type</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>static str</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#616e88>    /// The device verification code, "device_code" from the device authorization response</span></span>
<span class=giallo-l><span>    device_code</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>s str</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    client_id</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>static str</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>s</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> DeviceAccessTokenRequest</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>s</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    const</span><span> GRANT_TYPE</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>str</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>urn:ietf:params:oauth:grant-type:device_code</span><span style=color:#eceff4>";</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> new</span><span style=color:#eceff4>(</span><span>device_code</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>s str</span><span style=color:#eceff4>,</span><span> client_id</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>static str</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            grant_type</span><span style=color:#81a1c1>: Self::</span><span>GRANT_TYPE</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            device_code</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            client_id</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><ul><li><code>grant_type</code>ã«ã¯ä»•æ§˜ã§å®šã‚ã‚‰ã‚ŒãŸ<code>urn:ietf:params:oauth:grant-type:device_code</code>ã‚’æŒ‡å®šã—ã¾ã™ã€‚<li><code>device_code</code>ã¯device authorization responseã§å–å¾—ã—ãŸå€¤ã‚’åˆ©ç”¨ã—ã¾ã™<li><code>client_id</code>: Githubã‹ã‚‰æŒ¯ã‚Šå‡ºã•ã‚ŒãŸClient IDã§ã™ã€‚</ul><p>requestã¯device authorization requeståŒæ§˜ã«ã€POSTã§ã€form-urlencodedã§è¡Œã„ã¾ã™ã€‚<p>ç¶šã„ã¦responseã«ã¤ã„ã¦ã€‚<br> ã¾ãšã€userãŒcodeã‚’å…¥åŠ›ã—ã€æ¨©é™å§”è­²ã«åŒæ„ã—ãŸå ´åˆã®responseã¯<a href=https://datatracker.ietf.org/doc/html/rfc6749#section-5.1 rel=external>RFC6749 The OAuth 2.0 Authorization Framework 5.1</a>ã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã€é€šå¸¸ã®OAuthã®responseã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Deserialize</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Debug</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> DeviceAccessTokenResponse</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>    /// the access token issued by the authorization server</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> access_token</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> token_type</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#616e88>    /// the lifetime in seconds of the access token</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> expires_in</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>i64</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>Githubã®å ´åˆã¯ä»¥ä¸‹ã®ã‚ˆã†ãªå€¤ãŒè¿”ã£ã¦ãã¾ã—ãŸã€‚<ul><li><code>access_token</code>: <code>gho_</code>ã‹ã‚‰ã¯ã˜ã¾ã‚‹access token<li><code>token_type</code>: <code>bearer</code><li><code>expires_in</code>: <code>None</code></ul><p>Device flowã§ã¯ã€pollingã§userã®åˆ¤æ–­ã‚’ç¢ºèªã™ã‚‹ã®ã§ã€ã¾ã userã®åˆ¤æ–­ãŒç¤ºã•ã‚Œã¦ã„ãªã„ã¨ã„ã†çŠ¶æ…‹ã‚’ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚<p>å®Ÿè£…ã—ã¦ã„ã‚‹ä¸­ã§ã“ã“ãŒæ‚©ã¾ã—ã‹ã£ãŸã¨ã“ã‚ãªã®ã§ã™ãŒã€ä»•æ§˜ã§ã¯ã€userã®å…¥åŠ›ãŒå®Œäº†ã—ã¦ã„ãªã„å ´åˆã€<code>error</code>ã®å€¤ã¨ã—ã¦ã€<code>authorization_pending</code>ãŒè¿”ã‚‹ã¨æ—¢å®šã•ã‚Œã¦ã„ã‚‹ã®ã§ã™ãŒã€ãã®éš›ã®response codeãŒæ˜ç¤ºã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<br> <a href=https://docs.github.com/en/apps/oauth-apps/building-oauth-apps/authorizing-oauth-apps#device-flow rel=external>Githubã®Device flow doc</a>ã«ã‚‚ã€status codeãŒæ˜è¨˜ã•ã‚Œã¦ã„ã¾ã›ã‚“ã§ã—ãŸã€‚<p><a href=https://datatracker.ietf.org/doc/html/rfc8628#section-3.5 rel=external>3.5 Device Access Token Response</a>ã§ã¯<blockquote><p>If the user has approved the grant, the token endpoint responds with a success response defined in Section 5.1 of <a href=https://datatracker.ietf.org/doc/html/rfc6749#section-5.1 rel=external>RFC6749</a>; otherwise, it responds with an error, as defined in Section 5.2 of <a href=https://datatracker.ietf.org/doc/html/rfc6749#section-5.2 rel=external>RFC6749</a>.</blockquote><blockquote><p>In addition to the error codes defined in Section 5.2 of <a href=https://datatracker.ietf.org/doc/html/rfc6749#section-5.2 rel=external>RFC6749</a>, the following error codes are specified for use with the device authorization grant in token endpoint responses:</blockquote><p>ã¨ã€errorã®å ´åˆã¯ã€RFC6749ãŒå‚ç…§ã•ã‚Œã¦ã„ã¾ã™ã€‚<br> <a href=https://datatracker.ietf.org/doc/html/rfc6749#section-5.2 rel=external>RFC6749 5.2 Error Response</a>ã§ã¯<blockquote><p>The authorization server responds with an HTTP 400 (Bad Request) status code (unless specified otherwise) and includes the following parameters with the response:</blockquote><p>ã¨ã€errorã®å ´åˆã¯400ã§è¿”ã™ã¨ã‚ã‚‹ã®ã§ã€userã®å…¥åŠ›ãŒã¾ã å®Œäº†ã—ã¦ã„ãªã„å ´åˆã¯400ã§è¿”ã£ã¦ãã‚‹ã®ã‹ãªã¨æ€ã„ã¾ã—ãŸã€‚<p>ãŒã€çµæœã¨ã—ã¦ã¯ã€Githubã¯<code>authorization_pending</code>ã‚’200ã§è¿”ã™å®Ÿè£…ã¨ãªã£ã¦ã„ã¾ã—ãŸã€‚<br> HTTPã®semanticsçš„ã«ã‚‚ã€requestè‡ªä½“ã®parameterã¯æ­£ã—ã„ã®ã§ã€200ã¯ãŠã‹ã—ã„ã¨æ€ã‚ãªã„ã®ã§ã™ãŒã€ã©ã†ã—ã¦ã“ã“ãŒä»•æ§˜ã§æ›–æ˜§ã«ãªã£ã¦ã„ã‚‹ã®ã‹ç–‘å•ã§ã—ãŸã€‚<p>ã¨ã„ã†ã“ã¨ã§ã€rustã®å®Ÿè£…çš„ã«ã¯ã€httpã®status codeã‹ã‚‰deserializeã™ã‚‹å‹ã‚’æ±ºã‚ãŸã„ã¨ã“ã‚ãªã®ã§ã™ãŒã€200ã§ã‚ã£ã¦ã‚‚responseã®å‹ãŒé•ã†ã®ã§ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè£…ã—ã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> DeviceFlow</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#5e81ac>    #[tracing::instrument(skip(self))]</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub async fn</span><span style=color:#88c0d0> device_flow</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span> anyhow</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>DeviceAccessTokenResponse</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#616e88>        // ...</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span style=color:#8fbcbb> DeviceAuthorizationResponse</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            device_code</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            user_code</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            verification_uri</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            interval</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>            ..</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span><span style=color:#81a1c1> =</span><span> response</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>        println!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Open `</span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>verification_uri</span><span style=color:#ebcb8b>}</span><span style=color:#a3be8c>` on your browser</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>        println!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Enter CODE: `</span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>user_code</span><span style=color:#ebcb8b>}</span><span style=color:#a3be8c>`</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>        // attempt to open input screen in the browser</span></span>
<span class=giallo-l><span>        open</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>that</span><span style=color:#eceff4>(</span><span>verification_uri</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_string</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>ok</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>        macro_rules! continue_or_abort</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#eceff4>            (</span><span style=color:#81a1c1> $</span><span>response_bytes</span><span style=color:#81a1c1>:</span><span>ident</span><span style=color:#eceff4> )</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {{</span></span>
<span class=giallo-l><span style=color:#81a1c1>                let</span><span> err_response</span><span style=color:#81a1c1> =</span><span> serde_json</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_slice</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>DeviceAccessTokenErrorResponse</span><span style=color:#eceff4>>(</span><span style=color:#81a1c1>&$</span><span>response_bytes</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>                if</span><span> err_response</span><span style=color:#81a1c1>.</span><span>error</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>should_continue_to_poll</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>                    debug!</span><span style=color:#eceff4>(</span><span>error_code</span><span style=color:#81a1c1>=?</span><span>err_response</span><span style=color:#81a1c1>.</span><span>error</span><span style=color:#eceff4>,</span><span>interval</span><span style=color:#eceff4>, "</span><span style=color:#a3be8c>Continue to poll</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>                    let</span><span> interval</span><span style=color:#81a1c1> =</span><span> interval</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap_or</span><span style=color:#eceff4>(</span><span style=color:#b48ead>5</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>                    tokio</span><span style=color:#81a1c1>::</span><span>time</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>sleep</span><span style=color:#eceff4>(</span><span>Duration</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_secs</span><span style=color:#eceff4>(</span><span>interval</span><span style=color:#81a1c1> as</span><span style=color:#8fbcbb> u64</span><span style=color:#eceff4>))</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                    anyhow</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0;font-weight:700>bail!</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>                        "</span><span style=color:#a3be8c>Failed to authenticate. authorization server respond with </span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>err_response:?</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#eceff4>                    )</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#eceff4>            }};</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> response</span><span style=color:#81a1c1> = loop</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let</span><span> response</span><span style=color:#81a1c1> = self</span></span>
<span class=giallo-l><span style=color:#81a1c1>                .</span><span>client</span></span>
<span class=giallo-l><span style=color:#81a1c1>                .</span><span style=color:#88c0d0>post</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>Self::</span><span>TOKEN_ENDPOINT</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>                .</span><span style=color:#88c0d0>header</span><span style=color:#eceff4>(</span><span>http</span><span style=color:#81a1c1>::</span><span>header</span><span style=color:#81a1c1>::</span><span>ACCEPT</span><span style=color:#eceff4>, "</span><span style=color:#a3be8c>application/json</span><span style=color:#eceff4>")</span></span>
<span class=giallo-l><span style=color:#81a1c1>                .</span><span style=color:#88c0d0>form</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>DeviceAccessTokenRequest</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>device_code</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> self.</span><span>client_id</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#81a1c1>                .</span><span style=color:#88c0d0>send</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>                .await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>            match</span><span> response</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>status</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                StatusCode</span><span style=color:#81a1c1>::</span><span>OK</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    let</span><span> full</span><span style=color:#81a1c1> =</span><span> response</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>bytes</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    match</span><span> serde_json</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_slice</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>DeviceAccessTokenResponse</span><span style=color:#eceff4>>(</span><span style=color:#81a1c1>&</span><span>full</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                        Ok</span><span style=color:#eceff4>(</span><span>response</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> => break</span><span> response</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                        Err</span><span style=color:#eceff4>(</span><span>_</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#88c0d0;font-weight:700> continue_or_abort!</span><span style=color:#eceff4>(</span><span>full</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>                    }</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                StatusCode</span><span style=color:#81a1c1>::</span><span>BAD_REQUEST</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    let</span><span> full</span><span style=color:#81a1c1> =</span><span> response</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>bytes</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>                    continue_or_abort!</span><span style=color:#eceff4>(</span><span>full</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span>                other</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    let</span><span> error_msg</span><span style=color:#81a1c1> =</span><span> response</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>text</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await.</span><span style=color:#88c0d0>unwrap_or_default</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span>                    anyhow</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0;font-weight:700>bail!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Failed to authenticate. authorization server respond with </span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>other</span><span style=color:#ebcb8b>} {</span><span style=color:#a3be8c>error_msg</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>")</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        };</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        Ok</span><span style=color:#eceff4>(</span><span>response</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>request::Response::bytes()</code>ã§response bodyã‚’å–å¾—ã—ã¦ã€<code>DeviceAccessTokenResponse</code>ã«deserializeã§ããŸã‚‰ã€æˆåŠŸã€å¤±æ•—ã—ãŸå ´åˆã€<code>DeviceAccessErrorResponse</code>ã«å¤‰æ›ã—ãŸã®ã¡ã€å‡¦ç†ãŒç¶™ç¶šã§ãã‚‹ã‹åˆ¤å®šã—ã¾ã™ã€‚<blockquote><p>The "authorization_pending" and "slow_down" error codes define particularly unique behavior, as they indicate that the OAuth client should continue to poll the token endpoint by repeating the token request (implementing the precise behavior defined above). If the client receives an error response with any other error code, it MUST stop polling and SHOULD react accordingly, for example, by displaying an error to the user.</blockquote><p>ã¨å®šç¾©ã•ã‚Œã¦ãŠã‚Šã€ç‰¹å®šã®errorã®å ´åˆã«ã®ã¿ã€pollingã‚’ç¶™ç¶šã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã‚ˆã†ãªã®ã§ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè£…ã—ã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Deserialize</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Debug</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> DeviceAccessTokenErrorResponse</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    error</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> DeviceAccessTokenErrorCode</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#5e81ac>    #[allow(unused)]</span></span>
<span class=giallo-l><span>    error_description</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#616e88>    // error if there is no field on deserializing, maybe bug on http_serde_ext crate ?</span></span>
<span class=giallo-l><span style=color:#5e81ac>    #[allow(unused)]</span></span>
<span class=giallo-l><span style=color:#5e81ac>    #[serde(with = "</span><span style=color:#a3be8c>http_serde_ext::uri::option</span><span style=color:#5e81ac>", skip_deserializing)]</span></span>
<span class=giallo-l><span>    error_uri</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Uri</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>PartialEq</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Eq</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Debug</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Deserialize</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#5e81ac>#[serde(rename_all = "</span><span style=color:#a3be8c>snake_case</span><span style=color:#5e81ac>")]</span></span>
<span class=giallo-l><span style=color:#81a1c1>enum</span><span style=color:#8fbcbb> DeviceAccessTokenErrorCode</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    AuthorizationPending</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    SlowDown</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    AccessDenied</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    ExpiredToken</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    InvalidRequest</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    InvalidClient</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    InvalidGrant</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    UnauthorizedClient</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    UnsupportedGrantType</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    InvalidScope</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> DeviceAccessTokenErrorCode</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> should_continue_to_poll</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> bool</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        use</span><span> DeviceAccessTokenErrorCode</span><span style=color:#81a1c1>::*</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        *self ==</span><span style=color:#8fbcbb> AuthorizationPending</span><span style=color:#81a1c1> || *self ==</span><span style=color:#8fbcbb> SlowDown</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/hyperium/hyper/blob/d77c2599bc023b258b90a17f5b633c8b7b0cbd4b/src/server/conn.rs#L655 rel=external>hyperã®code</a>ã§matchã®armã§ä½¿ã„å›ã™å‡¦ç†ã‚’macroã§å®šç¾©ã—ã¦ã„ãŸã®ã§ã“ã†ã„ã†å ´é¢ãªã‚‰macroã„ã„ã®ã‹ãªã¨æ€ã„ã€è¨±å®¹ã—ã¾ã—ãŸã€‚<p>ã“ã‚Œã§ç„¡äº‹ã€access tokenã‚’å–å¾—ã§ãã€device flowã‚’å®Œäº†ã§ãã¾ã—ãŸã€‚<h2 id=matome><a aria-label="Anchor link for: matome" class=zola-anchor href=#matome>ã¾ã¨ã‚</a></h2><p><a href=https://datatracker.ietf.org/doc/html/rfc8628 rel=external>RFC</a>ã‚’èª­ã¿ãªãŒã‚‰ã€Device Authorization Grantã“ã¨ã€device flowã‚’å®Ÿè£…ã—ã¦ã¿ã¾ã—ãŸã€‚ä»•æ§˜è‡ªä½“ã‚‚20ãƒšãƒ¼ã‚¸ç¨‹åº¦ã§çŸ­ãã€èª¬æ˜ã‚‚ã‚ã‹ã‚Šã‚„ã™ã‹ã£ãŸã§ã™ã€‚</div></article></main><footer class=blog-footer><p>Â© 2026 <a href=https://blog.ymgyt.io> ymgyt </a> | Made with <a href=https://www.getzola.org rel=noopener target=_blank>Zola</a> | <a href=https://github.com/ymgyt/blog>Repository</a> | <a href=https://blog.ymgyt.io/atom.xml target=_blank title=rss> <svg viewbox="0 0 24 24" class=icon fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx=5 cy=19 r=1></circle></svg> </a></footer></div></div>