<!doctype html><html lang=ja><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1" name=viewport><link href=https://blog.ymgyt.io/favicon.ico rel=icon sizes=any><link href=https://blog.ymgyt.io/icon.svg rel=icon type=image/svg+xml><link href=https://blog.ymgyt.io/apple-touch-icon.png rel=apple-touch-icon><link href=https://blog.ymgyt.io/manifest.webmanifest rel=manifest><link href=https://blog.ymgyt.io/style.css rel=stylesheet><link href=https://blog.ymgyt.io/atom.xml rel=alternate title=Atom type=application/atom+xml><script src="https://www.googletagmanager.com/gtag/js?id=G-GTB0KMLN90" async></script><script>window.dataLayer = window.dataLayer || [];
	function gtag() {dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-GTB0KMLN90');</script><title>ğŸ“¦ cargo-nextestã®ä½¿ã„æ–¹ã¨ä»•çµ„ã¿ | Happy developing</title><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><body><div class=world><div class=content-container><header class=blog-header-container><div class=blog-logo><a href=https://blog.ymgyt.io>Happy developing</a></div><div class=blog-nav><nav><ul><li><a href=https://blog.ymgyt.io/entry/>Entries</a><li><a href=https://blog.ymgyt.io/tags/>Tags</a><li><a href=https://blog.ymgyt.io/about/>About</a><li><a href=https://github.com/ymgyt> <img alt=Github class=icon src=https://blog.ymgyt.io/images/icon/github.svg> </a><li><a href="https://twitter.com/YAmaguchixt "> <img alt=Twitter class=icon src=https://blog.ymgyt.io/images/icon/twitter.svg> </a></ul></nav></div></header><main class=blog-main><article><header class=entry-header><h1 class=entry-title>ğŸ“¦ cargo-nextestã®ä½¿ã„æ–¹ã¨ä»•çµ„ã¿</h1><div class=entry-meta><p class=entry-meta-item>ğŸ—“ 2022-03-17<p class=entry-meta-item>ğŸ· <span class=tag><a href=https://blog.ymgyt.io/tags/rust/>rust</a></span></div></header><aside class=entry-toc><nav><ul class=entry-toc-toplevel-list><li><a href=https://blog.ymgyt.io/entry/cargo-nextest/#cargo-nextestnoshi-ifang>cargo-nextestã®ä½¿ã„æ–¹</a> <ul><li><a href=https://blog.ymgyt.io/entry/cargo-nextest/#gai-yao>æ¦‚è¦</a><li><a href=https://blog.ymgyt.io/entry/cargo-nextest/#install>Install</a><li><a href=https://blog.ymgyt.io/entry/cargo-nextest/#testnoshi-xing>Testã®å®Ÿè¡Œ</a><li><a href=https://blog.ymgyt.io/entry/cargo-nextest/#testnoyi-lan-biao-shi>Testã®ä¸€è¦§è¡¨ç¤º</a><li><a href=https://blog.ymgyt.io/entry/cargo-nextest/#config>Config</a><li><a href=https://blog.ymgyt.io/entry/cargo-nextest/#github-actions>Github Actions</a></ul><li><a href=https://blog.ymgyt.io/entry/cargo-nextest/#cargo-nextestnoshi-zu-mi>cargo-nextestã®ä»•çµ„ã¿</a> <ul><li><a href=https://blog.ymgyt.io/entry/cargo-nextest/#cargo-nextest-list>cargo nextest list</a><li><a href=https://blog.ymgyt.io/entry/cargo-nextest/#cargo-nextest-run>cargo nextest run</a><li><a href=https://blog.ymgyt.io/entry/cargo-nextest/#matome>ã¾ã¨ã‚</a><li><a href=https://blog.ymgyt.io/entry/cargo-nextest/#jin-hui-hurerarenakatutatokoro>ä»Šå›ãµã‚Œã‚‰ã‚Œãªã‹ã£ãŸã¨ã“ã‚</a></ul></ul></nav></aside><div class=entry-content><p>ã“ã®è¨˜äº‹ã§ã¯ä»¥ä¸‹ã®ç‚¹ã«ã¤ã„ã¦æ›¸ãã¾ã™ã€‚<ul><li><a href=https://nexte.st/ rel=external>cargo-nextest</a>ã®ä½¿ã„æ–¹<li>ã‚½ãƒ¼ã‚¹ã‚’èª­ã‚“ã§ç†è§£ã§ããŸç¯„å›²å†…ã§ä»•çµ„ã¿ã®è§£èª¬</ul><h1 id=cargo-nextestnoshi-ifang><a aria-label="Anchor link for: cargo-nextestnoshi-ifang" class=zola-anchor href=#cargo-nextestnoshi-ifang>cargo-nextestã®ä½¿ã„æ–¹</a></h1><p>ã¾ãšã¯ä½¿ã„æ–¹ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚ğŸš€<h2 id=gai-yao><a aria-label="Anchor link for: gai-yao" class=zola-anchor href=#gai-yao>æ¦‚è¦</a></h2><p>cargo-nextestã¯Rustã®Test Runnerã§ã™ã€‚<br> <code>cargo test</code>ã‚’å®Ÿè¡Œã—ã¦ã„ãŸã¨ã“ã‚ã§ã€<code>cargo nextest run</code>ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§åˆ©ç”¨ã—ã¾ã™ã€‚<br> <a href=https://nexte.st/ rel=external>å°‚ç”¨ã®webpage</a>ã‚‚ã‚ã‚Šã¾ã™ã€‚ <code>cargo test</code>ã¨ã®æœ€å¤§ã®é•ã„ã¯test caseã”ã¨ã«ä¸¦åˆ—ã«å®Ÿè¡Œã™ã‚‹ã¨ã“ã‚ã§ã™ã€‚<p><a href=https://nexte.st/book/how-it-works.html#the-nextest-model rel=external>The nextest model</a>ã§ã‚‚ä»•çµ„ã¿ã«ã¤ã„ã¦è¿°ã¹ã‚‰ã‚Œã¦ã„ã‚‹ã®ã§ã™ãŒã€ã„ã¾ã„ã¡ç†è§£ã§ããªã‹ã£ãŸã®ãŒã‚½ãƒ¼ã‚¹èª­ã‚“ã§ã¿ãŸãã£ã‹ã‘ã§ã™ã€‚<br> å†…éƒ¨çš„ã«ã¯<code>cargo test</code>ã§test binaryã‚’ç”Ÿæˆã—ã¦ã„ã‚‹ã®ã§ã€å®Ÿè¡Œã•ã‚Œã‚‹testè‡ªä½“ã¯å¤‰ã‚ã‚Šã¾ã›ã‚“ã€‚<h2 id=install><a aria-label="Anchor link for: install" class=zola-anchor href=#install>Install</a></h2><p>Installã™ã‚‹ã«ã¯<code>cargo install</code>ã‚’ä½¿ã†ã‹ç›´æ¥binaryã‚’æŒã£ã¦ãã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>cargo</span><span style=color:#a3be8c> install cargo-nextest</span></span></code></pre><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#616e88># linux</span></span>
<span class=giallo-l><span style=color:#88c0d0>curl</span><span style=color:#a3be8c> -LsSF https://get.nexte.st/latest/linux</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> tar</span><span style=color:#a3be8c> zxf - -C</span><span style=color:#81a1c1> ${</span><span>CARGO_HOME</span><span style=color:#81a1c1>:-</span><span>~</span><span style=color:#81a1c1>/</span><span>.cargo</span><span style=color:#81a1c1>}</span><span style=color:#a3be8c>/bin</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88># mac</span></span>
<span class=giallo-l><span style=color:#88c0d0>curl</span><span style=color:#a3be8c> -LsSf https://get.nexte.st/latest/mac</span><span style=color:#81a1c1> |</span><span style=color:#88c0d0> tar</span><span style=color:#a3be8c> zxf - -C</span><span style=color:#81a1c1> ${</span><span>CARGO_HOME</span><span style=color:#81a1c1>:-</span><span>~</span><span style=color:#81a1c1>/</span><span>.cargo</span><span style=color:#81a1c1>}</span><span style=color:#a3be8c>/bin</span></span></code></pre><p><a href=https://nexte.st/book/installation.html rel=external>Nextest installation</a><h2 id=testnoshi-xing><a aria-label="Anchor link for: testnoshi-xing" class=zola-anchor href=#testnoshi-xing>Testã®å®Ÿè¡Œ</a></h2><p>testã®å®Ÿè¡Œæ–¹æ³•ã¯<code>cargo test</code>ã¨å¤‰ã‚ã‚Šã¾ã›ã‚“ã€‚<code>cargo test</code>ã§ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹optionsã¯nextestã§ã‚‚ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>cargo</span><span style=color:#a3be8c> nextest run</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88># run specified test</span></span>
<span class=giallo-l><span style=color:#88c0d0>cargo</span><span style=color:#a3be8c> nextest run aaa::a01</span></span>
<span class=giallo-l><span style=color:#616e88># or</span></span>
<span class=giallo-l><span style=color:#88c0d0>cargo</span><span style=color:#a3be8c> nextest run aaa::a01 aaa::a02</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88># show stdout</span></span>
<span class=giallo-l><span style=color:#88c0d0>cargo</span><span style=color:#a3be8c> nextest run --no-capture</span></span></code></pre><p><code>--no-capture</code>ã«ã¯<code>--nocapture</code> aliasãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã®ã§å¾“æ¥é€šã‚Šã€<code>cargo nextest run --nocapture</code>ã§ã‚‚å‹•ãã¾ã™ã€‚<br> cargoè‡ªä½“ã®optionã¨test binaryã«æ¸¡ã™optionã®é•ã„ã‚’æ„è­˜ã—ãªãã¦ã‚ˆããªã£ã¦ã„ã¾ã™ã€‚<h3 id=retry-flaky-test><a aria-label="Anchor link for: retry-flaky-test" class=zola-anchor href=#retry-flaky-test>Retry Flaky Test</a></h3><p>å®Ÿè¡ŒçµæœãŒä¸å®‰å®šãªtestã‚’flakyãªtestã¨ã„ã†ã‚‰ã—ã„ã§ã™(çŸ¥ã‚Šã¾ã›ã‚“ã§ã—ãŸ)ã€‚<br> <code>--retry</code> optionã‚’ä»˜ä¸ã™ã‚‹ã¨å¤±æ•—ã—ãŸtestã‚’å†å®Ÿè¡Œã—ã¦ãã‚Œã€retryæ™‚ã«æˆåŠŸã™ã‚Œã°ã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œè‡ªä½“ãŒæˆåŠŸã«ãªã‚Šã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>cargo</span><span style=color:#a3be8c> nextest run --retries</span><span style=color:#b48ead> 1</span></span>
<span class=giallo-l><span style=color:#88c0d0>    Finished</span><span style=color:#a3be8c> test</span><span> [unoptimized</span><span style=color:#a3be8c> + debuginfo] target</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>s</span><span style=color:#eceff4>)</span><span style=color:#a3be8c> in 0.01s</span></span>
<span class=giallo-l><span style=color:#88c0d0>    Starting</span><span style=color:#b48ead> 4</span><span style=color:#a3be8c> tests across</span><span style=color:#b48ead> 2</span><span style=color:#a3be8c> binaries</span></span>
<span class=giallo-l><span style=color:#88c0d0>        PASS</span><span> [</span><span style=color:#a3be8c>   0.004s] nextest-handson aaa::a01::tests::aaa</span></span>
<span class=giallo-l><span style=color:#88c0d0>        PASS</span><span> [</span><span style=color:#a3be8c>   0.004s] nextest-handson aaa::a02::tests::aaa</span></span>
<span class=giallo-l><span style=color:#88c0d0>        PASS</span><span> [</span><span style=color:#a3be8c>   0.005s] nextest-handson tests::case_1</span></span>
<span class=giallo-l><span style=color:#88c0d0>   1/2</span><span style=color:#a3be8c> RETRY</span><span> [</span><span style=color:#a3be8c>   0.006s] nextest-handson flaky::tests::rand</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>---</span><span style=color:#a3be8c> TRY</span><span style=color:#b48ead> 1</span><span style=color:#a3be8c> STDOUT:        nextest-handson flaky::tests::rand ---</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>running</span><span style=color:#b48ead> 1</span><span style=color:#a3be8c> test</span></span>
<span class=giallo-l><span style=color:#88c0d0>test</span><span style=color:#a3be8c> flaky::tests::rand ... FAILED</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>failures:</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>failures:</span></span>
<span class=giallo-l><span style=color:#88c0d0>    flaky::tests::rand</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>test</span><span style=color:#a3be8c> result: FAILED.</span><span style=color:#b48ead> 0</span><span style=color:#a3be8c> passed</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 1</span><span style=color:#a3be8c> failed</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 0</span><span style=color:#a3be8c> ignored</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 0</span><span style=color:#a3be8c> measured</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 2</span><span style=color:#a3be8c> filtered out</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> finished</span><span style=color:#a3be8c> in 0.00s</span></span>
<span class=giallo-l></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>---</span><span style=color:#a3be8c> TRY</span><span style=color:#b48ead> 1</span><span style=color:#a3be8c> STDERR:        nextest-handson flaky::tests::rand ---</span></span>
<span class=giallo-l><span style=color:#88c0d0>thread</span><span style=color:#eceff4> '</span><span style=color:#a3be8c>flaky::tests::rand</span><span style=color:#eceff4>'</span><span style=color:#a3be8c> panicked at</span><span style=color:#eceff4> '</span><span style=color:#a3be8c>assertion failed: false</span><span style=color:#eceff4>'</span><span style=color:#a3be8c>, src/flaky.rs:8:13</span></span>
<span class=giallo-l><span style=color:#88c0d0>note:</span><span style=color:#a3be8c> run with</span><span style=color:#eceff4> `</span><span>RUST_BACKTRACE</span><span style=color:#81a1c1>=</span><span style=color:#a3be8c>1</span><span style=color:#eceff4>`</span><span style=color:#88c0d0> environment</span><span style=color:#a3be8c> variable to display a backtrace</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>  TRY</span><span style=color:#b48ead> 2</span><span style=color:#a3be8c> PASS</span><span> [</span><span style=color:#a3be8c>   0.003s] nextest-handson flaky::tests::rand</span></span>
<span class=giallo-l><span style=color:#88c0d0>     Summary</span><span> [</span><span style=color:#a3be8c>   0.009s]</span><span style=color:#b48ead> 4</span><span style=color:#a3be8c> tests run:</span><span style=color:#b48ead> 4</span><span style=color:#a3be8c> passed</span><span> (1</span><span style=color:#a3be8c> flaky</span><span>), 0 skipped</span></span></code></pre><p>retry + 1å›ãŒéƒ½åˆå®Ÿè¡Œã•ã‚Œã‚‹å›æ•°ã§ã™ã€‚<h3 id=partitioning-test><a aria-label="Anchor link for: partitioning-test" class=zola-anchor href=#partitioning-test>Partitioning Test</a></h3><p>ä¸€åº¦ã®å®Ÿè¡Œã§test caseã®ä¸€éƒ¨ã®ã¿ã‚’å¯¾è±¡ã«ã§ãã¾ã™ã€‚CIã§test jobã‚’ä¸¦åˆ—åŒ–ã•ã›ã‚Œã°ãƒ†ã‚¹ãƒˆæ™‚é–“ã®çŸ­ç¸®ãŒç‹™ãˆãã†ã§ã™ã€‚<br> <code>--partition count:1/2</code>ã‚„<code>--partition hash:1/3</code>ã®ã‚ˆã†ã«æŒ‡å®šã—ã¾ã™ã€‚<br> countã¨hashã®é•ã„ã¯ã€countã¯test caseã«é †ç•ªã«ç•ªå·ã‚’æŒ¯ã£ã¦åˆ†é¡ã—ã¦ã„ãã®ã§ã€ä»Šã¾ã§<code>count:1/3</code>ã§å®Ÿè¡Œã•ã‚Œã¦ã„ãŸcaseãŒcaseã®è¿½åŠ ã«ã‚ˆã£ã¦<code>count:2/3</code>ã§å®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚‹å ´åˆãŒã‚ã‚‹ã“ã¨ã§ã™ã€‚hashã¯test caseã®åå‰ã§hashã‚’ã¨ã£ã¦åˆ†é¡ã™ã‚‹ã®ã§ã€caseãŒè¿½åŠ ã•ã‚Œã¦ã‚‚åˆ†é¡ãŒå¤‰å‹•ã—ã¾ã›ã‚“ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>â¯</span><span style=color:#a3be8c> cargo nextest run --partition count:1/2</span></span>
<span class=giallo-l><span style=color:#88c0d0>    Finished</span><span style=color:#a3be8c> test</span><span> [unoptimized</span><span style=color:#a3be8c> + debuginfo] target</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>s</span><span style=color:#eceff4>)</span><span style=color:#a3be8c> in 0.00s</span></span>
<span class=giallo-l><span style=color:#88c0d0>    Starting</span><span style=color:#b48ead> 3</span><span style=color:#a3be8c> tests across</span><span style=color:#b48ead> 2</span><span style=color:#a3be8c> binaries</span><span> (1</span><span style=color:#a3be8c> skipped</span><span>)</span></span>
<span class=giallo-l><span style=color:#88c0d0>        PASS</span><span> [</span><span style=color:#a3be8c>   0.004s] nextest-handson aaa::a01::tests::aaa</span></span>
<span class=giallo-l><span style=color:#88c0d0>        PASS</span><span> [</span><span style=color:#a3be8c>   0.004s] nextest-handson tests::case_1</span></span>
<span class=giallo-l><span style=color:#88c0d0>        PASS</span><span> [</span><span style=color:#a3be8c>   0.004s] nextest-handson flaky::tests::rand</span></span>
<span class=giallo-l><span style=color:#88c0d0>     Summary</span><span> [</span><span style=color:#a3be8c>   0.006s]</span><span style=color:#b48ead> 3</span><span style=color:#a3be8c> tests run:</span><span style=color:#b48ead> 3</span><span style=color:#a3be8c> passed,</span><span style=color:#b48ead> 1</span><span style=color:#a3be8c> skipped</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>â¯</span><span style=color:#a3be8c> cargo nextest run --partition count:2/2</span></span>
<span class=giallo-l><span style=color:#88c0d0>    Finished</span><span style=color:#a3be8c> test</span><span> [unoptimized</span><span style=color:#a3be8c> + debuginfo] target</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>s</span><span style=color:#eceff4>)</span><span style=color:#a3be8c> in 0.00s</span></span>
<span class=giallo-l><span style=color:#88c0d0>    Starting</span><span style=color:#b48ead> 1</span><span style=color:#a3be8c> tests across</span><span style=color:#b48ead> 2</span><span style=color:#a3be8c> binaries</span><span> (3</span><span style=color:#a3be8c> skipped</span><span>)</span></span>
<span class=giallo-l><span style=color:#88c0d0>        PASS</span><span> [</span><span style=color:#a3be8c>   0.003s] nextest-handson aaa::a02::tests::aaa</span></span>
<span class=giallo-l><span style=color:#88c0d0>     Summary</span><span> [</span><span style=color:#a3be8c>   0.003s]</span><span style=color:#b48ead> 1</span><span style=color:#a3be8c> tests run:</span><span style=color:#b48ead> 1</span><span style=color:#a3be8c> passed,</span><span style=color:#b48ead> 3</span><span style=color:#a3be8c> skipped</span></span></code></pre><h2 id=testnoyi-lan-biao-shi><a aria-label="Anchor link for: testnoyi-lan-biao-shi" class=zola-anchor href=#testnoyi-lan-biao-shi>Testã®ä¸€è¦§è¡¨ç¤º</a></h2><p>å®Ÿè¡Œã™ã‚‹test caseã‚’test binaryã”ã¨ã«è¡¨ç¤ºã§ãã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>â¯</span><span style=color:#a3be8c> cargo nextest list</span><span>       </span></span>
<span class=giallo-l><span style=color:#88c0d0>    Finished</span><span style=color:#a3be8c> test</span><span> [unoptimized</span><span style=color:#a3be8c> + debuginfo] target</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>s</span><span style=color:#eceff4>)</span><span style=color:#a3be8c> in 0.01s</span></span>
<span class=giallo-l><span style=color:#88c0d0>nextest-handson::integ_a:</span></span>
<span class=giallo-l><span style=color:#88c0d0>    case_1</span></span>
<span class=giallo-l><span style=color:#88c0d0>nextest-handson::integ_b:</span></span>
<span class=giallo-l><span style=color:#88c0d0>    case_1</span></span>
<span class=giallo-l><span style=color:#88c0d0>nextest-handson::bin/nextest-handson:</span></span>
<span class=giallo-l><span style=color:#eceff4>    (</span><span style=color:#88c0d0>no</span><span style=color:#a3be8c> tests</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#88c0d0>nextest-handson:</span></span>
<span class=giallo-l><span style=color:#88c0d0>    aaa::a01::tests::aaa</span></span>
<span class=giallo-l><span style=color:#88c0d0>    aaa::a02::tests::aaa</span></span>
<span class=giallo-l><span style=color:#88c0d0>    flaky::tests::rand</span></span></code></pre><h2 id=config><a aria-label="Anchor link for: config" class=zola-anchor href=#config>Config</a></h2><p>è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¯work space rootã®<code>.config/nextest.yaml</code>ã«ç½®ãã¾ã™ã€‚<br> <a href=https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/nextest-runner/default-config.toml rel=external>defaultã®config</a>ã¯binaryã«<a href=https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/nextest-runner/src/config.rs#L37 rel=external>åŸ‹ã‚è¾¼ã¾ã‚Œã¦ã„ã‚‹</a>ã®ã§ãªãã¦ã‚‚å‹•ãã¾ã™ã€‚<h3 id=profile><a aria-label="Anchor link for: profile" class=zola-anchor href=#profile>Profile</a></h3><p>testå®Ÿè¡Œæ™‚ã«profileã‚’æŒ‡å®šã§ãã€é©ç”¨ã•ã‚Œã‚‹è¨­å®šç¾¤ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚localã¨CIç”¨ã‚’ç”¨æ„ã—ãŸã‚Šç­‰ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=toml><span class=giallo-l><span style=color:#eceff4>[</span><span>profile.ci</span><span style=color:#eceff4>]</span></span>
<span class=giallo-l><span style=color:#616e88># Print out output for failing tests as soon as they fail, and also at the end</span></span>
<span class=giallo-l><span style=color:#616e88># of the run (for easy scrollability).</span></span>
<span class=giallo-l><span>failure-output</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>immediate-final</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#616e88># Do not cancel the test run on the first failure.</span></span>
<span class=giallo-l><span>fail-fast</span><span style=color:#eceff4> =</span><span style=color:#81a1c1> false</span></span></code></pre><p>ä¸Šè¨˜ã¯CIæ™‚ã«ã¯å¤±æ•—ã—ãŸtestã®stdout/stderrã‚’æœ€å¾Œã«è¡¨ç¤ºã—ã€test caseãŒå¤±æ•—ã—ã¦ã‚‚æœ€å¾Œã¾ã§å®Ÿè¡Œã—åˆ‡ã‚‹ã‚ˆã†ãªè¨­å®šã§ã™ã€‚<br> <code>cargo nextest run --profile ci</code> ã§é©ç”¨ã§ãã¾ã™ã€‚<h2 id=github-actions><a aria-label="Anchor link for: github-actions" class=zola-anchor href=#github-actions>Github Actions</a></h2><p>Github Actionsã«çµ„ã¿è¾¼ã‚€ã®ã‚‚éå¸¸ã«ç°¡å˜ã§ã™ã€‚<br> <code>.github/workflows/ci.yaml</code><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=yaml><span class=giallo-l><span style=color:#8fbcbb>name</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> ci</span></span>
<span class=giallo-l><span style=color:#81a1c1>on</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> push</span></span>
<span class=giallo-l><span style=color:#8fbcbb>jobs</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  test</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    name</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> Test</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    runs-on</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> ubuntu-20.04</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    steps</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#eceff4>    -</span><span style=color:#8fbcbb> name</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> Checkout</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      uses</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> actions/checkout@v2</span></span>
<span class=giallo-l><span style=color:#eceff4>    -</span><span style=color:#8fbcbb> name</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> Install nextest</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      shell</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> bash</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      run</span><span style=color:#eceff4>:</span><span style=color:#81a1c1> |</span></span>
<span class=giallo-l><span style=color:#a3be8c>        curl -LsSf https://get.nexte.st/latest/linux | tar zxf - -C ${CARGO_HOME:-~/.cargo}/bin</span></span>
<span class=giallo-l><span style=color:#eceff4>    -</span><span style=color:#8fbcbb> name</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> Run test</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      uses</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> actions-rs/cargo@v1</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      with</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        command</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> nextest</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        args</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> run</span></span>
<span class=giallo-l><span style=color:#616e88>    # or</span></span>
<span class=giallo-l><span style=color:#eceff4>    -</span><span style=color:#8fbcbb> name</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> Run test without action</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      run</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> cargo nextest run --profile ci --retries 1</span></span></code></pre><p><a href=https://nexte.st/book/pre-built-binaries.html#using-nextest-in-github-actions rel=external>å°‚ç”¨ã®action</a>ã‚‚ã§ããŸã‚‰ã—ã„ã§ã™ã€‚<h1 id=cargo-nextestnoshi-zu-mi><a aria-label="Anchor link for: cargo-nextestnoshi-zu-mi" class=zola-anchor href=#cargo-nextestnoshi-zu-mi>cargo-nextestã®ä»•çµ„ã¿</a></h1><p>ã“ã“ã¾ã§ç°¡å˜ã«cargo-nextestã®ä½¿ã„æ–¹ã‚’ã¿ã¦ãã¾ã—ãŸã€‚ä»¥é™ã¯ã“ã‚Œã‚‰ã®æ©Ÿèƒ½ãŒã©ã†ã‚„ã£ã¦å®Ÿç¾ã•ã‚Œã¦ã„ã‚‹ã®ã‹ã‚’ã‚½ãƒ¼ã‚¹èª­ã¿ãªãŒã‚‰è¿½ã£ã¦ã„ãã¾ã™ã€‚<br> ã‚½ãƒ¼ã‚¹ã¯æœ¬è¨˜äº‹ã‚’æ›¸ã„ã¦ã‚‹æ™‚ã®<a href=https://github.com/nextest-rs/nextest/tree/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5 rel=external>æœ€æ–°ã®main</a>ã‚’å¯¾è±¡ã«ã—ã¦ã„ã¾ã™ã€‚<p>å‡ºåŠ›ã®exampleã§åˆ©ç”¨ã™ã‚‹directoryæ§‹æˆã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>â¯</span><span style=color:#a3be8c> exa -T  src tests</span></span>
<span class=giallo-l><span style=color:#88c0d0>src</span></span>
<span class=giallo-l><span style=color:#88c0d0>â”œâ”€â”€</span><span style=color:#a3be8c> aaa</span></span>
<span class=giallo-l><span style=color:#88c0d0>â”‚</span><span style=color:#a3be8c>  â”œâ”€â”€ a01.rs</span></span>
<span class=giallo-l><span style=color:#88c0d0>â”‚</span><span style=color:#a3be8c>  â””â”€â”€ a02.rs</span></span>
<span class=giallo-l><span style=color:#88c0d0>â”œâ”€â”€</span><span style=color:#a3be8c> aaa.rs</span></span>
<span class=giallo-l><span style=color:#88c0d0>â”œâ”€â”€</span><span style=color:#a3be8c> flaky.rs</span></span>
<span class=giallo-l><span style=color:#88c0d0>â”œâ”€â”€</span><span style=color:#a3be8c> lib.rs</span></span>
<span class=giallo-l><span style=color:#88c0d0>â””â”€â”€</span><span style=color:#a3be8c> main.rs</span></span>
<span class=giallo-l><span style=color:#88c0d0>tests</span></span>
<span class=giallo-l><span style=color:#88c0d0>â”œâ”€â”€</span><span style=color:#a3be8c> integ_a.rs</span></span>
<span class=giallo-l><span style=color:#88c0d0>â””â”€â”€</span><span style=color:#a3be8c> integ_b.rs</span></span></code></pre><h2 id=cargo-nextest-list><a aria-label="Anchor link for: cargo-nextest-list" class=zola-anchor href=#cargo-nextest-list><code>cargo nextest list</code></a></h2><p><code>cargo nextest run</code>ã§ã‚‚listã®æ©Ÿèƒ½ã‚’åˆ©ç”¨ã™ã‚‹ã®ã§ã€ã¾ãšã¯listã‹ã‚‰ã¿ã¦ã„ãã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>â¯</span><span style=color:#a3be8c> cargo nextest list</span></span>
<span class=giallo-l><span style=color:#88c0d0>    Finished</span><span style=color:#a3be8c> test</span><span> [unoptimized</span><span style=color:#a3be8c> + debuginfo] target</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>s</span><span style=color:#eceff4>)</span><span style=color:#a3be8c> in 0.03s</span></span>
<span class=giallo-l><span style=color:#88c0d0>nextest-handson::integ_a:</span></span>
<span class=giallo-l><span style=color:#88c0d0>    case_1</span></span>
<span class=giallo-l><span style=color:#88c0d0>nextest-handson::integ_b:</span></span>
<span class=giallo-l><span style=color:#88c0d0>    case_1</span></span>
<span class=giallo-l><span style=color:#88c0d0>nextest-handson::bin/nextest-handson:</span></span>
<span class=giallo-l><span style=color:#eceff4>    (</span><span style=color:#88c0d0>no</span><span style=color:#a3be8c> tests</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#88c0d0>nextest-handson:</span></span>
<span class=giallo-l><span style=color:#88c0d0>    aaa::a01::tests::aaa</span></span>
<span class=giallo-l><span style=color:#88c0d0>    aaa::a02::tests::aaa</span></span>
<span class=giallo-l><span style=color:#88c0d0>    flaky::tests::rand</span></span>
<span class=giallo-l></span></code></pre><p>listã¯test binaryã”ã¨ã®test caseã‚’è¡¨ç¤ºã—ã¦ãã‚Œã‚‹ã®ã§ã€ã“ã‚ŒãŒã©ã†ã‚„ã£ã¦è¡¨ç¤ºã•ã‚Œã‚‹ã®ã‹ã‚’ç†è§£ã™ã‚‹ã®ãŒã‚´ãƒ¼ãƒ«ã§ã™ã€‚<br> ã¾ãšã€<code>cargo nextest list</code>ã‚’å®Ÿè¡Œã™ã‚‹ã¨clapã®cli parseå‡¦ç†ã‚’è¡Œã„ã€<a href=https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/cargo-nextest/src/dispatch.rs#L530 rel=external><code>App:exec_list()</code></a>ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> AppOpts</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>    /// Execute the command.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> exec</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self</span><span style=color:#eceff4>,</span><span> output_writer</span><span style=color:#81a1c1>: &mut</span><span style=color:#8fbcbb> OutputWriter</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        match self.</span><span>command </span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Command</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>List</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                build_filter</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>                message_format</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>                list_type</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>                reuse_build</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                let</span><span> app</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> App</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    self.</span><span>output</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>                    reuse_build</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>                    build_filter</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    self.</span><span>config_opts</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    self.</span><span>manifest_path</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>                )</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span>                app</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>exec_list</span><span style=color:#eceff4>(</span><span>message_format</span><span style=color:#eceff4>,</span><span> list_type</span><span style=color:#eceff4>,</span><span> output_writer</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#616e88>           // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/cargo-nextest/src/dispatch.rs#L93 rel=external>https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/cargo-nextest/src/dispatch.rs#L93</a><h3 id=app-exec-list><a aria-label="Anchor link for: app-exec-list" class=zola-anchor href=#app-exec-list><code>App::exec_list()</code></a></h3><p><a href=https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/cargo-nextest/src/dispatch.rs#L530 rel=external><code>App::exec_list()</code></a>ã§ã¯<code>BinaryList</code>ã‚’<code>App::build_binary_list()</code>ã§ç”Ÿæˆã—ã¦ã€<code>--list-type</code> optionã®å€¤ã«å¿œã˜ã¦è¡¨ç¤ºå‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> exec_list</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#81a1c1>        &self</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        message_format</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> MessageFormatOpts</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        list_type</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> ListType</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        output_writer</span><span style=color:#81a1c1>: &mut</span><span style=color:#8fbcbb> OutputWriter</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    )</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> binary_list</span><span style=color:#81a1c1> = self.</span><span style=color:#88c0d0>build_binary_list</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        match</span><span> list_type</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            ListType</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>BinariesOnly</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                let mut</span><span> writer</span><span style=color:#81a1c1> =</span><span> output_writer</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>stdout_writer</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span>                binary_list</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>                    message_format</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_output_format</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span>output</span><span style=color:#81a1c1>.</span><span>verbose</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    &mut</span><span> writer</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    self.</span><span>output</span><span style=color:#81a1c1>.</span><span>color</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>should_colorize</span><span style=color:#eceff4>(</span><span>Stream</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Stdout</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>                )</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span>                writer</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>flush</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            ListType</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Full</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                let</span><span> target_runner</span><span style=color:#81a1c1> = self.</span><span style=color:#88c0d0>load_runner</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>                let</span><span> test_list</span><span style=color:#81a1c1> = self.</span><span style=color:#88c0d0>build_test_list</span><span style=color:#eceff4>(</span><span>binary_list</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> &</span><span>target_runner</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>                let mut</span><span> writer</span><span style=color:#81a1c1> =</span><span> output_writer</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>stdout_writer</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span>                test_list</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>                    message_format</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_output_format</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span>output</span><span style=color:#81a1c1>.</span><span>verbose</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    &mut</span><span> writer</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    self.</span><span>output</span><span style=color:#81a1c1>.</span><span>color</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>should_colorize</span><span style=color:#eceff4>(</span><span>Stream</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Stdout</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>                )</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span>                writer</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>flush</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Ok</span><span style=color:#eceff4>(())</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span></code></pre><p><code>BinaryList</code>ã¯<code>RustTestBinary</code>ã®Vecã‚’ä¿æŒã—ã¦ãŠã‚Šã€<code>RustTestBinary</code>ã¯<code>cargo test</code>ãŒbuildã—ãŸtest binaryã‚’è¡¨ã—ã¦ã„ã¾ã™ã€‚<br> test binaryã¯packageã®lib(lib.rs), ã‚ã‚Œã°bin(main.rs)ã¨<code>tests</code>ä»¥ä¸‹ã®ãã‚Œãã‚Œã®fileã”ã¨ã«ç”Ÿæˆã•ã‚Œã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> BinaryList</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>    /// The list of test binaries.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> rust_binaries</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Vec</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>RustTestBinary</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/nextest-runner/src/test_list.rs#L75 rel=external>https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/nextest-runner/src/test_list.rs#L75</a><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#616e88>/// A Rust test binary built by Cargo.</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> RustTestBinary</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>    /// A unique ID.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> id</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#616e88>    /// The path to the binary artifact.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> path</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Utf8PathBuf</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#616e88>    /// The package this artifact belongs to.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> package_id</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#616e88>    /// The unique binary name defined in `Cargo.toml` or inferred by the filename.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> name</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#616e88>    /// Platform for which this binary was built.</span></span>
<span class=giallo-l><span style=color:#616e88>    /// (Proc-macro tests are built for the host.)</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> build_platform</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> BuildPlatform</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/nextest-runner/src/test_list.rs#L59 rel=external>https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/nextest-runner/src/test_list.rs#L59</a><p>cargo-nextestã§ã®file pathã¯<code>std::path::{Path,PathBuf}</code>ã§ãªãã€<a href=https://docs.rs/camino/latest/camino/ rel=external>camino</a>ã®<code>camino::{Utf8Path, Utf8PathBuf}</code>ãŒåˆ©ç”¨ã•ã‚Œã¦ãŠã‚Šã¾ã™ã€‚<br> ã“ã‚Œã¯file pathãŒutf8ã§ã‚ã‚‹ã“ã¨ã‚’ä¿è¨¼ã—ã¦ãã‚Œã‚‹å‹ã§ã™ã€‚ <code>id</code>ã¯binaryã®è­˜åˆ¥å­ã§ã€ä¸Šè¨˜ã®listå®Ÿè¡Œçµæœã§ã„ã†ã¨<code>nextest-handson::integ_a</code>ã‚„<code>nextest-handson:bin/nextest-handson</code>ã®ã‚ˆã†ãªå€¤ã‚’ã¨ã‚Šã¾ã™ã€‚<p>ã¨ã„ã†ã“ã¨ã§ã¾ãšã¯ã€testå¯¾è±¡ã®binaryã¨é–¢é€£ã™ã‚‹ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿(package_id, executable path,...)ã®ä¸€è¦§ã‚’å–å¾—ã™ã‚‹å‡¦ç†ã‚’ã¿ã¦ã„ãã¾ã™ã€‚<h3 id=testbuildfilter-compute-test-list><a aria-label="Anchor link for: testbuildfilter-compute-test-list" class=zola-anchor href=#testbuildfilter-compute-test-list><code>TestBuildFilter::compute_test_list()</code></a></h3><p>ã¾ãšã€<a href=https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/cargo-nextest/src/dispatch.rs#L481 rel=external><code>App::build_binary_list()</code></a> -> <a href=https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/cargo-nextest/src/dispatch.rs#L309 rel=external><code>TestBuildFilter::compute_binary_list()</code></a>ã¨ãã¾ã™ã€‚<p><a href=https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/cargo-nextest/src/dispatch.rs#L267 rel=external><code>TestBuildFilter</code></a>ã¯testå¯¾è±¡ã®filterlingé–¢é€£ã®cli optionã‚’ä¿æŒã™ã‚‹å‹ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Debug</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Args</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#5e81ac>#[clap(next_help_heading = "</span><span style=color:#a3be8c>FILTER OPTIONS</span><span style=color:#5e81ac>")]</span></span>
<span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> TestBuildFilter</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#5e81ac>    #[clap(flatten)]</span></span>
<span class=giallo-l><span>    cargo_options</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> CargoOptions</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    /// Run ignored tests</span></span>
<span class=giallo-l><span style=color:#5e81ac>    #[clap(long, possible_values =</span><span style=color:#8fbcbb> RunIgnored</span><span style=color:#5e81ac>::variants(), default_value_t, value_name = "</span><span style=color:#a3be8c>WHICH</span><span style=color:#5e81ac>")]</span></span>
<span class=giallo-l><span>    run_ignored</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> RunIgnored</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    /// Test partition, e.g. hash:1/2 or count:2/3</span></span>
<span class=giallo-l><span style=color:#5e81ac>    #[clap(long)]</span></span>
<span class=giallo-l><span>    partition</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>PartitionerBuilder</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    /// Filter test binaries by build platform</span></span>
<span class=giallo-l><span style=color:#5e81ac>    #[clap(long, arg_enum, value_name = "</span><span style=color:#a3be8c>PLATFORM</span><span style=color:#5e81ac>", default_value_t)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>crate</span><span style=color:#eceff4>)</span><span> platform_filter</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> PlatformFilterOpts</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    // TODO: add regex-based filtering in the future?</span></span>
<span class=giallo-l><span style=color:#616e88>    /// Test name filter</span></span>
<span class=giallo-l><span style=color:#5e81ac>    #[clap(name = "</span><span style=color:#a3be8c>FILTERS</span><span style=color:#5e81ac>", help_heading =</span><span style=color:#8fbcbb> None</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span>    filter</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Vec</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/cargo-nextest/src/dispatch.rs#L267 rel=external>https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/cargo-nextest/src/dispatch.rs#L267</a><p>ä½™è«‡ã§ã™ãŒã€clap v3ãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã€structoptã®deriveã¨çµ±åˆã•ã‚Œã¦éå¸¸ã«å¥½ãã§ã™ã€‚<br> <code>#[clap(next_help_heading = "FILTER OPTIONS"]</code>ã¨æŒ‡å®šã—ã¦ã‚ã‚‹ã®ã§ã€ <code>cargo nextest list --help</code>ã‚’å®Ÿè¡Œã—ãŸæ™‚ã®<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>FILTER</span><span style=color:#a3be8c> OPTIONS:</span></span>
<span class=giallo-l><span style=color:#88c0d0>        --run-ignored</span><span style=color:#81a1c1> &lt;</span><span style=color:#a3be8c>WHIC</span><span>H</span><span style=color:#81a1c1>></span></span>
<span class=giallo-l><span style=color:#88c0d0>            Run</span><span style=color:#a3be8c> ignored tests</span></span>
<span class=giallo-l><span>            </span></span>
<span class=giallo-l><span style=color:#eceff4>            [</span><span>default: default</span><span style=color:#eceff4>]</span></span>
<span class=giallo-l><span style=color:#eceff4>            [</span><span>possible values: default, ignored-only, all</span><span style=color:#eceff4>]</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>        --partition</span><span style=color:#81a1c1> &lt;</span><span style=color:#a3be8c>PARTITIO</span><span>N</span><span style=color:#81a1c1>></span></span>
<span class=giallo-l><span style=color:#88c0d0>            Test</span><span style=color:#a3be8c> partition, e.g. hash:1/2 or count:2/3</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>        --platform-filter</span><span style=color:#81a1c1> &lt;</span><span style=color:#a3be8c>PLATFOR</span><span>M</span><span style=color:#81a1c1>></span></span>
<span class=giallo-l><span style=color:#88c0d0>            Filter</span><span style=color:#a3be8c> test binaries by build platform</span></span>
<span class=giallo-l><span>            </span></span>
<span class=giallo-l><span style=color:#eceff4>            [</span><span>default: any</span><span style=color:#eceff4>]</span></span>
<span class=giallo-l><span style=color:#eceff4>            [</span><span>possible values: target, host, any</span><span style=color:#eceff4>]</span></span></code></pre><p>ã«å¯¾å¿œã—ã¦ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚<br> ã¾ãŸã€<a href=https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/cargo-nextest/src/cargo_cli.rs#L14 rel=external><code>CargoPotions</code></a>ã‚’å®šç¾©ã—ã¦ã€<code>cargo test</code>ã§åˆ©ç”¨ã§ãã‚‹optionsã‚’è‡ªå‰ã§ç®¡ç†ã—ã¦<code>cargo test</code>ã«æ¸¡ã—ã¦ã„ã¾ã™ã€‚<p>è‚å¿ƒã®<code>TestBuildFilter::compute_binary_list()</code>ã§ã™ãŒä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¦ãŠã‚Šã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> compute_binary_list</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#81a1c1>        &self</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        graph</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>PackageGraph</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        manifest_path</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>&</span><span style=color:#8fbcbb>Utf8Path</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>        output</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> OutputContext</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    )</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>BinaryList</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#616e88>        // Don't use the manifest path from the graph to ensure that if the user cd's into a</span></span>
<span class=giallo-l><span style=color:#616e88>        // particular crate and runs cargo nextest, then it behaves identically to cargo test.</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> cargo_cli</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> CargoCli</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>test</span><span style=color:#eceff4>",</span><span> manifest_path</span><span style=color:#eceff4>,</span><span> output</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>        // Only build tests in the cargo test invocation, do not run them.</span></span>
<span class=giallo-l><span>        cargo_cli</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>add_args</span><span style=color:#eceff4>(["</span><span style=color:#a3be8c>--no-run</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>--message-format</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>json-render-diagnostics</span><span style=color:#eceff4>"]);</span></span>
<span class=giallo-l><span>        cargo_cli</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>add_options</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self.</span><span>cargo_options</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> expression</span><span style=color:#81a1c1> =</span><span> cargo_cli</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_expression</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> output</span><span style=color:#81a1c1> =</span><span> expression</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>stdout_capture</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>unchecked</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>run</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>wrap_err</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>failed to build tests</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if !</span><span>output</span><span style=color:#81a1c1>.</span><span>status</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>success</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            return</span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Report</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>ExpectedError</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>build_failed</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>                cargo_cli</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>all_args</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>                output</span><span style=color:#81a1c1>.</span><span>status</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>code</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>            )));</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> test_binaries</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> BinaryList</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_messages</span><span style=color:#eceff4>(</span><span>Cursor</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>output</span><span style=color:#81a1c1>.</span><span>stdout</span><span style=color:#eceff4>),</span><span> graph</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Ok</span><span style=color:#eceff4>(</span><span>test_binaries</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span></code></pre><p><a href=https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/cargo-nextest/src/dispatch.rs#L309 rel=external>https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/cargo-nextest/src/dispatch.rs#L309</a><p><code>CargoCli</code>ã¯<code>cargo</code>ã‚³ãƒãƒ³ãƒ‰ã‚’åˆ¥ãƒ—ãƒ­ã‚»ã‚¹ã§å®Ÿè¡Œã™ã‚‹ãŸã‚ã®wrapperã§ã™ã€‚(å†…éƒ¨çš„ã«ã¯<a href=https://docs.rs/duct/latest/duct/ rel=external><code>duct::cmd()</code></a>ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™)ã€‚ ã“ã“ã§ã¯ã€<code>cargo --color=auto test --no-run --message-format json-render-diagnostics</code>ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚<br> <code>cargo test</code>ã«<code>--no-run</code>ã‚’ä»˜ä¸ã™ã‚‹ã¨testã‚’å®Ÿè¡Œã›ãštest binaryã®buildã ã‘ãŒè¡Œã‚ã‚Œã€<code>--message-format</code>ã‚’ä»˜ä¸ã™ã‚‹ã¨ã€buildçµæœã‚’stdoutã«å‡ºåŠ›ã—ã¦ãã‚Œã¾ã™ã€‚ è©¦ã—ã«å®Ÿè¡Œã—ã¦ã¿ã‚‹ã¨<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>{"reason":"compiler-artifact","package_id":"libc 0.2.118 (registry+https://github.com/rust-lang/crates.io-index)","manifest_path":"/Users/ymgyt/.cargo/registr</span></span>
<span class=giallo-l><span>        y/src/github.com-1ecc6299db9ec823/libc-0.2.118/Cargo.toml","target":{"kind":["custom-build"],"crate_types":["bin"],"name":"build-script-build","src_path":"/Us</span></span>
<span class=giallo-l><span>        ers/ymgyt/.cargo/registry/src/github.com-1ecc6299db9ec823/libc-0.2.118/build.rs","edition":"2015","doc":false,"doctest":false,"test":false},"profile":{"opt_le</span></span>
<span class=giallo-l><span>        vel":"0","debuginfo":2,"debug_assertions":true,"overflow_checks":true,"test":false},"features":[],"filenames":["/Users/ymgyt/ws/handson/rust/nextest-handson/t</span></span>
<span class=giallo-l><span>        arget/debug/build/libc-83a03a0b79ece1f7/build-script-build"],"executable":null,"fresh":true}</span></span></code></pre><p>ã®ã‚ˆã†ãªjsonãŒè¤‡æ•°è¡Œå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚<br> ã©ã†ã‚„ã‚‰ã€<code>cargo test</code>ã‚³ãƒãƒ³ãƒ‰ã®å‡ºåŠ›ã‹ã‚‰buildã•ã‚ŒãŸtest binaryã®æƒ…å ±ã‚’å–å¾—ã—ã¦ã„ãã†ã§ã™ã€‚<h3 id=packagegraph><a aria-label="Anchor link for: packagegraph" class=zola-anchor href=#packagegraph>PackageGraph</a></h3><p><code>cargo --color=auto test --no-run --message-format json-render-diagnostics</code>ã®å‡ºåŠ›çµæœã®parseå‡¦ç†ã®å‰ã«ã‚¹ãƒ«ãƒ¼ã—ã¦ã„ãŸ<code>PackageGraph</code>ã«ã¤ã„ã¦ãµã‚Œã¾ã™ã€‚<br> <code>list</code>,<code>run</code>ã‚³ãƒãƒ³ãƒ‰å…±é€šã§<a href=https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/cargo-nextest/src/dispatch.rs#L443 rel=external><code>App::new()</code></a>å®Ÿè¡Œæ™‚ã«testå¯¾è±¡packageã®meta dataã‚’å–å¾—ã™ã‚‹<a href=https://github.com/facebookincubator/cargo-guppy/blob/c0549a91c8a4aab2182a78f0c7bf8d1c294b78ec/guppy/src/graph/graph_impl.rs#L40 rel=external><code>guppy::PackageGraph</code></a>ç”Ÿæˆå‡¦ç†ãŒã‚ã‚Šã¾ã™ã€‚<p><code>PackageGraph</code>ã®ç”Ÿæˆå‡¦ç†ã¯<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> acquire_graph_data</span><span style=color:#eceff4>(</span><span>manifest_path</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>&</span><span style=color:#8fbcbb>Utf8Path</span><span style=color:#eceff4>>,</span><span> output</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> OutputContext</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> cargo_cli</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> CargoCli</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>metadata</span><span style=color:#eceff4>",</span><span> manifest_path</span><span style=color:#eceff4>,</span><span> output</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#616e88>    // Construct a package graph with --no-deps since we don't need full dependency</span></span>
<span class=giallo-l><span style=color:#616e88>    // information.</span></span>
<span class=giallo-l><span>    cargo_cli</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>add_args</span><span style=color:#eceff4>(["</span><span style=color:#a3be8c>--format-version=1</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>--all-features</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>--no-deps</span><span style=color:#eceff4>"]);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    // Capture stdout but not stderr.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> output</span><span style=color:#81a1c1> =</span><span> cargo_cli</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>to_expression</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>stdout_capture</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>unchecked</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>run</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>wrap_err</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>cargo metadata execution failed</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    if !</span><span>output</span><span style=color:#81a1c1>.</span><span>status</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>success</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        return</span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>ExpectedError</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>cargo_metadata_failed</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> json</span><span style=color:#81a1c1> =</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        String</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_utf8</span><span style=color:#eceff4>(</span><span>output</span><span style=color:#81a1c1>.</span><span>stdout</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>wrap_err</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>cargo metadata output is invalid UTF-8</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Ok</span><span style=color:#eceff4>(</span><span>json</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/cargo-nextest/src/dispatch.rs#L607 rel=external>https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/cargo-nextest/src/dispatch.rs#L607</a><p>ã§ã€<code>cargo --color=auto metadata --format-version=1 --all-features --no-deps</code> ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—packageã®metadataã‚’å–å¾—ã—ãã‚Œã‚’parseã—ã¾ã™ã€‚<code>--no-deps</code>ã‚’ä»˜ä¸ã—ã¦ã„ã‚‹ã®ã§dependenciesã®æƒ…å ±ã¯å‡ºåŠ›ã•ã‚Œãšã€testå¯¾è±¡ã®è‡ªpackageã®æƒ…å ±ã®ã¿å–å¾—ã—ã¾ã™ã€‚<p>å®Ÿè¡Œã—ã¦ã¿ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªjsonãŒå‡ºåŠ›ã•ã‚Œã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>â¯</span><span style=color:#a3be8c> cargo --color=auto metadata --format-version=1 --all-features --no-deps</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span><span style=color:#88c0d0>"packages":</span><span style=color:#a3be8c>[{</span><span>"</span><span style=color:#88c0d0>name":"nextest-handson","version":"0.1.0","id":"nextest-handson</span><span style=color:#b48ead> 0.1.0</span><span> (path+file:///Users/ymgyt/ws/handson/rust/nextest-handson)</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>,</span><span style=color:#eceff4>"</span><span>license</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:null,</span><span style=color:#eceff4>"</span><span>license_file</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:null,</span><span style=color:#eceff4>"</span><span>description</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:null,</span><span style=color:#eceff4>"</span><span>source</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:null,</span><span style=color:#eceff4>"</span><span>dependencies</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:[{</span><span style=color:#eceff4>"</span><span>name</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:</span><span style=color:#eceff4>"</span><span>rand</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>,</span><span style=color:#eceff4>"</span><span>source</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:</span><span style=color:#eceff4>"</span><span>registry+https://github.com/rust-lang/crates.io-index</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>,</span><span style=color:#eceff4>"</span><span>req</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:</span><span style=color:#eceff4>"</span><span>^0.8.5</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>,</span><span style=color:#eceff4>"</span><span>kind</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:</span><span style=color:#eceff4>"</span><span>dev</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>,</span><span style=color:#eceff4>"</span><span>rename</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:null,</span><span style=color:#eceff4>"</span><span>optional</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:false,</span><span style=color:#eceff4>"</span><span>uses_default_features</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:true,</span><span style=color:#eceff4>"</span><span>features</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:[],</span><span style=color:#eceff4>"</span><span>target</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:null,</span><span style=color:#eceff4>"</span><span>registry</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:null}],</span><span style=color:#eceff4>"</span><span>targets</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:[{</span><span style=color:#eceff4>"</span><span>kind</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:[</span><span style=color:#eceff4>"</span><span>lib</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>],</span><span style=color:#eceff4>"</span><span>crate_types</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:[</span><span style=color:#eceff4>"</span><span>lib</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>],</span><span style=color:#eceff4>"</span><span>name</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:</span><span style=color:#eceff4>"</span><span>nextest-handson</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>,</span><span style=color:#eceff4>"</span><span>src_path</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:</span><span style=color:#eceff4>"</span><span>/Users/ymgyt/ws/handson/rust/nextest-handson/src/lib.rs</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>,</span><span style=color:#eceff4>"</span><span>edition</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:</span><span style=color:#eceff4>"</span><span>2021</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>,</span><span style=color:#eceff4>"</span><span>doc</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:true,</span><span style=color:#eceff4>"</span><span>doctest</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:true,</span><span style=color:#eceff4>"</span><span>test</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:true},{</span><span style=color:#eceff4>"</span><span>kind</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:[</span><span style=color:#eceff4>"</span><span>bin</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>],</span><span style=color:#eceff4>"</span><span>crate_types</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:[</span><span style=color:#eceff4>"</span><span>bin</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>],</span><span style=color:#eceff4>"</span><span>name</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:</span><span style=color:#eceff4>"</span><span>nextest-handson</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>,</span><span style=color:#eceff4>"</span><span>src_path</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:</span><span style=color:#eceff4>"</span><span>/Users/ymgyt/ws/handson/rust/nextest-handson/src/main.rs</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>,</span><span style=color:#eceff4>"</span><span>edition</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:</span><span style=color:#eceff4>"</span><span>2021</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>,</span><span style=color:#eceff4>"</span><span>doc</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:true,</span><span style=color:#eceff4>"</span><span>doctest</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:false,</span><span style=color:#eceff4>"</span><span>test</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:true},{</span><span style=color:#eceff4>"</span><span>kind</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:[</span><span style=color:#eceff4>"</span><span>test</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>],</span><span style=color:#eceff4>"</span><span>crate_types</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:[</span><span style=color:#eceff4>"</span><span>bin</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>],</span><span style=color:#eceff4>"</span><span>name</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:</span><span style=color:#eceff4>"</span><span>integ_a</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>,</span><span style=color:#eceff4>"</span><span>src_path</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:</span><span style=color:#eceff4>"</span><span>/Users/ymgyt/ws/handson/rust/nextest-handson/tests/integ_a.rs</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>,</span><span style=color:#eceff4>"</span><span>edition</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:</span><span style=color:#eceff4>"</span><span>2021</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>,</span><span style=color:#eceff4>"</span><span>doc</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:false,</span><span style=color:#eceff4>"</span><span>doctest</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:false,</span><span style=color:#eceff4>"</span><span>test</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:true},{</span><span style=color:#eceff4>"</span><span>kind</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:[</span><span style=color:#eceff4>"</span><span>test</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>],</span><span style=color:#eceff4>"</span><span>crate_types</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:[</span><span style=color:#eceff4>"</span><span>bin</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>],</span><span style=color:#eceff4>"</span><span>name</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:</span><span style=color:#eceff4>"</span><span>integ_b</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>,</span><span style=color:#eceff4>"</span><span>src_path</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:</span><span style=color:#eceff4>"</span><span>/Users/ymgyt/ws/handson/rust/nextest-handson/tests/integ_b.rs</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>,</span><span style=color:#eceff4>"</span><span>edition</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:</span><span style=color:#eceff4>"</span><span>2021</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>,</span><span style=color:#eceff4>"</span><span>doc</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:false,</span><span style=color:#eceff4>"</span><span>doctest</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:false,</span><span style=color:#eceff4>"</span><span>test</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:true}],</span><span style=color:#eceff4>"</span><span>features</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:{},</span><span style=color:#eceff4>"</span><span>manifest_path</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:</span><span style=color:#eceff4>"</span><span>/Users/ymgyt/ws/handson/rust/nextest-handson/Cargo.toml</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>,</span><span style=color:#eceff4>"</span><span>metadata</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:null,</span><span style=color:#eceff4>"</span><span>publish</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:null,</span><span style=color:#eceff4>"</span><span>authors</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:[],</span><span style=color:#eceff4>"</span><span>categories</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:[],</span><span style=color:#eceff4>"</span><span>keywords</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:[],</span><span style=color:#eceff4>"</span><span>readme</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:</span><span style=color:#eceff4>"</span><span>README.md</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>,</span><span style=color:#eceff4>"</span><span>repository</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:null,</span><span style=color:#eceff4>"</span><span>homepage</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:null,</span><span style=color:#eceff4>"</span><span>documentation</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:null,</span><span style=color:#eceff4>"</span><span>edition</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:</span><span style=color:#eceff4>"</span><span>2021</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>,</span><span style=color:#eceff4>"</span><span>links</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:null,</span><span style=color:#eceff4>"</span><span>default_run</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:null,</span><span style=color:#eceff4>"</span><span>rust_version</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:null}],</span><span style=color:#eceff4>"</span><span>workspace_members</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:[</span><span style=color:#eceff4>"</span><span>nextest-handson 0.1.0 (</span><span style=color:#88c0d0>path+file:///Users/ymgyt/ws/handson/rust/nextest-handson</span><span>)</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>],</span><span style=color:#eceff4>"</span><span>resolve</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:null,</span><span style=color:#eceff4>"</span><span>target_directory</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:</span><span style=color:#eceff4>"</span><span>/Users/ymgyt/ws/handson/rust/nextest-handson/target</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>,</span><span style=color:#eceff4>"</span><span>version</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:1,</span><span style=color:#eceff4>"</span><span>workspace_root</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:</span><span style=color:#eceff4>"</span><span>/Users/ymgyt/ws/handson/rust/nextest-handson</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>,</span><span style=color:#eceff4>"</span><span>metadata</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>:null}</span></span></code></pre><p>ã“ã®å‡ºåŠ›ã‹ã‚‰<code>PackageGraph</code>ã‚’ç”Ÿæˆã—ã¾ã™ã€‚ <code>let graph = guppy::CargoMetadata::parse_json(&graph_data)?.build_graph();</code> [https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/cargo-nextest/src/dispatch.rs#L457]<p><code>PacakgeGraph</code>ã«ã¤ã„ã¦ã¯è©³ã—ãè§¦ã‚Œã‚‰ã‚Œãªã„ã®ã§ã™ãŒã€ã‚¤ãƒ¡ãƒ¼ã‚¸ã¨ã—ã¦ã¯package_id(<code>Cargo.tomlã®[pakcage.name])ã‚’æ¸¡ã™ã¨</code>Cargo.toml`ã«æ›¸ã„ã¦ã‚ã‚‹æƒ…å ±ã‚’è¿”ã—ã¦ãã‚Œã‚‹ãã‚‰ã„ã®ç†è§£ã§ã™ã€‚<h3 id=binarylist-from-messages><a aria-label="Anchor link for: binarylist-from-messages" class=zola-anchor href=#binarylist-from-messages><code>BinaryList::from_messages()</code></a></h3><p>å›ã‚Šé“ã‚’ã—ã¦ã—ã¾ã„ã¾ã—ãŸãŒã€<code>cargo --color=auto test --no-run --message-format json-render-diagnostics</code>ã®å‡ºåŠ›çµæœã‹ã‚‰<code>BinaryList</code>ã‚’ç”Ÿæˆã™ã‚‹å‡¦ç†ã‚’ã¿ã¦ã„ãã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> BinaryList</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>    /// Parses Cargo messages from the given `BufRead` and returns a list of test binaries.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> from_messages</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>        reader</span><span style=color:#81a1c1>: impl</span><span> io</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>BufRead</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        graph</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>PackageGraph</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    )</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>Self</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> FromMessagesError</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> rust_binaries</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0;font-weight:700> vec!</span><span style=color:#eceff4>[];</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        for</span><span> message</span><span style=color:#81a1c1> in</span><span style=color:#8fbcbb> Message</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>parse_stream</span><span style=color:#eceff4>(</span><span>reader</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let</span><span> message</span><span style=color:#81a1c1> =</span><span> message</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>map_err</span><span style=color:#eceff4>(</span><span>FromMessagesError</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>ReadMessages</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>            match</span><span> message</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Message</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>CompilerArtifact</span><span style=color:#eceff4>(</span><span>artifact</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> if</span><span> artifact</span><span style=color:#81a1c1>.</span><span>profile</span><span style=color:#81a1c1>.</span><span>test </span><span style=color:#81a1c1>=></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    if let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>path</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> artifact</span><span style=color:#81a1c1>.</span><span>executable </span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>                        let</span><span> package_id</span><span style=color:#81a1c1> =</span><span> artifact</span><span style=color:#81a1c1>.</span><span>package_id</span><span style=color:#81a1c1>.</span><span>repr</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>                        // Look up the executable by package ID.</span></span>
<span class=giallo-l><span style=color:#81a1c1>                        let</span><span> package</span><span style=color:#81a1c1> =</span><span> graph</span></span>
<span class=giallo-l><span style=color:#81a1c1>                            .</span><span style=color:#88c0d0>metadata</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>PackageId</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>package_id</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>()))</span></span>
<span class=giallo-l><span style=color:#81a1c1>                            .</span><span style=color:#88c0d0>map_err</span><span style=color:#eceff4>(</span><span>FromMessagesError</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>PackageGraph</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>                        // Construct the binary ID from the package and build target.</span></span>
<span class=giallo-l><span style=color:#81a1c1>                        let mut</span><span> id</span><span style=color:#81a1c1> =</span><span> package</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>name</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_owned</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>                        let</span><span> name</span><span style=color:#81a1c1> =</span><span> artifact</span><span style=color:#81a1c1>.</span><span>target</span><span style=color:#81a1c1>.</span><span>name</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>                        // To ensure unique binary IDs, we use the following scheme:</span></span>
<span class=giallo-l><span style=color:#616e88>                        // 1. If the target is a lib, use the package name.</span></span>
<span class=giallo-l><span style=color:#616e88>                        //      There can only be one lib per package, so this</span></span>
<span class=giallo-l><span style=color:#616e88>                        //      will always be unique.</span></span>
<span class=giallo-l><span style=color:#81a1c1>                        if !</span><span>artifact</span><span style=color:#81a1c1>.</span><span>target</span><span style=color:#81a1c1>.</span><span>kind</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>contains</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>lib</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_owned</span><span style=color:#eceff4>()) {</span></span>
<span class=giallo-l><span>                            id</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>push_str</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>::</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>                            match</span><span> artifact</span><span style=color:#81a1c1>.</span><span>target</span><span style=color:#81a1c1>.</span><span>kind</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>get</span><span style=color:#eceff4>(</span><span style=color:#b48ead>0</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#616e88>                                // 2. For integration tests, use the target name.</span></span>
<span class=giallo-l><span style=color:#616e88>                                //      Cargo enforces unique names for the same</span></span>
<span class=giallo-l><span style=color:#616e88>                                //      kind of targets in a package, so these</span></span>
<span class=giallo-l><span style=color:#616e88>                                //      will always be unique.</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                                Some</span><span style=color:#eceff4>(</span><span>kind</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> if</span><span> kind</span><span style=color:#81a1c1> ==</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>test</span><span style=color:#eceff4>"</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                                    id</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>push_str</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>name</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>                                }</span></span>
<span class=giallo-l><span style=color:#616e88>                                // 3. For all other target kinds, use a</span></span>
<span class=giallo-l><span style=color:#616e88>                                //      combination of the target kind and</span></span>
<span class=giallo-l><span style=color:#616e88>                                //      the target name. For the same reason</span></span>
<span class=giallo-l><span style=color:#616e88>                                //      as above, these will always be unique.</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                                Some</span><span style=color:#eceff4>(</span><span>kind</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                                    id</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>push_str</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span style=color:#88c0d0;font-weight:700>format!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{}</span><span style=color:#a3be8c>/</span><span style=color:#ebcb8b>{}</span><span style=color:#eceff4>",</span><span> kind</span><span style=color:#eceff4>,</span><span> name</span><span style=color:#eceff4>));</span></span>
<span class=giallo-l><span style=color:#eceff4>                                }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                                None</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                                    return</span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>FromMessagesError</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>MissingTargetKind</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                                        package_name</span><span style=color:#81a1c1>:</span><span> package</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>name</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_owned</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>                                        binary_name</span><span style=color:#81a1c1>:</span><span> name</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>                                    });</span></span>
<span class=giallo-l><span style=color:#eceff4>                                }</span></span>
<span class=giallo-l><span style=color:#eceff4>                            }</span></span>
<span class=giallo-l><span style=color:#eceff4>                        }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>                        let</span><span> platform</span><span style=color:#81a1c1> = if</span><span> artifact</span><span style=color:#81a1c1>.</span><span>target</span><span style=color:#81a1c1>.</span><span>kind</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>len</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> ==</span><span style=color:#b48ead> 1</span></span>
<span class=giallo-l><span style=color:#81a1c1>                            &&</span><span> artifact</span><span style=color:#81a1c1>.</span><span>target</span><span style=color:#81a1c1>.</span><span>kind</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>get</span><span style=color:#eceff4>(</span><span style=color:#b48ead>0</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>map</span><span style=color:#eceff4>(</span><span>String</span><span style=color:#81a1c1>::</span><span>as_str</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> ==</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>proc-macro</span><span style=color:#eceff4>")</span></span>
<span class=giallo-l><span style=color:#eceff4>                        {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                            BuildPlatform</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Host</span></span>
<span class=giallo-l><span style=color:#eceff4>                        }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                            BuildPlatform</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Target</span></span>
<span class=giallo-l><span style=color:#eceff4>                        };</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>                        rust_binaries</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>push</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>RustTestBinary</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                            path</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>                            package_id</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>                            name</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>                            id</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>                            build_platform</span><span style=color:#81a1c1>:</span><span> platform</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>                        })</span></span>
<span class=giallo-l><span style=color:#eceff4>                    }</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span>                _</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>                    // Ignore all other messages.</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>        rust_binaries</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>sort_by</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>b1</span><span style=color:#eceff4>,</span><span> b2</span><span style=color:#81a1c1>|</span><span> b1</span><span style=color:#81a1c1>.</span><span>id</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>cmp</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>b2</span><span style=color:#81a1c1>.</span><span>id</span><span style=color:#eceff4>));</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        Ok</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>Self</span><span style=color:#eceff4> {</span><span> rust_binaries</span><span style=color:#eceff4> })</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/nextest-runner/src/test_list.rs#L80 rel=external>https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/nextest-runner/src/test_list.rs#L80</a><p>é•·ã„ã§ã™ãŒã‚„ã£ã¦ã„ã‚‹ã“ã¨ã¯ã‚·ãƒ³ãƒ—ãƒ«ã§ã™ã€‚<br> ç¬¬ä¸€å¼•æ•°ã®<code>reader</code>ã¯cargo testã®å‡ºåŠ›ã‚’<code>std::io::Cursor</code>ã§wrapã—ãŸã‚‚ã®ã§ã€ç¬¬äºŒå¼•æ•°ã¯å…ˆã»ã©è¦‹ãŸ<code>PackageMetadata</code>ã§ã™ã€‚<br> <code>for message in Message::parse_stream(reader) </code>ã®ã¨ã“ã‚ã§ã€jsonã‚’<a href=https://github.com/oli-obk/cargo_metadata/blob/main/src/messages.rs#L104 rel=external><code>cargo_metadata::Message</code></a>ã«parseã—ã¾ã™ã€‚<br> <code>cargo_metadata::Message</code>ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªenumã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#616e88>// A cargo message</span></span>
<span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Debug</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Clone</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Serialize</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Deserialize</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> PartialEq</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Eq</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Hash</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#5e81ac>#[non_exhaustive]</span></span>
<span class=giallo-l><span style=color:#5e81ac>#[serde(tag = "</span><span style=color:#a3be8c>reason</span><span style=color:#5e81ac>", rename_all = "</span><span style=color:#a3be8c>kebab-case</span><span style=color:#5e81ac>")]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub enum</span><span style=color:#8fbcbb> Message</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>    /// The compiler generated an artifact</span></span>
<span class=giallo-l><span style=color:#88c0d0>    CompilerArtifact</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Artifact</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#616e88>    /// The compiler wants to display a message</span></span>
<span class=giallo-l><span style=color:#88c0d0>    CompilerMessage</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>CompilerMessage</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#616e88>    /// A build script successfully executed.</span></span>
<span class=giallo-l><span style=color:#88c0d0>    BuildScriptExecuted</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>BuildScript</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#616e88>    /// The build has finished.</span></span>
<span class=giallo-l><span style=color:#616e88>    ///</span></span>
<span class=giallo-l><span style=color:#616e88>    /// This is emitted at the end of the build as the last message.</span></span>
<span class=giallo-l><span style=color:#616e88>    /// Added in Rust 1.44.</span></span>
<span class=giallo-l><span style=color:#88c0d0>    BuildFinished</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>BuildFinished</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#616e88>    /// A line of text which isn't a cargo or compiler message.</span></span>
<span class=giallo-l><span style=color:#616e88>    /// Line separator is not included</span></span>
<span class=giallo-l><span style=color:#5e81ac>    #[serde(skip)]</span></span>
<span class=giallo-l><span style=color:#88c0d0>    TextLine</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/oli-obk/cargo_metadata/blob/f615f7164534eb52fb9525bdb5eee5731f652968/src/messages.rs#L104 rel=external>https://github.com/oli-obk/cargo_metadata/blob/f615f7164534eb52fb9525bdb5eee5731f652968/src/messages.rs#L104</a><p>ä»Šå›ã®å‡¦ç†ã¯ã“ã®ã†ã¡ã€<code>Message::CompilerArtifact</code>ã®ã¿ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚<code>Artifact</code>ã¯<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#616e88>/// A compiler-generated file.</span></span>
<span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Debug</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Clone</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Serialize</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Deserialize</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> PartialEq</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Eq</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Hash</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#5e81ac>#[cfg_attr(feature = "</span><span style=color:#a3be8c>builder</span><span style=color:#5e81ac>", derive(</span><span style=color:#8fbcbb>Builder</span><span style=color:#5e81ac>))]</span></span>
<span class=giallo-l><span style=color:#5e81ac>#[non_exhaustive]</span></span>
<span class=giallo-l><span style=color:#5e81ac>#[cfg_attr(feature = "</span><span style=color:#a3be8c>builder</span><span style=color:#5e81ac>", builder(pattern = "</span><span style=color:#a3be8c>owned</span><span style=color:#5e81ac>", setter(into)))]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> Artifact</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>    /// The package this artifact belongs to</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> package_id</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> PackageId</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#616e88>    /// The target this artifact was compiled for</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> target</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Target</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#616e88>    /// The profile this artifact was compiled with</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> profile</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> ArtifactProfile</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#616e88>    /// The enabled features for this artifact</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> features</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Vec</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#616e88>    /// The full paths to the generated artifacts</span></span>
<span class=giallo-l><span style=color:#616e88>    /// (e.g. binary file and separate debug info)</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> filenames</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Vec</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Utf8PathBuf</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#616e88>    /// Path to the executable file</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> executable</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Utf8PathBuf</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#616e88>    /// If true, then the files were already generated</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> fresh</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> bool</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/oli-obk/cargo_metadata/blob/f615f7164534eb52fb9525bdb5eee5731f652968/src/messages.rs#L34 rel=external>https://github.com/oli-obk/cargo_metadata/blob/f615f7164534eb52fb9525bdb5eee5731f652968/src/messages.rs#L34</a><p>ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã®<code>Artifact</code>ã«<code>PacakgGraph</code>ã§åˆ©ç”¨ã™ã‚‹package_idã‚„ã€test binaryã®å®Ÿè¡Œpath(<code>executable</code>)ãŒä¿æŒã•ã‚Œã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1> match</span><span> message</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Message</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>CompilerArtifact</span><span style=color:#eceff4>(</span><span>artifact</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> if</span><span> artifact</span><span style=color:#81a1c1>.</span><span>profile</span><span style=color:#81a1c1>.</span><span>test </span><span style=color:#81a1c1>=></span><span style=color:#eceff4> {</span><span style=color:#81a1c1> ..</span><span style=color:#eceff4> }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ä»¥ä¸‹ã¯åˆ†ã‹ã‚Šã¥ã‚‰ã„ã§ã™ãŒè¦ã¯ã€test binaryã®ä¸€æ„ã®è­˜åˆ¥å­ã‚’ä½œã‚ã†ã¨ã—ã¦ã„ã¾ã™ã€‚<br> packageã«ã¯lib crateãŒãŸã‹ã ã‹1ã¤ãªã®ã§packageåã‚’ãã®ã¾ã¾åˆ©ç”¨ã€<code>tests</code>ä»¥ä¸‹ã¯fileåãŒä¸€ä½ã«ãªã‚‹ã“ã¨ãŒä¿è¨¼ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€<code>&lt;package>::&lt;file_name></code>ã®ã‚ˆã†ãªçµ„ã¿ç«‹ã¦ã€bin crateã¯è¤‡æ•°å­˜åœ¨ã—ã†ã‚‹ã®ã§ã€<code>&lt;pacakge>::bin/&lt;bin_name></code>ã®ã‚ˆã†ãªã“ã¨ã‚’ã‚„ã‚ã†ã¨ã—ã¦ã„ã¾ã™ã€‚ çµæœçš„ã«<code>nextest-handson</code> packageã§ã¯<ul><li><code>nextest-handson::integ_a</code> (<code>tests/integ_a.rs</code>ã«å¯¾å¿œ)<li><code>nextest-handson::integ_b</code> (<code>tests/integ_b.rs</code>ã«å¯¾å¿œ)<li><code>nextest-handson::bin/nextest-handson</code> ( <code>src/main.rs</code>ã«å¯¾å¿œ)<li><code>nextest-handson</code> ( <code>src/lib.rs</code>ã«å¯¾å¿œ) ã®ã‚ˆã†ãªidã‚’çµ„ã¿ç«‹ã¦ã¦ã„ã¾ã™ã€‚</ul><p>ã¾ã¨ã‚ã‚‹ã¨ã€<code>cargo --color=auto metadata --format-version=1 --all-features --no-deps</code>ã¨<code>cargo --color=auto test --no-run --message-format json-render-diagnostics</code>ã®å‡ºåŠ›çµæœã‚’parseã—ã¦<code>cargo</code>ãŒbuildã—ãŸtest binaryã«é–¢ã™ã‚‹æƒ…å ±ã‚’å–å¾—ã—ãŸæ„Ÿã˜ã§ã™ã€‚<h3 id=testbuildfilter-compute-test-list-1><a aria-label="Anchor link for: testbuildfilter-compute-test-list-1" class=zola-anchor href=#testbuildfilter-compute-test-list-1><code>TestBuildFilter::compute_test_list()</code></a></h3><p>ã“ã“ã¾ã§ã§ã€testå¯¾è±¡ã®binaryã®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã—ãŸãŒã€è‚å¿ƒã®å„binaryã®test caseã®æƒ…å ±ãŒã¾ã å–å¾—ã§ãã¦ã„ã¾ã›ã‚“ã€‚<br> ãã®æƒ…å ±ã‚’å–å¾—ã™ã‚‹ã®ãŒã€<a href=https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/cargo-nextest/src/dispatch.rs#L290 rel=external><code>TestBuildFilter::compute_test_list()</code></a>ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> TestBuildFilter</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> compute_test_list</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>g</span><span style=color:#eceff4>>(</span></span>
<span class=giallo-l><span style=color:#81a1c1>        &self</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        graph</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>g PackageGraph</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        binary_list</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> BinaryList</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        runner</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>TargetRunner</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        reuse_build</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>ReuseBuildOpts</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    )</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>TestList</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>g</span><span style=color:#eceff4>>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> path_mapper</span><span style=color:#81a1c1> =</span><span> reuse_build</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>make_path_mapper</span><span style=color:#eceff4>(</span><span>graph</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> test_artifacts</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> RustTestArtifact</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_binary_list</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>            graph</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            binary_list</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            path_mapper</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_ref</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#81a1c1>            self.</span><span>platform_filter</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>        )</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> test_filter</span><span style=color:#81a1c1> =</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            TestFilterBuilder</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span>run_ignored</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> self.</span><span>partition</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>(),</span><span style=color:#81a1c1> &self.</span><span>filter</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        TestList</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>test_artifacts</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> &</span><span>test_filter</span><span style=color:#eceff4>,</span><span> runner</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>wrap_err</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>error building test list</span><span style=color:#eceff4>")</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ç¬¬ä¸‰,å››å¼•æ•°ã®<code>TargetRunner</code>ã¨<code>ReuseBuildOpts</code>ã¯ä»Šå›ã¯æ°—ã«ã—ãªãã¦å¤§ä¸ˆå¤«ã§ã™ã€‚<br> å‡¦ç†ã®æµã‚Œã¨ã—ã¦ã¯ã€<code>Vec&lt;RustTestArtifact></code>ã‚’ç”Ÿæˆã—ã¦ã€cliã®filteré–¢é€£ã‚’parse(<code>--run-ignored</code>, <code>--partition count:1/3</code>)ã—ã€æœ€çµ‚çš„ã«å‡ºåŠ›ã™ã‚‹<code>TestList</code>ã‚’ç”Ÿæˆã—ã¾ã™ã€‚<p>ã¾ãšã€<code>Vec&lt;RustTestBinary></code>ã‹ã‚‰<code>Vec&lt;RustTestArtiface&lt;'g></code>ã‚’ç”Ÿæˆã™ã‚‹ã®ã§ã™ãŒã€<code>RustTestArtifact&lt;'g></code>ã¯å…ˆã»ã©cargoã®å‡ºåŠ›çµæœã‚’parseã—ã¦ä½œæˆã—ãŸ<code>RustTestBinary</code>ã¨å¤§ã€…åŒã˜ã‚‚ã®ã§ã€packageã®metadataã¨cwdã‚’è¿½åŠ ã—ãŸã ã‘ã®æƒ…å ±ã§ã™ã€‚(èª­ã‚“ã§ã„ã‚‹æ™‚ã¯å‡¦ç†ã®å®Ÿè¡ŒçŠ¶æ…‹ã«å¿œã˜ãŸä¼¼ãŸã‚ˆã†ãªæ§‹é€ ä½“ãŒå¤šãã¦æ··ä¹±ã—ã¾ã—ãŸã€‚)<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#616e88>/// A Rust test binary built by Cargo. This artifact hasn't been run yet so there's no information</span></span>
<span class=giallo-l><span style=color:#616e88>/// about the tests within it.</span></span>
<span class=giallo-l><span style=color:#616e88>///</span></span>
<span class=giallo-l><span style=color:#616e88>/// Accepted as input to [`TestList::new`].</span></span>
<span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Clone</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Debug</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> RustTestArtifact</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>g</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#616e88>    /// A unique identifier for this test artifact.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> binary_id</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    /// Metadata for the package this artifact is a part of. This is used to set the correct</span></span>
<span class=giallo-l><span style=color:#616e88>    /// environment variables.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> package</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> PackageMetadata</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>g</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    /// The path to the binary artifact.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> binary_path</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Utf8PathBuf</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    /// The unique binary name defined in `Cargo.toml` or inferred by the filename.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> binary_name</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    /// The working directory that this test should be executed in. If None, the current directory</span></span>
<span class=giallo-l><span style=color:#616e88>    /// will not be changed.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> cwd</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Utf8PathBuf</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    /// The platform for which this test artifact was built.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> build_platform</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> BuildPlatform</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/nextest-runner/src/test_list.rs#L37 rel=external>https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/nextest-runner/src/test_list.rs#L37</a><h3 id=testlist-new><a aria-label="Anchor link for: testlist-new" class=zola-anchor href=#testlist-new><code>TestList::new()</code></a></h3><p>ã¤ã„ã«<code>cargo nextest list</code>ã®å‡ºåŠ›çµæœã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã®ã™ã¹ã¦ã®æƒ…å ±ãŒé›†ã¾ã£ãŸã®ã§ã“ã“ã‹ã‚‰ã¯parseã¨filterå‡¦ç†ã§ã™ã€‚<br> ç”Ÿæˆã™ã‚‹<code>TestList</code>ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#616e88>/// List of test instances, obtained by querying the [`RustTestArtifact`] instances generated by Cargo.</span></span>
<span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Clone</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Debug</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> TestList</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>g</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span>    test_count</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> usize</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    rust_suites</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> BTreeMap</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Utf8PathBuf</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> RustTestSuite</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>g</span><span style=color:#eceff4>>>,</span></span>
<span class=giallo-l><span style=color:#616e88>    // Computed on first access.</span></span>
<span class=giallo-l><span>    skip_count</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> OnceCell</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>usize</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/nextest-runner/src/test_list.rs#L300 rel=external>https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/nextest-runner/src/test_list.rs#L300</a><p><code>rust_suites: BTreeMap&lt;Utf8PathBuf, RustTestSuite&lt;'g>></code>ã®<code>Utf8PathBuf</code>ãŒtest binaryã®pathã§ã€<code>RustTestSuite</code>ãŒfilterå‡¦ç†é©ç”¨å¾Œã®æœ€çµ‚çš„ã«å‡ºåŠ›(å®Ÿè¡Œ)ã™ã‚‹test caseã«ã¤ã„ã¦ã®æƒ…å ±ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#616e88>/// A suite of tests within a single Rust test binary.</span></span>
<span class=giallo-l><span style=color:#616e88>///</span></span>
<span class=giallo-l><span style=color:#616e88>/// This is a representation of [`nextest_metadata::RustTestSuiteSummary`] used internally by the runner.</span></span>
<span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Clone</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Debug</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Eq</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> PartialEq</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> RustTestSuite</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>g</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#616e88>    /// A unique identifier for this binary.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> binary_id</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    /// Package metadata.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> package</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> PackageMetadata</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>g</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    /// The unique binary name defined in `Cargo.toml` or inferred by the filename.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> binary_name</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    /// The working directory that this test binary will be executed in. If None, the current directory</span></span>
<span class=giallo-l><span style=color:#616e88>    /// will not be changed.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> cwd</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Utf8PathBuf</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    /// The platform the test suite is for (host or target).</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> build_platform</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> BuildPlatform</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    /// Test case names and other information about them.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> testcases</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> BTreeMap</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> RustTestCaseSummary</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/nextest-runner/src/test_list.rs#L311 rel=external>https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/nextest-runner/src/test_list.rs#L311</a><p>å¤§ä½“ã€<code>RustTestArtifact</code>(<code>RustTestBinary</code>)ã¨åŒã˜æƒ…å ±ãªã®ã§ã™ãŒã€<code>pub testcases: BTreeMap&lt;String, RustTestCaseSummary>,</code>ã«test caseã”ã¨ã®æƒ…å ±ã‚’ä¿æŒã—ã¦ã„ã¾ã™ã€‚<code>String</code>ã¯<code>module/submodule/test_func</code>ã®ã‚ˆã†ãªtest caseã®è­˜åˆ¥å­ã§ã™ã€‚<br> <a href=https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/nextest-metadata/src/test_list.rs#L214 rel=external><code>RustTestCaseSummary</code></a>ã¯å„test caseã®å‡¦ç†çµæœã«é–¢ã™ã‚‹æƒ…å ±ã§ã™ã€‚(filterã«matchã—ãŸã‹)<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#616e88>/// Serializable information about an individual test case within a Rust test suite.</span></span>
<span class=giallo-l><span style=color:#616e88>///</span></span>
<span class=giallo-l><span style=color:#616e88>/// Part of a [`RustTestSuiteSummary`].</span></span>
<span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Clone</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Debug</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Eq</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> PartialEq</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Deserialize</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Serialize</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#5e81ac>#[serde(rename_all = "</span><span style=color:#a3be8c>kebab-case</span><span style=color:#5e81ac>")]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> RustTestCaseSummary</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>    /// Returns true if this test is marked ignored.</span></span>
<span class=giallo-l><span style=color:#616e88>    ///</span></span>
<span class=giallo-l><span style=color:#616e88>    /// Ignored tests, if run, are executed with the `--ignored` argument.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> ignored</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> bool</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    /// Whether the test matches the provided test filter.</span></span>
<span class=giallo-l><span style=color:#616e88>    ///</span></span>
<span class=giallo-l><span style=color:#616e88>    /// Only tests that match the filter are run.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> filter_match</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> FilterMatch</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/nextest-metadata/src/test_list.rs#L214 rel=external>https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/nextest-metadata/src/test_list.rs#L214</a><p>è‚å¿ƒã®parseã¨filterå‡¦ç†ã§ã™ãŒ<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>g</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> TestList</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>g</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#616e88>    /// Creates a new test list by running the given command and applying the specified filter.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> new</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>        test_artifacts</span><span style=color:#81a1c1>: impl</span><span style=color:#8fbcbb> IntoIterator</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Item</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> RustTestArtifact</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>g</span><span style=color:#eceff4>>>,</span></span>
<span class=giallo-l><span>        filter</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>TestFilterBuilder</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        runner</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>TargetRunner</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    )</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>Self</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> ParseTestListError</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> test_count</span><span style=color:#81a1c1> =</span><span style=color:#b48ead> 0</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> test_artifacts</span><span style=color:#81a1c1> =</span><span> test_artifacts</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>into_iter</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>map</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>test_binary</span><span style=color:#81a1c1>|</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                let</span><span style=color:#eceff4> (</span><span>non_ignored</span><span style=color:#eceff4>,</span><span> ignored</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> test_binary</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>exec</span><span style=color:#eceff4>(</span><span>runner</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>                let</span><span style=color:#eceff4> (</span><span>bin</span><span style=color:#eceff4>,</span><span> info</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> = Self::</span><span style=color:#88c0d0>process_output</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>                    test_binary</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>                    filter</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>                    non_ignored</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_str</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>                    ignored</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_str</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>                )</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span>                test_count</span><span style=color:#81a1c1> +=</span><span> info</span><span style=color:#81a1c1>.</span><span>testcases</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>len</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Ok</span><span style=color:#eceff4>((</span><span>bin</span><span style=color:#eceff4>,</span><span> info</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#eceff4>            })</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>collect</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>BTreeMap</span><span style=color:#eceff4>&lt;</span><span>_</span><span style=color:#eceff4>,</span><span> _</span><span style=color:#eceff4>>,</span><span> _</span><span style=color:#eceff4>>>()</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        Ok</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            rust_suites</span><span style=color:#81a1c1>:</span><span> test_artifacts</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            test_count</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            skip_count</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> OnceCell</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>        })</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/nextest-runner/src/test_list.rs#L379 rel=external>https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/nextest-runner/src/test_list.rs#L379</a><p>ã–ã£ãã‚Šã„ã†ã¨ã€test binaryã‚’ä½•ã‚‰ã‹ã®æ–¹æ³•ã§å®Ÿè¡Œã—ã¦test caseã®æƒ…å ±ã‚’å–å¾—ã—ã¦ã€<code>TestList::process_output()</code>ã§filterå‡¦ç†é©ç”¨ã—ã¦<code>TestCaseSummary</code>ã‚’ç”Ÿæˆã—ã¦ã„ã‚‹æ„Ÿã˜ã§ã—ã‚‡ã†ã‹ã€‚<h4 id=rusttestartifact-exec><a aria-label="Anchor link for: rusttestartifact-exec" class=zola-anchor href=#rusttestartifact-exec><code>RustTestArtifact::exec()</code></a></h4><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>g</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> RustTestArtifact</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>g</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#616e88>    /// Run this binary with and without --ignored and get the corresponding outputs.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> exec</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> runner</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>TargetRunner</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;(</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>),</span><span style=color:#8fbcbb> ParseTestListError</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> platform_runner</span><span style=color:#81a1c1> =</span><span> runner</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>for_build_platform</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span>build_platform</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> non_ignored</span><span style=color:#81a1c1> = self.</span><span style=color:#88c0d0>exec_single</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>false</span><span style=color:#eceff4>,</span><span> platform_runner</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> ignored</span><span style=color:#81a1c1> = self.</span><span style=color:#88c0d0>exec_single</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>true</span><span style=color:#eceff4>,</span><span> platform_runner</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Ok</span><span style=color:#eceff4>((</span><span>non_ignored</span><span style=color:#eceff4>,</span><span> ignored</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> exec_single</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#81a1c1>        &self</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        ignored</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> bool</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        runner</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>&</span><span style=color:#8fbcbb>PlatformRunner</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    )</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> ParseTestListError</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> argv</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Vec</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> program</span><span style=color:#81a1c1>:</span><span> std</span><span style=color:#81a1c1>::</span><span>ffi</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>OsString</span><span style=color:#81a1c1> = if let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>runner</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> runner</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            argv</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>extend</span><span style=color:#eceff4>(</span><span>runner</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>args</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span>            argv</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>push</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span>binary_path</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_str</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span>            runner</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>binary</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            use</span><span> duct</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>IntoExecutablePath</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>            self.</span><span>binary_path</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_std_path</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_executable</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>        };</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>        argv</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>extend</span><span style=color:#eceff4>(["</span><span style=color:#a3be8c>--list</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>--format</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>terse</span><span style=color:#eceff4>"]);</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if</span><span> ignored</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            argv</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>push</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>--ignored</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> cmd</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> cmd</span><span style=color:#eceff4>(</span><span>program</span><span style=color:#eceff4>,</span><span> argv</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>dir</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self.</span><span>cwd</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>stdout_capture</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>        cmd</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>read</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>map_err</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>error</span><span style=color:#81a1c1>|</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            ParseTestListError</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>command</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>                format!</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>                    "</span><span style=color:#a3be8c>'</span><span style=color:#ebcb8b>{}</span><span style=color:#a3be8c> --list --format terse</span><span style=color:#ebcb8b>{}</span><span style=color:#a3be8c>'</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    self.</span><span>binary_path</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    if</span><span> ignored</span><span style=color:#eceff4> { "</span><span style=color:#a3be8c> --ignored</span><span style=color:#eceff4>" }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> { "" }</span></span>
<span class=giallo-l><span style=color:#eceff4>                ),</span></span>
<span class=giallo-l><span>                error</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>            )</span></span>
<span class=giallo-l><span style=color:#eceff4>        })</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/nextest-runner/src/test_list.rs#L687 rel=external>https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/nextest-runner/src/test_list.rs#L687</a><p>ã¨ã„ã†ã“ã¨ã§ã€nextestãŒã©ã†ã‚„ã£ã¦test caseã®æƒ…å ±ã‚’å–å¾—ã—ã¦ã„ã‚‹ã‹åˆ†ã‹ã‚Šã¾ã—ãŸã€‚<br> buildã•ã‚ŒãŸtest binaryã«<code>--list --format terse</code>optionã‚’ä»˜ä¸ã—ã¦å®Ÿè¡Œã—ã¦ã„ã‚‹ã ã‘ã§ã—ãŸã€‚ è©¦ã—ã«æ‰‹å…ƒã§å®Ÿè¡Œã—ã¦ã¿ã‚‹ã¨<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>â¯</span><span style=color:#a3be8c> ./target/debug/deps/nextest_handson-b56b908ea854a424 --list --format terse</span><span> </span></span>
<span class=giallo-l><span style=color:#88c0d0>aaa::a01::tests::aaa:</span><span style=color:#a3be8c> test</span></span>
<span class=giallo-l><span style=color:#88c0d0>aaa::a02::tests::aaa:</span><span style=color:#a3be8c> test</span></span>
<span class=giallo-l><span style=color:#88c0d0>flaky::tests::rand:</span><span style=color:#a3be8c> test</span></span></code></pre><p>ã¨å‡ºåŠ›ã•ã‚Œtest caseä¸€è¦§ãŒ1è¡Œã¥ã¤è¡¨ç¤ºã•ã‚Œã¾ã—ãŸã€‚(ã“ã‚Œãªã‚‰parseã¯ç°¡å˜ãã†ã§ã™). <code>RustTestArtifact::exec()</code>ã®æ–¹ã§ã¯<code>#[ignore]</code> annotationã‚’è€ƒæ…®ã—ã¦<code>--ignored</code> flagã®ä»˜ä¸ã‚ã‚‹ãªã—ã§2å›å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚<h4 id=testlist-process-output><a aria-label="Anchor link for: testlist-process-output" class=zola-anchor href=#testlist-process-output><code>TestList::process_output()</code></a></h4><p><a href=https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/nextest-runner/src/test_list.rs#L558 rel=external>https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/nextest-runner/src/test_list.rs#L558</a> test caseåã®å‡ºåŠ›ã‚’å¾—ãŸã®ã§ã€ã‚ã¨ã¯1è¡Œã¥ã¤filterå‡¦ç†ã‚’é©ç”¨ã—ã¦ã„ãã ã‘ã§ã™ã€‚<br> filterå‡¦ç†ã®å®Ÿè£…ã¯[<code>TestFilter::filter_match()</code>(https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/nextest-runner/src/test_filter.rs#L140)ã«ã‚ã‚Šã¾ã™ã€‚<p><code>cargo nextest list aaa bbb</code>ã®ã‚ˆã†ã«filterç”¨å¼•æ•°ã‚’æ¸¡ã™ã¨<a href=https://github.com/BurntSushi/aho-corasick/blob/f8197afced3df41c47d05c9bbf8f84ddd197efdb/src/ahocorasick.rs#L183 rel=external><code>aho_corasick::AhoCorasick::is_match()</code></a>ãŒåˆ©ç”¨ã•ã‚Œã¾ã™ã€‚<p>ã¾ãŸã€<code>--partition count:1/2</code>, <code>--partition hash:1/2</code>ã®ã‚ˆã†ãªpartitionã®filterå®Ÿè£…ã¯ãã‚Œãã‚Œ<ul><li><p><a href=https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/nextest-runner/src/partition.rs#L163 rel=external>https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/nextest-runner/src/partition.rs#L163</a></p><li><p><a href=https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/nextest-runner/src/partition.rs#L187 rel=external>https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/nextest-runner/src/partition.rs#L187</a></p></ul><p>ã«å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚<h3 id=testlist-write-human><a aria-label="Anchor link for: testlist-write-human" class=zola-anchor href=#testlist-write-human><code>TestList::write_human()</code></a></h3><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#616e88>/// List of test instances, obtained by querying the [`RustTestArtifact`] instances generated by Cargo.</span></span>
<span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Clone</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Debug</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> TestList</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>g</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span>    test_count</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> usize</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    rust_suites</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> BTreeMap</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Utf8PathBuf</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> RustTestSuite</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>g</span><span style=color:#eceff4>>>,</span></span>
<span class=giallo-l><span style=color:#616e88>    // Computed on first access.</span></span>
<span class=giallo-l><span>    skip_count</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> OnceCell</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>usize</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/nextest-runner/src/test_list.rs#L300 rel=external>https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/nextest-runner/src/test_list.rs#L300</a><p><code>TestList</code>ãŒç”Ÿæˆã§ããŸã®ã§ã‚ã¨ã¯å‡ºåŠ›ã™ã‚‹ã ã‘ã§ã™ã€‚<p><a href=https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/nextest-runner/src/test_list.rs#L215 rel=external>https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/nextest-runner/src/test_list.rs#L215</a><p>å‡ºåŠ›ã«å¿…è¦ãªæƒ…å ±ã¨filterå‡¦ç†ãŒã§ãã¦ã„ã‚‹ã®ã§<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>â¯</span><span style=color:#a3be8c> cargo nextest list aaa</span></span>
<span class=giallo-l><span style=color:#88c0d0>    Finished</span><span style=color:#a3be8c> test</span><span> [unoptimized</span><span style=color:#a3be8c> + debuginfo] target</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>s</span><span style=color:#eceff4>)</span><span style=color:#a3be8c> in 0.01s</span></span>
<span class=giallo-l><span style=color:#88c0d0>nextest-handson::integ_a:</span></span>
<span class=giallo-l><span style=color:#88c0d0>    case_1</span><span> (skipped)</span></span>
<span class=giallo-l><span style=color:#88c0d0>nextest-handson::integ_b:</span></span>
<span class=giallo-l><span style=color:#88c0d0>    case_1</span><span> (skipped)</span></span>
<span class=giallo-l><span style=color:#88c0d0>nextest-handson::bin/nextest-handson:</span></span>
<span class=giallo-l><span style=color:#eceff4>    (</span><span style=color:#88c0d0>no</span><span style=color:#a3be8c> tests</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#88c0d0>nextest-handson:</span></span>
<span class=giallo-l><span style=color:#88c0d0>    aaa::a01::tests::aaa</span></span>
<span class=giallo-l><span style=color:#88c0d0>    aaa::a02::tests::aaa</span></span>
<span class=giallo-l><span style=color:#88c0d0>    flaky::tests::rand</span><span> (skipped)</span></span></code></pre><p>ã®ã‚ˆã†ã«çµæœã‚’è¡¨ç¤ºã§ãã¾ã™ã€‚<h3 id=listchu-li-nomatome><a aria-label="Anchor link for: listchu-li-nomatome" class=zola-anchor href=#listchu-li-nomatome><code>list</code>å‡¦ç†ã®ã¾ã¨ã‚</a></h3><p>ã“ã“ã¾ã§nextestãŒtest caseä¸€è¦§ã‚’è¡¨ç¤ºã™ã‚‹ã¾ã§ã®å‡¦ç†ã®æµã‚Œã‚’è¿½ã£ã¦ã¿ã¾ã—ãŸã€‚<p><code>cargo test --no-run --message-format json-render-diagnostics</code>ã‚’å®Ÿè¡Œã—ã¦cargoãŒbuildã—ãŸtest binaryã®æƒ…å ±ã‚’å–å¾—ã—ãŸã®ã¡ã€å„test binaryã‚’<code>--list --format terse</code> optionä»˜ãã§å®Ÿè¡Œã—ã¦ã€test binaryã”ã¨ã®test caseã‚’ä¿æŒã€‚ ãã®å¾Œã€test caseã”ã¨ã«filterå‡¦ç†ã‚’é©ç”¨ã™ã‚‹ã“ã¨ã§<code>cargo nextest list</code>ã‚’å‡ºåŠ›ã—ã¦ã„ã‚‹ã®ã“ã¨ãŒç†è§£ã§ãã¾ã—ãŸã€‚<br> listã§ç”Ÿæˆã—ãŸ<code>TestList</code>ã¯<code>run</code>ã‚³ãƒãƒ³ãƒ‰ã§ã‚‚ç”Ÿæˆã™ã‚‹ã®ã§ã“ã®å‡¦ç†ã®æµã‚Œã¯nextest runå®Ÿè¡Œæ™‚ã‚‚åŒã˜ã§ã™ã€‚ æº–å‚™ãŒã§ããŸã®ã§æ¬¡ã¯ã„ã‚ˆã„ã‚ˆnextestãŒã„ã†test caseã®ä¸¦åˆ—å®Ÿè¡Œã®ä»•çµ„ã¿ã‚’ã¿ã¦ã„ãã¾ã™ã€‚<h2 id=cargo-nextest-run><a aria-label="Anchor link for: cargo-nextest-run" class=zola-anchor href=#cargo-nextest-run><code>cargo nextest run</code></a></h2><p>runå®Ÿè¡Œæ™‚ã‚‚listã¨åŒæ§˜ã€<code>App::new()</code>å‡¦ç†ã§<code>PackageMetadata</code>ã‚’å–å¾—ã™ã‚‹ã¨ã“ã‚ã¾ã§ã¯å…±é€šã§ã™ã€‚<h3 id=app-exec-run><a aria-label="Anchor link for: app-exec-run" class=zola-anchor href=#app-exec-run><code>App::exec_run()</code></a></h3><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> exec_run</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#81a1c1>        &self</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        profile_name</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>&</span><span style=color:#8fbcbb>str</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>        no_capture</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> bool</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        runner_opts</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>TestRunnerOpts</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        reporter_opts</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>TestReporterOpts</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        output_writer</span><span style=color:#81a1c1>: &mut</span><span style=color:#8fbcbb> OutputWriter</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    )</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> config</span><span style=color:#81a1c1> = self</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span>config_opts</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>make_config</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span>workspace_root</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_path</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> profile</span><span style=color:#81a1c1> = self.</span><span style=color:#88c0d0>load_profile</span><span style=color:#eceff4>(</span><span>profile_name</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> &</span><span>config</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> target_runner</span><span style=color:#81a1c1> = self.</span><span style=color:#88c0d0>load_runner</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> binary_list</span><span style=color:#81a1c1> = self.</span><span style=color:#88c0d0>build_binary_list</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> test_list</span><span style=color:#81a1c1> = self.</span><span style=color:#88c0d0>build_test_list</span><span style=color:#eceff4>(</span><span>binary_list</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> &</span><span>target_runner</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> reporter</span><span style=color:#81a1c1> =</span><span> reporter_opts</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>to_builder</span><span style=color:#eceff4>(</span><span>no_capture</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>set_verbose</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span>output</span><span style=color:#81a1c1>.</span><span>verbose</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>build</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>test_list</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> &</span><span>profile</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if self.</span><span>output</span><span style=color:#81a1c1>.</span><span>color</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>should_colorize</span><span style=color:#eceff4>(</span><span>Stream</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Stderr</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span>            reporter</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>colorize</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> handler</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> SignalHandler</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>wrap_err</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>failed to set up Ctrl-C handler</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> runner_builder</span><span style=color:#81a1c1> =</span><span> runner_opts</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_builder</span><span style=color:#eceff4>(</span><span>no_capture</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> runner</span><span style=color:#81a1c1> =</span><span> runner_builder</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>build</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>test_list</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> &</span><span>profile</span><span style=color:#eceff4>,</span><span> handler</span><span style=color:#eceff4>,</span><span> target_runner</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> writer</span><span style=color:#81a1c1> =</span><span> output_writer</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>stderr_writer</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> run_stats</span><span style=color:#81a1c1> =</span><span> runner</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>try_execute</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>event</span><span style=color:#81a1c1>|</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>            // Write and flush the event.</span></span>
<span class=giallo-l><span>            reporter</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>report_event</span><span style=color:#eceff4>(</span><span>event</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> &mut</span><span> writer</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span>            writer</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>flush</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>map_err</span><span style=color:#eceff4>(</span><span>WriteEventError</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Io</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>        })</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if !</span><span>run_stats</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>is_success</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            return</span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Report</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>ExpectedError</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>test_run_failed</span><span style=color:#eceff4>()));</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Ok</span><span style=color:#eceff4>(())</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span></code></pre><p><a href=https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/cargo-nextest/src/dispatch.rs#L564 rel=external>https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/cargo-nextest/src/dispatch.rs#L564</a><p>runã‚³ãƒãƒ³ãƒ‰ã¯<code>App::exec_run()</code>ã‹ã‚‰å§‹ã¾ã‚Šã¾ã™ã€‚<br> ç¬¬ä¸€å¼•æ•°ã®<code>profile_name</code>ã¯<code>cargo nextest run --profile ci</code>ã®ã‚ˆã†ãªprofileæŒ‡å®šã§ã™ã€‚<br> ç¬¬äºŒå¼•æ•°ã®<code>no_capture</code>ã¯testã®stdout/stderrã‚’å‡ºåŠ›ã™ã‚‹ã‹ã©ã†ã‹ã€thread poolã®threadæ•°ã«å½±éŸ¿ã—ã¾ã™ã€‚<br> ç¬¬ä¸‰å¼•æ•°ã®<code>runner_opts</code>ã¯<code>cargo nexest run --test-thread=4 --retries=2 --fail-fast</code>ã®ã‚ˆã†ãªtestå®Ÿè¡Œæ™‚ã®æŒ™å‹•åˆ¶å¾¡ç”¨ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ã™ã€‚<br> ç¬¬å››å¼•æ•°ã®<code>reporter_opts</code>ã¯æˆåŠŸ/å¤±æ•—æ™‚ã®å‡ºåŠ›åˆ¶å¾¡ã¨testã®status(pass, skip,fail,...)ã®å‡ºåŠ›ãƒ¬ãƒ™ãƒ«ã®æŒ‡å®šã§ã™ã€‚ ç¬¬äº”å¼•æ•°ã®<code>output_writer</code>ã¯å‡ºåŠ›ç”¨ã®stdout/stderrã®æŠ½è±¡åŒ–ã§ã€nextestè‡ªä½“ã®testæ™‚ã¯buffer(Vec<u8>)æ¸¡ã›ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚ <pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>let</span><span> config</span><span style=color:#81a1c1> = self</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span>config_opts</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>make_config</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span>workspace_root</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_path</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>let</span><span> profile</span><span style=color:#81a1c1> = self.</span><span style=color:#88c0d0>load_profile</span><span style=color:#eceff4>(</span><span>profile_name</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> &</span><span>config</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>let</span><span> target_runner</span><span style=color:#81a1c1> = self.</span><span style=color:#88c0d0>load_runner</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>let</span><span> binary_list</span><span style=color:#81a1c1> = self.</span><span style=color:#88c0d0>build_binary_list</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>let</span><span> test_list</span><span style=color:#81a1c1> = self.</span><span style=color:#88c0d0>build_test_list</span><span style=color:#eceff4>(</span><span>binary_list</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> &</span><span>target_runner</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>let mut</span><span> reporter</span><span style=color:#81a1c1> =</span><span> reporter_opts</span></span>
<span class=giallo-l><span style=color:#81a1c1>    .</span><span style=color:#88c0d0>to_builder</span><span style=color:#eceff4>(</span><span>no_capture</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>    .</span><span style=color:#88c0d0>set_verbose</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span>output</span><span style=color:#81a1c1>.</span><span>verbose</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>    .</span><span style=color:#88c0d0>build</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>test_list</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> &</span><span>profile</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>if self.</span><span>output</span><span style=color:#81a1c1>.</span><span>color</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>should_colorize</span><span style=color:#eceff4>(</span><span>Stream</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Stderr</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span>    reporter</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>colorize</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre> <p>ã“ã“ã¾ã§ã§ã€configã‚’loadã—ã¦<code>TargetRunner</code>ã‚’å–å¾—ã—ã¾ã™ã€‚ä»Šå›ã¯<code>TargetRunner</code>ã«ã¯test binaryå®Ÿè¡Œæ™‚ã«æŒ‡å®šã®binaryã‚’å®Ÿè¡Œã™ã‚‹ä»•çµ„ã¿ã®ã‚ˆã†ã§ã™ã€‚(test binaryã¯ãã®å¼•æ•°ã«ãªã‚‹)</p> <p><code>binary_list</code>ã¨<code>test_list</code>ã¯listã‚³ãƒãƒ³ãƒ‰ã§ç”Ÿæˆã—ãŸã‚‚ã®ã¨åŒã˜ã§ã™ã€‚ã—ãŸãŒã£ã¦ã“ã“ã¾ã§ã§å®Ÿè¡Œã™ã‚‹test caseã®å–å¾—å‡¦ç†ã¯å®Œäº†ã—ã¦ã„ã¾ã™ã€‚<br> <a href=https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/nextest-runner/src/reporter.rs#L262 rel=external><code>TestReporter</code></a>ã¯option(config)ã§æŒ‡å®šã—ãŸå‡ºåŠ›è¨­å®šã«å¿œã˜ãŸå‡ºåŠ›å‡¦ç†ã‚’è¡Œãªã£ã¦ãã‚Œã¾ã™ã€‚</p> <pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>let</span><span> handler</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> SignalHandler</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>wrap_err</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>failed to set up Ctrl-C handler</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>let</span><span> runner_builder</span><span style=color:#81a1c1> =</span><span> runner_opts</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_builder</span><span style=color:#eceff4>(</span><span>no_capture</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>let</span><span> runner</span><span style=color:#81a1c1> =</span><span> runner_builder</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>build</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>test_list</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> &</span><span>profile</span><span style=color:#eceff4>,</span><span> handler</span><span style=color:#eceff4>,</span><span> target_runner</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>let mut</span><span> writer</span><span style=color:#81a1c1> =</span><span> output_writer</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>stderr_writer</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>let</span><span> run_stats</span><span style=color:#81a1c1> =</span><span> runner</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>try_execute</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>event</span><span style=color:#81a1c1>|</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>    // Write and flush the event.</span></span>
<span class=giallo-l><span>    reporter</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>report_event</span><span style=color:#eceff4>(</span><span>event</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> &mut</span><span> writer</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span>    writer</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>flush</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>map_err</span><span style=color:#eceff4>(</span><span>WriteEventError</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Io</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>})</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span></code></pre> <p>ã“ã“ãŒrunã‚³ãƒãƒ³ãƒ‰ã®ãƒ¡ã‚¤ãƒ³ã®å‡¦ç†ã§ã€<a href=https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/nextest-runner/src/runner.rs#L108 rel=external><code>TestRunner</code></a>ã‚’ç”Ÿæˆã—ã¦ã€testã‚’å®Ÿè¡Œã—ã¦ã„ãã¾ã™ã€‚ã¾ãšã¯<code>TestRunner</code>ã®ç”Ÿæˆå‡¦ç†ã‹ã‚‰ã¿ã¦ã„ãã¾ã™ã€‚</p> <h3 id=testrunnerbuilder-build><a aria-label="Anchor link for: testrunnerbuilder-build" class=zola-anchor href=#testrunnerbuilder-build><code>TestRunnerBuilder::build()</code></a></h3> <pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#616e88>    /// Creates a new test runner.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> build</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>>(</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        test_list</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>a TestList</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        profile</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>NextestProfile</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>        handler</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> SignalHandler</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        target_runner</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> TargetRunner</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    )</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> TestRunner</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> test_threads</span><span style=color:#81a1c1> = match self.</span><span>no_capture </span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>            true =></span><span style=color:#b48ead> 1</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>            false => self.</span><span>test_threads</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap_or_else</span><span style=color:#eceff4>(</span><span>num_cpus</span><span style=color:#81a1c1>::</span><span>get</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>        };</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> retries</span><span style=color:#81a1c1> = self.</span><span>retries</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap_or_else</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>||</span><span> profile</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>retries</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> fail_fast</span><span style=color:#81a1c1> = self.</span><span>fail_fast</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap_or_else</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>||</span><span> profile</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>fail_fast</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> slow_timeout</span><span style=color:#81a1c1> =</span><span> profile</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>slow_timeout</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        TestRunner</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            no_capture</span><span style=color:#81a1c1>: self.</span><span>no_capture</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#616e88>            // The number of tries = retries + 1.</span></span>
<span class=giallo-l><span>            tries</span><span style=color:#81a1c1>:</span><span> retries</span><span style=color:#81a1c1> +</span><span style=color:#b48ead> 1</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            fail_fast</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            slow_timeout</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            test_list</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            target_runner</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            run_pool</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> ThreadPoolBuilder</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#616e88>                // The main run_pool closure will need its own thread.</span></span>
<span class=giallo-l><span style=color:#81a1c1>                .</span><span style=color:#88c0d0>num_threads</span><span style=color:#eceff4>(</span><span>test_threads</span><span style=color:#81a1c1> +</span><span style=color:#b48ead> 1</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>                .</span><span style=color:#88c0d0>thread_name</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>idx</span><span style=color:#81a1c1>|</span><span style=color:#88c0d0;font-weight:700> format!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>testrunner-run-</span><span style=color:#ebcb8b>{}</span><span style=color:#eceff4>",</span><span> idx</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#81a1c1>                .</span><span style=color:#88c0d0>build</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>                .</span><span style=color:#88c0d0>expect</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>run pool built</span><span style=color:#eceff4>"),</span></span>
<span class=giallo-l><span>            wait_pool</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> ThreadPoolBuilder</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>                .</span><span style=color:#88c0d0>num_threads</span><span style=color:#eceff4>(</span><span>test_threads</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>                .</span><span style=color:#88c0d0>thread_name</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>idx</span><span style=color:#81a1c1>|</span><span style=color:#88c0d0;font-weight:700> format!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>testrunner-wait-</span><span style=color:#ebcb8b>{}</span><span style=color:#eceff4>",</span><span> idx</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#81a1c1>                .</span><span style=color:#88c0d0>build</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>                .</span><span style=color:#88c0d0>expect</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>run pool built</span><span style=color:#eceff4>"),</span></span>
<span class=giallo-l><span>            handler</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span></code></pre> <p><a href=https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/nextest-runner/src/runner.rs#L66 rel=external>https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/nextest-runner/src/runner.rs#L66</a></p> <p>ã“ã®å‡¦ç†ã§ã€<code>cargo nextest run --no-capture</code>ã‚’æŒ‡å®šã™ã‚‹ã¨threadæ•°ãŒ1ã«è¨­å®šã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚<br> thread poolã®builderã¨ã—ã¦åˆ©ç”¨ã•ã‚Œã¦ã„ã‚‹ã®ã¯<a href=https://github.com/rayon-rs/rayon/blob/f45eee8fa49c1646a00f084ca78d362f381f1b65/rayon-core/src/lib.rs#L142 rel=external>rayonã®<code>ThreadPoolBuilder</code></a>ã§ã™ã€‚<br> defaultã®threadæ•°ã¯<code>num_cpus::get()</code>ã§CPUã®è«–ç†ã‚³ã‚¢æ•°ãŒåˆ©ç”¨ã•ã‚Œã¾ã™ã€‚(è›‡è¶³ã§ã™ãŒã€é–“é•ãˆã¦<code>num_cpu</code> (sãŒãªã„)ã‚’ä½¿ã£ãŸæ™‚è­¦å‘ŠãŒå‡ºã¾ã—ãŸã€‚ä¾å­˜crateã®typoã¯çµæ§‹å±ãªã„ã€‚[https://kerkour.com/rust-crate-backdoor]). ThreadPoolãŒ<code>run_pool</code>ã¨<code>wait_pool</code>ã®äºŒã¤ã‚ã‚‹ã¨ã“ã‚ãŒãƒã‚¤ãƒ³ãƒˆã§ã€äºŒã¤å¿…è¦ãªç†ç”±ã¯å¾Œè¿°ã—ã¾ã™ã€‚</p> <h3 id=runner-try-execute><a aria-label="Anchor link for: runner-try-execute" class=zola-anchor href=#runner-try-execute><code>Runner::try_execute()</code></a></h3> <p><a href=https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/nextest-runner/src/runner.rs#L139 rel=external><code>Runner::try_execute()</code></a>ãŒtestå®Ÿè¡Œå‡¦ç†ã§ã™ã€‚</p> <p>ã“ã®é•·ã„å‡¦ç†ã‚’ã¿ã¦ã„ãå‰ã«<code>try_execute()</code>ã®ç°¡æ˜“ç‰ˆã‚’èª¬æ˜ã—ã¾ã™ã€‚</p> <pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span> anyhow</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> n</span><span style=color:#81a1c1> =</span><span> num_cpus</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>get</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> pool</span><span style=color:#81a1c1> =</span><span> rayon</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>ThreadPoolBuilder</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>num_threads</span><span style=color:#eceff4>(</span><span>n</span><span style=color:#81a1c1> +</span><span style=color:#b48ead> 1</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>build</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> wait_pool</span><span style=color:#81a1c1> =</span><span> rayon</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>ThreadPoolBuilder</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>num_threads</span><span style=color:#eceff4>(</span><span>n</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>build</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    println!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>num_cpus: </span><span style=color:#ebcb8b>{}</span><span style=color:#eceff4>",</span><span> n</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>    pool</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>scope</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>scope</span><span style=color:#81a1c1>|</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        for</span><span> _</span><span style=color:#81a1c1> in</span><span style=color:#b48ead> 0</span><span style=color:#81a1c1>..</span><span>n</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            scope</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>spawn</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>_scope</span><span style=color:#81a1c1>|</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                let</span><span> thread_id</span><span style=color:#81a1c1> =</span><span> std</span><span style=color:#81a1c1>::</span><span>thread</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>current</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>id</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>                println!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>thread: </span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>:?</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>",</span><span> thread_id</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>                let</span><span> cmd</span><span style=color:#81a1c1> =</span><span> duct</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>cmd</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>sleep</span><span style=color:#eceff4>", ["</span><span style=color:#a3be8c>5</span><span style=color:#eceff4>"]);</span></span>
<span class=giallo-l><span style=color:#81a1c1>                let</span><span> handle</span><span style=color:#81a1c1> =</span><span> cmd</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>start</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l></span>
<span class=giallo-l><span>                wait_pool</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>in_place_scope</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>scope</span><span style=color:#81a1c1>|</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    let</span><span style=color:#eceff4> (</span><span>sender</span><span style=color:#eceff4>,</span><span> receiver</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span>crossbeam_channel</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>bounded</span><span style=color:#eceff4>(</span><span style=color:#b48ead>1</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>                    scope</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>spawn</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>move |</span><span>scope</span><span style=color:#81a1c1>|</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                        let</span><span> _</span><span style=color:#81a1c1> =</span><span> handle</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>wait</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>                        let</span><span> _</span><span style=color:#81a1c1> =</span><span> sender</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>send</span><span style=color:#eceff4>(());</span></span>
<span class=giallo-l><span style=color:#eceff4>                    });</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>                    while let</span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> receiver</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>recv_timeout</span><span style=color:#eceff4>(</span><span>std</span><span style=color:#81a1c1>::</span><span>time</span><span style=color:#81a1c1>::</span><span>Duration</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_secs</span><span style=color:#eceff4>(</span><span style=color:#b48ead>2</span><span style=color:#eceff4>)) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                        match</span><span> err</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                            crossbeam_channel</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>RecvTimeoutError</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Timeout</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>                                println!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>receive: </span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>:?</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>",</span><span> thread_id</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>                            }</span></span>
<span class=giallo-l><span>                            _</span><span style=color:#81a1c1> =></span><span style=color:#88c0d0;font-weight:700> unreachable!</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>                        }</span></span>
<span class=giallo-l><span style=color:#eceff4>                    }</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>                    println!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>thread: </span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>:?</span><span style=color:#ebcb8b>}</span><span style=color:#a3be8c> done</span><span style=color:#eceff4>",</span><span> thread_id</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>                });</span></span>
<span class=giallo-l><span style=color:#eceff4>            })</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    });</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>    Ok</span><span style=color:#eceff4>(())</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span></code></pre><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=toml><span class=giallo-l><span style=color:#eceff4>[</span><span>dependencies</span><span style=color:#eceff4>]</span></span>
<span class=giallo-l><span>anyhow</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>1.0.56</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span>rayon</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>1.5.1</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span>num_cpus</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>1.13.1</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span>duct</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>0.9.1</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span>crossbeam-channel</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>0.5.2</span><span style=color:#eceff4>"</span></span></code></pre> <p>rayonã®ThreadPoolã‚’ä½¿ã£ãŸã“ã¨ãŒãªã„ã¨ã‚ã‹ã‚Šã¥ã‚‰ã„ã®ã§èª­ã¿æ–¹ã‚’èª¬æ˜ã—ã¾ã™ã€‚<br> <code>pool.scope()</code>ã¯thread poolã§å®Ÿè¡Œã™ã‚‹taskã‚’ç”Ÿæˆã™ã‚‹<code>scope.spawn()</code>ã«æ¸¡ã™closureã§å‚ç…§ã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã®ä»•çµ„ã¿ãã‚‰ã„ã®ç†è§£ã§å¤§ä¸ˆå¤«ã§ã™ã€‚(è‡ªåˆ†ãŒãã®ç¨‹åº¦ã®ç†è§£)ã€‚ <code>pool.scope()</code>ã¯æ¸¡ã•ã‚ŒãŸclosureãŒç”Ÿæˆã—ãŸtaskãŒã™ã¹ã¦çµ‚äº†ã™ã‚‹ã¾ã§blockã—ã¾ã™ã€‚<br> <code>scope.spawn()</code>ã«æ¸¡ã•ã‚ŒãŸclosureãŒå„test caseã®å®Ÿè¡Œå‡¦ç†ã ã¨æ€ã£ã¦ãã ã•ã„ã€‚ã“ã“ã§ã¯<code>sleep</code>ã§ä»£æ›¿ã—ã¦ã„ã¾ã™ãŒã€<code>doct::cmd</code>ã‚’åˆ©ç”¨ã™ã‚‹ç‚¹ã¯åŒã˜ã€‚<br> <code>cmd.start()</code>ã™ã‚‹ã¨ãƒ—ãƒ­ã‚»ã‚¹ãŒå®Ÿè¡Œã•ã‚Œã€åˆ¶å¾¡ç”¨ã®handleãŒè¿”ã•ã‚Œã¾ã™ã€‚ã“ã“ã§blockã—ã¦ã‚‚ã‚ˆã„ã®ã§ã™ãŒã€test caseã®timeoutã‚’æ•æ‰ã™ã‚‹ãŸã‚ã«ã€test caseçµ‚äº†ã‚’å¾…æ©Ÿã™ã‚‹taskã‚’ç”Ÿæˆã—ã¾ã™ã€‚ã“ã®taskã¯å…ˆã»ã©ç”Ÿæˆã—ãŸ<code>wait_pool</code>å´ã«ç”Ÿæˆã—ã¾ã™ã€‚<br> ãŸã ã—ã€<code>wait_pool.in_place_scope()</code>ã§å¾…æ©Ÿå‡¦ç†ã‚’è¡Œãªã£ã¦ã„ã‚‹ã®ã§ã€test case processã®å¾…æ©Ÿè‡ªä½“ã¯<code>pool</code>ã®ThreadPoolã®threadã§å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚çµæœçš„ã«æœ€å¤§ã§ä¸¦åˆ—ã«å®Ÿè¡Œã•ã‚Œã‚‹test caseã¯æŒ‡å®šã•ã‚ŒãŸthreadæ•°(<code>num_cpus::get()</code>)ã«ãªã‚Šã¾ã™ã€‚</p> <p>ThreadPoolã®ä½¿ã‚ã‚Œæ–¹ã‚’æŠ‘ãˆãŸã¨ã“ã‚ã§å®Ÿéš›ã®å‡¦ç†ã¯ã“ã¡ã‚‰ã§ã™ã€‚</p> <pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> try_execute</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>E</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> F</span><span style=color:#eceff4>>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> callback</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> F</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>RunStats</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> E</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>    where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        F</span><span style=color:#81a1c1>:</span><span style=color:#88c0d0> FnMut</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>TestEvent</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;(),</span><span style=color:#8fbcbb> E</span><span style=color:#eceff4>></span><span style=color:#81a1c1> +</span><span style=color:#8fbcbb> Send</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        E</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Send</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    {</span></span>
<span class=giallo-l><span style=color:#616e88>        // TODO: add support for other test-running approaches, measure performance.</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span style=color:#eceff4> (</span><span>run_sender</span><span style=color:#eceff4>,</span><span> run_receiver</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> crossbeam_channel</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>unbounded</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>        // This is move so that sender is moved into it. When the scope finishes the sender is</span></span>
<span class=giallo-l><span style=color:#616e88>        // dropped, and the receiver below completes iteration.</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> canceled</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> AtomicBool</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>false</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> canceled_ref</span><span style=color:#81a1c1> = &</span><span>canceled</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> ctx</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> CallbackContext</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>callback</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> self.</span><span>test_list</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>run_count</span><span style=color:#eceff4>(),</span><span style=color:#81a1c1> self.</span><span>fail_fast</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>        // Send the initial event.</span></span>
<span class=giallo-l><span style=color:#616e88>        // (Don't need to set the canceled atomic if this fails because the run hasn't started</span></span>
<span class=giallo-l><span style=color:#616e88>        // yet.)</span></span>
<span class=giallo-l><span>        ctx</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>run_started</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span>test_list</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>        // Stores the first error that occurred. This error is propagated up.</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> first_error</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> None</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> ctx_mut</span><span style=color:#81a1c1> = &mut</span><span> ctx</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> first_error_mut</span><span style=color:#81a1c1> = &mut</span><span> first_error</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>        // ---</span></span>
<span class=giallo-l><span style=color:#616e88>        // Spawn the test threads.</span></span>
<span class=giallo-l><span style=color:#616e88>        // ---</span></span>
<span class=giallo-l><span style=color:#616e88>        // XXX rayon requires its scope callback to be Send, there's no good reason for it but</span></span>
<span class=giallo-l><span style=color:#616e88>        // there's also no other well-maintained scoped threadpool :(</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>run_pool</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>scope</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>move |</span><span>run_scope</span><span style=color:#81a1c1>|</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            self.</span><span>test_list</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>iter_tests</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>for_each</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>test_instance</span><span style=color:#81a1c1>|</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                if</span><span> canceled_ref</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>load</span><span style=color:#eceff4>(</span><span>Ordering</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Acquire</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#616e88>                    // Check for test cancellation.</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    return</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>                let</span><span> this_run_sender</span><span style=color:#81a1c1> =</span><span> run_sender</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span>                run_scope</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>spawn</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>move |</span><span>_</span><span style=color:#81a1c1>|</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    if</span><span> canceled_ref</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>load</span><span style=color:#eceff4>(</span><span>Ordering</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Acquire</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#616e88>                        // Check for test cancellation.</span></span>
<span class=giallo-l><span style=color:#81a1c1>                        return</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>                    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>                    if let</span><span> FilterMatch</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Mismatch</span><span style=color:#eceff4> {</span><span> reason</span><span style=color:#eceff4> }</span><span style=color:#81a1c1> =</span><span> test_instance</span><span style=color:#81a1c1>.</span><span>test_info</span><span style=color:#81a1c1>.</span><span>filter_match </span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#616e88>                        // Failure to send means the receiver was dropped.</span></span>
<span class=giallo-l><span style=color:#81a1c1>                        let</span><span> _</span><span style=color:#81a1c1> =</span><span> this_run_sender</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>send</span><span style=color:#eceff4>(</span><span>InternalTestEvent</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Skipped</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                            test_instance</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>                            reason</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>                        });</span></span>
<span class=giallo-l><span style=color:#81a1c1>                        return</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>                    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>                    // Failure to send means the receiver was dropped.</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    let</span><span> _</span><span style=color:#81a1c1> =</span><span> this_run_sender</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>send</span><span style=color:#eceff4>(</span><span>InternalTestEvent</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Started</span><span style=color:#eceff4> {</span><span> test_instance</span><span style=color:#eceff4> });</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>                    let mut</span><span> run_statuses</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0;font-weight:700> vec!</span><span style=color:#eceff4>[];</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>                    loop</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                        let</span><span> attempt</span><span style=color:#81a1c1> =</span><span> run_statuses</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>len</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> +</span><span style=color:#b48ead> 1</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>                        let</span><span> run_status</span><span style=color:#81a1c1> = self</span></span>
<span class=giallo-l><span style=color:#81a1c1>                            .</span><span style=color:#88c0d0>run_test</span><span style=color:#eceff4>(</span><span>test_instance</span><span style=color:#eceff4>,</span><span> attempt</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> &</span><span>this_run_sender</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>                            .</span><span style=color:#88c0d0>into_external</span><span style=color:#eceff4>(</span><span>attempt</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> self.</span><span>tries</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>                        if</span><span> run_status</span><span style=color:#81a1c1>.</span><span>result</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>is_success</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#616e88>                            // The test succeeded.</span></span>
<span class=giallo-l><span>                            run_statuses</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>push</span><span style=color:#eceff4>(</span><span>run_status</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>                            break</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>                        }</span><span style=color:#81a1c1> else if</span><span> attempt</span><span style=color:#81a1c1> &lt; self.</span><span>tries </span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#616e88>                            // Retry this test: send a retry event, then retry the loop.</span></span>
<span class=giallo-l><span style=color:#81a1c1>                            let</span><span> _</span><span style=color:#81a1c1> =</span><span> this_run_sender</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>send</span><span style=color:#eceff4>(</span><span>InternalTestEvent</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Retry</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                                test_instance</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>                                run_status</span><span style=color:#81a1c1>:</span><span> run_status</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>                            });</span></span>
<span class=giallo-l><span>                            run_statuses</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>push</span><span style=color:#eceff4>(</span><span>run_status</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>                        }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>                            // This test failed and is out of retries.</span></span>
<span class=giallo-l><span>                            run_statuses</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>push</span><span style=color:#eceff4>(</span><span>run_status</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>                            break</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>                        }</span></span>
<span class=giallo-l><span style=color:#eceff4>                    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>                    // At this point, either:</span></span>
<span class=giallo-l><span style=color:#616e88>                    // * the test has succeeded, or</span></span>
<span class=giallo-l><span style=color:#616e88>                    // * the test has failed and we've run out of retries.</span></span>
<span class=giallo-l><span style=color:#616e88>                    // In either case, the test is finished.</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    let</span><span> _</span><span style=color:#81a1c1> =</span><span> this_run_sender</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>send</span><span style=color:#eceff4>(</span><span>InternalTestEvent</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Finished</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                        test_instance</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>                        run_statuses</span><span style=color:#81a1c1>:</span><span> ExecutionStatuses</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>run_statuses</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>                    });</span></span>
<span class=giallo-l><span style=color:#eceff4>                })</span></span>
<span class=giallo-l><span style=color:#eceff4>            });</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>            drop</span><span style=color:#eceff4>(</span><span>run_sender</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>            loop</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                let</span><span> internal_event</span><span style=color:#81a1c1> =</span><span> crossbeam_channel</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0;font-weight:700>select!</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0>                    recv</span><span style=color:#eceff4>(</span><span>run_receiver</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span> internal_event</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                        match</span><span> internal_event</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                            Ok</span><span style=color:#eceff4>(</span><span>event</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> InternalEvent</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Test</span><span style=color:#eceff4>(</span><span>event</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                            Err</span><span style=color:#eceff4>(</span><span>_</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>                                // All runs have been completed.</span></span>
<span class=giallo-l><span style=color:#81a1c1>                                break</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>                            }</span></span>
<span class=giallo-l><span style=color:#eceff4>                        }</span></span>
<span class=giallo-l><span style=color:#eceff4>                    },</span></span>
<span class=giallo-l><span style=color:#88c0d0>                    recv</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span>handler</span><span style=color:#81a1c1>.</span><span>receiver</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span> internal_event</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                        match</span><span> internal_event</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                            Ok</span><span style=color:#eceff4>(</span><span>event</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> InternalEvent</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Signal</span><span style=color:#eceff4>(</span><span>event</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                            Err</span><span style=color:#eceff4>(</span><span>_</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>                                // Ignore the signal thread being dropped. This is done for</span></span>
<span class=giallo-l><span style=color:#616e88>                                // noop signal handlers.</span></span>
<span class=giallo-l><span style=color:#81a1c1>                                continue</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>                            }</span></span>
<span class=giallo-l><span style=color:#eceff4>                        }</span></span>
<span class=giallo-l><span style=color:#eceff4>                    },</span></span>
<span class=giallo-l><span style=color:#eceff4>                };</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>                match</span><span> ctx_mut</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>handle_event</span><span style=color:#eceff4>(</span><span>internal_event</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                    Ok</span><span style=color:#eceff4>(())</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {}</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                    Err</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>                        // If an error happens, it is because either the callback failed or</span></span>
<span class=giallo-l><span style=color:#616e88>                        // a cancellation notice was received. If the callback failed, we need</span></span>
<span class=giallo-l><span style=color:#616e88>                        // to send a further cancellation notice as well.</span></span>
<span class=giallo-l><span>                        canceled_ref</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>store</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>true</span><span style=color:#eceff4>,</span><span> Ordering</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Release</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>                        match</span><span> err</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                            InternalError</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Error</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>                                // Ignore errors that happen during error cancellation.</span></span>
<span class=giallo-l><span style=color:#81a1c1>                                if</span><span> first_error_mut</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>is_none</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                                    *</span><span>first_error_mut</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>                                }</span></span>
<span class=giallo-l><span style=color:#81a1c1>                                let</span><span> _</span><span style=color:#81a1c1> =</span><span> ctx_mut</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>begin_cancel</span><span style=color:#eceff4>(</span><span>CancelReason</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>ReportError</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>                            }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                            InternalError</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>TestFailureCanceled</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>None</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>                            |</span><span style=color:#8fbcbb> InternalError</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>SignalCanceled</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>None</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>                                // Cancellation has begun and no error was returned during that.</span></span>
<span class=giallo-l><span style=color:#616e88>                                // Continue to handle events.</span></span>
<span class=giallo-l><span style=color:#eceff4>                            }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                            InternalError</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>TestFailureCanceled</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Some</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#81a1c1>                            |</span><span style=color:#8fbcbb> InternalError</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>SignalCanceled</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Some</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#eceff4>))</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>                                // Cancellation has begun and an error was received during</span></span>
<span class=giallo-l><span style=color:#616e88>                                // cancellation.</span></span>
<span class=giallo-l><span style=color:#81a1c1>                                if</span><span> first_error_mut</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>is_none</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                                    *</span><span>first_error_mut</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>                                }</span></span>
<span class=giallo-l><span style=color:#eceff4>                            }</span></span>
<span class=giallo-l><span style=color:#eceff4>                        }</span></span>
<span class=giallo-l><span style=color:#eceff4>                    }</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>            Ok</span><span style=color:#eceff4>(())</span></span>
<span class=giallo-l><span style=color:#eceff4>        })</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        match</span><span> ctx</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>run_finished</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Ok</span><span style=color:#eceff4>(())</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {}</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Err</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                if</span><span> first_error</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>is_none</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span>                    first_error</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        match</span><span> first_error</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            None</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>(</span><span>ctx</span><span style=color:#81a1c1>.</span><span>run_stats</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Some</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span></code></pre> <p><a href=https://blog.ymgyt.io/entry/cargo-nextest/%5Bhttps://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/nextest-runner/src/runner.rs#L139%5D>https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/nextest-runner/src/runner.rs#L139</a></p> <p>é•·ã„ã§ã™ãŒã‚„ã£ã¦ã„ã‚‹ã“ã¨ã¯ã‚·ãƒ³ãƒ—ãƒ«ã§ã™ã€‚</p> <ol><li><code>self.test_list.iter_tests().for_each()</code> ã§test caseã‚’iterateã™ã‚‹ã€‚<li>runner thread poolã«1ã¤ã®test caseã‚’å®Ÿè¡Œã™ã‚‹processã‚’ç«‹ã¡ä¸Šã’ã‚‹taskã‚’ç™»éŒ²ã™ã‚‹ã€‚<code>run_scope.spawn()</code><li>ã“ã®taskã¯retryãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆè¦å®šå›æ•°ã®retryã‚’è©¦ã¿ã‚‹<li>test caseã®å®Ÿè¡Œçµæœã‚’ç™»éŒ²ã™ã‚‹<li>main threadã¯ã™ã¹ã¦ã®test caseã®taskã‚’spawnã—çµ‚ãˆãŸã‚‰å„test caseç”¨ã®taskã«æ¸¡ã—ãŸevent channelã‚’receiveã—ç¶šã‘ã‚‹ã€‚<li>ãã®éš›ã€signal(ctrl-c)ã‚’è€ƒæ…®ã™ã‚‹<li>test caseå®Ÿè¡Œã«ã¾ã¤ã‚ã‚‹å„ç¨®event(start, success,timeout,...)ã‚’æ¸¡ã•ã‚ŒãŸcallbackã«æ¸¡ã™ã€‚</ol> <p>ã–ã£ãã‚Šã§ã™ãŒã“ã‚ŒãŒãƒ¡ã‚¤ãƒ³ã®loopå‡¦ç†ã®æ¦‚è¦ã§ã™ã€‚<br> æ¬¡ã«å®Ÿéš›ã®test caseã¯ã©ã®ã‚ˆã†ã«å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‹ã¿ã¦ã„ãã¾ã™ã€‚</p> <h3 id=testrunner-run-test><a aria-label="Anchor link for: testrunner-run-test" class=zola-anchor href=#testrunner-run-test><code>TestRunner::run_test()</code></a></h3> <pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#616e88>    /// Run an individual test in its own process.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> run_test</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#81a1c1>        &self</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        test</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> TestInstance</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>        attempt</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> usize</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        run_sender</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Sender</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>InternalTestEvent</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    )</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> InternalExecuteStatus</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> stopwatch</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> StopwatchStart</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>now</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        match self.</span><span style=color:#88c0d0>run_test_inner</span><span style=color:#eceff4>(</span><span>test</span><span style=color:#eceff4>,</span><span> attempt</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> &</span><span>stopwatch</span><span style=color:#eceff4>,</span><span> run_sender</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Ok</span><span style=color:#eceff4>(</span><span>run_status</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span> run_status</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Err</span><span style=color:#eceff4>(</span><span>_</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> InternalExecuteStatus</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>                // TODO: can we return more information in stdout/stderr? investigate this</span></span>
<span class=giallo-l><span>                stdout</span><span style=color:#81a1c1>:</span><span style=color:#88c0d0;font-weight:700> vec!</span><span style=color:#eceff4>[],</span></span>
<span class=giallo-l><span>                stderr</span><span style=color:#81a1c1>:</span><span style=color:#88c0d0;font-weight:700> vec!</span><span style=color:#eceff4>[],</span></span>
<span class=giallo-l><span>                result</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> ExecutionResult</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>ExecFail</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>                stopwatch_end</span><span style=color:#81a1c1>:</span><span> stopwatch</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>end</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>            },</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> run_test_inner</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#81a1c1>        &self</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        test</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> TestInstance</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>        attempt</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> usize</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        stopwatch</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>StopwatchStart</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        run_sender</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Sender</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>InternalTestEvent</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>a</span><span style=color:#eceff4>>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    )</span><span style=color:#81a1c1> -></span><span> std</span><span style=color:#81a1c1>::</span><span>io</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>InternalExecuteStatus</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> cmd</span><span style=color:#81a1c1> =</span><span> test</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>make_expression</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self.</span><span>target_runner</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>unchecked</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#616e88>            // Debug environment variable for testing.</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>env</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>__NEXTEST_ATTEMPT</span><span style=color:#eceff4>",</span><span style=color:#88c0d0;font-weight:700> format!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{}</span><span style=color:#eceff4>",</span><span> attempt</span><span style=color:#eceff4>));</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> cmd</span><span style=color:#81a1c1> = if self.</span><span>no_capture </span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span>            cmd</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>            // Capture stdout and stderr.</span></span>
<span class=giallo-l><span>            cmd</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>stdout_capture</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>stderr_capture</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>        };</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> handle</span><span style=color:#81a1c1> =</span><span> cmd</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>start</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>wait_pool</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>in_place_scope</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>s</span><span style=color:#81a1c1>|</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let</span><span style=color:#eceff4> (</span><span>sender</span><span style=color:#eceff4>,</span><span> receiver</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> crossbeam_channel</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>bounded</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>&lt;()>(</span><span style=color:#b48ead>1</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let</span><span> wait_handle</span><span style=color:#81a1c1> = &</span><span>handle</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>            // Spawn a task on the threadpool that waits for the test to finish.</span></span>
<span class=giallo-l><span>            s</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>spawn</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>move |</span><span>_</span><span style=color:#81a1c1>|</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>                // This thread is just waiting for the test to finish, we'll handle the output in the main thread</span></span>
<span class=giallo-l><span style=color:#81a1c1>                let</span><span> _</span><span style=color:#81a1c1> =</span><span> wait_handle</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>wait</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#616e88>                // We don't care if the receiver got the message or not</span></span>
<span class=giallo-l><span style=color:#81a1c1>                let</span><span> _</span><span style=color:#81a1c1> =</span><span> sender</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>send</span><span style=color:#eceff4>(());</span></span>
<span class=giallo-l><span style=color:#eceff4>            });</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>            // Continue waiting for the test to finish with a timeout, logging at slow-timeout</span></span>
<span class=giallo-l><span style=color:#616e88>            // intervals</span></span>
<span class=giallo-l><span style=color:#81a1c1>            while let</span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span>error</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> receiver</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>recv_timeout</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span>slow_timeout</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                match</span><span> error</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                    RecvTimeoutError</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Timeout</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                        let</span><span> _</span><span style=color:#81a1c1> =</span><span> run_sender</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>send</span><span style=color:#eceff4>(</span><span>InternalTestEvent</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Slow</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                            test_instance</span><span style=color:#81a1c1>:</span><span> test</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>                            elapsed</span><span style=color:#81a1c1>:</span><span> stopwatch</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>elapsed</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>                        });</span></span>
<span class=giallo-l><span style=color:#eceff4>                    }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                    RecvTimeoutError</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Disconnected</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>                        unreachable!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Waiting thread should never drop the sender</span><span style=color:#eceff4>")</span></span>
<span class=giallo-l><span style=color:#eceff4>                    }</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        });</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> output</span><span style=color:#81a1c1> =</span><span> handle</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into_output</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> status</span><span style=color:#81a1c1> = if</span><span> output</span><span style=color:#81a1c1>.</span><span>status</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>success</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            ExecutionResult</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Pass</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            ExecutionResult</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Fail</span></span>
<span class=giallo-l><span style=color:#eceff4>        };</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Ok</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>InternalExecuteStatus</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            stdout</span><span style=color:#81a1c1>:</span><span> output</span><span style=color:#81a1c1>.</span><span>stdout</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            stderr</span><span style=color:#81a1c1>:</span><span> output</span><span style=color:#81a1c1>.</span><span>stderr</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            result</span><span style=color:#81a1c1>:</span><span> status</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            stopwatch_end</span><span style=color:#81a1c1>:</span><span> stopwatch</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>end</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>        })</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l></span></code></pre> <p><a href=https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/nextest-runner/src/runner.rs#L318 rel=external>https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/nextest-runner/src/runner.rs#L318</a></p> <p>ã“ã“ãŒå…ˆã»ã©ã®ç°¡æ˜“ç‰ˆã§èª¬æ˜ã—ãŸã€<code>wait_pool</code>ã‚’åˆ©ç”¨ã—ãŸtest case processã®å¾…æ©Ÿå‡¦ç†ã§ã™ã€‚<br> è¦ã¯runner_poolã®å„threadã¯test caseå®Ÿè¡ŒprocessãŒçµ‚äº†ã™ã‚‹ã¾ã§blockã—ã¾ã™ã€‚</p> <p>å…ˆã»ã©ã‹ã‚‰ã€test caseç”¨ã®processã¨è¨€ã£ã¦ã„ã‚‹ã®ã§ã™ãŒã€ãã®processç”Ÿæˆå‡¦ç†ã¯å‡ºã¦ãã¦ã„ã¾ã›ã‚“ã§ã—ãŸã€‚å„test caseã‚’ä¸€ã¤ã ã‘å®Ÿè¡Œã™ã‚‹processã®ç”Ÿæˆå‡¦ç†ã¯<code>TestInstance::make_expression()</code>ã§è¡Œã‚ã‚Œã¦ã„ã¾ã™ã€‚</p> <h4 id=testinstance-make-expression><a aria-label="Anchor link for: testinstance-make-expression" class=zola-anchor href=#testinstance-make-expression><code>TestInstance::make_expression()</code></a></h4> <pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#616e88>    /// Creates the command expression for this test instance.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>crate</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> fn</span><span style=color:#88c0d0> make_expression</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> target_runner</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>TargetRunner</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Expression</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> platform_runner</span><span style=color:#81a1c1> =</span><span> target_runner</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>for_build_platform</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span>bin_info</span><span style=color:#81a1c1>.</span><span>build_platform</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#616e88>        // TODO: non-rust tests</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> args</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Vec</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> program</span><span style=color:#81a1c1>:</span><span> std</span><span style=color:#81a1c1>::</span><span>ffi</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>OsString</span><span style=color:#81a1c1> = match</span><span> platform_runner</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Some</span><span style=color:#eceff4>(</span><span>runner</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                args</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>extend</span><span style=color:#eceff4>(</span><span>runner</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>args</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span>                args</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>push</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span>binary</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_str</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span>                runner</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>binary</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            None</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                use</span><span> duct</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>IntoExecutablePath</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span>binary</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_std_path</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_executable</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        };</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>        args</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>extend</span><span style=color:#eceff4>(["</span><span style=color:#a3be8c>--exact</span><span style=color:#eceff4>",</span><span style=color:#81a1c1> self.</span><span>name</span><span style=color:#eceff4>, "</span><span style=color:#a3be8c>--nocapture</span><span style=color:#eceff4>"]);</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if self.</span><span>test_info</span><span style=color:#81a1c1>.</span><span>ignored </span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span>            args</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>push</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>--ignored</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> package</span><span style=color:#81a1c1> = self.</span><span>bin_info</span><span style=color:#81a1c1>.</span><span>package</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> cmd</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> cmd</span><span style=color:#eceff4>(</span><span>program</span><span style=color:#eceff4>,</span><span> args</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>dir</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self.</span><span>bin_info</span><span style=color:#81a1c1>.</span><span>cwd</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#616e88>            // This environment variable is set to indicate that tests are being run under nextest.</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>env</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>NEXTEST</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>1</span><span style=color:#eceff4>")</span></span>
<span class=giallo-l><span style=color:#616e88>            // This environment variable is set to indicate that each test is being run in its own process.</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>env</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>NEXTEST_EXECUTION_MODE</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>process-per-test</span><span style=color:#eceff4>")</span></span>
<span class=giallo-l><span style=color:#616e88>            // These environment variables are set at runtime by cargo test:</span></span>
<span class=giallo-l><span style=color:#616e88>            // https://doc.rust-lang.org/cargo/reference/environment-variables.html#environment-variables-cargo-sets-for-crates</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>env</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>                "</span><span style=color:#a3be8c>CARGO_MANIFEST_DIR</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span>                package</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>manifest_path</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>parent</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>            )</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>env</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>CARGO_PKG_VERSION</span><span style=color:#eceff4>",</span><span style=color:#88c0d0;font-weight:700> format!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{}</span><span style=color:#eceff4>",</span><span> package</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>version</span><span style=color:#eceff4>()))</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>env</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>                "</span><span style=color:#a3be8c>CARGO_PKG_VERSION_MAJOR</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>                format!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{}</span><span style=color:#eceff4>",</span><span> package</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>version</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span>major</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>            )</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>env</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>                "</span><span style=color:#a3be8c>CARGO_PKG_VERSION_MINOR</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>                format!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{}</span><span style=color:#eceff4>",</span><span> package</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>version</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span>minor</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>            )</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>env</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>                "</span><span style=color:#a3be8c>CARGO_PKG_VERSION_PATCH</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>                format!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{}</span><span style=color:#eceff4>",</span><span> package</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>version</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span>patch</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>            )</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>env</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>                "</span><span style=color:#a3be8c>CARGO_PKG_VERSION_PRE</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>                format!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{}</span><span style=color:#eceff4>",</span><span> package</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>version</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span>pre</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>            )</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>env</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>CARGO_PKG_AUTHORS</span><span style=color:#eceff4>",</span><span> package</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>authors</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>join</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>:</span><span style=color:#eceff4>"))</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>env</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>CARGO_PKG_NAME</span><span style=color:#eceff4>",</span><span> package</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>name</span><span style=color:#eceff4>())</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>env</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>                "</span><span style=color:#a3be8c>CARGO_PKG_DESCRIPTION</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span>                package</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>description</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap_or_default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>            )</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>env</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>CARGO_PKG_HOMEPAGE</span><span style=color:#eceff4>",</span><span> package</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>homepage</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap_or_default</span><span style=color:#eceff4>())</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>env</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>CARGO_PKG_LICENSE</span><span style=color:#eceff4>",</span><span> package</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>license</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap_or_default</span><span style=color:#eceff4>())</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>env</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>                "</span><span style=color:#a3be8c>CARGO_PKG_LICENSE_FILE</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span>                package</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>license_file</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap_or_else</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>||</span><span style=color:#eceff4> ""</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_ref</span><span style=color:#eceff4>()),</span></span>
<span class=giallo-l><span style=color:#eceff4>            )</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>env</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>                "</span><span style=color:#a3be8c>CARGO_PKG_REPOSITORY</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span>                package</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>repository</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap_or_default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>            );</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>        cmd</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span></code></pre> <p><a href=https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/nextest-runner/src/test_list.rs#L764 rel=external>https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/nextest-runner/src/test_list.rs#L764</a></p> <p>ã¨ã„ã†ã“ã¨ã§ã€ã¤ã„ã«cargo nextestãŒtest caseå˜ä½ã§processã‚’ç”Ÿæˆã—ã¦ä¸¦åˆ—ã«å®Ÿè¡Œã—ã¦ã„ã‚‹ã¨ã„ã†å‡¦ç†ã«ãŸã©ã‚Šç€ãã¾ã—ãŸã€‚<br> <code>args.extend(["--exact", self.name, "--nocapture"]);</code>ã¨ã‚ã‚‹ã‚ˆã†ã«ã€test binaryã«<code>--exact &lt;test_case> --nocapture</code>ã‚’ä»˜ä¸ã—ã¦å®Ÿè¡Œã—ã¦ã„ãŸã‚“ã§ã™ã­ã€‚ æ‰‹å…ƒã§ã‚„ã£ã¦ã¿ã‚‹ã¨</p> <pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>â¯</span><span style=color:#a3be8c> ./target/debug/deps/nextest_handson-b56b908ea854a424 --exact aaa:a01::tests::aaa --nocapture</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>running</span><span style=color:#b48ead> 0</span><span style=color:#a3be8c> tests</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>test</span><span style=color:#a3be8c> result: ok.</span><span style=color:#b48ead> 0</span><span style=color:#a3be8c> passed</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 0</span><span style=color:#a3be8c> failed</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 0</span><span style=color:#a3be8c> ignored</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 0</span><span style=color:#a3be8c> measured</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 3</span><span style=color:#a3be8c> filtered out</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> finished</span><span style=color:#a3be8c> in 0.00s</span></span></code></pre> <p>ã®ã‚ˆã†ã«æŒ‡å®šã—ãŸcaseã ã‘ãŒå®Ÿè¡Œã§ãã¾ã—ãŸã€‚<br> ã¾ãŸã€<code>cargo test</code>ã§åŒã˜å®Ÿè¡Œç’°å¢ƒã«ãªã‚‹ã‚ˆã†ã«åœ°é“ã«ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¦ã„ã‚‹ã“ã¨ã‚‚ã‚ã‹ã‚Šã¾ã—ãŸã€‚</p> <h3 id=runchu-li-nomatome><a aria-label="Anchor link for: runchu-li-nomatome" class=zola-anchor href=#runchu-li-nomatome><code>run</code>å‡¦ç†ã®ã¾ã¨ã‚</a></h3> <p>ã–ã£ãã‚Šã§ã™ãŒã€cargo nextest runãŒã©ã†ã‚„ã£ã¦testå®Ÿè¡Œã‚’ä¸¦åˆ—åŒ–ã•ã›ã¦ã„ã‚‹ã‹å¤§æ ãŒç†è§£ã§ãã¾ã—ãŸã€‚ test caseå˜ä½ã§iterateã—ã¦ã€rayonã®ThreadPoolã‚’åˆ©ç”¨ã—ã€å¯¾è±¡ã®test caseã ã‘ã‚’å®Ÿè¡Œã™ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ã‚’ä¸¦åˆ—åŒ–ã•ã›ã¦ã„ãŸã‚“ã§ã™ã­ã€‚<br> ã¾ãŸã€å„ç¨®testå‡¦ç†ã¯<a href=https://github.com/nextest-rs/nextest/blob/b647d946d2c2dcb8b6515c6f9152c30d4370a3d5/nextest-runner/src/runner.rs#L763 rel=external><code>InternalTestEvent</code></a>ã¨ã—ã¦è¡¨ç¾ã•ã‚Œã€testã®å®Ÿè¡Œæ–¹æ³•ã¨testçµæœã®è¡¨ç¤ºæ–¹æ³•ãŒç¶ºéº—ã«åˆ†é›¢ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚</p> <h2 id=matome><a aria-label="Anchor link for: matome" class=zola-anchor href=#matome>ã¾ã¨ã‚</a></h2> <p>cargo nextestãŒtestã‚’å®Ÿè¡Œã•ã‚Œã‚‹å‡¦ç†ã®æµã‚Œã‚’è¦‹ã¦ã„ãã¾ã—ãŸã€‚<br> åŸºæœ¬çš„ã«cargoã‚³ãƒãƒ³ãƒ‰ã‚’wrapã™ã‚‹ã‚ˆã†ã«ãªã£ã¦ãŠã‚Šã€testè‡ªä½“ã¯cargo testã‚’ä½¿ã£ãŸæ™‚ã¨åŒã˜ã§ã€test binaryã®å®Ÿè¡Œåˆ¶å¾¡æ–¹æ³•ã‚’å·¥å¤«ã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚<br> è¦ã¯test binaryã«<code>--exact</code> optionã‚’ä»˜ä¸ã—ã¦æœ€å¤§åŒæ™‚å®Ÿè¡Œæ•°ã‚’åˆ¶å¾¡ã—ãªãŒã‚‰processã‚’ä¸¦åˆ—å®Ÿè¡Œã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã€nextestã®ãƒ–ãƒ©ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹åº¦ãŒå°‘ã—æ¸›ã£ã¦å¬‰ã—ã„ã§ã™ã€‚</p> <h2 id=jin-hui-hurerarenakatutatokoro><a aria-label="Anchor link for: jin-hui-hurerarenakatutatokoro" class=zola-anchor href=#jin-hui-hurerarenakatutatokoro>ä»Šå›ãµã‚Œã‚‰ã‚Œãªã‹ã£ãŸã¨ã“ã‚</a></h2> <p>æœ¬è¨˜äº‹ã§ã¯ã€<code>list</code>ã¨<code>run</code>ã®ãƒ¡ã‚¤ãƒ³ã®å®Ÿè¡Œã®æµã‚Œã‚’è¿½ã£ã¦ã¿ã¾ã—ãŸã€‚ä»–ã«ã‚‚è‰²ã€…ãªæ©Ÿèƒ½ãŒã‚ã‚Šã¾ã™ã€‚</p> <ul><li>buildçµæœã®å†åˆ©ç”¨å‡¦ç†<li><code>--target</code>ã«å¿œã˜ãŸtest runnerã®åˆ‡ã‚Šæ›¿ãˆå‡¦ç†<li>terminalã®colorå‡¦ç†</ul> <footer class=blog-footer><p>Â© 2026 <a href=https://blog.ymgyt.io> ymgyt </a> | Made with <a href=https://www.getzola.org rel=noopener target=_blank>Zola</a> | <a href=https://github.com/ymgyt/blog>Repository</a> | <a href=https://blog.ymgyt.io/atom.xml target=_blank title=rss> <svg viewbox="0 0 24 24" class=icon fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx=5 cy=19 r=1></circle></svg> </a></footer> 