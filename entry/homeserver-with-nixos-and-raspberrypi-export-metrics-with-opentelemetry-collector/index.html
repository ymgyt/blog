<!doctype html><html lang=ja><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1" name=viewport><link href=https://blog.ymgyt.io/favicon.ico rel=icon sizes=any><link href=https://blog.ymgyt.io/icon.svg rel=icon type=image/svg+xml><link href=https://blog.ymgyt.io/apple-touch-icon.png rel=apple-touch-icon><link href=https://blog.ymgyt.io/manifest.webmanifest rel=manifest><link href=https://blog.ymgyt.io/style.css rel=stylesheet><link href=https://blog.ymgyt.io/atom.xml rel=alternate title=Atom type=application/atom+xml><script src="https://www.googletagmanager.com/gtag/js?id=G-GTB0KMLN90" async></script><script>window.dataLayer = window.dataLayer || [];
	function gtag() {dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-GTB0KMLN90');</script><title>â„ï¸ NixOSã¨Raspberry Piã§è‡ªå®…server | Part 4 opentelemetry-collectorã§metricsã‚’å–å¾— | Happy developing</title><meta content=opentelemetry-collectorã¨openobserveã«ã‚ˆã‚‹metricsç®¡ç† name=description><meta content=summary name=twitter:card><meta content="@YAmaguchixt " name=twitter:site><meta content="â„ï¸ NixOSã¨Raspberry Piã§è‡ªå®…server | Part 4 opentelemetry-collectorã§metricsã‚’å–å¾—" name=twitter:title><meta content=opentelemetry-collectorã¨openobserveã«ã‚ˆã‚‹metricsç®¡ç† name=twitter:description><meta content=https://blog.ymgyt.io/images/emoji/snowflake.png name=twitter:image><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><body><div class=world><div class=content-container><header class=blog-header-container><div class=blog-logo><a href=https://blog.ymgyt.io>Happy developing</a></div><div class=blog-nav><nav><ul><li><a href=https://blog.ymgyt.io/entry/>Entries</a><li><a href=https://blog.ymgyt.io/tags/>Tags</a><li><a href=https://blog.ymgyt.io/about/>About</a><li><a href=https://github.com/ymgyt> <img alt=Github class=icon src=https://blog.ymgyt.io/images/icon/github.svg> </a><li><a href="https://twitter.com/YAmaguchixt "> <img alt=Twitter class=icon src=https://blog.ymgyt.io/images/icon/twitter.svg> </a></ul></nav></div></header><main class=blog-main><article><header class=entry-header><h1 class=entry-title>â„ï¸ NixOSã¨Raspberry Piã§è‡ªå®…server | Part 4 opentelemetry-collectorã§metricsã‚’å–å¾—</h1><div class=entry-meta><p class=entry-meta-item>ğŸ—“ 2023-10-09<p class=entry-meta-item>ğŸ· <span class=tag><a href=https://blog.ymgyt.io/tags/nix/>nix</a></span> <span class=tag><a href=https://blog.ymgyt.io/tags/opentelemetry/>opentelemetry</a></span></div></header><aside class=entry-toc><nav><ul class=entry-toc-toplevel-list><li><a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-export-metrics-with-opentelemetry-collector/#systemddeopentelemetry-collectorwodong-kasu>systemdã§opentelemetry-collectorã‚’å‹•ã‹ã™</a><li><a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-export-metrics-with-opentelemetry-collector/#opentelemetry-collector-config-yaml>opentelemetry-collector config.yaml</a><li><a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-export-metrics-with-opentelemetry-collector/#matome>ã¾ã¨ã‚</a></ul></nav></aside><div class=entry-content><p><a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-install-nixos/ rel=external>Part 1 NixOSã‚’install</a><br> <a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-deploy-with-deploy-rs/ rel=external>Part 2 deply-rsã§NixOS Configurationã‚’é©ç”¨</a><br> <a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-secret-management-with-ragenix/ rel=external>Part 3 ragenixã§secretç®¡ç†</a><br> Part 4 opentelemetry-collectorã¨openobserveã§metricsã‚’å–å¾—(ğŸ‘ˆ ã“ã®è¨˜äº‹)<br> <a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-get-cpu-temperature/ rel=external>Part 5 CPUã®æ¸©åº¦ã‚’metricsã¨ã—ã¦å–å¾—</a><p>Part 4ã§ã¯raspiä¸Šã§opentelemetry-collector(contrib destribution)ã‚’å‹•ã‹ã—ã¦metricsã‚’ã¨ã‚Œã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚ metricsã®exportå…ˆã¯<a href=https://openobserve.ai/ rel=external>openobserve</a>ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚ä»Šå›ã¯cloudç‰ˆã‚’åˆ©ç”¨ã—ã¾ã™ã€‚<br> ç¾åœ¨ã®ã¨ã“ã‚ã€openobserveã®cloudç‰ˆã¯æœˆ200GB ingestion, 15æ—¥é–“ä¿æŒã¾ã§ãªã‚‰free planã§åˆ©ç”¨ã§ãã¾ã™ã€‚<br> ã¾ãŸclusteræ§‹æˆã§ãªã‘ã‚Œã°è‡ªå‰ã§hostã™ã‚‹ã®ã‚‚ã‚„ã‚Šã‚„ã™ã„ã®ã§ã„ãšã‚Œã¯raspiä¸Šã§å‹•ã‹ã›ã‚Œã°ã¨è€ƒãˆã¦ã„ã¾ã™ãŒã€CHANGELOGã‚’ã¿ã¦ã„ã‚‹ã¨ã¾ã ã¾ã é–‹ç™ºä¸­ã¨ã„ã£ãŸæ„Ÿã˜ãªã®ã§ã‚‚ã†ã™ã“ã—å®‰å®šã—ã¦ã‹ã‚‰ã«ã—ã‚ˆã†ã‹ã¨æ€ã£ã¦ã„ã¾ã™ã€‚<p>openobserveã¸ã®metricsã®exportã«ã¯çµ„ç¹”æƒ…å ±ã‚„credentialãŒå¿…è¦ã§ã™ã€‚ã“ã‚Œã¯<a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-secret-management-with-ragenix/ rel=external>Part 3</a>ã§æº–å‚™ã—ã¦ã‚ã‚Šã€æ—¢ã«deployæ¸ˆã§ã‚ã‚‹å‰æã§ã™ã€‚<p>åˆ©ç”¨ã™ã‚‹opentelemetry-collectorã®versionã¯contribç‰ˆã®<code>v0.78.0</code>ã§ã™ã€‚<h2 id=systemddeopentelemetry-collectorwodong-kasu><a aria-label="Anchor link for: systemddeopentelemetry-collectorwodong-kasu" class=zola-anchor href=#systemddeopentelemetry-collectorwodong-kasu>systemdã§opentelemetry-collectorã‚’å‹•ã‹ã™</a></h2><p>åŸºæœ¬çš„ã«ã‚„ã‚‹ã“ã¨ã¯ç°¡å˜ã§ã€systemdã‹ã‚‰opentelemetry-collectorã‚’èµ·å‹•ã™ã‚‹è¨­å®šã‚’è¡Œã†ã ã‘ã§ã™ã€‚<br> è‡ªåˆ†ã¯systemdãŒã‚ˆãã‚ã‹ã£ã¦ã„ãªã‹ã£ãŸã®ã§ã€<a href=https://learning.oreilly.com/library/view/linux-service-management/9781801811644/ rel=external>Linux Service Management Made Easy with systemd</a>ã‚’èª­ã‚“ã§ã¿ã¾ã—ãŸã€‚<br> ã“ã¡ã‚‰ã®æœ¬ã¯éå¸¸ã«å‚è€ƒã«ãªã‚Šåˆ¥ã§æ„Ÿæƒ³ã‚’æ›¸ã“ã†ã¨æ€ã£ã¦ã„ã¾ã™ã€‚ã€€<p>opentelemetryã‚„collectorã¨ã¯ãã‚‚ãã‚‚ãªã«ã‹ã«ã¤ã„ã¦ã¯ä»¥å‰ã€<a href=https://blog.ymgyt.io/entry/starting_opentelemetry_with_rust/ rel=external>è¨˜äº‹</a>ã‚’æ›¸ã„ãŸã®ã§ã‚ˆã‘ã‚Œã°èª­ã‚“ã§ã¿ã¦ãã ã•ã„ã€‚<p>ã¨ã„ã†ã“ã¨ã§nixã®è¨­å®šã«æˆ»ã‚Šã¾ã™ã€‚<br> ã¾ãšã€opentelemetry-collecotrç”¨ã«<code>modules/opentelemetry-collector/</code> directoryã‚’ä½œæˆã—ã¦ã€ãã“ã«<code>default.nix</code>ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=nix><span class=giallo-l><span style=color:#eceff4>{</span><span> pkgs</span><span style=color:#81a1c1>,</span><span> config</span><span style=color:#81a1c1>,</span><span> mysecrets</span><span style=color:#81a1c1>, ...</span><span style=color:#eceff4> }:</span><span> </span></span>
<span class=giallo-l><span style=color:#81a1c1>  let</span><span> </span></span>
<span class=giallo-l><span style=color:#8fbcbb>    otelColUser</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>opentelemetry-collector</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    otelColGroup</span><span style=color:#81a1c1> =</span><span> otelColUser</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>  in</span></span>
<span class=giallo-l><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>  # Create user statically for age to execute chown</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  users</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span><span> </span></span>
<span class=giallo-l><span style=color:#8fbcbb>    groups</span><span>.</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>opentelemetry-collector</span><span style=color:#eceff4>"</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      name</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#81a1c1>${</span><span>otelColGroup</span><span style=color:#81a1c1>}</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    users</span><span>.</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>opentelemetry-collector</span><span style=color:#eceff4>"</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      name</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#81a1c1>${</span><span>otelColUser</span><span style=color:#81a1c1>}</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      isSystemUser</span><span style=color:#81a1c1> = true;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      group</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#81a1c1>${</span><span>otelColGroup</span><span style=color:#81a1c1>}</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>  }</span><span style=color:#81a1c1>;</span><span>  </span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>  # Credential for opentelemetry-collector to export telemetry to openobserve cloud</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  age</span><span>.</span><span style=color:#8fbcbb>secrets</span><span>.</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>openobserve</span><span style=color:#eceff4>"</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    file</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#81a1c1>${</span><span>mysecrets</span><span style=color:#81a1c1>}</span><span style=color:#a3be8c>/openobserve.age</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    mode</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>0440</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    owner</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#81a1c1>${</span><span>otelColUser</span><span style=color:#81a1c1>}</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    group</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#81a1c1>${</span><span>otelColGroup</span><span style=color:#81a1c1>}</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>  }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>  # Put opentelemetry-collector config file</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  environment</span><span>.</span><span style=color:#8fbcbb>etc</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#eceff4>    "</span><span style=color:#a3be8c>opentelemetry-collector/config.yaml</span><span style=color:#eceff4>"</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      mode</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>0440</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      user</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#81a1c1>${</span><span>otelColUser</span><span style=color:#81a1c1>}</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      group</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#81a1c1>${</span><span>otelColGroup</span><span style=color:#81a1c1>}</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      text</span><span style=color:#81a1c1> = builtins.</span><span>readFile</span><span style=color:#a3be8c> ./config.yaml</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>  }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>  # Enable opentelemetry-collecotr service</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  systemd</span><span>.</span><span style=color:#8fbcbb>services</span><span>.</span><span style=color:#8fbcbb>opentelemetry-collector</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    description</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>Opentelemetry Collector Serivice</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    wantedBy</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> [ "</span><span style=color:#a3be8c>multi-user.target</span><span style=color:#eceff4>" ]</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    serviceConfig</span><span style=color:#81a1c1> = let</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      conf</span><span style=color:#81a1c1> =</span></span>
<span class=giallo-l><span style=color:#eceff4>        "</span><span style=color:#81a1c1>${</span><span>config</span><span style=color:#81a1c1>.</span><span>environment</span><span style=color:#81a1c1>.</span><span>etc</span><span style=color:#81a1c1>.</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>opentelemetry-collector/config.yaml</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span>source</span><span style=color:#81a1c1>.</span><span>outPath</span><span style=color:#81a1c1>}</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      ExecStart</span><span style=color:#81a1c1> =</span></span>
<span class=giallo-l><span style=color:#eceff4>        "</span><span style=color:#81a1c1>${</span><span>pkgs</span><span style=color:#81a1c1>.</span><span>opentelemetry-collector-contrib</span><span style=color:#81a1c1>}</span><span style=color:#a3be8c>/bin/otelcontribcol --config=file:</span><span style=color:#81a1c1>${</span><span>conf</span><span style=color:#81a1c1>}</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    in</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>      inherit</span><span style=color:#8fbcbb> ExecStart</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      EnvironmentFile</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> [</span><span> </span></span>
<span class=giallo-l><span style=color:#616e88>        # referenced by environment variable substitution in config file like '${env:FOO}'</span></span>
<span class=giallo-l><span>        config</span><span style=color:#81a1c1>.</span><span>age</span><span style=color:#81a1c1>.</span><span>secrets</span><span style=color:#81a1c1>.</span><span>openobserve</span><span style=color:#81a1c1>.</span><span>path</span></span>
<span class=giallo-l><span style=color:#eceff4>       ]</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#616e88>      # age executes chown on secret files, so user and group should exists in advance</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      DynamicUser</span><span style=color:#81a1c1> = false;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      User</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#81a1c1>${</span><span>otelColUser</span><span style=color:#81a1c1>}</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      Group</span><span style=color:#81a1c1>  =</span><span style=color:#eceff4> "</span><span style=color:#81a1c1>${</span><span>otelColGroup</span><span style=color:#81a1c1>}</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      Restart</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>always</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      ProtectSystem</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>full</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      DevicePolicy</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>closed</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      NoNewPrivileges</span><span style=color:#81a1c1> = true;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      WorkingDirectory</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>/var/lib/opentelemetry-collector</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      StateDirectory</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>opentelemetry-collector</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>  }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã“ã®moduleã‚’importã—ã¦deployã™ã‚Œã°opentelemetry-collectorãŒèµ·å‹•ã—ã¦ã€openobserveã«metricsã‚’exportã—ã¦ãã‚Œã¾ã™ã€‚<br> å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰ã¯contribç‰ˆãªã®ã§<code>otelcontribcol</code>ã§ã™ã€‚<br> opentelemetry-collectorã®è¨­å®šfileã¯<code>modules/opentelemetry-collector/config.yaml</code>ã«å®šç¾©ã—ã¦ãŠã‚Šã€<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>environment.etc = {</span></span>
<span class=giallo-l><span>  "opentelemetry-collector/config.yaml" = {</span></span>
<span class=giallo-l><span>    mode = "0440";</span></span>
<span class=giallo-l><span>    user = "${otelColUser}";</span></span>
<span class=giallo-l><span>    group = "${otelColGroup}";</span></span>
<span class=giallo-l><span>    text = builtins.readFile ./config.yaml;</span></span>
<span class=giallo-l><span>  };</span></span>
<span class=giallo-l><span>};</span></span></code></pre><p>ã¨ã™ã‚‹ã“ã¨ã§ã€raspiä¸Šã«<code>/etc/opentelemetry-collector/config.yaml</code>ãŒä½œæˆã•ã‚Œã¾ã™ã€‚<p>å‚ç…§ã™ã‚‹éš›ã¯<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>systemd.services.opentelemetry-collector = {</span></span>
<span class=giallo-l><span>  # ...</span></span>
<span class=giallo-l><span>  serviceConfig = let</span></span>
<span class=giallo-l><span>    conf =</span></span>
<span class=giallo-l><span>      "${config.environment.etc."opentelemetry-collector/config.yaml".source.outPath}";</span></span>
<span class=giallo-l><span>    ExecStart =</span></span>
<span class=giallo-l><span>      "${pkgs.opentelemetry-collector-contrib}/bin/otelcontribcol --config=file:${conf}";</span></span>
<span class=giallo-l><span>  in {</span></span>
<span class=giallo-l><span>    inherit ExecStart;</span></span>
<span class=giallo-l><span>    # ...</span></span>
<span class=giallo-l><span>  };</span></span>
<span class=giallo-l><span>};</span></span></code></pre><p>ã®ã‚ˆã†ã«<code>config.environment.etc."opentelemetry-collector".config.yaml.source.outPath</code>ã‚’å‚ç…§ã§ãã¾ã™ã€‚<h2 id=opentelemetry-collector-config-yaml><a aria-label="Anchor link for: opentelemetry-collector-config-yaml" class=zola-anchor href=#opentelemetry-collector-config-yaml>opentelemetry-collector config.yaml</a></h2><p>ç¶šã„ã¦opentelemetry-collectorã®è¨­å®šfileã§ã™ãŒã€ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã—ã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=yaml><span class=giallo-l><span style=color:#8fbcbb>receivers</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  hostmetrics</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    collection_interval</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> 1m</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    scrapers</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      cpu</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        metrics</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>          system.cpu.time</span><span style=color:#eceff4>: {</span><span style=color:#8fbcbb> enabled</span><span style=color:#eceff4>:</span><span style=color:#81a1c1> false</span><span style=color:#eceff4> }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>          system.cpu.utilization</span><span style=color:#eceff4>: {</span><span style=color:#8fbcbb> enabled</span><span style=color:#eceff4>:</span><span style=color:#81a1c1> true</span><span style=color:#eceff4> }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      memory</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        metrics</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>          system.memory.usage</span><span style=color:#eceff4>: {</span><span style=color:#8fbcbb> enabled</span><span style=color:#eceff4>:</span><span style=color:#81a1c1> false</span><span style=color:#eceff4> }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>          system.memory.utilization</span><span style=color:#eceff4>: {</span><span style=color:#8fbcbb> enabled</span><span style=color:#eceff4>:</span><span style=color:#81a1c1> true</span><span style=color:#eceff4> }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      network</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        include</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>          interfaces</span><span style=color:#eceff4>: ["</span><span style=color:#a3be8c>end0</span><span style=color:#eceff4>"]</span></span>
<span class=giallo-l><span style=color:#8fbcbb>          match_type</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> strict</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        metrics</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>          system.network.connections</span><span style=color:#eceff4>: {</span><span style=color:#8fbcbb> enabled</span><span style=color:#eceff4>:</span><span style=color:#81a1c1> true</span><span style=color:#eceff4> }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>          system.network.dropped</span><span style=color:#eceff4>: {</span><span style=color:#8fbcbb> enabled</span><span style=color:#eceff4>:</span><span style=color:#81a1c1> false</span><span style=color:#eceff4> }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>          system.network.errors</span><span style=color:#eceff4>: {</span><span style=color:#8fbcbb> enabled</span><span style=color:#eceff4>:</span><span style=color:#81a1c1> false</span><span style=color:#eceff4> }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>          system.network.io</span><span style=color:#eceff4>: {</span><span style=color:#8fbcbb> enabled</span><span style=color:#eceff4>:</span><span style=color:#81a1c1> true</span><span style=color:#eceff4> }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>          system.network.packets</span><span style=color:#eceff4>: {</span><span style=color:#8fbcbb> enabled</span><span style=color:#eceff4>:</span><span style=color:#81a1c1> false</span><span style=color:#eceff4> }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  hostmetrics/fs</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    collection_interval</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> 60m</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    scrapers</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      filesystem</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        exclude_mount_points</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>          mount_points</span><span style=color:#eceff4>: ["</span><span style=color:#a3be8c>/nix/store</span><span style=color:#eceff4>"]</span></span>
<span class=giallo-l><span style=color:#8fbcbb>          match_type</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> strict</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        metrics</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>          system.filesystem.inodes.usage</span><span style=color:#eceff4>: {</span><span style=color:#8fbcbb> enabled</span><span style=color:#eceff4>:</span><span style=color:#81a1c1> false</span><span style=color:#eceff4> }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>          system.filesystem.usage</span><span style=color:#eceff4>: {</span><span style=color:#8fbcbb> enabled</span><span style=color:#eceff4>:</span><span style=color:#81a1c1> false</span><span style=color:#eceff4> }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>          system.filesystem.utilization</span><span style=color:#eceff4>: {</span><span style=color:#8fbcbb> enabled</span><span style=color:#eceff4>:</span><span style=color:#81a1c1> true</span><span style=color:#eceff4> }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>processors</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  memory_limiter</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    check_interval</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> 10s</span></span>
<span class=giallo-l><span style=color:#616e88>    # hard limit</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    limit_mib</span><span style=color:#eceff4>:</span><span style=color:#b48ead> 500</span></span>
<span class=giallo-l><span style=color:#616e88>    # sort limit 400</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    spike_limit_mib</span><span style=color:#eceff4>:</span><span style=color:#b48ead> 100</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  resourcedetection/system</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    detectors</span><span style=color:#eceff4>: ["</span><span style=color:#a3be8c>system</span><span style=color:#eceff4>"]</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    override</span><span style=color:#eceff4>:</span><span style=color:#81a1c1> false</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    attributes</span><span style=color:#eceff4>: ["</span><span style=color:#a3be8c>host.name</span><span style=color:#eceff4>"]</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    system</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      hostname_sources</span><span style=color:#eceff4>: ["</span><span style=color:#a3be8c>os</span><span style=color:#eceff4>"]</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  filter/metrics</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    error_mode</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> propagate</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    metrics</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      datapoint</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#eceff4>        -</span><span style=color:#81a1c1> >-</span></span>
<span class=giallo-l><span style=color:#a3be8c>          metric.name == "system.cpu.utilization" </span></span>
<span class=giallo-l><span style=color:#a3be8c>          and </span></span>
<span class=giallo-l><span style=color:#a3be8c>          ( </span></span>
<span class=giallo-l><span style=color:#a3be8c>            attributes["state"] == "nice" </span></span>
<span class=giallo-l><span style=color:#a3be8c>            or </span></span>
<span class=giallo-l><span style=color:#a3be8c>            attributes["state"] == "softirq" </span></span>
<span class=giallo-l><span style=color:#a3be8c>            or </span></span>
<span class=giallo-l><span style=color:#a3be8c>            attributes["state"] == "steal" </span></span>
<span class=giallo-l><span style=color:#a3be8c>            or </span></span>
<span class=giallo-l><span style=color:#a3be8c>            attributes["state"] == "interrupt" </span></span>
<span class=giallo-l><span style=color:#a3be8c>          ) </span></span>
<span class=giallo-l><span style=color:#eceff4>        -</span><span style=color:#81a1c1> >-</span></span>
<span class=giallo-l><span style=color:#a3be8c>          metric.name == "system.network.connections"</span></span>
<span class=giallo-l><span style=color:#a3be8c>          and</span></span>
<span class=giallo-l><span style=color:#a3be8c>          attributes["state"] != "ESTABLISHED"</span></span>
<span class=giallo-l><span style=color:#a3be8c>          and</span></span>
<span class=giallo-l><span style=color:#a3be8c>          attributes["state"] != "LISTEN"</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  batch/metrics</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    send_batch_size</span><span style=color:#eceff4>:</span><span style=color:#b48ead> 8192</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    timeout</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> 3s</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    send_batch_max_size</span><span style=color:#eceff4>:</span><span style=color:#b48ead> 16384</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>exporters</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  logging</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    verbosity</span><span style=color:#eceff4>: "</span><span style=color:#a3be8c>normal</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  prometheusremotewrite/openobserve</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    endpoint</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> https://api.openobserve.ai/api/${env:OPEN_OBSERVE_ORG}/prometheus/api/v1/write</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    headers</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      Authorization</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> Basic ${env:OPEN_OBSERVE_TOKEN}</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    resource_to_telemetry_conversion</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      enabled</span><span style=color:#eceff4>:</span><span style=color:#81a1c1> true</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>extensions</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  memory_ballast</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    size_mib</span><span style=color:#eceff4>:</span><span style=color:#b48ead> 64</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>service</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  extensions</span><span style=color:#eceff4>: [</span><span style=color:#a3be8c>memory_ballast</span><span style=color:#eceff4>]</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  pipelines</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    metrics</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      receivers</span><span style=color:#eceff4>:</span><span> </span></span>
<span class=giallo-l><span style=color:#eceff4>        -</span><span style=color:#a3be8c> hostmetrics</span></span>
<span class=giallo-l><span style=color:#eceff4>        -</span><span style=color:#a3be8c> hostmetrics/fs</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      processors</span><span style=color:#eceff4>:</span><span> </span></span>
<span class=giallo-l><span style=color:#eceff4>        -</span><span style=color:#a3be8c> memory_limiter</span></span>
<span class=giallo-l><span style=color:#eceff4>        -</span><span style=color:#a3be8c> resourcedetection/system</span></span>
<span class=giallo-l><span style=color:#eceff4>        -</span><span style=color:#a3be8c> filter/metrics</span></span>
<span class=giallo-l><span style=color:#eceff4>        -</span><span style=color:#a3be8c> batch/metrics</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      exporters</span><span style=color:#eceff4>:</span><span> </span></span>
<span class=giallo-l><span style=color:#eceff4>        -</span><span style=color:#a3be8c> logging</span></span>
<span class=giallo-l><span style=color:#eceff4>        -</span><span style=color:#a3be8c> prometheusremotewrite/openobserve</span></span>
<span class=giallo-l></span></code></pre><p>ã¾ãšmetricsã¯hostmetricsã‚’åˆ©ç”¨ã—ã¾ã—ãŸã€‚<p>processorsã«é–¢ã—ã¦ã¯<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=yaml><span class=giallo-l><span style=color:#8fbcbb>processors</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  memory_limiter</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    check_interval</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> 10s</span></span>
<span class=giallo-l><span style=color:#616e88>    # hard limit</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    limit_mib</span><span style=color:#eceff4>:</span><span style=color:#b48ead> 500</span></span>
<span class=giallo-l><span style=color:#616e88>    # sort limit 400</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    spike_limit_mib</span><span style=color:#eceff4>:</span><span style=color:#b48ead> 100</span></span></code></pre><p>ã¾ãšmemory_limiterã‚’è¨­å®šã—<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=yaml><span class=giallo-l><span style=color:#8fbcbb>  resourcedetection/system</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    detectors</span><span style=color:#eceff4>: ["</span><span style=color:#a3be8c>system</span><span style=color:#eceff4>"]</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    override</span><span style=color:#eceff4>:</span><span style=color:#81a1c1> false</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    attributes</span><span style=color:#eceff4>: ["</span><span style=color:#a3be8c>host.name</span><span style=color:#eceff4>"]</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    system</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      hostname_sources</span><span style=color:#eceff4>: ["</span><span style=color:#a3be8c>os</span><span style=color:#eceff4>"]</span></span></code></pre><p>æ¬¡ã«resourcedetectionã§ã€metricsã«hostæƒ…å ±ã‚’ä»˜ä¸ã—ã¾ã—ãŸã€‚<br> hoståã¯ã€nixosã®è¨­å®šã§å®šç¾©ã—ã¦ã„ã¾ã™ã€‚<br> ç¶šã„ã¦<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=yaml><span class=giallo-l><span style=color:#8fbcbb>  filter/metrics</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    error_mode</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> propagate</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    metrics</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      datapoint</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#eceff4>        -</span><span style=color:#81a1c1> >-</span></span>
<span class=giallo-l><span style=color:#a3be8c>          metric.name == "system.cpu.utilization" </span></span>
<span class=giallo-l><span style=color:#a3be8c>          and </span></span>
<span class=giallo-l><span style=color:#a3be8c>          ( </span></span>
<span class=giallo-l><span style=color:#a3be8c>            attributes["state"] == "nice" </span></span>
<span class=giallo-l><span style=color:#a3be8c>            or </span></span>
<span class=giallo-l><span style=color:#a3be8c>            attributes["state"] == "softirq" </span></span>
<span class=giallo-l><span style=color:#a3be8c>            or </span></span>
<span class=giallo-l><span style=color:#a3be8c>            attributes["state"] == "steal" </span></span>
<span class=giallo-l><span style=color:#a3be8c>            or </span></span>
<span class=giallo-l><span style=color:#a3be8c>            attributes["state"] == "interrupt" </span></span>
<span class=giallo-l><span style=color:#a3be8c>          ) </span></span>
<span class=giallo-l><span style=color:#eceff4>        -</span><span style=color:#81a1c1> >-</span></span>
<span class=giallo-l><span style=color:#a3be8c>          metric.name == "system.network.connections"</span></span>
<span class=giallo-l><span style=color:#a3be8c>          and</span></span>
<span class=giallo-l><span style=color:#a3be8c>          attributes["state"] != "ESTABLISHED"</span></span>
<span class=giallo-l><span style=color:#a3be8c>          and</span></span>
<span class=giallo-l><span style=color:#a3be8c>          attributes["state"] != "LISTEN"</span></span></code></pre><p>filterã§cpuã®ã„ãã¤ã‹ã®çŠ¶æ…‹ã¨connectionã§çŸ¥ã‚ŠãŸã„ã‚‚ã®ã‚’å–å¾—ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚<br> æœ€å¾Œã«batchã‚’è¨­å®šã—ã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=yaml><span class=giallo-l><span style=color:#8fbcbb>  batch/metrics</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    send_batch_size</span><span style=color:#eceff4>:</span><span style=color:#b48ead> 8192</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    timeout</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> 3s</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    send_batch_max_size</span><span style=color:#eceff4>:</span><span style=color:#b48ead> 16384</span></span></code></pre><p>exporterã«é–¢ã—ã¦ã¯openobserveã¯metricsã®æ›¸ãè¾¼ã¿ã«promethesremotewriteã‚’è¦æ±‚ã™ã‚‹ã®ã§ã€æŒ‡å®šã•ã‚ŒãŸé€šã‚Šã«è¡Œã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=yaml><span class=giallo-l><span style=color:#8fbcbb>exporters</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  logging</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    verbosity</span><span style=color:#eceff4>: "</span><span style=color:#a3be8c>normal</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  prometheusremotewrite/openobserve</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    endpoint</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> https://api.openobserve.ai/api/${env:OPEN_OBSERVE_ORG}/prometheus/api/v1/write</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    headers</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      Authorization</span><span style=color:#eceff4>:</span><span style=color:#a3be8c> Basic ${env:OPEN_OBSERVE_TOKEN}</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    resource_to_telemetry_conversion</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      enabled</span><span style=color:#eceff4>:</span><span style=color:#81a1c1> true</span></span></code></pre><p><code>${env:OPEN_OBSERVE_ORG}</code>ã®ã‚ˆã†ã«æ›¸ãã¨ç’°å¢ƒå¤‰æ•°ã§ç½®æ›ã—ã¦ãã‚Œã¾ã™ã€‚<br> ç’°å¢ƒå¤‰æ•°ã¯ã€systemdã®<code>EnvironmentFile</code>çµŒç”±ã§ã€å¾©å·ã—ãŸage fileã‚’æ¸¡ã—ã¦ã„ã¾ã™ã€‚<h2 id=matome><a aria-label="Anchor link for: matome" class=zola-anchor href=#matome>ã¾ã¨ã‚</a></h2><p>ã“ã®è¨­å®šã‚’deployã—ã€openobserveã§dashboardã‚’è¨­å®šã™ã‚‹ã“ã¨ã§ä»¥ä¸‹ã®ã‚ˆã†ãªmetricsã‚’ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚<p>openobserveã§ã¯metricsã«PromQLãŒåˆ©ç”¨ã§ãã‚‹ã®ã§ã€<code>sum without(cpu,state) (system_cpu_utilization_ratio{host_name=~"rpi4",state!="idle"}) * 100</code>ã®ã‚ˆã†ã«ã—ã¦ç°¡å˜ã«dashboardãŒä½œã‚Œã¾ã™ã€‚<figure><div class=fig-images-row><img , alt src=images/ss-openobserve-dashboard.png></div><figcaption>openobserveã®dashboardã®æ§˜å­</figcaption></figure><p>ã“ã“ã¾ã§ã§ã€NixOSã®è¨­å®šã‚’raspiä¸Šã«åæ˜ ã—ã€metricsã‚’å–å¾—ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚<br> æ¬¡ã¯Rustã§raspiã®cpuæ¸©åº¦ã‚’å–å¾—ã—ã€opentelemetryã®metricsã¨ã—ã¦exportã™ã‚‹ã‚ˆã†ãªapplicationã‚’ä½œã£ã¦ã¿ã‚ˆã†ã¨æ€ã£ã¦ã„ã¾ã™ã€‚<p>ã“ã“ã¾ã§ãŠèª­ã¿ã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚</div></article></main><footer class=blog-footer><p>Â© 2026 <a href=https://blog.ymgyt.io> ymgyt </a> | Made with <a href=https://www.getzola.org rel=noopener target=_blank>Zola</a> | <a href=https://github.com/ymgyt/blog>Repository</a> | <a href=https://blog.ymgyt.io/atom.xml target=_blank title=rss> <svg viewbox="0 0 24 24" class=icon fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx=5 cy=19 r=1></circle></svg> </a></footer></div></div>