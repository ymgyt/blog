<!doctype html><html lang=ja><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1" name=viewport><link href=https://blog.ymgyt.io/favicon.ico rel=icon sizes=any><link href=https://blog.ymgyt.io/icon.svg rel=icon type=image/svg+xml><link href=https://blog.ymgyt.io/apple-touch-icon.png rel=apple-touch-icon><link href=https://blog.ymgyt.io/manifest.webmanifest rel=manifest><link href=https://blog.ymgyt.io/style.css rel=stylesheet><link href=https://blog.ymgyt.io/atom.xml rel=alternate title=Atom type=application/atom+xml><script src="https://www.googletagmanager.com/gtag/js?id=G-GTB0KMLN90" async></script><script>window.dataLayer = window.dataLayer || [];
	function gtag() {dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-GTB0KMLN90');</script><title>â™»ï¸  Rustã®exponential retryå®Ÿè£… againã®ã‚½ãƒ¼ã‚¹ã‚’èª­ã‚“ã§ã¿ã‚‹ | Happy developing</title><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><body><div class=world><div class=content-container><header class=blog-header-container><div class=blog-logo><a href=https://blog.ymgyt.io>Happy developing</a></div><div class=blog-nav><nav><ul><li><a href=https://blog.ymgyt.io/entry/>Entries</a><li><a href=https://blog.ymgyt.io/tags/>Tags</a><li><a href=https://blog.ymgyt.io/about/>About</a><li><a href=https://github.com/ymgyt> <img alt=Github class=icon src=https://blog.ymgyt.io/images/icon/github.svg> </a><li><a href="https://twitter.com/YAmaguchixt "> <img alt=Twitter class=icon src=https://blog.ymgyt.io/images/icon/twitter.svg> </a></ul></nav></div></header><main class=blog-main><article><header class=entry-header><h1 class=entry-title>â™»ï¸ Rustã®exponential retryå®Ÿè£… againã®ã‚½ãƒ¼ã‚¹ã‚’èª­ã‚“ã§ã¿ã‚‹</h1><div class=entry-meta><p class=entry-meta-item>ğŸ—“ 2022-06-26<p class=entry-meta-item>ğŸ· <span class=tag><a href=https://blog.ymgyt.io/tags/rust/>rust</a></span></div></header><aside class=entry-toc><nav><ul class=entry-toc-toplevel-list><li><a href=https://blog.ymgyt.io/entry/again/#shi-yong-li>ä½¿ç”¨ä¾‹</a><li><a href=https://blog.ymgyt.io/entry/again/#retrypolicy-retry-if>RetryPolicy::retry_if</a><li><a href=https://blog.ymgyt.io/entry/again/#retrypolicy-collect-and-retry>RetryPolicy::collect_and_retry</a><li><a href=https://blog.ymgyt.io/entry/again/#matome>ã¾ã¨ã‚</a></ul></nav></aside><div class=entry-content><figure><div class=fig-images-row><img , alt src=images/rust_again.png></div><figcaption>again</figcaption></figure><p>æœ¬è¨˜äº‹ã§ã¯ã€Rustã§exponential retryã®æ©Ÿèƒ½ã‚’æä¾›ã™ã‚‹<a href=https://github.com/softprops/again rel=external>again</a>ã®ã‚½ãƒ¼ã‚¹ã‚’èª­ã‚“ã§ã„ãã¾ã™ã€‚<br> (<code>lib.rs</code> 1ãƒ•ã‚¡ã‚¤ãƒ«ã ã‘ã®å°ã•ãªcrateãªã®ã§ã™ãèª­ã‚ã¾ã™)<p>åŸºæœ¬çš„ã«productionã§network callã‚’è¡Œã†éš›ã¯retryãŒå¿…è¦ã«ãªã£ã¦ãã‚‹ã¨æ€ã„ã¾ã™ã€‚sidecarç­‰ã®é€éçš„ãªinfra layerã§ã¯ãªãapplication layerã§ã“ã‚Œã‚’å®Ÿç¾ã™ã‚‹å ´åˆã€å¤§ä½“ä»¥ä¸‹ã®ã‚ˆã†ãªå‡¦ç†ã‚’ã„ã‚Œã‚‹ã“ã¨ã«ãªã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚<ul><li>å‡¦ç†ã‚’loopã§å›²ã‚€<li>æœ€å¤§retryæ•°ã‚’è€ƒæ…®ã™ã‚‹<li>retryå¯èƒ½ã‹ã©ã†ã‹ã®ã‚¨ãƒ©ãƒ¼åˆ¤å®š<li>retryæ™‚ã®interval(<code>Duration</code>)ã®èª¿æ•´</ul><p>ã“ã®å‡¦ç†ã‚’å®£è¨€çš„ã«æŠ½è±¡åŒ–ã—ã¦ãã‚Œã‚‹ã®ãŒagainã§ã™ã€‚<h2 id=shi-yong-li><a aria-label="Anchor link for: shi-yong-li" class=zola-anchor href=#shi-yong-li>ä½¿ç”¨ä¾‹</a></h2><p>å®Ÿéš›ã®åˆ©ç”¨ä¾‹ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>sync</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Arc</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>sync</span><span style=color:#81a1c1>::</span><span>atomic</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>AtomicU64</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Ordering</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>time</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Duration</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> again</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>RetryPolicy</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Debug</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>enum</span><span style=color:#8fbcbb> Error</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Retryable</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Fatal</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[tokio::main]</span></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span>    tracing_init</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>init</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> policy</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> RetryPolicy</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>exponential</span><span style=color:#eceff4>(</span><span>Duration</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_secs</span><span style=color:#eceff4>(</span><span style=color:#b48ead>1</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>with_jitter</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>false</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>with_backoff_exponent</span><span style=color:#eceff4>(</span><span style=color:#b48ead>2</span><span style=color:#81a1c1>.</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>with_max_delay</span><span style=color:#eceff4>(</span><span>Duration</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_secs</span><span style=color:#eceff4>(</span><span style=color:#b48ead>60</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>with_max_retries</span><span style=color:#eceff4>(</span><span style=color:#b48ead>4</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> retry_count</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Arc</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>AtomicU64</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span style=color:#b48ead>0</span><span style=color:#eceff4>));</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> result</span><span style=color:#81a1c1> =</span><span> policy</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>retry_if</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#81a1c1>         ||</span><span style=color:#eceff4>  {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let</span><span> retry_count</span><span style=color:#81a1c1> =</span><span> Arc</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>retry_count</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>            async move</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                retry_count</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>fetch_add</span><span style=color:#eceff4>(</span><span style=color:#b48ead>1</span><span style=color:#eceff4>,</span><span> Ordering</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>SeqCst</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>                tracing</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0;font-weight:700>info!</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>?</span><span>retry_count</span><span style=color:#eceff4>, "</span><span style=color:#a3be8c>task run!</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>                Err</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>&lt;(),</span><span style=color:#8fbcbb> Error</span><span style=color:#eceff4>>(</span><span style=color:#8fbcbb>Error</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Retryable</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        },</span></span>
<span class=giallo-l><span style=color:#81a1c1>        |</span><span>err</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Error</span><span style=color:#81a1c1>| match</span><span> err</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Error</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Retryable</span><span style=color:#81a1c1> => true</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Error</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Fatal</span><span style=color:#81a1c1> => false</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>        },</span></span>
<span class=giallo-l><span style=color:#eceff4>    )</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>    tracing</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0;font-weight:700>info!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>result:?</span><span style=color:#ebcb8b>} {</span><span style=color:#a3be8c>retry_count:?</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>tracing_init::init()</code>ã¯<code>tracing_subscriber</code>ã®åˆæœŸåŒ–ãªã®ã§çœç•¥ã€‚<br> <code>RetryPolicy</code>ã§retryæ™‚ã®æŒ™å‹•ã‚’è¨­å®šã—ã¾ã™ã€‚<br> <code>RetryPolicy::retry_if()</code>ã®ç¬¬ä¸€å¼•æ•°ã«å®Ÿéš›ã«å®Ÿè¡Œã—ãŸã„å‡¦ç†ã‚’closureã§æ¸¡ã—ã¾ã™ã€‚ç¬¬äºŒå¼•æ•°ã¯ErrorãŒretryã§ãã‚‹ã‹ã©ã†ã‹ã®åˆ¤å®šã‚’ãŠã“ãªã†closureã§ã™ã€‚ ã“ã‚Œã‚’å®Ÿè¡Œã™ã‚‹ã¨ä»¥ä¸‹ã®å‡ºåŠ›ã‚’ãˆã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>2022-06-25T11:36:05.393876Z</span><span style=color:#a3be8c>  INFO retry/examples/retry_closure.rs:35: task run! retry_count=</span><span style=color:#b48ead>1</span></span>
<span class=giallo-l><span style=color:#88c0d0>2022-06-25T11:36:06.399287Z</span><span style=color:#a3be8c>  INFO retry/examples/retry_closure.rs:35: task run! retry_count=</span><span style=color:#b48ead>2</span></span>
<span class=giallo-l><span style=color:#88c0d0>2022-06-25T11:36:08.400343Z</span><span style=color:#a3be8c>  INFO retry/examples/retry_closure.rs:35: task run! retry_count=</span><span style=color:#b48ead>3</span></span>
<span class=giallo-l><span style=color:#88c0d0>2022-06-25T11:36:12.404406Z</span><span style=color:#a3be8c>  INFO retry/examples/retry_closure.rs:35: task run! retry_count=</span><span style=color:#b48ead>4</span></span>
<span class=giallo-l><span style=color:#88c0d0>2022-06-25T11:36:20.407705Z</span><span style=color:#a3be8c>  INFO retry/examples/retry_closure.rs:35: task run! retry_count=</span><span style=color:#b48ead>5</span></span>
<span class=giallo-l><span style=color:#88c0d0>2022-06-25T11:36:20.408518Z</span><span style=color:#a3be8c>  INFO retry/examples/retry_closure.rs:46: Err</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>Retryable</span><span style=color:#eceff4>)</span><span style=color:#b48ead> 5</span></span></code></pre><p>å®Ÿè¡Œå›æ•°ã¯æœ€å¤§retryæ•°(4) + 1ã§5å›ã¨ãªã£ã¦ã„ã¾ã™ã€‚<br> ã¾ãŸretryé–“ã®é–“éš”ã‚‚ã€1,2,4,8ã¨exponentialã«ãªã£ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚<p>ã¾ãŸã€å®Ÿè¡Œã™ã‚‹å‡¦ç†ã«<code>again::Task</code>traitã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ã§closureä»¥å¤–ã®ãƒ¦ãƒ¼ã‚¶å´ã§å®šç¾©ã—ãŸå‹ã‚‚åˆ©ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>future</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>Future</span><span style=color:#eceff4>,</span><span> ready</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Ready</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> MyTask</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    count</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> u32</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span> again</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Task</span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> MyTask</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Item</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> ();</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Error</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Error</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Fut</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Ready</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>Self::</span><span style=color:#8fbcbb>Item</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> Self::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>>>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> call</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> Self::</span><span style=color:#8fbcbb>Fut</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>count </span><span style=color:#81a1c1>+=</span><span style=color:#b48ead> 1</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>        tracing</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0;font-weight:700>info!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>MyTask call() </span><span style=color:#ebcb8b>{}</span><span style=color:#eceff4>",</span><span style=color:#81a1c1> self.</span><span>count</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        if self.</span><span>count</span><span style=color:#81a1c1> &lt;</span><span style=color:#b48ead> 3</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0>            ready</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Err</span><span style=color:#eceff4>(</span><span>Error</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Retryable</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0>            ready</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Err</span><span style=color:#eceff4>(</span><span>Error</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Fatal</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[tokio::main]</span></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span>    tracing_init</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>init</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> policy</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> RetryPolicy</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> my_task</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> MyTask</span><span style=color:#eceff4> {</span><span> count</span><span style=color:#81a1c1>:</span><span style=color:#b48ead> 0</span><span style=color:#eceff4> };</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> result</span><span style=color:#81a1c1> =</span><span> policy</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>retry_if</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>        my_task</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>        |</span><span>err</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Error</span><span style=color:#81a1c1>| match</span><span> err</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            Error</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Retryable</span><span style=color:#81a1c1> => true</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            Error</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Fatal</span><span style=color:#81a1c1> => false</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>        },</span></span>
<span class=giallo-l><span style=color:#eceff4>    )</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>    tracing</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0;font-weight:700>info!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>result:?</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span></code></pre><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>2022-06-25T11:12:22.640568Z</span><span style=color:#a3be8c>  INFO retry/examples/retry_struct.rs:26: MyTask call</span><span style=color:#eceff4>()</span><span style=color:#b48ead> 1</span></span>
<span class=giallo-l><span style=color:#88c0d0>2022-06-25T11:12:23.645944Z</span><span style=color:#a3be8c>  INFO retry/examples/retry_struct.rs:26: MyTask call</span><span style=color:#eceff4>()</span><span style=color:#b48ead> 2</span></span>
<span class=giallo-l><span style=color:#88c0d0>2022-06-25T11:12:25.651503Z</span><span style=color:#a3be8c>  INFO retry/examples/retry_struct.rs:26: MyTask call</span><span style=color:#eceff4>()</span><span style=color:#b48ead> 3</span></span>
<span class=giallo-l><span style=color:#88c0d0>2022-06-25T11:12:25.651825Z</span><span style=color:#a3be8c>  INFO retry/examples/retry_struct.rs:51: Err</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>Fatal</span><span style=color:#eceff4>)</span></span></code></pre><p>ã¨ã„ã†ã“ã¨ã§ã¾ãšã¯<code>RetryPolicy::retry_if</code>ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚<h2 id=retrypolicy-retry-if><a aria-label="Anchor link for: retrypolicy-retry-if" class=zola-anchor href=#retrypolicy-retry-if><code>RetryPolicy::retry_if</code></a></h2><p>ã¾ãšç™»å ´ã™ã‚‹å‹ã¨<code>retry_if</code>ã®signatureã‹ã‚‰è¦‹ã¦ã„ãã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>future</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Future</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>pub async fn</span><span style=color:#88c0d0> retry</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>>(</span><span>task</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> T</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Item</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> T</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>    where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        T</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Task</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#88c0d0>    retry_if</span><span style=color:#eceff4>(</span><span>task</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Always</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>pub async fn</span><span style=color:#88c0d0> retry_if</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb>C</span><span style=color:#eceff4>>(</span></span>
<span class=giallo-l><span>    task</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> T</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    condition</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> C</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>)</span><span style=color:#81a1c1>  -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Item</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> T</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    T</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Task</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    C</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Condition</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#616e88>    // RetryPolicy::default().retry_if(task,condition).await</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    todo!</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>retry</code>ã¯ã‚¨ãƒ©ãƒ¼åˆ¤å®šã‚’è¡Œã‚ãªã„å ´åˆã§ã™ã€‚<br> <code>retry_if</code>ã¯genericsã«ãªã£ã¦ãŠã‚Šã€å®Ÿéš›ã®å‡¦ç†ã‚’æŠ½è±¡åŒ–ã—ãŸ<code>Task</code>ã¨Errorã®åˆ¤å®šã‚’æŠ½è±¡åŒ–ã—ãŸ<code>Condition</code>ã‚’å¼•æ•°ã«ã¨ã‚Šã¾ã™ã€‚ <code>Task</code>ã®å®šç¾©ã¯ä»¥ä¸‹ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#616e88>/// A unit of work to be retried</span></span>
<span class=giallo-l><span style=color:#616e88>/// A implementation is provided for `FnMut() -> Future`</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub trait</span><span style=color:#8fbcbb;font-weight:700> Task</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Item</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Error</span><span style=color:#81a1c1>:</span><span> std</span><span style=color:#81a1c1>::</span><span>fmt</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Debug</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Fut</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Future</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Output</span><span style=color:#81a1c1>=</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>Self::</span><span style=color:#8fbcbb>Item</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> Self::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>>>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> call</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> Self::</span><span style=color:#8fbcbb>Fut</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>Associateå‹ã®<code>Item</code>ã¨<code>Error</code>ã‚’ã‚‚ã¡ã€<code>Result</code>ã‚’futureã§è¿”ã›ã‚‹ã“ã¨ã‚’è¦æ±‚ã—ã¾ã™ã€‚<br> ãƒ¦ãƒ¼ã‚¶ãŒ<code>Task</code>ã‚’æ„è­˜ã—ãªãã¦ã‚ˆã„ã‚ˆã†ã«closureã¸ã®<code>Task</code>ã®å®Ÿè£…ãŒæä¾›ã•ã‚Œã¦ãŠã‚Šã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>F</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Fut</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> I</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> E</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Task</span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> F</span></span>
<span class=giallo-l><span style=color:#81a1c1>    where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        F</span><span style=color:#81a1c1>:</span><span style=color:#88c0d0> FnMut</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Fut</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Fut</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Future</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Output</span><span style=color:#81a1c1>=</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>I</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> E</span><span style=color:#eceff4>>>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        E</span><span style=color:#81a1c1>:</span><span> std</span><span style=color:#81a1c1>::</span><span>fmt</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Debug</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Item</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> I</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Error</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> E</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Fut</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Fut</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> call</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> Self::</span><span style=color:#8fbcbb>Fut</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[cfg(test)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>mod</span><span> tests</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    use super::*</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>    #[tokio::test]</span></span>
<span class=giallo-l><span style=color:#81a1c1>    async fn</span><span style=color:#88c0d0> task_implemented_for_closure</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> f</span><span style=color:#81a1c1> = || async</span><span style=color:#eceff4> {</span><span style=color:#8fbcbb> Ok</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>u32</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> u32</span><span style=color:#eceff4>>(</span><span style=color:#b48ead>10</span><span style=color:#eceff4>) };</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>        retry</span><span style=color:#eceff4>(</span><span>f</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã“ã®ã‚ˆã†ã«closureã«<code>Task</code>ãŒå®šç¾©ã—ã¦ã‚ã‚‹ã®ã§<code>retry_if</code>ã«<code>|| async {..}</code>ã®ã‚ˆã†ãªclosureãŒæ¸¡ã›ã¾ã™ã€‚<br> æ¬¡ã«<code>Condition</code>ã§ã™ãŒä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#616e88>/// A type to determine if a failed Future should be retried</span></span>
<span class=giallo-l><span style=color:#616e88>/// A implementation is provided for `Fn(&Err) -> bool` allowing yout</span></span>
<span class=giallo-l><span style=color:#616e88>/// to use a simple closure or fn handles</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub trait</span><span style=color:#8fbcbb;font-weight:700> Condition</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>E</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>   fn</span><span style=color:#88c0d0> is_retryable</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#81a1c1>       &mut self</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>       error</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>E</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>   )</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> bool</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> Always</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>E</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Condition</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>E</span><span style=color:#eceff4>></span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> Always</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> is_retryable</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> _</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>E</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> bool</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        true</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>F</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb>E</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Condition</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>E</span><span style=color:#eceff4>></span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> F</span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span><span style=color:#8fbcbb> F</span><span style=color:#81a1c1>:</span><span style=color:#88c0d0> FnMut</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span style=color:#8fbcbb>E</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> bool</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> is_retryable</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> error</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>E</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> bool</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self</span><span style=color:#eceff4>(</span><span>error</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã“ã“ã§ã‚‚ã€<code>|err: &Error| -> bool</code>ã®closureã«<code>Condition</code>ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ãƒ¦ãƒ¼ã‚¶å´ã§ã¯æ„è­˜ã™ã‚‹ã“ã¨ãªãclosureã‚’æ¸¡ã›ã¾ã™ã€‚<p><code>retry_if</code>ã®signatureãŒã‚ã‹ã£ãŸã®ã§è‚å¿ƒã®å®Ÿè£…ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Clone</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Copy</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>enum</span><span style=color:#8fbcbb> Backoff</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Fixed</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Exponential</span><span style=color:#eceff4> {</span><span> exponent</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> f64</span><span style=color:#eceff4> },</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>/// A template for configuring retry behavior</span></span>
<span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Clone</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> RetryPolicy</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    backoff</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Backoff</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#5e81ac>    #[cfg(feature = "</span><span style=color:#a3be8c>rand</span><span style=color:#5e81ac>")]</span></span>
<span class=giallo-l><span>    jitter</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> bool</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    delay</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Duration</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    max_delay</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Duration</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>    max_retries</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> usize</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Default</span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> RetryPolicy</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> default</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -> Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            backoff</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Backoff</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>            delay</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Duration</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_secs</span><span style=color:#eceff4>(</span><span style=color:#b48ead>1</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#5e81ac>            #[cfg(feature = "</span><span style=color:#a3be8c>rand</span><span style=color:#5e81ac>")]</span></span>
<span class=giallo-l><span>            jitter</span><span style=color:#81a1c1>: false</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            max_delay</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> None</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            max_retries</span><span style=color:#81a1c1>:</span><span style=color:#b48ead> 5</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>retryæ™‚ã®æŒ™å‹•ã‚’å®£è¨€çš„ã«å®šç¾©ã™ã‚‹<code>RetryPolicy</code>ã¯ä¸Šè¨˜ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚<ul><li><code>backoff</code>ã¯retryæ™‚ã®intervalã‚’å›ºå®š(<code>Fixed</code>)ã«ã™ã‚‹ã‹exponential(<code>Exponential</code>)ã«å¢—åŠ ã•ã›ã‚‹ã‹ã®æŒ‡å®šã€‚<li><code>jitter</code>ã¯intervalã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«èª¿æ•´ã™ã‚‹ã‹ã®æŒ‡å®š<li><code>delay</code>ã¯intervalã®æœŸé–“ã€‚exponentialã®å ´åˆã¯ã“ã‚ŒãŒ2,4å€ã«ãªã£ã¦ã„ãã¾ã™ã€‚<li><code>max_delay</code>æœ€å¤§ã®intervalã€‚<code>min(max_delay, calculated_delay)</code>ã®ã‚ˆã†ã«ä½¿ã‚ã‚Œã¾ã™<li><code>max_retries</code>æœ€å¤§retryæ•°ã€‚éƒ½åˆå®Ÿè¡Œã•ã‚Œã‚‹å‡¦ç†ã¯<code>max_retries</code> + 1ã§ã™ã€‚APIçš„ã«Optionã«ãªã£ã¦ãŠã‚‰ãšå¿…ãšæŒ‡å®šã™ã‚‹ã“ã¨ãŒè¦æ±‚ã•ã‚Œã¾ã™ã€‚</ul><p>ã“ã®<code>RetryPolicy</code>ã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹<code>retry_if</code>ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> wasm_timer</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Delay</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> RetryPolicy</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub async fn</span><span style=color:#88c0d0> retry</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> task</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> T</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Item</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> T</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>    where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        T</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Task</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self::</span><span style=color:#88c0d0>retry_if</span><span style=color:#eceff4>(</span><span>task</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Always</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    pub async fn</span><span style=color:#88c0d0> retry_if</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> C</span><span style=color:#eceff4>>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> task</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> T</span><span style=color:#eceff4>,</span><span> condition</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> C</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Item</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> T</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>    where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        T</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Task</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        C</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Condition</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> backoffs</span><span style=color:#81a1c1> = self.</span><span style=color:#88c0d0>backoffs</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> task</span><span style=color:#81a1c1> =</span><span> task</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> condition</span><span style=color:#81a1c1> =</span><span> condition</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        loop</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            return match</span><span> task</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>call</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Ok</span><span style=color:#eceff4>(</span><span>result</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>(</span><span>result</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Err</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    if</span><span> condition</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>is_retryable</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>err</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#616e88>                        // Backoff has two responsibilities.</span></span>
<span class=giallo-l><span style=color:#616e88>                        //   * Control whether to retry or not.</span></span>
<span class=giallo-l><span style=color:#616e88>                        //     backoff iter take care of max_retry policy.</span></span>
<span class=giallo-l><span style=color:#616e88>                        //   * If it does, control the duration of the delay.</span></span>
<span class=giallo-l><span style=color:#81a1c1>                        if let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>delay</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> backoffs</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>next</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span>                            tracing</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0;font-weight:700>trace!</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>                                "</span><span style=color:#a3be8c>task failed with error </span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>err:?</span><span style=color:#ebcb8b>}</span><span style=color:#a3be8c>. will try again in  </span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>delay:?</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#eceff4>                            );</span></span>
<span class=giallo-l><span style=color:#81a1c1>                            let</span><span> _</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Delay</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>delay</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>                            continue</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>                        }</span></span>
<span class=giallo-l><span style=color:#eceff4>                    }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                    Err</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#eceff4>            };</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>loopã§ãƒ¦ãƒ¼ã‚¶ãŒæ¸¡ã—ãŸclosureã‚’å‘¼ã³å‡ºã—ã¦ã€Errã®å ´åˆã«retryåˆ¤å®šã—ãŸã®ã¡ã«ã€retryã™ã‚‹ã‹ã€ã™ã‚‹ã¨ã—ãŸã‚‰ã©ã‚Œãã‚‰ã„å¾…æ©Ÿã™ã‚‹ã‹ã‚’<code>RetryPolicy::backoffs</code>ãŒè¿”ã™<code>Iterator</code>ã§åˆ¤å®šã—ã¾ã™ã€‚<br> ã¨ã„ã†ã“ã¨ã§ã€exponentialã‚„<code>RetryPolicy</code>ã«åŸºã¥ã„ãŸåˆ¶å¾¡ã¯<code>Backoff</code>å´ã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> RetryPolicy</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> backoffs</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> impl</span><span style=color:#8fbcbb> Iterator</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Item</span><span style=color:#81a1c1>=</span><span style=color:#8fbcbb>Duration</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>backoff</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>iter</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Clone</span><span style=color:#5e81ac>,</span><span style=color:#8fbcbb> Copy</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>enum</span><span style=color:#8fbcbb> Backoff</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Fixed</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Exponential</span><span style=color:#eceff4> {</span><span> exponent</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> f64</span><span style=color:#eceff4> },</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Backoff</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    const</span><span> DEFAULT_EXPONENT</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> f64</span><span style=color:#81a1c1> =</span><span style=color:#b48ead> 2</span><span style=color:#eceff4>.</span><span style=color:#b48ead>0</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> iter</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self</span><span style=color:#eceff4>,</span><span> policy</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>RetryPolicy</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> BackoffIter</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        BackoffIter</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            backoff</span><span style=color:#81a1c1>: self</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            current</span><span style=color:#81a1c1>:</span><span style=color:#b48ead> 1</span><span style=color:#eceff4>.</span><span style=color:#b48ead>0</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#5e81ac>            #[cfg(feature = "</span><span style=color:#a3be8c>rand</span><span style=color:#5e81ac>")]</span></span>
<span class=giallo-l><span>            jitter</span><span style=color:#81a1c1>:</span><span> policy</span><span style=color:#81a1c1>.</span><span>jitter</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            delay</span><span style=color:#81a1c1>:</span><span> policy</span><span style=color:#81a1c1>.</span><span>delay</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            max_delay</span><span style=color:#81a1c1>:</span><span> policy</span><span style=color:#81a1c1>.</span><span>max_delay</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            max_retries</span><span style=color:#81a1c1>:</span><span> policy</span><span style=color:#81a1c1>.</span><span>max_retries</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> BackoffIter</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    backoff</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Backoff</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    current</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> f64</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#5e81ac>    #[cfg(feature = "</span><span style=color:#a3be8c>rand</span><span style=color:#5e81ac>")]</span></span>
<span class=giallo-l><span>    jitter</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> bool</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    delay</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Duration</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    max_delay</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Duration</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>    max_retries</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> usize</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Iterator</span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> BackoffIter</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Item</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Duration</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> next</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>Self::</span><span style=color:#8fbcbb>Item</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if self.</span><span>max_retries</span><span style=color:#81a1c1> ></span><span style=color:#b48ead> 0</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let</span><span> factor</span><span style=color:#81a1c1> = match self.</span><span>backoff </span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Backoff</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Fixed</span><span style=color:#81a1c1> => self.</span><span>current</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Backoff</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Exponential</span><span style=color:#eceff4> {</span><span> exponent</span><span style=color:#eceff4> }</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    let</span><span> factor</span><span style=color:#81a1c1> = self.</span><span>current</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    let</span><span> next_factor</span><span style=color:#81a1c1> = self.</span><span>current </span><span style=color:#81a1c1>*</span><span> exponent</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    self.</span><span>current </span><span style=color:#81a1c1>=</span><span> next_factor</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span>                    factor</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#eceff4>            };</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>            let mut</span><span> delay</span><span style=color:#81a1c1> = self.</span><span>delay</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>mul_f64</span><span style=color:#eceff4>(</span><span>factor</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#5e81ac>            #[cfg(feature = "</span><span style=color:#a3be8c>rand</span><span style=color:#5e81ac>")]</span></span>
<span class=giallo-l><span style=color:#eceff4>            {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                if self.</span><span>jitter </span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span>                    delay</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> jitter</span><span style=color:#eceff4>(</span><span>delay</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#81a1c1>            if let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>max_delay</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> = self.</span><span>max_delay </span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span>                delay</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> min</span><span style=color:#eceff4>(</span><span>delay</span><span style=color:#eceff4>,</span><span> max_delay</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#81a1c1>            self.</span><span>max_retries </span><span style=color:#81a1c1>-=</span><span style=color:#b48ead> 1</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>            return</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>delay</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        None</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã¨ã„ã†ã“ã¨ã§ã€<code>BackoffIter::next</code>ã®ä¸­ã§ã€exponential, jitter, max_retries, max_delayãŒå®Ÿè£…ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚<br> ã“ã®ã‚ãŸã‚Šã®åˆ¤å®šå‡¦ç†ãŒ<code>BackoffIter</code>ã«åˆ‡ã‚Šå‡ºã•ã‚Œã¦ã„ã‚‹ã®ã§ã€<code>RetryPolicy::retry_if</code>ã®å‡¦ç†ãŒã¨ã¦ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ã«ãªã£ã¦ã„ã¦èª­ã¿ã‚„ã™ã„ã¨æ€ã„ã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[cfg(test)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>mod</span><span> tests</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    use super::*</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    use</span><span> approx</span><span style=color:#81a1c1>::</span><span>assert_relative_eq</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    use</span><span> std</span><span style=color:#81a1c1>::</span><span>error</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>    #[test]</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> exponential_backoff</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> iter</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> RetryPolicy</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>exponential</span><span style=color:#eceff4>(</span><span>Duration</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_secs</span><span style=color:#eceff4>(</span><span style=color:#b48ead>1</span><span style=color:#eceff4>))</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>backoffs</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>        assert_relative_eq!</span><span style=color:#eceff4>(</span><span>iter</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>next</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_secs_f64</span><span style=color:#eceff4>(),</span><span style=color:#b48ead> 1</span><span style=color:#eceff4>.</span><span style=color:#b48ead>0</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>        assert_relative_eq!</span><span style=color:#eceff4>(</span><span>iter</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>next</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_secs_f64</span><span style=color:#eceff4>(),</span><span style=color:#b48ead> 2</span><span style=color:#eceff4>.</span><span style=color:#b48ead>0</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>        assert_relative_eq!</span><span style=color:#eceff4>(</span><span>iter</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>next</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_secs_f64</span><span style=color:#eceff4>(),</span><span style=color:#b48ead> 4</span><span style=color:#eceff4>.</span><span style=color:#b48ead>0</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>        assert_relative_eq!</span><span style=color:#eceff4>(</span><span>iter</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>next</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_secs_f64</span><span style=color:#eceff4>(),</span><span style=color:#b48ead> 8</span><span style=color:#eceff4>.</span><span style=color:#b48ead>0</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>        assert_relative_eq!</span><span style=color:#eceff4>(</span><span>iter</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>next</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_secs_f64</span><span style=color:#eceff4>(),</span><span style=color:#b48ead> 16</span><span style=color:#eceff4>.</span><span style=color:#b48ead>0</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>jitterã®å®Ÿè£…ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>time</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Duration</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> rand</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span>distributions</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>OpenClosed01</span><span style=color:#eceff4>,</span><span> thread_rng</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Rng</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[cfg(feature = "</span><span style=color:#a3be8c>rand</span><span style=color:#5e81ac>")]</span></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> jitter</span><span style=color:#eceff4>(</span><span>duration</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Duration</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Duration</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> jitter</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> f64</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> thread_rng</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>sample</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>OpenClosed01</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> secs</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> (</span><span>duration</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_secs</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> as</span><span style=color:#8fbcbb> f64</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> *</span><span> jitter</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> nanos</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> (</span><span>duration</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>subsec_nanos</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> as</span><span style=color:#8fbcbb> f64</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> *</span><span> jitter</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> millis</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> (</span><span>secs</span><span style=color:#81a1c1> *</span><span style=color:#b48ead> 1_000_</span><span style=color:#8fbcbb>f64</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> +</span><span style=color:#eceff4> (</span><span>nanos</span><span style=color:#81a1c1> /</span><span style=color:#b48ead> 1_000_000_</span><span style=color:#8fbcbb>f64</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Duration</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_millis</span><span style=color:#eceff4>(</span><span>millis</span><span style=color:#81a1c1> as</span><span style=color:#8fbcbb> u64</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><h2 id=retrypolicy-collect-and-retry><a aria-label="Anchor link for: retrypolicy-collect-and-retry" class=zola-anchor href=#retrypolicy-collect-and-retry><code>RetryPolicy::collect_and_retry</code></a></h2><p>againã§ã¯ã€<code>retry_if</code>ã«åŠ ãˆã¦å‡¦ç†ãŒæˆåŠŸã—ãŸå ´åˆã§ã‚‚å‡¦ç†ã‚’ç¹°ã‚Šè¿”ã—ã¤ã¤ã€çµæœã‚’<code>Vec</code>ã§è¿”ã™ã€<code>collect_and_retry</code>ã‚‚æä¾›ã—ã¦ã„ã¾ã™ã€‚<br> signatureã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> RetryPolicy</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub async fn</span><span style=color:#88c0d0> collect_and_retry</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> C</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> D</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>>(</span></span>
<span class=giallo-l><span style=color:#81a1c1>        &self</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        task</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> T</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        success_condition</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> C</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        error_condition</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> D</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        start_value</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    )</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Vec</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Item</span><span style=color:#eceff4>>,</span><span style=color:#8fbcbb> T</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>        where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            T</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> TaskWithParameter</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            C</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> SuccessCondition</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Item</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            D</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Condition</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            S</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Clone</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>        todo!</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><ul><li><code>TaskWithParameter</code>ã¯å¼•æ•°ã‚’ã¨ã‚‹<code>Task</code>ã®æ‹¡å¼µã€‚ <ul><li><code>|| { ... }</code>ã§ã¯ãªãã€<code>|input| { ... }</code>ã®ã‚ˆã†ãªclosureã‚’æ¸¡ã›ã‚‹ã‚ˆã†ã«ãªã‚‹</ul><li><code>SuccessCondition</code>ã¯æˆåŠŸæ™‚ã®ç¶™ç¶šåˆ¤å®šå‡¦ç†ã¨æ¬¡ã®å‡¦ç†ã¸ã®å¼•æ•°ç”Ÿæˆå‡¦ç†<li><code>Condition</code>ã¯<code>retry_if</code>ã¨åŒæ§˜ã€‚<li><code>S</code>ã¯<code>TaskWithParameter</code>ã§æ¸¡ã™closureã®å¼•æ•°ã®å‹</ul><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#616e88>/// A type to determine if a successful Future should be retried</span></span>
<span class=giallo-l><span style=color:#616e88>/// A implementation is provided for `Fn(&Result) -> Option&lt;S>`, where S</span></span>
<span class=giallo-l><span style=color:#616e88>/// represents the next input value.</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub trait</span><span style=color:#8fbcbb;font-weight:700> SuccessCondition</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>R</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> retry_with</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> result</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>R</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>F</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> R</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> SuccessCondition</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>R</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>></span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> F</span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    F</span><span style=color:#81a1c1>:</span><span style=color:#88c0d0> Fn</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span style=color:#8fbcbb>R</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> retry_with</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> result</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>R</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self</span><span style=color:#eceff4>(</span><span>result</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>Error</code>ã§ã¯ãªãã€<code>Result</code>ã§ç¶™ç¶šã™ã‚‹ã‹åˆ¤å®šã™ã‚‹ã€‚<code>Some</code>ã§è¿”ã—ãŸå€¤ã¯æ¬¡ã®å‡¦ç†ã®å¼•æ•°ã«åˆ©ç”¨ã•ã‚Œã‚‹ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#616e88>/// A unit of work to be retried, that accepts a parameter</span></span>
<span class=giallo-l><span style=color:#616e88>/// A implementation is provided for `FnMut() -> Future`</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub trait</span><span style=color:#8fbcbb;font-weight:700> TaskWithParameter</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>P</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Item</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Error</span><span style=color:#81a1c1>:</span><span> std</span><span style=color:#81a1c1>::</span><span>fmt</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Debug</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Fut</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Future</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Output</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>Self::</span><span style=color:#8fbcbb>Item</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> Self::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>>>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> call</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> parameter</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> P</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> Self::</span><span style=color:#8fbcbb>Fut</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>F</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> P</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Fut</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> I</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> E</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> TaskWithParameter</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>P</span><span style=color:#eceff4>></span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> F</span></span>
<span class=giallo-l><span style=color:#81a1c1>    where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        F</span><span style=color:#81a1c1>:</span><span style=color:#88c0d0> FnMut</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>P</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Fut</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Fut</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Future</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Output</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>I</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> E</span><span style=color:#eceff4>>>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        E</span><span style=color:#81a1c1>:</span><span> std</span><span style=color:#81a1c1>::</span><span>fmt</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Debug</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Item</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> I</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Error</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> E</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Fut</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Fut</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> call</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> parameter</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> P</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> Self::</span><span style=color:#8fbcbb>Fut</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self</span><span style=color:#eceff4>(</span><span>parameter</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>Task</code>ã«å¼•æ•°ã®å‹ã®æŠ½è±¡åŒ–<code>P</code>ã‚’è¿½åŠ ã—ãŸå‹ã€‚genericsã®æ‹¡å¼µã®ä»•æ–¹ã¨ã—ã¦å‚è€ƒã«ãªã‚Šã¾ã™ã€‚<br> æœ€çµ‚çš„ãªå®Ÿè£…ã¯<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> RetryPolicy</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub async fn</span><span style=color:#88c0d0> collect_and_retry</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> C</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> D</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>>(</span></span>
<span class=giallo-l><span style=color:#81a1c1>        &self</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        task</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> T</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        success_condition</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> C</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        error_condition</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> D</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        start_value</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    )</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Vec</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Item</span><span style=color:#eceff4>>,</span><span style=color:#8fbcbb> T</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>        where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            T</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> TaskWithParameter</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            C</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> SuccessCondition</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Item</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> S</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            D</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Condition</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            S</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Clone</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> success_backoffs</span><span style=color:#81a1c1> = self.</span><span style=color:#88c0d0>backoffs</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> error_backoffs</span><span style=color:#81a1c1> = self.</span><span style=color:#88c0d0>backoffs</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> success_condition</span><span style=color:#81a1c1> =</span><span> success_condition</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> error_condition</span><span style=color:#81a1c1> =</span><span> error_condition</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> task</span><span style=color:#81a1c1> =</span><span> task</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> results</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0;font-weight:700> vec!</span><span style=color:#eceff4>[];</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> input</span><span style=color:#81a1c1> =</span><span> start_value</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> last_result</span><span style=color:#81a1c1> =</span><span> start_value</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        loop</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            return match</span><span> task</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>call</span><span style=color:#eceff4>(</span><span>input</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Ok</span><span style=color:#eceff4>(</span><span>item</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    let</span><span> maybe_new_input</span><span style=color:#81a1c1> =</span><span> success_condition</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>retry_with</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>item</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span>                    results</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>push</span><span style=color:#eceff4>(</span><span>item</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>                    if let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>new_input</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> maybe_new_input</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                        if let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>delay</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> success_backoffs</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>next</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span>                            tracing</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0;font-weight:700>trace!</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>                                "</span><span style=color:#a3be8c>task succeeded and condition is met. will run again in </span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>delay:?</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#eceff4>                            );</span></span>
<span class=giallo-l><span style=color:#81a1c1>                            let</span><span> _</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Delay</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>delay</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span>                            input</span><span style=color:#81a1c1> =</span><span> new_input</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span>                            last_result</span><span style=color:#81a1c1> =</span><span> new_input</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>                            continue</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>                        }</span></span>
<span class=giallo-l><span style=color:#eceff4>                    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>                    Ok</span><span style=color:#eceff4>(</span><span>results</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Err</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    if</span><span> error_condition</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>is_retryable</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>err</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                        if let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>delay</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> error_backoffs</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>next</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span>                            tracing</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0;font-weight:700>trace!</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>                                "</span><span style=color:#a3be8c>task failed with error </span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>err:?</span><span style=color:#ebcb8b>}</span><span style=color:#a3be8c>. will retry again in </span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>delay:?</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#eceff4>                            );</span></span>
<span class=giallo-l><span style=color:#81a1c1>                            let</span><span> _</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Delay</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>delay</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span>                            input</span><span style=color:#81a1c1> =</span><span> last_result</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>                            continue</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>                        }</span></span>
<span class=giallo-l><span style=color:#eceff4>                    }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                    Err</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#eceff4>            };</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>Err</code>æ™‚ã®retryã¯<code>retry_if</code>ã¨åŒã˜ã§ã€é•ã†ã®ã¯æˆåŠŸæ™‚ã«ã‚‚retryåˆ¤å®šãŒèµ°ã‚‹ç‚¹ã€‚<br> ä»¥ä¸‹ã®ã‚ˆã†ã«ç¬¬ä¸€å¼•æ•°ã®closureãŒå¼•æ•°ã‚’ã¨ã‚Œã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[tokio::test]</span></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> collect_and_retry_retries_when_success_condition_is_met</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;(),</span><span style=color:#8fbcbb> Box</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>dyn</span><span style=color:#8fbcbb> Error</span><span style=color:#eceff4>>></span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> result</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> RetryPolicy</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>fixed</span><span style=color:#eceff4>(</span><span>Duration</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_millis</span><span style=color:#eceff4>(</span><span style=color:#b48ead>1</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>collect_and_retry</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#81a1c1>            |</span><span>input</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> u32</span><span style=color:#81a1c1>| async move</span><span style=color:#eceff4> {</span><span style=color:#8fbcbb> Ok</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>u32</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> u32</span><span style=color:#eceff4>>(</span><span>input</span><span style=color:#81a1c1> +</span><span style=color:#b48ead> 1</span><span style=color:#eceff4>) },</span></span>
<span class=giallo-l><span style=color:#81a1c1>            |</span><span>result</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>u32</span><span style=color:#81a1c1>| if *</span><span>result</span><span style=color:#81a1c1> &lt;</span><span style=color:#b48ead> 2</span><span style=color:#eceff4> {</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>*</span><span>result</span><span style=color:#eceff4>) }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span><span style=color:#8fbcbb> None</span><span style=color:#eceff4> },</span></span>
<span class=giallo-l><span style=color:#81a1c1>            |</span><span>err</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>u32</span><span style=color:#81a1c1>| *</span><span>err</span><span style=color:#81a1c1> ></span><span style=color:#b48ead> 1</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#b48ead>            0</span><span style=color:#81a1c1> as</span><span style=color:#8fbcbb> u32</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>        )</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .await</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    assert_eq!</span><span style=color:#eceff4>(</span><span>result</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>(</span><span style=color:#88c0d0;font-weight:700>vec!</span><span style=color:#eceff4>[</span><span style=color:#b48ead>1</span><span style=color:#eceff4>,</span><span style=color:#b48ead> 2</span><span style=color:#eceff4>]));</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Ok</span><span style=color:#eceff4>(())</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><h2 id=matome><a aria-label="Anchor link for: matome" class=zola-anchor href=#matome>ã¾ã¨ã‚</a></h2><ul><li>retryé–¢é€£ã®å‡¦ç†ãŒã‚·ãƒ³ãƒ—ãƒ«ã«æ›¸ã„ã¦ã‚ã£ã¦èª­ã¿ã‚„ã™ã‹ã£ãŸã§ã™ã€‚loopã®å®Ÿè¡Œåˆ¶å¾¡ã¨åˆ¤å®šå‡¦ç†ãŒãã‚Œã„ã«åˆ†é›¢ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚<li>async blockã‚’ã‚‚ã¤closureã‚’wrapã™ã‚‹å‡¦ç†ã‚’æä¾›ã—ãŸã„ã¨ãã®æŠ½è±¡åŒ–ã®ä»•æ–¹ãŒã¨ã¦ã‚‚å‚è€ƒã«ãªã‚Šã¾ã—ãŸã€‚(<code>Task</code> trait)</ul></div></article></main><footer class=blog-footer><p>Â© 2026 <a href=https://blog.ymgyt.io> ymgyt </a> | Made with <a href=https://www.getzola.org rel=noopener target=_blank>Zola</a> | <a href=https://github.com/ymgyt/blog>Repository</a> | <a href=https://blog.ymgyt.io/atom.xml target=_blank title=rss> <svg viewbox="0 0 24 24" class=icon fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx=5 cy=19 r=1></circle></svg> </a></footer></div></div>