<!doctype html><html lang=ja><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1" name=viewport><link href=https://blog.ymgyt.io/favicon.ico rel=icon sizes=any><link href=https://blog.ymgyt.io/icon.svg rel=icon type=image/svg+xml><link href=https://blog.ymgyt.io/apple-touch-icon.png rel=apple-touch-icon><link href=https://blog.ymgyt.io/manifest.webmanifest rel=manifest><link href=https://blog.ymgyt.io/style.css rel=stylesheet><link href=https://blog.ymgyt.io/atom.xml rel=alternate title=Atom type=application/atom+xml><script src="https://www.googletagmanager.com/gtag/js?id=G-GTB0KMLN90" async></script><script>window.dataLayer = window.dataLayer || [];
	function gtag() {dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-GTB0KMLN90');</script><title>ğŸ—¼ Key Value Storeã‚’ä½œã‚ŠãªãŒã‚‰å­¦ã¶tokio | Happy developing</title><meta content=summary name=twitter:card><meta content="@YAmaguchixt " name=twitter:site><meta content="ğŸ—¼ Key Value Storeã‚’ä½œã‚ŠãªãŒã‚‰å­¦ã¶tokio" name=twitter:title><meta content=https://blog.ymgyt.io/images/emoji/tokyo_tower.png name=twitter:image><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><body><div class=world><div class=content-container><header class=blog-header-container><div class=blog-logo><a href=https://blog.ymgyt.io>Happy developing</a></div><div class=blog-nav><nav><ul><li><a href=https://blog.ymgyt.io/entry/>Entries</a><li><a href=https://blog.ymgyt.io/tags/>Tags</a><li><a href=https://blog.ymgyt.io/about/>About</a><li><a href=https://github.com/ymgyt> <img alt=Github class=icon src=https://blog.ymgyt.io/images/icon/github.svg> </a><li><a href="https://twitter.com/YAmaguchixt "> <img alt=Twitter class=icon src=https://blog.ymgyt.io/images/icon/twitter.svg> </a></ul></nav></div></header><main class=blog-main><article><header class=entry-header><h1 class=entry-title>ğŸ—¼ Key Value Storeã‚’ä½œã‚ŠãªãŒã‚‰å­¦ã¶tokio</h1><div class=entry-meta><p class=entry-meta-item>ğŸ—“ 2020-12-24<p class=entry-meta-item>ğŸ· <span class=tag><a href=https://blog.ymgyt.io/tags/rust/>rust</a></span></div></header><aside class=entry-toc><nav><ul class=entry-toc-toplevel-list><li><a href=https://blog.ymgyt.io/entry/key_value_store_with_tokio/#zuo-tutamono>ä½œã£ãŸã‚‚ã®</a><li><a href=https://blog.ymgyt.io/entry/key_value_store_with_tokio/#tcp-server>TCP Server</a> <ul><li><a href=https://blog.ymgyt.io/entry/key_value_store_with_tokio/#max-connection>Max Connection</a><li><a href=https://blog.ymgyt.io/entry/key_value_store_with_tokio/#graceful-shutdown>Graceful shutdown</a><li><a href=https://blog.ymgyt.io/entry/key_value_store_with_tokio/#stream-read-write>Stream read/write</a><li><a href=https://blog.ymgyt.io/entry/key_value_store_with_tokio/#tls>TLS</a></ul><li><a href=https://blog.ymgyt.io/entry/key_value_store_with_tokio/#shared-statewomutexkarachanneldeguan-li>Shared stateã‚’Mutexã‹ã‚‰channelã§ç®¡ç†</a><li><a href=https://blog.ymgyt.io/entry/key_value_store_with_tokio/#filehenoappend-onlynabao-cun>Fileã¸ã®append onlyãªä¿å­˜</a><li><a href=https://blog.ymgyt.io/entry/key_value_store_with_tokio/#matome>ã¾ã¨ã‚</a></ul></nav></aside><div class=entry-content><p>æœ¬ã‚¨ãƒ³ãƒˆãƒªãƒ¼ã§ã¯Key Value Storeã‚’<a href=https://github.com/tokio-rs/tokio rel=external>tokio</a>ã§ä½œã‚‹ã†ãˆã§å­¦ã‚“ã ã“ã¨ã‚’æ›¸ã„ã¦ã„ãã¾ã™ã€‚<br> Rustã®LTä¼š <a href=https://forcia.connpass.com/event/194229/ rel=external>Shinjuku.rs #13</a>ã§è©±ã•ã›ã¦ã„ãŸã ã„ãŸå†…å®¹ã§ã™ã€‚<p>ç™ºè¡¨æ™‚ã®ã‚¹ãƒ©ã‚¤ãƒ‰</p><iframe src="https://docs.google.com/presentation/d/e/2PACX-1vR-AmvaVFQFeMI79HorEznJo8eK0ipPnVUVXtQcT3IEy-s1pprD9MANe0eBwceqXm7Xuavhe9dP6NYY/embed?start=false&loop=false&delayms=3000" allowfullscreen frameborder=0 height=569 mozallowfullscreen=true webkitallowfullscreen=true width=960></iframe><p><a href=https://github.com/ymgyt/kvsd rel=external>source code</a><h2 id=zuo-tutamono><a aria-label="Anchor link for: zuo-tutamono" class=zola-anchor href=#zuo-tutamono>ä½œã£ãŸã‚‚ã®</a></h2><p>TCP(TLS)ã§remoteã«æ¥ç¶šã—ã¦Key/Valueã‚’CRUDã™ã‚‹ã ã‘ã®serverã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>â¯</span><span style=color:#a3be8c> export KVSD_HOST=kvsd.ymgyt.io</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>â¯</span><span style=color:#a3be8c> kvsd set hello rust</span></span>
<span class=giallo-l><span style=color:#88c0d0>OK</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>â¯</span><span style=color:#a3be8c> kvsd get hello</span></span>
<span class=giallo-l><span style=color:#88c0d0>rust</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>â¯</span><span style=color:#a3be8c> kvsd set hello</span><span style=color:#eceff4> '</span><span style=color:#a3be8c>rust!!!</span><span style=color:#eceff4>'</span></span>
<span class=giallo-l><span style=color:#88c0d0>OK</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>â¯</span><span style=color:#a3be8c> kvsd delete hello</span></span>
<span class=giallo-l><span style=color:#88c0d0>OK</span><span style=color:#a3be8c> old value: rust!!!</span></span></code></pre><h2 id=tcp-server><a aria-label="Anchor link for: tcp-server" class=zola-anchor href=#tcp-server>TCP Server</a></h2><figure><div class=fig-images-row><img , alt src=images/kvsd_tcp_server.jpeg></div><figcaption>æ¦‚è¦</figcaption></figure><p>Clientã‹ã‚‰ã®TCPæ¥ç¶šã”ã¨ã«taskã‚’<code>tokio::spawn()</code>ã—ã¦å°‚ç”¨ã®Handlerã‚’ç”Ÿæˆã—ã¾ã™ã€‚<br> Key/Valueã‚’ä¿å­˜ã™ã‚‹Fileã”ã¨ã«ã‚‚taskã‚’ç”Ÿæˆã—ã¦ãŠãã€å…±æœ‰resourceã®å‡¦ç†ã§lockç­‰ãŒå¿…è¦ãªã„ã‚ˆã†ã«ã—ã¾ã™ã€‚ (å›³ã®å››è§’ãŒ<code>tokio::spawn()</code>ã—ãŸtaskã‚’è¡¨ã—ã¦ã„ã¾ã™)<h3 id=max-connection><a aria-label="Anchor link for: max-connection" class=zola-anchor href=#max-connection>Max Connection</a></h3><p>tokioã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€clientã”ã¨ã«threadã‚’ç”Ÿæˆã™ã‚‹å¿…è¦ãŒãªããªã£ãŸã®ã§ã™ãŒç„¡åˆ¶é™ã«taskã‚’ç”Ÿæˆã™ã‚‹ã‚ã‘ã«ã‚‚ã„ã‹ãªã„ã®ã§æœ€å¤§connectionæ•°ã‚’åˆ¶å¾¡ã—ãŸã„ã§ã™ã€‚<br> æœ€å¤§connectionã«é”ã—ãŸã¨ãã¯<code>TcpListener.accept()</code>ã‚’ã‚ˆã³ã ã•ãªã„ã‚ˆã†ã«å®Ÿè£…ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> SemaphoreListener</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    inner</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> TcpListener</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    max_connections</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Arc</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Semaphore</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> SemaphoreListener</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> new</span><span style=color:#eceff4>(</span><span>listener</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> TcpListener</span><span style=color:#eceff4>,</span><span> max_connections</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> u32</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            inner</span><span style=color:#81a1c1>:</span><span> listener</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            max_connections</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Arc</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>Semaphore</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>max_connections</span><span style=color:#81a1c1> as</span><span style=color:#8fbcbb> usize</span><span style=color:#eceff4>)),</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    async fn</span><span style=color:#88c0d0> accept</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span> std</span><span style=color:#81a1c1>::</span><span>io</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;(</span><span style=color:#8fbcbb>TcpStream</span><span style=color:#eceff4>,</span><span> std</span><span style=color:#81a1c1>::</span><span>net</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>SocketAddr</span><span style=color:#eceff4>)> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>max_connections</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>acquire</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await.</span><span style=color:#88c0d0>forget</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>inner</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>accept</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/ymgyt/kvsd/blob/6b40c6a3edad0f416631f7ae66674fb5d7922cd7/src/server/tcp.rs#L494 rel=external>https://github.com/ymgyt/kvsd/blob/6b40c6a3edad0f416631f7ae66674fb5d7922cd7/src/server/tcp.rs#L494</a><p><code>tokio::sync::Semaphore</code>ã§<code>TcpListener</code>ã‚’wrapã—ã¦<code>accept()</code>æ™‚ã«<code>acquire()</code>ã‚’ã‚ˆã¶ã“ã¨ã§æœ€å¤§connectionã«é”ã—ãŸã¨ãã¯blockã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚<br> æ‰€æœ‰æ¨©ã®é–¢ä¿‚ã§<code>forget()</code>ã‚’å‘¼ã‚“ã§ã„ã‚‹ã®ã§ã€Clientã¨ã®æ¥ç¶šãŒçµ‚äº†ã—ãŸã¨ãã®Handlerã®dropå‡¦ç†ã§å¸³å°»ã‚’ã‚ã‚ã›ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> Handler</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span>    max_connections</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Arc</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Semaphore</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Drop</span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> Handler</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> drop</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>max_connections</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>add_permits</span><span style=color:#eceff4>(</span><span style=color:#b48ead>1</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://blog.ymgyt.io/entry/key_value_store_with_tokio/%5Bhttps://github.com/ymgyt/kvsd/blob/6b40c6a3edad0f416631f7ae66674fb5d7922cd7/src/server/tcp.rs#L488%5D>https://github.com/ymgyt/kvsd/blob/6b40c6a3edad0f416631f7ae66674fb5d7922cd7/src/server/tcp.rs#L488</a><h3 id=graceful-shutdown><a aria-label="Anchor link for: graceful-shutdown" class=zola-anchor href=#graceful-shutdown>Graceful shutdown</a></h3><figure><div class=fig-images-row><img , alt src=images/kvsd_graceful_shutdown_1.jpeg></div><figcaption>Shutdownã®é€šçŸ¥</figcaption></figure><figure><div class=fig-images-row><img , alt src=images/kvsd_graceful_shutdown_2.jpeg></div><figcaption>Shutdownã®å¾…æ©Ÿ</figcaption></figure><p>çµ‚äº†å‡¦ç†æ™‚(SIGINTç­‰)ã«ã™ã¹ã¦ã®Clientã¨ã®æ¥ç¶šãŒåˆ‡ã‚Œã‚‹ã¾ã§å¾…æ©Ÿã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚<br> Graceful shutdownã«å¿…è¦ãªå‡¦ç†ã¯ãã‚Œãã‚Œä»¥ä¸‹ã®tokioã®APIã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§å®Ÿç¾ã§ãã¾ã—ãŸã€‚<ul><li>Signal handling => <code>tokio::signal::ctrl_c()</code><li>Shutdownã®é€šçŸ¥ => <code>tokio::sync::broadcast::channel()</code><li>Shutdownã®å¾…æ©Ÿ =><code>tokio::sync::mpsc::channel()</code></ul><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Server</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>crate</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> async fn</span><span style=color:#88c0d0> run</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#81a1c1>        mut self</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        listener</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> TcpListener</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        shutdown</span><span style=color:#81a1c1>: impl</span><span style=color:#8fbcbb> Future</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    )</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span>        tokio</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0;font-weight:700>select!</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            result</span><span style=color:#81a1c1> = self.</span><span style=color:#88c0d0>serve</span><span style=color:#eceff4>(</span><span>listener</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                if let</span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> result</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>                    error!</span><span style=color:#eceff4>(</span><span>cause</span><span style=color:#81a1c1> = %</span><span>err</span><span style=color:#eceff4>, "</span><span style=color:#a3be8c>Failed to accept</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span>            _</span><span style=color:#81a1c1> =</span><span> shutdown</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>                info!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Shutdown signal received</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>        info!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Notify shutdown to all handlers</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>graceful_shutdown</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>shutdown</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>        info!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Shutdown successfully completed</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        Ok</span><span style=color:#eceff4>(())</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> GracefulShutdown</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    notify_shutdown</span><span style=color:#81a1c1>:</span><span> broadcast</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Sender</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>ShutdownSignal</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>    shutdown_complete_tx</span><span style=color:#81a1c1>:</span><span> mpsc</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Sender</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>ShutdownCompleteSignal</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>    shutdown_complete_rx</span><span style=color:#81a1c1>:</span><span> mpsc</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Receiver</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>ShutdownCompleteSignal</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> GracefulShutdown</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> new</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -> Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span style=color:#eceff4> (</span><span>notify_shutdown</span><span style=color:#eceff4>,</span><span> _</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> broadcast</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>channel</span><span style=color:#eceff4>(</span><span style=color:#b48ead>1</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span style=color:#eceff4> (</span><span>shutdown_complete_tx</span><span style=color:#eceff4>,</span><span> shutdown_complete_rx</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> mpsc</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>channel</span><span style=color:#eceff4>(</span><span style=color:#b48ead>1</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            notify_shutdown</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            shutdown_complete_tx</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            shutdown_complete_rx</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    // Notify handlers of the shutdown and wait for it to be completed.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    async fn</span><span style=color:#88c0d0> shutdown</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>mut self</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#616e88>        // Notify shutdown to all handler.</span></span>
<span class=giallo-l><span style=color:#88c0d0>        drop</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span>notify_shutdown</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>        // Drop final Sender so the Receiver below can complete.</span></span>
<span class=giallo-l><span style=color:#88c0d0>        drop</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span>shutdown_complete_tx</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>        // Wait for all handler to finish.</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> _</span><span style=color:#81a1c1> = self.</span><span>shutdown_complete_rx</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>recv</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/ymgyt/kvsd/blob/6b40c6a3edad0f416631f7ae66674fb5d7922cd7/src/server/tcp.rs#L204 rel=external>https://github.com/ymgyt/kvsd/blob/6b40c6a3edad0f416631f7ae66674fb5d7922cd7/src/server/tcp.rs#L204</a><br> <a href=https://github.com/ymgyt/kvsd/blob/6b40c6a3edad0f416631f7ae66674fb5d7922cd7/src/server/tcp.rs#L204 rel=external>https://github.com/ymgyt/kvsd/blob/6b40c6a3edad0f416631f7ae66674fb5d7922cd7/src/server/tcp.rs#L159</a><p><code>tokio::select!</code>ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€taskå†…ã§ï¼’ã¤ã®futureã‚’åŒæ™‚ã«<code>await</code>ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚<br> <code>impl Future</code>ã¨ã—ã¦ãŠãã“ã¨ã§testæ™‚ã«ã¯<code>tokio::sync::Notify</code>ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã§ãã¾ã™ã€‚<br> <a href=https://github.com/ymgyt/kvsd/blob/6b40c6a3edad0f416631f7ae66674fb5d7922cd7/tests/integration_test.rs#L38 rel=external>https://github.com/ymgyt/kvsd/blob/6b40c6a3edad0f416631f7ae66674fb5d7922cd7/tests/integration_test.rs#L38</a><h3 id=stream-read-write><a aria-label="Anchor link for: stream-read-write" class=zola-anchor href=#stream-read-write>Stream read/write</a></h3><p>TCPä¸Šã§è‡ªåˆ†ã§å®šç¾©ã—ãŸãƒ‡ãƒ¼ã‚¿æ§‹é€ ã§ã®é€šä¿¡ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚<br> <code>Message</code>ã¯Client-Serveré–“ã§ã‚„ã‚Šã¨ã‚Šã™ã‚‹å˜ä½ã§ã™(<code>Authenticate</code>, <code>Set</code>, <code>Success</code>,...)<br> <code>Frame</code>ã¯<code>Message</code>ã®æ§‹æˆè¦ç´ ã§ã™(<code>String</code>, <code>Bytes</code>,<code>Null</code>,...)<br> å®Ÿä½“ã¯redis serialization protocolã®åŠ£åŒ–ç‰ˆã¿ãŸã„ãªã‚‚ã®ã§ã™ã€‚<p><code>TcpStream</code>/<code>TlsStream</code>ã‚’wrapã—ãŸæ§‹é€ ä½“ã‚’å®šç¾©ã—ã¦ã€client/serverã«protocolå®Ÿè£…ã‚’æä¾›ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> bytes</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>Buf</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> BytesMut</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> tokio</span><span style=color:#81a1c1>::</span><span>io</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>AsyncRead</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> AsyncReadExt</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> AsyncWrite</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> AsyncWriteExt</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> BufWriter</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> Connection</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> TcpStream</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span>    stream</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> BufWriter</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#616e88>    // The buffer for reading frames.</span></span>
<span class=giallo-l><span>    buffer</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> BytesMut</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://blog.ymgyt.io/entry/key_value_store_with_tokio/%5Bhttps://github.com/ymgyt/kvsd/blob/6b40c6a3edad0f416631f7ae66674fb5d7922cd7/src/protocol/connection/mod.rs#L12%5D>https://github.com/ymgyt/kvsd/blob/6b40c6a3edad0f416631f7ae66674fb5d7922cd7/src/protocol/connection/mod.rs#L12</a><p><code>buffer</code>ã¯tcpã‹ã‚‰readã—ã¦Messageã‚’æ§‹æˆã™ã‚‹ãŸã‚ã«åˆ©ç”¨ã—ã¾ã™ã€‚<h4 id=write><a aria-label="Anchor link for: write" class=zola-anchor href=#write>write</a></h4><p>client/serverã‹ã‚‰é€šä¿¡ã—ãŸã„<code>Message</code>ã‚’ã†ã‘ã¨ã‚‹ã¨ãã‚Œã‚’<code>Frames</code>ã«åˆ†è§£ã—ã¦ãã‚Œãã‚Œserializationã—ã¦ã„ãã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> tokio</span><span style=color:#81a1c1>::</span><span>io</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>AsyncRead</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> AsyncReadExt</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> AsyncWrite</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> AsyncWriteExt</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> BufWriter</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Connection</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    T</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> AsyncWrite</span><span style=color:#81a1c1> +</span><span style=color:#8fbcbb> AsyncRead</span><span style=color:#81a1c1> +</span><span style=color:#8fbcbb> Unpin</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>crate</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> async fn</span><span style=color:#88c0d0> write_message</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> message</span><span style=color:#81a1c1>: impl</span><span style=color:#8fbcbb> Into</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>MessageFrames</span><span style=color:#eceff4>>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> frames</span><span style=color:#81a1c1> =</span><span> message</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>stream</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write_u8</span><span style=color:#eceff4>(</span><span>frameprefix</span><span style=color:#81a1c1>::</span><span>MESSAGE_FRAMES</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span style=color:#88c0d0>write_decimal</span><span style=color:#eceff4>(</span><span>frames</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>len</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        for</span><span> frame</span><span style=color:#81a1c1> in</span><span> frames</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            self.</span><span style=color:#88c0d0>write_frame</span><span style=color:#eceff4>(</span><span>frame</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await?</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>stream</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>flush</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Ok</span><span style=color:#eceff4>(())</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    async fn</span><span style=color:#88c0d0> write_frame</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> frame</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Frame</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        match</span><span> frame</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Frame</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>MessageType</span><span style=color:#eceff4>(</span><span>mt</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span>stream</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write_u8</span><span style=color:#eceff4>(</span><span>frameprefix</span><span style=color:#81a1c1>::</span><span>MESSAGE_TYPE</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span>stream</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write_u8</span><span style=color:#eceff4>(</span><span>mt</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Frame</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>String</span><span style=color:#eceff4>(</span><span>val</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span>stream</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write_u8</span><span style=color:#eceff4>(</span><span>frameprefix</span><span style=color:#81a1c1>::</span><span>STRING</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span>stream</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write_all</span><span style=color:#eceff4>(</span><span>val</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_bytes</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span>stream</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write_all</span><span style=color:#eceff4>(</span><span>DELIMITER</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Frame</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Bytes</span><span style=color:#eceff4>(</span><span>val</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span>stream</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write_u8</span><span style=color:#eceff4>(</span><span>frameprefix</span><span style=color:#81a1c1>::</span><span>BYTES</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span style=color:#88c0d0>write_decimal</span><span style=color:#eceff4>(</span><span>val</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>len</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> as</span><span style=color:#8fbcbb> u64</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span>stream</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write_all</span><span style=color:#eceff4>(</span><span>val</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_ref</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span>stream</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write_all</span><span style=color:#eceff4>(</span><span>DELIMITER</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Frame</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Time</span><span style=color:#eceff4>(</span><span>val</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span>stream</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write_u8</span><span style=color:#eceff4>(</span><span>frameprefix</span><span style=color:#81a1c1>::</span><span>TIME</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span>stream</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write_all</span><span style=color:#eceff4>(</span><span>val</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_rfc3339</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_bytes</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span>stream</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write_all</span><span style=color:#eceff4>(</span><span>DELIMITER</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Frame</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Null</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span>stream</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write_u8</span><span style=color:#eceff4>(</span><span>frameprefix</span><span style=color:#81a1c1>::</span><span>NULL</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        Ok</span><span style=color:#eceff4>(())</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://blog.ymgyt.io/entry/key_value_store_with_tokio/%5Bhttps://github.com/ymgyt/kvsd/blob/6b40c6a3edad0f416631f7ae66674fb5d7922cd7/src/protocol/connection/mod.rs#L29%5D>https://github.com/ymgyt/kvsd/blob/6b40c6a3edad0f416631f7ae66674fb5d7922cd7/src/protocol/connection/mod.rs#L29</a><p><code>AsyncWriteExt</code>ã«ã¯endianã‚’è€ƒæ…®ã—ãŸwrite methodãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹ã®ã§ä¾¿åˆ©ã§ã™ã€‚<h4 id=read><a aria-label="Anchor link for: read" class=zola-anchor href=#read>read</a></h4><figure class="figure-image figure-image-fotolife" title=readã®æ¦‚è¦>[f:id:yamaguchi7073xtt:20201224185344j:plain]<figcaption>readã®æ¦‚è¦</figcaption></figure><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Connection</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>    where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        T</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> AsyncWrite</span><span style=color:#81a1c1> +</span><span style=color:#8fbcbb> AsyncRead</span><span style=color:#81a1c1> +</span><span style=color:#8fbcbb> Unpin</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>crate</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> async fn</span><span style=color:#88c0d0> read_message_with_timeout</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#81a1c1>        &mut self</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        duration</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Duration</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    )</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Message</span><span style=color:#eceff4>>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        match</span><span> tokio</span><span style=color:#81a1c1>::</span><span>time</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>timeout</span><span style=color:#eceff4>(</span><span>duration</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> self.</span><span style=color:#88c0d0>read_message</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Ok</span><span style=color:#eceff4>(</span><span>read_result</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span> read_result</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Err</span><span style=color:#eceff4>(</span><span>elapsed</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Error</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from</span><span style=color:#eceff4>(</span><span>elapsed</span><span style=color:#eceff4>)),</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>crate</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> async fn</span><span style=color:#88c0d0> read_message</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Message</span><span style=color:#eceff4>>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        match self.</span><span style=color:#88c0d0>read_message_frames</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Some</span><span style=color:#eceff4>(</span><span>message_frames</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Some</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Message</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_frames</span><span style=color:#eceff4>(</span><span>message_frames</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>)),</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            None</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>None</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    async fn</span><span style=color:#88c0d0> read_message_frames</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>MessageFrames</span><span style=color:#eceff4>>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        loop</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            if let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>message_frames</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> = self.</span><span style=color:#88c0d0>parse_message_frames</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>?</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                return</span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Some</span><span style=color:#eceff4>(</span><span>message_frames</span><span style=color:#eceff4>));</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>            if</span><span style=color:#b48ead> 0</span><span style=color:#81a1c1> == self.</span><span>stream</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>read_buf</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self.</span><span>buffer</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                return if self.</span><span>buffer</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>is_empty</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                    Ok</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>None</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                    Err</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>ErrorKind</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>ConnectionResetByPeer</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>())</span></span>
<span class=giallo-l><span style=color:#eceff4>                };</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> parse_message_frames</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>MessageFrames</span><span style=color:#eceff4>>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        use</span><span> FrameError</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Incomplete</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> buf</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Cursor</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self.</span><span>buffer</span><span style=color:#eceff4>[</span><span style=color:#81a1c1>..</span><span style=color:#eceff4>]);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        match</span><span style=color:#8fbcbb> MessageFrames</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>check_parse</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut</span><span> buf</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Ok</span><span style=color:#eceff4>(</span><span>_</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                let</span><span> len</span><span style=color:#81a1c1> =</span><span> buf</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>position</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> as</span><span style=color:#8fbcbb> usize</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span>                buf</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>set_position</span><span style=color:#eceff4>(</span><span style=color:#b48ead>0</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>                let</span><span> message_frames</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> MessageFrames</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>parse</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut</span><span> buf</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span>buffer</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>advance</span><span style=color:#eceff4>(</span><span>len</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>                Ok</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Some</span><span style=color:#eceff4>(</span><span>message_frames</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Err</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Incomplete</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>None</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Err</span><span style=color:#eceff4>(</span><span>e</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span>e</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>()),</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://blog.ymgyt.io/entry/key_value_store_with_tokio/%5Bhttps://github.com/ymgyt/kvsd/blob/6b40c6a3edad0f416631f7ae66674fb5d7922cd7/src/protocol/connection/mod.rs#L73%5D>https://github.com/ymgyt/kvsd/blob/6b40c6a3edad0f416631f7ae66674fb5d7922cd7/src/protocol/connection/mod.rs#L73</a><p>futureã«timeoutã‚’è¨­å®šã™ã‚‹ã«ã¯<code>tokio::time::timeout</code>ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚<br> <code>tokio::time::timeout()</code>ã§wrapã™ã‚‹ã¨timeoutã¤ãã®futureã‚’ä½œã‚Œã€timeoutã™ã‚‹ã¨<code>tokio::time::Elapsed</code>ã‚’è¿”ã—ã¦ãã‚Œã¾ã™ã€‚<p>tcpã‹ã‚‰readã—ãŸã¨ãã«æ„å‘³ã‚ã‚‹å˜ä½ã§readã§ãã¦ã„ã‚‹ã¨ã¯é™ã‚‰ãªã„ã®ã§bufferã«èª­ã¿è¾¼ã‚“ã ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ä¸€åº¦parseã‚’è©¦ã¿ã¾ã™ã€‚<br> parseæ™‚ã®å®Ÿè£…ã‚’simpleã«ã™ã‚‹ãŸã‚ã«<code>std::io::Cursor</code>ã§wrapã—ã¦ãŠãã“ã¨ã§ã€parseå´ã§ã¯å¿…è¦ãªå˜ä½ã§bufferã‚’èª­ã¿è¾¼ã‚ã¾ã™ã€‚<br> bufferã«<code>Message</code>ã‚’æ§‹æˆã™ã‚‹ã«ååˆ†ãª<code>Frame</code>ãŒãªã„å ´åˆã¯loopã§tcpã®readã‚’ç¹°ã‚Šè¿”ã—ã¾ã™ã€‚<br> bufferã«ååˆ†ãª<code>Frames</code>ãŒã‚ã‚‹å ´åˆã¯ã€å‘¼ã³å‡ºã—å…ƒã«<code>Message</code>ã‚’è¿”ã—ã¦ã€bufferã‚’clearã—ã¾ã™ã€‚<h4 id=tcpstreamnotestnihatokio-io-duplex-gabian-li><a aria-label="Anchor link for: tcpstreamnotestnihatokio-io-duplex-gabian-li" class=zola-anchor href=#tcpstreamnotestnihatokio-io-duplex-gabian-li><code>TcpStream</code>ã®testã«ã¯<code>tokio::io::duplex()</code>ãŒä¾¿åˆ©</a></h4><p><code>TcpStream</code>ã‚’wrapã—ãŸã‚ˆã†ãªå‹ã®testã§ã¯<code>tokio::io::duplex()</code>ãŒä¾¿åˆ©ã§ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[test]</span></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> message_frames</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span>    tokio_test</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>block_on</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>async move</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span style=color:#eceff4> (</span><span>client</span><span style=color:#eceff4>,</span><span> server</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> tokio</span><span style=color:#81a1c1>::</span><span>io</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>duplex</span><span style=color:#eceff4>(</span><span style=color:#b48ead>1024</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> client_conn</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Connection</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>client</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> None</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> server_conn</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Connection</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>server</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> None</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> messages</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Vec</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Message</span><span style=color:#eceff4>></span><span style=color:#81a1c1> =</span><span style=color:#88c0d0;font-weight:700> vec!</span><span style=color:#eceff4>[</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Message</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Authenticate</span><span style=color:#eceff4>(</span><span>Authenticate</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>user</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>pass</span><span style=color:#eceff4>")),</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Message</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Ping</span><span style=color:#eceff4>(</span><span>Ping</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>record_client_time</span><span style=color:#eceff4>()),</span></span>
<span class=giallo-l><span style=color:#616e88>            // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>        ];</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> messages_clone</span><span style=color:#81a1c1> =</span><span> messages</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> write_handle</span><span style=color:#81a1c1> =</span><span> tokio</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>spawn</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>async move</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            for</span><span> message</span><span style=color:#81a1c1> in</span><span> messages</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                client_conn</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write_message</span><span style=color:#eceff4>(</span><span>message</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        });</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> read_handle</span><span style=color:#81a1c1> =</span><span> tokio</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>spawn</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>async move</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            for</span><span> want</span><span style=color:#81a1c1> in</span><span> messages_clone</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                let</span><span> got</span><span style=color:#81a1c1> =</span><span> server_conn</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>read_message</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>                assert_eq!</span><span style=color:#eceff4>(</span><span>want</span><span style=color:#eceff4>,</span><span> got</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        });</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>        write_handle</span><span style=color:#81a1c1>.await.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span>        read_handle</span><span style=color:#81a1c1>.await.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#eceff4>    })</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://blog.ymgyt.io/entry/key_value_store_with_tokio/%5Bhttps://github.com/ymgyt/kvsd/blob/6b40c6a3edad0f416631f7ae66674fb5d7922cd7/src/protocol/connection/mod.rs#L147%5D>https://github.com/ymgyt/kvsd/blob/6b40c6a3edad0f416631f7ae66674fb5d7922cd7/src/protocol/connection/mod.rs#L147</a><p>ã“ã®ã‚ˆã†ãªæ„Ÿã˜ã§tcp listenerã‚’ç”¨æ„ã›ãšã«ãƒ¡ãƒ¢ãƒªä¸Šã§testãŒå®Œçµã§ãã¾ã—ãŸã€‚<br> async codeã®testã§ã¯runtimeã‚’èµ·å‹•ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚‹ã®ã§ã€<code>tokio_test</code>ã‚’åˆ©ç”¨ã—ã¾ã—ãŸã€‚<h3 id=tls><a aria-label="Anchor link for: tls" class=zola-anchor href=#tls>TLS</a></h3><p>TCPã‚’TLSã§ä¿è­·ã™ã‚‹ã«ã¯<code>tokio_rustls</code>ã‚’åˆ©ç”¨ã§ãã¾ã™ã€‚<h4 id=server><a aria-label="Anchor link for: server" class=zola-anchor href=#server>server</a></h4><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> tokio_rustls</span><span style=color:#81a1c1>::</span><span>rustls</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> tokio_rustls</span><span style=color:#81a1c1>::</span><span>server</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>TlsStream</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> tokio_rustls</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>TlsAcceptor</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>let mut</span><span> tls_config</span><span style=color:#81a1c1> =</span><span> rustls</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>ServerConfig</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>rustls</span><span style=color:#81a1c1>::</span><span>NoClientAuth</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#81a1c1>let</span><span> certs</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Vec</span><span style=color:#eceff4>&lt;</span><span>rustls</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Certificate</span><span style=color:#eceff4>></span><span style=color:#81a1c1> = self.</span><span>config</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>load_certs</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>let mut</span><span> keys</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Vec</span><span style=color:#eceff4>&lt;</span><span>rustls</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>PrivateKey</span><span style=color:#eceff4>></span><span style=color:#81a1c1> = self.</span><span>config</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>load_keys</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>tls_config</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>set_single_cert</span><span style=color:#eceff4>(</span><span>certs</span><span style=color:#eceff4>,</span><span> keys</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>remove</span><span style=color:#eceff4>(</span><span style=color:#b48ead>0</span><span style=color:#eceff4>))</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>let</span><span> tls_acceptor</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> TlsAcceptor</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from</span><span style=color:#eceff4>(</span><span>Arc</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>tls_config</span><span style=color:#eceff4>));</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>let</span><span> tls_stream</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> TlsStream</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>TcpStream</span><span style=color:#eceff4>></span><span style=color:#81a1c1> =</span><span> acceptor</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>accept</span><span style=color:#eceff4>(</span><span>stream</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span></code></pre><p><a href=https://blog.ymgyt.io/entry/key_value_store_with_tokio/%5Bhttps://github.com/ymgyt/kvsd/blob/6b40c6a3edad0f416631f7ae66674fb5d7922cd7/src/server/tcp.rs#L251%5D>https://github.com/ymgyt/kvsd/blob/6b40c6a3edad0f416631f7ae66674fb5d7922cd7/src/server/tcp.rs#L251</a><p>è¨­å®šã‚’ç”Ÿæˆã—ã¦ã€éµã¨è¨¼æ˜æ›¸ã‚’loadã—ã¦ã€<code>TcpStream</code>ã‚’wrapã—ã¾ã™ã€‚<h4 id=client><a aria-label="Anchor link for: client" class=zola-anchor href=#client>client</a></h4><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> tokio_rustls</span><span style=color:#81a1c1>::</span><span>client</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>TlsStream</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> tokio_rustls</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span>rustls</span><span style=color:#eceff4>,</span><span> webpki</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> TlsConnector</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>// tokio-rustls = { version = "0.20.0", features = ["dangerous_configuration"] }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>let mut</span><span> tls_config</span><span style=color:#81a1c1> =</span><span> rustls</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>ClientConfig</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span>tls_config</span></span>
<span class=giallo-l><span style=color:#81a1c1>  .</span><span style=color:#88c0d0>dangerous</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>  .</span><span style=color:#88c0d0>set_certificate_verifier</span><span style=color:#eceff4>(</span><span>Arc</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>DangerousServerCertVerifier</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>()));</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>let</span><span> connector</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> TlsConnector</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from</span><span style=color:#eceff4>(</span><span>Arc</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>tls_config</span><span style=color:#eceff4>));</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>let</span><span> domain</span><span style=color:#81a1c1> =</span><span> webpki</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>DNSNameRef</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>try_from_ascii_str</span><span style=color:#eceff4>(</span><span>host</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>  .</span><span style=color:#88c0d0>map_err</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>_</span><span style=color:#81a1c1>|</span><span> io</span><span style=color:#81a1c1>::</span><span>Error</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>io</span><span style=color:#81a1c1>::</span><span>ErrorKind</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>InvalidInput</span><span style=color:#eceff4>, "</span><span style=color:#a3be8c>invalid host</span><span style=color:#eceff4>"))</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>let</span><span> stream</span><span style=color:#81a1c1> =</span><span> tokio</span><span style=color:#81a1c1>::</span><span>net</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>TcpStream</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>connect</span><span style=color:#eceff4>(</span><span>addr</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>let</span><span> tls_stream</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> TlsStream</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>TcpStream</span><span style=color:#eceff4>></span><span style=color:#81a1c1> =</span><span> connector</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>connect</span><span style=color:#eceff4>(</span><span>domain</span><span style=color:#eceff4>,</span><span> stream</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span></code></pre><p>clientã‚‚åŒæ§˜ã«è¨­å®šã‚’ç”Ÿæˆã—ã¦<code>TcpStream</code>ã‚’wrapã—ã¦ã‚„ã‚Šã¾ã™ã€‚<br> localç’°å¢ƒã§ã¯ã‚ªãƒ¬ã‚ªãƒ¬è¨¼æ˜æ›¸ã‚’ä½¿ã„ãŸã‹ã£ãŸã®ã§<code>dangerous_configuration</code> featureã‚’æœ‰åŠ¹ã«ã—ã¦è¨¼æ˜æ›¸æ¤œè¨¼å‡¦ç†ã‚’è‡ªåˆ†ã§å®šç¾©ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> DangerousServerCertVerifier</span><span style=color:#eceff4> {}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> DangerousServerCertVerifier</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> new</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -> Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        Self</span><span style=color:#eceff4> {}</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span> rustls</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>ServerCertVerifier</span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> DangerousServerCertVerifier</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> verify_server_cert</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#81a1c1>        &self</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        _roots</span><span style=color:#81a1c1>: &</span><span>rustls</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>RootCertStore</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        _presented_certs</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>[</span><span>rustls</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Certificate</span><span style=color:#eceff4>],</span></span>
<span class=giallo-l><span>        _dns_name</span><span style=color:#81a1c1>:</span><span> webpki</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>DNSNameRef</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>        _oscp_response</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>[</span><span style=color:#8fbcbb>u8</span><span style=color:#eceff4>],</span></span>
<span class=giallo-l><span style=color:#eceff4>    )</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span>rustls</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>ServerCertVerified</span><span style=color:#eceff4>,</span><span> rustls</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>TLSError</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Ok</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>ServerCertVerified</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>assertion</span><span style=color:#eceff4>())</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://blog.ymgyt.io/entry/key_value_store_with_tokio/%5Bhttps://github.com/ymgyt/kvsd/blob/6b40c6a3edad0f416631f7ae66674fb5d7922cd7/src/client/tcp.rs#L168%5D>https://github.com/ymgyt/kvsd/blob/6b40c6a3edad0f416631f7ae66674fb5d7922cd7/src/client/tcp.rs#L168</a><h2 id=shared-statewomutexkarachanneldeguan-li><a aria-label="Anchor link for: shared-statewomutexkarachanneldeguan-li" class=zola-anchor href=#shared-statewomutexkarachanneldeguan-li>Shared stateã‚’Mutexã‹ã‚‰channelã§ç®¡ç†</a></h2><p>[f:id:yamaguchi7073xtt:20201224185418j:plain]<p>Shared state(file)ã‚’æ’ä»–çš„ã«åˆ©ç”¨ã—ãŸã„å ´åˆã«Mutexç­‰ã§lockã™ã‚‹ã®ã§ã¯ãªãå°‚ç”¨ã®taskã‚’ç”Ÿæˆã—ã¦channelçµŒç”±ã§å‡¦ç†ã‚’ä¾é ¼ã—ã¾ã™ã€‚<br> å‡¦ç†ã®ä¾é ¼ã‚’channelã«æ›¸ãè¾¼ã‚€ã®ã¯ã„ã„ã®ã§ã™ãŒã€çµæœã‚’ã©ã†å—ã‘å–ã‚‹ã®ã‹ãŒå•é¡Œã«ãªã£ã¦ãã¾ã™ã€‚<br> ã“ã“ã§ã¯<code>tokio::sync::oneshot</code>ã‚’åˆ©ç”¨ã—ã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> tokio</span><span style=color:#81a1c1>::</span><span>sync</span><span style=color:#81a1c1>::</span><span>oneshot</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>pub</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>crate</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> struct</span><span style=color:#8fbcbb> Work</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Req</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Res</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>crate</span><span style=color:#eceff4>)</span><span> request</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Req</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#616e88>    // Wrap with option so that response can be sent via mut reference.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>crate</span><span style=color:#eceff4>)</span><span> response_sender</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span>oneshot</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Sender</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Res</span><span style=color:#eceff4>>>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://blog.ymgyt.io/entry/key_value_store_with_tokio/%5Bhttps://github.com/ymgyt/kvsd/blob/6b40c6a3edad0f416631f7ae66674fb5d7922cd7/src/client/tcp.rs#L168%5D>https://github.com/ymgyt/kvsd/blob/6b40c6a3edad0f416631f7ae66674fb5d7922cd7/src/core/uow.rs#L27</a><p>å‡¦ç†ã‚’ä¾é ¼ã™ã‚‹å‹ã®fieldã«<code>oneshot::Sender&lt;T></code>ã‚’å®šç¾©ã—ã¦ãŠãå‘¼ã³å‡ºã—å…ƒã§ä¿æŒã—ã¦ã„ã‚‹<code>Receiver</code>ã§çµæœã‚’ã†ã‘ã¨ã‚Šã¾ã™ã€‚<br> serverãŒclientã‹ã‚‰<code>Message</code>ã‚’ã†ã‘ã¨ã£ã¦ã€Key/Valueã‚’å–å¾—ã™ã‚‹å‡¦ç†ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#8fbcbb>Message</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Get</span><span style=color:#eceff4>(</span><span>get</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span style=color:#eceff4> (</span><span>work</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Uow</span><span style=color:#eceff4>,</span><span> rx</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Receiver</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;</span><span>_</span><span style=color:#eceff4>>>)</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> UnitOfWork</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new_get</span><span style=color:#eceff4>(</span><span>get</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>    self.</span><span>sender</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>send</span><span style=color:#eceff4>(</span><span>work</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    match</span><span> rx</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Ok</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Some</span><span style=color:#eceff4>(</span><span>value</span><span style=color:#eceff4>))</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            connection</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write_message</span><span style=color:#eceff4>(</span><span>Success</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>with_value</span><span style=color:#eceff4>(</span><span>value</span><span style=color:#eceff4>))</span><span style=color:#81a1c1>.await?</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Ok</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>None</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span> connection</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write_message</span><span style=color:#eceff4>(</span><span>Success</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        _</span><span style=color:#81a1c1> =></span><span style=color:#88c0d0;font-weight:700> unreachable!</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://blog.ymgyt.io/entry/key_value_store_with_tokio/%5Bhttps://github.com/ymgyt/kvsd/blob/6b40c6a3edad0f416631f7ae66674fb5d7922cd7/src/server/tcp.rs#L444%5D>https://github.com/ymgyt/kvsd/blob/6b40c6a3edad0f416631f7ae66674fb5d7922cd7/src/server/tcp.rs#L444</a><h2 id=filehenoappend-onlynabao-cun><a aria-label="Anchor link for: filehenoappend-onlynabao-cun" class=zola-anchor href=#filehenoappend-onlynabao-cun>Fileã¸ã®append onlyãªä¿å­˜</a></h2><figure class="figure-image figure-image-fotolife" title="Key Valueã®æŒã¡æ–¹">[f:id:yamaguchi7073xtt:20201224185446j:plain]<figcaption>Key Valueã®æŒã¡æ–¹</figcaption></figure><p>ã‚ˆã†ã‚„ãKey/Valueã®è©±ã«ã€‚<br> æ°¸ç¶šåŒ–ã™ã‚‹Key/Valueã¯fileã«append onlyã§ä¿å­˜ã—ã¦ã„ãã¾ã™ã€‚ãƒ¡ãƒ¢ãƒªä¸Šã§ã¯Keyã¨offsetã‚’ä¿æŒã—ã¦ãŠãã¾ã™ã€‚<br> Key/Valueã‚’fileã‹ã‚‰èª­ã¿è¾¼ã‚€å‡¦ç†ã¯ã„ã‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> tokio</span><span style=color:#81a1c1>::</span><span>sync</span><span style=color:#81a1c1>::</span><span>mpsc</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Receiver</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> tokio</span><span style=color:#81a1c1>::</span><span>io</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>AsyncRead</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> AsyncSeek</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> AsyncSeekExt</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> AsyncWrite</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> SeekFrom</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>pub</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>crate</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> struct</span><span style=color:#8fbcbb> Table</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>File</span><span style=color:#81a1c1> =</span><span> fs</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>File</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span>    file</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> File</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    index</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Index</span><span style=color:#eceff4>,</span><span style=color:#616e88> // HashMap&lt;String,usize>,</span></span>
<span class=giallo-l><span>    receiver</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Receiver</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>UnitOfWork</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>File</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> Table</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>File</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    File</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> AsyncWrite</span><span style=color:#81a1c1> +</span><span style=color:#8fbcbb> AsyncRead</span><span style=color:#81a1c1> +</span><span style=color:#8fbcbb> AsyncSeek</span><span style=color:#81a1c1> +</span><span style=color:#8fbcbb> Unpin</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    async fn</span><span style=color:#88c0d0> lookup_entry</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> key</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Key</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Entry</span><span style=color:#eceff4>>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> offset</span><span style=color:#81a1c1> = match self.</span><span>index</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>lookup_offset</span><span style=color:#eceff4>(</span><span>key</span><span style=color:#eceff4>){</span></span>
<span class=giallo-l><span style=color:#8fbcbb>Some</span><span style=color:#eceff4>(</span><span>offset</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span> offset</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            	None</span><span style=color:#81a1c1> => return</span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>None</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4> };</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> current</span><span style=color:#81a1c1> = self.</span><span>file</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>seek</span><span style=color:#eceff4>(</span><span>SeekFrom</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Current</span><span style=color:#eceff4>(</span><span style=color:#b48ead>0</span><span style=color:#eceff4>))</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>file</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>seek</span><span style=color:#eceff4>(</span><span>SeekFrom</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Start</span><span style=color:#eceff4>(</span><span>offset</span><span style=color:#81a1c1> as</span><span style=color:#8fbcbb> u64</span><span style=color:#eceff4>))</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span style=color:#eceff4> (</span><span>_</span><span style=color:#eceff4>,</span><span> entry</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Entry</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>decode_from</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self.</span><span>file</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>file</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>seek</span><span style=color:#eceff4>(</span><span>SeekFrom</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Start</span><span style=color:#eceff4>(</span><span>current</span><span style=color:#eceff4>))</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        Ok</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Some</span><span style=color:#eceff4>(</span><span>entry</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://blog.ymgyt.io/entry/key_value_store_with_tokio/%5Bhttps://github.com/ymgyt/kvsd/blob/6b40c6a3edad0f416631f7ae66674fb5d7922cd7/src/server/tcp.rs#L444%5D>https://github.com/ymgyt/kvsd/blob/6b40c6a3edad0f416631f7ae66674fb5d7922cd7/src/core/table/table.rs#L135</a><p><code>tokio::io::AsyncSeek</code>ãŒã‚ã‚‹ã®ã§offsetã«seekã™ã‚‹å‡¦ç†ã‚‚åŒæœŸã¨åŒã˜ã‚ˆã†ã«æ›¸ã‘ã¾ã—ãŸã€‚<h2 id=matome><a aria-label="Anchor link for: matome" class=zola-anchor href=#matome>ã¾ã¨ã‚</a></h2><ul><li>ã¯ã˜ã‚ã¦tokioã‚’åˆ©ç”¨ã—ã‚ˆã†ã¨æ€ã£ãŸã¨ã<a href=https://github.com/tokio-rs/mini-redis rel=external>mini redis</a>ã®å®Ÿè£…ãŒéå¸¸ã«å‚è€ƒã«ãªã‚Šã¾ã—ãŸã€‚ã‚³ãƒ¡ãƒ³ãƒˆã‚‚ãŸãã•ã‚“ã‚ã‚Šè¦ªåˆ‡ã§ã—ãŸã€‚<li>tokioã‚’åˆ©ç”¨ã—ã¦remoteã¨é€šä¿¡ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹ã¾ã§ã‚’è‡ªåˆ†ã§ä½œã‚Œã¦æ¥½ã—ã‹ã£ãŸã§ã™<li>tokioã®APIã‚’åˆ©ç”¨ã—ã¦Goã«è¿‘ã„å½¢ã§concurrentãªå‡¦ç†æ›¸ã‘ãã†ã¨æ€ã„ã¾ã—ãŸã€‚ <ul><li><code>tokio::select!</code> (<code>select</code>)<li><code>tokio::spawn()</code> (goroutine)<li><code>sync::{mpsc,oneshot,broadcast}</code> (<code>chan</code>)</ul></ul><p>ã“ã®è¨˜äº‹ã‚’æ›¸ã„ã¦ã„ã‚‹æ—¥ã«tokio <a href=https://github.com/tokio-rs/tokio/releases/tag/tokio-1.0.0 rel=external><code>v1.0.0</code></a>ãŒreleaseã•ã‚Œã¾ã—ãŸã€‚<br> <a href=https://tokio.rs/blog/2020-12-tokio-1-0 rel=external>æœ€ä½ã§ã‚‚5å¹´ã¯ãƒ¡ãƒ³ãƒ†ã—ã¦ã„ãæ—¨</a>ã‚‚ç™ºè¡¨ã•ã‚Œã¦ãŠã‚Štokioã‚’åˆ©ç”¨ã—ã¯ã˜ã‚ã‚‹ã«ã¯ã¡ã‚‡ã†ã©ã„ã„æ™‚æœŸãªã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚</div></article></main><footer class=blog-footer><p>Â© 2026 <a href=https://blog.ymgyt.io> ymgyt </a> | Made with <a href=https://www.getzola.org rel=noopener target=_blank>Zola</a> | <a href=https://github.com/ymgyt/blog>Repository</a> | <a href=https://blog.ymgyt.io/atom.xml target=_blank title=rss> <svg viewbox="0 0 24 24" class=icon fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx=5 cy=19 r=1></circle></svg> </a></footer></div></div>