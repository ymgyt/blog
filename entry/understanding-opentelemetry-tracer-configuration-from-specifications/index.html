<!doctype html><html lang=ja><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1" name=viewport><link href=https://blog.ymgyt.io/favicon.ico rel=icon sizes=any><link href=https://blog.ymgyt.io/icon.svg rel=icon type=image/svg+xml><link href=https://blog.ymgyt.io/apple-touch-icon.png rel=apple-touch-icon><link href=https://blog.ymgyt.io/manifest.webmanifest rel=manifest><link href=https://blog.ymgyt.io/style.css rel=stylesheet><link href=https://blog.ymgyt.io/atom.xml rel=alternate title=Atom type=application/atom+xml><script src="https://www.googletagmanager.com/gtag/js?id=G-GTB0KMLN90" async></script><script>window.dataLayer = window.dataLayer || [];
	function gtag() {dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-GTB0KMLN90');</script><title>ğŸ”­ Rustã§OpenTelemetry: Tracerã®è¨­å®šã‚’ä»•æ§˜ã‹ã‚‰ç†è§£ã™ã‚‹ | Happy developing</title><meta content=Rustã«ãŠã‘ã‚‹OpenTelemetryã®å®Ÿè£…ã‚’è¦‹ãªãŒã‚‰ä»•æ§˜ã®ç†è§£ã‚’è©¦ã¿ã¾ã™ã€‚ä»Šå›ã¯Tracerã®è¨­å®šã«ã¤ã„ã¦ã€‚ name=description><meta content=summary name=twitter:card><meta content="@YAmaguchixt " name=twitter:site><meta content="ğŸ”­ Rustã§OpenTelemetry: Tracerã®è¨­å®šã‚’ä»•æ§˜ã‹ã‚‰ç†è§£ã™ã‚‹" name=twitter:title><meta content=Rustã«ãŠã‘ã‚‹OpenTelemetryã®å®Ÿè£…ã‚’è¦‹ãªãŒã‚‰ä»•æ§˜ã®ç†è§£ã‚’è©¦ã¿ã¾ã™ã€‚ä»Šå›ã¯Tracerã®è¨­å®šã«ã¤ã„ã¦ã€‚ name=twitter:description><meta content=https://blog.ymgyt.io/images/emoji/telescope.png name=twitter:image><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><body><div class=world><div class=content-container><header class=blog-header-container><div class=blog-logo><a href=https://blog.ymgyt.io>Happy developing</a></div><div class=blog-nav><nav><ul><li><a href=https://blog.ymgyt.io/entry/>Entries</a><li><a href=https://blog.ymgyt.io/tags/>Tags</a><li><a href=https://blog.ymgyt.io/about/>About</a><li><a href=https://github.com/ymgyt> <img alt=Github class=icon src=https://blog.ymgyt.io/images/icon/github.svg> </a><li><a href="https://twitter.com/YAmaguchixt "> <img alt=Twitter class=icon src=https://blog.ymgyt.io/images/icon/twitter.svg> </a></ul></nav></div></header><main class=blog-main><article><header class=entry-header><h1 class=entry-title>ğŸ”­ Rustã§OpenTelemetry: Tracerã®è¨­å®šã‚’ä»•æ§˜ã‹ã‚‰ç†è§£ã™ã‚‹</h1><div class=entry-meta><p class=entry-meta-item>ğŸ—“ 2023-07-18<p class=entry-meta-item>ğŸ· <span class=tag><a href=https://blog.ymgyt.io/tags/rust/>rust</a></span> <span class=tag><a href=https://blog.ymgyt.io/tags/opentelemetry/>opentelemetry</a></span></div></header><aside class=entry-toc><nav><ul class=entry-toc-toplevel-list><li><a href=https://blog.ymgyt.io/entry/understanding-opentelemetry-tracer-configuration-from-specifications/#qian-ti-noque-ren>å‰æã®ç¢ºèª</a><li><a href=https://blog.ymgyt.io/entry/understanding-opentelemetry-tracer-configuration-from-specifications/#ju-ti-de-nacodenogai-yao>å…·ä½“çš„ãªcodeã®æ¦‚è¦</a> <ul><li><a href=https://blog.ymgyt.io/entry/understanding-opentelemetry-tracer-configuration-from-specifications/#tracing-subscribernoshe-ding>tracing subscriberã®è¨­å®š</a><li><a href=https://blog.ymgyt.io/entry/understanding-opentelemetry-tracer-configuration-from-specifications/#tracernoshe-ding>Tracerã®è¨­å®š</a></ul><li><a href=https://blog.ymgyt.io/entry/understanding-opentelemetry-tracer-configuration-from-specifications/#cratejian-noguan-xi>crateé–“ã®é–¢ä¿‚</a><li><a href=https://blog.ymgyt.io/entry/understanding-opentelemetry-tracer-configuration-from-specifications/#tracenosheng-cheng-karaexportmadenoliu-re>Traceã®ç”Ÿæˆã‹ã‚‰exportã¾ã§ã®æµã‚Œ</a><li><a href=https://blog.ymgyt.io/entry/understanding-opentelemetry-tracer-configuration-from-specifications/#apitosdk>APIã¨SDK</a><li><a href=https://blog.ymgyt.io/entry/understanding-opentelemetry-tracer-configuration-from-specifications/#opentelemetry-api-trace-trace>opentelemetry_api::trace::Trace</a><li><a href=https://blog.ymgyt.io/entry/understanding-opentelemetry-tracer-configuration-from-specifications/#opentelemetry-otlpniyorutracernoshe-ding>opentelemetry_otlpã«ã‚ˆã‚‹Tracerã®è¨­å®š</a><li><a href=https://blog.ymgyt.io/entry/understanding-opentelemetry-tracer-configuration-from-specifications/#opentelemetry-sdk-tracenoge-zhong-struct>opentelemetry_sdk::traceã®å„ç¨®struct</a><li><a href=https://blog.ymgyt.io/entry/understanding-opentelemetry-tracer-configuration-from-specifications/#opentelemetry-sdk-trace-config>opentelemetry::sdk::trace::Config</a> <ul><li><a href=https://blog.ymgyt.io/entry/understanding-opentelemetry-tracer-configuration-from-specifications/#idgenetaror>IdGenetaror</a><li><a href=https://blog.ymgyt.io/entry/understanding-opentelemetry-tracer-configuration-from-specifications/#sampler>Sampler</a></ul><li><a href=https://blog.ymgyt.io/entry/understanding-opentelemetry-tracer-configuration-from-specifications/#resource>Resource</a> <ul><li><a href=https://blog.ymgyt.io/entry/understanding-opentelemetry-tracer-configuration-from-specifications/#schema-url>Schema URL</a></ul><li><a href=https://blog.ymgyt.io/entry/understanding-opentelemetry-tracer-configuration-from-specifications/#export>Export</a> <ul><li><a href=https://blog.ymgyt.io/entry/understanding-opentelemetry-tracer-configuration-from-specifications/#batchconfig>BatchConfig</a><li><a href=https://blog.ymgyt.io/entry/understanding-opentelemetry-tracer-configuration-from-specifications/#exporterconfig>ExporterConfig</a></ul><li><a href=https://blog.ymgyt.io/entry/understanding-opentelemetry-tracer-configuration-from-specifications/#matome>ã¾ã¨ã‚</a></ul></nav></aside><div class=entry-content><p>æœ¬è¨˜äº‹ã§ã¯ã€Rustã«ãŠã‘ã‚‹OpenTelemetry Tracerã®è¨­å®šã‚’OpenTelemetryã®ä»•æ§˜ã«ç…§ã‚‰ã—ã¦ç†è§£ã™ã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚<br> ä»•æ§˜ã‚’ç¢ºèªã—ãªãŒã‚‰ã€ã©ã†ã—ã¦å„ç¨®crateãŒç¾åœ¨ã®å‹ã‚„æ§‹æˆã«ãªã£ã¦ã„ã‚‹ã®ã‹ã‚’èª¬æ˜ã—ã¾ã™ã€‚<br> Rustç‰¹æœ‰ã®è©±ã¨OpenTelemetryå…±é€šã®è©±ãŒæœ€åˆã¯åˆ†ã‹ã‚Šã¥ã‚‰ã‹ã£ãŸã®ã§ã™ãŒã€å…±é€šã®æ¦‚å¿µã‚’ç†è§£ã§ãã‚Œã°ä»–è¨€èªã§ã‚‚åŒæ§˜ã«è¨­å®šã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚<h2 id=qian-ti-noque-ren><a aria-label="Anchor link for: qian-ti-noque-ren" class=zola-anchor href=#qian-ti-noque-ren>å‰æã®ç¢ºèª</a></h2><p>ã‚‚ã‚ã‚‚ã‚ã®å‰æã‚’ç¢ºèªã—ã¾ã™ã€‚<br> ã¾ãšã€traceã®ç”Ÿæˆã«ã¤ã„ã¦ã¯<a href=https://github.com/tokio-rs/tracing rel=external><code>tracing</code> crate</a>ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚ãã‚Œã«ä¼´ã„ã€tracingã¨opentelemetryã‚’é€£æºã•ã›ã‚‹ãŸã‚ã«ã€<a href=https://github.com/tokio-rs/tracing-opentelemetry rel=external><code>tracing-opentelemetry</code> crate</a>ã‚‚åˆ©ç”¨ã—ã¾ã™ã€‚<br> ãªãŠã€tracing-opentelemetryãªã®ã§ã™ãŒã€ä»¥å‰ã¯tokio-rs/tracingé…ä¸‹ã®workspace memberã¨ã—ã¦ç®¡ç†ã•ã‚Œã¦ã„ã¾ã—ãŸãŒã€<a href=https://github.com/tokio-rs/tracing/pull/2523 rel=external>ã“ã¡ã‚‰ã®PR</a>ã§ã€tokio-rs/tracing-opentelemetryã«ç§»ã•ã‚Œã¾ã—ãŸã€‚<p>æ¬¡ã«traceã®exportã¯<a href=https://github.com/open-telemetry/opentelemetry-rust/tree/main/opentelemetry-otlp rel=external><code>opentelemetry-otlp</code> crate</a>ã‚’åˆ©ç”¨ã—ã¦ã€gRPCã§remoteã«exportã—ã¾ã™ã€‚(åŸºæœ¬çš„ã«ã¯opentelemetry-collectorã«ãªã‚‹ã‹ã¨æ€ã„ã¾ã™)<br> Opentelemetry-collectorã‚„observability-backendã®ç«‹ã¡ä¸Šã’ã«ã¤ã„ã¦ã¯è©³ã—ãã¯è§¦ã‚Œã¾ã›ã‚“ã€‚<p>å¯¾è±¡ã¨ã™ã‚‹OpenTelemetryã®ä»•æ§˜ã¯<code>v1.23.0</code>ã§ã™ã€‚<br> ä»•æ§˜ã®å‚ç…§å…ƒã¨ã—ã¦ã¯ã€<a href=https://opentelemetry.io/docs/specs/ rel=external>å…¬å¼ã®website</a>ã¨<a href=https://github.com/open-telemetry/opentelemetry-specification/tree/v1.23.0/specification rel=external><code>opentelemetry-specification</code> repository</a>ãŒã‚ã‚Šã¾ã™ã€‚<br> versionã‚’å›ºå®šã—ãŸlinkã‚’è²¼ã‚Šã‚„ã™ã„ã®ã§ã€æœ¬è¨˜äº‹ã§ã¯repositoryã‚’å‚ç…§ã—ã¾ã™ã€‚<br> ä»•æ§˜ã®ç¯„å›²ã§ã™ãŒã€æ¦‚ã­ã€Traceã¨é–¢é€£ã™ã‚‹å…±é€šé …ç›®ã«ã¤ã„ã¦ã¿ã¦ã„ãã¾ã™ã€‚<p>ãã‚‚ãã‚‚ã€Opentelemetryã¨ã¯ã€ã¨ã„ã†è©±ã¯ä»¥å‰ã®<a href=https://blog.ymgyt.io/entry/starting_opentelemetry_with_rust/ rel=external>Rustã§OpenTelemetryã‚’ã¯ã˜ã‚ã‚ˆã†</a>ã®æ–¹ã«æ›¸ã„ãŸã®ã§ã‚ˆã‘ã‚Œã°èª­ã‚“ã§ã¿ã¦ãã ã•ã„ã€‚<h2 id=ju-ti-de-nacodenogai-yao><a aria-label="Anchor link for: ju-ti-de-nacodenogai-yao" class=zola-anchor href=#ju-ti-de-nacodenogai-yao>å…·ä½“çš„ãªcodeã®æ¦‚è¦</a></h2><p>ã¾ãšã¯æœ¬è¨˜äº‹ã§æ‰±ã†ã€traceã‚’exportã™ã‚‹ãŸã‚ã®è¨­å®šã‚’è¡Œã†codeã‚’ç¢ºèªã—ã¾ã™ã€‚ã®ã¡ã»ã©è©³ã—ãè¦‹ã¦ã„ãã®ã§ã€ã“ã“ã§ç†è§£ã§ããªãã¦ã‚‚å¤§ä¸ˆå¤«ã§ã™ã€‚<br> é–¢é€£ã™ã‚‹ä¾å­˜crateã¯ä»¥ä¸‹ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=toml><span class=giallo-l><span style=color:#eceff4>[</span><span>dependencies</span><span style=color:#eceff4>]</span></span>
<span class=giallo-l><span>opentelemetry</span><span style=color:#eceff4> = {</span><span> version</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>=0.19.0</span><span style=color:#eceff4>",</span><span> features</span><span style=color:#eceff4> = ["</span><span style=color:#a3be8c>rt-tokio</span><span style=color:#eceff4>"] }</span></span>
<span class=giallo-l><span>opentelemetry-otlp</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>=0.12.0</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span>opentelemetry-semantic-conventions</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>=0.11.0</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span>tracing</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>0.1.38</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span>tracing-opentelemetry</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>=0.19.0</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span>tracing-subscriber</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>0.3.17</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#616e88># ...</span></span></code></pre><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[tokio::main]</span></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> _guard</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> init_opentelemetry</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>    init_subscriber</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    // Run application ...</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã¾ãš<code>main.rs</code>ã§ã¯ã€2ã¤ã®ã“ã¨ã‚’è¡Œã„ã¾ã™ã€‚<ol><li>opentelemetryé–¢é€£ã®åˆæœŸåŒ–å‡¦ç†<li>tracing-subscriberã®è¨­å®š</ol><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#616e88>/// Guard to perform opentelemetry termination processing at drop time.</span></span>
<span class=giallo-l><span style=color:#5e81ac>#[must_use]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> OtelInitGuard</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Drop</span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> OtelInitGuard</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> drop</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span>        opentelemetry</span><span style=color:#81a1c1>::</span><span>global</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>shutdown_tracer_provider</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>pub fn</span><span style=color:#88c0d0> init_opentelemetry</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> OtelInitGuard</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>    // for context propagation.</span></span>
<span class=giallo-l><span>    opentelemetry</span><span style=color:#81a1c1>::</span><span>global</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>set_text_map_propagator</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>        opentelemetry</span><span style=color:#81a1c1>::</span><span>sdk</span><span style=color:#81a1c1>::</span><span>propagation</span><span style=color:#81a1c1>::</span><span>TraceContextPropagator</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>    );</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>    OtelInitGuard</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>init_opentelemetry()</code>ã§ã¯ã€opentelemetryé–¢é€£ã®åˆæœŸåŒ–å‡¦ç†ã‚’å®Ÿæ–½ã—ã€çµ‚äº†å‡¦ç†ã‚’dropæ™‚ã«è¡Œã†<code>OtelInitGuard</code>ã‚’è¿”ã—ã¾ã™ã€‚<br> ã“ã®å‹ã¯å¤–éƒ¨crateã®å‹ã§ã¯ãªãapplicationå´ã®å®Ÿè£…ã§ã™ã€‚<code>opentelemetry::global::set_text_map_propagator()</code>ã¯context propagationé–¢é€£ã®æº–å‚™ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚<br> Context propagationã«ã¤ã„ã¦ã¯åˆ¥ã®è¨˜äº‹ã§è©³ã—ãè§¦ã‚ŒãŸã„ã¨æ€ã„ã¾ã™ã€‚<br> ã“ã“ã§ã‚„ã‚ŠãŸã„ã®ã¯ã€applicationçµ‚äº†æ™‚ã«ã€<code>opentelemetry::global::shutdown_tracer_provider()</code>ãŒç¢ºå®Ÿã«å‘¼ã°ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§ã™ã€‚<h3 id=tracing-subscribernoshe-ding><a aria-label="Anchor link for: tracing-subscribernoshe-ding" class=zola-anchor href=#tracing-subscribernoshe-ding>tracing subscriberã®è¨­å®š</a></h3><p>æ¬¡ã«tracing subscriberã®è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> init_subscriber</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    use</span><span> tracing_subscriber</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span>filter</span><span style=color:#eceff4>,</span><span> fmt</span><span style=color:#eceff4>,</span><span> layer</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>SubscriberExt</span><span style=color:#eceff4>,</span><span> util</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>SubscriberInitExt</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> sampling_ratio</span><span style=color:#81a1c1> =</span><span> std</span><span style=color:#81a1c1>::</span><span>env</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>var</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>OTEL_SAMPLING_RATIO</span><span style=color:#eceff4>")</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>ok</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>and_then</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>env</span><span style=color:#81a1c1>|</span><span> env</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>parse</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>ok</span><span style=color:#eceff4>())</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>unwrap_or</span><span style=color:#eceff4>(</span><span style=color:#b48ead>1</span><span style=color:#eceff4>.</span><span style=color:#b48ead>0</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>    tracing_subscriber</span><span style=color:#81a1c1>::</span><span>registry</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Registry</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>with</span><span style=color:#eceff4>(</span><span>fmt</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>layer</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>with_ansi</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>true</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>with</span><span style=color:#eceff4>(</span><span>filter</span><span style=color:#81a1c1>::</span><span>LevelFilter</span><span style=color:#81a1c1>::</span><span>INFO</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>with</span><span style=color:#eceff4>(</span><span>tracing_opentelemetry</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>layer</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>with_tracer</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>tracer</span><span style=color:#eceff4>(</span><span>sampling_ratio</span><span style=color:#eceff4>)))</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>init</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã“ã“ã§ã¯ã€tracing subscriberã‚’è¨­å®šã—ã€<code>tracing_opentelemetry::OpenTelemetryLayer</code>ã‚’è¨­å®šã—ã¾ã™ã€‚<br> tracing subscriberã‚„layerã«ã¤ã„ã¦ã¯<a href=https://blog.ymgyt.io/entry/how-tracing-and-tracing-subscriber-write-events/ rel=external>tracing/tracing-subscirberã§ãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã‚‹ä»•çµ„ã¿ã‚’ç†è§£ã™ã‚‹</a>ã§æ›¸ã„ãŸã®ã§ã“ã“ã§ã¯ç‰¹ã«èª¬æ˜ã—ã¾ã›ã‚“ã€‚<br> æ¦‚è¦ã¨ã—ã¦ã¯ã€<code>tracing::info!()</code>ã™ã‚‹ã¨ã€ãã“ã§ç”Ÿæˆã•ã‚ŒãŸlog(event)ãŒ<code>OpenTelemetryLayer</code>ã«æ¸¡ã•ã‚Œã€OpenTelemetryã®ä»•æ§˜ã«å®šã‚ã‚‰ã‚ŒãŸtraceã«å¤‰æ›ã•ã‚ŒãŸã®ã¡ã«ã€exportã•ã‚Œã‚‹ã¨ã„ã£ãŸæµã‚Œã§ã™ã€‚<p>è¦ç‚¹ã¨ã—ã¦ã¯ã€tracing/tracing-subscriberã®ä»•çµ„ã¿ã®ãŠã‹ã’ã§ã€ã“ã“ã§è¦‹ã¦ã„ã‚‹applicationåˆæœŸåŒ–æ™‚ä»¥å¤–ã§ã¯ã€traceãŒopentelemetryã®ä»•çµ„ã¿ã§å‡¦ç†ã•ã‚Œã‚‹ã¨ã„ã£ãŸã“ã¨ã‚’æ„è­˜ã—ãªãã¦ã‚ˆããªã£ã¦ã„ã‚‹ã¨ã„ã†ã“ã¨ã§ã™ã€‚<br> é€†ã«ã„ã†ã¨ã€opentelemetryã«ãŠã‘ã‚‹traceã®ãƒ‡ãƒ¼ã‚¿ãŒå…·ä½“çš„ã«ã©ã†ãªã‚‹ã‹ã¯ã€<code>tracing::info!()</code>ã¨ã„ã£ãŸã€tracing apiã¨tracing_opentelemetryã«ã‚ˆã‚‹å¤‰æ›å‡¦ç†æ¬¡ç¬¬ã¨ãªã‚Šã¾ã™ã€‚<br> ã‚‚ã£ã¨ã‚‚ã€tracing/tracing_opentelemetryã«ã‚ˆã‚‹opentelemetryã®æŠ½è±¡åŒ–ã¯å¾¹åº•ã•ã‚Œã¦ã„ã‚‹ã‚ã‘ã§ã¯ãªãã€ä»–ã‚µãƒ¼ãƒ“ã‚¹ã‚’networkè¶Šã—ã«å‘¼ã‚“ã å ´åˆã«ã‚‚traceã‚’é€£æºã•ã›ã‚‹context propagationç­‰ã®ä»•çµ„ã¿ã‚’åˆ©ç”¨ã™ã‚‹ä¸Šã§ã¯ã€opentelemetryã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ã“ã¨ã‚’æ„è­˜ã™ã‚‹å¿…è¦ãŒã§ã¦ãã¾ã™ã€‚<h3 id=tracernoshe-ding><a aria-label="Anchor link for: tracernoshe-ding" class=zola-anchor href=#tracernoshe-ding>Tracerã®è¨­å®š</a></h3><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> tracer</span><span style=color:#eceff4>(</span><span>sampling_ratio</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> f64</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span> opentelemetry</span><span style=color:#81a1c1>::</span><span>sdk</span><span style=color:#81a1c1>::</span><span>trace</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Tracer</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    use</span><span> opentelemetry</span><span style=color:#81a1c1>::</span><span>sdk</span><span style=color:#81a1c1>::</span><span>trace</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Sampler</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    use</span><span> opentelemetry_otlp</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>WithExportConfig</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>    opentelemetry_otlp</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new_pipeline</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>tracing</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>with_trace_config</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>            opentelemetry</span><span style=color:#81a1c1>::</span><span>sdk</span><span style=color:#81a1c1>::</span><span>trace</span><span style=color:#81a1c1>::</span><span>Config</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>                .</span><span style=color:#88c0d0>with_sampler</span><span style=color:#eceff4>(</span><span>Sampler</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>ParentBased</span><span style=color:#eceff4>(</span><span>Box</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>Sampler</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>TraceIdRatioBased</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>                    sampling_ratio</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>                ))))</span></span>
<span class=giallo-l><span style=color:#81a1c1>                .</span><span style=color:#88c0d0>with_id_generator</span><span style=color:#eceff4>(</span><span>opentelemetry</span><span style=color:#81a1c1>::</span><span>sdk</span><span style=color:#81a1c1>::</span><span>trace</span><span style=color:#81a1c1>::</span><span>XrayIdGenerator</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>())</span></span>
<span class=giallo-l><span style=color:#81a1c1>                .</span><span style=color:#88c0d0>with_resource</span><span style=color:#eceff4>(</span><span>opentelemetry</span><span style=color:#81a1c1>::</span><span>sdk</span><span style=color:#81a1c1>::</span><span>Resource</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_schema_url</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>                    [</span></span>
<span class=giallo-l><span>                        opentelemetry</span><span style=color:#81a1c1>::</span><span>KeyValue</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>                            opentelemetry_semantic_conventions</span><span style=color:#81a1c1>::</span><span>resource</span><span style=color:#81a1c1>::</span><span>SERVICE_NAME</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>                            env!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>CARGO_PKG_NAME</span><span style=color:#eceff4>"),</span></span>
<span class=giallo-l><span style=color:#eceff4>                        ),</span></span>
<span class=giallo-l><span>                        opentelemetry</span><span style=color:#81a1c1>::</span><span>KeyValue</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>                            opentelemetry_semantic_conventions</span><span style=color:#81a1c1>::</span><span>resource</span><span style=color:#81a1c1>::</span><span>SERVICE_VERSION</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>                            env!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>CARGO_PKG_VERSION</span><span style=color:#eceff4>"),</span></span>
<span class=giallo-l><span style=color:#eceff4>                        ),</span></span>
<span class=giallo-l><span style=color:#eceff4>                    ],</span></span>
<span class=giallo-l><span style=color:#eceff4>                    "</span><span style=color:#a3be8c>https://opentelemetry.io/schemas/1.20.0</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>                )),</span></span>
<span class=giallo-l><span style=color:#eceff4>        )</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>with_exporter</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>            opentelemetry_otlp</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new_exporter</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>                .</span><span style=color:#88c0d0>tonic</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>                .</span><span style=color:#88c0d0>with_endpoint</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>http://localhost:4317</span><span style=color:#eceff4>"),</span></span>
<span class=giallo-l><span style=color:#eceff4>        )</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>install_batch</span><span style=color:#eceff4>(</span><span>opentelemetry</span><span style=color:#81a1c1>::</span><span>sdk</span><span style=color:#81a1c1>::</span><span>runtime</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Tokio</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã“ã“ãŒãƒ¡ã‚¤ãƒ³ã¨ãªã‚‹ã€Tracerã®è¨­å®šã§ã™ã€‚<br> ã©ã®å‹ãŒã©ã®crateã‹ã‚‰æ¥ã¦ã„ã‚‹ã‹ã‚ã‹ã‚Šã‚„ã™ãã™ã‚‹ãŸã‚ã«ã€é•·ããªã‚Šã¾ã™ãŒã€crateã‹ã‚‰æ›¸ã„ã¦ã„ã¾ã™ã€‚ ã¾ãšã€ä»¥ä¸‹ã®crateãŒå‡ºã¦ãã¾ã™ã€‚<ul><li><code>opentelemetry</code><li><code>opentelemetry_otlp</code><li><code>opentelemetry_semantic_convensions</code></ul><p><code>opentelemetry</code> crateã¯<code>opentelemetry_api</code>ã¨<code>opentelemetry_sdk</code>ã‚’re-exportã—ã¦ã„ã‚‹ã ã‘ã®crateã§ã™ã€‚<p>ã“ã‚Œã‚‰ã®crateã¯ãã‚Œãã‚Œå¯¾å¿œã™ã‚‹ä»•æ§˜ã‚„ãã®å®Ÿè£…ã«å¯¾å¿œã—ã¦ã„ã‚‹ã®ã§ã€ã“ã®è¨­å®šé …ç›®ã®ä»•æ§˜ã‚’ç†è§£ã™ã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚<h2 id=cratejian-noguan-xi><a aria-label="Anchor link for: cratejian-noguan-xi" class=zola-anchor href=#cratejian-noguan-xi>crateé–“ã®é–¢ä¿‚</a></h2><p>ã¾ãšã¯ã“ã‚Œã‚‰ã®crateé–“ã®é–¢ä¿‚ã‚’æ•´ç†ã—ã¾ã™ã€‚<figure><div class=fig-images-row><img , alt src=images/opentelemetry_crates_overview.svg></div><figcaption>crateé–“ã®é–¢ä¿‚</figcaption></figure><p>ã¾ãšApplicationã¯tracingã®apiã‚’åˆ©ç”¨ã—ã¦è¨ˆè£…ã—ã¾ã™ã€‚<br> å…·ä½“çš„ã«ã¯ã€<code>tracing::instrument</code>ã‚„ã€<code>info_span!()</code>, <code>info!()</code>ç­‰ã‚’çµ„ã¿è¾¼ã¿ã¾ã™ã€‚<br> ApplicationãŒå®Ÿè¡Œã•ã‚Œã‚‹ã¨tracingã®æƒ…å ±ã¯tracing_subscriberã«ã‚ˆã£ã¦å‡¦ç†ã•ã‚Œã‚‹ã®ã§ã€subscriberã®å‡¦ç†ã«opentelemetryã‚’çµ„ã¿è¾¼ã‚€ãŸã‚ã«tracing_opentelemetryã‚’åˆ©ç”¨ã—ã¾ã™ã€‚<br> tracing_opentelemetryã¯opentelemetry_apiã«ä¾å­˜ã—ã¦ãŠã‚Šã€å®Ÿè¡Œæ™‚ã«ãã®å®Ÿè£…ã‚’injectã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚<br> opentelemetry_sdkãŒãã®å®Ÿè£…ã‚’æä¾›ã—ã¦ãã‚Œã¦ã„ã‚‹ã®ã§ã€ãã‚Œã‚’åˆ©ç”¨ã™ã‚‹ã®ã§ã™ãŒã€opentelemetry_sdkã¯pluginæ§‹é€ ã«ãªã£ã¦ãŠã‚Šã€protocolä¾å­˜ãªç®‡æ‰€ã¯sdkã«ã¯çµ„ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<br> ä»Šå›ã¯gRPCã‚’åˆ©ç”¨ã—ã¦traceã‚’exportã™ã‚‹ã®ã§ã™ãŒã€ãã®gRPCé–¢é€£ã®å®Ÿè£…ã¯opentelemetry_otlpã«ã‚ˆã£ã¦æä¾›ã•ã‚Œã¾ã™ã€‚<br> ãã—ã¦ã€opentelemetry_otlpã¯opentelemetry_sdkã®è¨­å®šã‚’è¡Œã†helperé–¢æ•°ã‚’å…¬é–‹ã—ã¦ãã‚Œã¦ã„ã‚‹ã®ã§ã€applicationã§ã¯ãã‚Œã‚’åˆ©ç”¨ã—ã¾ã™ã€‚<p>æ¦‚ã­ã“ã®ã‚ˆã†ãªå½¹å‰²åˆ†æ‹…ã¨ãªã£ã¦ã„ã¾ã™ã€‚<h2 id=tracenosheng-cheng-karaexportmadenoliu-re><a aria-label="Anchor link for: tracenosheng-cheng-karaexportmadenoliu-re" class=zola-anchor href=#tracenosheng-cheng-karaexportmadenoliu-re>Traceã®ç”Ÿæˆã‹ã‚‰exportã¾ã§ã®æµã‚Œ</a></h2><p>ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ¢ãƒ‡ãƒ«ã¨ã—ã¦ã€traceãŒç”Ÿæˆã•ã‚Œã¦ã‹ã‚‰exportã•ã‚Œã‚‹ã¾ã§ã®æµã‚Œã‚’ç¢ºèªã—ã¾ã™ã€‚<figure><div class=fig-images-row><img , alt src=images/opentelemetry_trace_flow_overview.svg></div><figcaption>traceãŒexportã•ã‚Œã‚‹æ¦‚è¦</figcaption></figure><p>ãã‚Œãã‚Œã®componentã®è©³ç´°ã¯ã®ã¡ã»ã©ç¢ºèªã—ã¾ã™ãŒã€å…¨ä½“ã®æµã‚Œã¨ã—ã¦ã¯ä¸Šè¨˜ã®ã‚ˆã†ã«ãªã£ã¦ãŠã‚Šã¾ã™ã€‚<p>spanãŒdropã•ã‚ŒãŸã‚Šã€<code>#[tracing::instrument]</code>ãŒä»˜ä¸ã•ã‚ŒãŸé–¢æ•°ã‚’æŠœã‘ã‚‹ã¨ã€tracing apiã«ã‚ˆã£ã¦ã€subsriberã®<code>on_close()</code>ãŒå‘¼ã°ã‚Œã¾ã™ã€‚ subscriberã¯layeredæ§‹æˆã«ãªã£ã¦ã„ã‚‹ã®ã§ã€å„layerã®spançµ‚äº†å‡¦ç†ãŒèµ°ã‚Šã¾ã™ã€‚<code>OpenTelemetryLayer</code>ã¯ã“ã“ã§ã€tracingã®spanæƒ…å ±ã‚’opentelemetryã®spanã«å¤‰æ›ã‚’è¡Œã„ã€<code>TracerProvider</code>ã‚’çµŒç”±ã—ã¦ã€<code>SpanProcessor</code>ã«exportã™ã‚‹spanã‚’æ¸¡ã—ã¾ã™ã€‚<br> <code>SpanExporter</code>ã¯batchã‚„timeout,retryå‡¦ç†ç­‰ã‚’è¡Œã„ã€serializeã‚„protocolã®å‡¦ç†ã‚’æ‹…ã†<code>SpanExporter</code>ãŒnetworkè¶Šã—ã®opentelemetry collectorã«spanã‚’exportã—ã¾ã™ã€‚<br> <code>OpenTelemetryLayer</code>ã‹ã‚‰å…ˆã®<code>Tracer</code>ã«ã¤ã„ã¦ã¯rustã®ç‹¬è‡ªå®Ÿè£…ã§ã¯ãªãã€<strong>opentelemetryã®ä»•æ§˜ã«å®šã‚ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚</strong><br> ã“ã®SDKãŒã©ã®ã‚ˆã†ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã‹ã®ä»•æ§˜ã¨ã„ã†ã®ãŒopentelemetry projectã®ç‰¹å¾´ã ã¨æ€ã£ã¦ã„ã¾ã™ã€‚<h2 id=apitosdk><a aria-label="Anchor link for: apitosdk" class=zola-anchor href=#apitosdk>APIã¨SDK</a></h2><p>OpenTelemetryã®ä»•æ§˜ã«ã¯APIã¨SDKã¨ã„ã†ç”¨èªãŒã‚ˆãã§ã¦ãã¾ã™ã€‚<br> ã©ã¡ã‚‰ã‚‚packageã§ã™ã€‚<a href=https://github.com/open-telemetry/opentelemetry-specification/blob/v1.23.0/specification/glossary.md#packages rel=external>packageã‚‚otelç”¨èª</a>ã§å„ç¨®ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã®libraryã‚’æŠ½è±¡åŒ–ã—ãŸã‚‚ã®ã§ã™ã€‚<br> ã§ã™ã®ã§ã€rustã«ã‚‚ã€opentelemetry_apiã¨opentelemetry_sdk crateãŒã‚ã‚Šã¾ã™ã€‚<br> ãŸã ã€opentelemetry_apiã¨opentelemetry_sdkã¯åŸºæœ¬çš„ã«åŒä¸€versionã§åˆ©ç”¨ã•ã‚Œã‚‹ã“ã¨ãŒæƒ³å®šã•ã‚Œã¦ã„ã‚‹ã®ã§ã€opentelemetry crateãŒä¸¡è€…ã‚’re-exportã—ã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>pub use</span><span> opentelemetry_api</span><span style=color:#81a1c1>::*</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub use</span><span> opentelemetry_sdk</span><span style=color:#81a1c1>::</span><span>runtime</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub mod</span><span> sdk</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub use</span><span> opentelemetry_sdk</span><span style=color:#81a1c1>::*</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/open-telemetry/opentelemetry-rust/blob/879d6ff9d251db158da7a5720ff903fa6cb7c1e2/opentelemetry/src/lib.rs#L225C1-L244C2 rel=external>source</a><p>SDKã¯<code>opentelemetry::sdk</code>ã§å‚ç…§ã§ãã¾ã™ãŒã€APIã¯<code>opentelemetry</code>ç›´ä¸‹ãªã®ã§ã€æœ€åˆã¯æ··ä¹±ã—ã¦ã—ã¾ã„ã¾ã—ãŸã€‚(ã‹ã¨ã„ã£ã¦ã€<code>opentelemetry::api</code>ã«ã™ã‚‹ã¨toplevelã«ãªã«ã‚‚itemãŒãªããªã£ã¦ã—ã¾ã†ã®ã§çµæœçš„ã«ä»Šã®çŠ¶æ…‹ãŒè‰¯ã„ã¨ã¯æ€ã„ã¾ã™)<p>æ¬¡ã«APIã¨SDKã®é–¢ä¿‚ãªã®ã§ã™ãŒã€å…¬å¼ã®ä»¥ä¸‹ã®å›³ãŒã‚ã‹ã‚Šã‚„ã™ã„ã§ã™ã€‚</p><a href=https://github.com/open-telemetry/opentelemetry-specification/blob/v1.23.0/internal/img/long-term-support.png> <figure><div class=fig-images-row><img , alt src=images/opentelemetry-long-term-support.png></div></figure> </a><p>å›³è‡ªä½“ã¯ã€Opentelemetryã®å„ç¨®packageã®major versionã®supportæœŸé–“ã«ã¤ã„ã¦ãªã®ã§ã™ãŒã€ç™»å ´äººç‰©ã¨packageã®é–¢ä¿‚ãŒã‚ã‹ã‚Šã‚„ã™ã„ã®ã§å¼•ç”¨ã—ã¾ã—ãŸã€‚<br> ã¾ãšOpenTelemetryã«é–¢ã‚ã‚‹é–‹ç™ºè€…ã¯ä»¥ä¸‹ã®3ã¤ã®roleã«åˆ†é¡ã•ã‚Œã¾ã™ã€‚<ul><li>Application Owner<li>Instrumentation Author<li>Plugin Author</ul><p>ã¾ãšApplication Ownerã§ã™ãŒã€ãã®ã¾ã¾applicationã®maintainer(é–‹ç™ºè€…)ã§ã™ã€‚SDKã‚’è¨­å®šã™ã‚‹è²¬å‹™ã‚’æŒã¡ã¾ã™ã€‚<br> Instrumentation Authorã¯APIã‚’åˆ©ç”¨ã—ã¦ã€traceã‚„metricsã‚’è¨­å®šã™ã‚‹äººã‚’æŒ‡ã—ã¾ã™ã€‚library(package)ã«OpenTelemetryã‚’çµ„ã¿è¾¼ã‚“ã§ã„ã‚‹libraryã®maintainerã‚„application ownerã‚‚instrumentation authorã«å«ã¾ã‚Œã¾ã™ã€‚<br> Plugin Authorã¯SDKã®pluginã®maintainerã§ã™ã€‚æœ¬è¨˜äº‹ã§ã„ã†ã¨ã€opentelemetry_otlpãŒpluginã«ã‚ãŸã‚Šã¾ã™ã€‚<p>Application Ownerã‹ã‚‰ã€SDKã®Constructorã¨Pluginã®Constructorã«çŸ¢å°ãŒä¼¸ã³ã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span>opentelemetry_otlp</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new_pipeline</span><span style=color:#eceff4>()</span><span style=color:#616e88> // ğŸ‘ˆ Plugin Constructor</span></span>
<span class=giallo-l><span style=color:#81a1c1>    .</span><span style=color:#88c0d0>tracing</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>    .</span><span style=color:#88c0d0>with_trace_config</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>        opentelemetry</span><span style=color:#81a1c1>::</span><span>sdk</span><span style=color:#81a1c1>::</span><span>trace</span><span style=color:#81a1c1>::</span><span>Config</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>()</span><span style=color:#616e88> // ğŸ‘ˆ SDK Constructor</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span></code></pre><p>Plugin Authorã‹ã‚‰SDKã®Plugin Interfaceã«çŸ¢å°ãŒä¼¸ã³ã¦ã„ã¾ã™ãŒã€ã“ã‚Œã¯PluginãŒSDKã®traitã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ã¨ã„ã†ã“ã¨ã§ã™ã€‚å…·ä½“ä¾‹ã¯ã®ã¡ã»ã©è¦‹ã¦ã„ãã¾ã™ã€‚<br> Instrumentation Authorã‹ã‚‰APIã¸ä¼¸ã³ã¦ã„ã‚‹çŸ¢å°ãã®ã¾ã¾ã¯APIã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ã“ã¨ã‚’æŒ‡ã—ã¦ã„ã¾ã™ã€‚<p>ã¾ãŸã€APIãŒSDKã‚’wrapã—ã¦ã„ã‚‹ã‚ˆã†ãªçµµã«ãªã£ã¦ã„ã‚‹ã¨ã“ã‚ã¯APIã®å®Ÿè£…ã¯SDKã¸ã®delegateã«ãªã£ã¦ãŠã‚Šã€åˆæœŸçŠ¶æ…‹ã ã¨ãªã«ã‚‚ã—ãªã„å®Ÿè£…(Noop)ãŒåˆ©ç”¨ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚<br> ã“ã®ç‚¹ã‚‚å…¬å¼ã«ã‚ã‹ã‚Šã‚„ã™ã„å›³ãŒã‚ã‚‹ã®ã§å¼•ç”¨ã—ã¾ã™ã€‚</p><a href=https://github.com/open-telemetry/opentelemetry-specification/blob/v1.23.0/internal/img/library-design.png> <figure><div class=fig-images-row><img , alt src=images/opentelemetry-library-design.png></div></figure> </a><p>ä¾‹ãˆã°ã€åˆæœŸçŠ¶æ…‹ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«<code>NoopTracerProvider</code>ãŒè¿”ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ãŸã‚Šã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#616e88>/// The global `Tracer` provider singleton.</span></span>
<span class=giallo-l><span style=color:#81a1c1>static</span><span> GLOBAL_TRACER_PROVIDER</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Lazy</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>RwLock</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>GlobalTracerProvider</span><span style=color:#eceff4>>></span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Lazy</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>||</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    RwLock</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>GlobalTracerProvider</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>        trace</span><span style=color:#81a1c1>::</span><span>noop</span><span style=color:#81a1c1>::</span><span>NoopTracerProvider</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>    ))</span></span>
<span class=giallo-l><span style=color:#eceff4>});</span></span></code></pre><p><a href=https://github.com/open-telemetry/opentelemetry-rust/blob/34c73323238738e79ef353ac0e64b2a85fc59128/opentelemetry-api/src/global/trace.rs#L357 rel=external>opentelemetry_api::global::trace</a><br> ã“ã®noopå®Ÿè£…ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹å‡¦ç†ã¯SDKã®åˆæœŸåŒ–å‡¦ç†ã«ã‚ˆã£ã¦è¡Œãªã‚ã‚Œã¾ã™ã€‚<p>APIã¨SDKã®é–¢ä¿‚ã®æ¦‚è¦ã‚’èª¬æ˜ã—ãŸã®ã§ã€æ¬¡ã‹ã‚‰ã¯ã„ã‚ˆã„ã‚ˆcodeã‚’è¦‹ã¦ã„ãã¾ã™ã€‚<h2 id=opentelemetry-api-trace-trace><a aria-label="Anchor link for: opentelemetry-api-trace-trace" class=zola-anchor href=#opentelemetry-api-trace-trace><code>opentelemetry_api::trace::Trace</code></a></h2><p>ApplicationãŒå®Ÿè¡Œã™ã‚‹OpenTelemetryé–¢é€£ã®åˆæœŸåŒ–å‡¦ç†ã®ã‚´ãƒ¼ãƒ«ã¯<code>tracing_opentelemetry::layer().with_tracer()</code>ã‚’åˆ©ç”¨ã—ã¦ã€tracing subscriberã«<code>tracing_opentelemetry::OpenTelemetryLayer</code>ã‚’æ¸¡ã™ã“ã¨ã§ã™ã€‚ ãã—ã¦ã€ãã®constructå‡¦ç†ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«trait boundã¨ã—ã¦ã€<code>opentelemetry_api::trace::Trace</code>ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã™ã€‚(<code>PreSampledTracer</code>ã®èª¬æ˜ã¯å‰²æ„›)<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> opentelemetry</span><span style=color:#81a1c1>::</span><span>trace </span><span style=color:#81a1c1>as</span><span> otel</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> T</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> OpenTelemetryLayer</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> T</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    S</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Subscriber</span><span style=color:#81a1c1> + for</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>span</span><span style=color:#eceff4>></span><span style=color:#8fbcbb> LookupSpan</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>span</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    T</span><span style=color:#81a1c1>:</span><span> otel</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Tracer</span><span style=color:#81a1c1> +</span><span style=color:#8fbcbb> PreSampledTracer</span><span style=color:#81a1c1> +</span><span style=color:#eceff4> '</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> with_tracer</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Tracer</span><span style=color:#eceff4>>(</span><span style=color:#81a1c1>self</span><span style=color:#eceff4>,</span><span> tracer</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Tracer</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> OpenTelemetryLayer</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>S</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Tracer</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#81a1c1>    where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Tracer</span><span style=color:#81a1c1>:</span><span> otel</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Tracer</span><span style=color:#81a1c1> +</span><span style=color:#8fbcbb> PreSampledTracer</span><span style=color:#81a1c1> +</span><span style=color:#eceff4> '</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    {</span><span style=color:#616e88> /* ... */</span><span style=color:#eceff4> }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/tokio-rs/tracing-opentelemetry/blob/42e986929080a5f1f245876c1aaa82ce9a7d85de/src/layer.rs#L467 rel=external>tracing_opentelemetry::layer</a><p>ã“ã®<code>opentelemetry::trace::Trace</code> traitã¯ä»•æ§˜ã§å®šç¾©ã•ã‚ŒãŸã‚‚ã®ã®ã€rustã«ãŠã‘ã‚‹å®Ÿè£…ã¨ãªã£ã¦ã„ã¾ã™ã€‚<br> <a href=https://github.com/open-telemetry/opentelemetry-specification/blob/v1.23.0/specification/trace/api.md#tracer rel=external>ä»•æ§˜</a>ã§ã¯<blockquote><p>The tracer is responsible for creating Spans. Note that Tracers should usually not be responsible for configuration. This should be the responsibility of the TracerProvider instead.</blockquote><p>Tracerã®è²¬å‹™ã¯Spanã®ç”Ÿæˆã§ã‚ã‚Šã€è¨­å®šã«é–¢ã—ã¦ã¯TracerProviderãŒæ‹…ã†ã¨ã‚ã‚Šã¾ã™ã€‚<br> OpenTelemetryã«ãŠã‘ã‚‹traceã¯å®Ÿä½“ã¨ã—ã¦ã¯Spanã®treeãªã®ã§ã€<code>OpenTelemetryLayer</code>ãŒSpanã®ç”Ÿæˆã®ã¿ã®è²¬å‹™ã‚’ã‚‚ã¤Tracerã‚’è¦æ±‚ã™ã‚‹ã®ã¯è‡ªç„¶ã«æ€ãˆã¾ã™ã€‚<p>ãã—ã¦ã€<a href=https://github.com/open-telemetry/opentelemetry-rust/blob/34c73323238738e79ef353ac0e64b2a85fc59128/opentelemetry-sdk/src/trace/tracer.rs#L125C1-L125C45 rel=external>SDKã®Tracerã¯APIã®Tracer traitã‚’impl</a>ã—ã¦ã„ã¾ã™ã€‚<br> ãªã®ã§ã€ä»Šå›ã®ä¾‹ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«SDKã®Tracerã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> tracer</span><span style=color:#eceff4>(</span><span>sampling_ratio</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> f64</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span> opentelemetry</span><span style=color:#81a1c1>::</span><span>sdk</span><span style=color:#81a1c1>::</span><span>trace</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Tracer</span><span style=color:#eceff4> {</span><span style=color:#616e88> /* ...*/</span><span style=color:#eceff4> }</span></span></code></pre><h2 id=opentelemetry-otlpniyorutracernoshe-ding><a aria-label="Anchor link for: opentelemetry-otlpniyorutracernoshe-ding" class=zola-anchor href=#opentelemetry-otlpniyorutracernoshe-ding><code>opentelemetry_otlp</code>ã«ã‚ˆã‚‹Tracerã®è¨­å®š</a></h2><p>ã¨ã„ã†ã“ã¨ã§ã€SDKã®Tracerã‚’constructã™ã‚‹ã“ã¨ãŒã‚´ãƒ¼ãƒ«ã¨ã‚ã‹ã‚Šã¾ã—ãŸã€‚<br> ã•ãã»ã©APIã¨SDKã®é–¢ä¿‚ã§è¿°ã¹ãŸã‚ˆã†ã«SDKã‚’è¨­å®šã—ã¦constructã™ã‚‹å‡¦ç†ã¯SDKã®PluginãŒæä¾›ã—ã¦ãã‚Œã‚‹ã®ãŒOpenTelemetryã®designã®ã‚ˆã†ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> tracer</span><span style=color:#eceff4>(</span><span>sampling_ratio</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> f64</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span> opentelemetry</span><span style=color:#81a1c1>::</span><span>sdk</span><span style=color:#81a1c1>::</span><span>trace</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Tracer</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    opentelemetry_otlp</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new_pipeline</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>tracing</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>with_trace_config</span><span style=color:#eceff4>(</span><span style=color:#616e88> /*...*/</span><span style=color:#eceff4> )</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>with_batch_config</span><span style=color:#eceff4>(</span><span style=color:#616e88> /*...*/</span><span style=color:#eceff4> )</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>with_exporter</span><span style=color:#eceff4>(</span><span style=color:#616e88> /*...*/</span><span style=color:#eceff4> )</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>install_batch</span><span style=color:#eceff4>(</span><span>opentelemetry</span><span style=color:#81a1c1>::</span><span>sdk</span><span style=color:#81a1c1>::</span><span>runtime</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Tokio</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>opentelemetry_otlp</code>ã‚‚è¨­å®šã‚’è¡Œã£ãŸå¾Œ<code>install_batch()</code>ã‚’å‘¼ã¶ã¨ã€<code>Result&lt;sdk::trace::Tracer,_></code>ã‚’è¿”ã™ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚<br> ã“ã“ã§ã€æœ€å¾Œã®constructå‡¦ç†ãŒ<code>build()</code>ã§ã¯ãªãã€installã¨ã„ã†ã©ã“ã¨ãªãå‰¯ä½œç”¨ã‚’æ„Ÿã˜ã•ã›ã‚‹å‘½åã«ãªã£ã¦ã„ã‚‹ã®ã¯å‰¯ä½œç”¨ãŒã‚ã‚‹ã‹ã‚‰ã§ã™ã€‚<p><a href=https://github.com/open-telemetry/opentelemetry-specification/blob/71813887597d18e3535dd56d2a18ecae7299daad/specification/trace/api.md#tracerprovider rel=external>APIã®TracerProviderã«é–¢ã™ã‚‹ä»•æ§˜</a>ã§ã¯<blockquote><p>Normally, the TracerProvider is expected to be accessed from a central place. Thus, the API SHOULD provide a way to set/register and access a global default TracerProvider.</blockquote><p>ã¨ã€APIã¯defaultã®TracerProviderã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’globalå¤‰æ•°ã§æä¾›ã™ã¹ãã¨ã•ã‚Œã¦ã„ã¾ã™ã€‚<br> ã“ã‚Œã‚’ã†ã‘ã¦ä¸Šè¨˜ã®å‡¦ç†ã®ä¸­ã§ã€SDK Tracerç”Ÿæˆã®éš›ã«ä½œæˆã—ãŸTracerProviderã‚’<a href=https://github.com/open-telemetry/opentelemetry-rust/blob/34c73323238738e79ef353ac0e64b2a85fc59128/opentelemetry-otlp/src/span.rs#L202 rel=external>globalå¤‰æ•°ã«ã‚»ãƒƒãƒˆã™ã‚‹å‡¦ç†</a>ãŒã‚ã‚Šã¾ã™ã€‚<h2 id=opentelemetry-sdk-tracenoge-zhong-struct><a aria-label="Anchor link for: opentelemetry-sdk-tracenoge-zhong-struct" class=zola-anchor href=#opentelemetry-sdk-tracenoge-zhong-struct><code>opentelemetry_sdk::trace</code>ã®å„ç¨®struct</a></h2><p>å„ç¨®è¨­å®šã®è©³ç´°ã‚’ç¢ºèªã™ã‚‹å‰ã«traceã®exportæ™‚ã«ç™»å ´ã™ã‚‹structã®æ¦‚è¦ã‚’æŠŠæ¡ã—ã¦ãŠãã¾ã™ã€‚<figure><div class=fig-images-row><img , alt src=images/opentelemetry_sdk_trace_crate_overview.svg></div><figcaption>opentelemetry_sdk::traceã®structã®æ¦‚è¦</figcaption></figure><p>æ¦‚ã­ä¸Šè¨˜ã®structãŒã€trace(span)ã®ç”Ÿæˆã‹ã‚‰exportã«é–¢ä¸ã—ã¾ã™ã€‚<br> ã“ã‚Œã‹ã‚‰ã¿ã¦ã„ãè¨­å®šã¯ã“ã‚Œã‚‰ã®componentã«é–¢ã™ã‚‹è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚<br> å®Ÿè£…ã«ã¯async runtime(tokio,async-std)ã®æŠ½è±¡åŒ–ã‚„ã€<code>futures::stream::FuturesUnordered</code>ã‚’åˆ©ç”¨ã—ãŸtaskç®¡ç†ç­‰å‚è€ƒã«ãªã‚‹å‡¦ç†ãŒå¤šãã‚ã‚‹ã®ã§ã™ãŒä»Šå›ã¯å‰²æ„›ã—ã¾ã™ã€‚<p>æœ€åˆã«<code>opentelemetry_otlp::new_pipeline()</code>ã‚’è¦‹ãŸã¨ãã€ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã¨ã¯?ã¨ãªã‚Šã¾ã—ãŸã€‚<br> ä»Šã¯ã€ä¸Šè¨˜ã®å›³ã§ã„ã†ã€TracerProvider -> BatchSpanProcessor -> SpanExporterã‚’pipelineã¨è¡¨ç¾ã—ã¦ã„ã‚‹ã®ã ãªã¨è€ƒãˆã¦ã„ã¾ã™ã€‚<h2 id=opentelemetry-sdk-trace-config><a aria-label="Anchor link for: opentelemetry-sdk-trace-config" class=zola-anchor href=#opentelemetry-sdk-trace-config><code>opentelemetry::sdk::trace::Config</code></a></h2><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span>opentelemetry_otlp</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new_pipeline</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>    .</span><span style=color:#88c0d0>tracing</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>    .</span><span style=color:#88c0d0>with_trace_config</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>        opentelemetry</span><span style=color:#81a1c1>::</span><span>sdk</span><span style=color:#81a1c1>::</span><span>trace</span><span style=color:#81a1c1>::</span><span>Config</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>with_sampler</span><span style=color:#eceff4>(</span><span style=color:#616e88>/*...*/</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>with_id_generator</span><span style=color:#eceff4>(</span><span style=color:#616e88>/*...*/</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>with_resource</span><span style=color:#eceff4>(</span><span style=color:#616e88>/*...*/</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>    )</span></span></code></pre><p><code>with_trace_config()</code>ã«<code>sdk::trace::Config</code>ã‚’æ¸¡ã—ã¾ã™ã€‚<br> ã¾ãšä»•æ§˜ã‚’ç¢ºèªã—ã¾ã™ã€‚ã•ãã»ã©ã¿ãŸã‚ˆã†ã«ã€Tracerã¯çŠ¶æ…‹ã‚’ã‚‚ãŸãšçŠ¶æ…‹(=è¨­å®š)ã®è²¬å‹™ã¯TracerProviderã«ã‚ã‚Šã¾ã™ã€‚<br> ãã“ã§ã€ä»Šå›ã¯TracerProviderã®SDKã«é–¢ã™ã‚‹ä»•æ§˜ã‚’ã¿ã¦ã¿ã‚‹ã¨ã€<a href=https://github.com/open-telemetry/opentelemetry-specification/blob/71813887597d18e3535dd56d2a18ecae7299daad/specification/trace/sdk.md#configuration rel=external>Tracer Provider Configuration</a>ã«<blockquote><p>Configuration (i.e., SpanProcessors, IdGenerator, SpanLimits and Sampler) MUST be owned by the the TracerProvider. The configuration MAY be applied at the time of TracerProvider creation if appropriate.</blockquote><p>Traceã«é–¢ã™ã‚‹è¨­å®š(Samplerã‚„IdGeneraor)ã¯TracerProviderã®ä½œæˆæ™‚ã«é©ç”¨ã•ã›ã‚‹ã¨ã„ã£ãŸè¨˜è¿°ãŒã‚ã‚Šã¾ã™ã€‚<br> ã“ã‚Œã‚’ã†ã‘ã¦ã€<code>opentelemetry_sdk::trace::Config</code>ã§ã¯SDKã®ä»•æ§˜ã«å®šã‚ã‚‰ã‚ŒãŸè¨­å®šã‚’<code>Config</code>ã§å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚<h3 id=idgenetaror><a aria-label="Anchor link for: idgenetaror" class=zola-anchor href=#idgenetaror>IdGenetaror</a></h3><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span>opentelemetry</span><span style=color:#81a1c1>::</span><span>sdk</span><span style=color:#81a1c1>::</span><span>trace</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Config</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>    .</span><span style=color:#88c0d0>with_id_generator</span><span style=color:#eceff4>(</span><span>opentelemetry</span><span style=color:#81a1c1>::</span><span>sdk</span><span style=color:#81a1c1>::</span><span>trace</span><span style=color:#81a1c1>::</span><span>XrayIdGenerator</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>())</span></span></code></pre><p>ã“ã“ã§ã¯ã€TraceId,SpanIdã®ç”Ÿæˆã®è²¬å‹™ã‚’ã‚‚ã¤IdGeneratorã‚’ä½œæˆã—ã¾ã™ã€‚<br> ã“ã‚Œã‚‰ã®Idã¯ãã®åã®é€šã‚Štraceã‚„spanã®è­˜åˆ¥å­ã§ã™ã€‚<a href=https://github.com/open-telemetry/opentelemetry-specification/blob/71813887597d18e3535dd56d2a18ecae7299daad/specification/trace/api.md#spancontext rel=external>ä»•æ§˜</a>ã§ã¯<blockquote><p>TraceId A valid trace identifier is a 16-byte array with at least one non-zero byte. SpanId A valid span identifier is an 8-byte array with at least one non-zero byte.</blockquote><p>ã¨å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚<br> ã¾ãŸã€OpenTelemetryã¯<a href=https://www.w3.org/TR/trace-context/ rel=external>W3C TraceContext specification</a>ã«æº–æ‹ ã—ã¦ãŠã‚Šã€ãŸã³ãŸã³ã“ã¡ã‚‰ã®ä»•æ§˜ãŒå‚ç…§ã•ã‚Œã¾ã™ã€‚<br> ã“ã‚Œã‚’ã†ã‘ã¦ã€<a href=https://github.com/open-telemetry/opentelemetry-specification/blob/71813887597d18e3535dd56d2a18ecae7299daad/specification/trace/sdk.md#id-generators rel=external>SDKã®ä»•æ§˜</a>ã§ã¯<blockquote><p>The SDK MUST by default randomly generate both the TraceId and the SpanId.</blockquote><p>ã¨å®šç¾©ã•ã‚Œã¦ãŠã‚Šã€Idã®å®Ÿè£…ã‚’æä¾›ã—ã¦ãã‚Œã¦ã„ã¾ã™ã€‚<br> <code>opentelemetry_sdk::trace</code>ã¯<a href=https://github.com/open-telemetry/opentelemetry-rust/blob/879d6ff9d251db158da7a5720ff903fa6cb7c1e2/opentelemetry-sdk/src/trace/id_generator/mod.rs#L22 rel=external><code>RandomIdGenetor</code></a>ã‚’æä¾›ã—ã¦ã„ã‚‹ã®ã§ã™ãŒã€ä»Šå›ã®ä¾‹ã§ã¯åˆ©ç”¨ã—ã¦ã„ã¾ã›ã‚“ã€‚<p>ä»£ã‚ã‚Šã«<code>opentelemetry_sdk::trace::id_generator::aws::XrayIdGenerator</code>ã¨ã„ã†ã€å”çªã«AWSã®XrayIdGeneratorã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚ ã“ã‚Œã¯ã€AWS XRayã®trace idã«ã¯<a href=https://docs.aws.amazon.com/xray/latest/devguide/xray-api-sendingdata.html#xray-api-traceids rel=external>trace idã«timestampã‚’è¼‰ã›ã‚‹</a>ã¨ã„ã†ä»•æ§˜ãŒã‚ã‚‹ãŸã‚ã«ã€randomã«ç”Ÿæˆã•ã‚ŒãŸidã ã¨XRayä¸Šã§åˆ©ç”¨ã§ããªã„ãŸã‚ã§ã™ã€‚<p>å€‹äººçš„ã«ã¯ã“ã®åˆ¶ç´„ã«ã¯éå¸¸ã«ä¸æº€ã‚’ã‚‚ã£ã¦ã„ã¾ã™ã€‚<br> ã¨ã„ã„ã¾ã™ã®ã‚‚ã€OpenTelemetryã‚’åˆ©ç”¨ã—ãŸã„ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã®ã²ã¨ã¤ã«application(è¨ˆè£…ã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰)ã«observability backendã‚„vendorã®æ¦‚å¿µã‚’æŒã¡è¾¼ã¾ãªã„ã¨ã„ã†ã‚‚ã®ã‚‚ãŒã‚ã‚Šã¾ã™ã€‚<br> ã“ã®ãŠã‹ã’ã§ã€applicationã¯opentelemetry collectorã¸ã®exportã ã‘ã‚’è€ƒæ…®ã—ã¦ã€ã‚ã¨ã®äº‹æƒ…ã¯collectorå´ã§å¸åã§ãã‚‹ã¨ã„ã†è¨­è¨ˆã§ã™ã€‚<br> ã—ã‹ã—ãªãŒã‚‰ã€XRayãŒtrace idã«ç‹¬è‡ªã®åˆ¶ç´„ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ãŸã‚ã«ã€applicationå´ã§traceãŒã©ã“ã«exportã•ã‚Œã‚‹ã‹ã‚’æ„è­˜ã—ãªããªã‚‰ãªã‘ã‚Œã°ãªã‚‰ãªããªã‚Šã¾ã—ãŸã€‚<p>ãŸã ã€XRayIdgeneratorã‚’åˆ©ç”¨ã—ã¦ã‚‚ã€OpenTelemetryã®trace idã®ä»•æ§˜ã«ã¯åã—ã¦ã„ãªã„ã®ã§ã€ç¾çŠ¶ã§ã¯XRayã‚’åˆ©ç”¨ã™ã‚‹ã‹ã«é–¢ã‚ã‚‰ãšã€XRayIdGeneratorã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚<p><a href=https://github.com/open-telemetry/opentelemetry-specification/blob/71813887597d18e3535dd56d2a18ecae7299daad/specification/trace/sdk.md#id-generators rel=external>SDKã®ä»•æ§˜</a>ã«ã¯<blockquote><p>Additional IdGenerator implementing vendor-specific protocols such as AWS X-Ray trace id generator MUST NOT be maintained or distributed as part of the Core OpenTelemetry repositories.</blockquote><p>ã¨ã‚ã‚Šã€"Core OpenTelemetry repositories"ã«ã¯vendorä¾å­˜ãªå‡¦ç†ã¯ã„ã‚Œã¦ã¯ãªã‚‰ãªã„ã¨ã‚ã‚Šã¾ã™ã€‚<br> ãŒã€ä»Šã®ã¨ã“ã‚ã¯ã€XRayIdGeneratorã¯<a href=https://github.com/open-telemetry/opentelemetry-rust/blob/879d6ff9d251db158da7a5720ff903fa6cb7c1e2/opentelemetry-sdk/src/trace/id_generator/aws.rs#L37 rel=external><code>opentelemetry_sdk::trace::id_genrarator::aws</code></a>ã«å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚<br> <a href=https://github.com/open-telemetry/opentelemetry-rust/issues/841 rel=external>issueã§ã‚‚ã“ã®ç‚¹ã¯è­°è«–</a>ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚<h3 id=sampler><a aria-label="Anchor link for: sampler" class=zola-anchor href=#sampler>Sampler</a></h3><p>æ¬¡ã¯Samplerã«ã¤ã„ã¦ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span>opentelemetry</span><span style=color:#81a1c1>::</span><span>sdk</span><span style=color:#81a1c1>::</span><span>trace</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Config</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>    .</span><span style=color:#88c0d0>with_sampler</span><span style=color:#eceff4>(</span><span>Sampler</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>ParentBased</span><span style=color:#eceff4>(</span><span>Box</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>Sampler</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>TraceIdRatioBased</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>        sampling_ratio</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    ))))</span></span></code></pre><p>Samplingã«ã¤ã„ã¦ã¯context propagationã¨é–¢é€£ã™ã‚‹ã®ã§ã€åˆ¥ã§è©³ã—ãæ‰±ã„ãŸã„ã¨æ€ã£ã¦ã„ã¾ã™ã€‚<br> ã“ã“ã§ã¯ã€traceã‚’ã™ã¹ã¦å–å¾—ã—ã¦ã€exportã€æ°¸ç¶šåŒ–ã™ã‚‹ã¨runtimeã®costã€network cost, storage costã¨ã„ã‚ã„ã‚å¤§å¤‰ãªã®ã§ã€å…¨ä½“ã®nï¼…ã‚’å–å¾—ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹æ©Ÿæ§‹ã¨ã„ã†ç¨‹åº¦ã®ç†è§£ã§ã„ãã¾ã™ã€‚<br> <a href=https://github.com/open-telemetry/opentelemetry-specification/blob/71813887597d18e3535dd56d2a18ecae7299daad/specification/trace/sdk.md#built-in-samplers rel=external>SDKã®ä»•æ§˜</a>ã§ã€ã„ãã¤ã‹builtinã®å®Ÿè£…ãŒæä¾›ã•ã‚Œã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#8fbcbb>Sampler</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>ParentBased</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>  Box</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>Sampler</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>TraceIdRatioBased</span><span style=color:#eceff4>(</span><span>sampling_ratio</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#eceff4>)</span></span></code></pre><p>ã®æ„å‘³ã§ã™ãŒã€æ—¢ã«Sampleã™ã‚‹ã‹ã®åˆ¤å®šãŒãªã•ã‚Œã¦ã„ãŸå ´åˆã¯ãã‚Œã«å¾“ã„ã€åˆã‚ã¦sampleã™ã‚‹ã‹ã®åˆ¤å®šã‚’è¡Œã†å ´åˆã¯ã€å¼•æ•°ã®sampling_ratioã«å¾“ã†ã¨ã„ã†è¨­å®šã‚’å®Ÿæ–½ã—ã¦ã„ã¾ã™ã€‚<br> å…·ä½“çš„ã«ã¯ã€graphqlã®ã‚ˆã†ãªserverå´ã®componentã‚’è¨­å®šã—ã¦ã„ã‚‹å ´åˆã«graphqlã®requestã‚’å®Ÿæ–½ã™ã‚‹clientå´ã§æ—¢ã«opentelemetryã®samplingåˆ¤å®šãŒå®Ÿæ–½ã•ã‚Œã€ãã‚ŒãŒhttp headerç­‰ã§serverã«propagate(context propagagation)ã•ã‚Œã¦ã„ãŸå ´åˆã«ã¯ã€graphql serverã¯ãã‚Œã«å¾“ã„ã¾ã™ã€‚<h2 id=resource><a aria-label="Anchor link for: resource" class=zola-anchor href=#resource>Resource</a></h2><p>æ¬¡ã¯Resourceã«ã¤ã„ã¦ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span>opentelemetry</span><span style=color:#81a1c1>::</span><span>sdk</span><span style=color:#81a1c1>::</span><span>trace</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Config</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>    .</span><span style=color:#88c0d0>with_resource</span><span style=color:#eceff4>(</span><span>opentelemetry</span><span style=color:#81a1c1>::</span><span>sdk</span><span style=color:#81a1c1>::</span><span>Resource</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_schema_url</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>        [</span></span>
<span class=giallo-l><span>            opentelemetry</span><span style=color:#81a1c1>::</span><span>KeyValue</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>                opentelemetry_semantic_conventions</span><span style=color:#81a1c1>::</span><span>resource</span><span style=color:#81a1c1>::</span><span>SERVICE_NAME</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>                env!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>CARGO_PKG_NAME</span><span style=color:#eceff4>"),</span></span>
<span class=giallo-l><span style=color:#eceff4>            ),</span></span>
<span class=giallo-l><span>            opentelemetry</span><span style=color:#81a1c1>::</span><span>KeyValue</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>                opentelemetry_semantic_conventions</span><span style=color:#81a1c1>::</span><span>resource</span><span style=color:#81a1c1>::</span><span>SERVICE_VERSION</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>                env!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>CARGO_PKG_VERSION</span><span style=color:#eceff4>"),</span></span>
<span class=giallo-l><span style=color:#eceff4>            ),</span></span>
<span class=giallo-l><span style=color:#eceff4>        ],</span></span>
<span class=giallo-l><span style=color:#eceff4>        "</span><span style=color:#a3be8c>https://opentelemetry.io/schemas/1.20.0</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>    ))</span></span></code></pre><p>Resourceã¨ã¯ä½•ã‹ã¨ã„ã†ã¨ã€traceã«ä»˜ä¸ã™ã‚‹key valutã®metadataã§ã™ã€‚<br> <a href=https://github.com/open-telemetry/opentelemetry-specification/blob/71813887597d18e3535dd56d2a18ecae7299daad/specification/resource/sdk.md#resource-sdk rel=external>ä»•æ§˜</a>ã«ã¯<blockquote><p>A Resource is an immutable representation of the entity producing telemetry as Attributes.</blockquote><p>ã¨å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚key valutã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚‚<a href=https://github.com/open-telemetry/opentelemetry-specification/blob/71813887597d18e3535dd56d2a18ecae7299daad/specification/common/README.md#attribute rel=external>ä»•æ§˜ã§å®šç¾©</a>ã•ã‚Œã¦ãŠã‚Šã€ã“ã¡ã‚‰ã¯Attributeã¨è¨€ã‚ã‚Œã¾ã™ã€‚<br> Resourceã¯traceã ã‘ã§ãªãã€metricsã§ã‚‚åˆ©ç”¨ã•ã‚Œã¾ã™ã€‚ã¾ãŸã€Attributeã¯Resourceã«é™ã‚‰ãšSpan eventsã§ã‚ã£ãŸã‚Šã€key valueã®æƒ…å ±ã‚’ä»˜ä¸ã™ã‚‹contextã§å‚ç…§ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã§ã™ã€‚æœ€å¤§ã‚µã‚¤ã‚ºã§ã‚ã£ãŸã‚Šã€ç©ºæ–‡å­—ã®keyãŒç¦æ­¢ã•ã‚Œã¦ã„ãŸã‚Šã¨ã„ã£ãŸã“ã¨ãŒè¦å®šã•ã‚Œã¦ã„ã¾ã™ã€‚<p>Resourceã§è¡¨ç¾ã™ã‚‹æƒ…å ±ã§ã™ãŒã€traceãŒã©ã“ã‹ã‚‰æ¥ãŸã‹ã«ã¤ã„ã¦ã‚’è¡¨ç¾ã—ã¾ã™ã€‚<br> ã¾ãŸã€ãã®éš›ã«ç”¨ã„ã‚‹keyã«ã¯semantic conventionsã‚’åˆ©ç”¨ã—ã¾ã™ã€‚<br> Semantic conventionsã¯Resourceã«é™ã‚‰ãšã€OpenTelemetryå…¨ä½“ã«é©ç”¨ã•ã‚Œã‚‹å‘½åè¦å‰‡ã§ã™ã€‚<br> ä¾‹ãˆã°ã€traceã‚’ç”Ÿæˆã—ãŸapplicationã‚’æŒ‡ã—ãŸã„å ´åˆã¯<a href=https://github.com/open-telemetry/semantic-conventions/blob/main/docs/resource/README.md#service rel=external><code>service.name</code></a>ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚<p>ä»–ã«ã‚‚æ§˜ã€…ãªattributeãŒè¦å®šã•ã‚Œã¦ã„ã¾ã™ã€‚traceã«ã¯requestã—ãŸuserã®è­˜åˆ¥å­ã‚’è¼‰ã›ãŸããªã‚‹ã®ãŒä¸€èˆ¬çš„ã‹ã¨æ€ã„ã¾ã™ãŒãã®éš›ã®keyã¯ã©ã†ã•ã‚Œã¦ã„ã‚‹ã§ã—ã‚‡ã†ã‹ã€‚<br> <code>user.id</code>ã‚’ä½¿ã£ã¦ã—ã¾ã„ãã†ã§ã™ãŒã€<a href=https://github.com/open-telemetry/semantic-conventions/blob/main/docs/general/attributes.md#general-identity-attributes rel=external>General identity attributes</a>ã¨ã—ã¦ã€<code>enduser.id</code>ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã™ã€‚<br> ã¡ãªã¿ã«AWS XRayã§ã¯ã€<code>enduser.id</code>ã‚’XRayå´ã®userã®è­˜åˆ¥å­ã«å¤‰æ›ã—ã¦ãã‚ŒãŸã‚Šã™ã‚‹ã®ã§ã€semantic conventionsã«å¾“ã£ã¦ãŠãã¨ã€ecosystemã®æ©æµã«é ã‹ã‚Œã‚‹ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã¾ã™ã€‚<p>productionã‚„stagingã¨ã„ã£ãŸã€deployã™ã‚‹ç’°å¢ƒã«ã¤ã„ã¦ã‚‚ã€<a href=https://github.com/open-telemetry/semantic-conventions/blob/v1.21.0/docs/resource/deployment-environment.md rel=external><code>deployment.environment</code></a>ã¨å®šã‚ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚<p>ã“ã®metadataã®keyãŒä»•æ§˜ã§å®šã‚ã‚‰ã‚Œã¦ã„ã‚‹ã®ã¯éå¸¸ã«é‡è¦ã ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚<br> ã“ã®ä»•æ§˜ã®ãŠã‹ã’ã§ã€logã‚„traceã‚’queryã™ã‚‹éš›ã«ã€<code>query ... condition deployment.environment = "production"</code>ã®ã‚ˆã†ãªæ¡ä»¶ãŒæ›¸ã‘ã¾ã™ã€‚<p>Rustã§ã¯semantic conventionsã¯<code>opentelemetry_semantic_conventions</code>ã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ã§ãã‚‹ã ã‘ã“ã¡ã‚‰ã‚’å‚ç…§ã™ã‚‹ã¨è‰¯ã„ã¨æ€ã„ã¾ã™ã€‚<h3 id=schema-url><a aria-label="Anchor link for: schema-url" class=zola-anchor href=#schema-url>Schema URL</a></h3><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span>opentelemetry</span><span style=color:#81a1c1>::</span><span>sdk</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Resource</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_schema_url</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#eceff4>    [</span><span style=color:#616e88> /*...*/</span><span style=color:#eceff4> ],</span></span>
<span class=giallo-l><span style=color:#eceff4>    "</span><span style=color:#a3be8c>https://opentelemetry.io/schemas/1.20.0</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>)),</span></span></code></pre><p>Resouceç”Ÿæˆæ™‚ã«æŒ‡å®šã—ã¦ã„ã‚‹ã€schema urlã«ã¤ã„ã¦ã€‚<br> <a href=https://github.com/open-telemetry/opentelemetry-specification/tree/71813887597d18e3535dd56d2a18ecae7299daad/specification/schemas rel=external>Telemetry Schemas</a>ã¨ã—ã¦ä»•æ§˜ã«å®šã‚ã‚‰ã‚Œã¦ã„ã‚‹ä»•çµ„ã¿ã§ã™ã€‚<br> æ¦‚è¦ã¨ã—ã¦ã¯ã€semantic conventionsã®versionã®ã‚ˆã†ãªã‚‚ã®ã§ã€ã“ã‚Œã«ã‚ˆã£ã¦ã€semantic conventionsã«ç ´å£Šçš„å¤‰æ›´ãŒã‚ã£ã¦ã‚‚æ—¢å­˜ã®ecosystemãŒå£Šã‚Œãªã„ã‚ˆã†ãªä»•çµ„ã¿ã¨ç†è§£ã—ã¦ã„ã¾ã™ã€‚<p>åŸºæœ¬çš„ã«ã¯ã€Resourceä½œæˆæ™‚ã«æŒ‡å®šã§ãã‚‹ã‚ˆã†ãªapiã«ãªã£ã¦ã„ã‚‹ã®ã§ã€è‡ªåˆ†ãŒå‚ç…§ã—ãŸsemantic conventionsã®versionã‚’ã„ã‚Œã¦ãŠã‘ã°ã€é–¢é€£ã™ã‚‹ecosystemå´ã§ã‚ˆã—ãªã«ã—ã¦ãã‚Œã‚‹ã“ã¨ãŒæœŸå¾…ã§ãã¾ã™ã€‚<br> å…·ä½“ä¾‹ã¨ã—ã¦ã¯ã€production,stagingã¨ã„ã£ãŸæƒ…å ±ã‚’environmentã§è¡¨ç¾ã—ãŸãŒã€deployment.environmentã«å¤‰æ›´ã—ã¦ã‚‚ã€queryå´ãŒå£Šã‚Œãªã„ã‚ˆã†ãªä¾‹ãŒæŒ™ã’ã‚‰ã‚Œã¦ã„ã¾ã—ãŸã€‚<br> Queryã¯Alertã§åˆ©ç”¨ã•ã‚Œã‚‹ã¨æ€ã†ã®ã§ã€Alertingã‚’å£Šã—ã¦ã—ã¾ã†ã¨ã€å®Ÿè³ªçš„ã«applicationå´ã§æœ€æ–°ã®semantic conventionsã‚’åˆ©ç”¨ã§ããªããªã£ã¦ã—ã¾ã„ã¾ã™ã€‚<br> OpenTelemetryã§ã¯æœ€æ–°ã®versionã¸fearlessã«upgradeã§ãã‚‹ã“ã¨ãŒé‡è¦–ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã“ã†ã„ã£ãŸæ©Ÿæ§‹ã‹ã‚‰ã‚‚ä¼ã‚ã£ã¦ãã¾ã™ã€‚<h2 id=export><a aria-label="Anchor link for: export" class=zola-anchor href=#export>Export</a></h2><p>æœ€å¾Œã«traceã®exporté–¢é€£ã®è¨­å®šã‚’ç¢ºèªã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span>opentelemetry_otlp</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new_pipeline</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>    .</span><span style=color:#88c0d0>tracing</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>    .</span><span style=color:#88c0d0>with_trace_config</span><span style=color:#eceff4>(</span><span style=color:#616e88> /*...*/</span><span style=color:#eceff4> )</span></span>
<span class=giallo-l><span style=color:#81a1c1>    .</span><span style=color:#88c0d0>with_batch_config</span><span style=color:#eceff4>(</span><span>opentelemetry</span><span style=color:#81a1c1>::</span><span>sdk</span><span style=color:#81a1c1>::</span><span>trace</span><span style=color:#81a1c1>::</span><span>BatchConfig</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>default</span><span style=color:#eceff4>())</span></span>
<span class=giallo-l><span style=color:#81a1c1>    .</span><span style=color:#88c0d0>with_exporter</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>        opentelemetry_otlp</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new_exporter</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>tonic</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>with_endpoint</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>http://localhost:4317</span><span style=color:#eceff4>"),</span></span>
<span class=giallo-l><span style=color:#eceff4>    )</span></span></code></pre><h3 id=batchconfig><a aria-label="Anchor link for: batchconfig" class=zola-anchor href=#batchconfig>BatchConfig</a></h3><p>traceã¯exportã•ã‚Œã‚‹éš›ã«ä¸€å®šç¨‹åº¦ã€ã¾ã¨ã‚ã¦ã‹ã‚‰exportã•ã‚Œã¾ã™ã€‚ã“ã®æŒ™å‹•ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ã®ãŒã€BatchSpanProcessorã§ã€SDKå´ã§å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ã€‚<br> TracerProvider -> SpanProcessor(BatchSpanProcessor) -> SpanExporterã®ã‚ˆã†ã«ã€exportå‰ã«SpanProcessorã¨ã„ã†layerã‚’ç”¨æ„ã—ã¦ã„ã‚‹ç†ç”±ã§ã™ãŒã€Pluginå´ã‚’è–„ãã™ã‚‹ãŸã‚ã ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚<br> ä»®ã«SpanProcessorãŒãªãã€traceãŒç›´æ¥SpanExporterã«æ¸¡ã•ã‚ŒãŸã¨ã™ã‚‹ã¨ã€Plugin(SpanExporter)ã¯æ‹…å½“ã™ã‚‹protocolå‡¦ç†ä»¥å¤–ã«ã‚‚batchå‡¦ç†ã‚’æ™‚å‰ã§å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚<p>Batchå‡¦ç†ã«ãŠã„ã¦æŒ‡å®šã§ãã‚‹è¨­å®šã‚‚<a href=https://github.com/open-telemetry/opentelemetry-specification/blob/71813887597d18e3535dd56d2a18ecae7299daad/specification/trace/sdk.md#batching-processor rel=external>SDKã®ä»•æ§˜</a>ã§å®šã‚ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚<br> OpenTelemetryã«ä»•æ§˜ã®ç‰¹å¾´ã¨ã—ã¦ã€è¨­å®šã§ãã‚‹é …ç›®ã®defaultå€¤ã‚‚ä»•æ§˜ã§å®šã‚ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚<br> ä¾‹ãˆã°ã€batchå‡¦ç†ã®éš›ã«ç”¨ã„ã‚‰ã‚Œã‚‹<code>maxQueueSize</code>ã®defaultå€¤ã¯2048ã§ã™ã€‚<br> ã“ã‚Œã¯Rustç‰¹æœ‰ã¨ã„ã†ã“ã¨ã§ãªãã€ã™ã¹ã¦ã®è¨€èªã«å½“ã¦ã¯ã¾ã‚Šã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã£ã¦ã€è¨€èªã”ã¨ã«ã€å¾®å¦™ã«æŒ™å‹•ãŒé•ã†ã¨ã„ã†ã“ã¨ãŒãªããªã£ã¦ãã¾ã™ã€‚(ã‚‚ã¡ã‚ã‚“å®Ÿè£…æ¬¡ç¬¬ã§ã™ãŒ)<br> ä»•æ§˜ã®defaultå€¤ã¯Rustã‚‰ã—ãã€<code>Default::default</code>ã§è¡¨ç¾ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ä¸Šã®ä¾‹ã§ã¯ç‰¹ã«è¨­å®šã›ãšã«åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚<br> ã¾ãŸã€Rust(<code>opentelemetry_sdk</code>)ã®å ´åˆã€<code>max_concurrent_exports</code>ã‚‚æŒ‡å®šã§ãã€åŒæ™‚ã«<code>tokio::task::span</code>ã™ã‚‹æœ€å¤§taskã‚‚æŒ‡å®šã§ãã¾ã™ã€‚(defaultã¯1)<h3 id=exporterconfig><a aria-label="Anchor link for: exporterconfig" class=zola-anchor href=#exporterconfig>ExporterConfig</a></h3><p>æœ€å¾Œã«gRPCã¨ã—ã¦ã€exportã™ã‚‹è¨­å®šã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚<br> gRPCã®å®Ÿè£…ã«ã¯tonicã‚’åˆ©ç”¨ã—ã¾ã—ãŸã€‚tonicä»¥å¤–ã«ã‚‚ã€grpcioã‚„httpã‚‚é¸æŠã§ãã¾ã™ã€‚<h2 id=matome><a aria-label="Anchor link for: matome" class=zola-anchor href=#matome>ã¾ã¨ã‚</a></h2><p>ç°¡å˜ã«ã§ã™ãŒã€rustã§OpenTelemetryã‚’åˆ©ç”¨ã™ã‚‹éš›ã®Traceré–¢é€£ã®è¨­å®šã«ã¤ã„ã¦ã¿ã¦ãã¾ã—ãŸã€‚<br> æœ€åˆã¯ã€ãªã‚“ã§ã“ã‚“ãªã„ã‚ã‚“ãªcrateã§ã¦ãã‚‹ã‚“ã ã¨æ€ã£ãŸã‚Šã—ãŸã®ã§ã™ãŒã€ä»•æ§˜ã‚’çŸ¥ã‚‹ã¨ã€ç¢ºã‹ã«å®Ÿè£…ã™ã‚‹ãªã‚‰ã“ã†ãªã‚‹ãªã¨ã„ã‚ã„ã‚ç´å¾—ã§ãã¾ã—ãŸã€‚<p>æ¬¡ã¯Metricsã«ã¤ã„ã¦æ›¸ãäºˆå®šã§ã™ã€‚</div></article></main><footer class=blog-footer><p>Â© 2026 <a href=https://blog.ymgyt.io> ymgyt </a> | Made with <a href=https://www.getzola.org rel=noopener target=_blank>Zola</a> | <a href=https://github.com/ymgyt/blog>Repository</a> | <a href=https://blog.ymgyt.io/atom.xml target=_blank title=rss> <svg viewbox="0 0 24 24" class=icon fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx=5 cy=19 r=1></circle></svg> </a></footer></div></div>