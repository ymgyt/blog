<!doctype html><html lang=ja><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1" name=viewport><link href=https://blog.ymgyt.io/favicon.ico rel=icon sizes=any><link href=https://blog.ymgyt.io/icon.svg rel=icon type=image/svg+xml><link href=https://blog.ymgyt.io/apple-touch-icon.png rel=apple-touch-icon><link href=https://blog.ymgyt.io/manifest.webmanifest rel=manifest><link href=https://blog.ymgyt.io/style.css rel=stylesheet><link href=https://blog.ymgyt.io/atom.xml rel=alternate title=Atom type=application/atom+xml><script src="https://www.googletagmanager.com/gtag/js?id=G-GTB0KMLN90" async></script><script>window.dataLayer = window.dataLayer || [];
	function gtag() {dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-GTB0KMLN90');</script><title>â„ï¸ NixOSã¨Raspberry Piã§è‡ªå®…server | Part 2 deploy-rsã§deploy | Happy developing</title><meta content="deploy-rsã‚’ä½¿ã£ã¦Raspberry Piã«deploy" name=description><meta content=summary name=twitter:card><meta content="@YAmaguchixt " name=twitter:site><meta content="â„ï¸ NixOSã¨Raspberry Piã§è‡ªå®…server | Part 2 deploy-rsã§deploy" name=twitter:title><meta content="deploy-rsã‚’ä½¿ã£ã¦Raspberry Piã«deploy" name=twitter:description><meta content=https://blog.ymgyt.io/images/emoji/snowflake.png name=twitter:image><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><body><div class=world><div class=content-container><header class=blog-header-container><div class=blog-logo><a href=https://blog.ymgyt.io>Happy developing</a></div><div class=blog-nav><nav><ul><li><a href=https://blog.ymgyt.io/entry/>Entries</a><li><a href=https://blog.ymgyt.io/tags/>Tags</a><li><a href=https://blog.ymgyt.io/about/>About</a><li><a href=https://github.com/ymgyt> <img alt=Github class=icon src=https://blog.ymgyt.io/images/icon/github.svg> </a><li><a href="https://twitter.com/YAmaguchixt "> <img alt=Twitter class=icon src=https://blog.ymgyt.io/images/icon/twitter.svg> </a></ul></nav></div></header><main class=blog-main><article><header class=entry-header><h1 class=entry-title>â„ï¸ NixOSã¨Raspberry Piã§è‡ªå®…server | Part 2 deploy-rsã§deploy</h1><div class=entry-meta><p class=entry-meta-item>ğŸ—“ 2023-10-09<p class=entry-meta-item>ğŸ· <span class=tag><a href=https://blog.ymgyt.io/tags/nix/>nix</a></span></div></header><aside class=entry-toc><nav><ul class=entry-toc-toplevel-list><li><a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-deploy-with-deploy-rs/#raspberry-pinoshe-ding>Raspberry Piã®è¨­å®š</a><li><a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-deploy-with-deploy-rs/#deploy-rs>deploy-rs</a><li><a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-deploy-with-deploy-rs/#shi-ji-nideploy>å®Ÿéš›ã«deploy</a></ul></nav></aside><div class=entry-content><p><a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-install-nixos/ rel=external>Part 1 NixOSã‚’install</a><br> Part 2 deply-rsã§NixOS Configurationã‚’é©ç”¨(ğŸ‘ˆ ã“ã®è¨˜äº‹)<br> <a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-secret-management-with-ragenix/ rel=external>Part 3 ragenixã§secretç®¡ç†</a><br> <a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-export-metrics-with-opentelemetry-collector/ rel=external>Part 4 opentelemetry-collectorã¨openobserveã§metricsã‚’å–å¾—</a><br> <a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-get-cpu-temperature/ rel=external>Part 5 CPUã®æ¸©åº¦ã‚’metricsã¨ã—ã¦å–å¾—</a><p>æœ¬è¨˜äº‹ã¯NixOSã¨Raspberry Piã§è‡ªå®…serverã‚’ã¯ã˜ã‚ã‚‹è¨˜äº‹ã®Part 2ã§ã™ã€‚<br> <a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-install-nixos/ rel=external>Part 1</a>ã§Raspberry Pi(ä»¥ä¸‹raspi)ã«NixOSã‚’installã—ã¦sshã§ãã‚‹ã¨ã“ã‚ã¾ã§ã‚’è¡Œã„ã¾ã—ãŸã€‚<br> æœ¬è¨˜äº‹ã§ã¯raspiã®è¨­å®šã‚’flakeã§ç®¡ç†ã—ã¦æ‰‹å…ƒã®host machineã‹ã‚‰deploy(é©ç”¨)ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ãã¾ã™ã€‚<br> å®Ÿéš›ã®sourceã¯<a href=https://github.com/ymgyt/mynix/tree/main/homeserver rel=external>ã“ã¡ã‚‰</a>ã§ç®¡ç†ã—ã¦ã„ã¾ã™ã€‚<p>æ¦‚è¦ã¨ã—ã¦ã¯<a href=https://github.com/serokell/deploy-rs rel=external>deploy-rs</a>ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ansibleã§æ§‹æˆç®¡ç†ã™ã‚‹ã®ã¨è¿‘ã„ã“ã¨ãŒã§ãã¾ã™ã€‚<br> é•ã†ã®ã¯provisioningã®è¨­å®šã‚’<code>nixosConfiguration</code>ã§è¡Œãˆã‚‹ç‚¹ã§ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šhostã®NixOSã‚„Macã¨åŒã˜è¨­å®šã®ä»•çµ„ã¿ã§raspiã‚‚ç®¡ç†ã§ãã¾ã™ã€‚<br> NixOSã‚„Macã‚’nixã§ç®¡ç†ã—ã¦ã„ãæ–¹æ³•ã«ã¤ã„ã¦ã¯ä»¥å‰ã€<a href=https://blog.ymgyt.io/entry/declarative-environment-management-with-nix/ rel=external>Nixã§linuxã¨macã®ç’°å¢ƒã‚’ç®¡ç†ã—ã¦ã¿ã‚‹</a>ã§æ›¸ã„ã¦ã¿ã¾ã—ãŸã€‚<p>raspiã‚’ç®¡ç†ã™ã‚‹repositoryã®<code>flake.nix</code>ã®å…¨ä½“ã¨ã—ã¦ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ ã“ã®è¨­å®šã‚’ç†è§£ã™ã‚‹ã®ãŒç›®æ¨™ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=nix><span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  description</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>Deployment for my home server cluster</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>  inputs</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    nixpkgs</span><span>.</span><span style=color:#8fbcbb>url</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>github:NixOS/nixpkgs/nixpkgs-unstable</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    deploy-rs</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      url</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>github:serokell/deploy-rs</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      inputs</span><span>.</span><span style=color:#8fbcbb>nixpkgs</span><span>.</span><span style=color:#8fbcbb>follows</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>nixpkgs</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      inputs</span><span>.</span><span style=color:#8fbcbb>utils</span><span>.</span><span style=color:#8fbcbb>follows</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>flake-utils</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>    flake-utils</span><span>.</span><span style=color:#8fbcbb>url</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>github:numtide/flake-utils</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>  }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>  outputs</span><span style=color:#81a1c1> =</span></span>
<span class=giallo-l><span style=color:#eceff4>    {</span><span> self</span><span style=color:#81a1c1>,</span><span> nixpkgs</span><span style=color:#81a1c1>,</span><span> deploy-rs</span><span style=color:#81a1c1>,</span><span> flake-utils</span><span style=color:#eceff4>}:</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      spec</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        user</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>ymgyt</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        defaultGateway</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>192.168.10.1</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        nameservers</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> [ "</span><span style=color:#a3be8c>8.8.8.8</span><span style=color:#eceff4>" ]</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>      }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    in</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      nixosConfigurations</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        rpi4-01</span><span style=color:#81a1c1> =</span><span> nixpkgs</span><span style=color:#81a1c1>.</span><span>lib</span><span style=color:#81a1c1>.</span><span>nixosSystem</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>          system</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>aarch64-linux</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>          specialArgs</span><span style=color:#81a1c1> =</span><span> spec</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>          modules</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> [</span><span style=color:#a3be8c> ./hosts/rpi4-01.nix</span><span style=color:#eceff4> ]</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#616e88>        # ... per host...</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        rpi4-04</span><span style=color:#81a1c1> =</span><span> nixpkgs</span><span style=color:#81a1c1>.</span><span>lib</span><span style=color:#81a1c1>.</span><span>nixosSystem</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>          system</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>aarch64-linux</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>          specialArgs</span><span style=color:#81a1c1> =</span><span> spec</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>          modules</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> [</span><span style=color:#a3be8c> ./hosts/rpi4-04.nix</span><span style=color:#eceff4> ]</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>      }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>      deploy</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>        # Deployment options applied to all nodes</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        sshUser</span><span style=color:#81a1c1> =</span><span> spec</span><span style=color:#81a1c1>.</span><span>user</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#616e88>        # User to which profile will be deployed.</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        user</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>root</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        sshOpts</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> [ "</span><span style=color:#a3be8c>-p</span><span style=color:#eceff4>" "</span><span style=color:#a3be8c>22</span><span style=color:#eceff4>" "</span><span style=color:#a3be8c>-F</span><span style=color:#eceff4>" "</span><span style=color:#a3be8c>./ssh.config</span><span style=color:#eceff4>" ]</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        fastConnection</span><span style=color:#81a1c1> = false;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        autoRollback</span><span style=color:#81a1c1> = true;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        magicRollback</span><span style=color:#81a1c1> = true;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>        # Or setup cross compilation</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        remoteBuild</span><span style=color:#81a1c1> = true;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        nodes</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>          rpi4-01</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            hostname</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>rpi4-01</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            profiles</span><span>.</span><span style=color:#8fbcbb>system</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>              path</span><span style=color:#81a1c1> =</span><span> deploy-rs</span><span style=color:#81a1c1>.</span><span>lib</span><span style=color:#81a1c1>.</span><span>aarch64-linux</span><span style=color:#81a1c1>.</span><span>activate</span><span style=color:#81a1c1>.</span><span>nixos</span></span>
<span class=giallo-l><span>                self</span><span style=color:#81a1c1>.</span><span>nixosConfigurations</span><span style=color:#81a1c1>.</span><span>rpi4-01</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>          }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#616e88>          # ... per host</span></span>
<span class=giallo-l><span style=color:#8fbcbb>          rpi4-04</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            hostname</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>rpi4-04</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            profiles</span><span>.</span><span style=color:#8fbcbb>system</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>              path</span><span style=color:#81a1c1> =</span><span> deploy-rs</span><span style=color:#81a1c1>.</span><span>lib</span><span style=color:#81a1c1>.</span><span>aarch64-linux</span><span style=color:#81a1c1>.</span><span>activate</span><span style=color:#81a1c1>.</span><span>nixos</span></span>
<span class=giallo-l><span>                self</span><span style=color:#81a1c1>.</span><span>nixosConfigurations</span><span style=color:#81a1c1>.</span><span>rpi4-04</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>          }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>      }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>      checks</span><span style=color:#81a1c1> = builtins.</span><span>mapAttrs</span></span>
<span class=giallo-l><span style=color:#eceff4>        (</span><span>system</span><span style=color:#eceff4>:</span><span> deployLib</span><span style=color:#eceff4>:</span><span> deployLib</span><span style=color:#81a1c1>.</span><span>deployChecks self</span><span style=color:#81a1c1>.</span><span>deploy</span><span style=color:#eceff4>)</span><span> deploy-rs</span><span style=color:#81a1c1>.</span><span>lib</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span><span style=color:#81a1c1> //</span><span> flake-utils</span><span style=color:#81a1c1>.</span><span>lib</span><span style=color:#81a1c1>.</span><span>eachDefaultSystem</span><span style=color:#eceff4> (</span><span>system</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#81a1c1>      let</span><span style=color:#8fbcbb> pkgs</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> import</span><span> nixpkgs</span><span style=color:#eceff4> {</span><span style=color:#81a1c1> inherit</span><span style=color:#8fbcbb> system</span><span style=color:#81a1c1>;</span><span style=color:#eceff4> }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>      in</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        devShells</span><span>.</span><span style=color:#8fbcbb>default</span><span style=color:#81a1c1> =</span></span>
<span class=giallo-l><span>          pkgs</span><span style=color:#81a1c1>.</span><span>mkShell</span><span style=color:#eceff4> {</span><span style=color:#8fbcbb> buildInputs</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> [</span><span> pkgs</span><span style=color:#81a1c1>.</span><span>deploy-rs pkgs</span><span style=color:#81a1c1>.</span><span>nixfmt</span><span style=color:#eceff4> ]</span><span style=color:#81a1c1>;</span><span style=color:#eceff4> }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>      })</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><h2 id=raspberry-pinoshe-ding><a aria-label="Anchor link for: raspberry-pinoshe-ding" class=zola-anchor href=#raspberry-pinoshe-ding>Raspberry Piã®è¨­å®š</a></h2><p>ã¾ãšã¯raspiã®è¨­å®šã‚’è¡Œã£ã¦ã„ãã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=nix><span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  inputs</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    nixpkgs</span><span>.</span><span style=color:#8fbcbb>url</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>github:NixOS/nixpkgs/nixpkgs-unstable</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span><span> </span></span>
<span class=giallo-l><span style=color:#616e88>    # ...</span></span>
<span class=giallo-l><span style=color:#eceff4>  }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>  outputs</span><span style=color:#81a1c1> =</span></span>
<span class=giallo-l><span style=color:#eceff4>    {</span><span> self</span><span style=color:#81a1c1>,</span><span> nixpkgs</span><span style=color:#81a1c1>, ...</span><span style=color:#eceff4>}:</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      spec</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        user</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>ymgyt</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        defaultGateway</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>192.168.10.1</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        nameservers</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> [ "</span><span style=color:#a3be8c>8.8.8.8</span><span style=color:#eceff4>" ]</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>      }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    in</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      nixosConfigurations</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        rpi4-01</span><span style=color:#81a1c1> =</span><span> nixpkgs</span><span style=color:#81a1c1>.</span><span>lib</span><span style=color:#81a1c1>.</span><span>nixosSystem</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>          system</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>aarch64-linux</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>          specialArgs</span><span style=color:#81a1c1> =</span><span> spec</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>          modules</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> [</span><span style=color:#a3be8c> ./hosts/rpi4-01.nix</span><span style=color:#eceff4> ]</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#616e88>      # ...</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>raspiã®host <code>rpi4-01</code>ã®è¨­å®šã¯ä¸Šè¨˜ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚<br> hoståã¯<a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-install-nixos/ rel=external>Part 1</a>ã§è¨­å®šã—ã¦ã‚ã‚‹å‰æã§ã™ã€‚<br> è¨­å®šè‡ªä½“ã¯é€šå¸¸ã®<code>nixosConfigurations</code>ã§è¡Œã„ã¾ã™ã€‚<br> <code>specialArgc = spce</code>ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§moduleã‹ã‚‰<code>spec</code>ã®fieldã‚’å‚ç…§ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã‚ã‚Šã¾ã™ã€‚<br> <code>system</code>ã¯raspiãªã®ã§<code>aarch64-linux</code>ã‚’æŒ‡å®šã—ã¾ã—ãŸã€‚<p>èª¿ã¹æ–¹ã¨ã—ã¦ã¯<code>nix repl</code>ã‚’åˆ©ç”¨ã—ã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>$</span><span style=color:#a3be8c> nix repl</span></span>
<span class=giallo-l><span style=color:#88c0d0>Welcome</span><span style=color:#a3be8c> to Nix 2.17.0. Type :? for help.</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>nix-repl</span><span>></span><span style=color:#a3be8c> builtins.currentSystem</span></span>
<span class=giallo-l><span style=color:#88c0d0>"aarch64-linux"</span></span></code></pre><p>moduleã¨ã—ã¦å‚ç…§ã—ã¦ã„ã‚‹<code>./hosts/rpi4-01.nix</code>ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=nix><span class=giallo-l><span style=color:#eceff4>{</span><span> defaultGateway</span><span style=color:#81a1c1>,</span><span> nameservers</span><span style=color:#81a1c1>, ...</span><span style=color:#eceff4> }: {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  imports</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> [</span><span style=color:#a3be8c> ../modules/rpi4.nix</span><span style=color:#eceff4> ]</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>  networking</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    inherit</span><span style=color:#8fbcbb> defaultGateway nameservers</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    hostName</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>rpi4-01</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    interfaces</span><span>.</span><span style=color:#8fbcbb>end0</span><span>.</span><span style=color:#8fbcbb>ipv4</span><span>.</span><span style=color:#8fbcbb>addresses</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> [{</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      address</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>192.168.10.150</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      prefixLength</span><span style=color:#81a1c1> =</span><span style=color:#b48ead> 24</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }]</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    wireless</span><span>.</span><span style=color:#8fbcbb>enable</span><span style=color:#81a1c1> = false;</span></span>
<span class=giallo-l><span style=color:#eceff4>  }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>hosts/</code>é…ä¸‹ã¯hostæ¯ã®è¨­å®šã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚<br> åŸºæœ¬çš„ã«ã¯<a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-install-nixos/ rel=external>Part 1</a>ã§ãŠã“ãªã£ãŸè¨­å®šã‹ã‚‰hostå›ºæœ‰ã®è¨­å®šã‚’ã“ã“ã§å®šç¾©ã—ã¦ã„ã¾ã™ã€‚<br> raspiãã‚Œãã‚Œã§å…±é€šã™ã‚‹è¨­å®šã¯<code>modules/rpi4.nix</code>ã«å®šç¾©ã—ã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=nix><span class=giallo-l><span style=color:#616e88># Common settings for Raspberry Pi4 Model B</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span><span> pkgs</span><span style=color:#81a1c1>,</span><span> user</span><span style=color:#81a1c1>, ...</span><span style=color:#eceff4> }: {</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>  boot</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>    # ...</span></span>
<span class=giallo-l><span style=color:#eceff4>  }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>  fileSystems</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>    # ...</span></span>
<span class=giallo-l><span style=color:#eceff4>  }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>  environment</span><span>.</span><span style=color:#8fbcbb>systemPackages</span><span style=color:#81a1c1> = with</span><span> pkgs;</span><span style=color:#eceff4> [</span><span> helix bottom bat</span><span style=color:#eceff4> ]</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>  # ...</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  users</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>    # ...</span></span>
<span class=giallo-l><span style=color:#eceff4>  }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  security</span><span>.</span><span style=color:#8fbcbb>sudo</span><span>.</span><span style=color:#8fbcbb>wheelNeedsPassword</span><span style=color:#81a1c1> = false;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>  hardware</span><span>.</span><span style=color:#8fbcbb>enableRedistributableFirmware</span><span style=color:#81a1c1> = true;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  system</span><span>.</span><span style=color:#8fbcbb>stateVersion</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>23.11</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>è¨­å®šè‡ªä½“ã¯<a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-install-nixos/ rel=external>Part 1</a>ã¨åŒã˜ã§ã™ã€‚<h2 id=deploy-rs><a aria-label="Anchor link for: deploy-rs" class=zola-anchor href=#deploy-rs>deploy-rs</a></h2><p>ç¶šã„ã¦å®šç¾©ã—ãŸraspiã®è¨­å®šã‚’deployã™ã‚‹æ–¹æ³•ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚ã€€<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=nix><span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  inputs</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>    # ...</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    deploy-rs</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      url</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>github:serokell/deploy-rs</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      inputs</span><span>.</span><span style=color:#8fbcbb>nixpkgs</span><span>.</span><span style=color:#8fbcbb>follows</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>nixpkgs</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      inputs</span><span>.</span><span style=color:#8fbcbb>utils</span><span>.</span><span style=color:#8fbcbb>follows</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>flake-utils</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>  }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>  outputs</span><span style=color:#81a1c1> =</span></span>
<span class=giallo-l><span style=color:#eceff4>    {</span><span> self</span><span style=color:#81a1c1>,</span><span> nixpkgs</span><span style=color:#81a1c1>,</span><span> deploy-rs</span><span style=color:#81a1c1>, ...</span><span style=color:#eceff4>}:</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span></span>
<span class=giallo-l><span style=color:#616e88>     # ...</span></span>
<span class=giallo-l><span style=color:#81a1c1>    in</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      nixosConfigurations</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        rpi4-01</span><span style=color:#81a1c1> =</span><span> nixpkgs</span><span style=color:#81a1c1>.</span><span>lib</span><span style=color:#81a1c1>.</span><span>nixosSystem</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>          system</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>aarch64-linux</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>          specialArgs</span><span style=color:#81a1c1> =</span><span> spec</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>          modules</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> [</span><span style=color:#a3be8c> ./hosts/rpi4-01.nix</span><span style=color:#eceff4> ]</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#616e88>        # ...</span></span>
<span class=giallo-l><span style=color:#eceff4>      }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>      deploy</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>        # Deployment options applied to all nodes</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        sshUser</span><span style=color:#81a1c1> =</span><span> spec</span><span style=color:#81a1c1>.</span><span>user</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#616e88>        # User to which profile will be deployed.</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        user</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>root</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        sshOpts</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> [ "</span><span style=color:#a3be8c>-p</span><span style=color:#eceff4>" "</span><span style=color:#a3be8c>22</span><span style=color:#eceff4>" "</span><span style=color:#a3be8c>-F</span><span style=color:#eceff4>" "</span><span style=color:#a3be8c>./etc/ssh.config</span><span style=color:#eceff4>" ]</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        fastConnection</span><span style=color:#81a1c1> = false;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        autoRollback</span><span style=color:#81a1c1> = true;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        magicRollback</span><span style=color:#81a1c1> = true;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>        # Or setup cross compilation</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        remoteBuild</span><span style=color:#81a1c1> = true;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        nodes</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>          rpi4-01</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            hostname</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>rpi4-01</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            profiles</span><span>.</span><span style=color:#8fbcbb>system</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>              path</span><span style=color:#81a1c1> =</span><span> deploy-rs</span><span style=color:#81a1c1>.</span><span>lib</span><span style=color:#81a1c1>.</span><span>aarch64-linux</span><span style=color:#81a1c1>.</span><span>activate</span><span style=color:#81a1c1>.</span><span>nixos</span></span>
<span class=giallo-l><span>                self</span><span style=color:#81a1c1>.</span><span>nixosConfigurations</span><span style=color:#81a1c1>.</span><span>rpi4-01</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>          }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#616e88>          # for each node...</span></span>
<span class=giallo-l><span style=color:#8fbcbb>          rpi4-04</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            hostname</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>rpi4-04</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            profiles</span><span>.</span><span style=color:#8fbcbb>system</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>              path</span><span style=color:#81a1c1> =</span><span> deploy-rs</span><span style=color:#81a1c1>.</span><span>lib</span><span style=color:#81a1c1>.</span><span>aarch64-linux</span><span style=color:#81a1c1>.</span><span>activate</span><span style=color:#81a1c1>.</span><span>nixos</span></span>
<span class=giallo-l><span>                self</span><span style=color:#81a1c1>.</span><span>nixosConfigurations</span><span style=color:#81a1c1>.</span><span>rpi4-04</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>          }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>      }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#616e88>      # ...</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><a href=https://github.com/serokell/deploy-rs rel=external>deploy-rs</a>ã¯flakeã®outputsã«<code>deploy</code>ã‚’æœŸå¾…ã—ã¾ã™ã€‚<br> <code>deploy.{sshUser,user}</code>ç­‰ã¯å„raspiã¸ã®deployå…±é€šã®è¨­å®šã§ã™ã€‚<br> <code>deploy.autoRollback</code>ã¯deployãŒå¤±æ•—ã—ãŸå ´åˆã«å‰å›ã®profileã‚’æœ‰åŠ¹ã«ã—ã¦ãã‚Œã‚‹optionã§ã™ã€‚<br> ã“ã“ã§ã„ã†profileã¯<a href=https://nixos.org/manual/nix/stable/package-management/profiles rel=external>nixã®profile</a>ã®ã“ã¨ã ã¨ç†è§£ã—ã¦ã„ã¾ã™ã€‚ <code>deploy.magicRollback</code>ã«ã¤ã„ã¦ã¯<a href=https://github.com/serokell/deploy-rs#magic-rollback rel=external>README</a>ã«ã‚ˆã‚‹ã¨ãªã‚“ã‚‰ã‹ã®ç†ç”±ã§å¤‰æ›´å¾Œã«deployå¯¾è±¡nodeã¸ã®ç–é€šãŒã§ããªããªã£ãŸå ´åˆã«è‡ªå‹•ã§rollbackã—ã¦ãã‚Œã‚‹è¨­å®šã§ã™ã€‚<p><code>deploy.remoteBuild</code>ã¯trueã‚’è¨­å®šã—ã¦ã„ã¾ã™ã€‚ è‡ªåˆ†ã®host machineã«<code>aarch64-linux</code>ã®ã‚‚ã®ãŒãªãã€nixã®cross compileã‚’ã¾ã è¨­å®šã§ãã¦ã„ãªã„ãŸã‚ã€deployå…ˆã®raspiä¸Šã§buildã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚<p><code>deploy.nodes.${node}</code>ã«deployå¯¾è±¡ã®nodeã‚’è¨­å®šã—ã¾ã™ã€‚<br> nodeã”ã¨ã«profileã‚’æŒ‡å®šã™ã‚‹ã“ã¨ãŒã§ãã“ã‚ŒãŒdeployã®å˜ä½ã¨ãªã‚Šã¾ã™ã€‚profile = roleã¨ã„ã†æ„Ÿã˜ã§ã™ã€‚<br> <code>deploy.nodes.${node}.profiles.${profile}.path</code>ã«ã•ãã»ã©å®šç¾©ã—ãŸnixosConfigurationã‚’æŒ‡å®šã—ã¾ã™ã€‚<p>ã“ã‚Œã§deployã®è¨­å®šã¯å®Œäº†ã§ã™ã€‚<h2 id=shi-ji-nideploy><a aria-label="Anchor link for: shi-ji-nideploy" class=zola-anchor href=#shi-ji-nideploy>å®Ÿéš›ã«deploy</a></h2><p>ã•ã£ããå®šç¾©ã—ãŸè¨­å®šã‚’deployã—ã¦ã¿ã¾ã™ã€‚<br> <code>flake.nix</code>ã®<code>devShell</code>ã«ä»¥ä¸‹ã®ã‚ˆã†ã«deploy-rsã‚’è¿½åŠ ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=nix><span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  inputs</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>    # ...</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    flake-utils</span><span>.</span><span style=color:#8fbcbb>url</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>github:numtide/flake-utils</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>  }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>  outputs</span><span style=color:#81a1c1> =</span></span>
<span class=giallo-l><span style=color:#eceff4>    {</span><span> self</span><span style=color:#81a1c1>,</span><span> nixpkgs</span><span style=color:#81a1c1>,</span><span> deploy-rs</span><span style=color:#81a1c1>,</span><span> flake-utils</span><span style=color:#eceff4>}:</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span></span>
<span class=giallo-l><span style=color:#616e88>      # ...</span></span>
<span class=giallo-l><span style=color:#81a1c1>    in</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>      nixosConfigurations</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>        # ...</span></span>
<span class=giallo-l><span style=color:#eceff4>      }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>      deploy</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>       # ...</span></span>
<span class=giallo-l><span style=color:#eceff4>      }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span><span style=color:#81a1c1> //</span><span> flake-utils</span><span style=color:#81a1c1>.</span><span>lib</span><span style=color:#81a1c1>.</span><span>eachDefaultSystem</span><span style=color:#eceff4> (</span><span>system</span><span style=color:#eceff4>:</span></span>
<span class=giallo-l><span style=color:#81a1c1>      let</span><span style=color:#8fbcbb> pkgs</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> import</span><span> nixpkgs</span><span style=color:#eceff4> {</span><span style=color:#81a1c1> inherit</span><span style=color:#8fbcbb> system</span><span style=color:#81a1c1>;</span><span style=color:#eceff4> }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>      in</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        devShells</span><span>.</span><span style=color:#8fbcbb>default</span><span style=color:#81a1c1> =</span></span>
<span class=giallo-l><span>          pkgs</span><span style=color:#81a1c1>.</span><span>mkShell</span><span style=color:#eceff4> {</span><span style=color:#8fbcbb> buildInputs</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> [</span><span> pkgs</span><span style=color:#81a1c1>.</span><span>deploy-rs pkgs</span><span style=color:#81a1c1>.</span><span>nixfmt</span><span style=color:#eceff4> ]</span><span style=color:#81a1c1>;</span><span style=color:#eceff4> }</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>      })</span><span style=color:#81a1c1>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã“ã‚Œã§<code>nix develop -c nu</code>ã‚‚ã—ãã¯<code>direnv</code>ã§<code>deploy</code>ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã™ã€‚<p>ã¾ãšã¯1å°ã«deployã—ã¦ã¿ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#81a1c1>></span><span> deploy --interactive --skip-checks .#rpi4-01</span></span>
<span class=giallo-l><span style=color:#88c0d0>ğŸš€</span><span style=color:#a3be8c> â„¹</span><span> [deploy] </span><span style=color:#eceff4>[</span><span>INFO</span><span style=color:#eceff4>]</span><span> Evaluating flake in </span><span style=color:#88c0d0>.</span></span>
<span class=giallo-l><span style=color:#88c0d0>ğŸš€</span><span style=color:#a3be8c> â„¹</span><span> [deploy] </span><span style=color:#eceff4>[</span><span>INFO</span><span style=color:#eceff4>]</span><span> The following profiles are going to be deployed:</span></span>
<span class=giallo-l><span style=color:#eceff4>[</span><span>rpi4-01.system</span><span style=color:#eceff4>]</span></span>
<span class=giallo-l><span style=color:#88c0d0>user</span><span style=color:#a3be8c> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>root</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#88c0d0>ssh_user</span><span style=color:#a3be8c> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>ymgyt</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#88c0d0>path</span><span style=color:#a3be8c> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>/nix/store/x901jwam6nzwgfxyzy7wa5hahm33fb93-activatable-nixos-system-rpi4-01-23.11.20230920.fe97767</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#88c0d0>hostname</span><span style=color:#a3be8c> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>rpi4-01</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#88c0d0>ssh_opts</span><span style=color:#a3be8c> =</span><span> [</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>-p</span><span style=color:#eceff4>"</span><span>,</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>22</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>,</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>-F</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>,</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>./etc/ssh.config</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>]</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>ğŸš€</span><span style=color:#a3be8c> â„¹</span><span> [deploy] </span><span style=color:#eceff4>[</span><span>INFO</span><span style=color:#eceff4>]</span><span> Are you sure you want to deploy these profiles</span><span style=color:#81a1c1>?</span></span>
<span class=giallo-l><span style=color:#81a1c1>></span><span> yes</span></span>
<span class=giallo-l><span style=color:#88c0d0>ğŸš€</span><span style=color:#a3be8c> â„¹</span><span> [deploy] </span><span style=color:#eceff4>[</span><span>INFO</span><span style=color:#eceff4>]</span><span> Building profile </span><span style=color:#eceff4>`</span><span style=color:#88c0d0>system</span><span style=color:#eceff4>`</span><span style=color:#81a1c1> for</span><span> node </span><span style=color:#eceff4>`</span><span style=color:#88c0d0>rpi4-01</span><span style=color:#eceff4>`</span><span style=color:#88c0d0> on</span><span style=color:#a3be8c> remote host</span></span>
<span class=giallo-l><span style=color:#88c0d0>ğŸš€</span><span style=color:#a3be8c> â„¹</span><span> [deploy] </span><span style=color:#eceff4>[</span><span>INFO</span><span style=color:#eceff4>]</span><span> Activating profile </span><span style=color:#eceff4>`</span><span style=color:#88c0d0>system</span><span style=color:#eceff4>`</span><span style=color:#81a1c1> for</span><span> node </span><span style=color:#eceff4>`</span><span style=color:#88c0d0>rpi4-01</span><span style=color:#eceff4>`</span></span>
<span class=giallo-l><span style=color:#88c0d0>ğŸš€</span><span style=color:#a3be8c> â„¹</span><span> [deploy] </span><span style=color:#eceff4>[</span><span>INFO</span><span style=color:#eceff4>]</span><span> Creating activation waiter</span></span>
<span class=giallo-l><span style=color:#88c0d0>ğŸ‘€</span><span style=color:#a3be8c> â„¹</span><span> [wait] </span><span style=color:#eceff4>[</span><span>INFO</span><span style=color:#eceff4>]</span><span> Waiting </span><span style=color:#81a1c1>for</span><span> confirmation event...</span></span>
<span class=giallo-l><span style=color:#88c0d0>â­</span><span style=color:#a3be8c> â„¹</span><span> [activate] </span><span style=color:#eceff4>[</span><span>INFO</span><span style=color:#eceff4>]</span><span> Activating profile</span></span>
<span class=giallo-l><span style=color:#88c0d0>activating</span><span style=color:#a3be8c> the configuration...</span></span>
<span class=giallo-l><span style=color:#88c0d0>setting</span><span style=color:#a3be8c> up /etc...</span></span>
<span class=giallo-l><span style=color:#88c0d0>reloading</span><span style=color:#a3be8c> user units for ymgyt...</span></span>
<span class=giallo-l><span style=color:#88c0d0>setting</span><span style=color:#a3be8c> up tmpfiles</span></span>
<span class=giallo-l><span style=color:#88c0d0>reloading</span><span style=color:#a3be8c> the following units: dbus.service</span></span>
<span class=giallo-l><span style=color:#88c0d0>â­</span><span style=color:#a3be8c> â„¹</span><span> [activate] </span><span style=color:#eceff4>[</span><span>INFO</span><span style=color:#eceff4>]</span><span> Activation succeeded</span><span style=color:#81a1c1>!</span></span>
<span class=giallo-l><span style=color:#88c0d0>â­</span><span style=color:#a3be8c> â„¹</span><span> [activate] </span><span style=color:#eceff4>[</span><span>INFO</span><span style=color:#eceff4>]</span><span> Magic rollback is enabled, setting up confirmation hook...</span></span>
<span class=giallo-l><span style=color:#88c0d0>â­</span><span style=color:#a3be8c> â„¹</span><span> [activate] </span><span style=color:#eceff4>[</span><span>INFO</span><span style=color:#eceff4>]</span><span> Waiting </span><span style=color:#81a1c1>for</span><span> confirmation event...</span></span>
<span class=giallo-l><span style=color:#88c0d0>ğŸ‘€</span><span style=color:#a3be8c> â„¹</span><span> [wait] </span><span style=color:#eceff4>[</span><span>INFO</span><span style=color:#eceff4>]</span><span> Found canary file, </span><span style=color:#81a1c1>done</span><span> waiting</span><span style=color:#81a1c1>!</span></span>
<span class=giallo-l><span style=color:#88c0d0>ğŸš€</span><span style=color:#a3be8c> â„¹</span><span> [deploy] </span><span style=color:#eceff4>[</span><span>INFO</span><span style=color:#eceff4>]</span><span> Success activating, attempting to confirm activation</span></span>
<span class=giallo-l><span style=color:#88c0d0>ğŸš€</span><span style=color:#a3be8c> â„¹</span><span> [deploy] </span><span style=color:#eceff4>[</span><span>INFO</span><span style=color:#eceff4>]</span><span> Deployment confirmed.</span></span></code></pre><p>ç„¡äº‹deployã§ãã¾ã—ãŸã€‚<br> <code>--skip-checks</code>ã¯<a href=https://github.com/serokell/deploy-rs/issues/216 rel=external>hostã¨remoteã®systemãŒé•ã†ã¨ç¾çŠ¶ã ã¨ã†ã¾ãcheckãŒå‹•ã‹ãªã„ã‚ˆã†ãªã®ã§</a>ã¤ã‘ã¦ã„ã¾ã™ã€‚<p>ã“ã‚Œã§raspiã®nixosConfigurationã‚’åæ˜ ã•ã›ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸã®ã§ã•ã£ããè¨­å®šã‚’å¤‰æ›´ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚<br> ç¾çŠ¶ã§ã¯time zoneã‚’è¨­å®šã—ã¦ã„ãªã„ã®ã§ã“ã‚Œã‚’è¨­å®šã—ã¦ã¿ã¾ã™ã€‚<p><code>./modules/rpi4.nix</code>ã«<code>time.timeZone = "Asia/Tokyo";</code>ã‚’è¿½åŠ ã—ã¾ã™ã€‚ä»Šåº¦ã¯å…¨å°ã«åæ˜ ã•ã›ãŸã„ã®ã§<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>deploy</span><span style=color:#a3be8c> --skip-checks --interactive .</span></span></code></pre><p>ã‚’å®Ÿè¡Œã—ã¦ã¿ã¾ã™ã€‚ æˆåŠŸã—ãŸã‚‰<a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-install-nixos/ rel=external>Part 1</a>ã§ä½œæˆã—ãŸzellij layoutã‚’ä½¿ã£ã¦sshã—ãŸã®ã¡<code>timedatectl</code>ã‚’å®Ÿè¡Œã—ã¦ã¿ã¾ã™ã€‚<figure><div class=fig-images-row><img , alt src=images/ss-timedatectl.png></div><figcaption>timedatectlã®å®Ÿè¡Œçµæœ</figcaption></figure><p>ç„¡äº‹ã€time zoneãŒ<code>Asia/Tokyo</code>ã«å¤‰æ›´ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸã€‚<p><a href=https://blog.ymgyt.io/entry/homeserver-with-nixos-and-raspberrypi-secret-management-with-ragenix/ rel=external>Part 3</a>ã§ã¯raspiä¸Šã§serviceã‚’å‹•ã‹ã™ãŸã‚ã«å¿…è¦ãªsecretã‚’ç®¡ç†ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ãã¾ã™ã€‚</div></article></main><footer class=blog-footer><p>Â© 2026 <a href=https://blog.ymgyt.io> ymgyt </a> | Made with <a href=https://www.getzola.org rel=noopener target=_blank>Zola</a> | <a href=https://github.com/ymgyt/blog>Repository</a> | <a href=https://blog.ymgyt.io/atom.xml target=_blank title=rss> <svg viewbox="0 0 24 24" class=icon fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx=5 cy=19 r=1></circle></svg> </a></footer></div></div>