<!doctype html><html lang=ja><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1" name=viewport><link href=https://blog.ymgyt.io/favicon.ico rel=icon sizes=any><link href=https://blog.ymgyt.io/icon.svg rel=icon type=image/svg+xml><link href=https://blog.ymgyt.io/apple-touch-icon.png rel=apple-touch-icon><link href=https://blog.ymgyt.io/manifest.webmanifest rel=manifest><link href=https://blog.ymgyt.io/style.css rel=stylesheet><link href=https://blog.ymgyt.io/atom.xml rel=alternate title=Atom type=application/atom+xml><script src="https://www.googletagmanager.com/gtag/js?id=G-GTB0KMLN90" async></script><script>window.dataLayer = window.dataLayer || [];
	function gtag() {dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-GTB0KMLN90');</script><title>ğŸ—  proc-macro-workshop/builderã‚’ã‚„ã£ã¦ã¿ã‚‹ | Happy developing</title><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><body><div class=world><div class=content-container><header class=blog-header-container><div class=blog-logo><a href=https://blog.ymgyt.io>Happy developing</a></div><div class=blog-nav><nav><ul><li><a href=https://blog.ymgyt.io/entry/>Entries</a><li><a href=https://blog.ymgyt.io/tags/>Tags</a><li><a href=https://blog.ymgyt.io/about/>About</a><li><a href=https://github.com/ymgyt> <img alt=Github class=icon src=https://blog.ymgyt.io/images/icon/github.svg> </a><li><a href="https://twitter.com/YAmaguchixt "> <img alt=Twitter class=icon src=https://blog.ymgyt.io/images/icon/twitter.svg> </a></ul></nav></div></header><main class=blog-main><article><header class=entry-header><h1 class=entry-title>ğŸ— proc-macro-workshop/builderã‚’ã‚„ã£ã¦ã¿ã‚‹</h1><div class=entry-meta><p class=entry-meta-item>ğŸ—“ 2022-10-10<p class=entry-meta-item>ğŸ· <span class=tag><a href=https://blog.ymgyt.io/tags/rust/>rust</a></span></div></header><aside class=entry-toc><nav><ul class=entry-toc-toplevel-list><li><a href=https://blog.ymgyt.io/entry/proc-macro-workshop-builder/#workshopnojin-mefang>workshopã®é€²ã‚æ–¹</a><li><a href=https://blog.ymgyt.io/entry/proc-macro-workshop-builder/#01-parse>01-parse</a><li><a href=https://blog.ymgyt.io/entry/proc-macro-workshop-builder/#02-create-builder>02-create-builder</a><li><a href=https://blog.ymgyt.io/entry/proc-macro-workshop-builder/#03-call-setters>03-call-setters</a><li><a href=https://blog.ymgyt.io/entry/proc-macro-workshop-builder/#04-call-build>04-call-build</a><li><a href=https://blog.ymgyt.io/entry/proc-macro-workshop-builder/#05-method-chaining>05-method-chaining</a><li><a href=https://blog.ymgyt.io/entry/proc-macro-workshop-builder/#06-optional-fields>06-optional-fields</a><li><a href=https://blog.ymgyt.io/entry/proc-macro-workshop-builder/#07-repeated-field>07-repeated-field</a><li><a href=https://blog.ymgyt.io/entry/proc-macro-workshop-builder/#08-unrecognized-attribute>08-unrecognized-attribute</a><li><a href=https://blog.ymgyt.io/entry/proc-macro-workshop-builder/#09-redefined-prelude-type>09-redefined-prelude-type</a><li><a href=https://blog.ymgyt.io/entry/proc-macro-workshop-builder/#matome>ã¾ã¨ã‚</a></ul></nav></aside><div class=entry-content><p>æœ¬è¨˜äº‹ã§ã¯dtolnayå…ˆç”Ÿã®<a href=https://github.com/dtolnay/proc-macro-workshop rel=external>proc-macro-workshop</a>ã®builderã‚’ã‚„ã£ã¦ã„ãã¾ã™ã€‚<br> workshopã¯procedural macrosã®å­¦ç¿’ã‚’ç›®çš„ã«ä½œã‚‰ã‚Œã¦ãŠã‚Šã€workshopå†…ã®å„projectã‚’step by stepã§å®Ÿè£…ã—ã¦ã„ãã“ã¨ã§è‡ªç„¶ã¨procedural macrosã«æ…£ã‚Œã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ æœ¬workshopã®å­˜åœ¨è‡ªä½“ã¯çŸ¥ã£ã¦ã„ãŸã®ã§ã™ãŒé€”ä¸­ã¾ã§ã—ã‹ã§ãã¦ã„ãªã„çŠ¶æ…‹ã§ã—ãŸã€‚<br> ãã‚“ãªä¸­ã§ä»Šåƒã„ã¦ã„ã‚‹<a href=https://fraim.co.jp/ rel=external>fraim</a>ã¨ã„ã†ä¼šç¤¾ã§Rustå‹‰å¼·ä¼šãŒå§‹ã¾ã‚Šã€ãã“ã§é€±ä¸€å›å°‘ã—ã¥ã¤é€²ã‚ã¦ã„ãæ©Ÿä¼šã‚’å¾—ã¾ã—ãŸã€‚(å‰¯æ¥­ã®å‹Ÿé›†ã‚‚ã‚ã‚‹ã®ã§ä»•äº‹ã§Rustã«è§¦ã‚ŒãŸã„æ–¹ç­‰ãŠã‚‰ã‚Œã¾ã—ãŸã‚‰æ˜¯é<a href=https://www.wantedly.com/companies/FRAIM/projects rel=external>å‹Ÿé›†</a>ã‚’è¦—ã„ã¦ã¿ã¦ãã ã•ã„)<h2 id=workshopnojin-mefang><a aria-label="Anchor link for: workshopnojin-mefang" class=zola-anchor href=#workshopnojin-mefang>workshopã®é€²ã‚æ–¹</a></h2><p>workshopã®é€²ã‚æ–¹ã«ã¤ã„ã¦ã€‚<br> ã¾ãšã€<a href=https://github.com/dtolnay/proc-macro-workshop rel=external>proc-macro-workshop</a>ã‚’fork(optional), cloneã—ã¦ãã¾ã™ã€‚<br> projectã®rootã«å„workshopã®projectãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚æœ¬è¨˜äº‹ã§ã¯builderã‚’ãŠã“ãªã£ã¦ã„ãã¾ã™ã®ã§ã€builderã«cdã—ã¾ã™ã€‚<br> ã™ã‚‹ã¨ã€<code>tests/progress.rs</code>ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”¨æ„ã•ã‚Œã¦ãŠã‚Šã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ãªãŒã‚‰å®Ÿè£…ã‚’é€²ã‚ã¦ã„ãã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[test]</span></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> tests</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> t</span><span style=color:#81a1c1> =</span><span> trybuild</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>TestCases</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#616e88>    //t.pass("tests/01-parse.rs");</span></span>
<span class=giallo-l><span style=color:#616e88>    //t.pass("tests/02-create-builder.rs");</span></span>
<span class=giallo-l><span style=color:#616e88>    //t.pass("tests/03-call-setters.rs");</span></span>
<span class=giallo-l><span style=color:#616e88>    //t.pass("tests/04-call-build.rs");</span></span>
<span class=giallo-l><span style=color:#616e88>    //t.pass("tests/05-method-chaining.rs");</span></span>
<span class=giallo-l><span style=color:#616e88>    //t.pass("tests/06-optional-field.rs");</span></span>
<span class=giallo-l><span style=color:#616e88>    //t.pass("tests/07-repeated-field.rs");</span></span>
<span class=giallo-l><span style=color:#616e88>    //t.compile_fail("tests/08-unrecognized-attribute.rs");</span></span>
<span class=giallo-l><span style=color:#616e88>    //t.pass("tests/09-redefined-prelude-types.rs");</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>æœ€åˆã¯<code>t.pass()</code>ãŒã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã•ã‚Œã¦ãŠã‚Šã€ä¸€ã¤ãšã¤ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‚’å¤–ã—ãªãŒã‚‰é€²ã‚ã¦ã„ãã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> tests</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> t</span><span style=color:#81a1c1> =</span><span> trybuild</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>TestCases</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span>    t</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>pass</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>tests/01-parse.rs</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><h2 id=01-parse><a aria-label="Anchor link for: 01-parse" class=zola-anchor href=#01-parse><code>01-parse</code></a></h2><p>ã¾ãšã¯<code>01-parse.rs</code>ã‚’æœ‰åŠ¹ã«ã—ã¾ã™ã€‚<br> <code>01-parse.rs</code>ã¯ä»¥ä¸‹ã®å†…å®¹ã«ãªã£ã¦ã„ã¾ã™ã€‚(commentã¯å‰²æ„›)<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> derive_builder</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Builder</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Builder</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> Command</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    executable</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    args</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Vec</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>    env</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Vec</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>    current_dir</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {}</span></span></code></pre><p>å®šç¾©ã•ã‚Œã¦ã„ã‚‹<code>Command</code>structã«<code>derive(Builder)</code>ãŒå®£è¨€ã•ã‚Œã¦ã„ã¾ã™ã€‚ã“ã®æ§˜ã«ä»»æ„ã®structã«deriveã—ã¦builderã‚’ç”Ÿæˆã™ã‚‹ã®ãŒæœ¬projectã®ç›®æ¨™ã§ã™ã€‚<br> <code>01-parse.rs</code>ã§ã¯builderã®å‡¦ç†ãŒã‚ˆã³ã ã•ã‚Œã¦ã„ãªã„ã®ã§ã¨ã‚Šã‚ãˆãšcompileã‚’é€šã›ã°ã‚ˆã„ã ã‘ã§ã™ã€‚ è‚å¿ƒã®builderã®å®Ÿè£…ã¯<code>src/lib.rs</code>ã«æ›¸ã„ã¦ã„ãã¾ã™ã€‚<br> <code>lib.rs</code>ã¯åˆæœŸçŠ¶æ…‹ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> proc_macro</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>TokenStream</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[proc_macro_derive(</span><span style=color:#8fbcbb>Builder</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub fn</span><span style=color:#88c0d0> derive</span><span style=color:#eceff4>(</span><span>input</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> TokenStream</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> TokenStream</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> _</span><span style=color:#81a1c1> =</span><span> input</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    unimplemented!</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã“ã®çŠ¶æ…‹ã§<code>cargo test --quiet</code>ã‚’å®Ÿè¡Œã™ã‚‹ã¨not implementedã¨ãªã‚Šå¤±æ•—ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>â¯</span><span style=color:#a3be8c> cargo test --quiet</span></span>
<span class=giallo-l><span style=color:#88c0d0>running</span><span style=color:#b48ead> 0</span><span style=color:#a3be8c> tests</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>test</span><span style=color:#a3be8c> result: ok.</span><span style=color:#b48ead> 0</span><span style=color:#a3be8c> passed</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 0</span><span style=color:#a3be8c> failed</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 0</span><span style=color:#a3be8c> ignored</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 0</span><span style=color:#a3be8c> measured</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 0</span><span style=color:#a3be8c> filtered out</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> finished</span><span style=color:#a3be8c> in 0.00s</span></span>
<span class=giallo-l></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>running</span><span style=color:#b48ead> 1</span><span style=color:#a3be8c> test</span></span>
<span class=giallo-l><span style=color:#88c0d0>   Compiling</span><span style=color:#a3be8c> derive_builder-tests v0.0.0</span><span> (/Users/ymgyt/rs/proc-macro-workshop-blog/target/tests/derive_builder)</span></span>
<span class=giallo-l><span style=color:#88c0d0>    Finished</span><span style=color:#a3be8c> dev</span><span> [unoptimized</span><span style=color:#a3be8c> + debuginfo] target</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>s</span><span style=color:#eceff4>)</span><span style=color:#a3be8c> in 0.12s</span></span>
<span class=giallo-l></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>test</span><span style=color:#a3be8c> tests/01-parse.rs ... error</span></span>
<span class=giallo-l><span style=color:#88c0d0>â”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆ</span></span>
<span class=giallo-l><span style=color:#88c0d0>error:</span><span style=color:#a3be8c> proc-macro derive panicked</span></span>
<span class=giallo-l><span style=color:#88c0d0>  --</span><span>></span><span style=color:#a3be8c> tests/01-parse.rs:26:10</span></span>
<span class=giallo-l><span style=color:#81a1c1>   |</span></span>
<span class=giallo-l><span style=color:#88c0d0>26</span><span style=color:#81a1c1> |</span><span style=color:#616e88> #[derive(Builder)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>   |</span><span style=color:#88c0d0>          ^^^^^^^</span></span>
<span class=giallo-l><span style=color:#81a1c1>   |</span></span>
<span class=giallo-l><span style=color:#a3be8c>   = help: message: not implemented</span></span>
<span class=giallo-l><span style=color:#88c0d0>â”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆ</span></span></code></pre><p>ä»Šå›ã¯compileã•ãˆé€šã›ã°ã‚ˆã„ã®ã§ç©ºã®<code>TokenStream</code>ã‚’è¿”ã—ã¦ã¿ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[proc_macro_derive(</span><span style=color:#8fbcbb>Builder</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub fn</span><span style=color:#88c0d0> derive</span><span style=color:#eceff4>(</span><span>input</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> TokenStream</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> TokenStream</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> _</span><span style=color:#81a1c1> =</span><span> input</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    TokenStream</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>â¯</span><span style=color:#a3be8c> cargo test --quiet</span></span>
<span class=giallo-l><span style=color:#88c0d0>running</span><span style=color:#b48ead> 0</span><span style=color:#a3be8c> tests</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>test</span><span style=color:#a3be8c> result: ok.</span><span style=color:#b48ead> 0</span><span style=color:#a3be8c> passed</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 0</span><span style=color:#a3be8c> failed</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 0</span><span style=color:#a3be8c> ignored</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 0</span><span style=color:#a3be8c> measured</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 0</span><span style=color:#a3be8c> filtered out</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> finished</span><span style=color:#a3be8c> in 0.00s</span></span>
<span class=giallo-l></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>running</span><span style=color:#b48ead> 1</span><span style=color:#a3be8c> test</span></span>
<span class=giallo-l><span style=color:#88c0d0>   Compiling</span><span style=color:#a3be8c> derive_builder v0.0.0</span><span> (/Users/ymgyt/rs/proc-macro-workshop-blog/builder)</span></span>
<span class=giallo-l><span style=color:#88c0d0>   Compiling</span><span style=color:#a3be8c> derive_builder-tests v0.0.0</span><span> (/Users/ymgyt/rs/proc-macro-workshop-blog/target/tests/derive_builder)</span></span>
<span class=giallo-l><span style=color:#88c0d0>    Finished</span><span style=color:#a3be8c> dev</span><span> [unoptimized</span><span style=color:#a3be8c> + debuginfo] target</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>s</span><span style=color:#eceff4>)</span><span style=color:#a3be8c> in 0.28s</span></span>
<span class=giallo-l></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>test</span><span style=color:#a3be8c> tests/01-parse.rs ... ok</span></span></code></pre><p>ã“ã‚Œã§<code>01-parse.rs</code>ã‚’ãƒ‘ã‚¹ã§ãã¾ã—ãŸğŸ‰<br> åŸºæœ¬çš„ãªæµã‚Œã¯å¾Œã¯åŒã˜ã§testã‚’é€šã—ãªãŒã‚‰Builderã‚’ä½œã£ã¦ã„ãã¾ã™ã€‚<h2 id=02-create-builder><a aria-label="Anchor link for: 02-create-builder" class=zola-anchor href=#02-create-builder><code>02-create-builder</code></a></h2><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> tests</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> t</span><span style=color:#81a1c1> =</span><span> trybuild</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>TestCases</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span>    t</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>pass</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>tests/02-create-builder.rs</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>02-create-builder.rs</code>ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Builder</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> Command</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    executable</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    args</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Vec</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>    env</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Vec</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>    current_dir</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> builder</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Command</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>builder</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> _</span><span style=color:#81a1c1> =</span><span> builder</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>Command</code>ã«<code>builder</code>methodã‚’ç”Ÿæˆã—ã€<code>CommandBuilder</code>å‹ã‚’è¿”ã›ã°ã‚ˆã•ãã†ã§ã™ã€‚<br> ç”Ÿæˆã™ã‚‹ã‚³ãƒ¼ãƒ‰ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã¨ã—ã¦ã¯<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> CommandBuilder</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>    // field definitions...</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Command</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> builder</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> CommandBuilder</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        CommandBuilder</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>            // initial fields...</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã¨ã„ã†æ„Ÿã˜ã«ãªã‚Šãã†ã§ã™ã€‚å…·ä½“çš„ã«ã¯<ul><li><code>CommandBuilder</code>ã®structå®šç¾©<li><code>Command</code>ã«<code>builder</code> methodã‚’impl<li><code>CommandBuilder</code>ã®åˆæœŸåŒ–å‡¦ç†</ul><p>ã‚’å®Ÿè£…ã—ã¾ã™ã€‚å®Ÿè£…ã«ç€æ‰‹ã™ã‚‹å‰ã«å¿…è¦ãªä¾å­˜ã‚’è¿½åŠ ã—ã¾ã™ã€‚<br> <code>cargo add syn quote proc-macro2</code>ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=toml><span class=giallo-l><span style=color:#eceff4>[</span><span>dependencies</span><span style=color:#eceff4>]</span></span>
<span class=giallo-l><span>proc-macro2</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>1.0.46</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span>quote</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>1.0.21</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span>syn</span><span style=color:#eceff4> = {</span><span> version</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>1.0.102</span><span style=color:#eceff4>",</span><span> features</span><span style=color:#eceff4> = ["</span><span style=color:#a3be8c>full</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>extra-traits</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>parsing</span><span style=color:#eceff4>"] }</span></span></code></pre><p>testã§ã¯builderã«ç‰¹ã«å‡¦ç†ãŒå¿…è¦ãªã„ã®ã§ç©ºã®builderã‚’ç”Ÿæˆã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚<br> æœ€åˆã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> proc_macro</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>TokenStream</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> quote</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span>format_ident</span><span style=color:#eceff4>,</span><span> quote</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> syn</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>Data</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> DataStruct</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> DeriveInput</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Fields</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> FieldsNamed</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>,</span><span> parse_macro_input</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Error</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> syn</span><span style=color:#81a1c1>::</span><span>spanned</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Spanned</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> proc_macro2</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>TokenStream</span><span style=color:#81a1c1> as</span><span style=color:#8fbcbb> TokenStream2</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[proc_macro_derive(</span><span style=color:#8fbcbb>Builder</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub fn</span><span style=color:#88c0d0> derive</span><span style=color:#eceff4>(</span><span>input</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> TokenStream</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> TokenStream</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> input</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> DeriveInput</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0;font-weight:700> parse_macro_input!</span><span style=color:#eceff4>(</span><span>input</span><span style=color:#81a1c1> as</span><span style=color:#8fbcbb> DeriveInput</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    match</span><span style=color:#88c0d0> derive_builder</span><span style=color:#eceff4>(</span><span>input</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Ok</span><span style=color:#eceff4>(</span><span>token_stream</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> TokenStream</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from</span><span style=color:#eceff4>(</span><span>token_stream</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Err</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> TokenStream</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_compile_error</span><span style=color:#eceff4>())</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> derive_builder</span><span style=color:#eceff4>(</span><span>input</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> DeriveInput</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>TokenStream2</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    if let</span><span style=color:#8fbcbb> Data</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Struct</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>DataStruct</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                            fields</span><span style=color:#81a1c1>:</span><span> Fields</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Named</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>FieldsNamed</span><span style=color:#eceff4> {</span><span> named</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> ..</span><span style=color:#eceff4> }),</span><span style=color:#81a1c1> ..</span></span>
<span class=giallo-l><span style=color:#eceff4>                        })</span><span style=color:#81a1c1> =</span><span> input</span><span style=color:#81a1c1>.</span><span>data </span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> _</span><span style=color:#81a1c1> =</span><span> named</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> ident</span><span style=color:#81a1c1> =</span><span> input</span><span style=color:#81a1c1>.</span><span>ident</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> builder</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0;font-weight:700> format_ident!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{}</span><span style=color:#a3be8c>Builder</span><span style=color:#eceff4>",</span><span>ident</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        Ok</span><span style=color:#eceff4>(</span><span style=color:#88c0d0;font-weight:700>quote!</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>           struct</span><span> #builder</span><span style=color:#eceff4> {}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>           impl</span><span> #ident</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                fn</span><span style=color:#88c0d0> builder</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span> #builder</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                    #builder</span><span style=color:#eceff4> {}</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        })</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Err</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Error</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>input</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>span</span><span style=color:#eceff4>(), "</span><span style=color:#a3be8c>Only struct supported</span><span style=color:#eceff4>"))</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>procedural macroã®æœ€åˆã®èª²é¡Œã¯syn(ã¨quote)ã®apiã«æ…£ã‚Œã‚‹ã“ã¨ã«ã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚<br> åŸºæœ¬çš„ã«<code>TokenStream</code>ã‚’ç›´æ¥æ‰±ã†ã“ã¨ã¯ã›ãšã€synã§Rustã®å‹æƒ…å ±ã‚’è¡¨ã™å‹ã«parseã—ã¾ã™ã€‚ä»Šå›ã¯<code>derive</code>ã«æ›¸ã‹ã‚Œã‚‹å‰æãªã®ã§<code>DeriveInput</code>å‹ã«parseã—ã¾ã™ã€‚<br> ãã“ã‹ã‚‰å¿…è¦ãªæƒ…å ±ã‚’æŠ½å‡ºã—ã¦ã€<code>quote!</code>ã§TokenStreamã‚’çµ„ã¿ç«‹ã¦ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>â¯</span><span style=color:#a3be8c> cargo test --quiet</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>running</span><span style=color:#b48ead> 0</span><span style=color:#a3be8c> tests</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>test</span><span style=color:#a3be8c> result: ok.</span><span style=color:#b48ead> 0</span><span style=color:#a3be8c> passed</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 0</span><span style=color:#a3be8c> failed</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 0</span><span style=color:#a3be8c> ignored</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 0</span><span style=color:#a3be8c> measured</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 0</span><span style=color:#a3be8c> filtered out</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> finished</span><span style=color:#a3be8c> in 0.00s</span></span>
<span class=giallo-l></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>running</span><span style=color:#b48ead> 1</span><span style=color:#a3be8c> test</span></span>
<span class=giallo-l><span style=color:#88c0d0>   Compiling</span><span style=color:#a3be8c> derive_builder v0.0.0</span><span> (/Users/ymgyt/rs/proc-macro-workshop-blog/builder)</span></span>
<span class=giallo-l><span style=color:#88c0d0>   Compiling</span><span style=color:#a3be8c> derive_builder-tests v0.0.0</span><span> (/Users/ymgyt/rs/proc-macro-workshop-blog/target/tests/derive_builder)</span></span>
<span class=giallo-l><span style=color:#88c0d0>    Finished</span><span style=color:#a3be8c> dev</span><span> [unoptimized</span><span style=color:#a3be8c> + debuginfo] target</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>s</span><span style=color:#eceff4>)</span><span style=color:#a3be8c> in 0.34s</span></span>
<span class=giallo-l></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>test</span><span style=color:#a3be8c> tests/02-create-builder.rs ... ok</span></span></code></pre><p>ç„¡äº‹testã‚’ãƒ‘ã‚¹ã—ã¾ã—ãŸã€‚ ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã‚’ç¢ºã‹ã‚ã‚‹æ–¹æ³•ã§ã™ãŒã€test caseã®ã‚³ãƒ¼ãƒ‰ã‚’projectç›´ä¸‹ã®main.rsã«è²¼ã‚Šä»˜ã‘ã¦<code>cargo expand</code>ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ç¢ºã‹ã‚ã‚‰ã‚Œã¾ã™ã€‚è©¦ã—ã«å®Ÿè¡Œã—ã¦ã¿ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#![feature(prelude_import)]</span></span>
<span class=giallo-l><span style=color:#5e81ac>#[prelude_import]</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>prelude</span><span style=color:#81a1c1>::</span><span>rust_2021</span><span style=color:#81a1c1>::*</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#5e81ac>#[macro_use]</span></span>
<span class=giallo-l><span style=color:#81a1c1>extern crate</span><span> std</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> derive_builder</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Builder</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> Command</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    executable</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    args</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Vec</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>    env</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Vec</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>    current_dir</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> CommandBuilder</span><span style=color:#eceff4> {}</span></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Command</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> builder</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> CommandBuilder</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        CommandBuilder</span><span style=color:#eceff4> {}</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> builder</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Command</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>builder</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> _</span><span style=color:#81a1c1> =</span><span> builder</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><h2 id=03-call-setters><a aria-label="Anchor link for: 03-call-setters" class=zola-anchor href=#03-call-setters><code>03-call-setters</code></a></h2><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> tests</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> t</span><span style=color:#81a1c1> =</span><span> trybuild</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>TestCases</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span>    t</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>pass</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>tests/03-call-setters.rs</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>03-call-setters.rs</code>ã§ã¯<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> derive_builder</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Builder</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Builder</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> Command</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    executable</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    args</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Vec</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>    env</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Vec</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>    current_dir</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> builder</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Command</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>builder</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span>    builder</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>executable</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>cargo</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_owned</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span>    builder</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>args</span><span style=color:#eceff4>(</span><span style=color:#88c0d0;font-weight:700>vec!</span><span style=color:#eceff4>["</span><span style=color:#a3be8c>build</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_owned</span><span style=color:#eceff4>(), "</span><span style=color:#a3be8c>--release</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_owned</span><span style=color:#eceff4>()]);</span></span>
<span class=giallo-l><span>    builder</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>env</span><span style=color:#eceff4>(</span><span style=color:#88c0d0;font-weight:700>vec!</span><span style=color:#eceff4>[]);</span></span>
<span class=giallo-l><span>    builder</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>current_dir</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>..</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_owned</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>builderã«å®šç¾©å…ƒã®structã®fieldåã®methodãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚å‹ã¯å®šç¾©å…ƒã®Commandã®fieldã¨åŒã˜ã‚ˆã†ã§ã™ã€‚ã“ã‚Œã«å¯¾å¿œã™ã‚‹ã«ã¯ä»¥ä¸‹ã®å¤‰æ›´ãŒå¿…è¦ãã†ã§ã™ã€‚<ul><li>builderã®fieldã‚’<code>Option&lt;T></code>ã¨ã™ã‚‹<li>builderã«deriveå…ƒã®fieldåã«å¯¾å¿œã—ãŸmethodã‚’å®šç¾©</ul><p>è¿½åŠ ã—ãŸå®Ÿè£…ãŒä»¥ä¸‹ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> derive_builder</span><span style=color:#eceff4>(</span><span>input</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> DeriveInput</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>TokenStream2</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    if let</span><span style=color:#8fbcbb> Data</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Struct</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>DataStruct</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                            fields</span><span style=color:#81a1c1>:</span><span> Fields</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Named</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>FieldsNamed</span><span style=color:#eceff4> {</span><span> named</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> ..</span><span style=color:#eceff4> }),</span><span style=color:#81a1c1> ..</span></span>
<span class=giallo-l><span style=color:#eceff4>                        })</span><span style=color:#81a1c1> =</span><span> input</span><span style=color:#81a1c1>.</span><span>data </span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> ident</span><span style=color:#81a1c1> =</span><span> input</span><span style=color:#81a1c1>.</span><span>ident</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> builder</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0;font-weight:700> format_ident!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{}</span><span style=color:#a3be8c>Builder</span><span style=color:#eceff4>",</span><span>ident</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#616e88>        // ğŸ‘‡</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> fields</span><span style=color:#81a1c1> =</span><span> named</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>iter</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>map</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>f</span><span style=color:#81a1c1>|</span><span style=color:#eceff4> (</span><span>f</span><span style=color:#81a1c1>.</span><span>ident</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_ref</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>expect</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>field have ident</span><span style=color:#eceff4>"),</span><span style=color:#81a1c1>&</span><span>f</span><span style=color:#81a1c1>.</span><span>ty</span><span style=color:#eceff4>));</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> builder_fields</span><span style=color:#81a1c1> =</span><span> fields</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>map</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span style=color:#eceff4>(</span><span>ident</span><span style=color:#eceff4>,</span><span> ty</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>|</span><span style=color:#88c0d0;font-weight:700> quote!</span><span style=color:#eceff4> {</span><span>#ident</span><span style=color:#81a1c1>: ::</span><span>core</span><span style=color:#81a1c1>::</span><span>option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Option</span><span style=color:#eceff4>&lt;</span><span>#ty</span><span style=color:#eceff4>>});</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> builder_init_fields</span><span style=color:#81a1c1> =</span><span> fields</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>map</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span style=color:#eceff4>(</span><span>ident</span><span style=color:#eceff4>,</span><span>_</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>|</span><span style=color:#88c0d0;font-weight:700> quote!</span><span style=color:#eceff4>{</span><span> #ident</span><span style=color:#81a1c1>: ::</span><span>core</span><span style=color:#81a1c1>::</span><span>option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>None</span><span style=color:#eceff4>});</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> builder_methods</span><span style=color:#81a1c1> =</span><span> fields</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>map</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span style=color:#eceff4>(</span><span>ident</span><span style=color:#eceff4>,</span><span> ty</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>|</span><span style=color:#88c0d0> impl_builder_method</span><span style=color:#eceff4>(</span><span>ident</span><span style=color:#eceff4>,</span><span> ty</span><span style=color:#eceff4>));</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        Ok</span><span style=color:#eceff4>(</span><span style=color:#88c0d0;font-weight:700>quote!</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>           struct</span><span> #builder</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                #</span><span style=color:#eceff4>(</span><span>#builder_fields</span><span style=color:#eceff4>),</span><span style=color:#81a1c1>*</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>            impl</span><span> #builder</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                #</span><span style=color:#eceff4>(</span><span>#builder_methods</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>*</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>           impl</span><span> #ident</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                fn</span><span style=color:#88c0d0> builder</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span> #builder</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                    #builder</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                        #</span><span style=color:#eceff4>(</span><span>#builder_init_fields</span><span style=color:#eceff4>),</span><span style=color:#81a1c1>*</span></span>
<span class=giallo-l><span style=color:#eceff4>                    }</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        })</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Err</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Error</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>input</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>span</span><span style=color:#eceff4>(), "</span><span style=color:#a3be8c>Only struct supported</span><span style=color:#eceff4>"))</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> impl_builder_method</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>    ident</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Ident</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    ty</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Type</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> TokenStream2</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    quote!</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        fn</span><span> #ident</span><span style=color:#eceff4> (</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> #ident</span><span style=color:#81a1c1>:</span><span> #ty</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> &mut Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            self.</span><span>#ident</span><span style=color:#81a1c1> = ::</span><span>core</span><span style=color:#81a1c1>::</span><span>option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Some</span><span style=color:#eceff4>(</span><span>#ident</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>            self</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>fieldã®æƒ…å ±(è­˜åˆ¥å­ã¨å‹)ã‚’iterateã—ã¦ãã‚Œãã‚ŒOptionã§wrapã—ãŸã‚ŠåŒåã®methodã‚’ç”Ÿæˆã•ã›ã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>struct</span><span> #builder</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    #</span><span style=color:#eceff4>(</span><span>#builder_fields</span><span style=color:#eceff4>),</span><span style=color:#81a1c1>*</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>declarative macroã¨åŒæ§˜ã«<code>#(...)*</code>ã§ç¹°ã‚Šè¿”ã—ãŒè¡¨ç¾ã§ãã‚‹ã®ã§ã€iteratorã‚’å‚ç…§ã™ã‚‹ã¨ãã‚ŒãŒå±•é–‹ã•ã‚Œã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ã€‚<p>expandã—ã¦ã¿ã‚‹ã¨<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> CommandBuilder</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    executable</span><span style=color:#81a1c1>: ::</span><span>core</span><span style=color:#81a1c1>::</span><span>option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>    args</span><span style=color:#81a1c1>: ::</span><span>core</span><span style=color:#81a1c1>::</span><span>option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Vec</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>>>,</span></span>
<span class=giallo-l><span>    env</span><span style=color:#81a1c1>: ::</span><span>core</span><span style=color:#81a1c1>::</span><span>option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Vec</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>>>,</span></span>
<span class=giallo-l><span>    current_dir</span><span style=color:#81a1c1>: ::</span><span>core</span><span style=color:#81a1c1>::</span><span>option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> CommandBuilder</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> executable</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> executable</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> &mut Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>executable </span><span style=color:#81a1c1>= ::</span><span>core</span><span style=color:#81a1c1>::</span><span>option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Some</span><span style=color:#eceff4>(</span><span>executable</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> args</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> args</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Vec</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>>)</span><span style=color:#81a1c1> -> &mut Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>args </span><span style=color:#81a1c1>= ::</span><span>core</span><span style=color:#81a1c1>::</span><span>option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Some</span><span style=color:#eceff4>(</span><span>args</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> env</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> env</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Vec</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>>)</span><span style=color:#81a1c1> -> &mut Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>env </span><span style=color:#81a1c1>= ::</span><span>core</span><span style=color:#81a1c1>::</span><span>option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Some</span><span style=color:#eceff4>(</span><span>env</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> current_dir</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> current_dir</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> &mut Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>current_dir </span><span style=color:#81a1c1>= ::</span><span>core</span><span style=color:#81a1c1>::</span><span>option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Some</span><span style=color:#eceff4>(</span><span>current_dir</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Command</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> builder</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> CommandBuilder</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        CommandBuilder</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            executable</span><span style=color:#81a1c1>: ::</span><span>core</span><span style=color:#81a1c1>::</span><span>option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>None</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            args</span><span style=color:#81a1c1>: ::</span><span>core</span><span style=color:#81a1c1>::</span><span>option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>None</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            env</span><span style=color:#81a1c1>: ::</span><span>core</span><span style=color:#81a1c1>::</span><span>option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>None</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            current_dir</span><span style=color:#81a1c1>: ::</span><span>core</span><span style=color:#81a1c1>::</span><span>option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>None</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã¨ãªã‚Šæ„å›³é€šã‚Šã®ã‚³ãƒ¼ãƒ‰ãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>â¯</span><span style=color:#a3be8c> cargo test --quiet</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>running</span><span style=color:#b48ead> 0</span><span style=color:#a3be8c> tests</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>test</span><span style=color:#a3be8c> result: ok.</span><span style=color:#b48ead> 0</span><span style=color:#a3be8c> passed</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 0</span><span style=color:#a3be8c> failed</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 0</span><span style=color:#a3be8c> ignored</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 0</span><span style=color:#a3be8c> measured</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 0</span><span style=color:#a3be8c> filtered out</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> finished</span><span style=color:#a3be8c> in 0.00s</span></span>
<span class=giallo-l></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>running</span><span style=color:#b48ead> 1</span><span style=color:#a3be8c> test</span></span>
<span class=giallo-l><span style=color:#88c0d0>   Compiling</span><span style=color:#a3be8c> derive_builder-tests v0.0.0</span><span> (/Users/ymgyt/rs/proc-macro-workshop-blog/target/tests/derive_builder)</span></span>
<span class=giallo-l><span style=color:#88c0d0>    Finished</span><span style=color:#a3be8c> dev</span><span> [unoptimized</span><span style=color:#a3be8c> + debuginfo] target</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>s</span><span style=color:#eceff4>)</span><span style=color:#a3be8c> in 0.13s</span></span>
<span class=giallo-l></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>test</span><span style=color:#a3be8c> tests/03-call-setters.rs ... ok</span></span></code></pre><p>ç„¡äº‹ãƒ†ã‚¹ãƒˆã‚‚ãƒ‘ã‚¹ã—ã¾ã—ãŸã€‚ <a href=https://github.com/ymgyt/proc-macro-workshop/tree/3d0f9b3ca5f38e0539cdf7499bde7087557b7044 rel=external>source code</a><h2 id=04-call-build><a aria-label="Anchor link for: 04-call-build" class=zola-anchor href=#04-call-build><code>04-call-build</code></a></h2><p><code>04-call-build</code>ã§ã¯å®Ÿéš›ã«builderã®build methodãŒå‘¼ã°ã‚Œã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> builder</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Command</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>builder</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span>    builder</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>executable</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>cargo</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_owned</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span>    builder</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>args</span><span style=color:#eceff4>(</span><span style=color:#88c0d0;font-weight:700>vec!</span><span style=color:#eceff4>["</span><span style=color:#a3be8c>build</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_owned</span><span style=color:#eceff4>(), "</span><span style=color:#a3be8c>--release</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_owned</span><span style=color:#eceff4>()]);</span></span>
<span class=giallo-l><span>    builder</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>env</span><span style=color:#eceff4>(</span><span style=color:#88c0d0;font-weight:700>vec!</span><span style=color:#eceff4>[]);</span></span>
<span class=giallo-l><span>    builder</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>current_dir</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>..</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_owned</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> command</span><span style=color:#81a1c1> =</span><span> builder</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>build</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    assert_eq!</span><span style=color:#eceff4>(</span><span>command</span><span style=color:#81a1c1>.</span><span>executable</span><span style=color:#eceff4>, "</span><span style=color:#a3be8c>cargo</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã“ã‚Œã«å¯¾å¿œã™ã‚‹ãŸã‚ã«ã¯builderã«build methodã‚’è¿½åŠ ã—ã€è‡ªèº«ã®fieldã®å€¤ã‹ã‚‰deriveå…ƒã®Commandã‚’constructã™ã‚‹ã‚ˆã†ãªå‡¦ç†ãŒå¿…è¦ã§ã™ã€‚ã“ã‚Œã«å¯¾å¿œã—ãŸã®ãŒä»¥ä¸‹ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> derive_builder</span><span style=color:#eceff4>(</span><span>input</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> DeriveInput</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>TokenStream2</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    if let</span><span style=color:#8fbcbb> Data</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Struct</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>DataStruct</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>        fields</span><span style=color:#81a1c1>:</span><span> Fields</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Named</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>FieldsNamed</span><span style=color:#eceff4> {</span><span> named</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> ..</span><span style=color:#eceff4> }),</span></span>
<span class=giallo-l><span style=color:#81a1c1>        ..</span></span>
<span class=giallo-l><span style=color:#eceff4>    })</span><span style=color:#81a1c1> =</span><span> input</span><span style=color:#81a1c1>.</span><span>data</span></span>
<span class=giallo-l><span style=color:#eceff4>    {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> ident</span><span style=color:#81a1c1> =</span><span> input</span><span style=color:#81a1c1>.</span><span>ident</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> builder</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0;font-weight:700> format_ident!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{}</span><span style=color:#a3be8c>Builder</span><span style=color:#eceff4>",</span><span> ident</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> fields</span><span style=color:#81a1c1> =</span><span> named</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>iter</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>map</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>f</span><span style=color:#81a1c1>|</span><span style=color:#eceff4> (</span><span>f</span><span style=color:#81a1c1>.</span><span>ident</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_ref</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>expect</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>field have ident</span><span style=color:#eceff4>"),</span><span style=color:#81a1c1> &</span><span>f</span><span style=color:#81a1c1>.</span><span>ty</span><span style=color:#eceff4>));</span></span>
<span class=giallo-l><span style=color:#616e88>        // ğŸ‘‡</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> idents</span><span style=color:#81a1c1> =</span><span> fields</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>map</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span style=color:#eceff4>(</span><span>ident</span><span style=color:#eceff4>,</span><span>_</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>|</span><span> ident</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> builder_fields</span><span style=color:#81a1c1> =</span><span> fields</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>map</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span style=color:#eceff4>(</span><span>ident</span><span style=color:#eceff4>,</span><span> ty</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>|</span><span style=color:#88c0d0;font-weight:700> quote!</span><span style=color:#eceff4> {</span><span>#ident</span><span style=color:#81a1c1>: ::</span><span>core</span><span style=color:#81a1c1>::</span><span>option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Option</span><span style=color:#eceff4>&lt;</span><span>#ty</span><span style=color:#eceff4>>});</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> builder_init_fields</span><span style=color:#81a1c1> =</span><span> fields</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>map</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span style=color:#eceff4>(</span><span>ident</span><span style=color:#eceff4>,</span><span> _</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>|</span><span style=color:#88c0d0;font-weight:700> quote!</span><span style=color:#eceff4> {</span><span> #ident</span><span style=color:#81a1c1>: ::</span><span>core</span><span style=color:#81a1c1>::</span><span>option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>None</span><span style=color:#eceff4>});</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> builder_methods</span><span style=color:#81a1c1> =</span><span> fields</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>map</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span style=color:#eceff4>(</span><span>ident</span><span style=color:#eceff4>,</span><span> ty</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>|</span><span style=color:#88c0d0> impl_builder_method</span><span style=color:#eceff4>(</span><span>ident</span><span style=color:#eceff4>,</span><span> ty</span><span style=color:#eceff4>));</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        Ok</span><span style=color:#eceff4>(</span><span style=color:#88c0d0;font-weight:700>quote!</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>           struct</span><span> #builder</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                #</span><span style=color:#eceff4>(</span><span>#builder_fields</span><span style=color:#eceff4>),</span><span style=color:#81a1c1>*</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>            impl</span><span> #builder</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                #</span><span style=color:#eceff4>(</span><span>#builder_methods</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>*</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>                // ğŸ‘‡</span></span>
<span class=giallo-l><span style=color:#81a1c1>                fn</span><span style=color:#88c0d0> build</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> ::</span><span>core</span><span style=color:#81a1c1>::</span><span>result</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;</span></span>
<span class=giallo-l><span>                    #ident</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    ::</span><span>std</span><span style=color:#81a1c1>::</span><span>boxed</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Box</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>dyn ::</span><span>std</span><span style=color:#81a1c1>::</span><span>error</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#eceff4>                ></span></span>
<span class=giallo-l><span style=color:#eceff4>                {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                    Ok</span><span style=color:#eceff4>(</span><span>#ident</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                        #</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>                            #idents</span><span style=color:#81a1c1>: self.</span><span>#idents</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>take</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>ok_or_else</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>||</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>                               format!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{}</span><span style=color:#a3be8c> is not provided</span><span style=color:#eceff4>",</span><span style=color:#88c0d0;font-weight:700> stringify!</span><span style=color:#eceff4>(</span><span>#idents</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#eceff4>                            )</span><span style=color:#81a1c1>?</span></span>
<span class=giallo-l><span style=color:#eceff4>                        ),</span><span style=color:#81a1c1>*</span></span>
<span class=giallo-l><span style=color:#eceff4>                    })</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>           impl</span><span> #ident</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                fn</span><span style=color:#88c0d0> builder</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span> #builder</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                    #builder</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                        #</span><span style=color:#eceff4>(</span><span>#builder_init_fields</span><span style=color:#eceff4>),</span><span style=color:#81a1c1>*</span></span>
<span class=giallo-l><span style=color:#eceff4>                    }</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        })</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Err</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Error</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>input</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>span</span><span style=color:#eceff4>(), "</span><span style=color:#a3be8c>Only struct supported</span><span style=color:#eceff4>"))</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>filedã®è­˜åˆ¥ã ã‘ã‚’ä¿æŒã™ã‚‹iteratorã‚’ç”¨æ„ã—ã¦ãŠãã€<code>#idents: self.#idents.take()</code>ã®ã‚ˆã†ã«ä½¿ã„ã¾ã™ã€‚ã‚ãã¾ã§tokenãªã®ã§ã€å®Ÿéš›ã«ã¯Optionã§ãªãã¦ã‚‚(<code>syn::Ident</code>)<code>take</code>ãŒå‘¼ã¹ã¦ã—ã¾ã†ã‚“ã§ã™ã­ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>â¯</span><span style=color:#a3be8c> cargo test</span></span>
<span class=giallo-l><span style=color:#88c0d0>    Finished</span><span style=color:#a3be8c> test</span><span> [unoptimized</span><span style=color:#a3be8c> + debuginfo] target</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>s</span><span style=color:#eceff4>)</span><span style=color:#a3be8c> in 0.02s</span></span>
<span class=giallo-l><span style=color:#88c0d0>     Running</span><span style=color:#a3be8c> unittests src/lib.rs</span><span> (/Users/ymgyt/rs/proc-macro-workshop-blog/target/debug/deps/derive_builder-5d658299e3122af7)</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>running</span><span style=color:#b48ead> 0</span><span style=color:#a3be8c> tests</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>test</span><span style=color:#a3be8c> result: ok.</span><span style=color:#b48ead> 0</span><span style=color:#a3be8c> passed</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 0</span><span style=color:#a3be8c> failed</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 0</span><span style=color:#a3be8c> ignored</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 0</span><span style=color:#a3be8c> measured</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 0</span><span style=color:#a3be8c> filtered out</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> finished</span><span style=color:#a3be8c> in 0.00s</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>     Running</span><span style=color:#a3be8c> tests/progress.rs</span><span> (/Users/ymgyt/rs/proc-macro-workshop-blog/target/debug/deps/tests-0fe6acae350aa640)</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>running</span><span style=color:#b48ead> 1</span><span style=color:#a3be8c> test</span></span>
<span class=giallo-l><span style=color:#88c0d0>   Compiling</span><span style=color:#a3be8c> derive_builder-tests v0.0.0</span><span> (/Users/ymgyt/rs/proc-macro-workshop-blog/target/tests/derive_builder)</span></span>
<span class=giallo-l><span style=color:#88c0d0>    Finished</span><span style=color:#a3be8c> dev</span><span> [unoptimized</span><span style=color:#a3be8c> + debuginfo] target</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>s</span><span style=color:#eceff4>)</span><span style=color:#a3be8c> in 0.13s</span></span>
<span class=giallo-l></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>test</span><span style=color:#a3be8c> tests/04-call-build.rs ... ok</span></span></code></pre><p>ãƒ†ã‚¹ãƒˆã‚‚ãƒ‘ã‚¹ã—ã¾ã—ãŸã€‚<h2 id=05-method-chaining><a aria-label="Anchor link for: 05-method-chaining" class=zola-anchor href=#05-method-chaining><code>05-method-chaining</code></a></h2><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> tests</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> t</span><span style=color:#81a1c1> =</span><span> trybuild</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>TestCases</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span>    t</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>pass</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>tests/05-method-chaining.rs</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>builderã®methodã‚’chainã§ãã‚‹ã‹ã®testã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> command</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Command</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>builder</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>executable</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>cargo</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_owned</span><span style=color:#eceff4>())</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>args</span><span style=color:#eceff4>(</span><span style=color:#88c0d0;font-weight:700>vec!</span><span style=color:#eceff4>["</span><span style=color:#a3be8c>build</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_owned</span><span style=color:#eceff4>(), "</span><span style=color:#a3be8c>--release</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_owned</span><span style=color:#eceff4>()])</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>env</span><span style=color:#eceff4>(</span><span style=color:#88c0d0;font-weight:700>vec!</span><span style=color:#eceff4>[])</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>current_dir</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>..</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_owned</span><span style=color:#eceff4>())</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>build</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    assert_eq!</span><span style=color:#eceff4>(</span><span>command</span><span style=color:#81a1c1>.</span><span>executable</span><span style=color:#eceff4>, "</span><span style=color:#a3be8c>cargo</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ä»Šå›ã¯æ–°ãŸã«å®Ÿè£…ã‚’å¤‰æ›´ã—ãªãã¦ã‚‚ãƒ†ã‚¹ãƒˆã‚’ãƒ‘ã‚¹ã§ãã¾ã™ã€‚<br> ä»Šå›ã¯builderã®signatureã‚’<code>&mut self</code>ã¨ã—ã¦ã„ã¾ã™ãŒã€<code>self</code>ã¨ã—ãŸã„å ´é¢ã‚‚ã‚ã‚Šã¾ã™ã€‚ä»Šå›ã®ã‚±ãƒ¼ã‚¹ã§ã¯åˆæœŸå€¤ã‚’ã™ã¹ã¦Optionå‹ã¨ã—ã¦ã„ã‚‹ã®ã§ã€takeã§æ‰€æœ‰æ¨©ã‚’å¥ªãˆã‚‹ã®ã§ã™ãŒãã†ã§ãªã„å ´åˆã«ã¯<code>&mut self</code>ã‹ã‚‰å€¤ã‚’moveã§ããšã«ä¸è¦ãªcloneãŒç”Ÿã˜ã¦ã—ã¾ã†å ´åˆãŒã‚ã‚Šã¾ã™ã€‚<br> ã“ã®ã‚ãŸã‚Šã®Pro/Conã«ã¤ã„ã¦ã¯<a href=https://docs.rs/derive_builder/latest/derive_builder/#builder-patterns rel=external>derive_builder</a>ã«èª¬æ˜ãŒã‚ã‚Šã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>â¯</span><span style=color:#a3be8c> cargo test</span></span>
<span class=giallo-l><span style=color:#88c0d0>    Finished</span><span style=color:#a3be8c> test</span><span> [unoptimized</span><span style=color:#a3be8c> + debuginfo] target</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>s</span><span style=color:#eceff4>)</span><span style=color:#a3be8c> in 0.02s</span></span>
<span class=giallo-l><span style=color:#88c0d0>     Running</span><span style=color:#a3be8c> unittests src/lib.rs</span><span> (/Users/ymgyt/rs/proc-macro-workshop-blog/target/debug/deps/derive_builder-5d658299e3122af7)</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>running</span><span style=color:#b48ead> 0</span><span style=color:#a3be8c> tests</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>test</span><span style=color:#a3be8c> result: ok.</span><span style=color:#b48ead> 0</span><span style=color:#a3be8c> passed</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 0</span><span style=color:#a3be8c> failed</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 0</span><span style=color:#a3be8c> ignored</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 0</span><span style=color:#a3be8c> measured</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 0</span><span style=color:#a3be8c> filtered out</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> finished</span><span style=color:#a3be8c> in 0.00s</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>     Running</span><span style=color:#a3be8c> tests/progress.rs</span><span> (/Users/ymgyt/rs/proc-macro-workshop-blog/target/debug/deps/tests-0fe6acae350aa640)</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>running</span><span style=color:#b48ead> 1</span><span style=color:#a3be8c> test</span></span>
<span class=giallo-l><span style=color:#88c0d0>   Compiling</span><span style=color:#a3be8c> derive_builder-tests v0.0.0</span><span> (/Users/ymgyt/rs/proc-macro-workshop-blog/target/tests/derive_builder)</span></span>
<span class=giallo-l><span style=color:#88c0d0>    Finished</span><span style=color:#a3be8c> dev</span><span> [unoptimized</span><span style=color:#a3be8c> + debuginfo] target</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>s</span><span style=color:#eceff4>)</span><span style=color:#a3be8c> in 0.13s</span></span>
<span class=giallo-l></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>test</span><span style=color:#a3be8c> tests/05-method-chaining.rs ... ok</span></span></code></pre><h2 id=06-optional-fields><a aria-label="Anchor link for: 06-optional-fields" class=zola-anchor href=#06-optional-fields><code>06-optional-fields</code></a></h2><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> tests</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> t</span><span style=color:#81a1c1> =</span><span> trybuild</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>TestCases</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span>    t</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>pass</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>tests/06-optional-field.rs</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Builder</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> Command</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    executable</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    args</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Vec</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>    env</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Vec</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>    current_dir</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> command</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Command</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>builder</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>executable</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>cargo</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_owned</span><span style=color:#eceff4>())</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>args</span><span style=color:#eceff4>(</span><span style=color:#88c0d0;font-weight:700>vec!</span><span style=color:#eceff4>["</span><span style=color:#a3be8c>build</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_owned</span><span style=color:#eceff4>(), "</span><span style=color:#a3be8c>--release</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_owned</span><span style=color:#eceff4>()])</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>env</span><span style=color:#eceff4>(</span><span style=color:#88c0d0;font-weight:700>vec!</span><span style=color:#eceff4>[])</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>build</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    assert!</span><span style=color:#eceff4>(</span><span>command</span><span style=color:#81a1c1>.</span><span>current_dir</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>is_none</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> command</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Command</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>builder</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>executable</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>cargo</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_owned</span><span style=color:#eceff4>())</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>args</span><span style=color:#eceff4>(</span><span style=color:#88c0d0;font-weight:700>vec!</span><span style=color:#eceff4>["</span><span style=color:#a3be8c>build</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_owned</span><span style=color:#eceff4>(), "</span><span style=color:#a3be8c>--release</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_owned</span><span style=color:#eceff4>()])</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>env</span><span style=color:#eceff4>(</span><span style=color:#88c0d0;font-weight:700>vec!</span><span style=color:#eceff4>[])</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>current_dir</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>..</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_owned</span><span style=color:#eceff4>())</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>build</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    assert!</span><span style=color:#eceff4>(</span><span>command</span><span style=color:#81a1c1>.</span><span>current_dir</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>is_some</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>deriveå…ƒã§ã¯<code>current_dir</code>ãŒOptionã«ãªã£ã¦ã„ã¾ã™ã€‚ãã‚Œã«å¯¾å¿œã—ã¦builderã§ã‚‚current_dirã®å‘¼ã³å‡ºã—ãŒoptionalã«ãªã£ã¦ã„ã¾ã™ã€‚<br> ã‚ˆã†ã‚„ãbuilderã‚‰ã—ããªã£ã¦ããŸã®ã§ã™ãŒã€ã“ã®ã‚ãŸã‚Šã‹ã‚‰ã¤ã‚‰ããªã‚Šã¾ã™ã€‚å…·ä½“çš„ã«ã¯æ‰±ã£ã¦ã„ã‚‹å¯¾è±¡ãŒã‚ãã¾ã§tokenåˆ—ãªã®ã§ã€å‹ã¨ã—ã¦æƒ…å ±ãŒã¾ã ãªãã€ä»Šæ‰±ã£ã¦ã„ã‚‹filedã®å‹ãŒOptionãªã®ã‹ã®åˆ¤åˆ¥ã‚„Option<t>ã‹ã‚‰Tã‚’å¾—ã‚‹å ´åˆã‚’ãŒã‚“ã°ã‚‰ãªã„ã¨ã„ã‘ãªããªã‚Šã¾ã™ã€‚ <p>ä»Šå›ã®å¤‰æ›´ç‚¹ã¯ä»¥ä¸‹ã§ã™ã€‚</p> <ul><li>Option<t>å‹ã®builderã®fieldã®åˆæœŸå€¤ã‚’<code>Some(None)</code>ã«ã™ã‚‹ <li>Option<t>å‹ã®builder methodãŒTã‚’ã†ã‘ã¨ã‚‹ã‚ˆã†ã«ã™ã‚‹ <p>å¤‰æ›´å¾Œã®ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã«ãªã‚Šã¾ã™ã€‚</p> <pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> derive_builder</span><span style=color:#eceff4>(</span><span>input</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> DeriveInput</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>TokenStream2</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    if let</span><span style=color:#8fbcbb> Data</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Struct</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>DataStruct</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>        fields</span><span style=color:#81a1c1>:</span><span> Fields</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Named</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>FieldsNamed</span><span style=color:#eceff4> {</span><span> named</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> ..</span><span style=color:#eceff4> }),</span></span>
<span class=giallo-l><span style=color:#81a1c1>        ..</span></span>
<span class=giallo-l><span style=color:#eceff4>    })</span><span style=color:#81a1c1> =</span><span> input</span><span style=color:#81a1c1>.</span><span>data</span></span>
<span class=giallo-l><span style=color:#eceff4>    {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> ident</span><span style=color:#81a1c1> =</span><span> input</span><span style=color:#81a1c1>.</span><span>ident</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> builder</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0;font-weight:700> format_ident!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{}</span><span style=color:#a3be8c>Builder</span><span style=color:#eceff4>",</span><span> ident</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> fields</span><span style=color:#81a1c1> =</span><span> named</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>iter</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>map</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>f</span><span style=color:#81a1c1>|</span><span style=color:#eceff4> (</span><span>f</span><span style=color:#81a1c1>.</span><span>ident</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_ref</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>expect</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>field have ident</span><span style=color:#eceff4>"),</span><span style=color:#81a1c1> &</span><span>f</span><span style=color:#81a1c1>.</span><span>ty</span><span style=color:#eceff4>));</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> idents</span><span style=color:#81a1c1> =</span><span> fields</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>map</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span style=color:#eceff4>(</span><span>ident</span><span style=color:#eceff4>,</span><span> _</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>|</span><span> ident</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> builder_fields</span><span style=color:#81a1c1> =</span><span> fields</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>map</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span style=color:#eceff4>(</span><span>ident</span><span style=color:#eceff4>,</span><span> ty</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>|</span><span style=color:#88c0d0;font-weight:700> quote!</span><span style=color:#eceff4> {</span><span>#ident</span><span style=color:#81a1c1>: ::</span><span>core</span><span style=color:#81a1c1>::</span><span>option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Option</span><span style=color:#eceff4>&lt;</span><span>#ty</span><span style=color:#eceff4>>});</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> builder_init_fields</span><span style=color:#81a1c1> =</span><span> fields</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>map</span><span style=color:#eceff4>(</span><span>builder_init_field</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> builder_methods</span><span style=color:#81a1c1> =</span><span> fields</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>map</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span style=color:#eceff4>(</span><span>ident</span><span style=color:#eceff4>,</span><span> ty</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>|</span><span style=color:#88c0d0> impl_builder_method</span><span style=color:#eceff4>(</span><span>ident</span><span style=color:#eceff4>,</span><span> ty</span><span style=color:#eceff4>));</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        Ok</span><span style=color:#eceff4>(</span><span style=color:#88c0d0;font-weight:700>quote!</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>           struct</span><span> #builder</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                #</span><span style=color:#eceff4>(</span><span>#builder_fields</span><span style=color:#eceff4>),</span><span style=color:#81a1c1>*</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>            impl</span><span> #builder</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                #</span><span style=color:#eceff4>(</span><span>#builder_methods</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>*</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>                fn</span><span style=color:#88c0d0> build</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> ::</span><span>core</span><span style=color:#81a1c1>::</span><span>result</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;</span></span>
<span class=giallo-l><span>                    #ident</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    ::</span><span>std</span><span style=color:#81a1c1>::</span><span>boxed</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Box</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>dyn ::</span><span>std</span><span style=color:#81a1c1>::</span><span>error</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#eceff4>                ></span></span>
<span class=giallo-l><span style=color:#eceff4>                {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                    Ok</span><span style=color:#eceff4>(</span><span>#ident</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                        #</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>                            #idents</span><span style=color:#81a1c1>: self.</span><span>#idents</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>take</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>ok_or_else</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>||</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>                               format!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{}</span><span style=color:#a3be8c> is not provided</span><span style=color:#eceff4>",</span><span style=color:#88c0d0;font-weight:700> stringify!</span><span style=color:#eceff4>(</span><span>#idents</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#eceff4>                            )</span><span style=color:#81a1c1>?</span></span>
<span class=giallo-l><span style=color:#eceff4>                        ),</span><span style=color:#81a1c1>*</span></span>
<span class=giallo-l><span style=color:#eceff4>                    })</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>           impl</span><span> #ident</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                fn</span><span style=color:#88c0d0> builder</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span> #builder</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                    #builder</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                        #</span><span style=color:#eceff4>(</span><span>#builder_init_fields</span><span style=color:#eceff4>),</span><span style=color:#81a1c1>*</span></span>
<span class=giallo-l><span style=color:#eceff4>                    }</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        })</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Err</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Error</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>input</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>span</span><span style=color:#eceff4>(), "</span><span style=color:#a3be8c>Only struct supported</span><span style=color:#eceff4>"))</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>// ğŸ‘‡</span></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> impl_builder_method</span><span style=color:#eceff4>(</span><span>ident</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Ident</span><span style=color:#eceff4>,</span><span> ty</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Type</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> TokenStream2</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    match</span><span style=color:#88c0d0> field_type</span><span style=color:#eceff4>(</span><span>ty</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        FieldType</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Option</span><span style=color:#eceff4>(</span><span>inner_ty</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>            quote!</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                fn</span><span> #ident</span><span style=color:#eceff4> (</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> #ident</span><span style=color:#81a1c1>:</span><span> #inner_ty</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> &mut Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    self.</span><span>#ident</span><span style=color:#81a1c1> = ::</span><span>core</span><span style=color:#81a1c1>::</span><span>option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Some</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#81a1c1>                        ::</span><span>core</span><span style=color:#81a1c1>::</span><span>option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Some</span><span style=color:#eceff4>(</span><span>#ident</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>                    );</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    self</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span>        _</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>            quote!</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                fn</span><span> #ident</span><span style=color:#eceff4> (</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> #ident</span><span style=color:#81a1c1>:</span><span> #ty</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> &mut Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    self.</span><span>#ident</span><span style=color:#81a1c1> = ::</span><span>core</span><span style=color:#81a1c1>::</span><span>option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Some</span><span style=color:#eceff4>(</span><span>#ident</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    self</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>// ğŸ‘‡</span></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> builder_init_field</span><span style=color:#eceff4>((</span><span>ident</span><span style=color:#eceff4>,</span><span> ty</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>:</span><span style=color:#eceff4> (</span><span style=color:#81a1c1>&</span><span style=color:#8fbcbb>Ident</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> &</span><span style=color:#8fbcbb>Type</span><span style=color:#eceff4>))</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> TokenStream2</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    match</span><span style=color:#88c0d0> field_type</span><span style=color:#eceff4>(</span><span>ty</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        FieldType</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Option</span><span style=color:#eceff4>(</span><span>_inner_ty</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>            quote!</span><span style=color:#eceff4> {</span><span> #ident</span><span style=color:#81a1c1>: ::</span><span>core</span><span style=color:#81a1c1>::</span><span>option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Some</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>::</span><span>core</span><span style=color:#81a1c1>::</span><span>option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>None</span><span style=color:#eceff4>)}</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        FieldType</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Vec</span><span style=color:#eceff4>(</span><span>_inner_ty</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>            quote!</span><span style=color:#eceff4> {</span><span> #ident</span><span style=color:#81a1c1>: ::</span><span>core</span><span style=color:#81a1c1>::</span><span>option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Some</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>::</span><span>std</span><span style=color:#81a1c1>::</span><span>vec</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Vec</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>())}</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        FieldType</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Raw</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>            quote!</span><span style=color:#eceff4> {</span><span> #ident</span><span style=color:#81a1c1>: ::</span><span>core</span><span style=color:#81a1c1>::</span><span>option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>None</span><span style=color:#eceff4>}</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>// ğŸ‘‡</span></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> field_type</span><span style=color:#eceff4>(</span><span>ty</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Type</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> FieldType</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    use</span><span> syn</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        AngleBracketedGenericArguments</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> GenericArgument</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Path</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> PathArguments</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> PathSegment</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> TypePath</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    };</span></span>
<span class=giallo-l><span style=color:#81a1c1>    if let</span><span style=color:#8fbcbb> Type</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Path</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>TypePath</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>        qself</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> None</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        path</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Path</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            leading_colon</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            segments</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>        },</span></span>
<span class=giallo-l><span style=color:#eceff4>    })</span><span style=color:#81a1c1> =</span><span> ty</span></span>
<span class=giallo-l><span style=color:#eceff4>    {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if</span><span> leading_colon</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>is_none</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> &&</span><span> segments</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>len</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> ==</span><span style=color:#b48ead> 1</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            if let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>PathSegment</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                ident</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>                arguments</span><span style=color:#81a1c1>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                    PathArguments</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>AngleBracketed</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>AngleBracketedGenericArguments</span><span style=color:#eceff4> {</span><span> args</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> ..</span><span style=color:#eceff4> }),</span></span>
<span class=giallo-l><span style=color:#eceff4>            })</span><span style=color:#81a1c1> =</span><span> segments</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>first</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>            {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                if let</span><span style=color:#eceff4> (</span><span style=color:#b48ead>1</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>GenericArgument</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Type</span><span style=color:#eceff4>(</span><span>t</span><span style=color:#eceff4>)))</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> (</span><span>args</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>len</span><span style=color:#eceff4>(),</span><span> args</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>first</span><span style=color:#eceff4>()) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    if</span><span> ident</span><span style=color:#81a1c1> ==</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>Option</span><span style=color:#eceff4>" {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                        return</span><span style=color:#8fbcbb> FieldType</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Option</span><span style=color:#eceff4>(</span><span>t</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#eceff4>                    }</span><span style=color:#81a1c1> else if</span><span> ident</span><span style=color:#81a1c1> ==</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>Vec</span><span style=color:#eceff4>" {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                        return</span><span style=color:#8fbcbb> FieldType</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Vec</span><span style=color:#eceff4>(</span><span>t</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#eceff4>                    }</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    FieldType</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Raw</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>enum</span><span style=color:#8fbcbb> FieldType</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Raw</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#88c0d0>    Option</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Type</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#88c0d0>    Vec</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Type</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre> <p>ã¾ãšå‹ã®åˆ¤åˆ¥ã¨inner typeã‚’å–å¾—ã™ã‚‹utilå‡¦ç†ã¨ã—ã¦ã€<code>field_type()</code>ã‚’å®šç¾©ã—ã¾ã™ã€‚<br> ã“ã®ã‚ˆã†ã«synã‹ã‚‰å‹ã‚’åˆ¤åˆ¥ã—ã¦inner typeã‚’å–å¾—ã™ã‚‹å‡¦ç†ã¯çµæ§‹å¤§å¤‰ã§ã™ã€‚ã“ã®å‡¦ç†ã§ã‚‚ç°¡æ˜“çš„ã§ã‚‚ã£ã¨è€ƒæ…®ã—ãªã„ã¨ã„ã‘ãªã‚±ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã™ã€‚<br> filedã®å‹ãŒ<code>Option&lt;T></code>ã¨åˆ¤åˆ¥ã§ãã‚Œã°ã€åˆæœŸå€¤ã¯<code>Some(None)</code>ã¨ã—ã¦ã€methodã®å¼•æ•°ã§ã¯<code>T</code>ã‚’ã†ã‘ã¨ã‚Œã‚‹ã‚ˆã†ã«ã§ãã¾ã™ã€‚</p> <p>ã“ã‚Œã§ãƒ†ã‚¹ãƒˆã‚’ãƒ‘ã‚¹ã§ãã¾ã—ãŸã€‚</p> <pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>â¯</span><span style=color:#a3be8c> cargo test</span></span>
<span class=giallo-l><span style=color:#88c0d0>    Finished</span><span style=color:#a3be8c> test</span><span> [unoptimized</span><span style=color:#a3be8c> + debuginfo] target</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>s</span><span style=color:#eceff4>)</span><span style=color:#a3be8c> in 0.02s</span></span>
<span class=giallo-l><span style=color:#88c0d0>     Running</span><span style=color:#a3be8c> unittests src/lib.rs</span><span> (/Users/ymgyt/rs/proc-macro-workshop-blog/target/debug/deps/derive_builder-5d658299e3122af7)</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>running</span><span style=color:#b48ead> 0</span><span style=color:#a3be8c> tests</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>test</span><span style=color:#a3be8c> result: ok.</span><span style=color:#b48ead> 0</span><span style=color:#a3be8c> passed</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 0</span><span style=color:#a3be8c> failed</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 0</span><span style=color:#a3be8c> ignored</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 0</span><span style=color:#a3be8c> measured</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 0</span><span style=color:#a3be8c> filtered out</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> finished</span><span style=color:#a3be8c> in 0.00s</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>     Running</span><span style=color:#a3be8c> tests/progress.rs</span><span> (/Users/ymgyt/rs/proc-macro-workshop-blog/target/debug/deps/tests-0fe6acae350aa640)</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>running</span><span style=color:#b48ead> 1</span><span style=color:#a3be8c> test</span></span>
<span class=giallo-l><span style=color:#88c0d0>   Compiling</span><span style=color:#a3be8c> derive_builder-tests v0.0.0</span><span> (/Users/ymgyt/rs/proc-macro-workshop-blog/target/tests/derive_builder)</span></span>
<span class=giallo-l><span style=color:#88c0d0>    Finished</span><span style=color:#a3be8c> dev</span><span> [unoptimized</span><span style=color:#a3be8c> + debuginfo] target</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>s</span><span style=color:#eceff4>)</span><span style=color:#a3be8c> in 0.13s</span></span>
<span class=giallo-l></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>test</span><span style=color:#a3be8c> tests/06-optional-field.rs ... ok</span></span></code></pre> <p><a href=https://github.com/ymgyt/proc-macro-workshop/tree/84105faa4bcafce3a6219b45c51ad99da501ddfe rel=external>source code</a></p> <h2 id=07-repeated-field><a aria-label="Anchor link for: 07-repeated-field" class=zola-anchor href=#07-repeated-field><code>07-repeated-field</code></a></h2> <pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> tests</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> t</span><span style=color:#81a1c1> =</span><span> trybuild</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>TestCases</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span>    t</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>pass</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>tests/07-repeated-field.rs</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre> <p><code>07-repeted-field</code>ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚</p> <pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Builder</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> Command</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    executable</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#5e81ac>    #[builder(each = "</span><span style=color:#a3be8c>arg</span><span style=color:#5e81ac>")]</span></span>
<span class=giallo-l><span>    args</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Vec</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#5e81ac>    #[builder(each = "</span><span style=color:#a3be8c>env</span><span style=color:#5e81ac>")]</span></span>
<span class=giallo-l><span>    env</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Vec</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>    current_dir</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> command</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Command</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>builder</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>executable</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>cargo</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_owned</span><span style=color:#eceff4>())</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>arg</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>build</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_owned</span><span style=color:#eceff4>())</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>arg</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>--release</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_owned</span><span style=color:#eceff4>())</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>build</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    assert_eq!</span><span style=color:#eceff4>(</span><span>command</span><span style=color:#81a1c1>.</span><span>executable</span><span style=color:#eceff4>, "</span><span style=color:#a3be8c>cargo</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    assert_eq!</span><span style=color:#eceff4>(</span><span>command</span><span style=color:#81a1c1>.</span><span>args</span><span style=color:#eceff4>,</span><span style=color:#88c0d0;font-weight:700> vec!</span><span style=color:#eceff4>["</span><span style=color:#a3be8c>build</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>--release</span><span style=color:#eceff4>"]);</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre> <p>fieldã«<code>builder(each = ...)</code>ã¨ã„ã†annotationãŒè¿½åŠ ã•ã‚Œã¦ãŠã‚Šã€<code>Vec&lt;T></code>å‹ã®fieldã«å¯¾ã—ã¦ã€eachã§æŒ‡å®šã—ãŸmethodã‚’è¤‡æ•°å›å‘¼ã¶ã“ã¨ã§å†…éƒ¨çš„ãªvecã«pushã§ãã‚‹ã‚ˆã†ãªapiã«ãªã£ã¦ã„ã¾ã™ã€‚<br> ã“ã“ã§æ³¨æ„ã—ã¦ã„ãŸã ããŸã„ã®ãŒã€<code>args</code>ã§ã¯eachãŒ<code>arg</code>ã«ãªã£ã¦ã„ã‚‹ã®ã«å¯¾ã—ã¦ã€<code>env</code>ã§ã¯eachã‚‚<code>env</code>ã¨ãªã£ã¦ãŠã‚Šã€eachã¨å…ƒã€…ã®fieldåãŒä¸€è‡´ã—ã¦ã„ã¾ã™ã€‚</p> <p>ä»Šå›å¿…è¦ãªå¤‰æ›´ç‚¹ã¯</p> <ul><li><code>each</code>ã®annotationã«å¯¾å¿œã—ãŸbuilder method</ul> <p>å¤‰æ›´å¾Œã®ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚</p> <pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[proc_macro_derive(</span><span style=color:#8fbcbb>Builder</span><span style=color:#5e81ac>, attributes(builder))]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub fn</span><span style=color:#88c0d0> derive</span><span style=color:#eceff4>(</span><span>input</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> TokenStream</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> TokenStream</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> input</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> DeriveInput</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0;font-weight:700> parse_macro_input!</span><span style=color:#eceff4>(</span><span>input</span><span style=color:#81a1c1> as</span><span style=color:#8fbcbb> DeriveInput</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> derive_builder</span><span style=color:#eceff4>(</span><span>input</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> DeriveInput</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>TokenStream2</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    if let</span><span style=color:#8fbcbb> Data</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Struct</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>DataStruct</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>        fields</span><span style=color:#81a1c1>:</span><span> Fields</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Named</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>FieldsNamed</span><span style=color:#eceff4> {</span><span> named</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> ..</span><span style=color:#eceff4> }),</span></span>
<span class=giallo-l><span style=color:#81a1c1>        ..</span></span>
<span class=giallo-l><span style=color:#eceff4>    })</span><span style=color:#81a1c1> =</span><span> input</span><span style=color:#81a1c1>.</span><span>data</span></span>
<span class=giallo-l><span style=color:#eceff4>    {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> ident</span><span style=color:#81a1c1> =</span><span> input</span><span style=color:#81a1c1>.</span><span>ident</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> builder</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0;font-weight:700> format_ident!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{}</span><span style=color:#a3be8c>Builder</span><span style=color:#eceff4>",</span><span> ident</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> fields</span><span style=color:#81a1c1> =</span><span> named</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>iter</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>map</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>f</span><span style=color:#81a1c1>|</span><span style=color:#eceff4> (</span><span>f</span><span style=color:#81a1c1>.</span><span>ident</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_ref</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>expect</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>field have ident</span><span style=color:#eceff4>"),</span><span style=color:#81a1c1> &</span><span>f</span><span style=color:#81a1c1>.</span><span>ty</span><span style=color:#eceff4>));</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> idents</span><span style=color:#81a1c1> =</span><span> fields</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>map</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span style=color:#eceff4>(</span><span>ident</span><span style=color:#eceff4>,</span><span> _</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>|</span><span> ident</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> builder_fields</span><span style=color:#81a1c1> =</span><span> fields</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>map</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span style=color:#eceff4>(</span><span>ident</span><span style=color:#eceff4>,</span><span> ty</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>|</span><span style=color:#88c0d0;font-weight:700> quote!</span><span style=color:#eceff4> {</span><span>#ident</span><span style=color:#81a1c1>: ::</span><span>core</span><span style=color:#81a1c1>::</span><span>option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Option</span><span style=color:#eceff4>&lt;</span><span>#ty</span><span style=color:#eceff4>>});</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> builder_init_fields</span><span style=color:#81a1c1> =</span><span> fields</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>map</span><span style=color:#eceff4>(</span><span>builder_init_field</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#616e88>        // ğŸ‘‡</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> each_attributes</span><span style=color:#81a1c1> =</span><span> named</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>iter</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>map</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>f</span><span style=color:#81a1c1>| match</span><span> f</span><span style=color:#81a1c1>.</span><span>attrs</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>first</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Some</span><span style=color:#eceff4>(</span><span>attr</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#88c0d0> inspect_each</span><span style=color:#eceff4>(</span><span>attr</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            None</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>None</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>        })</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>collect</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Vec</span><span style=color:#eceff4>&lt;</span><span>_</span><span style=color:#eceff4>>>>()</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> builder_methods</span><span style=color:#81a1c1> =</span><span> fields</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>zip</span><span style=color:#eceff4>(</span><span>each_attributes</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>map</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span style=color:#eceff4>((</span><span>ident</span><span style=color:#eceff4>,</span><span> ty</span><span style=color:#eceff4>),</span><span> maybe_each</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>|</span><span style=color:#88c0d0> impl_builder_method</span><span style=color:#eceff4>(</span><span>ident</span><span style=color:#eceff4>,</span><span> ty</span><span style=color:#eceff4>,</span><span> maybe_each</span><span style=color:#eceff4>));</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        Ok</span><span style=color:#eceff4>(</span><span style=color:#88c0d0;font-weight:700>quote!</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>           struct</span><span> #builder</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                #</span><span style=color:#eceff4>(</span><span>#builder_fields</span><span style=color:#eceff4>),</span><span style=color:#81a1c1>*</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>            impl</span><span> #builder</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                #</span><span style=color:#eceff4>(</span><span>#builder_methods</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>*</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>                fn</span><span style=color:#88c0d0> build</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> ::</span><span>core</span><span style=color:#81a1c1>::</span><span>result</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;</span></span>
<span class=giallo-l><span>                    #ident</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    ::</span><span>std</span><span style=color:#81a1c1>::</span><span>boxed</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Box</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>dyn ::</span><span>std</span><span style=color:#81a1c1>::</span><span>error</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#eceff4>                ></span></span>
<span class=giallo-l><span style=color:#eceff4>                {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                    Ok</span><span style=color:#eceff4>(</span><span>#ident</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                        #</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>                            #idents</span><span style=color:#81a1c1>: self.</span><span>#idents</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>take</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>ok_or_else</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>||</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>                               format!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{}</span><span style=color:#a3be8c> is not provided</span><span style=color:#eceff4>",</span><span style=color:#88c0d0;font-weight:700> stringify!</span><span style=color:#eceff4>(</span><span>#idents</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#eceff4>                            )</span><span style=color:#81a1c1>?</span></span>
<span class=giallo-l><span style=color:#eceff4>                        ),</span><span style=color:#81a1c1>*</span></span>
<span class=giallo-l><span style=color:#eceff4>                    })</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>           impl</span><span> #ident</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                fn</span><span style=color:#88c0d0> builder</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span> #builder</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                    #builder</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                        #</span><span style=color:#eceff4>(</span><span>#builder_init_fields</span><span style=color:#eceff4>),</span><span style=color:#81a1c1>*</span></span>
<span class=giallo-l><span style=color:#eceff4>                    }</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        })</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Err</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Error</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>input</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>span</span><span style=color:#eceff4>(), "</span><span style=color:#a3be8c>Only struct supported</span><span style=color:#eceff4>"))</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>// ...</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>// ğŸ‘‡</span></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> inspect_each</span><span style=color:#eceff4>(</span><span>attr</span><span style=color:#81a1c1>: &</span><span>syn</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Attribute</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Ident</span><span style=color:#eceff4>>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    use</span><span> syn</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>Lit</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Meta</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> MetaList</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> MetaNameValue</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> NestedMeta</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> meta</span><span style=color:#81a1c1> =</span><span> attr</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>parse_meta</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    match &</span><span>meta</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Meta</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>List</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>MetaList</span><span style=color:#eceff4> {</span><span> path</span><span style=color:#eceff4>,</span><span> nested</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> ..</span><span style=color:#eceff4> })</span><span style=color:#81a1c1> if</span><span> path</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>is_ident</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>builder</span><span style=color:#eceff4>")</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            if let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>NestedMeta</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Meta</span><span style=color:#eceff4>(</span><span>Meta</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>NameValue</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>MetaNameValue</span><span style=color:#eceff4> {</span><span> lit</span><span style=color:#eceff4>,</span><span> path</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> ..</span><span style=color:#eceff4> })))</span><span style=color:#81a1c1> =</span></span>
<span class=giallo-l><span>            nested</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>first</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>            {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                match</span><span> lit</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                    Lit</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Str</span><span style=color:#eceff4>(</span><span>s</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> if</span><span> path</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>is_ident</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>each</span><span style=color:#eceff4>")</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                        Ok</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Some</span><span style=color:#eceff4>(</span><span style=color:#88c0d0;font-weight:700>format_ident!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{}</span><span style=color:#eceff4>",</span><span> s</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>value</span><span style=color:#eceff4>())))</span></span>
<span class=giallo-l><span style=color:#eceff4>                    }</span></span>
<span class=giallo-l><span>                    _</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Error</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>                        meta</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>span</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>                        "</span><span style=color:#a3be8c>expected `builder(each = </span><span style=color:#ebcb8b>\"</span><span style=color:#a3be8c>...</span><span style=color:#ebcb8b>\"</span><span style=color:#a3be8c>)`</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>                    )),</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Err</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Error</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>                    meta</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>span</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>                    "</span><span style=color:#a3be8c>expected `builder(each = </span><span style=color:#ebcb8b>\"</span><span style=color:#a3be8c>...</span><span style=color:#ebcb8b>\"</span><span style=color:#a3be8c>)`</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>                ))</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span>        _</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>None</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre> <p><code>builder</code> attributeã‚’ã†ã‘ã¨ã‚‹ãŸã‚ã«ã€top levelã®é–¢æ•°ã®annotationã‚’å¤‰æ›´ã—ã¦ã„ã¾ã™ã€‚<br> å…·ä½“çš„ã«ã¯ã€<code>#[proc_macro_derive(Builder, attributes(builder))]</code>ã®ã‚ˆã†ã«ã—ã¦builder attributeã‚’ä½¿ã†ã“ã¨ã‚’æŒ‡ç¤ºã—ã¦ã„ã¾ã™ã€‚<br> attributeã‚’å€¤ã‚’æŠ½å‡ºã™ã‚‹helperã‚’å®šç¾©ã€‚eachãŒæŒ‡å®šã•ã‚Œã¦ã„ãŸã‚‰builderã®methodç”Ÿæˆæ™‚ã«Vecå‹ã®signatureã‚’å¤‰æ›´ã—ã¾ã™ã€‚</p> <p>ç„¡äº‹ãƒ†ã‚¹ãƒˆã‚’ãƒ‘ã‚¹ã—ã¾ã—ãŸã€‚</p> <pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>â¯</span><span style=color:#a3be8c> cargo test --quiet</span></span>
<span class=giallo-l><span style=color:#88c0d0>running</span><span style=color:#b48ead> 0</span><span style=color:#a3be8c> tests</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>test</span><span style=color:#a3be8c> result: ok.</span><span style=color:#b48ead> 0</span><span style=color:#a3be8c> passed</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 0</span><span style=color:#a3be8c> failed</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 0</span><span style=color:#a3be8c> ignored</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 0</span><span style=color:#a3be8c> measured</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 0</span><span style=color:#a3be8c> filtered out</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> finished</span><span style=color:#a3be8c> in 0.00s</span></span>
<span class=giallo-l></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>running</span><span style=color:#b48ead> 1</span><span style=color:#a3be8c> test</span></span>
<span class=giallo-l><span style=color:#88c0d0>   Compiling</span><span style=color:#a3be8c> derive_builder v0.0.0</span><span> (/Users/ymgyt/rs/proc-macro-workshop-blog/builder)</span></span>
<span class=giallo-l><span style=color:#88c0d0>   Compiling</span><span style=color:#a3be8c> derive_builder-tests v0.0.0</span><span> (/Users/ymgyt/rs/proc-macro-workshop-blog/target/tests/derive_builder)</span></span>
<span class=giallo-l><span style=color:#88c0d0>    Finished</span><span style=color:#a3be8c> dev</span><span> [unoptimized</span><span style=color:#a3be8c> + debuginfo] target</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>s</span><span style=color:#eceff4>)</span><span style=color:#a3be8c> in 0.41s</span></span>
<span class=giallo-l></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>test</span><span style=color:#a3be8c> tests/07-repeated-field.rs ... ok</span></span></code></pre> <p><a href=https://github.com/ymgyt/proc-macro-workshop/tree/9ab9a673c37c14c1b60177bad4e8c6175545a2b8 rel=external>source code</a></p> <h2 id=08-unrecognized-attribute><a aria-label="Anchor link for: 08-unrecognized-attribute" class=zola-anchor href=#08-unrecognized-attribute><code>08-unrecognized-attribute</code></a></h2> <pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> tests</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> t</span><span style=color:#81a1c1> =</span><span> trybuild</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>TestCases</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span>    t</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>compile_fail</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>tests/08-unrecognized-attribute.rs</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre> <p><code>08-unrecognized-attribute</code>ã¯æ„å›³ã—ãªã„attributeãŒæ¸¡ã•ã‚ŒãŸå ´åˆã«é©åˆ‡ãªcompile errorã‚’è¿”ã›ã¦ã„ã‚‹ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãƒ†ã‚¹ãƒˆã§ã™ã€‚å…·ä½“çš„ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«<code>each</code>ãŒtypoã•ã‚Œã¦ã„ã¾ã™ã€‚</p> <pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Builder</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> Command</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    executable</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#616e88>    //         ğŸ‘‡</span></span>
<span class=giallo-l><span style=color:#5e81ac>    #[builder(eac = "</span><span style=color:#a3be8c>arg</span><span style=color:#5e81ac>")]</span></span>
<span class=giallo-l><span>    args</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Vec</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>    env</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Vec</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>    current_dir</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre> <p>testã‚’å®Ÿè¡Œã—ã¦ã¿ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«æ„å›³ã—ãŸã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã¡ã‚‡ã£ã¨ãšã‚Œã¦ã„ã¾ã™ã€‚</p> <pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>test</span><span style=color:#a3be8c> tests/08-unrecognized-attribute.rs ... mismatch</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>EXPECTED:</span></span>
<span class=giallo-l><span style=color:#88c0d0>â”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆ</span></span>
<span class=giallo-l><span style=color:#88c0d0>error:</span><span style=color:#a3be8c> expected</span><span style=color:#eceff4> `</span><span style=color:#88c0d0>builder(each</span><span style=color:#a3be8c> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>...</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>)</span><span style=color:#eceff4>`</span></span>
<span class=giallo-l><span style=color:#88c0d0>  --</span><span>></span><span style=color:#a3be8c> tests/08-unrecognized-attribute.rs:22:7</span></span>
<span class=giallo-l><span style=color:#81a1c1>   |</span></span>
<span class=giallo-l><span style=color:#88c0d0>22</span><span style=color:#81a1c1> |</span><span style=color:#616e88>     #[builder(eac = "arg")]</span></span>
<span class=giallo-l><span style=color:#81a1c1>   |</span><span style=color:#88c0d0>       ^^^^^^^^^^^^^^^^^^^^</span></span>
<span class=giallo-l><span style=color:#88c0d0>â”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆ</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>ACTUAL</span><span style=color:#a3be8c> OUTPUT:</span></span>
<span class=giallo-l><span style=color:#88c0d0>â”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆ</span></span>
<span class=giallo-l><span style=color:#88c0d0>error:</span><span style=color:#a3be8c> expected</span><span style=color:#eceff4> `</span><span style=color:#88c0d0>builder(each</span><span style=color:#a3be8c> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>...</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>)</span><span style=color:#eceff4>`</span></span>
<span class=giallo-l><span style=color:#88c0d0>  --</span><span>></span><span style=color:#a3be8c> tests/08-unrecognized-attribute.rs:22:7</span></span>
<span class=giallo-l><span style=color:#81a1c1>   |</span></span>
<span class=giallo-l><span style=color:#88c0d0>22</span><span style=color:#81a1c1> |</span><span style=color:#616e88>     #[builder(eac = "arg")]</span></span>
<span class=giallo-l><span style=color:#81a1c1>   |</span><span style=color:#88c0d0>       ^^^^^^^</span></span>
<span class=giallo-l><span style=color:#88c0d0>â”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆâ”ˆ</span></span></code></pre> <p><code>^</code>ã‚’`builderã‹ã‚‰å¼•æ•°ã®çµ‚ã‚ã‚Šã¾ã§ã¤ã‘ãŸã„ã®ã§ã™ãŒã€ç¾çŠ¶ã§ã¯builderã«ã—ã‹ä»˜ä¸ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã“ã‚Œã«å¯¾å¿œã™ã‚‹ãŸã‚ã«ä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚</p> <pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> inspect_each</span><span style=color:#eceff4>(</span><span>attr</span><span style=color:#81a1c1>: &</span><span>syn</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Attribute</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Ident</span><span style=color:#eceff4>>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    use</span><span> syn</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>Lit</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Meta</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> MetaList</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> MetaNameValue</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> NestedMeta</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> meta</span><span style=color:#81a1c1> =</span><span> attr</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>parse_meta</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    match &</span><span>meta</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Meta</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>List</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>MetaList</span><span style=color:#eceff4> {</span><span> path</span><span style=color:#eceff4>,</span><span> nested</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> ..</span><span style=color:#eceff4> })</span><span style=color:#81a1c1> if</span><span> path</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>is_ident</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>builder</span><span style=color:#eceff4>")</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            if let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>NestedMeta</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Meta</span><span style=color:#eceff4>(</span><span>Meta</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>NameValue</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>MetaNameValue</span><span style=color:#eceff4> {</span><span> lit</span><span style=color:#eceff4>,</span><span> path</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> ..</span><span style=color:#eceff4> })))</span><span style=color:#81a1c1> =</span></span>
<span class=giallo-l><span>            nested</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>first</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>            {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                match</span><span> lit</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                    Lit</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Str</span><span style=color:#eceff4>(</span><span>s</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> if</span><span> path</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>is_ident</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>each</span><span style=color:#eceff4>")</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                        Ok</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Some</span><span style=color:#eceff4>(</span><span style=color:#88c0d0;font-weight:700>format_ident!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{}</span><span style=color:#eceff4>",</span><span> s</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>value</span><span style=color:#eceff4>())))</span></span>
<span class=giallo-l><span style=color:#eceff4>                    }</span></span>
<span class=giallo-l><span>                    _</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>                        // ğŸ‘‡</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                        Err</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Error</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new_spanned</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>                            meta</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>                            "</span><span style=color:#a3be8c>expected `builder(each = </span><span style=color:#ebcb8b>\"</span><span style=color:#a3be8c>...</span><span style=color:#ebcb8b>\"</span><span style=color:#a3be8c>)`</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>                        ))</span></span>
<span class=giallo-l><span style=color:#eceff4>                    },</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>                // ğŸ‘‡</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Err</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Error</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new_spanned</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>                    meta</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>                    "</span><span style=color:#a3be8c>expected `builder(each = </span><span style=color:#ebcb8b>\"</span><span style=color:#a3be8c>...</span><span style=color:#ebcb8b>\"</span><span style=color:#a3be8c>)`</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>                ))</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span>        _</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>None</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre> <p>å…·ä½“çš„ã«ã¯ã€<code>syn::Error::new()</code>ã‚’<code>syn::Error::new_spanned()</code>ã«å¤‰æ›´ã—ã¦ã€å¼•æ•°ã«spanã§ã¯ãªãã€ç›´æ¥<code>syn::Meta</code>ã‚’æ¸¡ã—ã¾ã—ãŸã€‚</p> <p><code>syn::Error::new_spanned()</code>ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å®šç¾©ã•ã‚Œã¦ã„ã¾ã™ã€‚</p> <pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#616e88>/// Creates an error with the specified message spanning the given syntax</span></span>
<span class=giallo-l><span style=color:#616e88>/// tree node.</span></span>
<span class=giallo-l><span style=color:#616e88>///</span></span>
<span class=giallo-l><span style=color:#616e88>/// Unlike the `Error::new` constructor, this constructor takes an argument</span></span>
<span class=giallo-l><span style=color:#616e88>/// `tokens` which is a syntax tree node. This allows the resulting `Error`</span></span>
<span class=giallo-l><span style=color:#616e88>/// to attempt to span all tokens inside of `tokens`. While you would</span></span>
<span class=giallo-l><span style=color:#616e88>/// typically be able to use the `Spanned` trait with the above `Error::new`</span></span>
<span class=giallo-l><span style=color:#616e88>/// constructor, implementation limitations today mean that</span></span>
<span class=giallo-l><span style=color:#616e88>/// `Error::new_spanned` may provide a higher-quality error message on</span></span>
<span class=giallo-l><span style=color:#616e88>/// stable Rust.</span></span>
<span class=giallo-l><span style=color:#616e88>///</span></span>
<span class=giallo-l><span style=color:#616e88>/// When in doubt it's recommended to stick to `Error::new` (or</span></span>
<span class=giallo-l><span style=color:#616e88>/// `ParseStream::error`)!</span></span>
<span class=giallo-l><span style=color:#5e81ac>#[cfg(feature = "</span><span style=color:#a3be8c>printing</span><span style=color:#5e81ac>")]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub fn</span><span style=color:#88c0d0> new_spanned</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> ToTokens</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> U</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Display</span><span style=color:#eceff4>>(</span><span>tokens</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> T</span><span style=color:#eceff4>,</span><span> message</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> U</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> iter</span><span style=color:#81a1c1> =</span><span> tokens</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into_token_stream</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into_iter</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> start</span><span style=color:#81a1c1> =</span><span> iter</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>next</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>map_or_else</span><span style=color:#eceff4>(</span><span>Span</span><span style=color:#81a1c1>::</span><span>call_site</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> |</span><span>t</span><span style=color:#81a1c1>|</span><span> t</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>span</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> end</span><span style=color:#81a1c1> =</span><span> iter</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>last</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>map_or</span><span style=color:#eceff4>(</span><span>start</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> |</span><span>t</span><span style=color:#81a1c1>|</span><span> t</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>span</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Error</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>        messages</span><span style=color:#81a1c1>:</span><span style=color:#88c0d0;font-weight:700> vec!</span><span style=color:#eceff4>[</span><span style=color:#8fbcbb>ErrorMessage</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            start_span</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> ThreadBound</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>start</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span>            end_span</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> ThreadBound</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>end</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span>            message</span><span style=color:#81a1c1>:</span><span> message</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_string</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>        }],</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre> <blockquote><p>Creates an error with the specified message spanning the given syntax tree node.</blockquote> <p>ã¨ã‚ã‚‹ã®ã§ã€synå´ã§ã„ã„æ„Ÿã˜ã«token treeã‹ã‚‰spanã®é–‹å§‹ã¨çµ‚äº†ã‚’çµ„ã¿ç«‹ã¦ã¦ãã‚Œã¦ã„ã‚‹æ§˜ã§ã™ã€‚<br> å®Ÿè£…ã‚‚startã¨endã‚’å–å¾—ã—ã¦ã„ã‚‹ã®ã§ã€error messageã‚’è¿”ã™éš›ã¯ã“ã®methodã‚’ä½¿ã£ã¦ãŠã‘ã°ç›´æ„Ÿçš„ã«å•é¡Œã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰ãŒæŒ‡å®šã•ã‚Œãã†ã§ã™ã€‚</p> <p>ç„¡äº‹ãƒ†ã‚¹ãƒˆã‚‚é€šã‚Šã¾ã—ãŸã€‚<br> (stderrã‚‚ãƒ†ã‚¹ãƒˆã§ãã‚‹trybuildã‚‚ä¾¿åˆ©ã§ä»–ã«ã‚‚ä½¿ã„é“ãŒã‚ã‚Šãã†ã§ã‚‚ã£ã¨èª¿ã¹ã¦ã¿ãŸããªã‚Šã¾ã™)</p> <pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>â¯</span><span style=color:#a3be8c>  cargo test --quiet</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>running</span><span style=color:#b48ead> 0</span><span style=color:#a3be8c> tests</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>test</span><span style=color:#a3be8c> result: ok.</span><span style=color:#b48ead> 0</span><span style=color:#a3be8c> passed</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 0</span><span style=color:#a3be8c> failed</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 0</span><span style=color:#a3be8c> ignored</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 0</span><span style=color:#a3be8c> measured</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 0</span><span style=color:#a3be8c> filtered out</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> finished</span><span style=color:#a3be8c> in 0.00s</span></span>
<span class=giallo-l></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>running</span><span style=color:#b48ead> 1</span><span style=color:#a3be8c> test</span></span>
<span class=giallo-l><span style=color:#88c0d0>   Compiling</span><span style=color:#a3be8c> derive_builder v0.0.0</span><span> (/Users/ymgyt/rs/proc-macro-workshop-blog/builder)</span></span>
<span class=giallo-l><span style=color:#88c0d0>    Checking</span><span style=color:#a3be8c> derive_builder-tests v0.0.0</span><span> (/Users/ymgyt/rs/proc-macro-workshop-blog/target/tests/derive_builder)</span></span>
<span class=giallo-l><span style=color:#88c0d0>    Finished</span><span style=color:#a3be8c> dev</span><span> [unoptimized</span><span style=color:#a3be8c> + debuginfo] target</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>s</span><span style=color:#eceff4>)</span><span style=color:#a3be8c> in 0.42s</span></span>
<span class=giallo-l></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>test</span><span style=color:#a3be8c> tests/08-unrecognized-attribute.rs ... ok</span></span></code></pre> <p><a href=https://github.com/ymgyt/proc-macro-workshop/tree/c73568a39a76914af9d76c82b63ee38aabf0f7e6 rel=external>source code</a></p> <h2 id=09-redefined-prelude-type><a aria-label="Anchor link for: 09-redefined-prelude-type" class=zola-anchor href=#09-redefined-prelude-type><code>09-redefined-prelude-type</code></a></h2> <pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> tests</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> t</span><span style=color:#81a1c1> =</span><span> trybuild</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>TestCases</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span>    t</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>pass</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>tests/09-redefined-prelude-types.rs</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#616e88>    // ...</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre> <p>æœ€å¾Œã®ã‚±ãƒ¼ã‚¹ã¯stdã®ã‚ˆãä½¿ã‚ã‚Œã‚‹å‹ã«aliasãŒè¨­å®šã•ã‚Œã¦ã„ã¦ã‚‚æ©Ÿèƒ½ã™ã‚‹ã‹ã®ãƒ†ã‚¹ãƒˆã§ã™ã€‚<br> å…·ä½“çš„ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«<code>Option</code>ã‚„<code>Result</code>ã®aliasãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚<br> procedural macroã«é™ã‚‰ãšdeclarative macroã§ã‚‚å…±é€šã—ã¾ã™ãŒã€ãƒ¦ãƒ¼ã‚¶ã®import/aliasã«å½±éŸ¿ã•ã‚Œãªã„ã‚ˆã†ã«å‹ã‚’å‚ç…§ã™ã‚‹éš›ã¯ã™ã¹ã¦ãƒ•ãƒ«ãƒ‘ã‚¹ã«ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</p> <pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>type</span><span style=color:#8fbcbb> Option</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> ();</span></span>
<span class=giallo-l><span style=color:#81a1c1>type</span><span style=color:#8fbcbb> Some</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> ();</span></span>
<span class=giallo-l><span style=color:#81a1c1>type</span><span style=color:#8fbcbb> None</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> ();</span></span>
<span class=giallo-l><span style=color:#81a1c1>type</span><span style=color:#8fbcbb> Result</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> ();</span></span>
<span class=giallo-l><span style=color:#81a1c1>type</span><span style=color:#8fbcbb> Box</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> ();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Builder</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> Command</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    executable</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {}</span></span></code></pre> <p>å…ƒã€…ã€<code>::core::option::Option</code>ã®ã‚ˆã†ã«å‹ã‚’ãƒ•ãƒ«ãƒ‘ã‚¹ã§æŒ‡å®šã—ã¦ã„ãŸã®ã§ç‰¹ã«å¤‰æ›´ã›ãšã«ãƒ†ã‚¹ãƒˆã‚’ãƒ‘ã‚¹ã§ãã¾ã™ã€‚</p> <pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>â¯</span><span style=color:#a3be8c> cargo test --quiet</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>running</span><span style=color:#b48ead> 0</span><span style=color:#a3be8c> tests</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>test</span><span style=color:#a3be8c> result: ok.</span><span style=color:#b48ead> 0</span><span style=color:#a3be8c> passed</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 0</span><span style=color:#a3be8c> failed</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 0</span><span style=color:#a3be8c> ignored</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 0</span><span style=color:#a3be8c> measured</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 0</span><span style=color:#a3be8c> filtered out</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> finished</span><span style=color:#a3be8c> in 0.00s</span></span>
<span class=giallo-l></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>running</span><span style=color:#b48ead> 1</span><span style=color:#a3be8c> test</span></span>
<span class=giallo-l><span style=color:#88c0d0>   Compiling</span><span style=color:#a3be8c> derive_builder-tests v0.0.0</span><span> (/Users/ymgyt/rs/proc-macro-workshop-blog/target/tests/derive_builder)</span></span>
<span class=giallo-l><span style=color:#88c0d0>    Finished</span><span style=color:#a3be8c> dev</span><span> [unoptimized</span><span style=color:#a3be8c> + debuginfo] target</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>s</span><span style=color:#eceff4>)</span><span style=color:#a3be8c> in 0.13s</span></span>
<span class=giallo-l></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>test</span><span style=color:#a3be8c> tests/09-redefined-prelude-types.rs ... ok</span></span></code></pre><h2 id=matome><a aria-label="Anchor link for: matome" class=zola-anchor href=#matome>ã¾ã¨ã‚</a></h2> <p>ä»Šã¾ã§ã¯test caseã‚’ä¸€ã¤ãšã¤æœ‰åŠ¹ã«ã—ã¦ã„ã¾ã—ãŸãŒé€šã—ã§å®Ÿè¡Œã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚</p> <pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> tests</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> t</span><span style=color:#81a1c1> =</span><span> trybuild</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>TestCases</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span>    t</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>pass</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>tests/01-parse.rs</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span>    t</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>pass</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>tests/02-create-builder.rs</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span>    t</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>pass</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>tests/03-call-setters.rs</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span>    t</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>pass</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>tests/04-call-build.rs</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span>    t</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>pass</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>tests/05-method-chaining.rs</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span>    t</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>pass</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>tests/06-optional-field.rs</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span>    t</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>pass</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>tests/07-repeated-field.rs</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span>    t</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>compile_fail</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>tests/08-unrecognized-attribute.rs</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span>    t</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>pass</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>tests/09-redefined-prelude-types.rs</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=shellscript><span class=giallo-l><span style=color:#88c0d0>â¯</span><span style=color:#a3be8c> cargo test --quiet</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>running</span><span style=color:#b48ead> 0</span><span style=color:#a3be8c> tests</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>test</span><span style=color:#a3be8c> result: ok.</span><span style=color:#b48ead> 0</span><span style=color:#a3be8c> passed</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 0</span><span style=color:#a3be8c> failed</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 0</span><span style=color:#a3be8c> ignored</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 0</span><span style=color:#a3be8c> measured</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> 0</span><span style=color:#a3be8c> filtered out</span><span style=color:#81a1c1>;</span><span style=color:#88c0d0> finished</span><span style=color:#a3be8c> in 0.00s</span></span>
<span class=giallo-l></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>running</span><span style=color:#b48ead> 1</span><span style=color:#a3be8c> test</span></span>
<span class=giallo-l><span style=color:#88c0d0>   Compiling</span><span style=color:#a3be8c> derive_builder-tests v0.0.0</span><span> (/Users/ymgyt/rs/proc-macro-workshop-blog/target/tests/derive_builder)</span></span>
<span class=giallo-l><span style=color:#88c0d0>    Finished</span><span style=color:#a3be8c> dev</span><span> [unoptimized</span><span style=color:#a3be8c> + debuginfo] target</span><span style=color:#eceff4>(</span><span style=color:#88c0d0>s</span><span style=color:#eceff4>)</span><span style=color:#a3be8c> in 0.14s</span></span>
<span class=giallo-l></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>test</span><span style=color:#a3be8c> tests/01-parse.rs</span><span> [should</span><span style=color:#a3be8c> pass] ... ok</span></span>
<span class=giallo-l><span style=color:#88c0d0>test</span><span style=color:#a3be8c> tests/02-create-builder.rs</span><span> [should</span><span style=color:#a3be8c> pass] ... ok</span></span>
<span class=giallo-l><span style=color:#88c0d0>test</span><span style=color:#a3be8c> tests/03-call-setters.rs</span><span> [should</span><span style=color:#a3be8c> pass] ... ok</span></span>
<span class=giallo-l><span style=color:#88c0d0>test</span><span style=color:#a3be8c> tests/04-call-build.rs</span><span> [should</span><span style=color:#a3be8c> pass] ... ok</span></span>
<span class=giallo-l><span style=color:#88c0d0>test</span><span style=color:#a3be8c> tests/05-method-chaining.rs</span><span> [should</span><span style=color:#a3be8c> pass] ... ok</span></span>
<span class=giallo-l><span style=color:#88c0d0>test</span><span style=color:#a3be8c> tests/06-optional-field.rs</span><span> [should</span><span style=color:#a3be8c> pass] ... ok</span></span>
<span class=giallo-l><span style=color:#88c0d0>test</span><span style=color:#a3be8c> tests/07-repeated-field.rs</span><span> [should</span><span style=color:#a3be8c> pass] ... ok</span></span>
<span class=giallo-l><span style=color:#88c0d0>test</span><span style=color:#a3be8c> tests/08-unrecognized-attribute.rs</span><span> [should</span><span style=color:#a3be8c> fail to compile] ... ok</span></span>
<span class=giallo-l><span style=color:#88c0d0>test</span><span style=color:#a3be8c> tests/09-redefined-prelude-types.rs</span><span> [should</span><span style=color:#a3be8c> pass] ... ok</span></span></code></pre> <p>ç„¡äº‹å…¨ã¦ã‚±ãƒ¼ã‚¹ã‚’ãƒ‘ã‚¹ã§ãã¾ã—ãŸğŸ‰<br> <a href=https://github.com/ymgyt/proc-macro-workshop/tree/1dc0ce4f7b86b4f9e97e79efce454793aef2a98e rel=external>source code</a></p> <p>æœ€çµ‚çš„ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚</p> <pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> proc_macro</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>TokenStream</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> proc_macro2</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>TokenStream</span><span style=color:#81a1c1> as</span><span style=color:#8fbcbb> TokenStream2</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> quote</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span>format_ident</span><span style=color:#eceff4>,</span><span> quote</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> syn</span><span style=color:#81a1c1>::</span><span>spanned</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Spanned</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> syn</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span>    parse_macro_input</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Data</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> DataStruct</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> DeriveInput</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Error</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Fields</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> FieldsNamed</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Ident</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Type</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>};</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[proc_macro_derive(</span><span style=color:#8fbcbb>Builder</span><span style=color:#5e81ac>, attributes(builder))]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub fn</span><span style=color:#88c0d0> derive</span><span style=color:#eceff4>(</span><span>input</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> TokenStream</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> TokenStream</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> input</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> DeriveInput</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0;font-weight:700> parse_macro_input!</span><span style=color:#eceff4>(</span><span>input</span><span style=color:#81a1c1> as</span><span style=color:#8fbcbb> DeriveInput</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    match</span><span style=color:#88c0d0> derive_builder</span><span style=color:#eceff4>(</span><span>input</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Ok</span><span style=color:#eceff4>(</span><span>token_stream</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> TokenStream</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from</span><span style=color:#eceff4>(</span><span>token_stream</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Err</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> TokenStream</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_compile_error</span><span style=color:#eceff4>()),</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> derive_builder</span><span style=color:#eceff4>(</span><span>input</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> DeriveInput</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>TokenStream2</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    if let</span><span style=color:#8fbcbb> Data</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Struct</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>DataStruct</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>        fields</span><span style=color:#81a1c1>:</span><span> Fields</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Named</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>FieldsNamed</span><span style=color:#eceff4> {</span><span> named</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> ..</span><span style=color:#eceff4> }),</span></span>
<span class=giallo-l><span style=color:#81a1c1>        ..</span></span>
<span class=giallo-l><span style=color:#eceff4>    })</span><span style=color:#81a1c1> =</span><span> input</span><span style=color:#81a1c1>.</span><span>data</span></span>
<span class=giallo-l><span style=color:#eceff4>    {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> ident</span><span style=color:#81a1c1> =</span><span> input</span><span style=color:#81a1c1>.</span><span>ident</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> builder</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0;font-weight:700> format_ident!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{}</span><span style=color:#a3be8c>Builder</span><span style=color:#eceff4>",</span><span> ident</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> fields</span><span style=color:#81a1c1> =</span><span> named</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>iter</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>map</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>f</span><span style=color:#81a1c1>|</span><span style=color:#eceff4> (</span><span>f</span><span style=color:#81a1c1>.</span><span>ident</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_ref</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>expect</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>field have ident</span><span style=color:#eceff4>"),</span><span style=color:#81a1c1> &</span><span>f</span><span style=color:#81a1c1>.</span><span>ty</span><span style=color:#eceff4>));</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> idents</span><span style=color:#81a1c1> =</span><span> fields</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>map</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span style=color:#eceff4>(</span><span>ident</span><span style=color:#eceff4>,</span><span> _</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>|</span><span> ident</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> builder_fields</span><span style=color:#81a1c1> =</span><span> fields</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>map</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span style=color:#eceff4>(</span><span>ident</span><span style=color:#eceff4>,</span><span> ty</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>|</span><span style=color:#88c0d0;font-weight:700> quote!</span><span style=color:#eceff4> {</span><span>#ident</span><span style=color:#81a1c1>: ::</span><span>core</span><span style=color:#81a1c1>::</span><span>option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Option</span><span style=color:#eceff4>&lt;</span><span>#ty</span><span style=color:#eceff4>>});</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> builder_init_fields</span><span style=color:#81a1c1> =</span><span> fields</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>map</span><span style=color:#eceff4>(</span><span>builder_init_field</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> each_attributes</span><span style=color:#81a1c1> =</span><span> named</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>iter</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>map</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>f</span><span style=color:#81a1c1>| match</span><span> f</span><span style=color:#81a1c1>.</span><span>attrs</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>first</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Some</span><span style=color:#eceff4>(</span><span>attr</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#88c0d0> inspect_each</span><span style=color:#eceff4>(</span><span>attr</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            None</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>None</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>        })</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>collect</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Vec</span><span style=color:#eceff4>&lt;</span><span>_</span><span style=color:#eceff4>>>>()</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> builder_methods</span><span style=color:#81a1c1> =</span><span> fields</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>zip</span><span style=color:#eceff4>(</span><span>each_attributes</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>            .</span><span style=color:#88c0d0>map</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span style=color:#eceff4>((</span><span>ident</span><span style=color:#eceff4>,</span><span> ty</span><span style=color:#eceff4>),</span><span> maybe_each</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>|</span><span style=color:#88c0d0> impl_builder_method</span><span style=color:#eceff4>(</span><span>ident</span><span style=color:#eceff4>,</span><span> ty</span><span style=color:#eceff4>,</span><span> maybe_each</span><span style=color:#eceff4>));</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        Ok</span><span style=color:#eceff4>(</span><span style=color:#88c0d0;font-weight:700>quote!</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>           struct</span><span> #builder</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                #</span><span style=color:#eceff4>(</span><span>#builder_fields</span><span style=color:#eceff4>),</span><span style=color:#81a1c1>*</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>            impl</span><span> #builder</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                #</span><span style=color:#eceff4>(</span><span>#builder_methods</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>*</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>                fn</span><span style=color:#88c0d0> build</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> ::</span><span>core</span><span style=color:#81a1c1>::</span><span>result</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;</span></span>
<span class=giallo-l><span>                    #ident</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    ::</span><span>std</span><span style=color:#81a1c1>::</span><span>boxed</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Box</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>dyn ::</span><span>std</span><span style=color:#81a1c1>::</span><span>error</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#eceff4>                ></span></span>
<span class=giallo-l><span style=color:#eceff4>                {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                    Ok</span><span style=color:#eceff4>(</span><span>#ident</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                        #</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>                            #idents</span><span style=color:#81a1c1>: self.</span><span>#idents</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>take</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>ok_or_else</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>||</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>                               format!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{}</span><span style=color:#a3be8c> is not provided</span><span style=color:#eceff4>",</span><span style=color:#88c0d0;font-weight:700> stringify!</span><span style=color:#eceff4>(</span><span>#idents</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#eceff4>                            )</span><span style=color:#81a1c1>?</span></span>
<span class=giallo-l><span style=color:#eceff4>                        ),</span><span style=color:#81a1c1>*</span></span>
<span class=giallo-l><span style=color:#eceff4>                    })</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>           impl</span><span> #ident</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                fn</span><span style=color:#88c0d0> builder</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span> #builder</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                    #builder</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                        #</span><span style=color:#eceff4>(</span><span>#builder_init_fields</span><span style=color:#eceff4>),</span><span style=color:#81a1c1>*</span></span>
<span class=giallo-l><span style=color:#eceff4>                    }</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        })</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Err</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Error</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>input</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>span</span><span style=color:#eceff4>(), "</span><span style=color:#a3be8c>Only struct supported</span><span style=color:#eceff4>"))</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> impl_builder_method</span><span style=color:#eceff4>(</span><span>ident</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Ident</span><span style=color:#eceff4>,</span><span> ty</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Type</span><span style=color:#eceff4>,</span><span> each</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Ident</span><span style=color:#eceff4>>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> TokenStream2</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> has_each</span><span style=color:#81a1c1> =</span><span> each</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>is_some</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>    match</span><span style=color:#88c0d0> field_type</span><span style=color:#eceff4>(</span><span>ty</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        FieldType</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Option</span><span style=color:#eceff4>(</span><span>inner_ty</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>            quote!</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                fn</span><span> #ident</span><span style=color:#eceff4> (</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> #ident</span><span style=color:#81a1c1>:</span><span> #inner_ty</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> &mut Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    self.</span><span>#ident</span><span style=color:#81a1c1> = ::</span><span>core</span><span style=color:#81a1c1>::</span><span>option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Some</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#81a1c1>                        ::</span><span>core</span><span style=color:#81a1c1>::</span><span>option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Some</span><span style=color:#eceff4>(</span><span>#ident</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#eceff4>                    );</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    self</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        FieldType</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Vec</span><span style=color:#eceff4>(</span><span>inner_ty</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> if</span><span> has_each</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let</span><span> each</span><span style=color:#81a1c1> =</span><span> each</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>           quote!</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>               fn</span><span> #each</span><span style=color:#eceff4> (</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> #each</span><span style=color:#81a1c1>:</span><span> #inner_ty</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> &mut Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                   self.</span><span>#ident</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_mut</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>map</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>v</span><span style=color:#81a1c1>|</span><span> v</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>push</span><span style=color:#eceff4>(</span><span>#each</span><span style=color:#eceff4>));</span></span>
<span class=giallo-l><span style=color:#81a1c1>                   self</span></span>
<span class=giallo-l><span style=color:#eceff4>               }</span></span>
<span class=giallo-l><span style=color:#eceff4>           }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span>        _</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>            quote!</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                fn</span><span> #ident</span><span style=color:#eceff4> (</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> #ident</span><span style=color:#81a1c1>:</span><span> #ty</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -> &mut Self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    self.</span><span>#ident</span><span style=color:#81a1c1> = ::</span><span>core</span><span style=color:#81a1c1>::</span><span>option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Some</span><span style=color:#eceff4>(</span><span>#ident</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    self</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> builder_init_field</span><span style=color:#eceff4>((</span><span>ident</span><span style=color:#eceff4>,</span><span> ty</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>:</span><span style=color:#eceff4> (</span><span style=color:#81a1c1>&</span><span style=color:#8fbcbb>Ident</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> &</span><span style=color:#8fbcbb>Type</span><span style=color:#eceff4>))</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> TokenStream2</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    match</span><span style=color:#88c0d0> field_type</span><span style=color:#eceff4>(</span><span>ty</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        FieldType</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Option</span><span style=color:#eceff4>(</span><span>_inner_ty</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>            quote!</span><span style=color:#eceff4> {</span><span> #ident</span><span style=color:#81a1c1>: ::</span><span>core</span><span style=color:#81a1c1>::</span><span>option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Some</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>::</span><span>core</span><span style=color:#81a1c1>::</span><span>option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>None</span><span style=color:#eceff4>)}</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        FieldType</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Vec</span><span style=color:#eceff4>(</span><span>_inner_ty</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>            quote!</span><span style=color:#eceff4> {</span><span> #ident</span><span style=color:#81a1c1>: ::</span><span>core</span><span style=color:#81a1c1>::</span><span>option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Some</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>::</span><span>std</span><span style=color:#81a1c1>::</span><span>vec</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Vec</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>())}</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        FieldType</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Raw</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>            quote!</span><span style=color:#eceff4> {</span><span> #ident</span><span style=color:#81a1c1>: ::</span><span>core</span><span style=color:#81a1c1>::</span><span>option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Option</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>None</span><span style=color:#eceff4>}</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> field_type</span><span style=color:#eceff4>(</span><span>ty</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Type</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> FieldType</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    use</span><span> syn</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        AngleBracketedGenericArguments</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> GenericArgument</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Path</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> PathArguments</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> PathSegment</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> TypePath</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    };</span></span>
<span class=giallo-l><span style=color:#81a1c1>    if let</span><span style=color:#8fbcbb> Type</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Path</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>TypePath</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>        qself</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> None</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        path</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Path</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            leading_colon</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            segments</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>        },</span></span>
<span class=giallo-l><span style=color:#eceff4>    })</span><span style=color:#81a1c1> =</span><span> ty</span></span>
<span class=giallo-l><span style=color:#eceff4>    {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if</span><span> leading_colon</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>is_none</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> &&</span><span> segments</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>len</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> ==</span><span style=color:#b48ead> 1</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            if let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>PathSegment</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                ident</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>                arguments</span><span style=color:#81a1c1>:</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                    PathArguments</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>AngleBracketed</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>AngleBracketedGenericArguments</span><span style=color:#eceff4> {</span><span> args</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> ..</span><span style=color:#eceff4> }),</span></span>
<span class=giallo-l><span style=color:#eceff4>            })</span><span style=color:#81a1c1> =</span><span> segments</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>first</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>            {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                if let</span><span style=color:#eceff4> (</span><span style=color:#b48ead>1</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>GenericArgument</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Type</span><span style=color:#eceff4>(</span><span>t</span><span style=color:#eceff4>)))</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> (</span><span>args</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>len</span><span style=color:#eceff4>(),</span><span> args</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>first</span><span style=color:#eceff4>()) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    if</span><span> ident</span><span style=color:#81a1c1> ==</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>Option</span><span style=color:#eceff4>" {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                        return</span><span style=color:#8fbcbb> FieldType</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Option</span><span style=color:#eceff4>(</span><span>t</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#eceff4>                    }</span><span style=color:#81a1c1> else if</span><span> ident</span><span style=color:#81a1c1> ==</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>Vec</span><span style=color:#eceff4>" {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                        return</span><span style=color:#8fbcbb> FieldType</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Vec</span><span style=color:#eceff4>(</span><span>t</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#eceff4>                    }</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    FieldType</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Raw</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>enum</span><span style=color:#8fbcbb> FieldType</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Raw</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#88c0d0>    Option</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Type</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#88c0d0>    Vec</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Type</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> inspect_each</span><span style=color:#eceff4>(</span><span>attr</span><span style=color:#81a1c1>: &</span><span>syn</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Attribute</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Ident</span><span style=color:#eceff4>>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    use</span><span> syn</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>Lit</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Meta</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> MetaList</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> MetaNameValue</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> NestedMeta</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> meta</span><span style=color:#81a1c1> =</span><span> attr</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>parse_meta</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    match &</span><span>meta</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Meta</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>List</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>MetaList</span><span style=color:#eceff4> {</span><span> path</span><span style=color:#eceff4>,</span><span> nested</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> ..</span><span style=color:#eceff4> })</span><span style=color:#81a1c1> if</span><span> path</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>is_ident</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>builder</span><span style=color:#eceff4>")</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            if let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>NestedMeta</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Meta</span><span style=color:#eceff4>(</span><span>Meta</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>NameValue</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>MetaNameValue</span><span style=color:#eceff4> {</span><span> lit</span><span style=color:#eceff4>,</span><span> path</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> ..</span><span style=color:#eceff4> })))</span><span style=color:#81a1c1> =</span></span>
<span class=giallo-l><span>            nested</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>first</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>            {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                match</span><span> lit</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                    Lit</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Str</span><span style=color:#eceff4>(</span><span>s</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> if</span><span> path</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>is_ident</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>each</span><span style=color:#eceff4>")</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                        Ok</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Some</span><span style=color:#eceff4>(</span><span style=color:#88c0d0;font-weight:700>format_ident!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{}</span><span style=color:#eceff4>",</span><span> s</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>value</span><span style=color:#eceff4>())))</span></span>
<span class=giallo-l><span style=color:#eceff4>                    }</span></span>
<span class=giallo-l><span>                    _</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                        Err</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Error</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new_spanned</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>                            meta</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>                            "</span><span style=color:#a3be8c>expected `builder(each = </span><span style=color:#ebcb8b>\"</span><span style=color:#a3be8c>...</span><span style=color:#ebcb8b>\"</span><span style=color:#a3be8c>)`</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>                        ))</span></span>
<span class=giallo-l><span style=color:#eceff4>                    },</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Err</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Error</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new_spanned</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span>                    meta</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>                    "</span><span style=color:#a3be8c>expected `builder(each = </span><span style=color:#ebcb8b>\"</span><span style=color:#a3be8c>...</span><span style=color:#ebcb8b>\"</span><span style=color:#a3be8c>)`</span><span style=color:#eceff4>",</span></span>
<span class=giallo-l><span style=color:#eceff4>                ))</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span>        _</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>None</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre> <p>ç°¡å˜ã«ã§ã™ãŒbuilder projectã‚’ã‚„ã£ã¦ã¿ã¾ã—ãŸã€‚<br> synã®APIã‚’ç†è§£ã—ã¦ã€å®Ÿè£…ã—ãŸã„å‹ã‚’é©åˆ‡ã«åˆ†å‰²ã—ã¦éƒ¨åˆ†çš„ã«çµ„ã¿ç«‹ã¦ã‚‰ã‚Œã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚<br> token streamã®parseã¯ã™ã§ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€rustã®iteratorç­‰ã‚’æ™®æ®µã¨åŒã˜æ§˜ã«ä½¿ãˆã‚‹ã®ã§éå¸¸ã«è¡¨ç¾åŠ›ãŒé«˜ã„ã¨æ„Ÿã˜ã¾ã—ãŸã€‚ã¾ãŸã€<code>quote!</code>ã—ã¦ã—ã¾ã†ã¨TokenStreamã«ãªã£ã¦å‹ã¨ã—ã¦ã¯æƒ…å ±ã‚’å¤±ã†ã®ã§ã€ã§ãã‚‹ã ã‘é€”ä¸­çµæœã‚’è¡¨ç¾ã™ã‚‹å‹ã‚’ç”¨æ„ã—ã¦ã€æœ€å¾Œã«quoteã™ã‚‹ã‚ˆã†ã«ã—ãªã„ã¨ã©ã‚“ã©ã‚“èª­ã¿ã«ãããªã‚‹ãªã¨æ„Ÿã˜ã¾ã—ãŸã€‚ä»Šå›ã®çŸ­ã„ä¾‹ã§ã‚‚ã€builderã®åˆæœŸå€¤ã¯ã“ã†ãªã£ã¦ã‚‹ã‹ã‚‰...ã¨è€ƒãˆãªãŒã‚‰ã‚„ã£ãŸã®ã§ã‚ˆã‚Šè¤‡é›‘ãªãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã«å¯¾å¿œã™ã‚‹ã«ã¯filedæ¯ã®parseçµæœã‚’ä¿æŒã™ã‚‹å‹ã‚’å®šç¾©ã—ã¦ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆæ›¸ããªãŒã‚‰è¡Œã„ãŸã„ã¨æ€ã„ã¾ã—ãŸã€‚</p> <footer class=blog-footer><p>Â© 2026 <a href=https://blog.ymgyt.io> ymgyt </a> | Made with <a href=https://www.getzola.org rel=noopener target=_blank>Zola</a> | <a href=https://github.com/ymgyt/blog>Repository</a> | <a href=https://blog.ymgyt.io/atom.xml target=_blank title=rss> <svg viewbox="0 0 24 24" class=icon fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx=5 cy=19 r=1></circle></svg> </a></footer> 