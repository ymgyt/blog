<!doctype html><html lang=ja><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1" name=viewport><link href=https://blog.ymgyt.io/favicon.ico rel=icon sizes=any><link href=https://blog.ymgyt.io/icon.svg rel=icon type=image/svg+xml><link href=https://blog.ymgyt.io/apple-touch-icon.png rel=apple-touch-icon><link href=https://blog.ymgyt.io/manifest.webmanifest rel=manifest><link href=https://blog.ymgyt.io/style.css rel=stylesheet><link href=https://blog.ymgyt.io/atom.xml rel=alternate title=Atom type=application/atom+xml><script src="https://www.googletagmanager.com/gtag/js?id=G-GTB0KMLN90" async></script><script>window.dataLayer = window.dataLayer || [];
	function gtag() {dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-GTB0KMLN90');</script><title>ğŸ“— Write Powerful Rust Macrosã‚’èª­ã‚“ã æ„Ÿæƒ³ | Happy developing</title><meta content=ä¸€å†Šã¾ã‚‹ã”ã¨Macroã«ã¤ã„ã¦ã®æœ¬ name=description><meta content=summary name=twitter:card><meta content="@YAmaguchixt " name=twitter:site><meta content="ğŸ“— Write Powerful Rust Macrosã‚’èª­ã‚“ã æ„Ÿæƒ³" name=twitter:title><meta content=ä¸€å†Šã¾ã‚‹ã”ã¨Macroã«ã¤ã„ã¦ã®æœ¬ name=twitter:description><meta content=https://blog.ymgyt.io/images/emoji/green_book.png name=twitter:image><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><body><div class=world><div class=content-container><header class=blog-header-container><div class=blog-logo><a href=https://blog.ymgyt.io>Happy developing</a></div><div class=blog-nav><nav><ul><li><a href=https://blog.ymgyt.io/entry/>Entries</a><li><a href=https://blog.ymgyt.io/tags/>Tags</a><li><a href=https://blog.ymgyt.io/about/>About</a><li><a href=https://github.com/ymgyt> <img alt=Github class=icon src=https://blog.ymgyt.io/images/icon/github.svg> </a><li><a href="https://twitter.com/YAmaguchixt "> <img alt=Twitter class=icon src=https://blog.ymgyt.io/images/icon/twitter.svg> </a></ul></nav></div></header><main class=blog-main><article><header class=entry-header><h1 class=entry-title>ğŸ“— Write Powerful Rust Macrosã‚’èª­ã‚“ã æ„Ÿæƒ³</h1><div class=entry-meta><p class=entry-meta-item>ğŸ—“ 2024-07-15<p class=entry-meta-item>ğŸ· <span class=tag><a href=https://blog.ymgyt.io/tags/rust/>rust</a></span> <span class=tag><a href=https://blog.ymgyt.io/tags/book/>book</a></span></div></header><aside class=entry-toc><nav><ul class=entry-toc-toplevel-list><li><a href=https://blog.ymgyt.io/entry/write-powerful-rust-macros/#du-ndaben>èª­ã‚“ã æœ¬</a><li><a href=https://blog.ymgyt.io/entry/write-powerful-rust-macros/#1-going-meta>1 Going meta</a><li><a href=https://blog.ymgyt.io/entry/write-powerful-rust-macros/#2-declarative-macros>2 Declarative macros</a><li><a href=https://blog.ymgyt.io/entry/write-powerful-rust-macros/#3-a-hello-world-procedural-macro>3 A "Hello, World" procedural macro</a><li><a href=https://blog.ymgyt.io/entry/write-powerful-rust-macros/#4-making-fields-public-with-attribute-macros>4 Making fields public with attribute macros</a><li><a href=https://blog.ymgyt.io/entry/write-powerful-rust-macros/#5-hiding-information-and-creating-mini-dlss-with-function-like-macros>5 Hiding information and creating mini-DLSs with function-like macros</a><li><a href=https://blog.ymgyt.io/entry/write-powerful-rust-macros/#6-testing-a-builder-macro>6 Testing a builder macro</a><li><a href=https://blog.ymgyt.io/entry/write-powerful-rust-macros/#7-from-panic-to-result-error-handling>7 From panic to result: Error handling</a><li><a href=https://blog.ymgyt.io/entry/write-powerful-rust-macros/#8-builder-with-attributes>8 Builder with attributes</a><li><a href=https://blog.ymgyt.io/entry/write-powerful-rust-macros/#9-writing-an-infrastructure-dsl>9 Writing an infrastructure DSL</a><li><a href=https://blog.ymgyt.io/entry/write-powerful-rust-macros/#10-macros-and-the-outside-world>10 Macros and the outside world</a><li><a href=https://blog.ymgyt.io/entry/write-powerful-rust-macros/#matome>ã¾ã¨ã‚</a></ul></nav></aside><div class=entry-content><h2 id=du-ndaben><a aria-label="Anchor link for: du-ndaben" class=zola-anchor href=#du-ndaben>èª­ã‚“ã æœ¬</a></h2><a href=https://www.manning.com/books/write-powerful-rust-macros> <figure><div class=fig-images-row><img , alt src=images/macro-book.jpg></div><figcaption>Write Powerful Rust Macros</figcaption></figure> </a><p>è‘—è€…: Sam Van Overmeire<p><a href=https://rustacean-station.org/episode/sam-van-overmeire/ rel=external>Rustacean station</a>ã¨ã„ã†podcastã§ç´¹ä»‹ã•ã‚Œã¦ã„ã¦ã€ãŠã‚‚ã—ã‚ãã†ã ã£ãŸã®ã§èª­ã‚“ã§ã¿ã¾ã—ãŸã€‚<h2 id=1-going-meta><a aria-label="Anchor link for: 1-going-meta" class=zola-anchor href=#1-going-meta>1 Going meta</a></h2><p>hygieneã‚„compileæ™‚ã«ãƒã‚§ãƒƒã‚¯ã•ã‚Œã‚‹ç­‰ã€Rustã®macroã®ç‰¹å¾´ã«ã¤ã„ã¦ã€‚<br> Procedural macroã¯derive macro, attribute macro, function like macroã«åˆ†é¡ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã‚‰ã«ã©ã†ã„ã£ãŸé•ã„ãŒã‚ã‚‹ã®ã‹è‡ªåˆ†ã¯æ›–æ˜§ã«ç†è§£ã—ã¦ã„ãŸã®ã§ã™ãŒã€deriveã¯codeã®è¿½åŠ ã®ã¿ã€attributeã¨function likeã¯codeã®å¤‰æ›´ã‚„å‰Šé™¤ã¾ã§ã§ãã‚‹ã¨ã„ã†é•ã„ãŒã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚<h2 id=2-declarative-macros><a aria-label="Anchor link for: 2-declarative-macros" class=zola-anchor href=#2-declarative-macros>2 Declarative macros</a></h2><p>Declarative macroã«ã¤ã„ã¦ã®ç« ã§ã™ã€‚<br> Declarative macroã®åŸºæœ¬çš„ãªæ›¸ãæ–¹ã‹ã‚‰ã€hygieneã¾ã§è§£èª¬ãŒã‚ã‚Šã¾ã™ã€‚<br> Usecaseã¨ã—ã¦ã€newtype patternå®Ÿè£…æ™‚ã®boilerplateã®è¨˜è¿°ç­‰ãŒç´¹ä»‹ã•ã‚Œã¾ã™ã€‚<br> ã¾ãŸã€<code>trace_macros!</code>ã‚„<code>log_syntax!</code>ã«ã‚ˆã‚‹debugæ–¹æ³•ã®è§£èª¬ã‚‚ã‚ã‚Šã¾ã™ã€‚<br> <code>log_syntax!</code>ã¯ä½¿ã£ãŸã“ã¨ãŒãªã‹ã£ãŸã§ã™ã€‚compileæ™‚ã«debugã§ãã‚‹ã®ã§<code>cargo check</code>ã§macroã‚’debugã§ãã¾ã™ã€‚<p>ãã®ä»–ã€ç°¡å˜ãªDSLã‚„é–¢æ•°ã‚’composeã™ã‚‹ä¾‹ãŒè¼‰ã£ã¦ã„ã¾ã™ã€‚<br> Real world usecaseã¨ã—ã¦<code>lazy_static!</code>ã®å®Ÿè£…ã®è§£èª¬ã‚‚ã‚ã‚Šã¾ã™ã€‚<h2 id=3-a-hello-world-procedural-macro><a aria-label="Anchor link for: 3-a-hello-world-procedural-macro" class=zola-anchor href=#3-a-hello-world-procedural-macro>3 A "Hello, World" procedural macro</a></h2><p>3ç« ã‹ã‚‰ã¯procedural macroã®è©±ã«ãªã‚Šã¾ã™ã€‚<br> ã¾ãšderive macroã®èª¬æ˜ã‹ã‚‰å§‹ã¾ã‚Šã¾ã™ã€‚ projectã®setupã®ä»•æ–¹ã‹ã‚‰macroã®å‡¦ç†ã®æ¦‚è¦ã€<code>syn</code>ã‚„<code>quote</code>ã®åŸºæœ¬çš„ãªä½¿ã„æ–¹ãŒè§£èª¬ã•ã‚Œã¾ã™ã€‚<br> ä»¥ä¸‹ã®ã‚ˆã†ãª<code>#[derive(Hello)]</code>ã®å®Ÿè£…ã‚’1è¡Œã¥ã¤èª¬æ˜ã—ã¦ãã‚Œã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> proc_macro</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>TokenStream</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> quote</span><span style=color:#81a1c1>::</span><span>quote</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> syn</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>DeriveInput</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[proc_macro_derive(</span><span style=color:#8fbcbb>Hello</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub fn</span><span style=color:#88c0d0> hello</span><span style=color:#eceff4>(</span><span>item</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> TokenStream</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> TokenStream</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> ast</span><span style=color:#81a1c1> = match</span><span> syn</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>parse</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>DeriveInput</span><span style=color:#eceff4>>(</span><span>item</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Ok</span><span style=color:#eceff4>(</span><span>input</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span> input</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Err</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> => return</span><span style=color:#8fbcbb> TokenStream</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from</span><span style=color:#eceff4>(</span><span>err</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_compile_error</span><span style=color:#eceff4>()),</span></span>
<span class=giallo-l><span style=color:#eceff4>    };</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> name</span><span style=color:#81a1c1> =</span><span> ast</span><span style=color:#81a1c1>.</span><span>ident</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> add_hello_world</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0;font-weight:700> quote!</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        impl</span><span> #name</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            fn</span><span style=color:#88c0d0> hello_world</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>                println!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Hello World</span><span style=color:#eceff4>")</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    };</span></span>
<span class=giallo-l><span>    add_hello_world</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> hello_world_macro</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Hello</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Hello</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> Example</span><span style=color:#eceff4> {}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> e</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Example</span><span style=color:#eceff4> {};</span></span>
<span class=giallo-l><span>    e</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>hello_world</span><span style=color:#eceff4>();</span><span style=color:#616e88> // => Hello World</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>æœ¬æ›¸ã‚’è©¦ã—ã¦ã„ã¦æ°—ã¥ã„ãŸã®ã§ã™ãŒã€<code>cargo expand</code>ã¯main.rsã ã‘ã§ãªãã€moduleã®pathã‚‚æŒ‡å®šã§ãã¦ã€<code>cargo expand path/to/module/hello</code>ã®ã‚ˆã†ã«å®Ÿè¡Œã™ã‚‹ã¨ã€<code>crate::path::to::module::hello</code>ã®å†…å®¹ãŒå±•é–‹ã§ãã¾ã—ãŸã€‚<br> ä»Šã¾ã§ã€main.rsç­‰ã«copyã—ã¦ã„ãŸã®ã§ã™ãŒã€ã“ã‚Œã‹ã‚‰ã¯æ°—ã«ãªã£ãŸã‚³ãƒ¼ãƒ‰ã‚’ã™ãã«expandã§ããã†ã§ã™ã€‚<h2 id=4-making-fields-public-with-attribute-macros><a aria-label="Anchor link for: 4-making-fields-public-with-attribute-macros" class=zola-anchor href=#4-making-fields-public-with-attribute-macros>4 Making fields public with attribute macros</a></h2><p>æœ¬ç« ã§ã¯ã€ä»˜ä¸ã•ã‚ŒãŸå‹ã®fieldã‚’publicã«ã™ã‚‹<code>#[public]</code> attribute macroã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[public]</span></span>
<span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> Example</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    first</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    second</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> i64</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ãŒä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰æ›ã•ã‚Œã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> Example</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> first</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub</span><span> second</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> i64</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã“ã®å‡¦ç†ã‚’å®Ÿè£…ã™ã‚‹ã«ã¯ã€structã®fieldã‚’parseã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚<br> ã“ã®ä¾‹ã‚’é€šã˜ã¦ã€<code>quote::ToTokens</code>ã‚„<code>syn::parse::Parse</code>ã®ä»•çµ„ã¿ã‚’å­¦ã¹ã¾ã™ã€‚<code>proc_macro2::TokenStream</code>ã‚‚ç™»å ´ã—ã¾ã™ã€‚<br> fieldã‚’åŠ å·¥ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã¨ã„ã‚ˆã„ã‚ˆã§ãã‚‹ã“ã¨ãŒåºƒãŒã£ã¦ãã¦ãŠã‚‚ã—ã‚ããªã£ã¦ãã¾ã™ã€‚<br> ã¾ãŸã€real worldã®usecaseã¨ã—ã¦ã€dtolnayå…ˆç”Ÿã®<a href=https://github.com/dtolnay/no-panic rel=external>no-panic</a>ã‚‚ç´¹ä»‹ã•ã‚Œã¾ã™ã€‚<br> ç« æœ«ã®exercisesã¾ã§ã‚„ã‚‹ã¨ã€å„ç¨®structã¨enumã®å¯¾å¿œã¾ã§å®Ÿè£…ã§ãã¾ã™ã€‚<h2 id=5-hiding-information-and-creating-mini-dlss-with-function-like-macros><a aria-label="Anchor link for: 5-hiding-information-and-creating-mini-dlss-with-function-like-macros" class=zola-anchor href=#5-hiding-information-and-creating-mini-dlss-with-function-like-macros>5 Hiding information and creating mini-DLSs with function-like macros</a></h2><p>5ç« ã¯<code>foo!()</code>ã®ã‚ˆã†ãªfunction like macroã«ã¤ã„ã¦ã§ã™ã€‚<br> function like macroã¯attribute macroã®ã‚ˆã†ã«inputã®TokenStreamã‚’ç½®ãæ›ãˆã‚‰ã‚Œã¾ã™ã€‚<br> attribute macroã¨ã®é•ã„ã¯ã€macroã®å…¥åŠ›ã¨ã—ã¦ã€rustã®codeã«é™ã‚‰ãšä»»æ„ã®å…¥åŠ›ã‚’æ¸¡ã›ã‚‹ç‚¹ã§ã™ã€‚<br> ã“ã®ç‰¹æ€§ã‹ã‚‰ã€<code>sqlx</code>ã‚„<code>yew</code>ã§ã¯ã€SQLã‚„htmlã‚’å…¥åŠ›ã«ã¨ã‚Œã‚‹macroãŒæä¾›ã•ã‚Œã¦ã„ã¾ã™ã€‚<br> æœ¬ç« ã§ã¯ã€2ç« ã§å®Ÿè£…ã—ãŸã€compose macroã®prodeduralç‰ˆã‚’å®Ÿè£…ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> compose_macro</span><span style=color:#81a1c1>::</span><span>compose</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> add_one</span><span style=color:#eceff4>(</span><span>n</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> i32</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> i32</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    n</span><span style=color:#81a1c1> +</span><span style=color:#b48ead> 1</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> to_string</span><span style=color:#eceff4>(</span><span>n</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> i32</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> String</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    n</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_string</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> with_prefix</span><span style=color:#eceff4>(</span><span>s</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> String</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    format!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>prefix_</span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>s</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>")</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> composed</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0;font-weight:700> compose!</span><span style=color:#eceff4>(</span><span>add_one</span><span style=color:#81a1c1>.</span><span>to_string</span><span style=color:#81a1c1>.</span><span>with_prefix</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    println!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{}</span><span style=color:#eceff4>",</span><span style=color:#88c0d0> composed</span><span style=color:#eceff4>(</span><span style=color:#b48ead>2</span><span style=color:#eceff4>));</span><span style=color:#616e88> // => "prefix_3"</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><h2 id=6-testing-a-builder-macro><a aria-label="Anchor link for: 6-testing-a-builder-macro" class=zola-anchor href=#6-testing-a-builder-macro>6 Testing a builder macro</a></h2><p>6ç« ã§ã¯ã€<code>#[derive(Builder)]</code> macroã«ã‚ˆã‚‹builder patternã®å®Ÿè£…ã‚’é€šã—ã¦ã€macroã®testã«ã¤ã„ã¦å­¦ã³ã¾ã™ã€‚ã¾ãŸã€<code>proc-macro2</code>ã‚’åˆ©ç”¨ã—ã¦ã€procedural macroã®å®Ÿè£…ã‚’é€šå¸¸ã®lib crateã«ç§»è­²ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ã‚‚èª¬æ˜ã•ã‚Œã¾ã™ã€‚<br> ä»–ã®procedural macroã«ã¤ã„ã¦ã®ãƒªã‚½ãƒ¼ã‚¹ã«ã¤ã„ã¦dtolnayå…ˆç”Ÿã®<a href=https://github.com/dtolnay/proc-macro-workshop rel=external>proc-macro-workshop</a>ã‚„jon gjengsetå…ˆç”Ÿã®<a href="https://www.youtube.com/watch?v=geovSK3wMB8" rel=external>Procedural Macros in Rust</a> å‹•ç”»ãŒç´¹ä»‹ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚<h2 id=7-from-panic-to-result-error-handling><a aria-label="Anchor link for: 7-from-panic-to-result-error-handling" class=zola-anchor href=#7-from-panic-to-result-error-handling>7 From panic to result: Error handling</a></h2><p>æœ¬ç« ã§ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãª<code>panic!()</code>ã™ã‚‹é–¢æ•°ã‚’Resultã‚’è¿”ã™é–¢æ•°ã«å¤‰æ›ã™ã‚‹<code>#[panic_to_result]</code>ã‚’é€šã—ã¦ã€é–¢æ•°ã®å¤‰æ›ã¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã«ã¤ã„ã¦å­¦ã³ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[panic_to_result]</span></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> create_person</span><span style=color:#eceff4>(</span><span>name</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>,</span><span> age</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> u32</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Person</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    if</span><span> age</span><span style=color:#81a1c1> ></span><span style=color:#b48ead> 30</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>        panic!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>I hope I die before I get old</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Person</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>        name</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        age</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> create_person</span><span style=color:#eceff4>(</span><span>name</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>,</span><span> age</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> u32</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Person</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    if</span><span> age</span><span style=color:#81a1c1> ></span><span style=color:#b48ead> 30</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        return</span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>I hope I die before I get old</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Person</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>        name</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        age</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>å¤‰æ›æ™‚ã®ã‚¨ãƒ©ãƒ¼ã€ä¾‹ãˆã°<code>panic!()</code>ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒãªã„å ´åˆã‚’ãƒ¦ãƒ¼ã‚¶ã«ã‚ã‹ã‚Šã‚„ã™ãä¼ãˆã‚‹æ–¹æ³•ãŒè§£èª¬ã•ã‚Œã¾ã™ã€‚<a href=https://docs.rs/proc-macro-error/latest/proc_macro_error/ rel=external>proc-macro-error</a>ã¯çŸ¥ã‚‰ãªã‹ã£ãŸã®ã§å‚è€ƒã«ãªã‚Šã¾ã—ãŸã€‚<h2 id=8-builder-with-attributes><a aria-label="Anchor link for: 8-builder-with-attributes" class=zola-anchor href=#8-builder-with-attributes>8 Builder with attributes</a></h2><p>8ç« ã§ã¯ã€attributesã‚’æ‰±ã†æ–¹æ³•ã«ã¤ã„ã¦å­¦ã³ã¾ã™ã€‚ ä»¥å‰ã®Builder macroã§renameã‚’æ‰±ãˆã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Builder</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> Example</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#5e81ac>    #[rename("</span><span style=color:#a3be8c>bar</span><span style=color:#5e81ac>")]</span></span>
<span class=giallo-l><span>    foo</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Example</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>builder</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>bar</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>bar</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>build</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>attributeã«ã‚‚ã€<code>#[rename(foo)]</code>ã§ã‚ã£ãŸã‚Šã€<code>#[rename(key=value)]</code>ã¨æ›¸ãæ–¹ãŒè¤‡æ•°ã‚ã‚Šã€ãã‚Œãã‚Œsynä¸Šã§ã®è¡¨ç¾ãŒç•°ãªã‚Šã¾ã™ã€‚<br> ã¾ãŸã€ä»Šã®Builderã®å®Ÿè£…ã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãŒé©åˆ‡ã«builderã®methodã‚’å‘¼ã³å‡ºã—ã‹ã©ã†ã‹ã‚’runtimeæ™‚ã«ãƒã‚§ãƒƒã‚¯ã—ã¦ã„ã¾ã™ã€‚<br> ã“ã‚Œã‚’compileæ™‚ã«ãƒã‚§ãƒƒã‚¯ã§ãã‚‹ã‚ˆã†ã«ã„ã‚ã‚†ã‚‹type state patternã‚’å®Ÿè£…ã—ã¾ã™ã€‚ attribute macroã®å ´åˆã€ä»–ã®attributeã‚’ä¿æŒã™ã‚‹ã‹ã©ã†ã‹ã‚‚åˆ¤æ–­ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€<code>#[allow()]</code>ç­‰ã®ä»–ã®attributeã‚’ä¿æŒã™ã‚‹ã‹å¦ã‹ã‚’åˆ¤å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã¯çŸ¥ã‚‰ãªã‹ã£ãŸã®ã§å‚è€ƒã«ãªã‚Šã¾ã—ãŸã€‚<h2 id=9-writing-an-infrastructure-dsl><a aria-label="Anchor link for: 9-writing-an-infrastructure-dsl" class=zola-anchor href=#9-writing-an-infrastructure-dsl>9 Writing an infrastructure DSL</a></h2><p>9ç« ã§ã¯ã€function like macroã§DSLã‚’ä½œã£ã¦ã„ãã¾ã™ã€‚<br> å…·ä½“çš„ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«AWSã®resourceã‚’å®£è¨€ã™ã‚‹terraformã®ã‚ˆã†ãªInfrastructure as Code(IaC) macroã‚’ä½œã‚Šã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#88c0d0;font-weight:700>iac!</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    bucket uniquename</span><span style=color:#81a1c1> =></span><span> lambda</span><span style=color:#eceff4> (</span></span>
<span class=giallo-l><span>        name</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>name</span><span style=color:#eceff4>",</span><span> mem</span><span style=color:#81a1c1> =</span><span style=color:#b48ead> 1024</span><span style=color:#eceff4>,</span><span> time</span><span style=color:#81a1c1> =</span><span style=color:#b48ead> 10</span></span>
<span class=giallo-l><span style=color:#eceff4>    )</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã“ã®å®Ÿè£…ã®ä¸­ã§ã€<code>syn::custom_keyword!</code>ã‚„<code>syn::parenthesized</code>ã®ä½¿ã„æ–¹ã‚‚ç´¹ä»‹ã•ã‚Œã¾ã™ã€‚ From the real worldã§ã¯declaratve macroã¨procedural macroã‚’çµ„ã¿åˆã‚ã›ã¦ä½¿ã‚ã‚Œã¦ã„ã‚‹ä¾‹ãŒç´¹ä»‹ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚<h2 id=10-macros-and-the-outside-world><a aria-label="Anchor link for: 10-macros-and-the-outside-world" class=zola-anchor href=#10-macros-and-the-outside-world>10 Macros and the outside world</a></h2><p>æœ€å¾Œã®10ç« ã¯compileæ™‚ã«yaml fileã‹ã‚‰<code>Config</code> structã‚’ç”Ÿæˆã™ã‚‹<code>config!</code>ã‚’å®Ÿè£…ã—ã¾ã™ã€‚<br> æœ¬ç« ã§ã¯proc macro crateã®featureåˆ¶å¾¡ã‚„documentã«ã¤ã„ã¦ã®è§£èª¬ã‚‚ã‚ã‚Šã¾ã™ã€‚<br> æœ€å¾Œã«ã¾ã¨ã‚ã¨ã—ã¦ã€<code>#[tokio::main]</code>ã®srcã®è§£èª¬ãŒã‚ã‚Šã¾ã™ã€‚<br> ã¾ãŸã€æœ¬æ›¸ã§ç´¹ä»‹ã—ãã‚Œãªã‹ã£ãŸsynã®<a href=https://www.infoq.com/articles/rust-procedural-macros-replace-panic/ rel=external><code>Fold</code> traitã®è§£èª¬è¨˜äº‹</a>ã‚„proc macroå®Ÿè£…æ™‚ã«åˆ©ç”¨ã§ãã‚‹crateãŒç´¹ä»‹ã•ã‚Œã¦ã„ã¾ã™ã€‚<h2 id=matome><a aria-label="Anchor link for: matome" class=zola-anchor href=#matome>ã¾ã¨ã‚</a></h2><p>Procedural macroã ã‘ã§ã»ã¼1å†Šæ›¸ã‹ã‚Œã¦ãŠã‚Šã€å®Ÿéš›ã«codeã‚’æ›¸ããªãŒã‚‰å°‘ã—ãšã¤æ”¹è‰¯ã—ã¦ã„ãã®ã§ã¨ã¦ã‚‚æ¥½ã—ãèª­ã‚ã¾ã—ãŸã€‚<br> ç« æœ«ã®exerciseã®ç­”ãˆã‚‚appendixã«è¼‰ã£ã¦ã„ã¦ã‚ã‚ŠãŒãŸã„ã§ã™ã€‚<br> ä»Šã¾ã§procedural macroã®å®Ÿè£…ã‚’èª­ã‚“ã§ã„ãªã‹ã£ãŸã®ã§ã™ãŒã€ã“ã‚Œã‹ã‚‰ã¯è‰²ã€…ãªlibã®å®Ÿè£…ã‚’èª­ã‚“ã§ã¿ã‚ˆã†ã¨æ€ãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚</div></article></main><footer class=blog-footer><p>Â© 2026 <a href=https://blog.ymgyt.io> ymgyt </a> | Made with <a href=https://www.getzola.org rel=noopener target=_blank>Zola</a> | <a href=https://github.com/ymgyt/blog>Repository</a> | <a href=https://blog.ymgyt.io/atom.xml target=_blank title=rss> <svg viewbox="0 0 24 24" class=icon fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx=5 cy=19 r=1></circle></svg> </a></footer></div></div>