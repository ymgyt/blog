<!doctype html><html lang=ja><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1" name=viewport><link href=https://blog.ymgyt.io/favicon.ico rel=icon sizes=any><link href=https://blog.ymgyt.io/icon.svg rel=icon type=image/svg+xml><link href=https://blog.ymgyt.io/apple-touch-icon.png rel=apple-touch-icon><link href=https://blog.ymgyt.io/manifest.webmanifest rel=manifest><link href=https://blog.ymgyt.io/style.css rel=stylesheet><link href=https://blog.ymgyt.io/atom.xml rel=alternate title=Atom type=application/atom+xml><script src="https://www.googletagmanager.com/gtag/js?id=G-GTB0KMLN90" async></script><script>window.dataLayer = window.dataLayer || [];
	function gtag() {dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-GTB0KMLN90');</script><title>ğŸ—¼ Mini-Redis Tutorialã‹ã‚‰ã¯ã˜ã‚ã‚‹tokio | Happy developing</title><meta content=summary name=twitter:card><meta content="@YAmaguchixt " name=twitter:site><meta content="ğŸ—¼ Mini-Redis Tutorialã‹ã‚‰ã¯ã˜ã‚ã‚‹tokio" name=twitter:title><meta content=https://blog.ymgyt.io/images/emoji/tokyo_tower.png name=twitter:image><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><body><div class=world><div class=content-container><header class=blog-header-container><div class=blog-logo><a href=https://blog.ymgyt.io>Happy developing</a></div><div class=blog-nav><nav><ul><li><a href=https://blog.ymgyt.io/entry/>Entries</a><li><a href=https://blog.ymgyt.io/tags/>Tags</a><li><a href=https://blog.ymgyt.io/about/>About</a><li><a href=https://github.com/ymgyt> <img alt=Github class=icon src=https://blog.ymgyt.io/images/icon/github.svg> </a><li><a href="https://twitter.com/YAmaguchixt "> <img alt=Twitter class=icon src=https://blog.ymgyt.io/images/icon/twitter.svg> </a></ul></nav></div></header><main class=blog-main><article><header class=entry-header><h1 class=entry-title>ğŸ—¼ Mini-Redis Tutorialã‹ã‚‰ã¯ã˜ã‚ã‚‹tokio</h1><div class=entry-meta><p class=entry-meta-item>ğŸ—“ 2020-10-25<p class=entry-meta-item>ğŸ· <span class=tag><a href=https://blog.ymgyt.io/tags/rust/>rust</a></span></div></header><aside class=entry-toc><nav><ul class=entry-toc-toplevel-list><li><a href=https://blog.ymgyt.io/entry/mini_redis_tutorial_to_get_started_with_tokio/#matome>ã¾ã¨ã‚</a><li><a href=https://blog.ymgyt.io/entry/mini_redis_tutorial_to_get_started_with_tokio/#zhun-bei>æº–å‚™</a> <ul><li><a href=https://blog.ymgyt.io/entry/mini_redis_tutorial_to_get_started_with_tokio/#mini-redis-server>Mini-Redis server</a><li><a href=https://blog.ymgyt.io/entry/mini_redis_tutorial_to_get_started_with_tokio/#my-redis>My-Redis</a></ul><li><a href=https://blog.ymgyt.io/entry/mini_redis_tutorial_to_get_started_with_tokio/#hello-tokio>Hello Tokio</a> <ul><li><a href=https://blog.ymgyt.io/entry/mini_redis_tutorial_to_get_started_with_tokio/#attribute-macro-tokio-main>Attribute Macro tokio::main</a><li><a href=https://blog.ymgyt.io/entry/mini_redis_tutorial_to_get_started_with_tokio/#awaitnomentarumoderu>awaitã®ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ¢ãƒ‡ãƒ«</a></ul><li><a href=https://blog.ymgyt.io/entry/mini_redis_tutorial_to_get_started_with_tokio/#spawning>Spawning</a> <ul><li><a href=https://blog.ymgyt.io/entry/mini_redis_tutorial_to_get_started_with_tokio/#concurrency-and-parallelism>Concurrency and Parallelism</a><li><a href=https://blog.ymgyt.io/entry/mini_redis_tutorial_to_get_started_with_tokio/#static-bound>'static bound</a><li><a href=https://blog.ymgyt.io/entry/mini_redis_tutorial_to_get_started_with_tokio/#send-bound>Send bound</a></ul><li><a href=https://blog.ymgyt.io/entry/mini_redis_tutorial_to_get_started_with_tokio/#shared-state>Shared state</a> <ul><li><a href=https://blog.ymgyt.io/entry/mini_redis_tutorial_to_get_started_with_tokio/#bytes-crate>bytes crate</a><li><a href=https://blog.ymgyt.io/entry/mini_redis_tutorial_to_get_started_with_tokio/#hashmapnogong-you>HashMapã®å…±æœ‰</a></ul><li><a href=https://blog.ymgyt.io/entry/mini_redis_tutorial_to_get_started_with_tokio/#channels>Channels</a> <ul><li><a href=https://blog.ymgyt.io/entry/mini_redis_tutorial_to_get_started_with_tokio/#tokionochannel-primitives>tokioã®channel primitives</a></ul><li><a href=https://blog.ymgyt.io/entry/mini_redis_tutorial_to_get_started_with_tokio/#i-o>I/O</a> <ul><li><a href=https://blog.ymgyt.io/entry/mini_redis_tutorial_to_get_started_with_tokio/#asyncread-asyncwrite>AsyncRead/AsyncWrite</a><li><a href=https://blog.ymgyt.io/entry/mini_redis_tutorial_to_get_started_with_tokio/#echo-server>Echo server</a></ul><li><a href=https://blog.ymgyt.io/entry/mini_redis_tutorial_to_get_started_with_tokio/#framing>Framing</a> <ul><li><a href=https://blog.ymgyt.io/entry/mini_redis_tutorial_to_get_started_with_tokio/#resp-redis-serialization-protocol>RESP(REdis Serialization Protocol)</a></ul><li><a href=https://blog.ymgyt.io/entry/mini_redis_tutorial_to_get_started_with_tokio/#resp-errors>RESP Errors</a> <ul><li><a href=https://blog.ymgyt.io/entry/mini_redis_tutorial_to_get_started_with_tokio/#resp-integers>RESP Integers</a><li><a href=https://blog.ymgyt.io/entry/mini_redis_tutorial_to_get_started_with_tokio/#resp-bulk-strings>RESP Bulk Strings</a><li><a href=https://blog.ymgyt.io/entry/mini_redis_tutorial_to_get_started_with_tokio/#resp-arrays>RESP Arrays</a><li><a href=https://blog.ymgyt.io/entry/mini_redis_tutorial_to_get_started_with_tokio/#sending-commands-to-a-redis-server>Sending commands to a Redis Server</a><li><a href=https://blog.ymgyt.io/entry/mini_redis_tutorial_to_get_started_with_tokio/#framenoshi-zhuang>frameã®å®Ÿè£…</a></ul><li><a href=https://blog.ymgyt.io/entry/mini_redis_tutorial_to_get_started_with_tokio/#async-in-depth>Async in depth</a> <ul><li><a href=https://blog.ymgyt.io/entry/mini_redis_tutorial_to_get_started_with_tokio/#mini-tokio-executor>Mini Tokio Executor</a></ul><li><a href=https://blog.ymgyt.io/entry/mini_redis_tutorial_to_get_started_with_tokio/#select>Select</a><li><a href=https://blog.ymgyt.io/entry/mini_redis_tutorial_to_get_started_with_tokio/#streams>Streams</a><li><a href=https://blog.ymgyt.io/entry/mini_redis_tutorial_to_get_started_with_tokio/#zhong-warini>çµ‚ã‚ã‚Šã«</a><li><a href=https://blog.ymgyt.io/entry/mini_redis_tutorial_to_get_started_with_tokio/#can-kao-document>å‚è€ƒdocument</a></ul></nav></aside><div class=entry-content><p>ã“ã®è¨˜äº‹ã§ã¯Rustã®éåŒæœŸruntimeã®ã²ã¨ã¤<a href=https://github.com/tokio-rs/tokio rel=external>tokio</a>ã®<a href=https://tokio.rs/tokio/tutorial rel=external>å…¬å¼Tutorial</a>ã‚’é€šã˜ã¦tokioã®APIã«å…¥é–€ã—ã¦ã„ãã¾ã™ã€‚<br> Tutorialã§ã¯<a href=https://github.com/tokio-rs/mini-redis rel=external>Mini-Redis</a>ã¨ã„ã†<a href=https://redis.io/ rel=external>Redis</a>ã®client/serverã‚’å®Ÿè£…ã—ãŸlibraryã‚’é€šã—ã¦tokioã¨future/asyncã®æ¦‚å¿µã‚’å­¦ã‚“ã§ã„ãã¾ã™ã€‚Redisã«ã¤ã„ã¦ã®å‰æçŸ¥è­˜ã¯å¿…è¦ã¨ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<br> Rustã§async/awaitãŒä½¿ãˆã‚‹ã«ãªã‚Šã¾ã—ãŸãŒã€å®Ÿéš›ã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ›¸ãã«ã¯runtimeã‚’é¸æŠã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ä»Šã ã¨tokioã‹<a href=https://github.com/tokio-rs/tokio/releases/tag/tokio-0.3.0 rel=external>async-std</a>ãŒç¾å®Ÿçš„ãªé¸æŠè‚¢ãªã®ã§ã—ã‚‡ã†ã‹ã€‚éåŒæœŸã®runtimeã‚’é¸æŠã™ã‚‹ã¨åŸºæœ¬çš„ã«I/Oã‚’ã¨ã‚‚ãªã†å‡¦ç†ã¯ã™ã¹ã¦(?)é¸æŠã—ãŸruntimeã®APIã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã«ãªã‚‹ã¨æ€ã„ã¾ã™ã€‚ãã®ãŸã‚ã€Rustã®éåŒæœŸecosystemã®æ©æµã«ã‚ãšã‹ã‚‹ã«ã¯runtime/tokioã®APIã«ãªã‚Œã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚<h2 id=matome><a aria-label="Anchor link for: matome" class=zola-anchor href=#matome>ã¾ã¨ã‚</a></h2><p>æœ¬tutorialã‚’é€šã—ã¦ä»¥ä¸‹ã®ã“ã¨ã‚’å­¦ã¹ã¾ã—ãŸã€‚<ul><li><code>std::sync::Mutex</code>ã¨<code>tokio::sync::Mutex</code>ã®ä½¿ã„åˆ†ã‘æ–¹<li><code>.await</code>ã¨æ›¸ã„ãŸã¨ãã«ã©ã‚“ãªã“ã¨ãŒãŠãã‚‹ã‹ã®ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ¢ãƒ‡ãƒ«ãŒã§ãã‚‹<li><code>Mutex</code>ã«ã‚ˆã‚‹çŠ¶æ…‹å…±æœ‰ã‹ã‚‰<code>mpsc</code>ã¨<code>oneshot</code>channelã‚’åˆ©ç”¨ã—ãŸãƒ‘ã‚¿ãƒ¼ãƒ³ã¸ã®ç§»è¡Œ<li><code>Frame</code>ã¨ã„ã†æ¦‚å¿µ(byte stream -> frame -> protocol)<li><code>bytes::{BytesMut,Bytes}</code>ã®åˆ©ç”¨ä¾‹<li>futureã‚’<code>poll</code>ã™ã‚‹executorã®æ¦‚è¦<li><code>select!</code>ã§goã£ã½ãæ›¸ã‘ã‚‹<li><code>Stream</code>ã«ã¯<code>pin</code>ã©ã‚ãŒå¿…è¦</ul><p>ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ãŒè±Šå¯Œã§githubã§ã¯ã‚ˆã‚Šç´°ã‹ãã‚³ãƒ¡ãƒ³ãƒˆãŒæ›¸ã„ã¦ã‚ã‚Šã¾ã™ã€‚<h2 id=zhun-bei><a aria-label="Anchor link for: zhun-bei" class=zola-anchor href=#zhun-bei>æº–å‚™</a></h2><p>rustã¯1.47ã‚’åˆ©ç”¨ã—ã¾ã—ãŸã€æœ€æ–°ã§ã‚ã‚Œã°ç‰¹ã«å•é¡Œãªã„ã¨æ€ã„ã¾ã™ã€‚minimumã¯<code>1.39.0</code>ã§ã™ã€‚ <code>rustc 1.47.0 (18bf6b4f0 2020-10-07)</code><p>ã“ã®è¨˜äº‹ã‚’æ›¸ã„ã¦ã„ã‚‹1é€±é–“ã»ã©å‰ã«<a href=https://github.com/tokio-rs/tokio/releases/tag/tokio-0.3.0 rel=external>tokio v0.3.0</a>ãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¾ã—ãŸã€‚<del>ã§ã™ãŒmini-redisã¯tokioã®0.2ã«ä¾å­˜ã—ã¦ã„ã‚‹ã®ã§0.2ã§é€²ã‚ã¦ã„ãã¾ã™ã€‚</del> <del><a href=https://github.com/tokio-rs/tokio/releases/tag/tokio-0.3.0 rel=external><code>bytes</code> crateã¸ã®ä¾å­˜ãŒpublic APIã‹ã‚‰å‰Šé™¤ã•ã‚ŒãŸ</a>ã®ã§ã€<code>read_buf()</code> -> <code>read()</code>ã«å¤‰æ›´ã™ã‚‹ä»¥å¤–ã¯ç‰¹ã«å½±éŸ¿ãªã„ã§ã™ã€‚</del><br> <a href=https://github.com/tokio-rs/mini-redis/commit/77df32d15e9645fec1483523d5a519f7c494e461 rel=external>mini-redisã‚‚tokio v0.3ã‚’åˆ©ç”¨ã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚</a><h3 id=mini-redis-server><a aria-label="Anchor link for: mini-redis-server" class=zola-anchor href=#mini-redis-server>Mini-Redis server</a></h3><p>clientå´ã®ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãéš›ã«serverãŒèµ·å‹•ã—ã¦ã„ã‚‹ã¨ä¾¿åˆ©ãªã®ã§mini-redisã‚’å‹•ã‹ã›ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>$ cargo install mini-redis</span></span>
<span class=giallo-l><span>$ mini-redis-server</span></span></code></pre><p><code>cargo install</code>ã§ã‚‚ã£ã¦ãã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ãŒã€ã‚½ãƒ¼ã‚¹ã‹ã‚‰å‹•ã‹ã™ã“ã¨ã«ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>git clone https://github.com/tokio-rs/mini-redis</span></span>
<span class=giallo-l><span>cd mini-redis</span></span>
<span class=giallo-l><span>cargo run --bin mini-redis-server</span></span></code></pre><p>åˆ¥terminalã§<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>cargo run --bin mini-redis-cli --quiet set xxx xxx</span></span>
<span class=giallo-l><span>cargo run --bin mini-redis-cli --quiet get xxx </span></span>
<span class=giallo-l><span>"xxx"</span></span></code></pre><p>ã¨ã§ãã‚Œã°OKã§ã™ã€‚<h3 id=my-redis><a aria-label="Anchor link for: my-redis" class=zola-anchor href=#my-redis>My-Redis</a></h3><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>cargo new my-redis</span></span>
<span class=giallo-l><span>cd my-redis</span></span></code></pre><p><code>Cargo.toml</code><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=yaml><span class=giallo-l><span style=color:#eceff4>[</span><span style=color:#a3be8c>dependencies</span><span style=color:#eceff4>]</span></span>
<span class=giallo-l><span style=color:#a3be8c>tokio = {version = "0.3.1", features = ["full"]}</span></span>
<span class=giallo-l><span style=color:#a3be8c>mini-redis = "0.3"</span></span></code></pre><p>projectã‚’ä½œæˆã—ã¦ã€tokioã¨mini-redisã‚’ä¾å­˜å…ˆã«è¿½åŠ ã—ã¾ã™ã€‚<br> æ¥½ã‚’ã—ã¦featuresã«<code>full</code>ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ãŒã€å®Ÿéš›ã«ã¯åˆ©ç”¨ã™ã‚‹æ©Ÿèƒ½ã«ã‚ã‚ã›ã¦<code>net</code>, <code>fs</code>, <code>rt-threaded</code>ã®ã‚ˆã†ã«æŒ‡å®šã—ã¾ã™ã€‚API documentã«åˆ©ç”¨ã™ã‚‹ãŸã‚ã«å¿…è¦ãªfeatureãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚<br> <code>v0.3</code>ã§ã¯<code>rt-core</code>ã¨<code>rt-util</code>ãŒ<code>rt</code>ã«ã€<code>tcp</code>, <code>udp</code>, <code>dns</code>ãŒ<code>net</code>ã«ã¾ã¨ã‚ã‚‰ã‚Œã‚‹ç­‰ã—ã¦æ•´ç†ã•ã‚Œã¦ã„ã¾ã™ã€‚<sup class=footnote-reference><a href=#tokio030>1</a></sup><p>ã“ã‚Œã§æº–å‚™ãŒæ•´ã£ãŸã®ã§æ—©é€Ÿã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã„ãã¾ã—ã‚‡ã†!<br> <a href=https://github.com/ymgyt/mini-redis-handson rel=external>Sourceã¯ã“ã¡ã‚‰</a> (branchãŒmasterã‹ã‚‰mainã«ãªã£ã¦ã„ã¾ã™ã€‚)<h2 id=hello-tokio><a aria-label="Anchor link for: hello-tokio" class=zola-anchor href=#hello-tokio>Hello Tokio</a></h2><p>tutorialã§ã¯<code>main.rs</code>ã«æ›¸ã„ã¦ã„ã¾ã™ãŒæ®‹ã—ã¦ãŠããŸã„ã®ã§<code>examples/hello-redis.rs</code>ã‚’ä½œæˆã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> mini_redis</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span>client</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[tokio::main]</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub async fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;()>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> client</span><span style=color:#81a1c1> =</span><span> client</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>connect</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>127.0.0.1:6379</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>    client</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>set</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>hello</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>world</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> result</span><span style=color:#81a1c1> =</span><span> client</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>get</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>hello</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    println!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>got value from the server; result = </span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>:?</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>",</span><span> result</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>    Ok</span><span style=color:#eceff4>(())</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>åˆ¥terminalã§mini-redisãŒèµ·å‹•ã—ã¦ã‚ã‚‹å‰æã§<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>$ cargo run --quiet --example hello-redis</span></span>
<span class=giallo-l><span>got value from the server; result = Some(b"world")</span></span></code></pre><p>ã¨ãªã‚Œã°æˆåŠŸã§ã™ã€‚<h3 id=attribute-macro-tokio-main><a aria-label="Anchor link for: attribute-macro-tokio-main" class=zola-anchor href=#attribute-macro-tokio-main>Attribute Macro <code>tokio::main</code></a></h3><p>ã¾ãšã„ããªã‚Šã†ã£..ã¨ãªã£ãŸã®ãŒ<code>tokio::main</code>macroã§ã™ã€‚mainé–¢æ•°ã‹ã‚‰ã„ããªã‚Šéš è”½ã•ã‚Œã‚‹ã®ã¯æŠµæŠ—ãªã„ã§ã—ã‚‡ã†ã‹ã€‚ã¨ã„ã†ã“ã¨ã§<code>cargo expand</code>ã§å±•é–‹å†…å®¹ã‚’ã¿ã¦ã„ãã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#![feature(prelude_import)]</span></span>
<span class=giallo-l><span style=color:#5e81ac>#[prelude_import]</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>prelude</span><span style=color:#81a1c1>::</span><span>v1</span><span style=color:#81a1c1>::*</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#5e81ac>#[macro_use]</span></span>
<span class=giallo-l><span style=color:#81a1c1>extern crate</span><span> std</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> mini_redis</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span>client</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l><span style=color:#81a1c1>pub fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span>    tokio</span><span style=color:#81a1c1>::</span><span>runtime</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Builder</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>basic_scheduler</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>threaded_scheduler</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>enable_all</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>build</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>block_on</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>async</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#eceff4>            {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                let mut</span><span> client</span><span style=color:#81a1c1> =</span><span> client</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>connect</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>127.0.0.1:6379</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span>                client</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>set</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>hello</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>world</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>                let</span><span> result</span><span style=color:#81a1c1> =</span><span> client</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>get</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>hello</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>                {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    ::</span><span>std</span><span style=color:#81a1c1>::</span><span>io</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>_print</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>::</span><span>core</span><span style=color:#81a1c1>::</span><span>fmt</span><span style=color:#81a1c1>::</span><span>Arguments</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new_v1</span><span style=color:#eceff4>(</span></span>
<span class=giallo-l><span style=color:#81a1c1>                        &</span><span style=color:#eceff4>["</span><span style=color:#a3be8c>got value from the server; result = </span><span style=color:#eceff4>", "</span><span style=color:#ebcb8b>\n</span><span style=color:#eceff4>"],</span></span>
<span class=giallo-l><span style=color:#81a1c1>                        &match</span><span style=color:#eceff4> (</span><span style=color:#81a1c1>&</span><span>result</span><span style=color:#eceff4>,) {</span></span>
<span class=giallo-l><span style=color:#eceff4>                            (</span><span>arg0</span><span style=color:#eceff4>,)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#eceff4>                                [</span><span style=color:#81a1c1>::</span><span>core</span><span style=color:#81a1c1>::</span><span>fmt</span><span style=color:#81a1c1>::</span><span>ArgumentV1</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>arg0</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> ::</span><span>core</span><span style=color:#81a1c1>::</span><span>fmt</span><span style=color:#81a1c1>::</span><span>Debug</span><span style=color:#81a1c1>::</span><span>fmt</span><span style=color:#eceff4>)]</span></span>
<span class=giallo-l><span style=color:#eceff4>                            }</span></span>
<span class=giallo-l><span style=color:#eceff4>                        },</span></span>
<span class=giallo-l><span style=color:#eceff4>                    ));</span></span>
<span class=giallo-l><span style=color:#eceff4>                };</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Ok</span><span style=color:#eceff4>(())</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        })</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã“ã®ã‚ˆã†ãªå±•é–‹çµæœã¨ãªã‚Šã¾ã—ãŸã€‚æ¦‚è¦ã¨ã—ã¦ã¯runtimeã‚’Builder patternã§è¨­å®šã—ã¦ãƒ¦ãƒ¼ã‚¶ã®ã‚³ãƒ¼ãƒ‰ã‚’async blockã§wrapã—ãŸã†ãˆã§<code>block_on()</code>ã«æ¸¡ã—ã¦ã„ã‚‹æ„Ÿã˜ã§ã™ã€‚<br> documentã«ã‚ˆã‚‹ã¨<code>Runtime</code>ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’ãƒ¦ãƒ¼ã‚¶ãŒ<code>Runtime</code>ã‚„<code>Builder</code>ã‚’ç›´æ¥åˆ©ç”¨ã™ã‚‹ã“ã¨ãªãã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã®helperã¨ã„ã†ä½ç½®ã¥ã‘ã®ã‚ˆã†ã§ã™ã€‚<br> <code>v0.3.0</code>ã§ã¯<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>#[tokio::main(flavor = "multi_thread", worker_threads = 10)]</span></span>
<span class=giallo-l><span>#[tokio::main(flavor = "current_thread")]</span></span></code></pre><p>ã®ã‚ˆã†ã«multi/single threadã®åˆ‡ã‚Šæ›¿ãˆã‚„worker threadæ•°ã‚’åˆ¶å¾¡ã§ãã‚‹ã‚ˆã†ã§ã™ã€‚<br> ã“ã®runtimeãŒãªã«ã‚’ã‚„ã£ã¦ãã‚Œã¦ã„ã‚‹ã‹ã¯å¾Œè¿°ã—ã¾ã™ã€‚<br> ã¡ãªã¿ã«<code>v0.3.0</code>ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å±•é–‹ã•ã‚Œã¾ã—ãŸã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span>  tokio</span><span style=color:#81a1c1>::</span><span>runtime</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Builder</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new_multi_thread</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>enable_all</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>build</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>block_on</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>async</span><span style=color:#eceff4> {</span><span style=color:#616e88> /* ...*/</span><span style=color:#eceff4> }</span></span></code></pre><p><a href=https://github.com/tokio-rs/tokio/blob/43d071489837a154dd56b42176c637b635e1891f/tokio/src/runtime/builder.rs#L489 rel=external>runtimeã®è¨­å®šå‡¦ç†</a>ã®ç†è§£ã‚’è©¦ã¿ãŸã®ã§ã™ãŒæ­¯ãŒãŸã¡ã¾ã›ã‚“ã§ã—ãŸã€‚<br> worker threadæ•°ã¯æŒ‡å®šã—ãªã„å ´åˆ<a href=https://github.com/seanmonstar rel=external>seanmonstarå…ˆç”Ÿ</a>ã®<a href=https://github.com/seanmonstar/num_cpus rel=external>num_cpus</a>ãŒåˆ©ç”¨ã•ã‚Œè«–ç†ã‚³ã‚¢æ•°ãŒä½¿ã‚ã‚Œã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚<h3 id=awaitnomentarumoderu><a aria-label="Anchor link for: awaitnomentarumoderu" class=zola-anchor href=#awaitnomentarumoderu><code>await</code>ã®ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ¢ãƒ‡ãƒ«</a></h3><p><code>async</code> fn/blockã®ä¸­ã§<code>await</code>ã‚’æ›¸ã„ãŸã‚‰ãªã«ãŒèµ·ãã‚‹ã®ãƒ”ãƒ³ã¨æ¥ã¦ã„ã¾ã›ã‚“ã§ã—ãŸã€‚ãªã®ã§ã›ã‚ã¦æ¦‚å¿µçš„ã«ã§ã‚‚<code>.await</code>æ›¸ã„ãŸã‚‰å®Ÿã¯ã“ã†ãªã£ã¦ã‚‹ã¨ã„ã†ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ¢ãƒ‡ãƒ«(ã‚ãã¾ã§è‡ªåˆ†ã®)ã‚’å¾—ã‚‹ã®ãŒç›®æ¨™ã§ã—ãŸãŒã€æœ¬tutorialã‚’è¡Œã„ç¾çŠ¶ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«è€ƒãˆã¦ã„ã¾ã™ã€‚<ol><li>async fn/blockã¯<code>Future::poll</code><sup class=footnote-reference><a href=#Future::Poll>2</a></sup>ã®å®Ÿè£…ã«å¤‰æ›ã•ã‚Œã‚‹ã€‚<li><code>Future</code>ã‚’å®Ÿè£…ã—ãŸanonymous structã¯æœ€çµ‚çš„ã«ã¯taskã¨ã„ã†å½¢ã§runtimeã«æ¸¡ã•ã‚Œã¦<code>poll()</code>ã‚’å‘¼ã‚“ã§ã‚‚ã‚‰ãˆã‚‹ã€‚<li><code>future_a.await</code>ã¨æ›¸ã„ãŸã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰æ›ã•ã‚Œã‚‹ã€‚(è©³ã—ãã¯å¾Œè¿°ã—ã¾ã™)</ol><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>let</span><span> value</span><span style=color:#81a1c1> = match</span><span style=color:#88c0d0> future_as_mut</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>poll</span><span style=color:#eceff4>(</span><span>cx</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  Poll</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Ready</span><span style=color:#eceff4>(</span><span>value</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    self.</span><span>state </span><span style=color:#81a1c1>= self.</span><span style=color:#8fbcbb>State</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>FutureAComplete</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span>    value</span></span>
<span class=giallo-l><span style=color:#eceff4>  }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>  Poll</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Pending</span><span style=color:#81a1c1> => return</span><span style=color:#8fbcbb> Poll</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Pending</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><ol><li>çµæœçš„ã«ãƒ¦ãƒ¼ã‚¶ã¯futureãŒå®Œäº†ã—ãŸã‚ã¨ã®å‡¦ç†ã ã‘ã‚’è¨˜è¿°ã™ã‚Œã°ã‚ˆãã€éåŒæœŸå‡¦ç†ãŒåŒæœŸå‡¦ç†ã£ã½ãæ›¸ã‘ã‚‹ã€‚</ol><h2 id=spawning><a aria-label="Anchor link for: spawning" class=zola-anchor href=#spawning>Spawning</a></h2><p>clientå´ã®ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ãŸã®ã§æ¬¡ã¯serverå´ã®ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã„ãã¾ã™ã€‚ã“ã¡ã‚‰ã¯<code>src/main.rs</code>ã«è¨˜è¿°ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> tokio</span><span style=color:#81a1c1>::</span><span>net</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>TcpListener</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> TcpStream</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> mini_redis</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>Connection</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Frame</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[tokio::main]</span></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> listener</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> TcpListener</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>bind</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>127.0.0.1:6379</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>.await.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    loop</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span style=color:#eceff4> (</span><span>socket</span><span style=color:#eceff4>,</span><span> _</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> listener</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>accept</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#88c0d0>        process</span><span style=color:#eceff4>(</span><span>socket</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> process</span><span style=color:#eceff4>(</span><span>socket</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> TcpStream</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> connection</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Connection</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>socket</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    if let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>frame</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> connection</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>read_frame</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>        println!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>GOT: </span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>:?</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>",</span><span> frame</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> response</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Frame</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Error</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>unimplemented</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_string</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span>        connection</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write_frame</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>response</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã“ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã€<code>process</code>ãŒå®Œäº†ã™ã‚‹ã¾ã§æ¬¡ã®æ¥ç¶šã‚’å—ã‘ä»˜ã‘ã¦ã„ãªã„ã®ã§åŒæ™‚ã«1ã¤ã®æ¥ç¶šã—ã‹å‡¦ç†ã•ã‚Œã¾ã›ã‚“ã€‚<code>process</code>ã‚’<strong>concurrent</strong>ã«ãŠã“ãªã†ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> tokio</span><span style=color:#81a1c1>::</span><span>net</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>TcpListener</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[tokio::main]</span></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> listener</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> TcpListener</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>bind</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>127.0.0.1:6379</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>.await.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    loop</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span style=color:#eceff4> (</span><span>socket</span><span style=color:#eceff4>,</span><span> _</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> listener</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>accept</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span>        tokio</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>spawn</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>async move</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0>            process</span><span style=color:#eceff4>(</span><span>socket</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>        });</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>process</code>ã‚’awaitã—ã¦ã„ã‚‹futureã‚’<code>tokio::spawn</code>ã«æ¸¡ã—ã¾ã™ã€‚<code>tokio::spawn</code>ã¯futureã®å®Ÿè¡Œå˜ä½ã§è‡ªåˆ†ã¯<code>go func() { ... }</code>ã®ã‚ˆã†ãªgoroutineã¨è€ƒãˆã¦ã„ã¾ã™ã€‚ãŸã ã—ã€goroutineã¨é•ã†ã®ã¯æˆ»ã‚Šå€¤ã‚’å–å¾—ã§ãã‚‹ã¨ã“ã‚ã§ã™ã€‚(goroutineã®å ´åˆã¯chanç­‰ã‚’ä½¿ã†å¿…è¦ãŒã‚ã‚‹)<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#[tokio::main]</span></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> handle</span><span style=color:#81a1c1> =</span><span> tokio</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>spawn</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>async</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#eceff4>        "</span><span style=color:#a3be8c>return value</span><span style=color:#eceff4>"</span></span>
<span class=giallo-l><span style=color:#eceff4>    });</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> out</span><span style=color:#81a1c1> =</span><span> handle</span><span style=color:#81a1c1>.await.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    println!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>GOT </span><span style=color:#ebcb8b>{}</span><span style=color:#eceff4>",</span><span> out</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><blockquote><p>Tasks in Tokio are very lightweight. Under the hood, they require only a single allocation and 64 bytes of memory. Applications should feel free to spawn thousands, if not millions of tasks.</blockquote><p>ã¨ã„ã†ã“ã¨ã§ãŸã£ãŸ64bytesã®allocationã—ã‹å¿…è¦ã¨ã›ãšã€ã‚ã‚‹ç¨‹åº¦ã¯æ°—ã«ã›ãšã«<code>spawn</code>ã—ã¦ã‚‚ã„ã„ã¿ãŸã„ã§ã™ã€‚<h3 id=concurrency-and-parallelism><a aria-label="Anchor link for: concurrency-and-parallelism" class=zola-anchor href=#concurrency-and-parallelism>Concurrency and Parallelism</a></h3><p>ã„ã‚ã‚†ã‚‹ä¸¦è¡Œã¨ä¸¦åˆ—ã®é•ã„ã«ã¤ã„ã¦ã‚‚è¨€åŠãŒã‚ã‚Šã¾ã™ã€‚<blockquote><p>Concurrency and parallelism is not the same thing. If you alternate between two tasks, then you are working on both tasks concurrently, but not in parallel. For it to qualify as parallel, you would need two people, one dedicated to each task.</blockquote><p>concurrentã¨parallelã®é•ã„ã«ã¤ã„ã¦ã¯<a href=https://www.oreilly.co.jp/books/9784873118468/ rel=external>Goè¨€èªã«ã‚ˆã‚‹ä¸¦è¡Œå‡¦ç†</a> 2ç« ä¸¦è¡Œæ€§ã‚’ã©ã†ãƒ¢ãƒ‡ãƒ«åŒ–ã™ã‚‹ã‹ã§æ›¸ã‹ã‚Œã¦ã„ã‚‹ä»¥ä¸‹ã®æ–‡ãŒã„ã¡ã°ã‚“ã‚ã‹ã‚Šã‚„ã™ã„ã¨æ€ã£ã¦ã„ã¾ã™ã€‚<blockquote><p>ä¸¦è¡Œæ€§ã¯ã‚³ãƒ¼ãƒ‰ã®æ€§è³ªã‚’æŒ‡ã—ã€ä¸¦åˆ—æ€§ã¯å‹•ä½œã—ã¦ã„ã‚‹ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®æ€§è³ªã‚’æŒ‡ã—ã¾ã™ã€‚</blockquote><p>ã“ã®æœ¬ã¯æœ¬å½“ã«åè‘—ã ã¨æ€ã„åŸæ–‡ã®<a href=https://www.oreilly.com/library/view/concurrency-in-go/9781491941294/ rel=external>Concurrency in Go</a>ã‚‚èª­ã¿ã¾ã—ãŸã€‚åŸæ–‡ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚<blockquote><p>Concurrency is a property of the code; parallelism is a property of the running program</blockquote><p>ãã—ã¦<blockquote><p>The first is that we do not write parallel code, only concurrent code that we hope will be run in parallel. Once again, parallelism is a property of the runtime of our program, not the code.</blockquote><p>ã¨ã„ã†ã‚ã‘ã§ã€ã‚³ãƒ¼ãƒ‰ã§ã¯ä¸¦è¡Œã‹ãã†ã§ãªã„ã‹ã ã‘ãŒåˆ¶å¾¡ã§ãã‚‹ã¨ã„ã†å§¿å‹¢ã§ã„ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚<h3 id=static-bound><a aria-label="Anchor link for: static-bound" class=zola-anchor href=#static-bound><code>'static</code> bound</a></h3><p><a href=https://docs.rs/tokio/0.3.1/tokio/fn.spawn.html rel=external><code>tokio::spawn</code>ã®å®šç¾©</a>ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>pub fn</span><span style=color:#88c0d0> spawn</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>>(</span><span>task</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> T</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> JoinHandle</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Output</span><span style=color:#eceff4>></span><span>â“˜ </span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    T</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Future</span><span style=color:#81a1c1> +</span><span style=color:#8fbcbb> Send</span><span style=color:#81a1c1> +</span><span style=color:#eceff4> '</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>    T</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Output</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Send</span><span style=color:#81a1c1> +</span><span style=color:#eceff4> '</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>,</span><span> </span></span></code></pre><p>ã€€ã“ã“ã§<code>T: 'static</code>ã¨ãªã£ã¦ã„ã‚‹ã¨ãã‚Œã¯"lives forever"ã¨<a href=https://github.com/pretzelhammer/rust-blog/blob/master/posts/common-rust-lifetime-misconceptions.md rel=external>ã‚ˆãèª¤è§£ã•ã‚Œã¦ã„ã‚‹</a>ãŒãã†ã§ã¯ãªã„ã¨ã„ã†æ³¨æ„ãŒã‚ã‚Šã¾ã™ã€‚(ã“ã®Common Rust Lifetime Misconceptionsã¯éå¸¸ã«å‚è€ƒã«ãªã£ãŸã®ã§åˆ¥ã§è¨˜äº‹ã‚’æ›¸ã“ã†ã¨æ€ã£ã¦ã„ã¾ã™ã€‚)<br> ã€€<code>T: 'static</code>ã¯Tã®æ‰€æœ‰è€…ã¯Tã‚’ä¿æŒã—ã¦ã„ã‚‹é™ã‚Šãƒ‡ãƒ¼ã‚¿ãŒç„¡åŠ¹ã«ãªã‚‹ã“ã¨ã¯ãªã„ã¨ä¿è¨¼ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®çµ‚äº†ã¾ã§ã‚’å«ã‚ã¦ç„¡æœŸé™ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã§ãã‚‹ã¨èª­ã‚ã¦ã€"T is bounded by a 'static lifetime"ã¨èª­ã‚€ã¹ãã§ã€"T has a 'static lifetime"ã¨èª­ã¾ãªã„ã¨è‡ªåˆ†ã¯ç†è§£ã—ã¦ã„ã¾ã™ã€‚<br> ã€€è¦ã¯<code>T: 'static</code>ã ã£ãŸã‚‰Tã¯owned typeã‹<code>'static lifetime</code>ã®å‚ç…§ã—ã‹fieldã«ã‚‚ãŸãªã„å‹ã¨ã„ã†ã“ã¨ã€‚<h3 id=send-bound><a aria-label="Anchor link for: send-bound" class=zola-anchor href=#send-bound>Send bound</a></h3><p><code>tokio::spawn</code>ã«æ¸¡ã•ã‚Œã‚‹futureã¯<code>Send</code>ã‚’implementã—ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚<strong>taskãŒ<code>Send</code>ã«ãªã‚‹ã«ã¯ã€<code>.await</code>ã‚’ã¾ãŸãã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒ<code>Send</code></strong> ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚é€†ã«ã„ã†ã¨<code>.await</code>ã¾ãŸãŒãªã‘ã‚Œã°<code>Send</code>ã§ãªã„ãƒ‡ãƒ¼ã‚¿ã§ã‚‚ä½¿ãˆã‚‹ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span>tokio</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>spawn</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>async</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#eceff4>  {</span><span>  </span></span>
<span class=giallo-l><span style=color:#81a1c1>     let</span><span> rc</span><span style=color:#81a1c1> =</span><span> std</span><span style=color:#81a1c1>::</span><span>rc</span><span style=color:#81a1c1>::</span><span>Rc</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>ok</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>     println!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{}</span><span style=color:#eceff4>",</span><span> rc</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>   }</span></span>
<span class=giallo-l><span>   tokio</span><span style=color:#81a1c1>::</span><span>task</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>yield_now</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>});</span></span></code></pre><p>ã“ã‚Œã¯OKã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span>tokio</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>spawn</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>async</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>   let</span><span> rc</span><span style=color:#81a1c1> =</span><span> std</span><span style=color:#81a1c1>::</span><span>rc</span><span style=color:#81a1c1>::</span><span>Rc</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>ok</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span>   </span></span>
<span class=giallo-l><span>   tokio</span><span style=color:#81a1c1>::</span><span>task</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>yield_now</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>   println!</span><span style=color:#eceff4>("</span><span style=color:#ebcb8b>{}</span><span style=color:#eceff4>",</span><span> rc</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>});</span></span></code></pre><p>ã“ã‚Œã¯<code>Rc</code>ãŒ<code>Send</code>ã§ãªã„ã®ã§ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ã€‚<h2 id=shared-state><a aria-label="Anchor link for: shared-state" class=zola-anchor href=#shared-state>Shared state</a></h2><p>redis serverã‚’å®Ÿè£…ã™ã‚‹ã«ã‚ãŸã£ã¦çŠ¶æ…‹ã‚’ä¿æŒã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚çŠ¶æ…‹ã‚’å…±æœ‰ã™ã‚‹æ–¹æ³•ã¨ã—ã¦ä¾‹ãˆã°ä»¥ä¸‹ã®2ã¤ãŒè€ƒãˆã‚‰ã‚Œã¾ã™ã€‚<ol><li><code>Mutex</code>ã§ã‚¬ãƒ¼ãƒ‰ã—ã¦ä¿æŒã™ã‚‹ã€‚<li>stateã‚’ç®¡ç†ã™ã‚‹å°‚ç”¨ã®taskã‚’spawnã—ã¦channelã‚’é€šã˜ã¦ã‚„ã‚Šã¨ã‚Šã™ã‚‹ã€‚</ol><p>ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ‡ãƒ¼ã‚¿ã§ã¯æœ€åˆã®æ–¹æ³•ãŒé©ã—ã¦ã„ã¦ã€I/Oç­‰ã®éåŒæœŸå‡¦ç†ãŒå¿…è¦ã«ãªã£ã¦ãã‚‹ã¨2ã¤ç›®ã®æ–¹å¼ãŒé©ã—ã¦ã„ã‚‹ã€‚<br> ä»Šå›ã®å®Ÿè£…ã§ã¯çŠ¶æ…‹ã¯<code>HashMap</code>ã§ãƒ¡ãƒ¢ãƒªã«ä¿æŒã™ã‚‹ã®ã§<code>Mutex</code>ã‚’åˆ©ç”¨ã—ãŸæ–¹å¼ã§å®Ÿè£…ã—ã¦ã„ã‚‹ã€‚(channelã‚’ä½¿ã†æ–¹å¼ã¯ã®ã¡ã®ã¡ãµã‚Œã‚‹)<h3 id=bytes-crate><a aria-label="Anchor link for: bytes-crate" class=zola-anchor href=#bytes-crate><code>bytes</code> crate</a></h3><p>byte streamã‚’è¡¨ç¾ã™ã‚‹ã®ã«<code>Vec&lt;u8></code>ã§ãªã<code>Bytes</code>ã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã«<code>bytes</code> crateã‚’ä¾å­˜å…ˆã«è¿½åŠ ã—ã¾ã™ã€‚tokioã®versionãŒ0.3ã«ã‚ãŒã£ãŸã®ã§ã€<code>0.6</code>ã‚’æŒ‡å®šã—ã¾ã™ã€‚<p>Cargo.toml<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=toml><span class=giallo-l><span>bytes</span><span style=color:#eceff4> = "</span><span style=color:#a3be8c>0.6</span><span style=color:#eceff4>"</span></span></code></pre><h3 id=hashmapnogong-you><a aria-label="Anchor link for: hashmapnogong-you" class=zola-anchor href=#hashmapnogong-you><code>HashMap</code>ã®å…±æœ‰</a></h3><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> tokio</span><span style=color:#81a1c1>::</span><span>net</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>TcpListener</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>collections</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>HashMap</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>sync</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>Arc</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Mutex</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[tokio::main]</span></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> listener</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> TcpListener</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>bind</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>127.0.0.1:6379</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>.await.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    println!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Listening</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> db</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Arc</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>Mutex</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>HashMap</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>()));</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    loop</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span style=color:#eceff4> (</span><span>socket</span><span style=color:#eceff4>,</span><span> _</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> listener</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>accept</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> db</span><span style=color:#81a1c1> =</span><span> db</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>        println!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Accepted</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span>        tokio</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>spawn</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>async move</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0>            process</span><span style=color:#eceff4>(</span><span>socket</span><span style=color:#eceff4>,</span><span> db</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>        });</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>HashMap</code>ã«<code>Mutex</code>ã§interior mutabilityã‚’ä»˜ä¸ã—ã¦ã€<code>Arc</code>ã§è¤‡æ•°threadã§ownã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚<br> <code>tokio::sync::Mutex</code>ã§ã¯ãªã<code>std::sync::Mutex</code>ã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚<br> <code>tokio::sync::Mutex</code>ã¯å–å¾—ã—ãŸlockãŒ<code>.await</code>ã‚’ã¾ãŸãéš›ã«åˆ©ç”¨ã™ã‚‹ãã†ã§ã™ã€‚ <code>std</code>ã¨<code>tokio</code>ã®<code>Mutex</code>ã®ä½¿ã„åˆ†ã‘ãŒãšã£ã¨ã‚ã‹ã£ã¦ã„ãªã‹ã£ãŸã®ã§ç–‘å•ç‚¹ãŒã²ã¨ã¤è§£æ¶ˆã§ãã¦ã†ã‚Œã—ã„ã§ã™ã€‚<br> ç«¶åˆãŒå°‘ãªãã€å–å¾—ã—ãŸãƒ­ãƒƒã‚¯ãŒ<code>.await</code>ã‚’ã¾ãŸãŒãªã„å ´åˆã¯asyncå†…ã§synchronous mutexã‚’åˆ©ç”¨ã—ã¦ã‚‚ã‚ˆã„ãã†ã§ã™ã€‚<br> ãŸã ã—æ³¨æ„ç‚¹ã¨ã—ã¦ãƒ­ãƒƒã‚¯å–å¾—ã«ã‚ˆã‚‹blockã¯ãã®taskã ã‘ã§ãªãtaskã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹threadã«scheduleã•ã‚Œã¦ã„ã‚‹ä»–ã®taskã‚‚ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹ã®ã§æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚ã“ã‚Œã¯mutexã«é™ã£ãŸè©±ã§ã¯ãªãasyncå†…ã§blockã™ã‚‹APIå‘¼ã¶å ´åˆã®ä¸€èˆ¬çš„æ³¨æ„äº‹é …ã¨ã„ãˆãã†ã§ã™ã€‚<br> ã¾ãŸã€<a href=https://docs.rs/parking_lot/0.10.2/parking_lot/type.Mutex.html rel=external><code>parking_lot::Mutex</code></a>ã®åˆ©ç”¨ã‚‚é¸æŠè‚¢ã«ã‚ã‚‹ãã†ãªã®ã§ã™ãŒã€ã‚ˆãã‚ã‹ã£ã¦ã„ã¾ã›ã‚“ã€‚Rustã§æ™‚ã€…ã§ã¦ãã‚‹<code>parking</code>ã«ã¤ã„ã¦ã¯ã„ãšã‚Œèª¿ã¹ã¦ã„ããŸã„ã§ã™ã€‚<p>mutexã®ãƒ­ãƒƒã‚¯ãŒå•é¡Œã«ãªã£ãŸå ´åˆã®é¸æŠè‚¢ã¨ã—ã¦<ul><li>å…±æœ‰ã—ã¦ã„ãŸstateã®ç®¡ç†å°‚ç”¨ã®taskã‚’ç”¨æ„ã—ã¦ã€message passingã‚’åˆ©ç”¨ã™ã‚‹ã€‚<li>mutexã‚’åˆ†å‰²ã™ã‚‹<li>ãã‚‚ãã‚‚mutexã‚’åˆ©ç”¨ã—ãªã„ã‚ˆã†ã«ã™ã‚‹</ul><p>ãŸã¨ãˆã°ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¦<code>HashMap</code>ã‚’åˆ†å‰²ã—ã¦ãƒ­ãƒƒã‚¯ã®ç«¶åˆã™ã‚‹é »åº¦ã‚’ã•ã’ã‚‹ã“ã¨ãŒã§ãã‚‹ãã†ã§ã™ã€‚ã¾ãŸ<a href=https://docs.rs/dashmap rel=external>dashmap</a>ãŒsharded hash mapã®æ©Ÿèƒ½ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>type</span><span style=color:#8fbcbb> ShardedDb</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Arc</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Vec</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Mutex</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>HashMap</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Vec</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>u8</span><span style=color:#eceff4>>>>>>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>let</span><span> shard</span><span style=color:#81a1c1> =</span><span> db</span><span style=color:#eceff4>[</span><span style=color:#88c0d0>hash</span><span style=color:#eceff4>(</span><span>key</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> %</span><span> db</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>len</span><span style=color:#eceff4>()]</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>lock</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span>shard</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>insert</span><span style=color:#eceff4>(</span><span>key</span><span style=color:#eceff4>,</span><span> value</span><span style=color:#eceff4>);</span></span></code></pre><h2 id=channels><a aria-label="Anchor link for: channels" class=zola-anchor href=#channels>Channels</a></h2><p>ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã‹ã‚‰ã¿ã¦ã„ãã¾ã™ã€‚ã¾ãšæ›¸ããŸã„ã®ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªå‡¦ç†ã ã¨ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> mini_redis</span><span style=color:#81a1c1>::</span><span>client</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[tokio::main]</span></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#616e88>    // Establish a connection to the server</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> client</span><span style=color:#81a1c1> =</span><span> client</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>connect</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>127.0.0.1:6379</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>.await.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    // Spawn two tasks, one gets a key, the other sets a key</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> t1</span><span style=color:#81a1c1> =</span><span> tokio</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>spawn</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>async</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> res</span><span style=color:#81a1c1> =</span><span> client</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>get</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>hello</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    });</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> t2</span><span style=color:#81a1c1> =</span><span> tokio</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>spawn</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>async</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>        client</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>set</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>foo</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>bar</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    });</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>    t1</span><span style=color:#81a1c1>.await.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span>    t2</span><span style=color:#81a1c1>.await.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã“ã®ã‚³ãƒ¼ãƒ‰ã¯ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã§ãã¾ã›ã‚“ã€‚<code>client</code>ã¯copyã§ãªã„ã®ã§æ‰€æœ‰æ¨©ã®å•é¡ŒãŒã‚ã‚Šã¾ã™ã—ã€<code>Client::set</code>ã¯<code>&mut self</code>ã‚’è¦æ±‚ã™ã‚‹ã®ã§æ’ä»–åˆ¶å¾¡ãŒå¿…è¦ã«ãªã£ã¦ãã¾ã™ã€‚<br> ãã“ã§message passingã¨ã„ã†ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚<code>client</code> ãƒªã‚½ãƒ¼ã‚¹ã‚’ç®¡ç†ã™ã‚‹å°‚ç”¨ã®taskã‚’spawnã—ã¦ã€clientã«å‡¦ç†ã‚’ä¾é ¼ã—ãŸã„taskã¯client taskã«å‡¦ç†ã‚’ä¾é ¼ã™ã‚‹messageã‚’é€ã‚‹å½¢ã«ã—ã¾ã™ã€‚<br> ã“ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½¿ã†ã¨ã€æ¥ç¶šã™ã‚‹connectionã¯1æœ¬ã§æ¸ˆã¿clientã‚’manageã™ã‚‹taskã¯clientã«æ’ä»–çš„ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚ã¾ãŸchannelã¯bufferã¨ã—ã¦ã‚‚æ©Ÿèƒ½ã™ã‚‹ã®ã§å‡¦ç†ã®producerã¨consumerã®é€Ÿåº¦å·®ã‚’å¸åã—ã¦ãã‚Œã¾ã™ã€‚<h3 id=tokionochannel-primitives><a aria-label="Anchor link for: tokionochannel-primitives" class=zola-anchor href=#tokionochannel-primitives>tokioã®channel primitives</a></h3><p>tokioã¯ç›®çš„ã”ã¨ã«ä»¥ä¸‹ã®channel primitiveã‚’ç”¨æ„ã—ã¦ãã‚Œã¦ã„ã¾ã™ã€‚<ul><li><a href=https://docs.rs/tokio/0.3/tokio/sync/mpsc/index.html rel=external><code>mpsc</code></a>: multi-producer, single consumerç”¨channel<li><a href=https://docs.rs/tokio/0.3/tokio/sync/oneshot/index.html rel=external><code>oneshot</code></a>: ä¸€åº¦ã ã‘ã®å€¤ã®é€šçŸ¥ã«åˆ©ç”¨ã§ãã‚‹<li><a href=https://docs.rs/tokio/0.3/tokio/sync/broadcast/index.html rel=external><code>broadcast</code></a>: é€ã£ãŸmessageã¯ãã‚Œãã‚Œã®receiverã«å±Šã<li><a href=https://docs.rs/tokio/0.3/tokio/sync/watch/index.html rel=external><code>watch</code></a>: single-producer, multi-consumer.receiverã¯æœ€æ–°ã®å€¤ã ã‘ã†ã‘ã¨ã‚Œã‚‹ã€‚</ul><p><code>std::sync::mpsc</code>ã‚„<code>crossbeam::channel</code>ã¯threadã‚’blockã—ã¦ã—ã¾ã†ã®ã§asyncã§ä½¿ã†ã«ã¯é©ã•ãªã„ãã†ã§ã™ã€‚ä»¥ä¸‹ã§ã¯<code>mpsc</code>ã¨<code>oneshot</code>ã‚’åˆ©ç”¨ã—ã¦ã„ãã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> bytes</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Bytes</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> mini_redis</span><span style=color:#81a1c1>::</span><span>client</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> tokio</span><span style=color:#81a1c1>::</span><span>sync</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span>mpsc</span><span style=color:#eceff4>,</span><span> oneshot</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[derive(</span><span style=color:#8fbcbb>Debug</span><span style=color:#5e81ac>)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>enum</span><span style=color:#8fbcbb> Command</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Get</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>        key</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        resp</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Responder</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Bytes</span><span style=color:#eceff4>>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    },</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Set</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>        key</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> String</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>        val</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Vec</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>u8</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>        resp</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Responder</span><span style=color:#eceff4>&lt;()>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    },</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>type</span><span style=color:#8fbcbb> Responder</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>></span><span style=color:#81a1c1> =</span><span> oneshot</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Sender</span><span style=color:#eceff4>&lt;</span><span>mini_redis</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>T</span><span style=color:#eceff4>>>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[tokio::main]</span></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span style=color:#eceff4> (</span><span>tx</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> mut</span><span> rx</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> mpsc</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>channel</span><span style=color:#eceff4>(</span><span style=color:#b48ead>32</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> tx2</span><span style=color:#81a1c1> =</span><span> tx</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> manager</span><span style=color:#81a1c1> =</span><span> tokio</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>spawn</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>async move</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> client</span><span style=color:#81a1c1> =</span><span> client</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>connect</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>127.0.0.1:6379</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>.await.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        while let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>cmd</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> rx</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>recv</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            match</span><span> cmd</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Command</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Get</span><span style=color:#eceff4> {</span><span> key</span><span style=color:#eceff4>,</span><span> resp</span><span style=color:#eceff4> }</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    let</span><span> res</span><span style=color:#81a1c1> =</span><span> client</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>get</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>key</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    let</span><span> _</span><span style=color:#81a1c1> =</span><span> resp</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>send</span><span style=color:#eceff4>(</span><span>res</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Command</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Set</span><span style=color:#eceff4> {</span><span> key</span><span style=color:#eceff4>,</span><span> val</span><span style=color:#eceff4>,</span><span> resp</span><span style=color:#eceff4> }</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    let</span><span> res</span><span style=color:#81a1c1> =</span><span> client</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>set</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>key</span><span style=color:#eceff4>,</span><span> val</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    let</span><span> _</span><span style=color:#81a1c1> =</span><span> resp</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>send</span><span style=color:#eceff4>(</span><span>res</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    });</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    // Spawn two tasks, each setting a value</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> t1</span><span style=color:#81a1c1> =</span><span> tokio</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>spawn</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>async move</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span style=color:#eceff4> (</span><span>resp_tx</span><span style=color:#eceff4>,</span><span> resp_rx</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> oneshot</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>channel</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> cmd</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Command</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Get</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            key</span><span style=color:#81a1c1>:</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>hello</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_string</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>            resp</span><span style=color:#81a1c1>:</span><span> resp_tx</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>        };</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>        // Send the GET request</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if</span><span> tx</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>send</span><span style=color:#eceff4>(</span><span>cmd</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await.</span><span style=color:#88c0d0>is_err</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>            eprintln!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>connection task shutdown</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#81a1c1>            return</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>        // Await the response</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> res</span><span style=color:#81a1c1> =</span><span> resp_rx</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>        println!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>GOT = </span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>:?</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>",</span><span> res</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>    });</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> t2</span><span style=color:#81a1c1> =</span><span> tokio</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>spawn</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>async move</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span style=color:#eceff4> (</span><span>resp_tx</span><span style=color:#eceff4>,</span><span> resp_rx</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> oneshot</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>channel</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> cmd</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Command</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Set</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            key</span><span style=color:#81a1c1>:</span><span style=color:#eceff4> "</span><span style=color:#a3be8c>foo</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_string</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>            val</span><span style=color:#81a1c1>:</span><span style=color:#a3be8c> b</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>bar</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_vec</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span>            resp</span><span style=color:#81a1c1>:</span><span> resp_tx</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>        };</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>        // Send the SET request</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if</span><span> tx2</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>send</span><span style=color:#eceff4>(</span><span>cmd</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await.</span><span style=color:#88c0d0>is_err</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>            eprintln!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>connection task shutdown</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#81a1c1>            return</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>        // Await the response</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> res</span><span style=color:#81a1c1> =</span><span> resp_rx</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>        println!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>GOT = </span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>:?</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>",</span><span> res</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>    });</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>    t1</span><span style=color:#81a1c1>.await.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span>    t2</span><span style=color:#81a1c1>.await.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span>    manager</span><span style=color:#81a1c1>.await.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ãƒã‚¤ãƒ³ãƒˆã¯client taskã«å‡¦ç†ã‚’ä¾é ¼ã™ã‚‹<code>Command</code>ã«çµæœã‚’é€šçŸ¥ã™ã‚‹ãŸã‚ã®filedãŒç”¨æ„ã—ã¦ã‚ã‚‹ã¨ã“ã‚ã§ã—ã‚‡ã†ã‹ã€‚<br> <code>Responder&lt;T> = oneshot::Sender&lt;mini_redis::Result&lt;T>>;</code>ã¨å®šç¾©ã—ã¦ã€ä¾é ¼ã—ãŸã‚³ãƒãƒ³ãƒ‰ã®çµæœã‚’ã†ã‘ã¨ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚<br> å‡¦ç†ã‚’ä¾é ¼ã™ã‚‹channelã¨çµæœã‚’ã¤ã‘ã¨ã‚‹channelã§åˆ¥ã®primitiveã‚’åˆ©ç”¨ã™ã‚‹ã“ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯éå¸¸ã«å‚è€ƒã«ãªã‚Šã¾ã—ãŸã€‚Goã ã¨ä¸¡æ–¹ã¨ã‚‚<code>chan</code>ã«ãªã‚Šã¾ã™ãŒã€<code>oneshot</code>ã®ã»ã†ãŒæ„å›³ãŒã§ã¦ã„ã„ãªã¨æ€ã„ã¾ã™ã€‚<h2 id=i-o><a aria-label="Anchor link for: i-o" class=zola-anchor href=#i-o>I/O</a></h2><h3 id=asyncread-asyncwrite><a aria-label="Anchor link for: asyncread-asyncwrite" class=zola-anchor href=#asyncread-asyncwrite><code>AsyncRead</code>/<code>AsyncWrite</code></a></h3><p>Futureã®<code>poll</code>ã‚’ç›´æ¥å‘¼ã¶ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã‹ãªã„ã‚ˆã†ã«<code>AsyncRead</code>/<code>AsyncWrite</code> traitã‚’ç›´æ¥ã‚ˆã¶ã“ã¨ã¯åŸºæœ¬çš„ã«ãªãã€ãã‚Œãã‚Œã«å¯¾å¿œã—ã¦ã„ã‚‹<code>AsyncReadExt</code>/<code>AsyncWriteExt</code>ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> tokio</span><span style=color:#81a1c1>::</span><span>io</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#81a1c1>self</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> AsyncReadExt</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> tokio</span><span style=color:#81a1c1>::</span><span>fs</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>File</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[tokio::main]</span></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span> io</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> f</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> File</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>open</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>foo.txt</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> buffer</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Vec</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    // read the whole file</span></span>
<span class=giallo-l><span>    f</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>read_to_end</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut</span><span> buffer</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Ok</span><span style=color:#eceff4>(())</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> tokio</span><span style=color:#81a1c1>::</span><span>io</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#81a1c1>self</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> AsyncWriteExt</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> tokio</span><span style=color:#81a1c1>::</span><span>fs</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>File</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[tokio::main]</span></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span> io</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> file</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> File</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>create</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>foo.txt</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    // Writes some prefix of the byte string, but not necessarily all of it.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> n</span><span style=color:#81a1c1> =</span><span> file</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>b</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>some bytes</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    println!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Wrote the first </span><span style=color:#ebcb8b>{}</span><span style=color:#a3be8c> bytes of 'some bytes'.</span><span style=color:#eceff4>",</span><span> n</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Ok</span><span style=color:#eceff4>(())</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>fileã®å†…å®¹ã‚’ã™ã¹ã¦èª­ã‚“ã ã‚Šã€æ›¸ãè¾¼ã‚“ã ã‚Šã™ã‚‹ã®ã¯ã“ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚åŒæœŸçš„ãªæ›¸ãæ–¹ã¨åŒã˜ã§ã™ã­ã€‚<h3 id=echo-server><a aria-label="Anchor link for: echo-server" class=zola-anchor href=#echo-server>Echo server</a></h3><p>ã¨ã„ã†ã“ã¨ã§I/Oã¨ã„ãˆã°echoã¨ã„ã†ã“ã¨ã§echo serverã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚<br> server sideã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#5e81ac>#![allow(dead_code)]</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> tokio</span><span style=color:#81a1c1>::</span><span>io</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> tokio</span><span style=color:#81a1c1>::</span><span>net</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>TcpListener</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[tokio::main]</span></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span> io</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> listener</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> TcpListener</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>bind</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>127.0.0.1:6142</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>.await.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    loop</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span style=color:#eceff4> (</span><span>socket</span><span style=color:#eceff4>,</span><span> _</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> listener</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>accept</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>        // echo_io_copy(socket).await;</span></span>
<span class=giallo-l><span style=color:#88c0d0>        echo_manual_copy</span><span style=color:#eceff4>(</span><span>socket</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> echo_manual_copy</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>mut</span><span> socket</span><span style=color:#81a1c1>:</span><span> tokio</span><span style=color:#81a1c1>::</span><span>net</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>TcpStream</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    use</span><span> tokio</span><span style=color:#81a1c1>::</span><span>io</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>AsyncReadExt</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> AsyncWriteExt</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l><span>    tokio</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>spawn</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>async move</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> buf</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0;font-weight:700> vec!</span><span style=color:#eceff4>[</span><span style=color:#b48ead>0</span><span style=color:#eceff4>;</span><span style=color:#b48ead> 1024</span><span style=color:#eceff4>];</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        loop</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            match</span><span> socket</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>read</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut</span><span> buf</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>                // return value of Ok(0) signified that the remote has closed.</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Ok</span><span style=color:#eceff4>(</span><span style=color:#b48ead>0</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> => return</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Ok</span><span style=color:#eceff4>(</span><span>n</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    if</span><span> socket</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write_all</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>buf</span><span style=color:#eceff4>[</span><span style=color:#81a1c1>..</span><span>n</span><span style=color:#eceff4>])</span><span style=color:#81a1c1>.await.</span><span style=color:#88c0d0>is_err</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>                        eprintln!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>write error</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#81a1c1>                        return</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>                    }</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Err</span><span style=color:#eceff4>(</span><span>_</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    return</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    });</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> echo_io_copy</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>mut</span><span> socket</span><span style=color:#81a1c1>:</span><span> tokio</span><span style=color:#81a1c1>::</span><span>net</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>TcpStream</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span>    tokio</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>spawn</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>async move</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span style=color:#eceff4> (</span><span style=color:#81a1c1>mut</span><span> rd</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> mut</span><span> wr</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> socket</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>split</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        if</span><span> io</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>copy</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut</span><span> rd</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> &mut</span><span> wr</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await.</span><span style=color:#88c0d0>is_err</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>            eprintln!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>failed to copy</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    });</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>è‡ªåˆ†ã§bufferã‚’ç¢ºä¿ã—ã¦loopã§readã™ã‚‹æ–¹æ³•ã¨<code>tokio::io::copy</code>ã‚’åˆ©ç”¨ã™ã‚‹æ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚ <code>io::copy</code>ã¯readerã¨writerãã‚Œãã‚Œã«<code>&mut</code>ã‚’è¦æ±‚ã™ã‚‹ã®ã§<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>io::copy(&mut socket, &mut socket).await</span></span></code></pre><p>ã¨ã—ãŸã„ã¨ã“ã‚ã§ã™ãŒã€å‚ç…§ã®åˆ¶ç´„ã‹ã‚‰ãã‚ŒãŒã§ãã¾ã›ã‚“ã€‚ãã“ã§ã€<code>io::split</code>ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚(ãŸã ã—<code>TcpStream</code>ã¯è‡ªå‰ã§ç”¨æ„ã—ã¦ã„ã‚‹)<br> <code>split</code> APIã‚’ã¿ã‚‹ã¨ã„ã¤ã‹twitterã§æµã‚Œã¦ããŸã“ã®ç”»åƒãŒã„ã¤ã‚‚æ€ã„å‡ºã•ã‚Œã¾ã™ã€‚<br> <a href=https://knowyourmeme.com/memes/multi-track-drifting rel=external>é›»è»Šã§Dã®meme</a>ã¿ãŸã„ã§ã™ã€‚<figure><div class=fig-images-row><img , alt src=images/denshaded.jpeg></div><figcaption>è¤‡ç·šãƒ‰ãƒªãƒ•ãƒˆ</figcaption></figure><p>clientã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> tokio</span><span style=color:#81a1c1>::</span><span>io</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#81a1c1>self</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> AsyncReadExt</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> AsyncWriteExt</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> tokio</span><span style=color:#81a1c1>::</span><span>net</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>TcpStream</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[tokio::main]</span></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span> io</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> socket</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> TcpStream</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>connect</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>127.0.0.1:6142</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span style=color:#eceff4> (</span><span style=color:#81a1c1>mut</span><span> rd</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> mut</span><span> wr</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> io</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>split</span><span style=color:#eceff4>(</span><span>socket</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> _write_task</span><span style=color:#81a1c1> =</span><span> tokio</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>spawn</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>async move</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>        wr</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write_all</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>b</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>hello</span><span style=color:#ebcb8b>\r\n</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span>        wr</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write_all</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>b</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>world</span><span style=color:#ebcb8b>\r\n</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        Ok</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>&lt;</span><span>_</span><span style=color:#eceff4>,</span><span> io</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>>(())</span></span>
<span class=giallo-l><span style=color:#eceff4>    });</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> buf</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0;font-weight:700> vec!</span><span style=color:#eceff4>[</span><span style=color:#b48ead>0</span><span style=color:#eceff4>;</span><span style=color:#b48ead> 128</span><span style=color:#eceff4>];</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    loop</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> n</span><span style=color:#81a1c1> =</span><span> rd</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>read</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut</span><span> buf</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        if</span><span> n</span><span style=color:#81a1c1> ==</span><span style=color:#b48ead> 0</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            break</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>        println!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>GOT </span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>:?</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>",</span><span style=color:#8fbcbb> String</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_utf8_lossy</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>buf</span><span style=color:#eceff4>[</span><span style=color:#81a1c1>..</span><span>n</span><span style=color:#eceff4>]));</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>    Ok</span><span style=color:#eceff4>(())</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>split</code>ã§writerã‚’moveã§æ¸¡ã—ã¦ã„ã¾ã™ã€‚<h2 id=framing><a aria-label="Anchor link for: framing" class=zola-anchor href=#framing>Framing</a></h2><p>æ¬¡ã«<code>TcpStream</code>ã‚’wrapã—ã¦byte streamã‹ã‚‰redisã®å„ç¨®ã‚³ãƒãƒ³ãƒ‰APIã‚’æä¾›ã—ã¦ã„ã‚‹<code>Connection</code>ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚ ã“ã“ã§ã„ã†frameã¨ã¯client/serveré–“ã§é€ã‚‰ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã®å˜ä½ã¨ã„ã†æ„Ÿã˜ã§ã—ã‚‡ã†ã‹ã€‚(A frame is a unit of data transmitted between two peers.)<br> 1ã¤ä»¥ä¸Šã®frameã§protocolã«ãŠã‘ã‚‹messageã«ãªã‚‹ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚ ä»Šå›å®Ÿè£…ã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹Redis wire protocolã«ã¤ã„ã¦ã¯<a href=https://redis.io/topics/protocol rel=external>ã“ã¡ã‚‰</a><br> å®Ÿè£…ã«å¿…è¦ãªç¯„å›²ã§ã¾ã¨ã‚ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚<h3 id=resp-redis-serialization-protocol><a aria-label="Anchor link for: resp-redis-serialization-protocol" class=zola-anchor href=#resp-redis-serialization-protocol>RESP(REdis Serialization Protocol)</a></h3><p>https://redis.io/topics/protocol<p>first byteã§dataã®typeã‚’åˆ¤å®šã§ãã‚‹<ul><li><code>+</code> Simple Strings<li><code>-</code> Errors<li><code>:</code> Integers<li><code>$</code> Bulk Strings<li><code>*</code> Arrays</ul><p>protocolã¯å¸¸ã«<code>\r\n</code>(CRLF)ã§terminated<h4 id=resp-simple-strings><a aria-label="Anchor link for: resp-simple-strings" class=zola-anchor href=#resp-simple-strings>RESP Simple Strings</a></h4><p><code>+</code>ã«ç¶šã„ã¦CRã¨LFã‚’å«ã¾ãªã„æ–‡å­—åˆ—ã§æ§‹æˆã•ã‚Œã‚‹ã€‚<br> æˆåŠŸã‚’è¡¨ã™OKã¯ä»¥ä¸‹ã®ã‚ˆã†ã«5byteã€‚<br> <code>+OK\r\n</code><h2 id=resp-errors><a aria-label="Anchor link for: resp-errors" class=zola-anchor href=#resp-errors>RESP Errors</a></h2><p>ã‚¨ãƒ©ãƒ¼ç”¨ã®data type. å®Ÿä½“ã¨ã—ã¦ã¯Simple Stringsã ãŒprefixãŒ<code>-</code>ã§åŒºåˆ¥ã•ã‚Œã‚‹ã€‚<br> clientã«ä¾‹å¤–ã¨ã—ã¦æ‰±ã‚ã‚Œã€å†…å®¹ã¯ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€‚<br> <code>-Error message\r\n</code><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>-ERR unknown command 'foobar'</span></span>
<span class=giallo-l><span>-WRONGTYPE Operation against a key holding the wrong kind of value</span></span></code></pre><p><code>ERR</code>ã®ã‚ã¨ã«<code>WRONGTYPE</code>ã®ã‚ˆã†ãªå…·ä½“çš„ãªã‚¨ãƒ©ãƒ¼ç¨®åˆ¥ã‚’è¿”ã™ã®ã¯Redisã®æ…£ç¿’ã§RESPã®Error Formatã§ã¯ãªã„ã€‚<h4 id=resp-integers><a aria-label="Anchor link for: resp-integers" class=zola-anchor href=#resp-integers>RESP Integers</a></h4><p>CRLF terminatedãªstringã§integerã«parseã§ãã‚‹ã€‚prefixã¯<code>:</code>ã€‚<br> signed 64bit integerã®rangeã§ã‚ã‚‹ã“ã¨ãŒä¿è¨¼ã•ã‚Œã¦ã„ã‚‹ã€‚<ul><li><code>:0\r\n</code><li><code>:1000\r\n</code></ul><h4 id=resp-bulk-strings><a aria-label="Anchor link for: resp-bulk-strings" class=zola-anchor href=#resp-bulk-strings>RESP Bulk Strings</a></h4><p>ã€€512MBã¾ã§ã®ä»»æ„ã®byteåˆ—ã‚’ä¿æŒã§ãã‚‹ãƒ‡ãƒ¼ã‚¿ã€‚redisã®documentã§ã¯binary safeã¨è¨€ã‚ã‚Œã¦ã„ã‚‹ã€‚<br> binary safe stringã®æ„å‘³ã«ã¤ã„ã¦ã¯äºˆã‚é•·ã•ãŒåˆ†ã‹ã£ã¦ã„ã¦ç‰¹å®šã®æ–‡å­—ã«ã‚ˆã‚‹çµ‚ç«¯ã‚’å‰æã«ã—ã¦ãŠã‚‰ãšã€ä»»æ„ã®byteåˆ—ã‚’ä¿æŒã§ãã‚‹ã¨ã„ã†ã“ã¨ã ã¨æ€ã†ã€‚<ul><li><code>$6\r\nfoobar\r\n</code> : "foobar".<li><code>$0\r\n\r\</code> : empty string.<li><code>$-1\r\n</code> : non-existenceã‚’è¡¨ç¾ã€‚</ul><h4 id=resp-arrays><a aria-label="Anchor link for: resp-arrays" class=zola-anchor href=#resp-arrays>RESP Arrays</a></h4><p>è¤‡æ•°ã®data typeã‚’è¡¨ã™data type.è¦ç´ æ•°ã¯prefix<code>*</code>ã®ã‚ã¨ã«æ˜ç¤ºã•ã‚Œã‚‹ã€‚<ul><li><code>*0\r\n</code> : empty array.<li><code>*2\r\n$3\r\nfoo\r\n$3\r\nbar\r\n</code> : "foo", "bar"ã‚’è¡¨ã™ã€‚<li><code>*-1\r\n</code> : Null Array.</ul><h4 id=sending-commands-to-a-redis-server><a aria-label="Anchor link for: sending-commands-to-a-redis-server" class=zola-anchor href=#sending-commands-to-a-redis-server>Sending commands to a Redis Server</a></h4><p>clientã‹ã‚‰serverã«<code>LLEN mylist</code>ã‚’é€ã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚‹ã€‚<br> <code>*2\r\n$4\r\nLLEN\r\n$6\r\nmylist\r\n</code><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=markdown><span class=giallo-l><span>Array: 2 element</span></span>
<span class=giallo-l><span style=color:#eceff4>  -</span><span> String(len:4) LLEN</span></span>
<span class=giallo-l><span style=color:#eceff4>  -</span><span> String(len:6) mylist</span></span></code></pre><h3 id=framenoshi-zhuang><a aria-label="Anchor link for: framenoshi-zhuang" class=zola-anchor href=#framenoshi-zhuang>frameã®å®Ÿè£…</a></h3><p>ä¸Šè¨˜ã®redis data typeã‚’Rustã§è¡¨ç¾ã™ã‚‹ã¨<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> bytes</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Bytes</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>enum</span><span style=color:#8fbcbb> Frame</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0>    Simple</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#88c0d0>    Error</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>String</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#88c0d0>    Integer</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>u64</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#88c0d0>    Bulk</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Bytes</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Null</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#88c0d0>    Array</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Vec</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Frame</span><span style=color:#eceff4>>),</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ã‚·ãƒ³ãƒ—ãƒ«ã§ã™ã­ã€‚Redisã®Commandã¯è¤‡æ•°Frame(<code>Frame::Array</code>)ã§è¡¨ç¾ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ãƒ¦ãƒ¼ã‚¶ã¨ã—ã¦ã¯tcp socket(reader)ã‚’æ¸¡ã—ã¦ã‚³ãƒãƒ³ãƒ‰ã‚’è¿”ã—ã¦ãã‚Œã‚‹ã‚ˆã†ãªå‡¦ç†ãŒæ¬²ã—ããªã‚Šã¾ã™ã€‚<br> server sideã®frameã‚’èª­ã‚€å‡¦ç†ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> bytes</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Bytes</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> mini_redis</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Frame</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>collections</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>HashMap</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>sync</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>Arc</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Mutex</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> tokio</span><span style=color:#81a1c1>::</span><span>net</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>TcpListener</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> TcpStream</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>mod</span><span> connection</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> connection</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Connection</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> process</span><span style=color:#eceff4>(</span><span>socket</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> TcpStream</span><span style=color:#eceff4>,</span><span> db</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Db</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    use</span><span> mini_redis</span><span style=color:#81a1c1>::</span><span>Command</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#81a1c1>self</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Get</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Set</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> connection</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Connection</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>socket</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    while let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>frame</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> connection</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>read_frame</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> response</span><span style=color:#81a1c1> = match</span><span style=color:#8fbcbb> Command</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_frame</span><span style=color:#eceff4>(</span><span>frame</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#88c0d0>            Set</span><span style=color:#eceff4>(</span><span>cmd</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                let mut</span><span> db</span><span style=color:#81a1c1> =</span><span> db</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>lock</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span>                db</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>insert</span><span style=color:#eceff4>(</span><span>cmd</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>key</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_string</span><span style=color:#eceff4>(),</span><span> cmd</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>value</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Frame</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Simple</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>OK</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_string</span><span style=color:#eceff4>())</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#88c0d0>            Get</span><span style=color:#eceff4>(</span><span>cmd</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                let</span><span> db</span><span style=color:#81a1c1> =</span><span> db</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>lock</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>                if let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>value</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> db</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>get</span><span style=color:#eceff4>(</span><span>cmd</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>key</span><span style=color:#eceff4>()) {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                    Frame</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Bulk</span><span style=color:#eceff4>(</span><span>value</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>())</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                    Frame</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Null</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span>            cmd</span><span style=color:#81a1c1> =></span><span style=color:#88c0d0;font-weight:700> panic!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>unimplemented </span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>:?</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>",</span><span> cmd</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>        };</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>        connection</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write_frame</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>response</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>Connection::read_frame()</code>ãŒ<code>Frame::Array</code>ã‚’è¿”ã—ã€<code>Frame::Array</code>ã‹ã‚‰Redisã®<code>Command</code>ã«å¤‰æ›ã—ã¦ã„ã¾ã™ã€‚<br> ã¨ã„ã†ã“ã¨ã§ã€byte streamã‹ã‚‰<code>Frame::Array</code>ã«å¤‰æ›ã™ã‚‹å‡¦ç†ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚<h4 id=buffered-reads><a aria-label="Anchor link for: buffered-reads" class=zola-anchor href=#buffered-reads>Buffered reads</a></h4><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>io</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#81a1c1>self</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Cursor</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> bytes</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>Buf</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> BytesMut</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> mini_redis</span><span style=color:#81a1c1>::</span><span>frame</span><span style=color:#81a1c1>::</span><span>Error</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Incomplete</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> mini_redis</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>Frame</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> tokio</span><span style=color:#81a1c1>::</span><span>io</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>AsyncReadExt</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> AsyncWriteExt</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> BufWriter</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> tokio</span><span style=color:#81a1c1>::</span><span>net</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>TcpStream</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>pub struct</span><span style=color:#8fbcbb> Connection</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    stream</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> BufWriter</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>TcpStream</span><span style=color:#eceff4>>,</span></span>
<span class=giallo-l><span>    buffer</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> BytesMut</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Connection</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    pub fn</span><span style=color:#88c0d0> new</span><span style=color:#eceff4>(</span><span>stream</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> TcpStream</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Connection</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Connection</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            stream</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> BufWriter</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>stream</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span>            buffer</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> BytesMut</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>with_capacity</span><span style=color:#eceff4>(</span><span style=color:#b48ead>4096</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    pub async fn</span><span style=color:#88c0d0> read_frame</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Frame</span><span style=color:#eceff4>>> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        loop</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            if let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>frame</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> = self.</span><span style=color:#88c0d0>parse_frame</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>?</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                return</span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Some</span><span style=color:#eceff4>(</span><span>frame</span><span style=color:#eceff4>));</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>            if</span><span style=color:#b48ead> 0</span><span style=color:#81a1c1> == self.</span><span>stream</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>read_buf</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self.</span><span>buffer</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                if self.</span><span>buffer</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>is_empty</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    return</span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>None</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    return</span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>connection reset by peer</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> parse_frame</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Frame</span><span style=color:#eceff4>>> {</span></span>
<span class=giallo-l><span style=color:#616e88>        // Create the T: Buf type.</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> buf</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Cursor</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span>buffer</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_ref</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        match</span><span style=color:#8fbcbb> Frame</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>check</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut</span><span> buf</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Ok</span><span style=color:#eceff4>(</span><span>_</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>                // Frame::check set cursor position at end of frame.</span></span>
<span class=giallo-l><span style=color:#81a1c1>                let</span><span> len</span><span style=color:#81a1c1> =</span><span> buf</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>position</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> as</span><span style=color:#8fbcbb> usize</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>                // Reset the internal cursor for the call to parse.</span></span>
<span class=giallo-l><span>                buf</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>set_position</span><span style=color:#eceff4>(</span><span style=color:#b48ead>0</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>                // Parse the frame.</span></span>
<span class=giallo-l><span style=color:#81a1c1>                let</span><span> frame</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Frame</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>parse</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut</span><span> buf</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>                // Discard the frame from the buffer.</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span>buffer</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>advance</span><span style=color:#eceff4>(</span><span>len</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>                // Return the frame to the caller.</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Ok</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Some</span><span style=color:#eceff4>(</span><span>frame</span><span style=color:#eceff4>))</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#616e88>            // Not enough data has been buffered.</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Err</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Incomplete</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>None</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>            // An error was encountered.</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Err</span><span style=color:#eceff4>(</span><span>e</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#8fbcbb> Err</span><span style=color:#eceff4>(</span><span>e</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>()),</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span></code></pre><p><code>Connection</code>ã¯<code>TcpStream</code>ã¨frameã‚’parseã™ã‚‹ãŸã‚ã®bufferã‚’ä¿æŒã—ã¦ã„ã¾ã™ã€‚bufferã®å‹ã¨ã—ã¦<code>bytes::BytesMut</code>ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚<br> <code>impl&lt;W: AsyncWrite + AsyncRead> AsyncRead for BufWriter&lt;W></code>ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€<code>Connection.stream</code>ã¯<code>AsyncReader</code>ã¨ã—ã¦åˆ©ç”¨ã§ãã¾ã™ã€‚ <code>read_frame</code>ãŒå‘¼ã°ã‚Œã‚‹ã¨èª­ã¿è¾¼ã‚“ã bufferã‹ã‚‰FrameãŒç”Ÿæˆã§ãã‚Œã°Frameã‚’è¿”ã—bufferã‚’æ›´æ–°ã—ã¾ã™ã€‚Frameã‚’ç”Ÿæˆã™ã‚‹ã¾ã§ã®bufferãŒè¶³ã‚Šãªã‘ã‚Œã°tcp streamã‹ã‚‰readã—ã¾ã™ã€‚<br> ãªã«ã‹ã‚’parseã™ã‚‹éš›ã¯å…ˆèª­ã¿ã™ã‚‹ã“ã¨ãŒå¿…è¦ã¨ãªã‚‹ã“ã¨ãŒå¤šã„ã¨æ€ã„ã¾ã™ãŒã€ã“ã“ã§ã¯<code>std::io::Cursor</code>ã§wrapã—ã¦ã‹ã‚‰<code>Frame::check</code>ã«bufferã‚’æ¸¡ã™ã“ã¨ã§bufferã®positionã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ãªãparseå‡¦ç†ã‚’å§”è­²ã§ãã¦ã„ã¾ã™ã€‚<code>Cursor</code>ã®ã“ã®ã‚ˆã†ãªä½¿ã„æ–¹ã¯éå¸¸ã«å‚è€ƒã«ãªã‚Šã¾ã™ã€‚<h4 id=buffered-writes><a aria-label="Anchor link for: buffered-writes" class=zola-anchor href=#buffered-writes>buffered writes</a></h4><pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>    pub async fn</span><span style=color:#88c0d0> write_frame</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> frame</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Frame</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span> io</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        match</span><span> frame</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Frame</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Array</span><span style=color:#eceff4>(</span><span>val</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>                // Encode the frame type prefix. For an array, it is `*`.</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span>stream</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write_u8</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>b</span><span style=color:#eceff4>'</span><span style=color:#a3be8c>*</span><span style=color:#eceff4>')</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>                // Encode the length of the array.</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span style=color:#88c0d0>write_decimal</span><span style=color:#eceff4>(</span><span>val</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>len</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> as</span><span style=color:#8fbcbb> u64</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>                // Iterate and encode each entry in the array.</span></span>
<span class=giallo-l><span style=color:#81a1c1>                for</span><span> entry</span><span style=color:#81a1c1> in &**</span><span>val</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    self.</span><span style=color:#88c0d0>write_value</span><span style=color:#eceff4>(</span><span>entry</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span>            _</span><span style=color:#81a1c1> => self.</span><span style=color:#88c0d0>write_value</span><span style=color:#eceff4>(</span><span>frame</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>        // Ensure the encoded frame is written to the socket.</span></span>
<span class=giallo-l><span style=color:#616e88>        // The calls above are to the buffered stream and writes.</span></span>
<span class=giallo-l><span style=color:#616e88>        // Calling `flush` writes the remaining contents of the buffer to the socket.</span></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>stream</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>flush</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    async fn</span><span style=color:#88c0d0> write_value</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut self</span><span style=color:#eceff4>,</span><span> frame</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Frame</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> -></span><span> io</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        const</span><span> DELIMITER</span><span style=color:#81a1c1>: &</span><span style=color:#eceff4>[</span><span style=color:#8fbcbb>u8</span><span style=color:#eceff4>]</span><span style=color:#81a1c1> =</span><span style=color:#a3be8c> b</span><span style=color:#eceff4>"</span><span style=color:#ebcb8b>\r\n</span><span style=color:#eceff4>";</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        match</span><span> frame</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Frame</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Simple</span><span style=color:#eceff4>(</span><span>val</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span>stream</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write_u8</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>b</span><span style=color:#eceff4>'</span><span style=color:#a3be8c>+</span><span style=color:#eceff4>')</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span>stream</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write_all</span><span style=color:#eceff4>(</span><span>val</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_bytes</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span>stream</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write_all</span><span style=color:#eceff4>(</span><span>DELIMITER</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Frame</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Error</span><span style=color:#eceff4>(</span><span>val</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span>stream</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write_u8</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>b</span><span style=color:#eceff4>'</span><span style=color:#a3be8c>-</span><span style=color:#eceff4>')</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span>stream</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write_all</span><span style=color:#eceff4>(</span><span>val</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_bytes</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span>stream</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write_all</span><span style=color:#eceff4>(</span><span>DELIMITER</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Frame</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Integer</span><span style=color:#eceff4>(</span><span>val</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span>stream</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write_u8</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>b</span><span style=color:#eceff4>'</span><span style=color:#a3be8c>:</span><span style=color:#eceff4>')</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span style=color:#88c0d0>write_decimal</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>*</span><span>val</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Frame</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Null</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span>stream</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write_all</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>b</span><span style=color:#eceff4>"</span><span style=color:#a3be8c>$-1</span><span style=color:#ebcb8b>\r\n</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Frame</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Bulk</span><span style=color:#eceff4>(</span><span>val</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                let</span><span> len</span><span style=color:#81a1c1> =</span><span> val</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>len</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span>stream</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write_u8</span><span style=color:#eceff4>(</span><span style=color:#a3be8c>b</span><span style=color:#eceff4>'</span><span style=color:#a3be8c>$</span><span style=color:#eceff4>')</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span style=color:#88c0d0>write_decimal</span><span style=color:#eceff4>(</span><span>len</span><span style=color:#81a1c1> as</span><span style=color:#8fbcbb> u64</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span>stream</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write_all</span><span style=color:#eceff4>(</span><span>val</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>                self.</span><span>stream</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>write_all</span><span style=color:#eceff4>(</span><span>DELIMITER</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>            // Encoding an `Array` from within a value cannot be done using a</span></span>
<span class=giallo-l><span style=color:#616e88>            // recursive strategy. In general, async fns do not support</span></span>
<span class=giallo-l><span style=color:#616e88>            // recursion. Mini-redis has not needed to encode nested arrays yet,</span></span>
<span class=giallo-l><span style=color:#616e88>            // so for now it is skipped.</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Frame</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Array</span><span style=color:#eceff4>(</span><span>_val</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#88c0d0;font-weight:700> unimplemented!</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        self.</span><span>stream</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>flush</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        Ok</span><span style=color:#eceff4>(())</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span></code></pre><p>writeå‡¦ç†ã¯Redisã®protocolã«ã—ãŸãŒã£ã¦<code>Frame</code>ã‚’encodeã—ã¦æ›¸ãè¾¼ã‚“ã§ã„ãã¾ã™ã€‚<code>BytesMut</code>ã¯system callã®å›æ•°ã‚’æŠ‘ãˆã‚‹ãŸã‚ã«æ›¸ãè¾¼ã¿ã‚’bufferã™ã‚‹ã®ã§ã€æœ€å¾Œã«<code>flush</code>ã‚’å‘¼ã³ã¾ã™ã€‚ã“ã®ã‚ãŸã‚Šã¯åŒæœŸå‡¦ç†ã¨åŒã˜ã§ã™ã­ã€‚<br> APIã®è¨­è¨ˆä¸Š<code>Connection</code>ã®å‘¼ã³å‡ºã—å´ã«ã„ã¤<code>flush</code>ã™ã‚‹ã‹ã‚’åˆ¶å¾¡ã•ã›ã‚‹è¨­è¨ˆã‚‚ã‚ã‚Šãˆã‚‹ã¨è¨€åŠã•ã‚Œã¦ã„ã¾ã—ãŸã€‚<h2 id=async-in-depth><a aria-label="Anchor link for: async-in-depth" class=zola-anchor href=#async-in-depth>Async in depth</a></h2><p>ã“ã“ã¾ã§ã§asyncã¨tokioã®ä¸€é€šã‚Šã®æ©Ÿèƒ½ã«è§¦ã‚ŒãŸã®ã§futureã«ã¤ã„ã¦ã‚‚ã†å°‘ã—è¦‹ã¦ã„ãã¾ã™ã€‚<br> ã¾ãšæŒ‡å®šã•ã‚ŒãŸæœŸé–“ãŒçµŒéã—ãŸã‚‰stdoutã«æŒ¨æ‹¶ã‚’è¡¨ç¤ºã™ã‚‹futureã‚’å®Ÿè£…ã—ã¦ã¿ã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>future</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Future</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>pin</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Pin</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>task</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>Context</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Poll</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>time</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>Duration</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Instant</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> Delay</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    when</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Instant</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Future</span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> Delay</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Output</span><span style=color:#81a1c1> = &</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>static str</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> poll</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self:</span><span style=color:#8fbcbb> Pin</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>&mut Self</span><span style=color:#eceff4>>,</span><span> cx</span><span style=color:#81a1c1>: &mut</span><span style=color:#8fbcbb> Context</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>        -></span><span style=color:#8fbcbb> Poll</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>&</span><span style=color:#eceff4>'</span><span style=color:#8fbcbb>static str</span><span style=color:#eceff4>></span></span>
<span class=giallo-l><span style=color:#eceff4>    {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if</span><span style=color:#8fbcbb> Instant</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>now</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> >= self.</span><span>when </span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>            println!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Hello world</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Poll</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Ready</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>done</span><span style=color:#eceff4>")</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>            // Ignore this line for now.</span></span>
<span class=giallo-l><span>            cx</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>waker</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>wake_by_ref</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Poll</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Pending</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[tokio::main]</span></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> when</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Instant</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>now</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> +</span><span style=color:#8fbcbb> Duration</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_millis</span><span style=color:#eceff4>(</span><span style=color:#b48ead>10</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> future</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Delay</span><span style=color:#eceff4> {</span><span> when</span><span style=color:#eceff4> };</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> out</span><span style=color:#81a1c1> =</span><span> future</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    assert_eq!</span><span style=color:#eceff4>(</span><span>out</span><span style=color:#eceff4>, "</span><span style=color:#a3be8c>done</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã“ã®ã‚³ãƒ¼ãƒ‰ã¯ã“ã‚“ãªæ„Ÿã˜ã«å±•é–‹ã•ã‚Œã‚‹ãã†ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>future</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Future</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>pin</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Pin</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>task</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>Context</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Poll</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>time</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>Duration</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Instant</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>enum</span><span style=color:#8fbcbb> MainFuture</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>    // Initialized, never polled</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    State0</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#616e88>    // Waiting on `Delay`, i.e. the `future.await` line.</span></span>
<span class=giallo-l><span style=color:#88c0d0>    State1</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Delay</span><span style=color:#eceff4>),</span></span>
<span class=giallo-l><span style=color:#616e88>    // The future has completed.</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    Terminated</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Future</span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> MainFuture</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Output</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> ();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> poll</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>mut self:</span><span style=color:#8fbcbb> Pin</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>&mut Self</span><span style=color:#eceff4>>,</span><span> cx</span><span style=color:#81a1c1>: &mut</span><span style=color:#8fbcbb> Context</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>        -></span><span style=color:#8fbcbb> Poll</span><span style=color:#eceff4>&lt;()></span></span>
<span class=giallo-l><span style=color:#eceff4>    {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        use</span><span> MainFuture</span><span style=color:#81a1c1>::*</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        loop</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            match *self</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                State0</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    let</span><span> when</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Instant</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>now</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> +</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                        Duration</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_millis</span><span style=color:#eceff4>(</span><span style=color:#b48ead>10</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    let</span><span> future</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Delay</span><span style=color:#eceff4> {</span><span> when</span><span style=color:#eceff4> };</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    *self =</span><span style=color:#88c0d0> State1</span><span style=color:#eceff4>(</span><span>future</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#88c0d0>                State1</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>ref mut</span><span> my_future</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                    match</span><span style=color:#8fbcbb> Pin</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>my_future</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>poll</span><span style=color:#eceff4>(</span><span>cx</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                        Poll</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Ready</span><span style=color:#eceff4>(</span><span>out</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>                            assert_eq!</span><span style=color:#eceff4>(</span><span>out</span><span style=color:#eceff4>, "</span><span style=color:#a3be8c>done</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#81a1c1>                            *self =</span><span style=color:#8fbcbb> Terminated</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>                            return</span><span style=color:#8fbcbb> Poll</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Ready</span><span style=color:#eceff4>(());</span></span>
<span class=giallo-l><span style=color:#eceff4>                        }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                        Poll</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Pending</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                            return</span><span style=color:#8fbcbb> Poll</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Pending</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>                        }</span></span>
<span class=giallo-l><span style=color:#eceff4>                    }</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#8fbcbb>                Terminated</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>                    panic!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>future polled after completion</span><span style=color:#eceff4>")</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’ã¿ã¦<code>.await</code>ã®æŒ™å‹•ã ã£ãŸã‚Šã€<code>.await</code>ã¾ãŸãã¨ãã®åˆ¶ç´„ã ã£ãŸã‚ŠãŒã„ã‚ã„ã‚è…¹è½ã¡ã—ã¾ã—ãŸã€‚futureã¯state machinesã ã€ã¿ãŸã„ãªè¨˜è¿°ã¯ã“ã®ã“ã¨ã‚’è¨€ã‚ã‚“ã¨ã—ã¦ã„ãŸã‚“ã§ã™ã­ã€‚<br> async blockå†…ã§<code>.await</code>ã‚’ä½¿ã†ãŸã³ã«<code>enum</code>ã§å®šç¾©ã•ã‚ŒãŸStateãŒå¢—ãˆã¦ã„ãã“ã¨ã«ãªã‚‹ã‚“ã§ã™ã­ã€‚"zero cost abstractions"ã¯ã ã¦ã˜ã‚ƒãªã„ã€‚<h3 id=mini-tokio-executor><a aria-label="Anchor link for: mini-tokio-executor" class=zola-anchor href=#mini-tokio-executor>Mini Tokio Executor</a></h3><p>async block/fnãŒ<code>poll</code>ã«å¤‰æ›ã•ã‚Œã‚‹ã¨ã„ã†ã“ã¨ã¯èª°ã‹ãŒã“ã®<code>poll</code>ã‚’å‘¼ã³å‡ºã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãã‚ŒãŒtokio(runtime)ãŒæä¾›ã—ã¦ã„ã‚‹executorã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> crossbeam</span><span style=color:#81a1c1>::</span><span>channel</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> futures</span><span style=color:#81a1c1>::</span><span>task</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#81a1c1>self</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> ArcWake</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>cell</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>RefCell</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>future</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Future</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>pin</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Pin</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>sync</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>Arc</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Mutex</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>task</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>Context</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Poll</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Waker</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>thread</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> std</span><span style=color:#81a1c1>::</span><span>time</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span style=color:#8fbcbb>Duration</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> Instant</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> mini_tokio</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> MiniTokio</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    // Spawn root task.</span></span>
<span class=giallo-l><span style=color:#616e88>    // No work happens until `mini_tokio.run()` is called.</span></span>
<span class=giallo-l><span>    mini_tokio</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>spawn</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>async</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0>        spawn</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>async</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            Delay</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>with</span><span style=color:#eceff4>(</span><span>Duration</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_millis</span><span style=color:#eceff4>(</span><span style=color:#b48ead>100</span><span style=color:#eceff4>))</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>            println!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>world</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#eceff4>        });</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>        spawn</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>async</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>            println!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>hello</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#eceff4>        });</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        Delay</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>with</span><span style=color:#eceff4>(</span><span>Duration</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_millis</span><span style=color:#eceff4>(</span><span style=color:#b48ead>200</span><span style=color:#eceff4>))</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span>        std</span><span style=color:#81a1c1>::</span><span>process</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>exit</span><span style=color:#eceff4>(</span><span style=color:#b48ead>0</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>    });</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>    mini_tokio</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>run</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> MiniTokio</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>    // Receives scheduled tasks. When a task is scheduled, the associated future is ready to make progress.</span></span>
<span class=giallo-l><span style=color:#616e88>    // This usually happens when a resource the task uses becomes ready to perform an operation.</span></span>
<span class=giallo-l><span style=color:#616e88>    // For example, a socket received data and read call will succeed.</span></span>
<span class=giallo-l><span>    scheduled</span><span style=color:#81a1c1>:</span><span> channel</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Receiver</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Arc</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Task</span><span style=color:#eceff4>>>,</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    // Send half ot the scheduled channel.</span></span>
<span class=giallo-l><span>    sender</span><span style=color:#81a1c1>:</span><span> channel</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Sender</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Arc</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Task</span><span style=color:#eceff4>>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> MiniTokio</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> new</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> MiniTokio</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span style=color:#eceff4> (</span><span>sender</span><span style=color:#eceff4>,</span><span> scheduled</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> channel</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>unbounded</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>        MiniTokio</span><span style=color:#eceff4> {</span><span> scheduled</span><span style=color:#eceff4>,</span><span> sender</span><span style=color:#eceff4> }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> spawn</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>F</span><span style=color:#eceff4>>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>,</span><span> future</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> F</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>    where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        F</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Future</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Output</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> ()></span><span style=color:#81a1c1> +</span><span style=color:#8fbcbb> Send</span><span style=color:#81a1c1> +</span><span style=color:#eceff4> '</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        Task</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>spawn</span><span style=color:#eceff4>(</span><span>future</span><span style=color:#eceff4>,</span><span style=color:#81a1c1> &self.</span><span>sender</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> run</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&self</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span>        CURRENT</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>with</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>cell</span><span style=color:#81a1c1>|</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            *</span><span>cell</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>borrow_mut</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span>sender</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#eceff4>        });</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        while let</span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>(</span><span>task</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> = self.</span><span>scheduled</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>recv</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span>            task</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>poll</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>pub fn</span><span style=color:#88c0d0> spawn</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>F</span><span style=color:#eceff4>>(</span><span>future</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> F</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>    F</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Future</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Output</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> ()></span><span style=color:#81a1c1> +</span><span style=color:#8fbcbb> Send</span><span style=color:#81a1c1> +</span><span style=color:#eceff4> '</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span>    CURRENT</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>with</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>cell</span><span style=color:#81a1c1>|</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> borrow</span><span style=color:#81a1c1> =</span><span> cell</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>borrow</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> sender</span><span style=color:#81a1c1> =</span><span> borrow</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_ref</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span>        Task</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>spawn</span><span style=color:#eceff4>(</span><span>future</span><span style=color:#eceff4>,</span><span> sender</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>    });</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> Delay</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>    // When to complete the delay.</span></span>
<span class=giallo-l><span>    when</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Instant</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#616e88>    // The waker to notify once the delay has completed.</span></span>
<span class=giallo-l><span style=color:#616e88>    // The waker must be accessible by both the timer thread and future so it is wrapped with `Arc&lt;Mutex>>`</span></span>
<span class=giallo-l><span>    waker</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Option</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Arc</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Mutex</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Waker</span><span style=color:#eceff4>>>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Future</span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> Delay</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    type</span><span style=color:#8fbcbb> Output</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> ();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> poll</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>mut self:</span><span style=color:#8fbcbb> Pin</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>&mut Self</span><span style=color:#eceff4>>,</span><span> cx</span><span style=color:#81a1c1>: &mut</span><span style=color:#8fbcbb> Context</span><span style=color:#eceff4>&lt;'</span><span style=color:#8fbcbb>_</span><span style=color:#eceff4>>)</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Poll</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span style=color:#616e88>        // First, if this is the first time the future is called, spawn the timer thread.</span></span>
<span class=giallo-l><span style=color:#616e88>        // If the timer thread is already running, ensure the stored `Waker` matches the current task's waker.</span></span>
<span class=giallo-l><span style=color:#81a1c1>        if let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>waker</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> = &self.</span><span>waker </span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let mut</span><span> waker</span><span style=color:#81a1c1> =</span><span> waker</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>lock</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>            // Check if the stored waker matches the current tasks' waker.</span></span>
<span class=giallo-l><span style=color:#81a1c1>            if !</span><span>waker</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>will_wake</span><span style=color:#eceff4>(</span><span>cx</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>waker</span><span style=color:#eceff4>()) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                *</span><span>waker</span><span style=color:#81a1c1> =</span><span> cx</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>waker</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let</span><span> when</span><span style=color:#81a1c1> = self.</span><span>when</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>            let</span><span> waker</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Arc</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>Mutex</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>cx</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>waker</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>()));</span></span>
<span class=giallo-l><span style=color:#81a1c1>            self.</span><span>waker </span><span style=color:#81a1c1>=</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>waker</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>            // This is the first time `poll` is called, spawn the timer thread.</span></span>
<span class=giallo-l><span>            thread</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>spawn</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>move ||</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                let</span><span> now</span><span style=color:#81a1c1> =</span><span> Instant</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>now</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>                if</span><span> now</span><span style=color:#81a1c1> &lt;</span><span> when</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>                    thread</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>sleep</span><span style=color:#eceff4>(</span><span>when</span><span style=color:#81a1c1> -</span><span> now</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>                }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>                let</span><span> waker</span><span style=color:#81a1c1> =</span><span> waker</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>lock</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span>                waker</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>wake_by_ref</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#eceff4>            });</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        if</span><span style=color:#8fbcbb> Instant</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>now</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> >= self.</span><span>when </span><span style=color:#eceff4>{</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Poll</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>Ready</span><span style=color:#eceff4>(())</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span><span style=color:#81a1c1> else</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#616e88>            // The duration has not elapsed, the future has not completed so return `Poll::Pending`.</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Poll</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Pending</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Delay</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    async fn</span><span style=color:#88c0d0> with</span><span style=color:#eceff4>(</span><span>dur</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Duration</span><span style=color:#eceff4>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> future</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Delay</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            when</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Instant</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>now</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> +</span><span> dur</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            waker</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> None</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>        };</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>        future</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>thread_local!</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    static</span><span> CURRENT</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> RefCell</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Option</span><span style=color:#eceff4>&lt;</span><span>channel</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Sender</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Arc</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Task</span><span style=color:#eceff4>>>>></span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> RefCell</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>None</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>struct</span><span style=color:#8fbcbb> Task</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>    future</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Mutex</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Pin</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Box</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>dyn</span><span style=color:#8fbcbb> Future</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Output</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> ()></span><span style=color:#81a1c1> +</span><span style=color:#8fbcbb> Send</span><span style=color:#eceff4>>>>,</span></span>
<span class=giallo-l><span>    executor</span><span style=color:#81a1c1>:</span><span> channel</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Sender</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Arc</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Task</span><span style=color:#eceff4>>>,</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> Task</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> spawn</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>F</span><span style=color:#eceff4>>(</span><span>future</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> F</span><span style=color:#eceff4>,</span><span> sender</span><span style=color:#81a1c1>: &</span><span>channel</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Sender</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Arc</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Task</span><span style=color:#eceff4>>>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>    where</span></span>
<span class=giallo-l><span style=color:#8fbcbb>        F</span><span style=color:#81a1c1>:</span><span style=color:#8fbcbb> Future</span><span style=color:#eceff4>&lt;</span><span style=color:#8fbcbb>Output</span><span style=color:#81a1c1> =</span><span style=color:#eceff4> ()></span><span style=color:#81a1c1> +</span><span style=color:#8fbcbb> Send</span><span style=color:#81a1c1> +</span><span style=color:#eceff4> '</span><span style=color:#8fbcbb>static</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>    {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> task</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Arc</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span style=color:#8fbcbb>Task</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>            future</span><span style=color:#81a1c1>:</span><span> Mutex</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>new</span><span style=color:#eceff4>(</span><span>Box</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>pin</span><span style=color:#eceff4>(</span><span>future</span><span style=color:#eceff4>)),</span></span>
<span class=giallo-l><span>            executor</span><span style=color:#81a1c1>:</span><span> sender</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>(),</span></span>
<span class=giallo-l><span style=color:#eceff4>        });</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>        sender</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>send</span><span style=color:#eceff4>(</span><span>task</span><span style=color:#eceff4>)</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#616e88>        //let _ = sender.send(task);</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> poll</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self:</span><span style=color:#8fbcbb> Arc</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>Self</span><span style=color:#eceff4>>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> waker</span><span style=color:#81a1c1> =</span><span> task</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>waker</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>self.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> cx</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> Context</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>from_waker</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&</span><span>waker</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        let mut</span><span> future</span><span style=color:#81a1c1> = self.</span><span>future</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>try_lock</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> _</span><span style=color:#81a1c1> =</span><span> future</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_mut</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>poll</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut</span><span> cx</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>impl</span><span style=color:#8fbcbb> ArcWake</span><span style=color:#81a1c1> for</span><span style=color:#8fbcbb> Task</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    fn</span><span style=color:#88c0d0> wake_by_ref</span><span style=color:#eceff4>(</span><span>arc_self</span><span style=color:#81a1c1>: &</span><span style=color:#8fbcbb>Arc</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>Self</span><span style=color:#eceff4>>) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> _</span><span style=color:#81a1c1> =</span><span> arc_self</span><span style=color:#81a1c1>.</span><span>executor</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>send</span><span style=color:#eceff4>(</span><span>arc_self</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>clone</span><span style=color:#eceff4>());</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>executorã¨ã—ã¦<code>MiniTokio</code>ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚<code>MiniTokio::spawn</code>ã§æ¸¡ã•ã‚ŒãŸfutureã‚’<code>Task</code>ã§wrapã—ã¦channelã®Senderã‚’cloneã—ã¦ä¿æŒã•ã›ã¦ã„ã¾ã™ã€‚<br> <code>Delay</code>ã®futureå®Ÿè£…ã§ã¯åˆ¥threadã‚’èµ·å‹•ã—ã¦æŒ‡å®šæœŸé–“çµŒéå¾Œã«wakerã‚’wakeã—ã¾ã™ã€‚<br> <code>futures::task::ArcWake</code> traitã‚’å®Ÿè£…ã—ã¦ã‚ã‚‹ã¨ã€<code>impl ArcWake</code> -> <code>Waker</code> -> <code>Context</code>ã¨ä½œæˆã§ãVTableã‚’è‡ªåˆ†ã§ä½œã‚‰ãªãã¦ã‚‚<code>poll</code>ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã‚ˆã†ã§ã™ã€‚<br> ã“ã®å®Ÿè£…ã§ã¯<code>wake_ by_ref</code>ã§ã¯å˜ç´”ã«è‡ªåˆ†ã‚’å†åº¦channelã«sendã—ã¦executorã®<code>poll</code>å¯¾è±¡ã«ãªã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚<br> ã‚‚ã®ã™ã”ãç°¡æ˜“çš„ãªå®Ÿè£…ã ã¨æ€ã„ã¾ã™ãŒExecutorã®é›°å›²æ°—ã¯ã¤ã‹ã‚ãŸã‚ˆã†ãªæ°—ãŒã—ã¾ã™ã€‚ tokioã®<code>Runtime::block_on</code>ã®å®Ÿè£…ã‚’ãŠã£ã¦ã¿ãŸã¨ã“ã‚ã¾ã£ãŸãã‚ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸãŒ(ç‰¹ã«parkã®æ¦‚å¿µ)ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ç¢ºã‹ã«futureã‚’<code>poll</code>ã—ã¦ã„ã‚‹loopãŒã‚ã‚Šã¾ã—ãŸã€‚<br> https://github.com/tokio-rs/tokio/blob/c30ce1f65c5befb2a4b48eb4c16b7da3c0eafbd1/tokio/src/park/thread.rs#L263<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>loop</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>            if let</span><span style=color:#88c0d0> Ready</span><span style=color:#eceff4>(</span><span>v</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> = crate::</span><span>coop</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>budget</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>||</span><span> f</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>as_mut</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>poll</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>&mut</span><span> cx</span><span style=color:#eceff4>)) {</span></span>
<span class=giallo-l><span style=color:#81a1c1>                return</span><span style=color:#8fbcbb> Ok</span><span style=color:#eceff4>(</span><span>v</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>            }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>            self.</span><span style=color:#88c0d0>park</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><h2 id=select><a aria-label="Anchor link for: select" class=zola-anchor href=#select>Select</a></h2><p><code>tokio::spawn</code>ãŒgoroutineã®ç”Ÿæˆã«å¯¾å¿œã™ã‚‹ãªã‚‰goã£ã½ãæ›¸ã‘ã‚‹ã‚“ã˜ã‚ƒã¨æ€ã£ã¦ã„ã¾ã—ãŸãŒãã®ãŸã‚ã«ã¯ã²ã¨ã¤é‡è¦ãªäºˆç´„èªãŒãŸã‚Šã¾ã›ã‚“ã€‚ãã†<code>select</code>ã§ã™ã€‚<br> ã“ã‚ŒãŒãªã„ã¨æœ€åˆã®ã‚·ã‚°ãƒŠãƒ«ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒãã‚‚ãã‚‚æ›¸ã‘ãªã„ã§ã™ã€‚(éƒ½åº¦ãƒã‚§ãƒƒã‚¯ã™ã‚‹ä»¥å¤–)<br> ã¨ã„ã†ã“ã¨ã§ã€<code>tokio::select!</code>ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚ãƒã‚¯ãƒ­ãªã®ã¯ã—ã‚‡ã†ãŒãªã„ã§ã™ã€‚(cargo expandã™ã‚‹ã¨formatã•ã‚Œã¦ã„ãªã„ã‚³ãƒ¼ãƒ‰ãŒå‡ºåŠ›ã•ã‚Œã¦ã—ã¾ã£ãŸã®ã§è¼‰ã›ã‚‹ã®ã¯ã‚ãã‚‰ã‚ã¾ã—ãŸ)<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> tokio</span><span style=color:#81a1c1>::</span><span>sync</span><span style=color:#81a1c1>::</span><span>oneshot</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[tokio::main]</span></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span style=color:#eceff4> (</span><span>tx1</span><span style=color:#eceff4>,</span><span> rx1</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> oneshot</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>channel</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span style=color:#eceff4> (</span><span>tx2</span><span style=color:#eceff4>,</span><span> rx2</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> oneshot</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>channel</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>    tokio</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>spawn</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>async</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> _</span><span style=color:#81a1c1> =</span><span> tx1</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>send</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>one</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#eceff4>    });</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>    tokio</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>spawn</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>async</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>        let</span><span> _</span><span style=color:#81a1c1> =</span><span> tx2</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>send</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>two</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#eceff4>    });</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>    tokio</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0;font-weight:700>select!</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>        val</span><span style=color:#81a1c1> =</span><span> rx1</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>            println!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>rx1 completed first with </span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>:?</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>",</span><span> val</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span>        val</span><span style=color:#81a1c1> =</span><span> rx2</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>            println!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>rx2 completed first with </span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>:?</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>",</span><span> val</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ãµãŸã¤ã®channelã®çµæœã‚’å¾…æ©Ÿã™ã‚‹ã‚³ãƒ¼ãƒ‰ã¯ã“ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=plain><span class=giallo-l><span>&lt;pattern> = &lt;async expression> => &lt;handler>,</span></span></code></pre><p><code>select!</code>ã®syntaxã¯ã“ã®ã‚ˆã†ã«è¡¨ã•ã‚Œã¾ã™ã€‚<br> ã™ã¹ã¦ã®<code>&lt;async expression></code>ã¯ã²ã¨ã¤ã«ã¾ã¨ã‚ã‚‰ã‚Œã¦concurrentã«å®Ÿè¡Œã•ã‚Œã€ã‚ã‚‹expressionã®å®Ÿè¡ŒãŒå®Œäº†ã—ã¦ã€çµæœãŒ<code>&lt;pattern></code>ã«ãƒãƒƒãƒã™ã‚‹ã¨<code>&lt;handler></code>ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚<br> çµæœçš„ã«å®Ÿè¡Œã•ã‚Œã‚‹<code>&lt;handler></code>ã¯å¿…ãšã²ã¨ã¤ã®branchã§ã™ã€‚<br> ã¾ãŸã€<code>&lt;async expression></code>ã¯åŒã˜taskã¨ã—ã¦å®Ÿè¡Œã•ã‚Œã‚‹ã®ã§åŒæ™‚ã«å®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã¯ãªã„(ã¯ãš)ã§ã™ã€‚(taskå†…concurrency)<br> ã“ã®ã‚ãŸã‚Šã®ä»•æ§˜ã¯Rustã®borrow checkerã«å½±éŸ¿ã—ã¦ãã¾ã™ã€‚(handlerã§ã¯mutable borrowã‚’ã¨ã‚Œã‚‹)<br> ã“ã‚Œã§signalã®ã‚ˆã†ãªçµ‚äº†å‡¦ç†ã‚’ä¼æ’­ã•ã›ã‚‹ã‚ˆã†ãªå‡¦ç†ã‚‚ã‹ã‘ãã†ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> tokio</span><span style=color:#81a1c1>::</span><span>net</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>TcpStream</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> tokio</span><span style=color:#81a1c1>::</span><span>sync</span><span style=color:#81a1c1>::</span><span>oneshot</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[tokio::main]</span></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>() {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span style=color:#eceff4> (</span><span>tx</span><span style=color:#eceff4>,</span><span> rx</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> oneshot</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>channel</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    // Spawn a task that sends a message over the oneshot</span></span>
<span class=giallo-l><span>    tokio</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>spawn</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>async move</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>        tx</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>send</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>done</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>unwrap</span><span style=color:#eceff4>();</span></span>
<span class=giallo-l><span style=color:#eceff4>    });</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>    tokio</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0;font-weight:700>select!</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>        socket</span><span style=color:#81a1c1> =</span><span style=color:#8fbcbb> TcpStream</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>connect</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>localhost:3465</span><span style=color:#eceff4>")</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>            println!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>Socket connected </span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>:?</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>",</span><span> socket</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span>        msg</span><span style=color:#81a1c1> =</span><span> rx</span><span style=color:#81a1c1> =></span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>            println!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>received message first </span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>:?</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>",</span><span> msg</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>        }</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p>ãŸã ã—tokioã®<a href=https://docs.rs/tokio/0.3.1/tokio/signal/index.html rel=external>signal API</a>ã‚’ã¿ã¦ã¿ã‚‹ã¨signalã®ç¨®é¡ã”ã¨ã«futureã‚’ç”Ÿæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šãã†ãªã®ã§è¤‡æ•°ç¨®é¡ã®signalå‡¦ç†ã‚’æ›¸ãå ´åˆã¯ãã‚Œãã‚Œç”Ÿæˆã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šãã†ã§ã™ã€‚<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> tokio</span><span style=color:#81a1c1>::</span><span>signal</span><span style=color:#81a1c1>::</span><span>unix</span><span style=color:#81a1c1>::</span><span style=color:#eceff4>{</span><span>signal</span><span style=color:#eceff4>,</span><span style=color:#8fbcbb> SignalKind</span><span style=color:#eceff4>};</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[tokio::main]</span></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span style=color:#8fbcbb> Result</span><span style=color:#eceff4>&lt;(),</span><span style=color:#8fbcbb> Box</span><span style=color:#eceff4>&lt;</span><span style=color:#81a1c1>dyn</span><span> std</span><span style=color:#81a1c1>::</span><span>error</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Error</span><span style=color:#eceff4>>> {</span></span>
<span class=giallo-l><span style=color:#616e88>    // An infinite stream of hangup signals.</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> stream</span><span style=color:#81a1c1> =</span><span style=color:#88c0d0> signal</span><span style=color:#eceff4>(</span><span>SignalKind</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>hangup</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#616e88>    // Print whenever a HUP signal is received</span></span>
<span class=giallo-l><span style=color:#81a1c1>    loop</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span>        stream</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>recv</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>        println!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>got signal HUP</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><h2 id=streams><a aria-label="Anchor link for: streams" class=zola-anchor href=#streams>Streams</a></h2><p>é§†ã‘è¶³ã§tutorialã®å„é …ç›®ã‚’ã•ã‚‰ã£ã¦ãã¾ã—ãŸãŒæœ€å¾Œã¯Streamã§ã™ã€‚<br> <code>Future&lt;Output = T></code>ãŒasyncãª<code>T</code>ã ã¨ã—ãŸã‚‰<code>Stream&lt;Item = T></code>ã¯asyncãª<code>Iterator&lt;Item = T></code>ã¨ã„ã†é–¢ä¿‚ã®ã‚ˆã†ã§ã™ã€‚(https://docs.rs/futures-core/0.3.6/futures_core/stream/trait.Stream.html)<br> I/Oã¨åŒæ§˜ã«<code>futures_core::stream::Stream</code>ã¯<code>poll_next</code>ã—ã‹å®šç¾©ã—ã¦ãŠã‚‰ãšã€iteratorã®ã‚ˆã†ãªå„ç¨®APIã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯<code>tokio::stream::StreamExt</code>ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚ redisã®pub/subã£ã½ã„ã“ã¨ã‚’ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚(<code>mini-redis-server</code>ã‚’èµ·å‹•ã—ã¦ãŠãã¾ã™)<pre class=giallo style=color:#d8dee9;background-color:#2e3440><code data-lang=rust><span class=giallo-l><span style=color:#81a1c1>use</span><span> mini_redis</span><span style=color:#81a1c1>::</span><span>client</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>use</span><span> tokio</span><span style=color:#81a1c1>::</span><span>stream</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>StreamExt</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> publish</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span> mini_redis</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let mut</span><span> client</span><span style=color:#81a1c1> =</span><span> client</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>connect</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>127.0.0.1:6379</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>    client</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>publish</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>numbers</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>1</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span>    client</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>publish</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>numbers</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>two</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span>    client</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>publish</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>numbers</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>3</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span>    client</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>publish</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>numbers</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>four</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span>    client</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>publish</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>numbers</span><span style=color:#eceff4>", "</span><span style=color:#a3be8c>5</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>into</span><span style=color:#eceff4>())</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>    Ok</span><span style=color:#eceff4>(())</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> subscribe</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span> mini_redis</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> client</span><span style=color:#81a1c1> =</span><span> client</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>connect</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>127.0.0.1:6379</span><span style=color:#eceff4>")</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> subscriber</span><span style=color:#81a1c1> =</span><span> client</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>subscribe</span><span style=color:#eceff4>(</span><span style=color:#88c0d0;font-weight:700>vec!</span><span style=color:#eceff4>["</span><span style=color:#a3be8c>numbers</span><span style=color:#eceff4>"</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>to_owned</span><span style=color:#eceff4>()])</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l><span style=color:#81a1c1>    let</span><span> messages</span><span style=color:#81a1c1> =</span><span> subscriber</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>into_stream</span><span style=color:#eceff4>()</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>filter</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>|</span><span>msg</span><span style=color:#81a1c1>| match</span><span> msg</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#8fbcbb>            Ok</span><span style=color:#eceff4>(</span><span>msg</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> if</span><span> msg</span><span style=color:#81a1c1>.</span><span>content</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>len</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> ==</span><span style=color:#b48ead> 1</span><span style=color:#81a1c1> => true</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span>            _</span><span style=color:#81a1c1> => false</span><span style=color:#eceff4>,</span></span>
<span class=giallo-l><span style=color:#eceff4>        })</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>map</span><span style=color:#eceff4>(</span><span>std</span><span style=color:#81a1c1>::</span><span>result</span><span style=color:#81a1c1>::</span><span>Result</span><span style=color:#81a1c1>::</span><span>unwrap</span><span style=color:#eceff4>)</span></span>
<span class=giallo-l><span style=color:#81a1c1>        .</span><span style=color:#88c0d0>take</span><span style=color:#eceff4>(</span><span style=color:#b48ead>3</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span>    tokio</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0;font-weight:700>pin!</span><span style=color:#eceff4>(</span><span>messages</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#81a1c1>    while let</span><span style=color:#8fbcbb> Some</span><span style=color:#eceff4>(</span><span>msg</span><span style=color:#eceff4>)</span><span style=color:#81a1c1> =</span><span> messages</span><span style=color:#81a1c1>.</span><span style=color:#88c0d0>next</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4> {</span></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>        println!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>got = </span><span style=color:#ebcb8b>{</span><span style=color:#a3be8c>:?</span><span style=color:#ebcb8b>}</span><span style=color:#eceff4>",</span><span> msg</span><span style=color:#eceff4>);</span></span>
<span class=giallo-l><span style=color:#eceff4>    }</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>    Ok</span><span style=color:#eceff4>(())</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#5e81ac>#[tokio::main]</span></span>
<span class=giallo-l><span style=color:#81a1c1>async fn</span><span style=color:#88c0d0> main</span><span style=color:#eceff4>()</span><span style=color:#81a1c1> -></span><span> mini_redis</span><span style=color:#81a1c1>::</span><span style=color:#8fbcbb>Result</span><span style=color:#eceff4>&lt;()> {</span></span>
<span class=giallo-l><span>    tokio</span><span style=color:#81a1c1>::</span><span style=color:#88c0d0>spawn</span><span style=color:#eceff4>(</span><span style=color:#81a1c1>async</span><span style=color:#eceff4> {</span><span style=color:#88c0d0> publish</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await</span><span style=color:#eceff4> });</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0>    subscribe</span><span style=color:#eceff4>()</span><span style=color:#81a1c1>.await?</span><span style=color:#eceff4>;</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#88c0d0;font-weight:700>    println!</span><span style=color:#eceff4>("</span><span style=color:#a3be8c>DONE</span><span style=color:#eceff4>");</span></span>
<span class=giallo-l></span>
<span class=giallo-l><span style=color:#8fbcbb>    Ok</span><span style=color:#eceff4>(())</span></span>
<span class=giallo-l><span style=color:#eceff4>}</span></span></code></pre><p><code>subscriber.into_stream</code>ã§subscriberã‚’consumeã—ãŸã‚ã¨ã€<code>StreamExt</code>ã‚’åˆ©ç”¨ã—ã¦adaptorå‡¦ç†ã‚’è¿½åŠ ã—ã¦ã„ã¾ã™ã€‚ã“ã®ã‚ãŸã‚Šã®ä½¿ç”¨æ„Ÿã¯iteratorã¨åŒã˜ã§ã™ã­ã€‚<br> æ³¨æ„ãŒå¿…è¦ãªã®ã¯<code>next</code>ã‚’å‘¼ã¶å‰ã«<code>tokio::pin!</code>ã¨ã„ã†è¦‹æ…£ã‚Œãªã„ãƒã‚¯ãƒ­ã‚’ã‚ˆã‚“ã§ã„ã‚‹ã“ã¨ã§ã™ã€‚<br> <code>next</code>ã‚’å‘¼ã¶ãŸã‚ã«ã¯streamãŒ<code>pinned</code>ã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã€<code>into_stream</code>ã¯<code>pin</code>ã•ã‚Œã¦ã„ãªã„<code>Stream</code>ã‚’è¿”ã—ã¦ã„ã¾ã™ã€‚ã“ã®<code>tokio::pin!</code>ã‚’å¿˜ã‚Œã‚‹ã¨ã‚‚ã®ã™ã”ã„ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã¨ã‚‚ã«ã€<code>pin</code>ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã¨ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãƒ¼ã‹ã‚‰æ³¨æ„ã—ã¦ã‚‚ã‚‰ãˆã¾ã™ã€‚(<code>.... cannot be unpined</code>)<p><code>pin</code>ã«ã¤ã„ã¦ã¯<a href=https://rust-lang.github.io/async-book/04_pinning/01_chapter.html rel=external>async book</a>ã‚„<a href=https://tech-blog.optim.co.jp/entry/2020/03/05/160000 rel=external>OPTiMã•ã‚“ã®Pinãƒãƒ§ãƒƒãƒˆãƒ¯ã‚«ãƒ«</a>ã‚’å‚è€ƒã«ã•ã›ã¦ã„ãŸã ãã¾ã—ãŸã€‚<br> è‡ªåˆ†ã®ç†è§£ã§ã¯<code>Pin&lt;T></code>ã¨ã—ã¦ãŠãã¨ãƒ¡ãƒ¢ãƒªä¸Šã§å‹•ã‹ã—ã¦ã¯ã„ã‘ãªã„å‹(Futureã‚’å®Ÿè£…ã—ãŸstruct)ãŒ<code>&mut self</code>ã‚’ã¨ã‚Œãªããªã‚Šçµæœçš„ã«<code>std::mem::replace</code>ç­‰ãŒä½¿ãˆãªããªã‚Šå®‰å…¨ã«ãªã‚‹ã¨ã„ã†æ„Ÿã˜ã§ã™ã€‚<br> ãªãœFutureã®å®Ÿè£…ã‚’ãƒ¡ãƒ¢ãƒªã‹ã‚‰å‹•ã‹ã›ãªã„ã‹ã¨ã„ã†ã¨<code>.await</code>ã‚’ã¾ãŸã„ãŸå¤‰æ•°ã¯structã®fieldã«å¤‰æ›ã•ã‚Œã‚‹ã‹ã‚‰ã¨ã†ã„ã“ã¨ã§ã—ã‚‡ã†ã‹ã€‚<h2 id=zhong-warini><a aria-label="Anchor link for: zhong-warini" class=zola-anchor href=#zhong-warini>çµ‚ã‚ã‚Šã«</a></h2><p>tokio tutorialã‚’å†™ã—ãªãŒã‚‰å‹•ã‹ã—ã¦ã„ã£ã¦ã ã„ã¶async/tokioã®APIã«æ…£ã‚Œã¦ãã¾ã—ãŸã€‚ã¾ã ã¾ã ã¯ã¾ã‚Šã©ã“ã‚ã‚ã‚Šãã†ã§ã™ãŒå°‘ãªãã¨ã‚‚ä»Šã¾ã§æ›¸ã„ã¦ã„ãŸåŒæœŸå‡¦ç†ã®ã‚³ãƒ¼ãƒ‰ã‚’tokioã‚’ä½¿ã£ã¦æ›¸ãç›´ã™ã¨ã‹ã¯ã§ãã‚‹ã‚ˆã†ãªããŒã—ã¦ãã¾ã—ãŸã€‚ã¾ãŸã€Mini-Redisã®å®Ÿè£…ã§ã¯è§¦ã‚Œã‚‰ã‚Œãªã‹ã£ãŸã¨ã“ã‚ã§ã‚‚å‚è€ƒã«ãªã‚Šãã†ãªç®‡æ‰€ãŒå¤šãã‚ã‚Š(protocolã®parseã®ã¨ã“ã‚ç­‰)å‚è€ƒã«ã—ã¦ã„ããŸã„ã¨æ€ã£ã¦ã„ã¾ã™ã€‚<p><a href=https://tokio.rs/blog/2020-10-tokio-0-3 rel=external>tokioã®blogè¨˜äº‹ Announcing Tokio 0.3 and the path to 1.0</a>ã§ã¯2020å¹´12æœˆã®çµ‚ã‚ã‚Šé ƒã«1.0ã®ãƒªãƒªãƒ¼ã‚¹ã‚’è¨ˆç”»ã—ã¦ã„ã‚‹ã“ã¨ãŒæ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚<br> tokio1.0ã§ã¯<ul><li>A minimum of 5 years of maintenance.<li>A minimum of 3 years before a hypothetical 2.0 release.<br> ã¨ã„ã†stability guaranteesã¸ã®commitãŒå®£è¨€ã•ã‚Œã¦ã„ã¾ã™ã€‚ã™ã”ã„ã§ã™ã­ã€ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ã§5å¹´ãƒ¡ãƒ³ãƒ†ã—ã¾ã™!ã¨å®£è¨€ã—ã¦ã„ã‚‹ã‚‚ã®ã¯ã‹ãªã‚Šå°‘ãªã„ã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚<br> ã“ã‚Œãªã‚‰å®‰å¿ƒã—ã¦tokioä½¿ã£ã¦ã„ã‘ã¾ã™ã­ã€‚</ul><h2 id=can-kao-document><a aria-label="Anchor link for: can-kao-document" class=zola-anchor href=#can-kao-document>å‚è€ƒdocument</a></h2><ul><li><a href=https://rust-lang.github.io/async-book/ rel=external>async book</a>. TODOãŒç›®ç«‹ã¤ãŒExecutorã®ç°¡æ˜“çš„ãªå®Ÿè£…ä¾‹ãŒã®ã£ã¦ã„ã‚‹ã€‚<li><a href=https://keens.github.io/blog/2019/07/07/rustnofuturetosonorunnerwotsukuttemita/ rel=external>keenå…ˆç”Ÿã®blog</a>. <code>RawWakrVTable</code>ã‹ã‚‰Contextã‚’ä½œã£ã¦ã„ã‚‹ã€‚<li><a href=https://qiita.com/legokichi/items/53536fcf247143a4721c rel=external>éåŒæœŸRustã®å‹•å‘èª¿æŸ»</a><li>OPTiMã•ã‚“ã®tech blog <ul><li><a href=https://tech-blog.optim.co.jp/entry/2020/03/05/160000 rel=external>Rustã®Pinãƒãƒ§ãƒƒãƒˆãƒ¯ã‚«ãƒ«</a><li><a href=https://tech-blog.optim.co.jp/entry/2019/11/08/163000 rel=external>Rustã®éåŒæœŸãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã‚’ãƒã‚¹ã‚¿ãƒ¼ã™ã‚‹</a></ul><li>Writing As OS in Rustã®<a href=https://os.phil-opp.com/async-await/ rel=external>async/awaitã®ç« </a></ul><div class=footnote-definition id=tokio030><sup class=footnote-definition-label>1</sup><p>https://github.com/tokio-rs/tokio/releases/tag/tokio-0.3.0</div><div class=footnote-definition id=Future::Poll><sup class=footnote-definition-label>2</sup><p>https://doc.rust-lang.org/std/future/trait.Future.html#tymethod.poll</div></div></article></main><footer class=blog-footer><p>Â© 2026 <a href=https://blog.ymgyt.io> ymgyt </a> | Made with <a href=https://www.getzola.org rel=noopener target=_blank>Zola</a> | <a href=https://github.com/ymgyt/blog>Repository</a> | <a href=https://blog.ymgyt.io/atom.xml target=_blank title=rss> <svg viewbox="0 0 24 24" class=icon fill=none height=24 stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx=5 cy=19 r=1></circle></svg> </a></footer></div></div>