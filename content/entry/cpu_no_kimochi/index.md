+++
title = "ğŸ“— ã‚‚ã£ã¨CPUã®æ°—æŒã¡ãŒçŸ¥ã‚ŠãŸã„ã§ã™ã‹ï¼Ÿã‚’èª­ã‚“ã æ„Ÿæƒ³"
slug = "cpu_no_kimochi"
date = "2022-11-27"
draft = false
description = "CPUã®æ°—æŒã¡æœ¬ã‚’èª­ã‚“ã æ„Ÿæƒ³"
[taxonomies]
tags = ["book"]
+++

## èª­ã‚“ã æœ¬

{{ figure(caption="å‡ºæ‘ æˆå’Œ è‘—", images=["images/cpu_no_kimochi_book.png"] )}}

[ã‚‚ã£ã¨CPUã®æ°—æŒã¡ãŒçŸ¥ã‚ŠãŸã„ã§ã™ã‹ï¼Ÿ](https://peaks.cc/cpu_no_kimochi)  
ã‚¿ã‚¤ãƒˆãƒ«ã«æƒ¹ã‹ã‚Œã¦èª­ã‚“ã§ã¿ãŸã®ã§æ„Ÿæƒ³ã‚’æ›¸ãã¾ã™ã€‚(é›»å­æ›¸ç± åˆç‰ˆ) 
ç›®æ¬¡ã¯[æœ¬æ›¸ã®Webãƒšãƒ¼ã‚¸](https://peaks.cc/cpu_no_kimochi)ã‹ã‚‰è¦‹ã‚Œã¾ã™ã€‚  
ä»¥ä¸‹ã®ã‚ˆã†ãªæ–¹ãŒå¯¾è±¡èª­è€…ã¨ã—ã¦æŒ™ã’ã‚‰ã‚Œã¦ã„ã¾ã—ãŸã€‚

> â–  CPU ã®å†…éƒ¨ã§è¡Œã‚ã‚Œã¦ã„ã‚‹ã“ã¨ï¼ˆä¸»ã«ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢æ–¹é¢ï¼‰ã‚’ç†è§£ã—ãŸã„äºº

> â–  CPU ã®æŒ™å‹•ã‚’ç†è§£ã—ãŸä¸Šã§ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ããŸã„äºº


## ã¾ã¨ã‚

* CPUã«ã¤ã„ã¦çŸ¥ã‚ŠãŸã„ã¨æ€ã£ãŸéš›ã«æœ€åˆã«èª­ã‚€æœ¬ã¨ã—ã¦ã‚ªã‚¹ã‚¹ãƒ¡ã—ãŸã„ã§ã™ã€‚è‡ªåˆ†ã¯æœ€åˆã«ã“ã®æœ¬èª­ã‚“ã§ãŠããŸã‹ã£ãŸãªã¨æ€ã„ã¾ã—ãŸã€‚

## ç¬¬1ç«  CPUã®æ°—æŒã¡ã‚’çŸ¥ã‚‹ã¨ã„ã†ã“ã¨

CPUã®æ°—æŒã¡(CPUã®ä»•çµ„ã¿ã‚„è¡Œã‚ã‚Œã¦ã„ã‚‹å‡¦ç†)ã‚’ç†è§£ã—ã¦ã„ã‚‹ã¨ã©ã†ã„ã£ãŸãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚‹ã‹ã«ã¤ã„ã¦ã€‚  

Flutterã¨ã„ã£ãŸã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãªãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’ä½¿ã£ã¦ã„ã¦ã‚‚è‚Œé–“ã§OSã‚„ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ä¾å­˜ã®å®Ÿè£…ãŒå¿…è¦ãªç®‡æ‰€ãŒ1~2å‰²ãã‚‰ã„ã‚ã‚‹ã¨ã„ã†è©±ãŒã®ã£ã¦ã„ã¾ã—ãŸã€‚ä»¥å‰React Nativeã‚’åˆ©ç”¨ã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®éš›ã«iOSè©³ã—ã„æ–¹ãŒãã†ã„ã£ãŸç®‡æ‰€ã‚’æ‹…å½“ã•ã‚Œã¦ãŠã‚Šã€ãã†ã„ã†ã‚‚ã®ãªã®ã ãªã¨æ€ã„ã¾ã—ãŸã€‚

ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚’  

```
ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³  
ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
os (software)
-------------
cpu (hardware)
```

ã¨ã„ã†ã‚¹ã‚¿ãƒƒã‚¯ã¨ã—ã¦æ‰ãˆã‚‹ã¨CPUãŒsoftã¨hardã®å¢ƒç•Œã«ã‚ãŸã‚‹ã®ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨cpuã®çŸ¥è­˜ã‹ã‚‰ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚„osã‚’å­¦ã¶ã‚¢ãƒ—ãƒ­ãƒ¼ãƒãŒç´¹ä»‹ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚  
è‡ªåˆ†ã¯æœ€è¿‘[Green Threads Explained in 200 Lines of Rust](https://cfsamson.gitbook.io/green-threads-explained-in-200-lines-of-rust/)ã¨ã„ã†è¨˜äº‹ã‚’èª­ã‚“ã§ã„ãŸã®ã§ã™ãŒã€Green threads(Goã®goroutineç­‰)ã‚’ç†è§£ã™ã‚‹ãŸã‚ã«ã¯çµå±€CPUã®å†…éƒ¨æ§‹é€ ã‚ã‹ã£ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã€CPUã¸ã®ç†è§£ã¯å¿…é ˆã§ã©ã†ã«ã‹ç†è§£ã‚’æ·±ã‚ãŸã„ã¨æ€ã£ã¦ã„ã¾ã—ãŸã€‚

ã¾ãŸã€CPUã¨é–¢é€£ã®çŸ¥è­˜ã¯ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã®æŒ™å‹•ã®ç†è§£ã«ã‚‚æœ‰ç”¨ã§ã‚ã‚‹ã¨ã•ã‚Œã¦ãŠã‚Šã€ä¾‹ã¨ã—ã¦ãƒã‚¤ãƒ³ã‚¿ãƒ¼ãŒæŒ™ã’ã‚‰ã‚Œã¦ã„ã¾ã—ãŸã€‚  
è‡ªåˆ†ãŒãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã§CPUã®ç†è§£ãŒè¶³ã‚Šã¦ã„ãªã„ã¨å¼·ãæ„Ÿã˜ãŸã®ã¯ã€[atomicã®orderingé–¢é€£](https://doc.rust-lang.org/nomicon/atomics.html)ã§ã™ã€‚
[ä¸¦è¡Œãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°å…¥é–€](https://www.oreilly.co.jp/books/9784873119595/)ã§`atomic::Ordering::SeqCst`ç­‰ãŒCPUã®ã©ã†ã„ã£ãŸå‘½ä»¤ã«å¯¾å¿œã—ã¦ã„ã‚‹ã¨ã„ã£ãŸè©±ãŒã§ã¦ãã¦ã€CPUã«ã¤ã„ã¦ã‚‚ã£ã¨çŸ¥ã‚ŠãŸã„ãªã¨æ€ã†ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚


## ç¬¬2ç«  CPUã¨å‹é”ã«ãªã‚ã†

å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã®æ¦‚è¦ã‚’ã€åŠ ç®—ã‚’è¡Œã†å‡¦ç†ã‚’Cã§æ›¸ã„ã¦ã€compileã—ãŸã®ã¡objdumpã§disassembleã—ãªãŒã‚‰èª¬æ˜ã—ã¦ãã‚Œã¾ã™ã€‚

## ç¬¬3ç«  ã‚¢ã‚»ãƒ³ãƒ–ãƒªè¨€èªã‚’ãªã‚“ã¨ãªãèª­ã‚€

`x = 2`ã®ã‚ˆã†ãªå¤‰æ•°ã¸ã®ä»£å…¥ãŒ

```
mov w9, #2
str w9, [sp, #24]
```

ã®ã‚ˆã†ãªå‘½ä»¤ã«å¤‰æ›ã•ã‚Œã‚‹ä¾‹ã‚’é€šã—ã¦ã‚¢ã‚»ãƒ³ãƒ–ãƒªã®æ¦‚è¦ã®èª¬æ˜ãŒã‚ã‚Šã¾ã™ã€‚  
ã‚¢ã‚»ãƒ³ãƒ–ãƒªã£ã¦ã©ã†ã—ã¦ã‚‚æ¥­å‹™ã‚„æ—¥ã€…ã®é–‹ç™ºã§ä½¿ã‚ãªã„ã®ã§ã©ã†ã‚‚èº«ã«ã¤ã‹ãªã„ã§ã™ã€‚Rustã®å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã‚ã‚‹ã‚ˆã†ã«ãªã‚‹ãªã‚‰[å¤§ç†±è¡€ï¼ ã‚¢ã‚»ãƒ³ãƒ–ãƒ©å…¥é–€](https://www.amazon.co.jp/dp/B07CMMVY5J)ç­‰ã‚’ã‚„ã£ã¦ã¿ã‚ˆã†ã‹ãªãªã©ã¨æ€ã£ã¦ã„ãŸã‚Šã—ã¾ã™ã€‚

## ç¬¬4ç«  CPUã‚’ã–ã£ãã‚ŠæŠŠæ¡ã™ã‚‹

CPUã‚’æ§‹æˆã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒå‘½ä»¤ã‚’å®Ÿè¡Œã™ã‚‹éš›ã«ã©ã†ã„ã£ãŸå½¹å‰²ã‚’æœãŸã™ã‹ãŒèª¬æ˜ã•ã‚Œã¾ã™ã€‚  
å‘½ä»¤ã‚»ãƒƒãƒˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ¼ã¨ãƒã‚¤ã‚¯ãƒ­ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ¼ã®ï¼’ã¤ã‚’ç†è§£ã—ã¦ãŠãã¨ã‚ˆã„ã¨ã•ã‚Œã¦ã„ã¾ã™ã€‚è‡ªåˆ†ã‚‚æœ€åˆã¯x86ã¨amd64ã£ã¦åŒã˜ãªã®ã‹é•ã†ã‚‚ã®ãªã®ã‹æ··ä¹±ã—ã¦ã„ãŸã‚Šã—ã¾ã—ãŸã€‚

## ç¬¬5ç«  å€¤ã‚’æ‰±ã†(ãƒ¬ã‚¸ã‚¹ã‚¿ãƒ¼)

ãƒ¬ã‚¸ã‚¹ã‚¿ãƒ¼ã«ã¤ã„ã¦ã®èª¬æ˜ã€‚  
æ±ç”¨ãƒ¬ã‚¸ã‚¹ã‚¿ãƒ¼ã¨ã„ã„ã¤ã¤ã€æ±ç”¨ã§ãªã‹ã£ãŸã‚Šã™ã‚‹èª¬æ˜ã¯ã‚‚ã£ã¨æ—©ãçŸ¥ã‚ŠãŸã‹ã£ãŸã§ã™ã€‚  
æš—é»™çš„ã«å¤‰æ›´ã•ã‚Œã‚‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¬ã‚¸ã‚¹ã‚¿ãƒ¼ã®èª¬æ˜ãŒä¸å¯§ã§ã‚ã‹ã‚Šã‚„ã™ã‹ã£ãŸã§ã™ã€‚

## ç¬¬6ç«  CPUãŒã§ãã‚‹ã“ã¨ã¯å¤šããªã„(å‘½ä»¤)

å‘½ä»¤ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«åˆ†é¡ã—ã¦ãã‚Œãã‚Œèª¬æ˜ã—ã¦ãã‚Œã¾ã™ã€‚  

* ãƒ­ãƒ¼ãƒ‰/ã‚¹ãƒˆã‚¢å‘½ä»¤
* ç®—è¡“æ¼”ç®—
* è«–ç†æ¼”ç®—
* æ¯”è¼ƒå‘½ä»¤
* ä¸¦åˆ—å‘½ä»¤
* åˆ†å²å‘½ä»¤
* ãã®ä»–

æ¯”è¼ƒå‘½ä»¤(`cmp`)ã£ã¦æ¸›ç®—ã‚’è¡Œã£ã¦ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¬ã‚¸ã‚¹ã‚¿ãƒ¼ã‚’æ›´æ–°ã™ã‚‹å‡¦ç†ã ã£ãŸã‚“ã§ã™ã­ã€‚  
SIMDå‘½ä»¤ã«ã¤ã„ã¦å…·ä½“ä¾‹ã‚‚ã‚ã£ã¦ã‚ã‹ã‚Šã‚„ã™ã‹ã£ãŸã§ã™ã€‚

## ç¬¬7ç«  é“ã¯åˆ†ã‹ã‚Œã‚‹(åˆ†å²å‘½ä»¤)

10ç« ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«é–¢ã‚ã£ã¦ãã‚‹ã“ã¨ã‹ã‚‰åˆ†å²å‘½ä»¤ã«ã¤ã„ã¦ã€ä¸å¯§ã«èª¬æ˜ã•ã‚Œã¾ã™ã€‚ç›´å‰ã®å‘½ä»¤ã®å®Ÿè¡ŒçµæœãŒã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¬ã‚¸ã‚¹ã‚¿ãƒ¼ã«æ›¸ãæˆ»ã•ã‚Œã¦åˆã‚ã¦æ¬¡ã«å®Ÿè¡Œã™ã‚‹å‘½ä»¤ãŒæ±ºã¾ã‚‹ã¨ã„ã†ç‚¹ãŒãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å‡¦ç†ã§å•é¡Œã«ãªã‚‹ã¨ã„ã†ç†è§£ã§ã™ã€‚

## ç¬¬8ç«  ã‚·ãƒ³ãƒ—ãƒ«ãªCPUã€è¤‡é›‘ãªCPU(RISCã¨CISC)

RISC(Reduced Instruction Set Computer)ã¨CISC(Complex Instruction Set Computer)ã«ã¤ã„ã¦ã€‚  
ãƒ­ãƒ¼ãƒ‰ãƒ»ã‚¹ãƒˆã‚¢ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ¼ã§ã‚ã‚‹ç‚¹ã‚„å‘½ä»¤ãŒå›ºå®šé•·ã§ã‚ã‚‹ã“ã¨ç­‰ã®è¦³ç‚¹ã‹ã‚‰RISCã¨CISCã‚’æ¯”è¼ƒã—ãªãŒã‚‰èª¬æ˜ã—ã¦ãã‚Œã¾ã™ã€‚  
RISCã®Reducedã¯å‘½ä»¤æ•°ã§ã¯ãªããƒ¡ãƒ¢ãƒªã‚¢ã‚¯ã‚»ã‚¹ã¸ã®é »åº¦ã‚’æŒ‡ã—ã¦ã„ã‚‹ã¨ã„ã†ã®ã¯çŸ¥ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚

## ç¬¬9ç«  è¨˜æ†¶ã®ä»•çµ„ã¿(ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒª)

CPUã¨ãƒ¡ãƒ¢ãƒªã®é–¢ä¿‚ã«ã¤ã„ã¦ã€‚  
ãƒã‚¤ãƒˆã‚ªãƒ¼ãƒ€ãƒ¼ã‚„ã‚¢ãƒ©ã‚¤ãƒ¡ãƒ³ãƒˆã«ã¤ã„ã¦ã®èª¬æ˜ãŒã‚ã‚Šã¾ã™ã€‚

## ç¬¬10ç«  å‡¦ç†ã‚’åŠ¹ç‡ã‚ˆãå®Ÿè¡Œã™ã‚‹ä»•çµ„ã¿(ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³)

å‘½ä»¤ã®å®Ÿè¡Œã‚’è¤‡æ•°ã®å‡¦ç†ã«åˆ†å‰²ã—ã¦ã€åŒæ™‚ã«å®Ÿè¡Œã§ãã‚‹å‘½ä»¤ã‚’å¢—ã‚„ã™ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«ã¤ã„ã¦ã€‚  
ç†æƒ³çŠ¶æ…‹ã§ã¯ã€å‘½ä»¤ã‚’ã‚‚ã£ã¨ã‚‚åŠ¹ç‡çš„ã«å®Ÿè¡Œã—ã€1ã‚¯ãƒ­ãƒƒã‚¯1å‘½ä»¤ãŒå®Ÿè¡Œã§ãã‚‹ãŒç¾å®Ÿã¯æ¬¡ã®å‘½ä»¤ã‚’ç›´ã¡ã«å®Ÿè¡Œã§ããªã„äº‹æƒ…ãŒå­˜åœ¨ã™ã‚‹ã€‚  
ä»£è¡¨ä¾‹ã¨ã—ã¦ã€å‰å›ã®çµæœã«ä¾å­˜ã™ã‚‹å ´åˆã¨ã€æ¡ä»¶åˆ†å²å‘½ä»¤ãŒæŒ™ã’ã‚‰ã‚Œã‚‹ã€‚
ã“ã®ã‚ˆã†ãªå ´åˆã«ã‚‚ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®å®Ÿè¡ŒåŠ¹ç‡ã‚’è½ã¨ã•ãªã„ãŸã‚ã®å·¥å¤«ãŒã‚ã‚Šã€ä»¥ä¸‹ãŒè§£èª¬ã•ã‚Œã¦ã„ã¾ã™ã€‚

* ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚¹ã‚«ãƒ©ãƒ¼
* ã‚¢ã‚¦ãƒˆã‚ªãƒ–ã‚ªãƒ¼ãƒ€ãƒ¼å®Ÿè¡Œ
* åˆ†å²äºˆæ¸¬
* æŠ•æ©Ÿçš„å®Ÿè¡Œ

æœ€åˆã«CPUã®ä»•çµ„ã¿ã«ã¤ã„ã¦çŸ¥ã‚ŠãŸã„ã¨æ€ã£ãŸã®ã¯atomicé–¢é€£ã®è©±ã§å®Ÿéš›ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®é€šã‚Šã«ä¸Šã‹ã‚‰å®Ÿè¡Œã•ã‚Œã‚‹è¨³ã§ã¯ãªã„ã¨ã„ã†è©±ã‚’çŸ¥ã£ãŸã¨ãã§ã—ãŸã€‚([ã•ã‚‰ã«compilerã ã‘ã§ãªãhardwareå´ã§ã‚‚reorderã•ã‚ŒãŸã‚Š](https://doc.rust-lang.org/nomicon/atomics.html#hardware-reordering))

è‡ªåˆ†ã¯åˆ†å²äºˆæ¸¬ã‚„æŠ•æ©Ÿçš„å®Ÿè¡ŒãŒã‚ˆãã‚ã‹ã£ã¦ãŠã‚‰ãšã“ã®ã‚ãŸã‚Šã®è§£èª¬ãŒèª­ã¿ãŸã„ã¨æ€ã£ã¦ã„ã¾ã—ãŸã€‚æ¡ä»¶åˆ†å²ã‚„ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãŒä¸å¯§ã«èª¬æ˜ã•ã‚Œã¦ã„ã‚‹ã®ã§ãªãœåˆ†å²äºˆæ¸¬ã‚„æŠ•æ©Ÿçš„å®Ÿè¡ŒãŒå¿…è¦ã‹ãŒã¨ã¦ã‚‚ã‚ã‹ã‚Šã‚„ã™ã‹ã£ãŸã§ã™ã€‚  
`if false { }`ã®ã‚ˆã†ã«å®Ÿè¡Œæ™‚ã«trueã§ãªãã¦ã‚‚ifã®blockãŒCPUã§ã¯å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã£ã¦ã™ã”ã„ã§ã™ã‚ˆã­ã€‚å®Ÿè¡Œçµæœã¯æ¨ã¦ã‚‰ã‚Œã‚‹ã‚‰ã—ã„ã®ã§ã™ãŒå‰¯ä½œç”¨ã‚ã‚‹å‡¦ç†ã ã£ãŸã‚‰ã©ã†ãªã‚‹ã®ã‹ãªã¨ã„ã†ç–‘å•ãŒç”Ÿã˜ã¾ã™ã€‚æ¡ä»¶ã®çµæœãŒãƒ¬ã‚¸ã‚¹ã‚¿ãƒ¼ã«æ›¸ãæˆ»ã•ã‚Œã‚‹ã¾ã§ã®è©±ã ã‹ã‚‰æŠ•æ©Ÿçš„ã«å®Ÿè¡Œã•ã‚Œã‚‹ã®ã‚‚æ•°å‘½ä»¤ç¨‹åº¦ã¨ã„ã†è©±ãªã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€‚

åˆ†å²äºˆæ¸¬ã«ã¯ã€é™çš„ã‹å‹•çš„ã‹ã§åˆ†é¡ã§ãã‚‹ãã†ã§ã™ã€‚  
é™çš„åˆ†å²äºˆæ¸¬ã¯ã€compilerãŒå‘½ä»¤ã‚’ä¸¦ã³æ›¿ãˆãŸã‚Šã™ã‚‹æ‰‹æ³•ã€‚å…·ä½“çš„ã«ã©ã†ã„ã£ãŸå‘½ä»¤ã®ä¸¦ã³æ›¿ãˆãŒè¡Œã‚ã‚Œã‚‹ã‹ã®å…·ä½“ä¾‹ãŒãªã‹ã£ãŸã®ã§æ°—ã«ãªã‚Šã¾ã—ãŸã€‚C++20ã§ã¯

```cpp
constexpr double pow(double x, long long n) noexcept {
    if (n > 0) [[likely]]
        return x * pow(x, n - 1);
    else [[unlikely]]
        return 1;
}
```

https://en.cppreference.com/w/cpp/language/attributes/likely

ã®ã‚ˆã†ã«ifã«`[[likely]]`ã¨æ›¸ã„ã¦ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã§åˆ†å²ã«é–¢ã™ã‚‹æƒ…å ±ã‚’compilerã«ä¼ãˆã‚‰ã‚Œã‚‹ã‚ˆã†ã§ã™ã€‚ã™ã”ã„ã€‚

## ç¬¬11ç«  æ‰‹ãŒå±Šãç¯„å›²ã«ãƒ¢ãƒãŒã‚ã‚‹ã¨ä¾¿åˆ©ã ã‚ˆã­(ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ¡ãƒ¢ãƒª)

CPUã¨cacheã«ã¤ã„ã¦ã€‚  
cacheã‚’æ„è­˜ã™ã‚‹ã‹ã—ãªã„ã‹ã§ã©ã‚Œãã‚‰ã„é€Ÿåº¦ã«å·®ãŒã§ã‚‹ã‹æ¤œè¨¼ã™ã‚‹Cã®ã‚³ãƒ¼ãƒ‰ãŒè¼‰ã£ã¦ã„ãŸã®ã§ã€Rustã§æ›¸ã„ã¦è©¦ã—ã¦ã¿ã¾ã—ãŸã€‚

`Cargo.toml`

```toml
[dev-dependencies]
criterion = "0.3.0"

[[bench]]
name = "cache"
harness = false
```

`benches/cache.rs`

```rust
use criterion::{criterion_group, criterion_main, Criterion, BatchSize};

type Data = Vec<Vec<i64>>;

const D: i64 = 100;

#[derive(Clone)]
struct Input {
    buff_size: usize,
    a: Data,
    b: Data,
    answer: Data,
}

fn init_input(buff_size: usize) -> Input {
    let answer = vec![vec![0_i64; buff_size]; buff_size];
    let mut a = vec![vec![0_i64; buff_size]; buff_size];
    let mut b = vec![vec![0_i64; buff_size]; buff_size];

    for i in 0..buff_size {
        for j in 0..buff_size {
            a[i][j] = j as i64;
            b[i][j] = j as i64;
        }
    }

    Input {
        buff_size,
        a,
        b,
        answer,
    }
}

fn access_in_order(Input { buff_size, a, b, answer }: &mut Input) {
    let buff_size = *buff_size;
    for i in 0..buff_size {
        for j in 0..buff_size {
            answer[i][j] = a[i][j] * b[i][j] + D;
        }
    }
}

fn access(Input { buff_size, a, b, answer }: &mut Input) {
    let buff_size = *buff_size;
    for i in 0..buff_size {
        for j in 0..buff_size {
            answer[j][i] = a[j][i] * b[j][i] + D;
        }
    }
}


fn benchmark(c: &mut Criterion) {
    let buff_size = 0x2000;
    let mut group = c.benchmark_group("cache");
    let input = init_input(buff_size);

    group.bench_function("access_in_order", |b| {
        b.iter_batched(|| input.clone(), |mut input| access_in_order(&mut input), BatchSize::SmallInput)
    });

    group.bench_function("access", |b| {
        b.iter_batched(|| input.clone(), |mut input| access(&mut input), BatchSize::SmallInput)
    });
}

criterion_group! {
    name = bench_main;
    config = Criterion::default();
    targets = benchmark
}

criterion_main!(bench_main);
```

çµæœ

```
â¯ cargo criterion -- --sample-size=10
    Finished bench [optimized] target(s) in 0.03s
Gnuplot not found, using plotters backend
cache/access_in_order   time:   [145.88 ms 148.53 ms 151.90 ms]                                
Benchmarking cache/access: Warming up for 3.0000 s
Warning: Unable to complete 10 samples in 5.0s. You may wish to increase target time to 47.4s.
cache/access            time:   [4.2983 s 4.5101 s 4.6564 s]                          
```


ã¨ã„ã†ã“ã¨ã§ã€cacheã‚’è€ƒæ…®ã—ãŸ`access_in_order`ã®ã»ã†ãŒé€Ÿã„çµæœãŒå†ç¾ã§ãã¾ã—ãŸã€‚  
`pref`ã‚³ãƒãƒ³ãƒ‰ã®ä½¿ã„æ–¹ã‚‚è¼‰ã£ã¦ãŠã‚Šã€ã¨ã¦ã‚‚å‚è€ƒã«ãªã‚Šã¾ã—ãŸã€‚

{{ figure(caption="criterionå‡ºåŠ›çµæœ", images=["images/cpu_no_kimochi_bench.png"]) }}

## ç¬¬12ç«  CPUã¨å‘¨è¾ºæ©Ÿå™¨ã¨ã®çµã³ã¤ã(I/O)

CPUãŒå‘¨è¾ºæ©Ÿå™¨ã¨ã‚„ã‚Šã¨ã‚Šã™ã‚‹éš›ã«ãƒ¡ãƒ¢ãƒªãƒãƒƒãƒ—ã©I/Oã¨ã„ã†ä»•çµ„ã¿ã§ãƒ¡ãƒ¢ãƒªçµŒç”±ã§ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿æ›¸ãã—ã¦ã„ã‚‹ã¨ã„ã†è©±ã€‚  
[åŸºç¤ã‹ã‚‰å­¦ã¶ çµ„è¾¼ã¿Rust](https://www.c-r.com/book/detail/1403)ã‚’ã‚„ã£ãŸéš›ã«å‡ºã¦ããŸæ°—ãŒã—ã¾ã™ã€‚  

## ç¬¬13ç«  å¤šãã®ä»•äº‹ã‚’å·®ã—è¾¼ã¾ã‚Œã‚‹ç«‹å ´ã§ã™(å‰²ã‚Šè¾¼ã¿)

å‰²ã‚Šè¾¼ã¿ã«ã¤ã„ã¦ã®èª¬æ˜ã€‚  
ãƒ™ã‚¯ã‚¿ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå‰²ã‚Šè¾¼ã¿æ¬¡ã«ã©ã®ã‚ˆã†ã«å‚ç…§ã•ã‚Œã‚‹ã‹ç­‰ã®ã£ã¦ãŠã‚Šã€å‰²ã‚Šè¾¼ã¿ã®èª¬æ˜ã¨ã—ã¦ã¨ã¦ã‚‚ã‚ã‹ã‚Šã‚„ã™ã‹ã£ãŸã§ã™ã€‚  
[Writing an OS in Rustã®CPU Exceptions](https://os.phil-opp.com/cpu-exceptions/)ã‚’èª­ã‚“ã éš›ã«Interrupt Descriptor TableãŒã‚ˆãã‚ã‹ã‚‰ãªã‹ã£ãŸã®ã§æœ€åˆã«ã“ã®èª¬æ˜èª­ã‚“ã§ã„ãŸã‚‰ã¨æ€ã„ã¾ã—ãŸã€‚

## ä»˜éŒ²A æ¬¡ã«èª­ã‚€ã¹ãæœ¬

æ¬¡ã«èª­ã‚€æœ¬ã®ã‚ªã‚¹ã‚¹ãƒ¡ãŒæŒ™ã’ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚ 
ãƒ‘ã‚¿ãƒ˜ãƒæœ¬(ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã®æ§‹æˆã¨è¨­è¨ˆ)ã‚‚è¼‰ã£ã¦ã„ã¾ã—ãŸã€‚(ç¬¬5ç‰ˆã¨ã‚ã‚Šã¾ã™ãŒã€ç¬¬6ç‰ˆã§ã¦ã¾ã™)  
ãƒ‘ã‚¿ãƒ˜ãƒæœ¬ã¯ã‚ªã‚¹ã‚¹ãƒ¡ã•ã‚Œã¦ä¸€åº¦èª­ã‚“ã§ã¿ãŸã®ã§ã™ãŒé›£ã—ãç†è§£ã§ããªã„ã¨ã“ã‚ã‚‚å¤šã‹ã£ãŸã®ã§ç†è§£ã‚’æ·±ã‚ã¦ã‹ã‚‰å†æŒ‘æˆ¦ã—ãŸã„ã§ã™ã€‚  
ãã—ã¦ã“ã“ã§ã‚‚æŒ™ãŒã‚‹CPUã®é€ ã‚Šæ–¹ã€‚2003å¹´ã®æœ¬ã§ã™ãŒä»Šã§ã‚‚ã‚ªã‚¹ã‚¹ãƒ¡ã«ä¸ŠãŒã‚Šç¶šã‘ã‚‹ã®ã™ã”ã„ãªã¨æ€ã£ã¦ã„ã¾ã™ã€‚  
è‡ªåˆ†ã¯ãƒ—ãƒ­ã‚»ãƒƒã‚µã‚’æ”¯ãˆã‚‹æŠ€è¡“ã‚’èª­ã‚“ã§ã¿ã‚ˆã†ã¨æ€ã„ã¾ã—ãŸã€‚

